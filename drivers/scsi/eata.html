<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › eata.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>eata.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      eata.c - Low-level driver for EATA/DMA SCSI host adapters.</span>
<span class="cm"> *</span>
<span class="cm"> *      03 Jun 2003 Rev. 8.10 for linux-2.5.70</span>
<span class="cm"> *        + Update for new IRQ API.</span>
<span class="cm"> *        + Use &quot;goto&quot; when appropriate.</span>
<span class="cm"> *        + Drop eata.h.</span>
<span class="cm"> *        + Update for new module_param API.</span>
<span class="cm"> *        + Module parameters  can now be specified only in the</span>
<span class="cm"> *          same format as the kernel boot options.</span>
<span class="cm"> *</span>
<span class="cm"> *             boot option    old module param </span>
<span class="cm"> *             -----------    ------------------</span>
<span class="cm"> *             addr,...       io_port=addr,...</span>
<span class="cm"> *             lc:[y|n]       linked_comm=[1|0]</span>
<span class="cm"> *             mq:xx          max_queue_depth=xx</span>
<span class="cm"> *             tm:[0|1|2]     tag_mode=[0|1|2]</span>
<span class="cm"> *             et:[y|n]       ext_tran=[1|0]</span>
<span class="cm"> *             rs:[y|n]       rev_scan=[1|0]</span>
<span class="cm"> *             ip:[y|n]       isa_probe=[1|0]</span>
<span class="cm"> *             ep:[y|n]       eisa_probe=[1|0]</span>
<span class="cm"> *             pp:[y|n]       pci_probe=[1|0]</span>
<span class="cm"> *</span>
<span class="cm"> *          A valid example using the new parameter format is:</span>
<span class="cm"> *          modprobe eata &quot;eata=0x7410,0x230,lc:y,tm:0,mq:4,ep:n&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *          which is equivalent to the old format:</span>
<span class="cm"> *          modprobe eata io_port=0x7410,0x230 linked_comm=1 tag_mode=0 \</span>
<span class="cm"> *                        max_queue_depth=4 eisa_probe=0</span>
<span class="cm"> *</span>
<span class="cm"> *      12 Feb 2003 Rev. 8.04 for linux 2.5.60</span>
<span class="cm"> *        + Release irq before calling scsi_register.</span>
<span class="cm"> *</span>
<span class="cm"> *      12 Nov 2002 Rev. 8.02 for linux 2.5.47</span>
<span class="cm"> *        + Release driver_lock before calling scsi_register.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Nov 2002 Rev. 8.01 for linux 2.5.47</span>
<span class="cm"> *        + Fixed bios_param and scsicam_bios_param calling parameters.</span>
<span class="cm"> *</span>
<span class="cm"> *      28 Oct 2002 Rev. 8.00 for linux 2.5.44-ac4</span>
<span class="cm"> *        + Use new tcq and adjust_queue_depth api.</span>
<span class="cm"> *        + New command line option (tm:[0-2]) to choose the type of tags:</span>
<span class="cm"> *          0 -&gt; disable tagging ; 1 -&gt; simple tags  ; 2 -&gt; ordered tags.</span>
<span class="cm"> *          Default is tm:0 (tagged commands disabled).</span>
<span class="cm"> *          For compatibility the &quot;tc:&quot; option is an alias of the &quot;tm:&quot;</span>
<span class="cm"> *          option; tc:n is equivalent to tm:0 and tc:y is equivalent to</span>
<span class="cm"> *          tm:1.</span>
<span class="cm"> *        + The tagged_comm module parameter has been removed, use tag_mode</span>
<span class="cm"> *          instead, equivalent to the &quot;tm:&quot; boot option.</span>
<span class="cm"> *</span>
<span class="cm"> *      10 Oct 2002 Rev. 7.70 for linux 2.5.42</span>
<span class="cm"> *        + Foreport from revision 6.70.</span>
<span class="cm"> *</span>
<span class="cm"> *      25 Jun 2002 Rev. 6.70 for linux 2.4.19</span>
<span class="cm"> *        + This release is the first one tested on a Big Endian platform:</span>
<span class="cm"> *          fixed endian-ness problem due to bitfields;</span>
<span class="cm"> *          fixed endian-ness problem in read_pio.</span>
<span class="cm"> *        + Added new options for selectively probing ISA, EISA and PCI bus:</span>
<span class="cm"> *</span>
<span class="cm"> *          Boot option   Parameter name    Default according to</span>
<span class="cm"> *</span>
<span class="cm"> *          ip:[y|n]      isa_probe=[1|0]   CONFIG_ISA  defined</span>
<span class="cm"> *          ep:[y|n]      eisa_probe=[1|0]  CONFIG_EISA defined</span>
<span class="cm"> *          pp:[y|n]      pci_probe=[1|0]   CONFIG_PCI  defined</span>
<span class="cm"> *</span>
<span class="cm"> *          The default action is to perform probing if the corresponding</span>
<span class="cm"> *          bus is configured and to skip probing otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> *        + If pci_probe is in effect and a list of I/O  ports is specified</span>
<span class="cm"> *          as parameter or boot option, pci_enable_device() is performed</span>
<span class="cm"> *          on all pci devices matching PCI_CLASS_STORAGE_SCSI.</span>
<span class="cm"> *</span>
<span class="cm"> *      21 Feb 2002 Rev. 6.52 for linux 2.4.18</span>
<span class="cm"> *        + Backport from rev. 7.22 (use io_request_lock).</span>
<span class="cm"> *</span>
<span class="cm"> *      20 Feb 2002 Rev. 7.22 for linux 2.5.5</span>
<span class="cm"> *        + Remove any reference to virt_to_bus().</span>
<span class="cm"> *        + Fix pio hang while detecting multiple HBAs.</span>
<span class="cm"> *        + Fixed a board detection bug: in a system with</span>
<span class="cm"> *          multiple ISA/EISA boards, all but the first one</span>
<span class="cm"> *          were erroneously detected as PCI.</span>
<span class="cm"> *</span>
<span class="cm"> *      01 Jan 2002 Rev. 7.20 for linux 2.5.1</span>
<span class="cm"> *        + Use the dynamic DMA mapping API.</span>
<span class="cm"> *</span>
<span class="cm"> *      19 Dec 2001 Rev. 7.02 for linux 2.5.1</span>
<span class="cm"> *        + Use SCpnt-&gt;sc_data_direction if set.</span>
<span class="cm"> *        + Use sglist.page instead of sglist.address.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Dec 2001 Rev. 7.00 for linux 2.5.1</span>
<span class="cm"> *        + Use host-&gt;host_lock instead of io_request_lock.</span>
<span class="cm"> *</span>
<span class="cm"> *       1 May 2001 Rev. 6.05 for linux 2.4.4</span>
<span class="cm"> *        + Clean up all pci related routines.</span>
<span class="cm"> *        + Fix data transfer direction for opcode SEND_CUE_SHEET (0x5d)</span>
<span class="cm"> *</span>
<span class="cm"> *      30 Jan 2001 Rev. 6.04 for linux 2.4.1</span>
<span class="cm"> *        + Call pci_resource_start after pci_enable_device.</span>
<span class="cm"> *</span>
<span class="cm"> *      25 Jan 2001 Rev. 6.03 for linux 2.4.0</span>
<span class="cm"> *        + &quot;check_region&quot; call replaced by &quot;request_region&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *      22 Nov 2000 Rev. 6.02 for linux 2.4.0-test11</span>
<span class="cm"> *        + Return code checked when calling pci_enable_device.</span>
<span class="cm"> *        + Removed old scsi error handling support.</span>
<span class="cm"> *        + The obsolete boot option flag eh:n is silently ignored.</span>
<span class="cm"> *        + Removed error messages while a disk drive is powered up at</span>
<span class="cm"> *          boot time.</span>
<span class="cm"> *        + Improved boot messages: all tagged capable device are</span>
<span class="cm"> *          indicated as &quot;tagged&quot; or &quot;soft-tagged&quot; :</span>
<span class="cm"> *          - &quot;soft-tagged&quot;  means that the driver is trying to do its</span>
<span class="cm"> *            own tagging (i.e. the tc:y option is in effect);</span>
<span class="cm"> *          - &quot;tagged&quot; means that the device supports tagged commands,</span>
<span class="cm"> *            but the driver lets the HBA be responsible for tagging</span>
<span class="cm"> *            support.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Sep 1999 Rev. 5.11 for linux 2.2.12 and 2.3.18</span>
<span class="cm"> *        + Updated to the new __setup interface for boot command line options.</span>
<span class="cm"> *        + When loaded as a module, accepts the new parameter boot_options</span>
<span class="cm"> *          which value is a string with the same format of the kernel boot</span>
<span class="cm"> *          command line options. A valid example is:</span>
<span class="cm"> *          modprobe eata &#39;boot_options=&quot;0x7410,0x230,lc:y,tc:n,mq:4&quot;&#39;</span>
<span class="cm"> *</span>
<span class="cm"> *       9 Sep 1999 Rev. 5.10 for linux 2.2.12 and 2.3.17</span>
<span class="cm"> *        + 64bit cleanup for Linux/Alpha platform support</span>
<span class="cm"> *          (contribution from H.J. Lu).</span>
<span class="cm"> *</span>
<span class="cm"> *      22 Jul 1999 Rev. 5.00 for linux 2.2.10 and 2.3.11</span>
<span class="cm"> *        + Removed pre-2.2 source code compatibility.</span>
<span class="cm"> *        + Added call to pci_set_master.</span>
<span class="cm"> *</span>
<span class="cm"> *      26 Jul 1998 Rev. 4.33 for linux 2.0.35 and 2.1.111</span>
<span class="cm"> *        + Added command line option (rs:[y|n]) to reverse the scan order</span>
<span class="cm"> *          of PCI boards. The default is rs:y, which reverses the BIOS order</span>
<span class="cm"> *          while registering PCI boards. The default value rs:y generates</span>
<span class="cm"> *          the same order of all previous revisions of this driver.</span>
<span class="cm"> *          Pls. note that &quot;BIOS order&quot; might have been reversed itself</span>
<span class="cm"> *          after the 2.1.9x PCI modifications in the linux kernel.</span>
<span class="cm"> *          The rs value is ignored when the explicit list of addresses</span>
<span class="cm"> *          is used by the &quot;eata=port0,port1,...&quot; command line option.</span>
<span class="cm"> *        + Added command line option (et:[y|n]) to force use of extended</span>
<span class="cm"> *          translation (255 heads, 63 sectors) as disk geometry.</span>
<span class="cm"> *          The default is et:n, which uses the disk geometry returned</span>
<span class="cm"> *          by scsicam_bios_param. The default value et:n is compatible with</span>
<span class="cm"> *          all previous revisions of this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *      28 May 1998 Rev. 4.32 for linux 2.0.33 and 2.1.104</span>
<span class="cm"> *          Increased busy timeout from 10 msec. to 200 msec. while</span>
<span class="cm"> *          processing interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 May 1998 Rev. 4.31 for linux 2.0.33 and 2.1.102</span>
<span class="cm"> *          Improved abort handling during the eh recovery process.</span>
<span class="cm"> *</span>
<span class="cm"> *      13 May 1998 Rev. 4.30 for linux 2.0.33 and 2.1.101</span>
<span class="cm"> *          The driver is now fully SMP safe, including the</span>
<span class="cm"> *          abort and reset routines.</span>
<span class="cm"> *          Added command line options (eh:[y|n]) to choose between</span>
<span class="cm"> *          new_eh_code and the old scsi code.</span>
<span class="cm"> *          If linux version &gt;= 2.1.101 the default is eh:y, while the eh</span>
<span class="cm"> *          option is ignored for previous releases and the old scsi code</span>
<span class="cm"> *          is used.</span>
<span class="cm"> *</span>
<span class="cm"> *      18 Apr 1998 Rev. 4.20 for linux 2.0.33 and 2.1.97</span>
<span class="cm"> *          Reworked interrupt handler.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Apr 1998 rev. 4.05 for linux 2.0.33 and 2.1.95</span>
<span class="cm"> *          Major reliability improvement: when a batch with overlapping</span>
<span class="cm"> *          requests is detected, requests are queued one at a time</span>
<span class="cm"> *          eliminating any possible board or drive reordering.</span>
<span class="cm"> *</span>
<span class="cm"> *      10 Apr 1998 rev. 4.04 for linux 2.0.33 and 2.1.95</span>
<span class="cm"> *          Improved SMP support (if linux version &gt;= 2.1.95).</span>
<span class="cm"> *</span>
<span class="cm"> *       9 Apr 1998 rev. 4.03 for linux 2.0.33 and 2.1.94</span>
<span class="cm"> *          Added support for new PCI code and IO-APIC remapping of irqs.</span>
<span class="cm"> *          Performance improvement: when sequential i/o is detected,</span>
<span class="cm"> *          always use direct sort instead of reverse sort.</span>
<span class="cm"> *</span>
<span class="cm"> *       4 Apr 1998 rev. 4.02 for linux 2.0.33 and 2.1.92</span>
<span class="cm"> *          io_port is now unsigned long.</span>
<span class="cm"> *</span>
<span class="cm"> *      17 Mar 1998 rev. 4.01 for linux 2.0.33 and 2.1.88</span>
<span class="cm"> *          Use new scsi error handling code (if linux version &gt;= 2.1.88).</span>
<span class="cm"> *          Use new interrupt code.</span>
<span class="cm"> *</span>
<span class="cm"> *      12 Sep 1997 rev. 3.11 for linux 2.0.30 and 2.1.55</span>
<span class="cm"> *          Use of udelay inside the wait loops to avoid timeout</span>
<span class="cm"> *          problems with fast cpus.</span>
<span class="cm"> *          Removed check about useless calls to the interrupt service</span>
<span class="cm"> *          routine (reported on SMP systems only).</span>
<span class="cm"> *          At initialization time &quot;sorted/unsorted&quot; is displayed instead</span>
<span class="cm"> *          of &quot;linked/unlinked&quot; to reinforce the fact that &quot;linking&quot; is</span>
<span class="cm"> *          nothing but &quot;elevator sorting&quot; in the actual implementation.</span>
<span class="cm"> *</span>
<span class="cm"> *      17 May 1997 rev. 3.10 for linux 2.0.30 and 2.1.38</span>
<span class="cm"> *          Use of serial_number_at_timeout in abort and reset processing.</span>
<span class="cm"> *          Use of the __initfunc and __initdata macro in setup code.</span>
<span class="cm"> *          Minor cleanups in the list_statistics code.</span>
<span class="cm"> *          Increased controller busy timeout in order to better support</span>
<span class="cm"> *          slow SCSI devices.</span>
<span class="cm"> *</span>
<span class="cm"> *      24 Feb 1997 rev. 3.00 for linux 2.0.29 and 2.1.26</span>
<span class="cm"> *          When loading as a module, parameter passing is now supported</span>
<span class="cm"> *          both in 2.0 and in 2.1 style.</span>
<span class="cm"> *          Fixed data transfer direction for some SCSI opcodes.</span>
<span class="cm"> *          Immediate acknowledge to request sense commands.</span>
<span class="cm"> *          Linked commands to each disk device are now reordered by elevator</span>
<span class="cm"> *          sorting. Rare cases in which reordering of write requests could</span>
<span class="cm"> *          cause wrong results are managed.</span>
<span class="cm"> *          Fixed spurious timeouts caused by long simple queue tag sequences.</span>
<span class="cm"> *          New command line option (tm:[0-3]) to choose the type of tags:</span>
<span class="cm"> *          0 -&gt; mixed (default); 1 -&gt; simple; 2 -&gt; head; 3 -&gt; ordered.</span>
<span class="cm"> *</span>
<span class="cm"> *      18 Jan 1997 rev. 2.60 for linux 2.1.21 and 2.0.28</span>
<span class="cm"> *          Added command line options to enable/disable linked commands</span>
<span class="cm"> *          (lc:[y|n]), tagged commands (tc:[y|n]) and to set the max queue</span>
<span class="cm"> *          depth (mq:xx). Default is &quot;eata=lc:n,tc:n,mq:16&quot;.</span>
<span class="cm"> *          Improved command linking.</span>
<span class="cm"> *          Documented how to setup RAID-0 with DPT SmartRAID boards.</span>
<span class="cm"> *</span>
<span class="cm"> *       8 Jan 1997 rev. 2.50 for linux 2.1.20 and 2.0.27</span>
<span class="cm"> *          Added linked command support.</span>
<span class="cm"> *          Improved detection of PCI boards using ISA base addresses.</span>
<span class="cm"> *</span>
<span class="cm"> *       3 Dec 1996 rev. 2.40 for linux 2.1.14 and 2.0.27</span>
<span class="cm"> *          Added support for tagged commands and queue depth adjustment.</span>
<span class="cm"> *</span>
<span class="cm"> *      22 Nov 1996 rev. 2.30 for linux 2.1.12 and 2.0.26</span>
<span class="cm"> *          When CONFIG_PCI is defined, BIOS32 is used to include in the</span>
<span class="cm"> *          list of i/o ports to be probed all the PCI SCSI controllers.</span>
<span class="cm"> *          The list of i/o ports to be probed can be overwritten by the</span>
<span class="cm"> *          &quot;eata=port0,port1,....&quot; boot command line option.</span>
<span class="cm"> *          Scatter/gather lists are now allocated by a number of kmalloc</span>
<span class="cm"> *          calls, in order to avoid the previous size limit of 64Kb.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Nov 1996 rev. 2.20 for linux 2.1.10 and 2.0.25</span>
<span class="cm"> *          Added support for EATA 2.0C, PCI, multichannel and wide SCSI.</span>
<span class="cm"> *</span>
<span class="cm"> *      27 Sep 1996 rev. 2.12 for linux 2.1.0</span>
<span class="cm"> *          Portability cleanups (virtual/bus addressing, little/big endian</span>
<span class="cm"> *          support).</span>
<span class="cm"> *</span>
<span class="cm"> *      09 Jul 1996 rev. 2.11 for linux 2.0.4</span>
<span class="cm"> *          Number of internal retries is now limited.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Apr 1996 rev. 2.10 for linux 1.3.90</span>
<span class="cm"> *          New argument &quot;reset_flags&quot; to the reset routine.</span>
<span class="cm"> *</span>
<span class="cm"> *       6 Jul 1995 rev. 2.01 for linux 1.3.7</span>
<span class="cm"> *          Update required by the new /proc/scsi support.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Mar 1995 rev. 2.00 for linux 1.2.0</span>
<span class="cm"> *          Fixed a bug which prevented media change detection for removable</span>
<span class="cm"> *          disk drives.</span>
<span class="cm"> *</span>
<span class="cm"> *      23 Feb 1995 rev. 1.18 for linux 1.1.94</span>
<span class="cm"> *          Added a check for scsi_register returning NULL.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Feb 1995 rev. 1.17 for linux 1.1.91</span>
<span class="cm"> *          Now DEBUG_RESET is disabled by default.</span>
<span class="cm"> *          Register a board even if it does not assert DMA protocol support</span>
<span class="cm"> *          (DPT SK2011B does not report correctly the dmasup bit).</span>
<span class="cm"> *</span>
<span class="cm"> *       9 Feb 1995 rev. 1.16 for linux 1.1.90</span>
<span class="cm"> *          Use host-&gt;wish_block instead of host-&gt;block.</span>
<span class="cm"> *          New list of Data Out SCSI commands.</span>
<span class="cm"> *</span>
<span class="cm"> *       8 Feb 1995 rev. 1.15 for linux 1.1.89</span>
<span class="cm"> *          Cleared target_time_out counter while performing a reset.</span>
<span class="cm"> *          All external symbols renamed to avoid possible name conflicts.</span>
<span class="cm"> *</span>
<span class="cm"> *      28 Jan 1995 rev. 1.14 for linux 1.1.86</span>
<span class="cm"> *          Added module support.</span>
<span class="cm"> *          Log and do a retry when a disk drive returns a target status</span>
<span class="cm"> *          different from zero on a recovered error.</span>
<span class="cm"> *</span>
<span class="cm"> *      24 Jan 1995 rev. 1.13 for linux 1.1.85</span>
<span class="cm"> *          Use optimized board configuration, with a measured performance</span>
<span class="cm"> *          increase in the range 10%-20% on i/o throughput.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Jan 1995 rev. 1.12 for linux 1.1.81</span>
<span class="cm"> *          Fix mscp structure comments (no functional change).</span>
<span class="cm"> *          Display a message if check_region detects a port address</span>
<span class="cm"> *          already in use.</span>
<span class="cm"> *</span>
<span class="cm"> *      17 Dec 1994 rev. 1.11 for linux 1.1.74</span>
<span class="cm"> *          Use the scsicam_bios_param routine. This allows an easy</span>
<span class="cm"> *          migration path from disk partition tables created using</span>
<span class="cm"> *          different SCSI drivers and non optimal disk geometry.</span>
<span class="cm"> *</span>
<span class="cm"> *      15 Dec 1994 rev. 1.10 for linux 1.1.74</span>
<span class="cm"> *          Added support for ISA EATA boards (DPT PM2011, DPT PM2021).</span>
<span class="cm"> *          The host-&gt;block flag is set for all the detected ISA boards.</span>
<span class="cm"> *          The detect routine no longer enforces LEVEL triggering</span>
<span class="cm"> *          for EISA boards, it just prints a warning message.</span>
<span class="cm"> *</span>
<span class="cm"> *      30 Nov 1994 rev. 1.09 for linux 1.1.68</span>
<span class="cm"> *          Redo i/o on target status CHECK_CONDITION for TYPE_DISK only.</span>
<span class="cm"> *          Added optional support for using a single board at a time.</span>
<span class="cm"> *</span>
<span class="cm"> *      18 Nov 1994 rev. 1.08 for linux 1.1.64</span>
<span class="cm"> *          Forces sg_tablesize = 64 and can_queue = 64 if these</span>
<span class="cm"> *          values are not correctly detected (DPT PM2012).</span>
<span class="cm"> *</span>
<span class="cm"> *      14 Nov 1994 rev. 1.07 for linux 1.1.63  Final BETA release.</span>
<span class="cm"> *      04 Aug 1994 rev. 1.00 for linux 1.1.39  First BETA release.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *          This driver is based on the CAM (Common Access Method Committee)</span>
<span class="cm"> *          EATA (Enhanced AT Bus Attachment) rev. 2.0A, using DMA protocol.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1994-2003 Dario Ballabio (ballabio_dario@emc.com)</span>
<span class="cm"> *</span>
<span class="cm"> *  Alternate email: dario.ballabio@inwind.it, dario.ballabio@tiscalinet.it</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that redistributions of source</span>
<span class="cm"> *  code retain the above copyright notice and this comment without</span>
<span class="cm"> *  modification.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  Here is a brief description of the DPT SCSI host adapters.</span>
<span class="cm"> *  All these boards provide an EATA/DMA compatible programming interface</span>
<span class="cm"> *  and are fully supported by this driver in any configuration, including</span>
<span class="cm"> *  multiple SCSI channels:</span>
<span class="cm"> *</span>
<span class="cm"> *  PM2011B/9X -  Entry Level ISA</span>
<span class="cm"> *  PM2021A/9X -  High Performance ISA</span>
<span class="cm"> *  PM2012A       Old EISA</span>
<span class="cm"> *  PM2012B       Old EISA</span>
<span class="cm"> *  PM2022A/9X -  Entry Level EISA</span>
<span class="cm"> *  PM2122A/9X -  High Performance EISA</span>
<span class="cm"> *  PM2322A/9X -  Extra High Performance EISA</span>
<span class="cm"> *  PM3021     -  SmartRAID Adapter for ISA</span>
<span class="cm"> *  PM3222     -  SmartRAID Adapter for EISA (PM3222W is 16-bit wide SCSI)</span>
<span class="cm"> *  PM3224     -  SmartRAID Adapter for PCI  (PM3224W is 16-bit wide SCSI)</span>
<span class="cm"> *  PM33340UW  -  SmartRAID Adapter for PCI  ultra wide multichannel</span>
<span class="cm"> *</span>
<span class="cm"> *  The above list is just an indication: as a matter of fact all DPT</span>
<span class="cm"> *  boards using the EATA/DMA protocol are supported by this driver,</span>
<span class="cm"> *  since they use exactely the same programming interface.</span>
<span class="cm"> *</span>
<span class="cm"> *  The DPT PM2001 provides only the EATA/PIO interface and hence is not</span>
<span class="cm"> *  supported by this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *  This code has been tested with up to 3 Distributed Processing Technology</span>
<span class="cm"> *  PM2122A/9X (DPT SCSI BIOS v002.D1, firmware v05E.0) EISA controllers,</span>
<span class="cm"> *  in any combination of private and shared IRQ.</span>
<span class="cm"> *  PCI support has been tested using up to 2 DPT PM3224W (DPT SCSI BIOS</span>
<span class="cm"> *  v003.D0, firmware v07G.0).</span>
<span class="cm"> *</span>
<span class="cm"> *  DPT SmartRAID boards support &quot;Hardware Array&quot; - a group of disk drives</span>
<span class="cm"> *  which are all members of the same RAID-0, RAID-1 or RAID-5 array implemented</span>
<span class="cm"> *  in host adapter hardware. Hardware Arrays are fully compatible with this</span>
<span class="cm"> *  driver, since they look to it as a single disk drive.</span>
<span class="cm"> *</span>
<span class="cm"> *  WARNING: to create a RAID-0 &quot;Hardware Array&quot; you must select &quot;Other Unix&quot;</span>
<span class="cm"> *  as the current OS in the DPTMGR &quot;Initial System Installation&quot; menu.</span>
<span class="cm"> *  Otherwise RAID-0 is generated as an &quot;Array Group&quot; (i.e. software RAID-0),</span>
<span class="cm"> *  which is not supported by the actual SCSI subsystem.</span>
<span class="cm"> *  To get the &quot;Array Group&quot; functionality, the Linux MD driver must be used</span>
<span class="cm"> *  instead of the DPT &quot;Array Group&quot; feature.</span>
<span class="cm"> *</span>
<span class="cm"> *  Multiple ISA, EISA and PCI boards can be configured in the same system.</span>
<span class="cm"> *  It is suggested to put all the EISA boards on the same IRQ level, all</span>
<span class="cm"> *  the PCI  boards on another IRQ level, while ISA boards cannot share</span>
<span class="cm"> *  interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> *  If you configure multiple boards on the same IRQ, the interrupt must</span>
<span class="cm"> *  be _level_ triggered (not _edge_ triggered).</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver detects EATA boards by probes at fixed port addresses,</span>
<span class="cm"> *  so no BIOS32 or PCI BIOS support is required.</span>
<span class="cm"> *  The suggested way to detect a generic EATA PCI board is to force on it</span>
<span class="cm"> *  any unused EISA address, even if there are other controllers on the EISA</span>
<span class="cm"> *  bus, or even if you system has no EISA bus at all.</span>
<span class="cm"> *  Do not force any ISA address on EATA PCI boards.</span>
<span class="cm"> *</span>
<span class="cm"> *  If PCI bios support is configured into the kernel, BIOS32 is used to</span>
<span class="cm"> *  include in the list of i/o ports to be probed all the PCI SCSI controllers.</span>
<span class="cm"> *</span>
<span class="cm"> *  Due to a DPT BIOS &quot;feature&quot;, it might not be possible to force an EISA</span>
<span class="cm"> *  address on more than a single DPT PCI board, so in this case you have to</span>
<span class="cm"> *  let the PCI BIOS assign the addresses.</span>
<span class="cm"> *</span>
<span class="cm"> *  The sequence of detection probes is:</span>
<span class="cm"> *</span>
<span class="cm"> *  - ISA 0x1F0;</span>
<span class="cm"> *  - PCI SCSI controllers (only if BIOS32 is available);</span>
<span class="cm"> *  - EISA/PCI 0x1C88 through 0xFC88 (corresponding to EISA slots 1 to 15);</span>
<span class="cm"> *  - ISA  0x170, 0x230, 0x330.</span>
<span class="cm"> *</span>
<span class="cm"> *  The above list of detection probes can be totally replaced by the</span>
<span class="cm"> *  boot command line option: &quot;eata=port0,port1,port2,...&quot;, where the</span>
<span class="cm"> *  port0, port1... arguments are ISA/EISA/PCI addresses to be probed.</span>
<span class="cm"> *  For example using &quot;eata=0x7410,0x7450,0x230&quot;, the driver probes</span>
<span class="cm"> *  only the two PCI addresses 0x7410 and 0x7450 and the ISA address 0x230,</span>
<span class="cm"> *  in this order; &quot;eata=0&quot; totally disables this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *  After the optional list of detection probes, other possible command line</span>
<span class="cm"> *  options are:</span>
<span class="cm"> *</span>
<span class="cm"> *  et:y  force use of extended translation (255 heads, 63 sectors);</span>
<span class="cm"> *  et:n  use disk geometry detected by scsicam_bios_param;</span>
<span class="cm"> *  rs:y  reverse scan order while detecting PCI boards;</span>
<span class="cm"> *  rs:n  use BIOS order while detecting PCI boards;</span>
<span class="cm"> *  lc:y  enables linked commands;</span>
<span class="cm"> *  lc:n  disables linked commands;</span>
<span class="cm"> *  tm:0  disables tagged commands (same as tc:n);</span>
<span class="cm"> *  tm:1  use simple queue tags (same as tc:y);</span>
<span class="cm"> *  tm:2  use ordered queue tags (same as tc:2);</span>
<span class="cm"> *  mq:xx set the max queue depth to the value xx (2 &lt;= xx &lt;= 32).</span>
<span class="cm"> *</span>
<span class="cm"> *  The default value is: &quot;eata=lc:n,mq:16,tm:0,et:n,rs:n&quot;.</span>
<span class="cm"> *  An example using the list of detection probes could be:</span>
<span class="cm"> *  &quot;eata=0x7410,0x230,lc:y,tm:2,mq:4,et:n&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *  When loading as a module, parameters can be specified as well.</span>
<span class="cm"> *  The above example would be (use 1 in place of y and 0 in place of n):</span>
<span class="cm"> *</span>
<span class="cm"> *  modprobe eata io_port=0x7410,0x230 linked_comm=1 \</span>
<span class="cm"> *                max_queue_depth=4 ext_tran=0 tag_mode=2 \</span>
<span class="cm"> *                rev_scan=1</span>
<span class="cm"> *</span>
<span class="cm"> *  ----------------------------------------------------------------------------</span>
<span class="cm"> *  In this implementation, linked commands are designed to work with any DISK</span>
<span class="cm"> *  or CD-ROM, since this linking has only the intent of clustering (time-wise)</span>
<span class="cm"> *  and reordering by elevator sorting commands directed to each device,</span>
<span class="cm"> *  without any relation with the actual SCSI protocol between the controller</span>
<span class="cm"> *  and the device.</span>
<span class="cm"> *  If Q is the queue depth reported at boot time for each device (also named</span>
<span class="cm"> *  cmds/lun) and Q &gt; 2, whenever there is already an active command to the</span>
<span class="cm"> *  device all other commands to the same device  (up to Q-1) are kept waiting</span>
<span class="cm"> *  in the elevator sorting queue. When the active command completes, the</span>
<span class="cm"> *  commands in this queue are sorted by sector address. The sort is chosen</span>
<span class="cm"> *  between increasing or decreasing by minimizing the seek distance between</span>
<span class="cm"> *  the sector of the commands just completed and the sector of the first</span>
<span class="cm"> *  command in the list to be sorted.</span>
<span class="cm"> *  Trivial math assures that the unsorted average seek distance when doing</span>
<span class="cm"> *  random seeks over S sectors is S/3.</span>
<span class="cm"> *  When (Q-1) requests are uniformly distributed over S sectors, the average</span>
<span class="cm"> *  distance between two adjacent requests is S/((Q-1) + 1), so the sorted</span>
<span class="cm"> *  average seek distance for (Q-1) random requests over S sectors is S/Q.</span>
<span class="cm"> *  The elevator sorting hence divides the seek distance by a factor Q/3.</span>
<span class="cm"> *  The above pure geometric remarks are valid in all cases and the</span>
<span class="cm"> *  driver effectively reduces the seek distance by the predicted factor</span>
<span class="cm"> *  when there are Q concurrent read i/o operations on the device, but this</span>
<span class="cm"> *  does not necessarily results in a noticeable performance improvement:</span>
<span class="cm"> *  your mileage may vary....</span>
<span class="cm"> *</span>
<span class="cm"> *  Note: command reordering inside a batch of queued commands could cause</span>
<span class="cm"> *        wrong results only if there is at least one write request and the</span>
<span class="cm"> *        intersection (sector-wise) of all requests is not empty.</span>
<span class="cm"> *        When the driver detects a batch including overlapping requests</span>
<span class="cm"> *        (a really rare event) strict serial (pid) order is enforced.</span>
<span class="cm"> *  ----------------------------------------------------------------------------</span>
<span class="cm"> *  The extended translation option (et:y) is useful when using large physical</span>
<span class="cm"> *  disks/arrays. It could also be useful when switching between Adaptec boards</span>
<span class="cm"> *  and DPT boards without reformatting the disk.</span>
<span class="cm"> *  When a boot disk is partitioned with extended translation, in order to</span>
<span class="cm"> *  be able to boot it with a DPT board is could be necessary to add to</span>
<span class="cm"> *  lilo.conf additional commands as in the following example:</span>
<span class="cm"> *</span>
<span class="cm"> *  fix-table</span>
<span class="cm"> *  disk=/dev/sda bios=0x80 sectors=63 heads=128 cylindres=546</span>
<span class="cm"> *</span>
<span class="cm"> *  where the above geometry should be replaced with the one reported at</span>
<span class="cm"> *  power up by the DPT controller.</span>
<span class="cm"> *  ----------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *  The boards are named EATA0, EATA1,... according to the detection order.</span>
<span class="cm"> *</span>
<span class="cm"> *  In order to support multiple ISA boards in a reliable way,</span>
<span class="cm"> *  the driver sets host-&gt;wish_block = 1 for all ISA boards.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">,</span>
			     <span class="n">sector_t</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;EATA/DMA 2.0x rev. 8.10.00 &quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">eata2x_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">eata2x_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">eata2x_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">eata2x_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span> <span class="o">=</span> <span class="n">eata2x_eh_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span> <span class="o">=</span> <span class="n">eata2x_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span> <span class="o">=</span> <span class="n">eata2x_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if !defined(__BIG_ENDIAN_BITFIELD) &amp;&amp; !defined(__LITTLE_ENDIAN_BITFIELD)</span>
<span class="cp">#error &quot;Adjust your &lt;asm/byteorder.h&gt; defines&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/* Subversion values */</span>
<span class="cp">#define ISA  0</span>
<span class="cp">#define ESA 1</span>

<span class="cp">#undef  FORCE_CONFIG</span>

<span class="cp">#undef  DEBUG_LINKED_COMMANDS</span>
<span class="cp">#undef  DEBUG_DETECT</span>
<span class="cp">#undef  DEBUG_PCI_DETECT</span>
<span class="cp">#undef  DEBUG_INTERRUPT</span>
<span class="cp">#undef  DEBUG_RESET</span>
<span class="cp">#undef  DEBUG_GENERATE_ERRORS</span>
<span class="cp">#undef  DEBUG_GENERATE_ABORTS</span>
<span class="cp">#undef  DEBUG_GEOMETRY</span>

<span class="cp">#define MAX_ISA 4</span>
<span class="cp">#define MAX_VESA 0</span>
<span class="cp">#define MAX_EISA 15</span>
<span class="cp">#define MAX_PCI 16</span>
<span class="cp">#define MAX_BOARDS (MAX_ISA + MAX_VESA + MAX_EISA + MAX_PCI)</span>
<span class="cp">#define MAX_CHANNEL 4</span>
<span class="cp">#define MAX_LUN 32</span>
<span class="cp">#define MAX_TARGET 32</span>
<span class="cp">#define MAX_MAILBOXES 64</span>
<span class="cp">#define MAX_SGLIST 64</span>
<span class="cp">#define MAX_LARGE_SGLIST 122</span>
<span class="cp">#define MAX_INTERNAL_RETRIES 64</span>
<span class="cp">#define MAX_CMD_PER_LUN 2</span>
<span class="cp">#define MAX_TAGGED_CMD_PER_LUN (MAX_MAILBOXES - MAX_CMD_PER_LUN)</span>

<span class="cp">#define SKIP ULONG_MAX</span>
<span class="cp">#define FREE 0</span>
<span class="cp">#define IN_USE   1</span>
<span class="cp">#define LOCKED   2</span>
<span class="cp">#define IN_RESET 3</span>
<span class="cp">#define IGNORE   4</span>
<span class="cp">#define READY    5</span>
<span class="cp">#define ABORTING 6</span>
<span class="cp">#define NO_DMA  0xff</span>
<span class="cp">#define MAXLOOP  10000</span>
<span class="cp">#define TAG_DISABLED 0</span>
<span class="cp">#define TAG_SIMPLE   1</span>
<span class="cp">#define TAG_ORDERED  2</span>

<span class="cp">#define REG_CMD         7</span>
<span class="cp">#define REG_STATUS      7</span>
<span class="cp">#define REG_AUX_STATUS  8</span>
<span class="cp">#define REG_DATA        0</span>
<span class="cp">#define REG_DATA2       1</span>
<span class="cp">#define REG_SEE         6</span>
<span class="cp">#define REG_LOW         2</span>
<span class="cp">#define REG_LM          3</span>
<span class="cp">#define REG_MID         4</span>
<span class="cp">#define REG_MSB         5</span>
<span class="cp">#define REGION_SIZE     9UL</span>
<span class="cp">#define MAX_ISA_ADDR    0x03ff</span>
<span class="cp">#define MIN_EISA_ADDR   0x1c88</span>
<span class="cp">#define MAX_EISA_ADDR   0xfc88</span>
<span class="cp">#define BSY_ASSERTED      0x80</span>
<span class="cp">#define DRQ_ASSERTED      0x08</span>
<span class="cp">#define ABSY_ASSERTED     0x01</span>
<span class="cp">#define IRQ_ASSERTED      0x02</span>
<span class="cp">#define READ_CONFIG_PIO   0xf0</span>
<span class="cp">#define SET_CONFIG_PIO    0xf1</span>
<span class="cp">#define SEND_CP_PIO       0xf2</span>
<span class="cp">#define RECEIVE_SP_PIO    0xf3</span>
<span class="cp">#define TRUNCATE_XFR_PIO  0xf4</span>
<span class="cp">#define RESET_PIO         0xf9</span>
<span class="cp">#define READ_CONFIG_DMA   0xfd</span>
<span class="cp">#define SET_CONFIG_DMA    0xfe</span>
<span class="cp">#define SEND_CP_DMA       0xff</span>
<span class="cp">#define ASOK              0x00</span>
<span class="cp">#define ASST              0x01</span>

<span class="cp">#define YESNO(a) ((a) ? &#39;y&#39; : &#39;n&#39;)</span>
<span class="cp">#define TLDEV(type) ((type) == TYPE_DISK || (type) == TYPE_ROM)</span>

<span class="cm">/* &quot;EATA&quot;, in Big Endian format */</span>
<span class="cp">#define EATA_SIG_BE 0x45415441</span>

<span class="cm">/* Number of valid bytes in the board config structure for EATA 2.0x */</span>
<span class="cp">#define EATA_2_0A_SIZE 28</span>
<span class="cp">#define EATA_2_0B_SIZE 30</span>
<span class="cp">#define EATA_2_0C_SIZE 34</span>

<span class="cm">/* Board info structure */</span>
<span class="k">struct</span> <span class="n">eata_info</span> <span class="p">{</span>
	<span class="n">u_int32_t</span> <span class="n">data_len</span><span class="p">;</span>	<span class="cm">/* Number of valid bytes after this field */</span>
	<span class="n">u_int32_t</span> <span class="n">sign</span><span class="p">;</span>		<span class="cm">/* ASCII &quot;EATA&quot; signature */</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
	<span class="n">unchar</span> <span class="n">version</span>	<span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
	       		<span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">haaval</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">ata</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">drqvld</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">dmasup</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">morsup</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">trnxfr</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">tarsup</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">ocsena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">unchar</span>		<span class="o">:</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* unused low nibble */</span>
	 	<span class="n">version</span>	<span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* EATA version, should be 0x1 */</span>
	<span class="n">unchar</span> <span class="n">ocsena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Overlap Command Support Enabled */</span>
	       <span class="n">tarsup</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Target Mode Supported */</span>
	       <span class="n">trnxfr</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Truncate Transfer Cmd NOT Necessary */</span>
	       <span class="n">morsup</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* More Supported */</span>
	       <span class="n">dmasup</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* DMA Supported */</span>
	       <span class="n">drqvld</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* DRQ Index (DRQX) is valid */</span>
	       <span class="n">ata</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* This is an ATA device */</span>
	       <span class="n">haaval</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Host Adapter Address Valid */</span>
<span class="cp">#endif</span>

	<span class="n">ushort</span> <span class="n">cp_pad_len</span><span class="p">;</span>	<span class="cm">/* Number of pad bytes after cp_len */</span>
	<span class="n">unchar</span> <span class="n">host_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Host Adapter SCSI ID for channels 3, 2, 1, 0 */</span>
	<span class="n">u_int32_t</span> <span class="n">cp_len</span><span class="p">;</span>	<span class="cm">/* Number of valid bytes in cp */</span>
	<span class="n">u_int32_t</span> <span class="n">sp_len</span><span class="p">;</span>	<span class="cm">/* Number of valid bytes in sp */</span>
	<span class="n">ushort</span> <span class="n">queue_size</span><span class="p">;</span>	<span class="cm">/* Max number of cp that can be queued */</span>
	<span class="n">ushort</span> <span class="n">unused</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">scatt_size</span><span class="p">;</span>	<span class="cm">/* Max number of entries in scatter/gather table */</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
	<span class="n">unchar</span> <span class="n">drqx</span>	<span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
	       <span class="n">second</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">irq_tr</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">irq</span>	<span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">unchar</span>		<span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
	       <span class="n">res1</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">large_sg</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">forcaddr</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">isaena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">max_chan</span>	<span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
	       <span class="n">max_id</span>	<span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">max_lun</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">eisa</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">pci</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">idquest</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">m1</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       		<span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">unchar</span> <span class="n">irq</span>	<span class="o">:</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* Interrupt Request assigned to this controller */</span>
	       <span class="n">irq_tr</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* 0 for edge triggered, 1 for level triggered */</span>
	       <span class="n">second</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* 1 if this is a secondary (not primary) controller */</span>
	       <span class="n">drqx</span>	<span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* DRQ Index (0=DMA0, 1=DMA7, 2=DMA6, 3=DMA5) */</span>
	<span class="n">unchar</span> <span class="n">sync</span><span class="p">;</span>		<span class="cm">/* 1 if scsi target id 7...0 is running sync scsi */</span>

	<span class="cm">/* Structure extension defined in EATA 2.0B */</span>
	<span class="n">unchar</span> <span class="n">isaena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* ISA i/o addressing is disabled/enabled */</span>
	       <span class="n">forcaddr</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Port address has been forced */</span>
	       <span class="n">large_sg</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* 1 if large SG lists are supported */</span>
	       <span class="n">res1</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       		<span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">max_id</span>	<span class="o">:</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* Max SCSI target ID number */</span>
	       <span class="n">max_chan</span>	<span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Max SCSI channel number on this board */</span>

	<span class="cm">/* Structure extension defined in EATA 2.0C */</span>
	<span class="n">unchar</span> <span class="n">max_lun</span><span class="p">;</span>		<span class="cm">/* Max SCSI LUN number */</span>
	<span class="n">unchar</span>
			<span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
	       <span class="n">m1</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* This is a PCI with an M1 chip installed */</span>
	       <span class="n">idquest</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* RAIDNUM returned is questionable */</span>
	       <span class="n">pci</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* This board is PCI */</span>
	       <span class="n">eisa</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* This board is EISA */</span>
<span class="cp">#endif</span>

	<span class="n">unchar</span> <span class="n">raidnum</span><span class="p">;</span>		<span class="cm">/* Uniquely identifies this HBA in a system */</span>
	<span class="n">unchar</span> <span class="n">notused</span><span class="p">;</span>

	<span class="n">ushort</span> <span class="n">ipad</span><span class="p">[</span><span class="mi">247</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Board config structure */</span>
<span class="k">struct</span> <span class="n">eata_config</span> <span class="p">{</span>
	<span class="n">ushort</span> <span class="n">len</span><span class="p">;</span>		<span class="cm">/* Number of bytes following this field */</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
	<span class="n">unchar</span>		<span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
	       <span class="n">tarena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">mdpena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">ocena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">edis</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">unchar</span> <span class="n">edis</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Disable EATA interface after config command */</span>
	       <span class="n">ocena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Overlapped Commands Enabled */</span>
	       <span class="n">mdpena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Transfer all Modified Data Pointer Messages */</span>
	       <span class="n">tarena</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Target Mode Enabled for this controller */</span>
	       		<span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">unchar</span> <span class="n">cpad</span><span class="p">[</span><span class="mi">511</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Returned status packet structure */</span>
<span class="k">struct</span> <span class="n">mssp</span> <span class="p">{</span>
<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
	<span class="n">unchar</span> <span class="n">eoc</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">adapter_status</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">unchar</span> <span class="n">adapter_status</span> <span class="o">:</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/* State related to current command */</span>
	       <span class="n">eoc</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* End Of Command (1 = command completed) */</span>
<span class="cp">#endif</span>
	<span class="n">unchar</span> <span class="n">target_status</span><span class="p">;</span>	<span class="cm">/* SCSI status received after data transfer */</span>
	<span class="n">unchar</span> <span class="n">unused</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u_int32_t</span> <span class="n">inv_res_len</span><span class="p">;</span>	<span class="cm">/* Number of bytes not transferred */</span>
	<span class="n">u_int32_t</span> <span class="n">cpp_index</span><span class="p">;</span>	<span class="cm">/* Index of address set in cp */</span>
	<span class="kt">char</span> <span class="n">mess</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sg_list</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span>	<span class="cm">/* Segment Address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">;</span>	<span class="cm">/* Segment Length */</span>
<span class="p">};</span>

<span class="cm">/* MailBox SCSI Command Packet */</span>
<span class="k">struct</span> <span class="n">mscp</span> <span class="p">{</span>
<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
	<span class="n">unchar</span> <span class="n">din</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">dout</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">interp</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       		<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">sg</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">reqsen</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">init</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">sreset</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">unused</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">unchar</span>		<span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
	       <span class="n">fwnest</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unchar</span>		<span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
	       <span class="n">hbaci</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">iat</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">phsunit</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">channel</span>	<span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
	       <span class="n">target</span>	<span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">one</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">dispri</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">luntar</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">lun</span>	<span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">unchar</span> <span class="n">sreset</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* SCSI Bus Reset Signal should be asserted */</span>
	       <span class="n">init</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Re-initialize controller and self test */</span>
	       <span class="n">reqsen</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Transfer Request Sense Data to addr using DMA */</span>
	       <span class="n">sg</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Use Scatter/Gather */</span>
	       		<span class="o">:</span><span class="mi">1</span><span class="p">,</span>
	       <span class="n">interp</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* The controller interprets cp, not the target */</span>
	       <span class="n">dout</span>	<span class="o">:</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Direction of Transfer is Out (Host to Target) */</span>
	       <span class="n">din</span>	<span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Direction of Transfer is In (Target to Host) */</span>
	<span class="n">unchar</span> <span class="n">sense_len</span><span class="p">;</span>	<span class="cm">/* Request Sense Length */</span>
	<span class="n">unchar</span> <span class="n">unused</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">unchar</span> <span class="n">fwnest</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Send command to a component of an Array Group */</span>
			<span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">phsunit</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Send to Target Physical Unit (bypass RAID) */</span>
	       <span class="n">iat</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Inhibit Address Translation */</span>
	       <span class="n">hbaci</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Inhibit HBA Caching for this command */</span>
	       		<span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="n">target</span>	<span class="o">:</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* SCSI target ID */</span>
	       <span class="n">channel</span>	<span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* SCSI channel number */</span>
	<span class="n">unchar</span> <span class="n">lun</span>	<span class="o">:</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* SCSI logical unit number */</span>
	       <span class="n">luntar</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* This cp is for Target (not LUN) */</span>
	       <span class="n">dispri</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* Disconnect Privilege granted */</span>
	       <span class="n">one</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 1 */</span>
<span class="cp">#endif</span>

	<span class="n">unchar</span> <span class="n">mess</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Massage to/from Target */</span>
	<span class="n">unchar</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>		<span class="cm">/* Command Descriptor Block */</span>
	<span class="n">u_int32_t</span> <span class="n">data_len</span><span class="p">;</span>	<span class="cm">/* If sg=0 Data Length, if sg=1 sglist length */</span>
	<span class="n">u_int32_t</span> <span class="n">cpp_index</span><span class="p">;</span>	<span class="cm">/* Index of address to be returned in sp */</span>
	<span class="n">u_int32_t</span> <span class="n">data_address</span><span class="p">;</span>	<span class="cm">/* If sg=0 Data Address, if sg=1 sglist address */</span>
	<span class="n">u_int32_t</span> <span class="n">sp_dma_addr</span><span class="p">;</span>	<span class="cm">/* Address where sp is DMA&#39;ed when cp completes */</span>
	<span class="n">u_int32_t</span> <span class="n">sense_addr</span><span class="p">;</span>	<span class="cm">/* Address where Sense Data is DMA&#39;ed on error */</span>

	<span class="cm">/* Additional fields begin here. */</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="cm">/* All the cp structure is zero filled by queuecommand except the</span>
<span class="cm">	   following CP_TAIL_SIZE bytes, initialized by detect */</span>
	<span class="n">dma_addr_t</span> <span class="n">cp_dma_addr</span><span class="p">;</span>	<span class="cm">/* dma handle for this cp structure */</span>
	<span class="k">struct</span> <span class="n">sg_list</span> <span class="o">*</span><span class="n">sglist</span><span class="p">;</span>	<span class="cm">/* pointer to the allocated SG list */</span>
<span class="p">};</span>

<span class="cp">#define CP_TAIL_SIZE (sizeof(struct sglist *) + sizeof(dma_addr_t))</span>

<span class="k">struct</span> <span class="n">hostdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="n">cp</span><span class="p">[</span><span class="n">MAX_MAILBOXES</span><span class="p">];</span>	<span class="cm">/* Mailboxes for this board */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cp_stat</span><span class="p">[</span><span class="n">MAX_MAILBOXES</span><span class="p">];</span>	<span class="cm">/* FREE, IN_USE, LOCKED, IN_RESET */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_cp_used</span><span class="p">;</span>	<span class="cm">/* Index of last mailbox used */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iocount</span><span class="p">;</span>	<span class="cm">/* Total i/o done for this board */</span>
	<span class="kt">int</span> <span class="n">board_number</span><span class="p">;</span>	<span class="cm">/* Number of this board */</span>
	<span class="kt">char</span> <span class="n">board_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/* Name of this board */</span>
	<span class="kt">int</span> <span class="n">in_reset</span><span class="p">;</span>		<span class="cm">/* True if board is doing a reset */</span>
	<span class="kt">int</span> <span class="n">target_to</span><span class="p">[</span><span class="n">MAX_TARGET</span><span class="p">][</span><span class="n">MAX_CHANNEL</span><span class="p">];</span>	<span class="cm">/* N. of timeout errors on target */</span>
	<span class="kt">int</span> <span class="n">target_redo</span><span class="p">[</span><span class="n">MAX_TARGET</span><span class="p">][</span><span class="n">MAX_CHANNEL</span><span class="p">];</span>	<span class="cm">/* If 1 redo i/o on target */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">;</span>	<span class="cm">/* Number of internal retries */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_retried_pid</span><span class="p">;</span>	<span class="cm">/* Pid of last retried command */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">subversion</span><span class="p">;</span>	<span class="cm">/* Bus type, either ISA or EISA/PCI */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">protocol_rev</span><span class="p">;</span>	<span class="cm">/* EATA 2.0 rev., &#39;A&#39; or &#39;B&#39; or &#39;C&#39; */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">is_pci</span><span class="p">;</span>	<span class="cm">/* 1 is bus type is PCI */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>	<span class="cm">/* pdev for PCI bus, NULL otherwise */</span>
	<span class="k">struct</span> <span class="n">mssp</span> <span class="o">*</span><span class="n">sp_cpu_addr</span><span class="p">;</span>	<span class="cm">/* cpu addr for DMA buffer sp */</span>
	<span class="n">dma_addr_t</span> <span class="n">sp_dma_addr</span><span class="p">;</span>	<span class="cm">/* dma handle for DMA buffer sp */</span>
	<span class="k">struct</span> <span class="n">mssp</span> <span class="n">sp</span><span class="p">;</span>		<span class="cm">/* Local copy of sp buffer */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;EATA&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">sha</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">driver_lock</span><span class="p">);</span>

<span class="cm">/* Initialize num_boards so that ihdlr can work while detect is in progress */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_boards</span> <span class="o">=</span> <span class="n">MAX_BOARDS</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* Space for MAX_INT_PARAM ports usable while loading as a module */</span>
	<span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span>
	<span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span>

	<span class="cm">/* First ISA */</span>
	<span class="mh">0x1f0</span><span class="p">,</span>

	<span class="cm">/* Space for MAX_PCI ports possibly reported by PCI_BIOS */</span>
	<span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span>
	<span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">,</span>

	<span class="cm">/* MAX_EISA ports */</span>
	<span class="mh">0x1c88</span><span class="p">,</span> <span class="mh">0x2c88</span><span class="p">,</span> <span class="mh">0x3c88</span><span class="p">,</span> <span class="mh">0x4c88</span><span class="p">,</span> <span class="mh">0x5c88</span><span class="p">,</span> <span class="mh">0x6c88</span><span class="p">,</span> <span class="mh">0x7c88</span><span class="p">,</span> <span class="mh">0x8c88</span><span class="p">,</span>
	<span class="mh">0x9c88</span><span class="p">,</span> <span class="mh">0xac88</span><span class="p">,</span> <span class="mh">0xbc88</span><span class="p">,</span> <span class="mh">0xcc88</span><span class="p">,</span> <span class="mh">0xdc88</span><span class="p">,</span> <span class="mh">0xec88</span><span class="p">,</span> <span class="mh">0xfc88</span><span class="p">,</span>

	<span class="cm">/* Other (MAX_ISA - 1) ports */</span>
	<span class="mh">0x170</span><span class="p">,</span> <span class="mh">0x230</span><span class="p">,</span> <span class="mh">0x330</span><span class="p">,</span>

	<span class="cm">/* End of list */</span>
	<span class="mh">0x0</span>
<span class="p">};</span>

<span class="cm">/* Device is Big Endian */</span>
<span class="cp">#define H2DEV(x)   cpu_to_be32(x)</span>
<span class="cp">#define DEV2H(x)   be32_to_cpu(x)</span>
<span class="cp">#define H2DEV16(x) cpu_to_be16(x)</span>
<span class="cp">#define DEV2H16(x) be16_to_cpu(x)</span>

<span class="cm">/* But transfer orientation from the 16 bit data register is Little Endian */</span>
<span class="cp">#define REG2H(x)   le16_to_cpu(x)</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_interrupt_handler</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_trace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">link_statistics</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext_tran</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rev_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SCSI_EATA_TAGGED_QUEUE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">TAG_SIMPLE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">TAG_DISABLED</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_SCSI_EATA_LINKED_COMMANDS)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">linked_comm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">linked_comm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_SCSI_EATA_MAX_TAGS)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">CONFIG_SCSI_EATA_MAX_TAGS</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_ISA)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isa_probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isa_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_EISA)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eisa_probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eisa_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_PCI)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci_probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_INT_PARAM 10</span>
<span class="cp">#define MAX_BOOT_OPTIONS_SIZE 256</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">boot_options</span><span class="p">[</span><span class="n">MAX_BOOT_OPTIONS_SIZE</span><span class="p">];</span>

<span class="cp">#if defined(MODULE)</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="n">module_param_string</span><span class="p">(</span><span class="n">eata</span><span class="p">,</span> <span class="n">boot_options</span><span class="p">,</span> <span class="n">MAX_BOOT_OPTIONS_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">eata</span><span class="p">,</span> <span class="s">&quot; equivalent to the </span><span class="se">\&quot;</span><span class="s">eata=...</span><span class="se">\&quot;</span><span class="s"> kernel boot option.&quot;</span>
		 <span class="s">&quot;            Example: modprobe eata </span><span class="se">\&quot;</span><span class="s">eata=0x7410,0x230,lc:y,tm:0,mq:4,ep:n</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dario Ballabio&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EATA/DMA SCSI Driver&quot;</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eata2x_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tqd</span><span class="p">,</span> <span class="n">utqd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tag_suffix</span><span class="p">,</span> <span class="o">*</span><span class="n">link_suffix</span><span class="p">;</span>

	<span class="n">utqd</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>
	<span class="n">tqd</span> <span class="o">=</span> <span class="n">max_queue_depth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag_mode</span> <span class="o">==</span> <span class="n">TAG_SIMPLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
			<span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, simple tags&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tag_mode</span> <span class="o">==</span> <span class="n">TAG_ORDERED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
			<span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, ordered tags&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
			<span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, no tags&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">linked_comm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
		<span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, untagged&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">utqd</span><span class="p">);</span>
		<span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">linked_comm</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">link_suffix</span> <span class="o">=</span> <span class="s">&quot;, sorted&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="n">link_suffix</span> <span class="o">=</span> <span class="s">&quot;, unsorted&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">link_suffix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;cmds/lun %d%s%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">link_suffix</span><span class="p">,</span> <span class="n">tag_suffix</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_on_busy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_AUX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ABSY_ASSERTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">unchar</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">byaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">devaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">?</span> <span class="n">MAXLOOP</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">MAXLOOP</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devaddr</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">byaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">devaddr</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">byaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_LOW</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">byaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_LM</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">byaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_MID</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">byaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_MSB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_pio</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">ushort</span> <span class="o">*</span> <span class="n">start</span><span class="p">,</span> <span class="n">ushort</span> <span class="o">*</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">MAXLOOP</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DRQ_ASSERTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">loop</span> <span class="o">=</span> <span class="n">MAXLOOP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">REG2H</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">get_pci_dev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port_base</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PCI)</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_class</span><span class="p">(</span><span class="n">PCI_CLASS_STORAGE_SCSI</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG_PCI_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: get_pci_dev, bus %d, devfn 0x%x, addr 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* we are in so much trouble for a pci hotplug system with this driver</span>
<span class="cm">		 * anyway, so doing this at least lets people unload the driver and not</span>
<span class="cm">		 * cause memory problems, but in general this is a bad thing to do (this</span>
<span class="cm">		 * driver needs to be converted to the proper PCI api someday... */</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span> <span class="o">==</span> <span class="n">port_base</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* end CONFIG_PCI */</span><span class="cp"></span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_pci_ports</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PCI)</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_class</span><span class="p">(</span><span class="n">PCI_CLASS_STORAGE_SCSI</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_PCI_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: enable_pci_ports, bus %d, devfn 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s: warning, pci_enable_device failed, bus %d devfn 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* end CONFIG_PCI */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">port_detect</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma_channel</span><span class="p">,</span> <span class="n">subversion</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_pci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">protocol_rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eata_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bus_type</span><span class="p">,</span> <span class="n">dma_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="cm">/* Allowed DMA channels for ISA (0 indicates reserved) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dma_channel_table</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">REGION_SIZE</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: address 0x%03lx in use, skipping probe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		       <span class="n">port_base</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_dma</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">READ_CONFIG_PIO</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: detect, do_dma failed at 0x%03lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		       <span class="n">port_base</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the info structure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_pio</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">ipad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: detect, read_pio failed at 0x%03lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		       <span class="n">port_base</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">sign</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">cp_pad_len</span> <span class="o">=</span> <span class="n">DEV2H16</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">cp_pad_len</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">cp_len</span> <span class="o">=</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">cp_len</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">sp_len</span> <span class="o">=</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">sp_len</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">scatt_size</span> <span class="o">=</span> <span class="n">DEV2H16</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">scatt_size</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">queue_size</span> <span class="o">=</span> <span class="n">DEV2H16</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">queue_size</span><span class="p">);</span>

	<span class="cm">/* Check the controller &quot;EATA&quot; signature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">sign</span> <span class="o">!=</span> <span class="n">EATA_SIG_BE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: signature 0x%04x discarded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">sign</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="n">EATA_2_0A_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: config structure size (%d bytes) too short, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">data_len</span> <span class="o">==</span> <span class="n">EATA_2_0A_SIZE</span><span class="p">)</span>
		<span class="n">protocol_rev</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">data_len</span> <span class="o">==</span> <span class="n">EATA_2_0B_SIZE</span><span class="p">)</span>
		<span class="n">protocol_rev</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">protocol_rev</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">!=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">forcaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: warning, port address has been forced.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;PCI&quot;</span><span class="p">;</span>
		<span class="n">is_pci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ESA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">&gt;</span> <span class="n">MAX_EISA_ADDR</span>
		   <span class="o">||</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">pci</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;PCI&quot;</span><span class="p">;</span>
		<span class="n">is_pci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ESA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">&gt;=</span> <span class="n">MIN_EISA_ADDR</span>
		   <span class="o">||</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">eisa</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;EISA&quot;</span><span class="p">;</span>
		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ESA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">eisa</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;ISA&quot;</span><span class="p">;</span>
		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ISA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">&gt;</span> <span class="n">MAX_ISA_ADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;PCI&quot;</span><span class="p">;</span>
		<span class="n">is_pci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ESA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;ISA&quot;</span><span class="p">;</span>
		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ISA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">haaval</span> <span class="o">||</span> <span class="n">info</span><span class="p">.</span><span class="n">ata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: address 0x%03lx, unusable %s board (%d%d), detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">name</span><span class="p">,</span> <span class="n">port_base</span><span class="p">,</span> <span class="n">bus_type</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">haaval</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">ata</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">drqvld</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ESA</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: warning, weird %s board using DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			       <span class="n">bus_type</span><span class="p">);</span>

		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ISA</span><span class="p">;</span>
		<span class="n">dma_channel</span> <span class="o">=</span> <span class="n">dma_channel_table</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="n">info</span><span class="p">.</span><span class="n">drqx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ISA</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: warning, weird %s board not using DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">name</span><span class="p">,</span> <span class="n">bus_type</span><span class="p">);</span>

		<span class="n">subversion</span> <span class="o">=</span> <span class="n">ESA</span><span class="p">;</span>
		<span class="n">dma_channel</span> <span class="o">=</span> <span class="n">NO_DMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">dmasup</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: warning, DMA protocol support not asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ESA</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">irq_tr</span><span class="p">)</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: warning, LEVEL triggering is suggested for IRQ %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">get_pci_dev</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s: warning, failed to get pci_dev structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: IRQ %u mapped to IO-APIC IRQ %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Board detected, allocate its IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_interrupt_handler</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="p">((</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ESA</span><span class="p">)</span> <span class="o">?</span> <span class="n">IRQF_SHARED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sha</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate IRQ %u, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		       <span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ISA</span> <span class="o">&amp;&amp;</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate DMA channel %u, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">dma_channel</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">freeirq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if defined(FORCE_CONFIG)</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">eata_config</span> <span class="o">*</span><span class="n">cf</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">cf_dma_addr</span><span class="p">;</span>

		<span class="n">cf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eata_config</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">cf_dma_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s: config, pci_alloc_consistent failed, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">freedma</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set board configuration */</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eata_config</span><span class="p">));</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">H2DEV16</span><span class="p">((</span><span class="n">ushort</span><span class="p">)</span> <span class="mi">510</span><span class="p">);</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">ocena</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_dma</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">cf_dma_addr</span><span class="p">,</span> <span class="n">SET_CONFIG_DMA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s: busy timeout sending configuration, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">name</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eata_config</span><span class="p">),</span>
					    <span class="n">cf</span><span class="p">,</span> <span class="n">cf_dma_addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">freedma</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">shost</span> <span class="o">=</span> <span class="n">scsi_register</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span><span class="p">));</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to register host, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">freedma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="n">REGION_SIZE</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="n">dma_channel</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">info</span><span class="p">.</span><span class="n">scatt_size</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">info</span><span class="p">.</span><span class="n">host_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">info</span><span class="p">.</span><span class="n">queue_size</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">subversion</span> <span class="o">=</span> <span class="n">subversion</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">protocol_rev</span> <span class="o">=</span> <span class="n">protocol_rev</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">is_pci</span> <span class="o">=</span> <span class="n">is_pci</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_number</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ESA</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">,</span> <span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="cm">/* DPT PM2012 does not allow to detect sg_tablesize correctly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">&gt;</span> <span class="n">MAX_SGLIST</span> <span class="o">||</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: detect, wrong n. of SG lists %d, fixed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">);</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">MAX_SGLIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DPT PM2012 does not allow to detect can_queue correctly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">&gt;</span> <span class="n">MAX_MAILBOXES</span> <span class="o">||</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: detect, wrong n. of mbox %d, fixed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">);</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">MAX_MAILBOXES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">!=</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">max_chan</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">max_chan</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNEL</span><span class="p">)</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">max_chan</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">max_id</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">max_id</span> <span class="o">&lt;</span> <span class="n">MAX_TARGET</span><span class="p">)</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">max_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">large_sg</span> <span class="o">&amp;&amp;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">==</span> <span class="n">MAX_SGLIST</span><span class="p">)</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">MAX_LARGE_SGLIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">max_lun</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">max_lun</span> <span class="o">&lt;</span> <span class="n">MAX_LUN</span><span class="p">)</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">max_lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_channel</span> <span class="o">==</span> <span class="n">NO_DMA</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dma_name</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;BMST&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dma_name</span><span class="p">,</span> <span class="s">&quot;DMA %u&quot;</span><span class="p">,</span> <span class="n">dma_channel</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cp_dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">),</span>
							  <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_list</span><span class="p">);</span>
		<span class="n">gfp_t</span> <span class="n">gfp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">?</span> <span class="n">GFP_DMA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">GFP_ATOMIC</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sglist</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sglist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s: kmalloc SGlist failed, mbox %d, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_cpu_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mssp</span><span class="p">),</span>
							<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_dma_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: pci_alloc_consistent failed, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_queue_depth</span> <span class="o">&gt;</span> <span class="n">MAX_TAGGED_CMD_PER_LUN</span><span class="p">)</span>
		<span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">MAX_TAGGED_CMD_PER_LUN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_queue_depth</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">)</span>
		<span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag_mode</span> <span class="o">!=</span> <span class="n">TAG_DISABLED</span> <span class="o">&amp;&amp;</span> <span class="n">tag_mode</span> <span class="o">!=</span> <span class="n">TAG_SIMPLE</span><span class="p">)</span>
		<span class="n">tag_mode</span> <span class="o">=</span> <span class="n">TAG_ORDERED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;EATA/DMA 2.0x: Copyright (C) 1994-2003 Dario Ballabio.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s config options -&gt; tm:%d, lc:%c, mq:%d, rs:%c, et:%c, &quot;</span>
		     <span class="s">&quot;ip:%c, ep:%c, pp:%c.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">tag_mode</span><span class="p">,</span>
		     <span class="n">YESNO</span><span class="p">(</span><span class="n">linked_comm</span><span class="p">),</span> <span class="n">max_queue_depth</span><span class="p">,</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">rev_scan</span><span class="p">),</span>
		     <span class="n">YESNO</span><span class="p">(</span><span class="n">ext_tran</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">isa_probe</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">eisa_probe</span><span class="p">),</span>
		     <span class="n">YESNO</span><span class="p">(</span><span class="n">pci_probe</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: 2.0%c, %s 0x%03lx, IRQ %u, %s, SG %d, MB %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">protocol_rev</span><span class="p">,</span> <span class="n">bus_type</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dma_name</span><span class="p">,</span>
	       <span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: wide SCSI support enabled, max_id %u, max_lun %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SCSI channel %u enabled, host target ID %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">host_addr</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="n">i</span><span class="p">]);</span>

<span class="cp">#if defined(DEBUG_DETECT)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Vers. 0x%x, ocs %u, tar %u, trnxfr %u, more %u, SYNC 0x%x, &quot;</span>
	       <span class="s">&quot;sec. %u, infol %d, cpl %d spl %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
	       <span class="n">info</span><span class="p">.</span><span class="n">ocsena</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">tarsup</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">trnxfr</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">morsup</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">sync</span><span class="p">,</span>
	       <span class="n">info</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">data_len</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">cp_len</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">sp_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span> <span class="o">||</span> <span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: isaena %u, forcaddr %u, max_id %u, max_chan %u, &quot;</span>
		       <span class="s">&quot;large_sg %u, res1 %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">isaena</span><span class="p">,</span>
		       <span class="n">info</span><span class="p">.</span><span class="n">forcaddr</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">max_id</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">max_chan</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">large_sg</span><span class="p">,</span>
		       <span class="n">info</span><span class="p">.</span><span class="n">res1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol_rev</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: max_lun %u, m1 %u, idquest %u, pci %u, eisa %u, &quot;</span>
		       <span class="s">&quot;raidnum %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">max_lun</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">m1</span><span class="p">,</span>
		       <span class="n">info</span><span class="p">.</span><span class="n">idquest</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eisa</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">raidnum</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: warning, pci_set_dma_mask failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

      <span class="nl">freedma:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ISA</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
      <span class="nl">freeirq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sha</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
      <span class="nl">freelock:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">REGION_SIZE</span><span class="p">);</span>
      <span class="nl">fail:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">release:</span>
	<span class="n">eata2x_release</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">internal_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">MAX_INT_PARAM</span><span class="p">)</span>
			<span class="n">argc</span> <span class="o">=</span> <span class="n">MAX_INT_PARAM</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">io_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">io_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">setup_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*++</span><span class="n">pc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;Y&#39;</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;lc:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">linked_comm</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;tm:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">tag_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;tc:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">tag_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;mq:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;ls:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">link_statistics</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;et:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">ext_tran</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;rs:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">rev_scan</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;ip:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">isa_probe</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;ep:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">eisa_probe</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;pp:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">pci_probe</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)))</span>
			<span class="o">++</span><span class="n">cur</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">option_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="n">MAX_INT_PARAM</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_INT_PARAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ints</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">cur</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">internal_setup</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_pci_ports</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PCI)</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_PCI</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_class</span><span class="p">(</span><span class="n">PCI_CLASS_STORAGE_SCSI</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_PCI_DETECT)</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s: detect, bus %d, devfn 0x%x, pci_enable_device failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG_PCI_DETECT)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: detect, seq. %d, bus %d, devfn 0x%x, addr 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">driver_name</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Order addresses according to rev_scan value */</span>
		<span class="n">io_port</span><span class="p">[</span><span class="n">MAX_INT_PARAM</span> <span class="o">+</span> <span class="p">(</span><span class="n">rev_scan</span> <span class="o">?</span> <span class="p">(</span><span class="n">MAX_PCI</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">))]</span> <span class="o">=</span>
		    <span class="n">addr</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* end CONFIG_PCI */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eata2x_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;eata2x&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">boot_options</span><span class="p">))</span>
		<span class="n">option_setup</span><span class="p">(</span><span class="n">boot_options</span><span class="p">);</span>

<span class="cp">#if defined(MODULE)</span>
	<span class="cm">/* io_port could have been modified when loading as a module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setup_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">io_port</span><span class="p">[</span><span class="n">MAX_INT_PARAM</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">MAX_INT_PARAM</span><span class="p">;</span> <span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">SKIP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">MAX_ISA_ADDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isa_probe</span><span class="p">)</span>
				<span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">SKIP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MIN_EISA_ADDR</span>
			   <span class="o">&amp;&amp;</span> <span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">MAX_EISA_ADDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eisa_probe</span><span class="p">)</span>
				<span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">SKIP</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup_done</span><span class="p">)</span>
			<span class="n">add_pci_ports</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="n">enable_pci_ports</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">SKIP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span> <span class="o">&amp;&amp;</span> <span class="n">port_detect</span><span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">tpnt</span><span class="p">))</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_boards</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">map_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">pci_dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">)</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span> <span class="o">=</span>
		    <span class="n">H2DEV</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
			   <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>

	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span>
			   <span class="n">pci_dir</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">);</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">num_bytes</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
						 <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="o">*</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_list</span><span class="p">),</span>
						 <span class="n">pci_dir</span><span class="p">));</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">((</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_list</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unmap_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">))</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">),</span>
				 <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span>
		<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span>
			     <span class="n">pci_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">))</span>
		<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">))</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">),</span>
				 <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">),</span> <span class="n">pci_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">))</span>
		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">),</span>
					    <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">),</span>
					    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span>
		<span class="n">pci_dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span>
					<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">pci_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">))</span>
		<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">))</span>
		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					    <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">),</span>
					    <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">),</span> <span class="n">pci_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scsi_to_dev_dir</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_out_cmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span>
		<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x5d</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_none_cmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
		<span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
		<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">dout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">dout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">dout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: qcomm, invalid SCpnt-&gt;sc_data_direction.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data_out_cmds</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data_out_cmds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">dout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span> <span class="o">=</span> <span class="o">!</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">dout</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data_none_cmds</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data_none_cmds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eata2x_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: qcomm, SCpnt %p already active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="cm">/* i is the mailbox number, look for the first free mailbox</span>
<span class="cm">	   starting from last_cp_used */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_cp_used</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_cp_used</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: qcomm, no free mailbox.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set pointer to control packet structure */</span>
	<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cpp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">)</span> <span class="o">-</span> <span class="n">CP_TAIL_SIZE</span><span class="p">);</span>

	<span class="cm">/* Set pointer to status packet structure, Big Endian format */</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sp_dma_addr</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_dma_addr</span><span class="p">);</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cpp_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cpp_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_trace</span><span class="p">)</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span>
			<span class="s">&quot;qcomm, mbox %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">reqsen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">dispri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (SCpnt-&gt;device-&gt;type == TYPE_TAPE)</span>
<span class="c">		cpp-&gt;hbaci = 1;</span>
<span class="cp">#endif</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="cm">/* Use data transfer direction SCpnt-&gt;sc_data_direction */</span>
	<span class="n">scsi_to_dev_dir</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Map DMA buffers and SG list */</span>
	<span class="n">map_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linked_comm</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="mi">2</span>
	    <span class="o">&amp;&amp;</span> <span class="n">TLDEV</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">READY</span><span class="p">;</span>
		<span class="n">flush_dev</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span> <span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send control packet to the board */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_dma</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span><span class="p">,</span> <span class="n">SEND_CP_DMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="s">&quot;qcomm, adapter busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_USE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">eata2x_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">eata2x_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="s">&quot;abort, cmd inactive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="s">&quot;abort, mbox %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: abort, invalid SCarg-&gt;host_scribble.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, timeout error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_USE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCarg</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d, SCarg %p, cp SCpnt %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_AUX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_ASSERTED</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d, interrupt pending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">READY</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, abort, mbox %d ready, DID_ABORT, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d, invalid cp_stat.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eata2x_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arg_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="s">&quot;reset, enter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, inactive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit, already in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit, timeout error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOCKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, locked mbox %d forced free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SCpnt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">))</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, SCpnt == NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">READY</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_RESET</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, garbled SCpnt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, index mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, SCpnt-&gt;scsi_done == NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span> <span class="o">==</span> <span class="n">SCarg</span><span class="p">)</span>
			<span class="n">arg_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_dma</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RESET_PIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, cannot reset, timeout error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, board reset done, enabling interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG_RESET)</span>
	<span class="n">do_trace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">in_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* FIXME: use a sleep instead */</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100L</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, interrupts disabled, loops %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">;</span>
			<span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* This mailbox is still waiting for its interrupt */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LOCKED</span><span class="p">;</span>

			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s, reset, mbox %d locked, DID_RESET, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">;</span>
			<span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* This mailbox was never queued to the adapter */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>

			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%s, reset, mbox %d aborting, DID_RESET, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">else</span>
			<span class="cm">/* Any other mailbox has already been set free by interrupt */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">in_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">do_trace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg_done</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">eata2x_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		      <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dkinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_tran</span> <span class="o">||</span> <span class="p">(</span><span class="n">scsicam_bios_param</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">dkinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">dkinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#if defined (DEBUG_GEOMETRY)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bios_param, head=%d, sec=%d, cyl=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span>
	       <span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dkinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sk</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">da</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
					<span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
					<span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">sk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">da</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reorder</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cursec</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ihdlr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">il</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_ready</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sl</span><span class="p">[</span><span class="n">n_ready</span><span class="p">],</span> <span class="n">pl</span><span class="p">[</span><span class="n">n_ready</span><span class="p">],</span> <span class="n">ll</span><span class="p">[</span><span class="n">n_ready</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minsec</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">,</span> <span class="n">seek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iseek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioseek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flushcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batchcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sortcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">readycount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ovlcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">readysorted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">revcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seeksorted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seeknosort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">++</span><span class="n">flushcount</span> <span class="o">%</span> <span class="n">link_statistics</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fc %d bc %d ic %d oc %d rc %d rs %d sc %d re %d&quot;</span>
		       <span class="s">&quot; av %ldK as %ldK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flushcount</span><span class="p">,</span> <span class="n">batchcount</span><span class="p">,</span>
		       <span class="n">inputcount</span><span class="p">,</span> <span class="n">ovlcount</span><span class="p">,</span> <span class="n">readycount</span><span class="p">,</span> <span class="n">readysorted</span><span class="p">,</span> <span class="n">sortcount</span><span class="p">,</span>
		       <span class="n">revcount</span><span class="p">,</span> <span class="n">seeknosort</span> <span class="o">/</span> <span class="p">(</span><span class="n">readycount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		       <span class="n">seeksorted</span> <span class="o">/</span> <span class="p">(</span><span class="n">readycount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_ready</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span><span class="p">)</span>
			<span class="n">input_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minsec</span><span class="p">)</span>
			<span class="n">minsec</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxsec</span><span class="p">)</span>
			<span class="n">maxsec</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>

		<span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="n">ioseek</span> <span class="o">+=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
			<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				<span class="n">seek</span> <span class="o">+=</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">seek</span> <span class="o">+=</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cursec</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">seek</span> <span class="o">+=</span> <span class="n">cursec</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">seek</span> <span class="o">+=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cursec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursec</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">maxsec</span> <span class="o">+</span> <span class="n">minsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioseek</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">maxsec</span> <span class="o">-</span> <span class="n">minsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">)))</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_only</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
			<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
			<span class="n">ll</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
			<span class="n">pl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
			    <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ll</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">ll</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])))</span>
				<span class="n">overlap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cursec</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">iseek</span> <span class="o">=</span> <span class="n">cursec</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">iseek</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cursec</span><span class="p">;</span>
		<span class="n">batchcount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">readycount</span> <span class="o">+=</span> <span class="n">n_ready</span><span class="p">;</span>
		<span class="n">seeknosort</span> <span class="o">+=</span> <span class="n">seek</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">input_only</span><span class="p">)</span>
			<span class="n">inputcount</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ovlcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">seeksorted</span> <span class="o">+=</span> <span class="n">iseek</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">seeksorted</span> <span class="o">+=</span> <span class="p">(</span><span class="n">iseek</span> <span class="o">+</span> <span class="n">maxsec</span> <span class="o">-</span> <span class="n">minsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">revcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">readysorted</span> <span class="o">+=</span> <span class="n">n_ready</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sortcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">readysorted</span> <span class="o">+=</span> <span class="n">n_ready</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if defined(DEBUG_LINKED_COMMANDS)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">overlap</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">flushcount</span> <span class="o">%</span> <span class="n">link_statistics</span><span class="p">)))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
			<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
			<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span>
			    <span class="s">&quot;%s mb %d fc %d nr %d sec %ld ns %u&quot;</span>
			     <span class="s">&quot; cur %ld s:%c r:%c rev:%c in:%c ov:%c xd %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ihdlr</span> <span class="o">?</span> <span class="s">&quot;ihdlr&quot;</span> <span class="o">:</span> <span class="s">&quot;qcomm&quot;</span><span class="p">),</span>
			     <span class="n">k</span><span class="p">,</span> <span class="n">flushcount</span><span class="p">,</span>
			     <span class="n">n_ready</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span>
			     <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span> <span class="n">cursec</span><span class="p">,</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
			     <span class="n">YESNO</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">rev</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">input_only</span><span class="p">),</span>
			     <span class="n">YESNO</span><span class="p">(</span><span class="n">overlap</span><span class="p">),</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">din</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">overlap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cursec</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ihdlr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="n">MAX_MAILBOXES</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">READY</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IN_USE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_USE</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">il</span><span class="p">[</span><span class="n">n_ready</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reorder</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cursec</span><span class="p">,</span> <span class="n">ihdlr</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">))</span>
		<span class="n">n_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span><span class="p">,</span> <span class="n">SEND_CP_DMA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span>
			    <span class="s">&quot;%s, mbox %d, adapter&quot;</span>
			     <span class="s">&quot; busy, will abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ihdlr</span> <span class="o">?</span> <span class="s">&quot;ihdlr&quot;</span> <span class="o">:</span> <span class="s">&quot;qcomm&quot;</span><span class="p">),</span>
			     <span class="n">k</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_USE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ihdlr</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">tstatus</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mssp</span> <span class="o">*</span><span class="n">spp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Check if this board need to be serviced */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_AUX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_ASSERTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_trace</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, enter, irq %d, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>

	<span class="cm">/* Check if this board is still busy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_STATUS</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: ihdlr, busy timeout error,  irq %d, reg 0x%x, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>

	<span class="cm">/* Make a local copy just before clearing the interrupt indication */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">spp</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_cpu_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mssp</span><span class="p">));</span>

	<span class="cm">/* Clear the completion flag and cp pointer on the dynamic copy of sp */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_cpu_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mssp</span><span class="p">));</span>

	<span class="cm">/* Read the status register to clear the interrupt indication */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_STATUS</span><span class="p">);</span>

<span class="cp">#if defined (DEBUG_INTERRUPT)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bytesp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">bytesp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">spp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sp[] =&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">bytesp</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Reject any sp with supspect data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">eoc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: ihdlr, spp-&gt;eoc == 0, irq %d, reg 0x%x, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">cpp_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">cpp_index</span> <span class="o">&gt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;%s: ihdlr, bad spp-&gt;cpp_index %d, irq %d, reg 0x%x, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">cpp_index</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">eoc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">cpp_index</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">cpp_index</span> <span class="o">&gt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>

	<span class="cm">/* Find the mailbox to be serviced on this board */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">cpp_index</span><span class="p">;</span>

	<span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="cp">#if defined(DEBUG_GENERATE_ABORTS)</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">%</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IGNORE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d unlocked, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d is free, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_RESET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d is in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IN_USE</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, invalid cp_stat: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
	<span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, SCpnt == NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, SCpnt %p garbled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span>
		      <span class="n">i</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, index mismatch %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		      <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>

	<span class="n">sync_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linked_comm</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="mi">2</span>
	    <span class="o">&amp;&amp;</span> <span class="n">TLDEV</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="n">flush_dev</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span> <span class="n">ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tstatus</span> <span class="o">=</span> <span class="n">status_byte</span><span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG_GENERATE_ERRORS)</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">%</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASOK</span>:		<span class="cm">/* status OK */</span>

		<span class="cm">/* Forces a reset if a disk drive keeps returning BUSY */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">BUSY</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="cm">/* If there was a bus reset, redo operation on each target */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">!=</span> <span class="n">GOOD</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span>
			 <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">SCpnt</span><span class="o">-&gt;</span>
								  <span class="n">device</span><span class="o">-&gt;</span>
								  <span class="n">channel</span><span class="p">])</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="cm">/* Works around a flaw in scsi.c */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">CHECK_CONDITION</span>
			 <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span>
							      <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">CHECK_CONDITION</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&lt;=</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOT_READY</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, target %d.%d:%d, &quot;</span>
			       <span class="s">&quot;target_status 0x%x, sense key 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span>
			       <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			       <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			       <span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_retried_pid</span> <span class="o">==</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASST</span>:		<span class="cm">/* Selection Time Out */</span>
	<span class="k">case</span> <span class="mh">0x02</span>:		<span class="cm">/* Command Time Out   */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span>
							    <span class="n">channel</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Perform a limited number of internal retries */</span>
	<span class="k">case</span> <span class="mh">0x03</span>:		<span class="cm">/* SCSI Bus Reset Received */</span>
	<span class="k">case</span> <span class="mh">0x04</span>:		<span class="cm">/* Initial Controller Power-up */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">MAX_INTERNAL_RETRIES</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#if defined(DID_SOFT_ERROR)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_retried_pid</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:		<span class="cm">/* Unexpected Bus Phase */</span>
	<span class="k">case</span> <span class="mh">0x06</span>:		<span class="cm">/* Unexpected Bus Free */</span>
	<span class="k">case</span> <span class="mh">0x07</span>:		<span class="cm">/* Bus Parity Error */</span>
	<span class="k">case</span> <span class="mh">0x08</span>:		<span class="cm">/* SCSI Hung */</span>
	<span class="k">case</span> <span class="mh">0x09</span>:		<span class="cm">/* Unexpected Message Reject */</span>
	<span class="k">case</span> <span class="mh">0x0a</span>:		<span class="cm">/* SCSI Bus Reset Stuck */</span>
	<span class="k">case</span> <span class="mh">0x0b</span>:		<span class="cm">/* Auto Request-Sense Failed */</span>
	<span class="k">case</span> <span class="mh">0x0c</span>:		<span class="cm">/* Controller Ram Parity Error */</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">status</span> <span class="o">|</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">;</span>

<span class="cp">#if defined(DEBUG_INTERRUPT)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">||</span> <span class="n">do_trace</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">!=</span> <span class="n">ASOK</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">!=</span> <span class="n">ASOK</span> <span class="o">&amp;&amp;</span>
	     <span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">!=</span> <span class="n">ASST</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">do_trace</span> <span class="o">||</span> <span class="n">msg_byte</span><span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">))</span>
<span class="cp">#endif</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="s">&quot;ihdlr, mbox %2d, err 0x%x:%x,&quot;</span>
		       <span class="s">&quot; reg 0x%x, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">,</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">,</span>
		       <span class="n">reg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>

	<span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Set the command state to inactive */</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_trace</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, exit, irq %d, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span>
				<span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>

      <span class="nl">handled:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
      <span class="nl">none:</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">do_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">shap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spin_flags</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check if the interrupt must be processed by this handler */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">shap</span> <span class="o">-</span> <span class="n">sha</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">num_boards</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ihdlr</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eata2x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cp_dma_addr</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_cpu_addr</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mssp</span><span class="p">),</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_cpu_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp_dma_addr</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sha</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_number</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">!=</span> <span class="n">NO_DMA</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>

	<span class="n">release_region</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>
	<span class="n">scsi_unregister</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &quot;scsi_module.c&quot;</span>

<span class="cp">#ifndef MODULE</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;eata=&quot;</span><span class="p">,</span> <span class="n">option_setup</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* end MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
