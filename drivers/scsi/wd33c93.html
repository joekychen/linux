<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › wd33c93.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>wd33c93.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1996 John Shifflett, GeoLog Consulting</span>
<span class="cm"> *    john@geolog.com</span>
<span class="cm"> *    jshiffle@netcom.com</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Drew Eckhardt&#39;s excellent &#39;Generic NCR5380&#39; sources from Linux-PC</span>
<span class="cm"> * provided much of the inspiration and some of the code for this</span>
<span class="cm"> * driver. Everything I know about Amiga DMA was gleaned from careful</span>
<span class="cm"> * reading of Hamish Mcdonald&#39;s original wd33c93 driver; in fact, I</span>
<span class="cm"> * borrowed shamelessly from all over that source. Thanks Hamish!</span>
<span class="cm"> *</span>
<span class="cm"> * _This_ driver is (I feel) an improvement over the old one in</span>
<span class="cm"> * several respects:</span>
<span class="cm"> *</span>
<span class="cm"> *    -  Target Disconnection/Reconnection  is now supported. Any</span>
<span class="cm"> *          system with more than one device active on the SCSI bus</span>
<span class="cm"> *          will benefit from this. The driver defaults to what I</span>
<span class="cm"> *          call &#39;adaptive disconnect&#39; - meaning that each command</span>
<span class="cm"> *          is evaluated individually as to whether or not it should</span>
<span class="cm"> *          be run with the option to disconnect/reselect (if the</span>
<span class="cm"> *          device chooses), or as a &quot;SCSI-bus-hog&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *    -  Synchronous data transfers are now supported. Because of</span>
<span class="cm"> *          a few devices that choke after telling the driver that</span>
<span class="cm"> *          they can do sync transfers, we don&#39;t automatically use</span>
<span class="cm"> *          this faster protocol - it can be enabled via the command-</span>
<span class="cm"> *          line on a device-by-device basis.</span>
<span class="cm"> *</span>
<span class="cm"> *    -  Runtime operating parameters can now be specified through</span>
<span class="cm"> *       the &#39;amiboot&#39; or the &#39;insmod&#39; command line. For amiboot do:</span>
<span class="cm"> *          &quot;amiboot [usual stuff] wd33c93=blah,blah,blah&quot;</span>
<span class="cm"> *       The defaults should be good for most people. See the comment</span>
<span class="cm"> *       for &#39;setup_strings&#39; below for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    -  The old driver relied exclusively on what the Western Digital</span>
<span class="cm"> *          docs call &quot;Combination Level 2 Commands&quot;, which are a great</span>
<span class="cm"> *          idea in that the CPU is relieved of a lot of interrupt</span>
<span class="cm"> *          overhead. However, by accepting a certain (user-settable)</span>
<span class="cm"> *          amount of additional interrupts, this driver achieves</span>
<span class="cm"> *          better control over the SCSI bus, and data transfers are</span>
<span class="cm"> *          almost as fast while being much easier to define, track,</span>
<span class="cm"> *          and debug.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *       more speed. linked commands.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * People with bug reports, wish-lists, complaints, comments,</span>
<span class="cm"> * or improvements are asked to pah-leeez email me (John Shifflett)</span>
<span class="cm"> * at john@geolog.com or jshiffle@netcom.com! I&#39;m anxious to get</span>
<span class="cm"> * this thing into as good a shape as possible, and I&#39;m positive</span>
<span class="cm"> * there are lots of lurking bugs and &quot;Stupid Places&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Updates:</span>
<span class="cm"> *</span>
<span class="cm"> * Added support for pre -A chips, which don&#39;t have advanced features</span>
<span class="cm"> * and will generate CSR_RESEL rather than CSR_RESEL_AM.</span>
<span class="cm"> *	Richard Hirst &lt;richard@sleepie.demon.co.uk&gt;  August 2000</span>
<span class="cm"> *</span>
<span class="cm"> * Added support for Burst Mode DMA and Fast SCSI. Enabled the use of</span>
<span class="cm"> * default_sx_per for asynchronous data transfers. Added adjustment</span>
<span class="cm"> * of transfer periods in sx_table to the actual input-clock.</span>
<span class="cm"> *  peter fuerst &lt;post@pfrst.de&gt;  February 2007</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &quot;wd33c93.h&quot;</span>

<span class="cp">#define optimum_sx_per(hostdata) (hostdata)-&gt;sx_table[1].period_ns</span>


<span class="cp">#define WD33C93_VERSION    &quot;1.26++&quot;</span>
<span class="cp">#define WD33C93_DATE       &quot;10/Feb/2007&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;John Shifflett&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Generic WD33C93 SCSI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;setup_strings&#39; is a single string used to pass operating parameters and</span>
<span class="cm"> * settings from the kernel/module command-line to the driver. &#39;setup_args[]&#39;</span>
<span class="cm"> * is an array of strings that define the compile-time default values for</span>
<span class="cm"> * these settings. If Linux boots with an amiboot or insmod command-line,</span>
<span class="cm"> * those settings are combined with &#39;setup_args[]&#39;. Note that amiboot</span>
<span class="cm"> * command-lines are prefixed with &quot;wd33c93=&quot; while insmod uses a</span>
<span class="cm"> * &quot;setup_strings=&quot; prefix. The driver recognizes the following keywords</span>
<span class="cm"> * (lower case required) and arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * -  nosync:bitmask -bitmask is a byte where the 1st 7 bits correspond with</span>
<span class="cm"> *                    the 7 possible SCSI devices. Set a bit to negotiate for</span>
<span class="cm"> *                    asynchronous transfers on that device. To maintain</span>
<span class="cm"> *                    backwards compatibility, a command-line such as</span>
<span class="cm"> *                    &quot;wd33c93=255&quot; will be automatically translated to</span>
<span class="cm"> *                    &quot;wd33c93=nosync:0xff&quot;.</span>
<span class="cm"> * -  nodma:x        -x = 1 to disable DMA, x = 0 to enable it. Argument is</span>
<span class="cm"> *                    optional - if not present, same as &quot;nodma:1&quot;.</span>
<span class="cm"> * -  period:ns      -ns is the minimum # of nanoseconds in a SCSI data transfer</span>
<span class="cm"> *                    period. Default is 500; acceptable values are 250 - 1000.</span>
<span class="cm"> * -  disconnect:x   -x = 0 to never allow disconnects, 2 to always allow them.</span>
<span class="cm"> *                    x = 1 does &#39;adaptive&#39; disconnects, which is the default</span>
<span class="cm"> *                    and generally the best choice.</span>
<span class="cm"> * -  debug:x        -If &#39;DEBUGGING_ON&#39; is defined, x is a bit mask that causes</span>
<span class="cm"> *                    various types of debug output to printed - see the DB_xxx</span>
<span class="cm"> *                    defines in wd33c93.h</span>
<span class="cm"> * -  clock:x        -x = clock input in MHz for WD33c93 chip. Normal values</span>
<span class="cm"> *                    would be from 8 through 20. Default is 8.</span>
<span class="cm"> * -  burst:x        -x = 1 to use Burst Mode (or Demand-Mode) DMA, x = 0 to use</span>
<span class="cm"> *                    Single Byte DMA, which is the default. Argument is</span>
<span class="cm"> *                    optional - if not present, same as &quot;burst:1&quot;.</span>
<span class="cm"> * -  fast:x         -x = 1 to enable Fast SCSI, which is only effective with</span>
<span class="cm"> *                    input-clock divisor 4 (WD33C93_FS_16_20), x = 0 to disable</span>
<span class="cm"> *                    it, which is the default.  Argument is optional - if not</span>
<span class="cm"> *                    present, same as &quot;fast:1&quot;.</span>
<span class="cm"> * -  next           -No argument. Used to separate blocks of keywords when</span>
<span class="cm"> *                    there&#39;s more than one host adapter in the system.</span>
<span class="cm"> *</span>
<span class="cm"> * Syntax Notes:</span>
<span class="cm"> * -  Numeric arguments can be decimal or the &#39;0x&#39; form of hex notation. There</span>
<span class="cm"> *    _must_ be a colon between a keyword and its numeric argument, with no</span>
<span class="cm"> *    spaces.</span>
<span class="cm"> * -  Keywords are separated by commas, no spaces, in the standard kernel</span>
<span class="cm"> *    command-line manner.</span>
<span class="cm"> * -  A keyword in the &#39;nth&#39; comma-separated command-line member will overwrite</span>
<span class="cm"> *    the &#39;nth&#39; element of setup_args[]. A blank command-line member (in</span>
<span class="cm"> *    other words, a comma with no preceding keyword) will _not_ overwrite</span>
<span class="cm"> *    the corresponding setup_args[] element.</span>
<span class="cm"> * -  If a keyword is used more than once, the first one applies to the first</span>
<span class="cm"> *    SCSI host found, the second to the second card, etc, unless the &#39;next&#39;</span>
<span class="cm"> *    keyword is used to change the order.</span>
<span class="cm"> *</span>
<span class="cm"> * Some amiboot examples (for insmod, use &#39;setup_strings&#39; instead of &#39;wd33c93&#39;):</span>
<span class="cm"> * -  wd33c93=nosync:255</span>
<span class="cm"> * -  wd33c93=nodma</span>
<span class="cm"> * -  wd33c93=nodma:1</span>
<span class="cm"> * -  wd33c93=disconnect:2,nosync:0x08,period:250</span>
<span class="cm"> * -  wd33c93=debug:0x1c</span>
<span class="cm"> */</span>

<span class="cm">/* Normally, no defaults are specified */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setup_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setup_strings</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_strings</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">wd33c93_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_WD33C93_PIO</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">uchar</span>
<span class="nf">read_wd33c93</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">reg_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uchar</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">read_wd33c93_count</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">WD_TRANSFER_COUNT_MSB</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">uchar</span>
<span class="nf">read_aux_stat</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">write_wd33c93</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">reg_num</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
      <span class="n">outb</span><span class="p">(</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">);</span>
      <span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">write_wd33c93_count</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">WD_TRANSFER_COUNT_MSB</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define write_wd33c93_cmd(regs, cmd) \</span>
<span class="cp">	write_wd33c93((regs), WD_COMMAND, (cmd))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">write_wd33c93_cdb</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">cmnd</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">WD_CDB_1</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_WD33C93_PIO */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">uchar</span>
<span class="nf">read_wd33c93</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">reg_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span> <span class="o">=</span> <span class="n">reg_num</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">read_wd33c93_count</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span> <span class="o">=</span> <span class="n">WD_TRANSFER_COUNT_MSB</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">uchar</span>
<span class="nf">read_aux_stat</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">write_wd33c93</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">reg_num</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span> <span class="o">=</span> <span class="n">reg_num</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_wd33c93_count</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span> <span class="o">=</span> <span class="n">WD_TRANSFER_COUNT_MSB</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">write_wd33c93_cmd</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span> <span class="o">=</span> <span class="n">WD_COMMAND</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">write_wd33c93_cdb</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uint</span> <span class="n">len</span><span class="p">,</span> <span class="n">uchar</span> <span class="n">cmnd</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SASR</span> <span class="o">=</span> <span class="n">WD_CDB_1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">regs</span><span class="p">.</span><span class="n">SCMD</span> <span class="o">=</span> <span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_WD33C93_PIO */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">uchar</span>
<span class="nf">read_1_byte</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uchar</span> <span class="n">asr</span><span class="p">;</span>
	<span class="n">uchar</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span> <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">CTRL_POLLED</span><span class="p">);</span>
	<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_TRANS_INFO</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_DBR</span><span class="p">)</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">round_period</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sx_period</span> <span class="o">*</span><span class="n">sx_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">sx_table</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">period_ns</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="n">sx_table</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">0</span><span class="p">].</span><span class="n">period_ns</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">period</span> <span class="o">&gt;</span> <span class="n">sx_table</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">period_ns</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate Synchronous Transfer Register value from SDTR code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uchar</span>
<span class="nf">calc_sync_xfer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fast</span><span class="p">,</span>
               <span class="k">const</span> <span class="k">struct</span> <span class="n">sx_period</span> <span class="o">*</span><span class="n">sx_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* When doing Fast SCSI synchronous data transfers, the corresponding</span>
<span class="cm">	 * value in &#39;sx_table&#39; is two times the actually used transfer period.</span>
<span class="cm">	 */</span>
	<span class="n">uchar</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">fast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fast</span> <span class="o">=</span> <span class="n">STR_FSS</span><span class="p">;</span>
		<span class="n">period</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">period</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* convert SDTR code to ns */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">sx_table</span><span class="p">[</span><span class="n">round_period</span><span class="p">(</span><span class="n">period</span><span class="p">,</span><span class="n">sx_table</span><span class="p">)].</span><span class="n">reg_value</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">OPTIMUM_SX_OFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">OPTIMUM_SX_OFF</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="n">fast</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate SDTR code bytes [3],[4] from period and offset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">calc_sync_msg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fast</span><span class="p">,</span>
                <span class="n">uchar</span>  <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="p">{</span>
	<span class="cm">/* &#39;period&#39; is a &quot;normal&quot;-mode value, like the ones in &#39;sx_table&#39;. The</span>
<span class="cm">	 * actually used transfer period for Fast SCSI synchronous data</span>
<span class="cm">	 * transfers is half that value.</span>
<span class="cm">	 */</span>
	<span class="n">period</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">fast</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wd33c93_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">hostdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_QUEUE_COMMAND</span><span class="p">,</span>
	   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Q-%d-%02x( &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="cm">/* Set up a few fields in the scsi_cmnd structure for our own use:</span>
<span class="cm"> *  - host_scribble is the pointer to the next cmd in the input queue</span>
<span class="cm"> *  - scsi_done points to the routine we call when a cmd is finished</span>
<span class="cm"> *  - result is what you&#39;d expect</span>
<span class="cm"> */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* We use the Scsi_Pointer structure that&#39;s included with each command</span>
<span class="cm"> * as a scratchpad (as it&#39;s intended to be used!). The handy thing about</span>
<span class="cm"> * the SCp.xxx fields is that they&#39;re always associated with a given</span>
<span class="cm"> * cmd, and are preserved across disconnect-reselect. This means we</span>
<span class="cm"> * can pretty much ignore SAVE_POINTERS and RESTORE_POINTERS messages</span>
<span class="cm"> * if we keep all the critical pointers and counters in SCp:</span>
<span class="cm"> *  - SCp.ptr is the pointer into the RAM buffer</span>
<span class="cm"> *  - SCp.this_residual is the size of that buffer</span>
<span class="cm"> *  - SCp.buffer points to the current scatter-gather buffer</span>
<span class="cm"> *  - SCp.buffers_residual tells us how many S.G. buffers there are</span>
<span class="cm"> *  - SCp.have_data_in is not used</span>
<span class="cm"> *  - SCp.sent_command is not used</span>
<span class="cm"> *  - SCp.phase records this command&#39;s SRCID_ER bit setting</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* WD docs state that at the conclusion of a &quot;LEVEL2&quot; command, the</span>
<span class="cm"> * status byte can be retrieved from the LUN register. Apparently,</span>
<span class="cm"> * this is the case only for *uninterrupted* LEVEL2 commands! If</span>
<span class="cm"> * there are any unexpected phases entered, even if they are 100%</span>
<span class="cm"> * legal (different devices may choose to do things differently),</span>
<span class="cm"> * the LEVEL2 command sequence is exited. This often occurs prior</span>
<span class="cm"> * to receiving the status byte, in which case the driver does a</span>
<span class="cm"> * status phase interrupt and gets the status byte on its own.</span>
<span class="cm"> * While such a command can then be &quot;resumed&quot; (ie restarted to</span>
<span class="cm"> * finish up as a LEVEL2 command), the LUN register will NOT be</span>
<span class="cm"> * a valid status byte at the command&#39;s conclusion, and we must</span>
<span class="cm"> * use the byte obtained during the earlier interrupt. Here, we</span>
<span class="cm"> * preset SCp.Status to an illegal value (0xff) so that when</span>
<span class="cm"> * this command finally completes, we can tell where the actual</span>
<span class="cm"> * status byte is stored.</span>
<span class="cm"> */</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">ILLEGAL_STATUS_BYTE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add the cmd to the end of &#39;input_Q&#39;. Note that REQUEST SENSE</span>
<span class="cm">	 * commands are added to the head of the queue so that the desired</span>
<span class="cm">	 * sense data is not lost before REQUEST_SENSE executes.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* find the end of the queue */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
		     <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		     <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* We know that there&#39;s at least one command in &#39;input_Q&#39; now.</span>
<span class="cm"> * Go see if any of them are runnable!</span>
<span class="cm"> */</span>

	<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_QUEUE_COMMAND</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;)Q &quot;</span><span class="p">))</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">wd33c93_queuecommand</span><span class="p">)</span>

<span class="cm">/*</span>
<span class="cm"> * This routine attempts to start a scsi command. If the host_card is</span>
<span class="cm"> * already connected, we give up immediately. Otherwise, look through</span>
<span class="cm"> * the input_Q, using the first command we find that&#39;s intended</span>
<span class="cm"> * for a currently non-busy target/lun.</span>
<span class="cm"> *</span>
<span class="cm"> * wd33c93_execute() is always called with interrupts disabled or from</span>
<span class="cm"> * the wd33c93_intr itself, which means that a wd33c93 interrupt</span>
<span class="cm"> * cannot occur while we are in here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">wd33c93_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_EXECUTE</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;EX(&quot;</span><span class="p">))</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">||</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_EXECUTE</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;)EX-0 &quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Search through the input_Q for a command destined</span>
<span class="cm">	 * for an idle target/lun.</span>
<span class="cm">	 */</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* quit if queue empty or all possible targets are busy */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_EXECUTE</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;)EX-1 &quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  remove command from queue */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

<span class="cp">#ifdef PROC_STATISTICS</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start the selection process</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DESTINATION_ID</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DESTINATION_ID</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|</span> <span class="n">DSTID_DPD</span><span class="p">);</span>

<span class="cm">/* Now we need to figure out whether or not this command is a good</span>
<span class="cm"> * candidate for disconnect/reselect. We guess to the best of our</span>
<span class="cm"> * ability, based on a set of hierarchical rules. When several</span>
<span class="cm"> * devices are operating simultaneously, disconnects are usually</span>
<span class="cm"> * an advantage. In a single device system, or if only 1 device</span>
<span class="cm"> * is being accessed, transfers usually go faster if disconnects</span>
<span class="cm"> * are not allowed:</span>
<span class="cm"> *</span>
<span class="cm"> * + Commands should NEVER disconnect if hostdata-&gt;disconnect =</span>
<span class="cm"> *   DIS_NEVER (this holds for tape drives also), and ALWAYS</span>
<span class="cm"> *   disconnect if hostdata-&gt;disconnect = DIS_ALWAYS.</span>
<span class="cm"> * + Tape drive commands should always be allowed to disconnect.</span>
<span class="cm"> * + Disconnect should be allowed if disconnected_Q isn&#39;t empty.</span>
<span class="cm"> * + Commands should NOT disconnect if input_Q is empty.</span>
<span class="cm"> * + Disconnect should be allowed if there are commands in input_Q</span>
<span class="cm"> *   for a different target/lun. In this case, the other commands</span>
<span class="cm"> *   should be made disconnect-able, if not already.</span>
<span class="cm"> *</span>
<span class="cm"> * I know, I know - this code would flunk me out of any</span>
<span class="cm"> * &quot;C Programming 101&quot; class ever offered. But it&#39;s easy</span>
<span class="cm"> * to change around and experiment with for now.</span>
<span class="cm"> */</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* assume no disconnect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">==</span> <span class="n">DIS_NEVER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">==</span> <span class="n">DIS_ALWAYS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">yes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* tape drive? */</span>
		<span class="k">goto</span> <span class="n">yes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span><span class="p">)</span>	<span class="cm">/* other commands disconnected? */</span>
		<span class="k">goto</span> <span class="n">yes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">))</span>	<span class="cm">/* input_Q empty? */</span>
		<span class="k">goto</span> <span class="n">no</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span> <span class="n">prev</span><span class="p">;</span>
	     <span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span> <span class="n">prev</span><span class="p">;</span>
			     <span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">yes</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">no</span><span class="p">;</span>

 <span class="nl">yes:</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef PROC_STATISTICS</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disc_allowed_cnt</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

 <span class="nl">no:</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SOURCE_ID</span><span class="p">,</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span><span class="p">)</span> <span class="o">?</span> <span class="n">SRCID_ER</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_TARGET_LUN</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SYNCHRONOUS_TRANSFER</span><span class="p">,</span>
		      <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">==</span> <span class="n">L2_NONE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="n">SS_UNSET</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Do a &#39;Select-With-ATN&#39; command. This will end with</span>
<span class="cm">		 * one of the following interrupts:</span>
<span class="cm">		 *    CSR_RESEL_AM:  failure - can try again later.</span>
<span class="cm">		 *    CSR_TIMEOUT:   failure - give up.</span>
<span class="cm">		 *    CSR_SELECT:    success - proceed.</span>
<span class="cm">		 */</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

<span class="cm">/* Every target has its own synchronous transfer setting, kept in the</span>
<span class="cm"> * sync_xfer array, and a corresponding status byte in sync_stat[].</span>
<span class="cm"> * Each target&#39;s sync_stat[] entry is initialized to SX_UNSET, and its</span>
<span class="cm"> * sync_xfer[] entry is initialized to the default/safe value. SS_UNSET</span>
<span class="cm"> * means that the parameters are undetermined as yet, and that we</span>
<span class="cm"> * need to send an SDTR message to this device after selection is</span>
<span class="cm"> * complete: We set SS_FIRST to tell the interrupt routine to do so.</span>
<span class="cm"> * If we&#39;ve been asked not to try synchronous transfers on this</span>
<span class="cm"> * target (and _all_ luns within it), we&#39;ll still send the SDTR message</span>
<span class="cm"> * later, but at that time we&#39;ll negotiate for async by specifying a</span>
<span class="cm"> * sync fifo depth of 0.</span>
<span class="cm"> */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="n">SS_UNSET</span><span class="p">)</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS_FIRST</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_SELECTING</span><span class="p">;</span>
		<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* guarantee a DATA_PHASE interrupt */</span>
		<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Do a &#39;Select-With-ATN-Xfer&#39; command. This will end with</span>
<span class="cm">		 * one of the following interrupts:</span>
<span class="cm">		 *    CSR_RESEL_AM:  failure - can try again later.</span>
<span class="cm">		 *    CSR_TIMEOUT:   failure - give up.</span>
<span class="cm">		 *    anything else: success - proceed.</span>
<span class="cm">		 */</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* copy command_descriptor_block into WD chip</span>
<span class="cm">		 * (take advantage of auto-incrementing)</span>
<span class="cm">		 */</span>

		<span class="n">write_wd33c93_cdb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">);</span>

		<span class="cm">/* The wd33c93 only knows about Group 0, 1, and 5 commands when</span>
<span class="cm">		 * it&#39;s doing a &#39;select-and-transfer&#39;. To be safe, we write the</span>
<span class="cm">		 * size of the CDB into the OWN_ID register for every case. This</span>
<span class="cm">		 * way there won&#39;t be problems with vendor-unique, audio, etc.</span>
<span class="cm">		 */</span>

		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_OWN_ID</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

		<span class="cm">/* When doing a non-disconnect command with DMA, we can save</span>
<span class="cm">		 * ourselves a DATA phase interrupt later by setting everything</span>
<span class="cm">		 * up ahead of time.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_setup</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="o">?</span>
			     <span class="n">DATA_OUT_DIR</span> <span class="o">:</span> <span class="n">DATA_IN_DIR</span><span class="p">))</span>
				<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* guarantee a DATA_PHASE interrupt */</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span>
						    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">);</span>
				<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span>
					      <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">);</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">D_DMA_RUNNING</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* guarantee a DATA_PHASE interrupt */</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">;</span>
		<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN_XFER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since the SCSI bus can handle only 1 connection at a time,</span>
<span class="cm">	 * we get out of here now. If the selection fails, or when</span>
<span class="cm">	 * the command disconnects, we&#39;ll come back to this routine</span>
<span class="cm">	 * to search the input_Q again...</span>
<span class="cm">	 */</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_EXECUTE</span><span class="p">,</span>
	   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s)EX-2 &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;d:&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">transfer_pio</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="n">uchar</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">data_in_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uchar</span> <span class="n">asr</span><span class="p">;</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_TRANSFER</span><span class="p">,</span>
	   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%p,%d,%s:&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">data_in_dir</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">))</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span> <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">CTRL_POLLED</span><span class="p">);</span>
	<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_TRANS_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_in_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_DBR</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DATA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_DBR</span><span class="p">)</span>
				<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Note: we are returning with the interrupt UN-cleared.</span>
<span class="cm">	 * Since (presumably) an entire I/O operation has</span>
<span class="cm">	 * completed, the bus phase is probably different, and</span>
<span class="cm">	 * the interrupt routine will discover this when it</span>
<span class="cm">	 * responds to the uncleared int.</span>
<span class="cm">	 */</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">transfer_bytes</span><span class="p">(</span><span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">data_in_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">hostdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

<span class="cm">/* Normally, you&#39;d expect &#39;this_residual&#39; to be non-zero here.</span>
<span class="cm"> * In a series of scatter-gather transfers, however, this</span>
<span class="cm"> * routine will usually be called with &#39;this_residual&#39; equal</span>
<span class="cm"> * to 0 and &#39;buffers_residual&#39; non-zero. This means that a</span>
<span class="cm"> * previous transfer completed, clearing &#39;this_residual&#39;, and</span>
<span class="cm"> * now we need to setup the next scatter-gather buffer as the</span>
<span class="cm"> * source or destination for THIS transfer.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span>
		<span class="o">--</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">)</span> <span class="cm">/* avoid bogus setups */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SYNCHRONOUS_TRANSFER</span><span class="p">,</span>
		      <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>

<span class="cm">/* &#39;hostdata-&gt;no_dma&#39; is TRUE if we don&#39;t even want to try DMA.</span>
<span class="cm"> * Update &#39;this_residual&#39; and &#39;ptr&#39; after &#39;transfer_pio()&#39; returns.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">||</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_setup</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">data_in_dir</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef PROC_STATISTICS</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pio_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">transfer_pio</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
			     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">,</span> <span class="n">data_in_dir</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">read_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/* We are able to do DMA (in fact, the Amiga hardware is</span>
<span class="cm"> * already going!), so start up the wd33c93 in DMA mode.</span>
<span class="cm"> * We set &#39;hostdata-&gt;dma&#39; = D_DMA_RUNNING so that when the</span>
<span class="cm"> * transfer completes and causes an interrupt, we&#39;re</span>
<span class="cm"> * reminded to tell the Amiga to shut down its end. We&#39;ll</span>
<span class="cm"> * postpone the updating of &#39;this_residual&#39; and &#39;ptr&#39;</span>
<span class="cm"> * until then.</span>
<span class="cm"> */</span>

	<span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef PROC_STATISTICS</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span> <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">);</span>
		<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">&gt;=</span> <span class="n">L2_DATA</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">==</span> <span class="n">L2_BASIC</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN_XFER</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_TRANS_INFO</span><span class="p">);</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">D_DMA_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">wd33c93_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">uchar</span> <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">phs</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="n">ucp</span><span class="p">,</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_BSY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef PROC_STATISTICS</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">int_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">;</span>	<span class="cm">/* assume we&#39;re connected */</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>	<span class="cm">/* clear the interrupt */</span>
	<span class="n">phs</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">);</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;{%02x:%02x-&quot;</span><span class="p">,</span> <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">))</span>

<span class="cm">/* After starting a DMA transfer, the next interrupt</span>
<span class="cm"> * is guaranteed to be in response to completion of</span>
<span class="cm"> * the transfer. Since the Amiga DMA hardware runs in</span>
<span class="cm"> * in an open-ended fashion, it needs to be told when</span>
<span class="cm"> * to stop; do that here if D_DMA_RUNNING is true.</span>
<span class="cm"> * Also, we have to update &#39;this_residual&#39; and &#39;ptr&#39;</span>
<span class="cm"> * based on the contents of the TRANSFER_COUNT register,</span>
<span class="cm"> * in case the device decided to do an intermediate</span>
<span class="cm"> * disconnect (a device may do this if it has to do a</span>
<span class="cm"> * seek, or just to be nice and let other devices have</span>
<span class="cm"> * some bus time during long transfers). After doing</span>
<span class="cm"> * whatever is needed, we go on and service the WD3393</span>
<span class="cm"> * interrupt normally.</span>
<span class="cm"> */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">D_DMA_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_TRANSFER</span><span class="p">,</span>
		   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;[%p/%d:&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">))</span>
		    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_stop</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">D_DMA_OFF</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">read_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">);</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_TRANSFER</span><span class="p">,</span>
		   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%p/%d]&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">))</span>
	<span class="p">}</span>

<span class="cm">/* Respond to the specific WD3393 interrupt - there are quite a few! */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CSR_TIMEOUT</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;TIMEOUT&quot;</span><span class="p">))</span>

		    <span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">)</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span><span class="p">;</span>	<span class="cm">/* get a valid cmd */</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* From esp.c:</span>
<span class="cm">		 * There is a window of time within the scsi_done() path</span>
<span class="cm">		 * of execution where interrupts are turned back on full</span>
<span class="cm">		 * blast and left that way.  During that time we could</span>
<span class="cm">		 * reconnect to a disconnected command, then we&#39;d bomb</span>
<span class="cm">		 * out below.  We could also end up executing two commands</span>
<span class="cm">		 * at _once_.  ...just so you know why the restore_flags()</span>
<span class="cm">		 * is here...</span>
<span class="cm">		 */</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cm">/* We are not connected to a target - check to see if there</span>
<span class="cm"> * are commands waiting to be executed.</span>
<span class="cm"> */</span>

		<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/* Note: this interrupt should not occur in a LEVEL2 command */</span>

	<span class="k">case</span> <span class="n">CSR_SELECT</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELECT&quot;</span><span class="p">))</span>
		    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* construct an IDENTIFY message with correct disconnect bit */</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span><span class="p">)</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="n">SS_FIRST</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS_WAITING</span><span class="p">;</span>

<span class="cm">/* Tack on a 2nd message to ask about synchronous transfers. If we&#39;ve</span>
<span class="cm"> * been asked to do only asynchronous transfers on this device, we</span>
<span class="cm"> * request a fifo depth of 0, which is equivalent to async - should</span>
<span class="cm"> * solve the problems some people have had with GVP&#39;s Guru ROM.</span>
<span class="cm"> */</span>

			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">EXTENDED_SDTR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_sync</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calc_sync_msg</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">default_sx_per</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">calc_sync_msg</span><span class="p">(</span><span class="n">optimum_sx_per</span><span class="p">(</span><span class="n">hostdata</span><span class="p">),</span>
						<span class="n">OPTIMUM_SX_OFF</span><span class="p">,</span>
						<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">,</span>
						<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="cp">#ifdef SYNC_DEBUG</span>
			<span class="n">ucp</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; sending SDTR %02x03%02x%02x%02x &quot;</span><span class="p">,</span>
				<span class="n">ucp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ucp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ucp</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_XFER_DONE</span> <span class="o">|</span> <span class="n">PHS_DATA_IN</span>:
	<span class="k">case</span> <span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_DATA_IN</span>:
	<span class="k">case</span> <span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_DATA_IN</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span>
		   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IN-%d.%d&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">,</span>
			  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="p">))</span>
		    <span class="n">transfer_bytes</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">DATA_IN_DIR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">)</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_XFER_DONE</span> <span class="o">|</span> <span class="n">PHS_DATA_OUT</span>:
	<span class="k">case</span> <span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_DATA_OUT</span>:
	<span class="k">case</span> <span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_DATA_OUT</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span>
		   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;OUT-%d.%d&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">,</span>
			  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="p">))</span>
		    <span class="n">transfer_bytes</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">DATA_OUT_DIR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">)</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/* Note: this interrupt should not occur in a LEVEL2 command */</span>

	<span class="k">case</span> <span class="n">CSR_XFER_DONE</span> <span class="o">|</span> <span class="n">PHS_COMMAND</span>:
	<span class="k">case</span> <span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_COMMAND</span>:
	<span class="k">case</span> <span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_COMMAND</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;CMND-%02x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		    <span class="n">transfer_pio</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">DATA_OUT_DIR</span><span class="p">,</span>
				 <span class="n">hostdata</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_XFER_DONE</span> <span class="o">|</span> <span class="n">PHS_STATUS</span>:
	<span class="k">case</span> <span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_STATUS</span>:
	<span class="k">case</span> <span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_STATUS</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;STATUS=&quot;</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">read_1_byte</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">))</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">&gt;=</span> <span class="n">L2_BASIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>	<span class="cm">/* clear interrupt */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">;</span>
			<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN_XFER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_XFER_DONE</span> <span class="o">|</span> <span class="n">PHS_MESS_IN</span>:
	<span class="k">case</span> <span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_MESS_IN</span>:
	<span class="k">case</span> <span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_MESS_IN</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MSG_IN=&quot;</span><span class="p">))</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">read_1_byte</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>	<span class="cm">/* clear interrupt */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_msg</span><span class="p">[</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">)</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">COMMAND_COMPLETE</span>:
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;CCMP&quot;</span><span class="p">))</span>
			    <span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_PRE_CMP_DISC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SAVE_POINTERS</span>:
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SDP&quot;</span><span class="p">))</span>
			    <span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESTORE_POINTERS</span>:
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;RDP&quot;</span><span class="p">))</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">&gt;=</span> <span class="n">L2_BASIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
				<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN_XFER</span><span class="p">);</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DISCONNECT</span>:
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;DIS&quot;</span><span class="p">))</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_PRE_TMP_DISC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MESSAGE_REJECT</span>:
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;REJ&quot;</span><span class="p">))</span>
<span class="cp">#ifdef SYNC_DEBUG</span>
			    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;-REJ-&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="n">SS_WAITING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS_SET</span><span class="p">;</span>
				<span class="cm">/* we want default_sx_per, not DEFAULT_SX_PER */</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">default_sx_per</span>
						<span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EXTENDED_MESSAGE</span>:
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;EXT&quot;</span><span class="p">))</span>

			    <span class="n">ucp</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_msg</span><span class="p">;</span>

<span class="cp">#ifdef SYNC_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">ucp</span><span class="p">[</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="cm">/* Is this the last byte of the extended message? */</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span> <span class="o">==</span> <span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/* what&#39;s the EXTENDED code? */</span>
				<span class="k">case</span> <span class="n">EXTENDED_SDTR</span>:
					<span class="cm">/* default to default async period */</span>
					<span class="n">id</span> <span class="o">=</span> <span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span>
							<span class="n">default_sx_per</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span>
					    <span class="n">SS_WAITING</span><span class="p">)</span> <span class="p">{</span>

<span class="cm">/* A device has sent an unsolicited SDTR message; rather than go</span>
<span class="cm"> * through the effort of decoding it and then figuring out what</span>
<span class="cm"> * our reply should be, we&#39;re just gonna say that we have a</span>
<span class="cm"> * synchronous fifo depth of 0. This will result in asynchronous</span>
<span class="cm"> * transfers - not ideal but so much easier.</span>
<span class="cm"> * Actually, this is OK because it assures us that if we don&#39;t</span>
<span class="cm"> * specifically ask for sync transfers, we won&#39;t do any.</span>
<span class="cm"> */</span>

						<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_ASSERT_ATN</span><span class="p">);</span>	<span class="cm">/* want MESS_OUT */</span>
						<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
						    <span class="n">EXTENDED_MESSAGE</span><span class="p">;</span>
						<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
						<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
						    <span class="n">EXTENDED_SDTR</span><span class="p">;</span>
						<span class="n">calc_sync_msg</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span>
							<span class="n">default_sx_per</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
						<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="cm">/* well, sync transfer */</span>
							<span class="n">id</span> <span class="o">=</span> <span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ucp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
									<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">,</span>
									<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="cm">/* very unlikely... */</span>
							<span class="n">id</span> <span class="o">=</span> <span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ucp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
									<span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
<span class="cp">#ifdef SYNC_DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; sync_xfer=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
<span class="cp">#endif</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">SS_SET</span><span class="p">;</span>
					<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span>
							  <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">EXTENDED_WDTR</span>:
					<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_ASSERT_ATN</span><span class="p">);</span>	<span class="cm">/* want MESS_OUT */</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sending WDTR &quot;</span><span class="p">);</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">EXTENDED_MESSAGE</span><span class="p">;</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">EXTENDED_WDTR</span><span class="p">;</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 8 bit transfer width */</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span>
							  <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_ASSERT_ATN</span><span class="p">);</span>	<span class="cm">/* want MESS_OUT */</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;Rejecting Unknown Extended Message(%02x). &quot;</span><span class="p">,</span>
					     <span class="n">ucp</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span>
							  <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* We need to read more MESS_IN bytes for the extended message */</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rejecting Unknown Message(%02x) &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_ASSERT_ATN</span><span class="p">);</span>	<span class="cm">/* want MESS_OUT */</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/* Note: this interrupt will occur only after a LEVEL2 command */</span>

	<span class="k">case</span> <span class="n">CSR_SEL_XFER_DONE</span>:

<span class="cm">/* Make sure that reselection is enabled at this point - it may</span>
<span class="cm"> * have been turned off for the command that just completed.</span>
<span class="cm"> */</span>

		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SOURCE_ID</span><span class="p">,</span> <span class="n">SRCID_ER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phs</span> <span class="o">==</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SX-DONE&quot;</span><span class="p">))</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">;</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_TARGET_LUN</span><span class="p">);</span>
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;:%d.%d&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span>
			    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">==</span> <span class="n">ILLEGAL_STATUS_BYTE</span><span class="p">)</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span>
			    <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span>
				     <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x00ffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="cm">/* We are no longer  connected to a target - check to see if</span>
<span class="cm"> * there are commands waiting to be executed.</span>
<span class="cm"> */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;%02x:%02x:%02x: Unknown SEL_XFER_DONE phase!!---&quot;</span><span class="p">,</span>
			     <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">phs</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/* Note: this interrupt will occur only after a LEVEL2 command */</span>

	<span class="k">case</span> <span class="n">CSR_SDP</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SDP&quot;</span><span class="p">))</span>
		    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">;</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN_XFER</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_XFER_DONE</span> <span class="o">|</span> <span class="n">PHS_MESS_OUT</span>:
	<span class="k">case</span> <span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_MESS_OUT</span>:
	<span class="k">case</span> <span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_MESS_OUT</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;MSG_OUT=&quot;</span><span class="p">))</span>

<span class="cm">/* To get here, we&#39;ve probably requested MESSAGE_OUT and have</span>
<span class="cm"> * already put the correct bytes in outgoing_msg[] and filled</span>
<span class="cm"> * in outgoing_len. We simply send them out to the SCSI bus.</span>
<span class="cm"> * Sometimes we get MESSAGE_OUT phase when we&#39;re not expecting</span>
<span class="cm"> * it - like when our SDTR message is rejected by a target. Some</span>
<span class="cm"> * targets send the REJECT before receiving all of the extended</span>
<span class="cm"> * message, and then seem to go back to MESSAGE_OUT for a byte</span>
<span class="cm"> * or two. Not sure why, or if I&#39;m doing something wrong to</span>
<span class="cm"> * cause this to happen. Regardless, it seems that sending</span>
<span class="cm"> * NOP messages in these situations results in no harm and</span>
<span class="cm"> * makes everyone happy.</span>
<span class="cm"> */</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">transfer_pio</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">,</span>
			     <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span><span class="p">,</span> <span class="n">DATA_OUT_DIR</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_UNEXP_DISC</span>:

<span class="cm">/* I think I&#39;ve seen this after a request-sense that was in response</span>
<span class="cm"> * to an error condition, but not sure. We certainly need to do</span>
<span class="cm"> * something when we get this interrupt - the question is &#39;what?&#39;.</span>
<span class="cm"> * Let&#39;s think positively, and assume some command has finished</span>
<span class="cm"> * in a legal manner (like a command that provokes a request-sense),</span>
<span class="cm"> * so we treat it as a normal command-complete-disconnect.</span>
<span class="cm"> */</span>

<span class="cm">/* Make sure that reselection is enabled at this point - it may</span>
<span class="cm"> * have been turned off for the command that just completed.</span>
<span class="cm"> */</span>

		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SOURCE_ID</span><span class="p">,</span> <span class="n">SRCID_ER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Already disconnected! &quot;</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;UNEXP_DISC&quot;</span><span class="p">))</span>
		    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x00ffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="cm">/* We are no longer connected to a target - check to see if</span>
<span class="cm"> * there are commands waiting to be executed.</span>
<span class="cm"> */</span>
		<span class="cm">/* look above for comments on scsi_done() */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_DISC</span>:

<span class="cm">/* Make sure that reselection is enabled at this point - it may</span>
<span class="cm"> * have been turned off for the command that just completed.</span>
<span class="cm"> */</span>

		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SOURCE_ID</span><span class="p">,</span> <span class="n">SRCID_ER</span><span class="p">);</span>
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;DISC&quot;</span><span class="p">))</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - Already disconnected! &quot;</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">S_PRE_CMP_DISC</span>:
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
			<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;:%d&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">))</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span>
				<span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span>
				     <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x00ffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
				    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">S_PRE_TMP_DISC</span>:
		<span class="k">case</span> <span class="n">S_RUNNING_LEVEL2</span>:
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>

<span class="cp">#ifdef PROC_STATISTICS</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disc_done_cnt</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;*** Unexpected DISCONNECT interrupt! ***&quot;</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cm">/* We are no longer connected to a target - check to see if</span>
<span class="cm"> * there are commands waiting to be executed.</span>
<span class="cm"> */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSR_RESEL_AM</span>:
	<span class="k">case</span> <span class="n">CSR_RESEL</span>:
		<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;RESEL%s&quot;</span><span class="p">,</span> <span class="n">sr</span> <span class="o">==</span> <span class="n">CSR_RESEL_AM</span> <span class="o">?</span> <span class="s">&quot;_AM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

		    <span class="cm">/* Old chips (pre -A ???) don&#39;t have advanced features and will</span>
<span class="cm">		     * generate CSR_RESEL.  In that case we have to extract the LUN the</span>
<span class="cm">		     * hard way (see below).</span>
<span class="cm">		     * First we have to make sure this reselection didn&#39;t</span>
<span class="cm">		     * happen during Arbitration/Selection of some other device.</span>
<span class="cm">		     * If yes, put losing command back on top of input_Q.</span>
<span class="cm">		     */</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">&lt;=</span> <span class="n">L2_NONE</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span><span class="p">;</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phs</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span>
					    <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
					<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;---%02x:%02x:%02x-TROUBLE: Intrusive ReSelect!---&quot;</span><span class="p">,</span>
					     <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">phs</span><span class="p">);</span>
					<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="cm">/* OK - find out which device reselected us. */</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SOURCE_ID</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">&amp;=</span> <span class="n">SRCID_MASK</span><span class="p">;</span>

		<span class="cm">/* and extract the lun from the ID message. (Note that we don&#39;t</span>
<span class="cm">		 * bother to check for a valid message here - I guess this is</span>
<span class="cm">		 * not the right way to go, but...)</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">==</span> <span class="n">CSR_RESEL_AM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DATA</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">&lt;</span> <span class="n">L2_RESELECT</span><span class="p">)</span>
				<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
			<span class="n">lun</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Old chip; wait for msgin phase to pick up the LUN. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">lun</span><span class="p">;</span> <span class="n">lun</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;wd33c93: Reselected without IDENTIFY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Verify this is a change to MSG_IN and read the message */</span>
				<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">==</span> <span class="p">(</span><span class="n">CSR_ABORT</span> <span class="o">|</span> <span class="n">PHS_MESS_IN</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">sr</span> <span class="o">==</span> <span class="p">(</span><span class="n">CSR_UNEXP</span> <span class="o">|</span> <span class="n">PHS_MESS_IN</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">sr</span> <span class="o">==</span> <span class="p">(</span><span class="n">CSR_SRV_REQ</span> <span class="o">|</span> <span class="n">PHS_MESS_IN</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Got MSG_IN, grab target LUN */</span>
					<span class="n">lun</span> <span class="o">=</span> <span class="n">read_1_byte</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
					<span class="cm">/* Now we expect a &#39;paused with ACK asserted&#39; int.. */</span>
					<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
						<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">))</span>
							<span class="n">printk</span>
							    <span class="p">(</span><span class="s">&quot;wd33c93: No int after LUN on RESEL (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							     <span class="n">asr</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">!=</span> <span class="n">CSR_MSGIN</span><span class="p">)</span>
						<span class="n">printk</span>
						    <span class="p">(</span><span class="s">&quot;wd33c93: Not paused with ACK on RESEL (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">sr</span><span class="p">);</span>
					<span class="n">lun</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
					<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span>
							  <span class="n">WD_CMD_NEGATE_ACK</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;wd33c93: Not MSG_IN on reselect (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">sr</span><span class="p">);</span>
					<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Now we look for the command that&#39;s reconnecting. */</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span><span class="p">;</span>
		<span class="n">patch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">lun</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">patch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Hmm. Couldn&#39;t find a valid command.... What to do? */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;---TROUBLE: target %d.%d not in disconnect queue---&quot;</span><span class="p">,</span>
			     <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Ok, found the command - now start it up again. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">)</span>
			<span class="n">patch</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span> <span class="o">=</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="cm">/* We don&#39;t need to worry about &#39;initialize_SCp()&#39; or &#39;hostdata-&gt;busy[]&#39;</span>
<span class="cm">		 * because these things are preserved over a disconnect.</span>
<span class="cm">		 * But we DO need to fix the DPD bit so it&#39;s correct for this command.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
			<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DESTINATION_ID</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DESTINATION_ID</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|</span> <span class="n">DSTID_DPD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">&gt;=</span> <span class="n">L2_RESELECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* we want a DATA_PHASE interrupt */</span>
			<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND_PHASE</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
			<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_SEL_ATN_XFER</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_RUNNING_LEVEL2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_CONNECTED</span><span class="p">;</span>

		    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;--UNKNOWN INTERRUPT:%02x:%02x:%02x--&quot;</span><span class="p">,</span> <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">phs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DB</span><span class="p">(</span><span class="n">DB_INTR</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;} &quot;</span><span class="p">))</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">reset_wd33c93</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">uchar</span> <span class="n">sr</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SGI_IP22</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">busycount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">extern</span> <span class="kt">void</span> <span class="n">sgiwd93_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="cm">/* wait &#39;til the chip gets some time for us */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ASR_BSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">busycount</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">udelay</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm"> 	 * there are scsi devices out there, which manage to lock up</span>
<span class="cm">	 * the wd33c93 in a busy condition. In this state it won&#39;t</span>
<span class="cm">	 * accept the reset command. The only way to solve this is to</span>
<span class="cm"> 	 * give the chip a hardware reset (if possible). The code below</span>
<span class="cm">	 * does this for the SGI Indy, where this is possible</span>
<span class="cm">	 */</span>
	<span class="cm">/* still busy ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ASR_BSY</span><span class="p">)</span>
		<span class="n">sgiwd93_reset</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span> <span class="cm">/* yeah, give it the hard one */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_OWN_ID</span><span class="p">,</span> <span class="n">OWNID_EAF</span> <span class="o">|</span> <span class="n">OWNID_RAF</span> <span class="o">|</span>
		      <span class="n">instance</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock_freq</span><span class="p">);</span>
	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span> <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">CTRL_POLLED</span><span class="p">);</span>
	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SYNCHRONOUS_TRANSFER</span><span class="p">,</span>
		      <span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">default_sx_per</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
				     <span class="n">DEFAULT_SX_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">));</span>
	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_COMMAND</span><span class="p">,</span> <span class="n">WD_CMD_RESET</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_MVME147_SCSI</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>		<span class="cm">/* The old wd33c93 on MVME147 needs this, at least */</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">))</span>
		<span class="p">;</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">microcode</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CDB_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">C_WD33C93</span><span class="p">;</span>
	<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_QUEUE_TAG</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">);</span>	<span class="cm">/* any random number */</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_QUEUE_TAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">==</span> <span class="mh">0xa5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">C_WD33C93B</span><span class="p">;</span>
			<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_QUEUE_TAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">C_WD33C93A</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">C_UNKNOWN_CHIP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">C_WD33C93B</span><span class="p">)</span>	<span class="cm">/* Fast SCSI unavailable */</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_TIMEOUT_PERIOD</span><span class="p">,</span> <span class="n">TIMEOUT_PERIOD_VALUE</span><span class="p">);</span>
	<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span> <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">CTRL_POLLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">wd33c93_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">hostdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: reset. &quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_stop</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">DEFAULT_SX_PER</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">DEFAULT_SX_OFF</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS_UNSET</span><span class="p">;</span>	<span class="cm">/* using default sync values */</span>
	<span class="p">}</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">D_DMA_OFF</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reset_wd33c93</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">wd33c93_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">hostdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Case 1 : If the command hasn&#39;t been issued yet, we simply remove it</span>
<span class="cm"> *     from the input_Q.</span>
<span class="cm"> */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;scsi%d: Abort - removing command from input_Q. &quot;</span><span class="p">,</span>
			     <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Case 2 : If the command is connected, we&#39;re going to fail the abort</span>
<span class="cm"> *     and let the high level SCSI driver retry at a later time or</span>
<span class="cm"> *     issue a reset.</span>
<span class="cm"> *</span>
<span class="cm"> *     Timeouts, and therefore aborted commands, will be highly unlikely</span>
<span class="cm"> *     and handling them cleanly in this situation would make the common</span>
<span class="cm"> *     case of noresets less efficient, and would pollute our code.  So,</span>
<span class="cm"> *     we fail.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uchar</span> <span class="n">sr</span><span class="p">,</span> <span class="n">asr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: Aborting connected command - &quot;</span><span class="p">,</span>
		       <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;stopping DMA - &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">D_DMA_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_stop</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">D_DMA_OFF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sending wd33c93 ABORT command - &quot;</span><span class="p">);</span>
		<span class="n">write_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CONTROL</span><span class="p">,</span>
			      <span class="n">CTRL_IDI</span> <span class="o">|</span> <span class="n">CTRL_EDI</span> <span class="o">|</span> <span class="n">CTRL_POLLED</span><span class="p">);</span>
		<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_ABORT</span><span class="p">);</span>

<span class="cm">/* Now we have to attempt to flush out the FIFO... */</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flushing fifo - &quot;</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_DBR</span><span class="p">)</span>
				<span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_DATA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;asr=%02x, sr=%02x, %ld bytes un-transferred (timeout=%ld) - &quot;</span><span class="p">,</span>
		     <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">read_wd33c93_count</span><span class="p">(</span><span class="n">regs</span><span class="p">),</span> <span class="n">timeout</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Abort command processed.</span>
<span class="cm">		 * Still connected.</span>
<span class="cm">		 * We must disconnect.</span>
<span class="cm">		 */</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sending wd33c93 DISCONNECT command - &quot;</span><span class="p">);</span>
		<span class="n">write_wd33c93_cmd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_CMD_DISCONNECT</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">asr</span> <span class="o">&amp;</span> <span class="n">ASR_CIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">asr</span> <span class="o">=</span> <span class="n">read_aux_stat</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">read_wd33c93</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">WD_SCSI_STATUS</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;asr=%02x, sr=%02x.&quot;</span><span class="p">,</span> <span class="n">asr</span><span class="p">,</span> <span class="n">sr</span><span class="p">);</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

<span class="cm">/*      sti();*/</span>
		<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

		<span class="n">enable_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Case 3: If the command is currently disconnected from the bus,</span>
<span class="cm"> * we&#39;re not going to expend much effort here: Let&#39;s just return</span>
<span class="cm"> * an ABORT_SNOOZE and hope for the best...</span>
<span class="cm"> */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;scsi%d: Abort - command found on disconnected_Q - &quot;</span><span class="p">,</span>
			     <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Abort SNOOZE. &quot;</span><span class="p">);</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Case 4 : If we reached this point, the command was not found in any of</span>
<span class="cm"> *     the queues.</span>
<span class="cm"> *</span>
<span class="cm"> * We probably reached this point because of an unlikely race condition</span>
<span class="cm"> * between the command completing successfully and the abortion code,</span>
<span class="cm"> * so we won&#39;t panic, but we will notify the user in case something really</span>
<span class="cm"> * broke.</span>
<span class="cm"> */</span>

<span class="cm">/*   sti();*/</span>
	<span class="n">wd33c93_execute</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: warning : SCSI command probably completed successfully&quot;</span>
	       <span class="s">&quot;         before abortion. &quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_WD33C93_HOSTS 4</span>
<span class="cp">#define MAX_SETUP_ARGS ARRAY_SIZE(setup_args)</span>
<span class="cp">#define SETUP_BUFFER_SIZE 200</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">setup_buffer</span><span class="p">[</span><span class="n">SETUP_BUFFER_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">setup_used</span><span class="p">[</span><span class="n">MAX_SETUP_ARGS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">done_setup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wd33c93_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>

	<span class="cm">/* The kernel does some processing of the command-line before calling</span>
<span class="cm">	 * this function: If it begins with any decimal or hex number arguments,</span>
<span class="cm">	 * ints[0] = how many numbers found and ints[1] through [n] are the values</span>
<span class="cm">	 * themselves. str points to where the non-numeric arguments (if any)</span>
<span class="cm">	 * start: We do our own parsing of those. We construct synthetic &#39;nosync&#39;</span>
<span class="cm">	 * keywords out of numeric args (to maintain compatibility with older</span>
<span class="cm">	 * versions) and then add the rest of the arguments.</span>
<span class="cm">	 */</span>

	<span class="n">p1</span> <span class="o">=</span> <span class="n">setup_buffer</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">SETUP_BUFFER_SIZE</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">setup_buffer</span><span class="p">));</span>
	<span class="n">setup_buffer</span><span class="p">[</span><span class="n">SETUP_BUFFER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">p1</span> <span class="o">=</span> <span class="n">setup_buffer</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SETUP_ARGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p2</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">)</span>
				<span class="n">setup_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
			<span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">setup_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SETUP_ARGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">setup_used</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">done_setup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;wd33c93=&quot;</span><span class="p">,</span> <span class="n">wd33c93_setup</span><span class="p">);</span>

<span class="cm">/* check_setup_args() returns index if key found, 0 if not</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_setup_args</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MAX_SETUP_ARGS</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup_used</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">setup_args</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">setup_args</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="s">&quot;next&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">MAX_SETUP_ARGS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_used</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">setup_args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">x</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cp</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">++</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate internal data-transfer-clock cycle from input-clock</span>
<span class="cm"> * frequency (/MHz) and fill &#39;sx_table&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * The original driver used to rely on a fixed sx_table, containing periods</span>
<span class="cm"> * for (only) the lower limits of the respective input-clock-frequency ranges</span>
<span class="cm"> * (8-10/12-15/16-20 MHz). Although it seems, that no problems occurred with</span>
<span class="cm"> * this setting so far, it might be desirable to adjust the transfer periods</span>
<span class="cm"> * closer to the really attached, possibly 25% higher, input-clock, since</span>
<span class="cm"> * - the wd33c93 may really use a significant shorter period, than it has</span>
<span class="cm"> *   negotiated (eg. thrashing the target, which expects 4/8MHz, with 5/10MHz</span>
<span class="cm"> *   instead).</span>
<span class="cm"> * - the wd33c93 may ask the target for a lower transfer rate, than the target</span>
<span class="cm"> *   is capable of (eg. negotiating for an assumed minimum of 252ns instead of</span>
<span class="cm"> *   possible 200ns, which indeed shows up in tests as an approx. 10% lower</span>
<span class="cm"> *   transfer rate).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">round_4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="o">--</span><span class="n">x</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="o">++</span><span class="n">x</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="o">++</span><span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">calc_sx_table</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mhz</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sx_period</span> <span class="n">sx_table</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mhz</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">d</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* divisor for  8-10 MHz input-clock */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mhz</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">d</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* divisor for 12-15 MHz input-clock */</span>
	<span class="k">else</span>
		<span class="n">d</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* divisor for 16-20 MHz input-clock */</span>

	<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100000</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mhz</span><span class="p">;</span> <span class="cm">/* 100 x DTCC / nanosec */</span>

	<span class="n">sx_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">period_ns</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sx_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_value</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sx_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">period_ns</span> <span class="o">=</span> <span class="n">round_4</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">d</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
		<span class="n">sx_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sx_table</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">reg_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sx_table</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">period_ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sx_table</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">reg_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check and, maybe, map an init- or &quot;clock:&quot;- argument.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uchar</span>
<span class="nf">set_clk_freq</span><span class="p">(</span><span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mhz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WD33C93_FS_8_10</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WD33C93_FS_12_15</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WD33C93_FS_16_20</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">WD33C93_FS_8_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">WD33C93_FS_12_15</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">WD33C93_FS_16_20</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Hmm, wouldn&#39;t it be safer to assume highest freq here? */</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">WD33C93_FS_8_10</span><span class="p">;</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">mhz</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * to be used with the resync: fast: ... options</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_resync</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">hd</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS_UNSET</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">wd33c93_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">const</span> <span class="n">wd33c93_regs</span> <span class="n">regs</span><span class="p">,</span>
	     <span class="n">dma_setup_t</span> <span class="n">setup</span><span class="p">,</span> <span class="n">dma_stop_t</span> <span class="n">stop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clock_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done_setup</span> <span class="o">&amp;&amp;</span> <span class="n">setup_strings</span><span class="p">)</span>
		<span class="n">wd33c93_setup</span><span class="p">(</span><span class="n">setup_strings</span><span class="p">);</span>

	<span class="n">hostdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock_freq</span> <span class="o">=</span> <span class="n">set_clk_freq</span><span class="p">(</span><span class="n">clock_freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
	<span class="n">calc_sx_table</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_setup</span> <span class="o">=</span> <span class="n">setup</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_stop</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_bounce_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_bounce_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">calc_sync_xfer</span><span class="p">(</span><span class="n">DEFAULT_SX_PER</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">DEFAULT_SX_OFF</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SS_UNSET</span><span class="p">;</span>	<span class="cm">/* using default sync values */</span>
<span class="cp">#ifdef PROC_STATISTICS</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disc_allowed_cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disc_done_cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">input_Q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">selecting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S_UNCONNECTED</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">D_DMA_OFF</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">=</span> <span class="n">L2_BASIC</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">DIS_ADAPTIVE</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">DEBUG_DEFAULTS</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">incoming_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">outgoing_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">default_sx_per</span> <span class="o">=</span> <span class="n">DEFAULT_SX_PER</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default is DMA enabled */</span>

<span class="cp">#ifdef PROC_INTERFACE</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">PR_VERSION</span> <span class="o">|</span> <span class="n">PR_INFO</span> <span class="o">|</span> <span class="n">PR_STATISTICS</span> <span class="o">|</span>
	    <span class="n">PR_CONNECTED</span> <span class="o">|</span> <span class="n">PR_INPUTQ</span> <span class="o">|</span> <span class="n">PR_DISCQ</span> <span class="o">|</span> <span class="n">PR_STOP</span><span class="p">;</span>
<span class="cp">#ifdef PROC_STATISTICS</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pio_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">int_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;clock&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock_freq</span> <span class="o">=</span> <span class="n">set_clk_freq</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">calc_sx_table</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;nosync&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_sync</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;nodma&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;period&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">default_sx_per</span> <span class="o">=</span>
		    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">[</span><span class="n">round_period</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span>
		                                    <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">)].</span><span class="n">period_ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;disconnect&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">DIS_NEVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="n">DIS_ALWAYS</span><span class="p">))</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">DIS_ADAPTIVE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;level2&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">DB_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;burst&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">CTRL_BURST</span><span class="o">:</span><span class="n">CTRL_DMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WD33C93_FS_16_20</span> <span class="o">==</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock_freq</span> <span class="cm">/* divisor 4 */</span>
		<span class="o">&amp;&amp;</span> <span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;fast&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">setup_used</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PROC_INTERFACE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_setup_args</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">reset_wd33c93</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wd33c93-%d: chip=%s/%d no_sync=0x%x no_dma=%d&quot;</span><span class="p">,</span>
	       <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">C_WD33C93</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;WD33c93&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span>
							    <span class="n">C_WD33C93A</span><span class="p">)</span> <span class="o">?</span>
	       <span class="s">&quot;WD33c93A&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span>
			     <span class="n">C_WD33C93B</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;WD33c93B&quot;</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">microcode</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_sync</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">no_dma</span><span class="p">);</span>
<span class="cp">#ifdef DEBUGGING_ON</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; debug_flags=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; debugging=OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;           setup_args=&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SETUP_ARGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s,&quot;</span><span class="p">,</span> <span class="n">setup_args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;           Version %s - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WD33C93_VERSION</span><span class="p">,</span> <span class="n">WD33C93_DATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">wd33c93_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef PROC_INTERFACE</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">WD33C93_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

<span class="cm">/* If &#39;in&#39; is TRUE we need to _read_ the proc file. We accept the following</span>
<span class="cm"> * keywords (same format as command-line, but arguments are not optional):</span>
<span class="cm"> *    debug</span>
<span class="cm"> *    disconnect</span>
<span class="cm"> *    period</span>
<span class="cm"> *    resync</span>
<span class="cm"> *    proc</span>
<span class="cm"> *    nodma</span>
<span class="cm"> *    level2</span>
<span class="cm"> *    burst</span>
<span class="cm"> *    fast</span>
<span class="cm"> *    nosync</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="sc">&#39;,&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">bp</span> <span class="o">||</span> <span class="sc">&#39; &#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
				<span class="o">++</span><span class="n">bp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;debug:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DB_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;disconnect:&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">x</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">DIS_NEVER</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">DIS_ALWAYS</span><span class="p">)</span>
				<span class="n">x</span> <span class="o">=</span> <span class="n">DIS_ADAPTIVE</span><span class="p">;</span>
			<span class="n">hd</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;period:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hd</span><span class="o">-&gt;</span><span class="n">default_sx_per</span> <span class="o">=</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">[</span><span class="n">round_period</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span>
							  <span class="n">hd</span><span class="o">-&gt;</span><span class="n">sx_table</span><span class="p">)].</span><span class="n">period_ns</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;resync:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_resync</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;proc:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;nodma:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;level2:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">level2</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;burst:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span>
					<span class="n">simple_strtol</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CTRL_BURST</span><span class="o">:</span><span class="n">CTRL_DMA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;fast:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">x</span> <span class="o">=</span> <span class="o">!!</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span>
					<span class="n">set_resync</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;nosync:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">x</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">bp</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">set_resync</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">x</span> <span class="o">^</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">no_sync</span><span class="p">);</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">no_sync</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* unknown keyword,syntax-error,... */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Version %s - %s.&quot;</span><span class="p">,</span>
			<span class="n">WD33C93_VERSION</span><span class="p">,</span> <span class="n">WD33C93_DATE</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">clock_freq=%02x no_sync=%02x no_dma=%d&quot;</span>
			<span class="s">&quot; dma_mode=%02x fast=%d&quot;</span><span class="p">,</span>
			<span class="n">hd</span><span class="o">-&gt;</span><span class="n">clock_freq</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">no_sync</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">no_dma</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sync_xfer[] =       &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%02x&quot;</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">sync_xfer</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sync_stat[] =       &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%02x&quot;</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">sync_stat</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef PROC_STATISTICS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_STATISTICS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">commands issued:    &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%ld&quot;</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">disconnects allowed:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%ld&quot;</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">disc_allowed_cnt</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">disconnects done:   &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%ld&quot;</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">disc_done_cnt</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">interrupts: %ld, DATA_PHASE ints: %ld DMA, %ld PIO&quot;</span><span class="p">,</span>
			<span class="n">hd</span><span class="o">-&gt;</span><span class="n">int_cnt</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">dma_cnt</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">pio_cnt</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">connected:     &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot; %d:%d(%02x)&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_INPUTQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">input_Q:       &quot;</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">input_Q</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot; %d:%d(%02x)&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_DISCQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">disconnected_Q:&quot;</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">disconnected_Q</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot; %d:%d(%02x)&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mh">0x40000</span><span class="p">)</span>	<span class="cm">/* ALWAYS stop after 256k bytes have been read */</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">&amp;</span> <span class="n">PR_STOP</span><span class="p">)</span>	<span class="cm">/* stop every other time */</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#else				</span><span class="cm">/* PROC_INTERFACE */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#endif				</span><span class="cm">/* PROC_INTERFACE */</span><span class="cp"></span>

<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wd33c93_host_reset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wd33c93_init</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wd33c93_abort</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wd33c93_queuecommand</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wd33c93_intr</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">wd33c93_proc_info</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
