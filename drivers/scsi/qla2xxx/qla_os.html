<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_os.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_os.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>

<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Driver version</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="n">qla2x00_version_str</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">apidev_major</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * SRB allocation cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">srb_cachep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * CT6 CTX allocation cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ctx_cachep</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * error level for logging</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ql_errlev</span> <span class="o">=</span> <span class="n">ql_log_all</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">ql2xenableclass2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xenableclass2</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xenableclass2</span><span class="p">,</span>
		<span class="s">&quot;Specify if Class 2 operations are supported from the very &quot;</span>
		<span class="s">&quot;beginning. Default is 0 - class 2 not supported.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xlogintimeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xlogintimeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xlogintimeout</span><span class="p">,</span>
		<span class="s">&quot;Login timeout value in seconds.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">qlport_down_retry</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlport_down_retry</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlport_down_retry</span><span class="p">,</span>
		<span class="s">&quot;Maximum number of command retries to a port that returns &quot;</span>
		<span class="s">&quot;a PORT-DOWN status.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xplogiabsentdevice</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xplogiabsentdevice</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xplogiabsentdevice</span><span class="p">,</span>
		<span class="s">&quot;Option to enable PLOGI to devices that are not present after &quot;</span>
		<span class="s">&quot;a Fabric scan.  This is needed for several broken switches. &quot;</span>
		<span class="s">&quot;Default is 0 - no PLOGI. 1 - perfom PLOGI.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xloginretrycount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xloginretrycount</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xloginretrycount</span><span class="p">,</span>
		<span class="s">&quot;Specify an alternate value for the NVRAM login retry count.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xallocfwdump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xallocfwdump</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xallocfwdump</span><span class="p">,</span>
		<span class="s">&quot;Option to enable allocation of memory for a firmware dump &quot;</span>
		<span class="s">&quot;during HBA initialization.  Memory allocation requirements &quot;</span>
		<span class="s">&quot;vary by ISP type.  Default is 1 - allocate memory.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xextended_error_logging</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xextended_error_logging</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xextended_error_logging</span><span class="p">,</span>
		<span class="s">&quot;Option to enable extended error logging,</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Default is 0 - no logging.  0x40000000 - Module Init &amp; Probe.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x20000000 - Mailbox Cmnds. 0x10000000 - Device Discovery.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x08000000 - IO tracing.    0x04000000 - DPC Thread.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x02000000 - Async events.  0x01000000 - Timer routines.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x00800000 - User space.    0x00400000 - Task Management.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x00200000 - AER/EEH.       0x00100000 - Multi Q.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x00080000 - P3P Specific.  0x00040000 - Virtual Port.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x00020000 - Buffer Dump.   0x00010000 - Misc.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x7fffffff - For enabling all logs, can be too many logs.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">0x1e400000 - Preferred value for capturing essential &quot;</span>
		<span class="s">&quot;debug information (equivalent to old &quot;</span>
		<span class="s">&quot;ql2xextended_error_logging=1).</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Do LOGICAL OR of the value to enable more than one level&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xshiftctondsd</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xshiftctondsd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xshiftctondsd</span><span class="p">,</span>
		<span class="s">&quot;Set to control shifting of command type processing &quot;</span>
		<span class="s">&quot;based on total number of SG elements.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_free_device</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xfdmienable</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xfdmienable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xfdmienable</span><span class="p">,</span>
		<span class="s">&quot;Enables FDMI registrations. &quot;</span>
		<span class="s">&quot;0 - no FDMI. Default is 1 - perform FDMI.&quot;</span><span class="p">);</span>

<span class="cp">#define MAX_Q_DEPTH    32</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ql2xmaxqdepth</span> <span class="o">=</span> <span class="n">MAX_Q_DEPTH</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xmaxqdepth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xmaxqdepth</span><span class="p">,</span>
		<span class="s">&quot;Maximum queue depth to report for target devices.&quot;</span><span class="p">);</span>

<span class="cm">/* Do not change the value of this after module load */</span>
<span class="kt">int</span> <span class="n">ql2xenabledif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xenabledif</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xenabledif</span><span class="p">,</span>
		<span class="s">&quot; Enable T10-CRC-DIF &quot;</span>
		<span class="s">&quot; Default is 0 - No DIF Support. 1 - Enable it&quot;</span>
		<span class="s">&quot;, 2 - Enable DIF for all types, except Type 0.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xenablehba_err_chk</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xenablehba_err_chk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xenablehba_err_chk</span><span class="p">,</span>
		<span class="s">&quot; Enable T10-CRC-DIF Error isolation by HBA:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; Default is 1.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;  0 -- Error isolation disabled</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;  1 -- Error isolation enabled only for DIX Type 0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;  2 -- Error isolation enabled for all Types</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xiidmaenable</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xiidmaenable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xiidmaenable</span><span class="p">,</span>
		<span class="s">&quot;Enables iIDMA settings &quot;</span>
		<span class="s">&quot;Default is 1 - perform iIDMA. 0 - no iIDMA.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xmaxqueues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xmaxqueues</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xmaxqueues</span><span class="p">,</span>
		<span class="s">&quot;Enables MQ settings &quot;</span>
		<span class="s">&quot;Default is 1 for single queue. Set it to number &quot;</span>
		<span class="s">&quot;of queues in MQ mode.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xmultique_tag</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xmultique_tag</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xmultique_tag</span><span class="p">,</span>
		<span class="s">&quot;Enables CPU affinity settings for the driver &quot;</span>
		<span class="s">&quot;Default is 0 for no affinity of request and response IO. &quot;</span>
		<span class="s">&quot;Set it to 1 to turn on the cpu affinity.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xfwloadbin</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xfwloadbin</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xfwloadbin</span><span class="p">,</span>
		<span class="s">&quot;Option to specify location from which to load ISP firmware:.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 2 -- load firmware via the request_firmware() (hotplug).</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;      interface.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 1 -- load firmware from flash.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 0 -- use default semantics.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xetsenable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xetsenable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xetsenable</span><span class="p">,</span>
		<span class="s">&quot;Enables firmware ETS burst.&quot;</span>
		<span class="s">&quot;Default is 0 - skip ETS enablement.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xdbwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xdbwr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xdbwr</span><span class="p">,</span>
		<span class="s">&quot;Option to specify scheme for request queue posting.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 0 -- Regular doorbell.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 1 -- CAMRAM doorbell (faster).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xtargetreset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xtargetreset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xtargetreset</span><span class="p">,</span>
		 <span class="s">&quot;Enable target reset.&quot;</span>
		 <span class="s">&quot;Default is 1 - use hw defaults.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xgffidenable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xgffidenable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xgffidenable</span><span class="p">,</span>
		<span class="s">&quot;Enables GFF_ID checks of port type. &quot;</span>
		<span class="s">&quot;Default is 0 - Do not use GFF_ID information.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xasynctmfenable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xasynctmfenable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xasynctmfenable</span><span class="p">,</span>
		<span class="s">&quot;Enables issue of TM IOCBs asynchronously via IOCB mechanism&quot;</span>
		<span class="s">&quot;Default is 0 - Issue TM IOCBs via mailbox mechanism.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xdontresethba</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xdontresethba</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xdontresethba</span><span class="p">,</span>
		<span class="s">&quot;Option to specify reset behaviour.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 0 (Default) -- Reset on failure.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot; 1 -- Do not reset on failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">uint</span> <span class="n">ql2xmaxlun</span> <span class="o">=</span> <span class="n">MAX_LUNS</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xmaxlun</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xmaxlun</span><span class="p">,</span>
		<span class="s">&quot;Defines the maximum LU number to register with the SCSI &quot;</span>
		<span class="s">&quot;midlayer. Default is 65535.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xmdcapmask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xmdcapmask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xmdcapmask</span><span class="p">,</span>
		<span class="s">&quot;Set the Minidump driver capture mask level. &quot;</span>
		<span class="s">&quot;Default is 0x1F - Can be set to 0x3, 0x7, 0xF, 0x1F, 0x7F.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql2xmdenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql2xmdenable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql2xmdenable</span><span class="p">,</span>
		<span class="s">&quot;Enable/disable MiniDump. &quot;</span>
		<span class="s">&quot;0 - MiniDump disabled. &quot;</span>
		<span class="s">&quot;1 (Default) - MiniDump enabled.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * SCSI host template entry points</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_scan_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2xxx_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2xxx_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_eh_target_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_eh_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2xxx_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_change_queue_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">qla2xxx_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">qla2xxx_queuecommand</span><span class="p">,</span>

	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">qla2xxx_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">qla2xxx_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">qla2xxx_eh_target_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">qla2xxx_eh_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">qla2xxx_eh_host_reset</span><span class="p">,</span>

	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">qla2xxx_slave_configure</span><span class="p">,</span>

	<span class="p">.</span><span class="n">slave_alloc</span>		<span class="o">=</span> <span class="n">qla2xxx_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>		<span class="o">=</span> <span class="n">qla2xxx_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_finished</span>		<span class="o">=</span> <span class="n">qla2xxx_scan_finished</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_start</span>		<span class="o">=</span> <span class="n">qla2xxx_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">qla2x00_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_type</span>	<span class="o">=</span> <span class="n">qla2x00_change_queue_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>

	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">qla2x00_host_attrs</span><span class="p">,</span>

	<span class="p">.</span><span class="n">supported_mode</span>		<span class="o">=</span> <span class="n">MODE_INITIATOR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">qla2xxx_transport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">qla2xxx_transport_vport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* TODO Convert to inlines</span>
<span class="cm"> *</span>
<span class="cm"> * Timer routines</span>
<span class="cm"> */</span>

<span class="n">__inline__</span> <span class="kt">void</span>
<span class="nf">qla2x00_start_timer</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">func</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_restart_timer</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Currently used for 82XX only. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x600d</span><span class="p">,</span>
		    <span class="s">&quot;Device in a failed state, returning.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span>
<span class="nf">qla2x00_stop_timer</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_do_dpc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_rst_aen</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_mem_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint16_t</span><span class="p">,</span> <span class="kt">uint16_t</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">**</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">**</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_free_fw_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_mem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla2x00_alloc_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x003b</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for request queue ptrs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_req_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for response queue ptrs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_rsp_map</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure we record at least the request and response queue zero in</span>
<span class="cm">	 * case we need to free them if part of the probe fails.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">fail_rsp_map:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail_req_map:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla2x00_free_req_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">),</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla2x00_free_rsp_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">&amp;&amp;</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">),</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla2x00_free_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">qla2x00_free_req_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">qla2x00_free_rsp_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla25xx_setup_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ques</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d8</span><span class="p">,</span>
		    <span class="s">&quot;Firmware is not multi-queue capable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmultique_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* create a request queue for IO */</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_7</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">qla25xx_create_req_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">QLA_DEFAULT_QUE_QOS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00e0</span><span class="p">,</span>
			    <span class="s">&quot;Failed to create request queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;qla2xxx_wq&quot;</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">req</span><span class="p">];</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ques</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ques</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">;</span> <span class="n">ques</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_create_rsp_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00e8</span><span class="p">,</span>
				    <span class="s">&quot;Failed to create response queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xc007</span><span class="p">,</span>
		    <span class="s">&quot;CPU affinity mode enalbed, &quot;</span>
		    <span class="s">&quot;no. of response queues:%d no. of request queues:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00e9</span><span class="p">,</span>
		    <span class="s">&quot;CPU affinity mode enalbed, &quot;</span>
		    <span class="s">&quot;no. of response queues:%d no. of request queues:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail2:</span>
	<span class="n">qla25xx_delete_queues</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="nl">fail:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla2x00_pci_info_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_bus_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;33&quot;</span><span class="p">,</span> <span class="s">&quot;66&quot;</span><span class="p">,</span> <span class="s">&quot;100&quot;</span><span class="p">,</span> <span class="s">&quot;133&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">uint16_t</span> <span class="n">pci_bus</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCI&quot;</span><span class="p">);</span>
	<span class="n">pci_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pci_attr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_9</span> <span class="o">|</span> <span class="n">BIT_10</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;-X (&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">pci_bus_modes</span><span class="p">[</span><span class="n">pci_bus</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pci_attr</span> <span class="o">&amp;</span> <span class="n">BIT_8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; (&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">pci_bus_modes</span><span class="p">[</span><span class="n">pci_bus</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; MHz)&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla24xx_pci_info_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_bus_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;33&quot;</span><span class="p">,</span> <span class="s">&quot;66&quot;</span><span class="p">,</span> <span class="s">&quot;100&quot;</span><span class="p">,</span> <span class="s">&quot;133&quot;</span><span class="p">,</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcie_reg</span><span class="p">;</span>

	<span class="n">pcie_reg</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">lwstr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="kt">uint16_t</span> <span class="n">pcie_lstat</span><span class="p">,</span> <span class="n">lspeed</span><span class="p">,</span> <span class="n">lwidth</span><span class="p">;</span>

		<span class="n">pcie_reg</span> <span class="o">+=</span> <span class="mh">0x12</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_lstat</span><span class="p">);</span>
		<span class="n">lspeed</span> <span class="o">=</span> <span class="n">pcie_lstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_0</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_3</span><span class="p">);</span>
		<span class="n">lwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcie_lstat</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_4</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_8</span> <span class="o">|</span> <span class="n">BIT_9</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCIe (&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lspeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;2.5GT/s &quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lspeed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;5.0GT/s &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;&lt;unknown&gt; &quot;</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">lwstr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lwstr</span><span class="p">),</span> <span class="s">&quot;x%d)&quot;</span><span class="p">,</span> <span class="n">lwidth</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">lwstr</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCI&quot;</span><span class="p">);</span>
	<span class="n">pci_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pci_attr</span> <span class="o">&amp;</span> <span class="n">CSRX_PCIX_BUS_MODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pci_bus</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; (&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">pci_bus_modes</span><span class="p">[</span><span class="n">pci_bus</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;-X &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;Mode 2&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;Mode 1&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; (&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">pci_bus_modes</span><span class="p">[</span><span class="n">pci_bus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT_2</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; MHz)&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla2x00_fw_version_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">un_str</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d.%02d.%02d &quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="n">BIT_9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;FLX&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;EF&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x17</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;TP&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x37</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;IP&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x77</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;VI&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">un_str</span><span class="p">,</span> <span class="s">&quot;(%x)&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">un_str</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;X&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla24xx_fw_version_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d.%02d.%02d (%x)&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_sp_free_dma</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">GET_CMD_CTX_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_DMA_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DMA_VALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_CRC_PROT_DMA_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		    <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_CRC_PROT_DMA_VALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_CRC_CTX_DSD_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* List assured to be having elements */</span>
		<span class="n">qla2x00_clean_dsd_pool</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_CRC_CTX_DSD_VALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_CRC_CTX_DMA_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span>
		    <span class="p">((</span><span class="k">struct</span> <span class="n">crc_context</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">crc_ctx_dma</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_CRC_CTX_DMA_VALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_FCP_CMND_DMA_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ct6_dsd</span> <span class="o">*</span><span class="n">ctx1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct6_dsd</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="p">;</span>

		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">,</span> <span class="n">ctx1</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="p">,</span>
			<span class="n">ctx1</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma</span><span class="p">);</span>
		<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx1</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_list</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_inuse</span> <span class="o">-=</span> <span class="n">ctx1</span><span class="o">-&gt;</span><span class="n">dsd_use_cnt</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_avail</span> <span class="o">+=</span> <span class="n">ctx1</span><span class="o">-&gt;</span><span class="n">dsd_use_cnt</span><span class="p">;</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">ctx1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">);</span>
		<span class="n">ctx1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_sp_compl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3015</span><span class="p">,</span>
		    <span class="s">&quot;SP reference-count to ZERO -- sp=%p cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sp</span><span class="p">,</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql2xextended_error_logging</span> <span class="o">&amp;</span> <span class="n">ql_dbg_io</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qla2x00_sp_free_dma</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x9010</span><span class="p">,</span>
			    <span class="s">&quot;PCI Channel IO permanent failure, exiting &quot;</span>
			    <span class="s">&quot;cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x9011</span><span class="p">,</span>
			    <span class="s">&quot;EEH_Busy, Requeuing the cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_REQUEUE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">qc24_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">fc_remote_port_chkready</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3003</span><span class="p">,</span>
		    <span class="s">&quot;fc_remote_port_chkready failed for cmd=%p, rval=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qc24_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">difdix_supported</span> <span class="o">&amp;&amp;</span>
		<span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCSI_PROT_NORMAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3004</span><span class="p">,</span>
			    <span class="s">&quot;DIF Cap not reg, fail DIF capable cmd&#39;s:%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">qc24_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">qc24_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FCS_ONLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_DEVICE_DEAD</span> <span class="o">||</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DEAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3005</span><span class="p">,</span>
			    <span class="s">&quot;Returning DNC, fcport_state=%d loop_state=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">));</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">qc24_fail_command</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">qc24_target_busy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">qc24_host_busy</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SRB_SCSI_CMD</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="n">qla2x00_sp_free_dma</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">qla2x00_sp_compl</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">start_scsi</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3013</span><span class="p">,</span>
		    <span class="s">&quot;Start scsi failed rval=%d for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qc24_host_busy_free_sp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">qc24_host_busy_free_sp:</span>
	<span class="n">qla2x00_sp_free_dma</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>

<span class="nl">qc24_host_busy:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

<span class="nl">qc24_target_busy:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_TARGET_BUSY</span><span class="p">;</span>

<span class="nl">qc24_fail_command:</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_eh_wait_on_command</span>
<span class="cm"> *    Waits for the command to be returned by the Firmware for some</span>
<span class="cm"> *    max time.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *    cmd = Scsi Command to wait on.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Not Found : 0</span>
<span class="cm"> *    Found : 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_eh_wait_on_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ABORT_POLLING_PERIOD	1000</span>
<span class="cp">#define ABORT_WAIT_ITER		((10 * 1000) / (ABORT_POLLING_PERIOD))</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait_iter</span> <span class="o">=</span> <span class="n">ABORT_WAIT_ITER</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8005</span><span class="p">,</span>
		    <span class="s">&quot;Return:eh_wait.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wait_iter</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">ABORT_POLLING_PERIOD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_wait_for_hba_online</span>
<span class="cm"> *    Wait till the HBA is online after going through</span>
<span class="cm"> *    &lt;= MAX_RETRIES_OF_ISP_ABORT  or</span>
<span class="cm"> *    finally HBA is disabled ie marked offline</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *     ha - pointer to host adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *    Does context switching-Release SPIN_LOCK</span>
<span class="cm"> *    (if any) before calling this routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Success (Adapter is online) : 0</span>
<span class="cm"> *    Failed  (Adapter is offline/disabled) : 1</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">return_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">wait_online</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">wait_online</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_LOOP_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_online</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">return_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_wait_for_reset_ready</span>
<span class="cm"> *    Wait till the HBA is online after going through</span>
<span class="cm"> *    &lt;= MAX_RETRIES_OF_ISP_ABORT  or</span>
<span class="cm"> *    finally HBA is disabled ie marked offline or flash</span>
<span class="cm"> *    operations are in progress.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *     ha - pointer to host adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *    Does context switching-Release SPIN_LOCK</span>
<span class="cm"> *    (if any) before calling this routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Success (Adapter is online/no flash ops) : 0</span>
<span class="cm"> *    Failed  (Adapter is offline/disabled/flash ops in progress) : 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_wait_for_reset_ready</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">return_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">wait_online</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">wait_online</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_LOOP_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SWAITING</span> <span class="o">||</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_online</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">&amp;&amp;</span>  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">==</span> <span class="n">QLA_SWAITING</span><span class="p">)</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8019</span><span class="p">,</span>
	    <span class="s">&quot;%s return status=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">return_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_wait_for_chip_reset</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">return_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">wait_reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">wait_reset</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_LOOP_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_reset</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span><span class="p">)</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">* qla2xxx_eh_abort</span>
<span class="cm">*</span>
<span class="cm">* Description:</span>
<span class="cm">*    The abort function will abort the specified command.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*    cmd = Linux SCSI command packet to be aborted.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*    Either SUCCESS or FAILED.</span>
<span class="cm">*</span>
<span class="cm">* Note:</span>
<span class="cm">*    Only return FAILED if command not returned by firmware.</span>
<span class="cm">**************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fc_block_scsi_eh</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">,</span>
	    <span class="s">&quot;Aborting from RISC nexus=%ld:%d:%d sp=%p cmd=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Get a reference to the sp and drop the lock.*/</span>
	<span class="n">sp_get</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">abort_command</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8003</span><span class="p">,</span>
		    <span class="s">&quot;Abort command mbx failed cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8004</span><span class="p">,</span>
		    <span class="s">&quot;Abort command mbx success cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Did the command return during mailbox execution? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">FAILED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Wait for the command to be returned. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_eh_wait_on_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8006</span><span class="p">,</span>
			    <span class="s">&quot;Abort handler timed out cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x801c</span><span class="p">,</span>
	    <span class="s">&quot;Abort command issued nexus=%ld:%d:%d --  %d %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_eh_wait_for_pending_commands</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nexus_wait_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span>
		<span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SRB_SCSI_CMD</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WAIT_HOST</span>:
			<span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WAIT_TARGET</span>:
			<span class="n">match</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WAIT_LUN</span>:
			<span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">t</span> <span class="o">&amp;&amp;</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">l</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_eh_wait_on_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reset_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;HBA not online&quot;</span><span class="p">,</span>
	<span class="s">&quot;HBA not ready&quot;</span><span class="p">,</span>
	<span class="s">&quot;Task management failed&quot;</span><span class="p">,</span>
	<span class="s">&quot;Waiting for command completions&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__qla2xxx_eh_generic_reset</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nexus_wait_type</span> <span class="n">type</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">do_reset</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fc_block_scsi_eh</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8009</span><span class="p">,</span>
	    <span class="s">&quot;%s RESET ISSUED nexus=%ld:%d:%d cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x800a</span><span class="p">,</span>
		    <span class="s">&quot;Wait for hba online failed for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eh_reset_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_reset</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x800c</span><span class="p">,</span>
		    <span class="s">&quot;do_reset failed for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eh_reset_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_eh_wait_for_pending_commands</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x800d</span><span class="p">,</span>
		    <span class="s">&quot;wait for peding cmds failed for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eh_reset_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x800e</span><span class="p">,</span>
	    <span class="s">&quot;%s RESET SUCCEEDED nexus:%ld:%d:%d cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">eh_reset_failed:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x800f</span><span class="p">,</span>
	    <span class="s">&quot;%s RESET FAILED: %s nexus=%ld:%d:%d cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
	    <span class="n">reset_errors</span><span class="p">[</span><span class="n">err</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__qla2xxx_eh_generic_reset</span><span class="p">(</span><span class="s">&quot;DEVICE&quot;</span><span class="p">,</span> <span class="n">WAIT_LUN</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">lun_reset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_eh_target_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__qla2xxx_eh_generic_reset</span><span class="p">(</span><span class="s">&quot;TARGET&quot;</span><span class="p">,</span> <span class="n">WAIT_TARGET</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">target_reset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">* qla2xxx_eh_bus_reset</span>
<span class="cm">*</span>
<span class="cm">* Description:</span>
<span class="cm">*    The bus reset function will reset the bus and abort any executing</span>
<span class="cm">*    commands.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*    cmd = Linux SCSI command packet of the command that cause the</span>
<span class="cm">*          bus reset.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*    SUCCESS/FAILURE (defined as macro in scsi.h).</span>
<span class="cm">*</span>
<span class="cm">**************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_eh_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fc_block_scsi_eh</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8012</span><span class="p">,</span>
	    <span class="s">&quot;BUS RESET ISSUED nexus=%ld:%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8013</span><span class="p">,</span>
		    <span class="s">&quot;Wait for hba online failed board disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eh_bus_reset_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_loop_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eh_bus_reset_done</span><span class="p">;</span>

	<span class="cm">/* Flush outstanding commands. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_eh_wait_for_pending_commands</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WAIT_HOST</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8014</span><span class="p">,</span>
		    <span class="s">&quot;Wait for pending commands failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">eh_bus_reset_done:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x802b</span><span class="p">,</span>
	    <span class="s">&quot;BUS RESET %s nexus=%ld:%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FAILED&quot;</span> <span class="o">:</span> <span class="s">&quot;SUCCEDED&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">* qla2xxx_eh_host_reset</span>
<span class="cm">*</span>
<span class="cm">* Description:</span>
<span class="cm">*    The reset function will reset the Adapter.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      cmd = Linux SCSI command packet of the command that cause the</span>
<span class="cm">*            adapter reset.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      Either SUCCESS or FAILED.</span>
<span class="cm">*</span>
<span class="cm">* Note:</span>
<span class="cm">**************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8018</span><span class="p">,</span>
	    <span class="s">&quot;ADAPTER RESET ISSUED nexus=%ld:%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_reset_ready</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eh_host_reset_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span> <span class="o">!=</span> <span class="n">base_vha</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_vp_abort_isp</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">eh_host_reset_lock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla82xx_fcoe_ctx_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Ctx reset success */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">eh_host_reset_lock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall thru if ctx reset failed */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span>
			<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">abort_isp</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="cm">/* failed. schedule dpc to try */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x802a</span><span class="p">,</span>
				    <span class="s">&quot;wait for hba online failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">eh_host_reset_lock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Waiting for command to be returned to OS.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_eh_wait_for_pending_commands</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WAIT_HOST</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">eh_host_reset_lock:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8017</span><span class="p">,</span>
	    <span class="s">&quot;ADAPTER RESET %s nexus=%ld:%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FAILED&quot;</span> <span class="o">:</span> <span class="s">&quot;SUCCEEDED&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_loop_reset</span>
<span class="cm">*      Issue loop reset.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha = adapter block pointer.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0 = success</span>
<span class="cm">*/</span>
<span class="kt">int</span>
<span class="nf">qla2x00_loop_reset</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xtargetreset</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_target_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_TARGET</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">target_reset</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x802c</span><span class="p">,</span>
				    <span class="s">&quot;Bus Reset failed: Target Reset=%d &quot;</span>
				    <span class="s">&quot;d_id=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_full_login</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_full_login_lip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x802d</span><span class="p">,</span>
			    <span class="s">&quot;full_login_lip=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
		<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_lip_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x802e</span><span class="p">,</span>
			    <span class="s">&quot;lip_reset failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue marker command only when we are going to start the I/O */</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">que</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">que</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">que</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">;</span> <span class="n">que</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span> <span class="o">||</span> <span class="n">fc_remote_port_chkready</span><span class="p">(</span><span class="n">rport</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">fc_port_t</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
		<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla2x00_handle_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_track_queue_full</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3029</span><span class="p">,</span>
	    <span class="s">&quot;Queue depth adjusted-down to %d for nexus=%ld:%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla2x00_adjust_sdev_qdepth_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">&lt;=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">&lt;</span> <span class="n">qdepth</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ordered_tags</span><span class="p">)</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x302a</span><span class="p">,</span>
	    <span class="s">&quot;Queue depth adjusted-up to %d for nexus=%ld:%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_QDEPTH_DEFAULT</span>:
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">qdepth</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_QDEPTH_QFULL</span>:
		<span class="n">qla2x00_handle_queue_full</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_QDEPTH_RAMP_UP</span>:
		<span class="n">qla2x00_adjust_sdev_qdepth_up</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_change_queue_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag_type</span><span class="p">)</span>
			<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tag_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tag_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_config_dma_addressing() - Configure OS DMA addressing method.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * At exit, the @ha&#39;s flags.enable_64bit_addressing set to indicated</span>
<span class="cm"> * supported addressing method.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_config_dma_addressing</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Assume a 32bit DMA mask. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_64bit_addressing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Any upper-dword bits set? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">dma_get_required_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Ok, a 64bit DMA mask is applicable. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_64bit_addressing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">calc_req_entries</span> <span class="o">=</span> <span class="n">qla2x00_calc_iocbs_64</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">build_iocbs</span> <span class="o">=</span> <span class="n">qla2x00_build_scsi_iocbs_64</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_enable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* enable risc and host interrupts */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="n">ICR_EN_INT</span> <span class="o">|</span> <span class="n">ICR_EN_RISC</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_disable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* disable risc and host interrupts */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_enable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="n">ICRX_EN_RISC_INT</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_disable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOPOLLING_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_iospace_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">pio</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">msix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_selected_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">,</span>
	    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span>
		    <span class="s">&quot;Failed to reserve PIO/MMIO regions (%s), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bars</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_pio</span><span class="p">;</span>

	<span class="cm">/* We only need PIO for Flash operations on ISP2312 v2 chips. */</span>
	<span class="n">pio</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span>
			    <span class="s">&quot;Invalid pci I/O region size (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
			<span class="n">pio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span>
		    <span class="s">&quot;Region #0 no a PIO resource (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">pio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span> <span class="o">=</span> <span class="n">pio</span><span class="p">;</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span>
	    <span class="s">&quot;PIO address=%llu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">);</span>

<span class="nl">skip_pio:</span>
	<span class="cm">/* Use MMIO operations for all accesses. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span>
		    <span class="s">&quot;Region #1 not an MMIO resource (%s), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span>
		    <span class="s">&quot;Invalid PCI mem region size (%s), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">,</span>
		    <span class="s">&quot;Cannot remap MMIO (%s), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine queue resources */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ql2xmaxqueues</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ql2xmultique_tag</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ql2xmaxqueues</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xmultique_tag</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">mqiobase_exit</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span>
		    <span class="s">&quot;MQIO Base=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">);</span>
		<span class="cm">/* Read MSIX vector size of the board */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">QLA_PCI_MSIX_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msix</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">=</span> <span class="n">msix</span><span class="p">;</span>
		<span class="cm">/* Max queues are bounded by available msix vectors */</span>
		<span class="cm">/* queue 0 uses two msix vectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmultique_tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpus</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">cpus</span><span class="p">)</span> <span class="o">?</span>
				<span class="p">(</span><span class="n">cpus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ql2xmaxqueues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ql2xmaxqueues</span> <span class="o">&gt;</span> <span class="n">QLA_MQ_SIZE</span> <span class="o">?</span>
			    <span class="n">QLA_MQ_SIZE</span> <span class="o">:</span> <span class="n">ql2xmaxqueues</span><span class="p">;</span>
			<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xc008</span><span class="p">,</span>
			    <span class="s">&quot;QoS mode set, max no of request queues:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
			<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">,</span>
			    <span class="s">&quot;QoS mode set, max no of request queues:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X vector count: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msix</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">,</span>
		    <span class="s">&quot;BAR 3 not enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">mqiobase_exit:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">,</span>
	    <span class="s">&quot;MSIX Count:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="nl">iospace_error_exit:</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla83xx_iospace_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">msix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_selected_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">,</span>
	    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0117</span><span class="p">,</span>
		    <span class="s">&quot;Failed to reserve PIO/MMIO regions (%s), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use MMIO operations for all accesses. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0118</span><span class="p">,</span>
		    <span class="s">&quot;Invalid pci I/O region size (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0119</span><span class="p">,</span>
		    <span class="s">&quot;Invalid PCI mem region size (%s), aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x011a</span><span class="p">,</span>
		    <span class="s">&quot;Cannot remap MMIO (%s), aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 64bit PCI BAR - BAR2 will correspoond to region 4 */</span>
	<span class="cm">/* 83XX 26XX always use MQ type access for queues</span>
<span class="cm">	 * - mbar 2, a.k.a region 4 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x011d</span><span class="p">,</span>
		    <span class="s">&quot;BAR2/region4 not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mqiobase_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msixbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msixbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read MSIX vector size of the board */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		    <span class="n">QLA_83XX_PCI_MSIX_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msix</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">=</span> <span class="n">msix</span><span class="p">;</span>
		<span class="cm">/* Max queues are bounded by available msix vectors */</span>
		<span class="cm">/* queue 0 uses two msix vectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmultique_tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpus</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">cpus</span><span class="p">)</span> <span class="o">?</span>
				<span class="p">(</span><span class="n">cpus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ql2xmaxqueues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ql2xmaxqueues</span> <span class="o">&gt;</span> <span class="n">QLA_MQ_SIZE</span> <span class="o">?</span>
						<span class="n">QLA_MQ_SIZE</span> <span class="o">:</span> <span class="n">ql2xmaxqueues</span><span class="p">;</span>
			<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xc00c</span><span class="p">,</span>
			    <span class="s">&quot;QoS mode set, max no of request queues:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
			<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x011b</span><span class="p">,</span>
			    <span class="s">&quot;QoS mode set, max no of request queues:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x011c</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X vector count: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msix</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x011e</span><span class="p">,</span>
		    <span class="s">&quot;BAR 1 not enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">mqiobase_exit:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x011f</span><span class="p">,</span>
	    <span class="s">&quot;MSIX Count:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">iospace_error_exit:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla2100_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla2100_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla2x00_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla2x00_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla2x00_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla2x00_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla2x00_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla2x00_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla2x00_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla2x00_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla2x00_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla2100_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla2x00_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla2x00_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla2x00_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla2x00_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla2x00_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla2x00_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla2x00_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="n">qla2x00_calc_iocbs_32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="n">qla2x00_build_scsi_iocbs_32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla2x00_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla2x00_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="n">qla2x00_read_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="n">qla2x00_write_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla2100_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla2x00_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla2x00_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla2x00_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>		<span class="o">=</span> <span class="n">qla2x00_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla2x00_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>     	<span class="o">=</span> <span class="n">qla2x00_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla2300_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla2300_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla2x00_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla2x00_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla2x00_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla2x00_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla2x00_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla2x00_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla2x00_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla2x00_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla2x00_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla2300_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla2x00_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla2x00_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla2x00_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla2x00_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla2x00_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla2x00_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla2x00_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="n">qla2x00_calc_iocbs_32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="n">qla2x00_build_scsi_iocbs_32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla2x00_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla2x00_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="n">qla2x00_read_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="n">qla2x00_write_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla2300_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="n">qla2x00_beacon_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="n">qla2x00_beacon_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="n">qla2x00_beacon_blink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla2x00_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla2x00_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla2x00_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>		<span class="o">=</span> <span class="n">qla2x00_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla2x00_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>     	<span class="o">=</span> <span class="n">qla2x00_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla24xx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla24xx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla24xx_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla24xx_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla24xx_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla24xx_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla24xx_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla24xx_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla24xx_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla24xx_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla24xx_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla24xx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla24xx_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla24xx_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla24xx_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla24xx_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla24xx_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla24xx_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla24xx_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="n">qla24xx_read_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="n">qla24xx_write_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla24xx_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_blink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla24xx_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla24xx_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla24xx_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>		<span class="o">=</span> <span class="n">qla24xx_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla2x00_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>     	<span class="o">=</span> <span class="n">qla2x00_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla25xx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla25xx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla24xx_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla24xx_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla24xx_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla24xx_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla24xx_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla24xx_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla24xx_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla24xx_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla24xx_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla24xx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla24xx_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla24xx_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla24xx_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla24xx_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla24xx_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla24xx_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla24xx_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="n">qla25xx_read_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="n">qla25xx_write_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla25xx_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_blink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla25xx_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla24xx_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla24xx_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>		<span class="o">=</span> <span class="n">qla24xx_dif_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla2x00_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>     	<span class="o">=</span> <span class="n">qla2x00_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla81xx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla25xx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla24xx_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla24xx_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla24xx_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla24xx_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla81xx_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla81xx_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla81xx_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla24xx_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla24xx_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla24xx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla24xx_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla24xx_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla24xx_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla24xx_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla24xx_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla24xx_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla24xx_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla81xx_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="n">qla83xx_beacon_blink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla25xx_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla24xx_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla24xx_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>		<span class="o">=</span> <span class="n">qla24xx_dif_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla2x00_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>     	<span class="o">=</span> <span class="n">qla2x00_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla82xx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla82xx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla82xx_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla24xx_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla82xx_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla24xx_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla81xx_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla24xx_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla82xx_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla82xx_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla24xx_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla82xx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla82xx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla82xx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla24xx_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla24xx_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla24xx_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla24xx_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla24xx_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla24xx_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla24xx_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="n">qla24xx_read_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="n">qla24xx_write_nvram_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla24xx_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="n">qla82xx_beacon_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="n">qla82xx_beacon_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla82xx_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla82xx_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla24xx_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>             <span class="o">=</span> <span class="n">qla82xx_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla82xx_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>     	<span class="o">=</span> <span class="n">qla82xx_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla83xx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pci_config</span>		<span class="o">=</span> <span class="n">qla25xx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>		<span class="o">=</span> <span class="n">qla24xx_reset_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_diag</span>		<span class="o">=</span> <span class="n">qla24xx_chip_diag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_rings</span>		<span class="o">=</span> <span class="n">qla24xx_config_rings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_adapter</span>		<span class="o">=</span> <span class="n">qla24xx_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvram_config</span>		<span class="o">=</span> <span class="n">qla81xx_nvram_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_fw_options</span>	<span class="o">=</span> <span class="n">qla81xx_update_fw_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_risc</span>		<span class="o">=</span> <span class="n">qla81xx_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_info_str</span>		<span class="o">=</span> <span class="n">qla24xx_pci_info_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_version_str</span>		<span class="o">=</span> <span class="n">qla24xx_fw_version_str</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>		<span class="o">=</span> <span class="n">qla24xx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>		<span class="o">=</span> <span class="n">qla24xx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_command</span>		<span class="o">=</span> <span class="n">qla24xx_abort_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_reset</span>		<span class="o">=</span> <span class="n">qla24xx_abort_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lun_reset</span>		<span class="o">=</span> <span class="n">qla24xx_lun_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_login</span>		<span class="o">=</span> <span class="n">qla24xx_login_fabric</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_logout</span>		<span class="o">=</span> <span class="n">qla24xx_fabric_logout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_req_entries</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_iocbs</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_iocb</span>		<span class="o">=</span> <span class="n">qla24xx_prep_ms_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_ms_fdmi_iocb</span>	<span class="o">=</span> <span class="n">qla24xx_prep_ms_fdmi_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_nvram</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_nvram</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_dump</span>		<span class="o">=</span> <span class="n">qla83xx_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_on</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_off</span>		<span class="o">=</span> <span class="n">qla24xx_beacon_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">beacon_blink</span>		<span class="o">=</span> <span class="n">qla83xx_beacon_blink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_optrom</span>		<span class="o">=</span> <span class="n">qla25xx_read_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_optrom</span>		<span class="o">=</span> <span class="n">qla24xx_write_optrom_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_flash_version</span>	<span class="o">=</span> <span class="n">qla24xx_get_flash_version</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_scsi</span>		<span class="o">=</span> <span class="n">qla24xx_dif_start_scsi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_isp</span>		<span class="o">=</span> <span class="n">qla2x00_abort_isp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iospace_config</span>		<span class="o">=</span> <span class="n">qla83xx_iospace_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_set_isp_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DT_EXTENDED_IDS</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2100</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DT_EXTENDED_IDS</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2200</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2200</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DT_EXTENDED_IDS</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2300</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2312</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2312</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2322</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2322</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1028</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0170</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_OEM_001</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP6312</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP6312</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP6322</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP6322</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2422</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2422</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2432</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2432</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8432</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP8432</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP5422</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP5422</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP5432</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP5432</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2532</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2532</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8001</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP8001</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8021</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP8021</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="cm">/* Initialize 82XX ISP flags */</span>
		<span class="n">qla82xx_init_flags</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2031</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2031</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_T10_PI</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8031</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP8031</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ZIO_SUPPORTED</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_FWI2</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_IIDMA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_T10_PI</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span> <span class="o">=</span> <span class="n">RISC_START_ADDRESS_2400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Get adapter physical port no from interrupt pin register. */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span>
	    <span class="s">&quot;device_type=0x%x port=%d fw_srisc_address=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">running_gold_fw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NPIV_CONFIG_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_scan_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_READY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCI driver interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">qla2x00_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pci_info</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">fw_str</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bars</span><span class="p">,</span> <span class="n">mem_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">req_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsp_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bars</span> <span class="o">=</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span><span class="p">);</span>
	<span class="n">sht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla2xxx_driver_template</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2422</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2432</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8432</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP5422</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP5432</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2532</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8001</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8021</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2031</span> <span class="o">||</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8031</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bars</span> <span class="o">=</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">);</span>
		<span class="n">mem_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span>
		    <span class="s">&quot;Mem only adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span>
	    <span class="s">&quot;Bars=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bars</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This may fail but that&#39;s ok */</span>
	<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for ha.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span>
	    <span class="s">&quot;Memory allocated for ha=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">enable_class_2</span> <span class="o">=</span> <span class="n">ql2xenableclass2</span><span class="p">;</span>

	<span class="cm">/* Clear our data area */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bars</span> <span class="o">=</span> <span class="n">bars</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_only</span> <span class="o">=</span> <span class="n">mem_only</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">);</span>

	<span class="cm">/* Set ISP-type information. */</span>
	<span class="n">qla2x00_set_isp_flags</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Set EEH reset type to fundamental if required by hba */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">needs_freset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">prev_topology</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">init_cb_t</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span> <span class="o">=</span> <span class="n">PORT_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_2300</span><span class="p">;</span>

	<span class="cm">/* Assign ISP specific operations. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT_2100</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_2100</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla2100_isp_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT_2200</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_2200</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla2100_isp_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2100</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_2200</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_2322</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla2300_isp_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2400</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_24XX</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span> <span class="o">=</span> <span class="n">ATIO_ENTRY_CNT_24XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_init_cb_24xx</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_24XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span> <span class="o">=</span> <span class="n">QLA_MAX_VPORTS_QLA24XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla24xx_isp_ops</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_CONF</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_DATA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_NVRAM_CONF</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_NVRAM_DATA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2400</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_24XX</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span> <span class="o">=</span> <span class="n">ATIO_ENTRY_CNT_24XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_init_cb_24xx</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_25XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span> <span class="o">=</span> <span class="n">QLA_MAX_VPORTS_QLA25XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla25xx_isp_ops</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_CONF</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_DATA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_NVRAM_CONF</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_NVRAM_DATA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2400</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_24XX</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_init_cb_81xx</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_81XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span> <span class="o">=</span> <span class="n">QLA_MAX_VPORTS_QLA25XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla81xx_isp_ops</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_CONF_81XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_DATA_81XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2400</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_82XX</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_82XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_init_cb_81xx</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_82XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span> <span class="o">=</span> <span class="n">QLA_MAX_VPORTS_QLA25XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla82xx_isp_ops</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_CONF</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_DATA</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_NVRAM_CONF</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_NVRAM_DATA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_2400</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
		<span class="n">req_length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_24XX</span><span class="p">;</span>
		<span class="n">rsp_length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span> <span class="o">=</span> <span class="n">SNS_LAST_LOOP_ID_2300</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_init_cb_81xx</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">=</span> <span class="n">OPTROM_SIZE_83XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span> <span class="o">=</span> <span class="n">QLA_MAX_VPORTS_QLA25XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla83xx_isp_ops</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_CONF_81XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_DATA_81XX</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">,</span>
	    <span class="s">&quot;mbx_count=%d, req_length=%d, &quot;</span>
	    <span class="s">&quot;rsp_length=%d, max_loop_id=%d, init_cb_size=%d, &quot;</span>
	    <span class="s">&quot;gid_list_info_size=%d, optrom_size=%d, nvram_npiv_size=%d, &quot;</span>
	    <span class="s">&quot;max_fibre_devices=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">,</span> <span class="n">req_length</span><span class="p">,</span> <span class="n">rsp_length</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">);</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x001f</span><span class="p">,</span>
	    <span class="s">&quot;isp_ops=%p, flash_conf_off=%d, &quot;</span>
	    <span class="s">&quot;flash_data_off=%d, nvram_conf_off=%d, nvram_data_off=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span><span class="p">);</span>

	<span class="cm">/* Configure PCI I/O space */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">iospace_config</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_hw_failed</span><span class="p">;</span>

	<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">,</span>
	    <span class="s">&quot;Found an ISP%04X irq %d iobase 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_comp</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_comp</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_comp</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">);</span>

	<span class="n">qla2x00_config_dma_addressing</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span>
	    <span class="s">&quot;64 Bit addressing is %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_64bit_addressing</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span>
	    <span class="s">&quot;disable&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_mem_alloc</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req_length</span><span class="p">,</span> <span class="n">rsp_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for adapter, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">probe_hw_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">MAX_Q_DEPTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmaxqdepth</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xmaxqdepth</span> <span class="o">&lt;=</span> <span class="mh">0xffffU</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">ql2xmaxqdepth</span><span class="p">;</span>


	<span class="n">base_vha</span> <span class="o">=</span> <span class="n">qla2x00_create_host</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_vha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">qla2x00_mem_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla2x00_free_req_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">qla2x00_free_rsp_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_hw_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2XXX_MIDTYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span> <span class="o">=</span> <span class="n">MANAGEMENT_SERVER</span> <span class="o">+</span>
						<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="cm">/* Set the SG table size based on ISP type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">QLA_SG_ALL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span>
	    <span class="s">&quot;can_queue=%d, req=%p, &quot;</span>
	    <span class="s">&quot;mgmt_svr_loop_id=%d, sg_tablesize=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">,</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
	    <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_T10_PI_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xenabledif</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">MAX_CMDSZ</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">MAX_BUSES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">ql2xmaxlun</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">qla2xxx_transport_template</span><span class="p">;</span>
	<span class="n">sht</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSI_NL_VID_TYPE_PCI</span> <span class="o">|</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span>
	    <span class="s">&quot;max_id=%d this_id=%d &quot;</span>
	    <span class="s">&quot;cmd_per_len=%d unique_id=%d max_cmd_len=%d max_channel=%d &quot;</span>
	    <span class="s">&quot;max_lun=%d transportt=%p, vendor_id=%llu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">,</span>
	    <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span>
	    <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">,</span>
	    <span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span><span class="p">,</span> <span class="n">sht</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">);</span>

<span class="nl">que_init:</span>
	<span class="cm">/* Alloc arrays of request and response ring ptrs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_alloc_queues</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x003d</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for queue pointers...&quot;</span>
		    <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_init_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qlt_probe_one_stage1</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Set up the irqs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_request_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_init_failed</span><span class="p">;</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Assign back pointers */</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* FWI2-capable only. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_in</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">rsp_q_in</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">rsp_q_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">req_q_in</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">rsp_q_in</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">rsp_q_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">rsp_q_in</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">rsp_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xc009</span><span class="p">,</span>
	    <span class="s">&quot;rsp_q_map=%p req_q_map=%p rsp-&gt;req=%p req-&gt;rsp=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xc00a</span><span class="p">,</span>
	    <span class="s">&quot;req-&gt;req_q_in=%p req-&gt;req_q_out=%p &quot;</span>
	    <span class="s">&quot;rsp-&gt;rsp_q_in=%p rsp-&gt;rsp_q_out=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">,</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x003e</span><span class="p">,</span>
	    <span class="s">&quot;rsp_q_map=%p req_q_map=%p rsp-&gt;req=%p req-&gt;rsp=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">,</span>
	    <span class="s">&quot;req-&gt;req_q_in=%p req-&gt;req_q_out=%p rsp-&gt;rsp_q_in=%p rsp-&gt;rsp_q_out=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_initialize_adapter</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00d6</span><span class="p">,</span>
		    <span class="s">&quot;Failed to initialize adapter - Adapter flags %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
				<span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00d7</span><span class="p">,</span>
			    <span class="s">&quot;HW State: FAILED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla25xx_setup_mode</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00ec</span><span class="p">,</span>
			    <span class="s">&quot;Failed to create queues, falling back to single queue mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">que_init</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">running_gold_fw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_dpc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Startup the kernel thread for this host adapter</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">qla2x00_do_dpc</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;%s_dpc&quot;</span><span class="p">,</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host_str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00ed</span><span class="p">,</span>
		    <span class="s">&quot;Failed to start DPC thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00ee</span><span class="p">,</span>
	    <span class="s">&quot;DPC thread started successfully.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re not coming up in initiator mode, we might sit for</span>
<span class="cm">	 * a while without waking up the dpc thread, which leads to a</span>
<span class="cm">	 * stuck process warning.  So just kick the dpc once here and</span>
<span class="cm">	 * let the kthread start (and go back to sleep in qla2x00_do_dpc).</span>
<span class="cm">	 */</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

<span class="nl">skip_dpc:</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">);</span>
	<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Initialized the timer */</span>
	<span class="n">qla2x00_start_timer</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">qla2x00_timer</span><span class="p">,</span> <span class="n">WATCH_INTERVAL</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00ef</span><span class="p">,</span>
	    <span class="s">&quot;Started qla2x00_timer with &quot;</span>
	    <span class="s">&quot;interval=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WATCH_INTERVAL</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00f0</span><span class="p">,</span>
	    <span class="s">&quot;Detected hba at address=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_T10_PI_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xenabledif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">difdix_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00f1</span><span class="p">,</span>
			    <span class="s">&quot;Registering for DIF/DIX type 1 and 3 protection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql2xenabledif</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">prot</span> <span class="o">=</span> <span class="n">SHOST_DIX_TYPE0_PROTECTION</span><span class="p">;</span>
			<span class="n">scsi_host_set_prot</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
			    <span class="n">prot</span> <span class="o">|</span> <span class="n">SHOST_DIF_TYPE1_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIF_TYPE2_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIF_TYPE3_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIX_TYPE1_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIX_TYPE2_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIX_TYPE3_PROTECTION</span><span class="p">);</span>
			<span class="n">scsi_host_set_guard</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SHOST_DIX_GUARD_CRC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">difdix_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_failed</span><span class="p">;</span>

	<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00f2</span><span class="p">,</span>
	    <span class="s">&quot;Init done and hba is online.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span>
		<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">,</span>
			<span class="s">&quot;skipping scsi_scan_host() for non-initiator port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qla2x00_alloc_sysfs_attr</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">qla2x00_init_host_attr</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">qla2x00_dfs_setup</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00fb</span><span class="p">,</span>
	    <span class="s">&quot;QLogic %s - %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span> <span class="o">?</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">,</span>
	    <span class="s">&quot;ISP%04X: %s @ %s hdma%c host#=%ld fw=%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">pci_info_str</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">pci_info</span><span class="p">),</span>
	    <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_64bit_addressing</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	    <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_version_str</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">fw_str</span><span class="p">));</span>

	<span class="n">qlt_add_target</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_init_failed:</span>
	<span class="n">qla2x00_free_req_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">);</span>
	<span class="n">qla2x00_free_rsp_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span>
		<span class="n">qla2x00_stop_timer</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
	<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla2x00_free_device</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

<span class="nl">probe_hw_failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql2xdbwr</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">((</span><span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">probe_out:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_stop_dpc_thread</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * qla2xxx_wake_dpc checks for -&gt;dpc_thread</span>
<span class="cm">	 * so we need to zero it out.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span>  <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Turn-off FCE trace */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_disable_fce_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn-off EFT trace */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">)</span>
		<span class="n">qla2x00_disable_eft_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Stop currently executing firmware. */</span>
	<span class="n">qla2x00_try_to_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Turn adapter off line */</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* turn-off interrupts on the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla2x00_free_irqs</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla2x00_free_fw_dump</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">,</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span>  <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the PCI device is disabled that means that probe failed and any</span>
<span class="cm">	 * resources should be have cleaned up on probe exit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">host_shutting_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cur_vport_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">);</span>
		<span class="cm">/* This assumes first entry in ha-&gt;vp_list is always base vha */</span>
		<span class="n">vha</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">scsi_qla_host_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">scsi_host</span> <span class="o">=</span> <span class="n">scsi_host_get</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>

		<span class="n">fc_vport_terminate</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">);</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">qla2x00_dfs_remove</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">qla84xx_put_chip</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="cm">/* Disable timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span>
		<span class="n">qla2x00_stop_timer</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Flush the work queue and remove it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Kill the kernel thread for this host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * qla2xxx_wake_dpc checks for -&gt;dpc_thread</span>
<span class="cm">		 * so we need to zero it out.</span>
<span class="cm">		 */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qlt_remove_target</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">);</span>

	<span class="n">qla2x00_free_sysfs_attr</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">qla2x00_free_device</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">((</span><span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql2xdbwr</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">((</span><span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msixbase</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msixbase</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_free_device</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Disable timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span>
		<span class="n">qla2x00_stop_timer</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla2x00_stop_dpc_thread</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla25xx_delete_queues</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span><span class="p">)</span>
		<span class="n">qla2x00_disable_fce_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">)</span>
		<span class="n">qla2x00_disable_eft_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Stop currently executing firmware. */</span>
	<span class="n">qla2x00_try_to_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* turn-off interrupts on the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla2x00_free_irqs</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla2x00_free_fcports</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla2x00_mem_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">qla82xx_md_free</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla2x00_free_queues</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla2x00_free_fcports</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="o">*</span><span class="n">tfcport</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">tfcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">fcport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_schedule_rport_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">defer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rport</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">defer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">drport</span> <span class="o">=</span> <span class="n">rport</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fc_remote_port_delete</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="n">qlt_fc_port_deleted</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_mark_device_lost Updates fcport state when device goes offline.</span>
<span class="cm"> *</span>
<span class="cm"> * Input: ha = adapter block pointer.  fcport = port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: None.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">do_login</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_ONLINE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">==</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_DEVICE_LOST</span><span class="p">);</span>
		<span class="n">qla2x00_schedule_rport_del</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">defer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We may need to retry the login, so don&#39;t change the state of the</span>
<span class="cm">	 * port but do the retries.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FCS_DEVICE_DEAD</span><span class="p">)</span>
		<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_DEVICE_LOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_login</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2067</span><span class="p">,</span>
		    <span class="s">&quot;Port login retry &quot;</span>
		    <span class="s">&quot;%02x%02x%02x%02x%02x%02x%02x%02x, &quot;</span>
		    <span class="s">&quot;id = 0x%04x retry cnt=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_mark_all_devices_lost</span>
<span class="cm"> *	Updates fcport state when device goes offline.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	fcport = port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	None.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">!=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * No point in marking the device as lost, if the device is</span>
<span class="cm">		 * already DEAD.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_DEVICE_DEAD</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_ONLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_DEVICE_LOST</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">defer</span><span class="p">)</span>
				<span class="n">qla2x00_schedule_rport_del</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">defer</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">==</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span>
				<span class="n">qla2x00_schedule_rport_del</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">defer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_mem_alloc</span>
<span class="cm">*      Allocates adapter memory.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0  = success.</span>
<span class="cm">*      !0  = failure.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_mem_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">req_len</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rsp_len</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">**</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">**</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_mem_alloc</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_init_cb</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_tgt_mem</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="n">SRB_MIN_REQ</span><span class="p">,</span> <span class="n">srb_cachep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_gid_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Allocate cache for CT6 Ctx. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx_cachep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qla2xxx_ctx&quot;</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct6_dsd</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx_cachep</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_free_gid_list</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="n">SRB_MIN_REQ</span><span class="p">,</span>
			<span class="n">ctx_cachep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_srb_mempool</span><span class="p">;</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span>
		    <span class="s">&quot;ctx_cachep=%p ctx_mempool=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ctx_cachep</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get memory for cached NVRAM */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">MAX_NVRAM_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_ctx_mempool</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s_%d&quot;</span><span class="p">,</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">DMA_POOL_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_nvram</span><span class="p">;</span>

	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span>
	    <span class="s">&quot;init_cb=%p gid_list=%p, srb_mempool=%p s_dma_pool=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">ql2xenabledif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DSD_LIST_DMA_POOL_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span>
			    <span class="s">&quot;Failed to allocate memory for dl_dma_pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_s_dma_pool</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">FCP_CMND_DMA_POOL_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span>
			    <span class="s">&quot;Failed to allocate memory for fcp_cmnd_dma_pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_dl_dma_pool</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0025</span><span class="p">,</span>
		    <span class="s">&quot;dl_dma_pool=%p fcp_cmnd_dma_pool=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for SNS commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* Get consistent memory allocated for SNS commands */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_dma_pool</span><span class="p">;</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span>
		    <span class="s">&quot;sns_cmd: %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* Get consistent memory allocated for MS IOCB */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_dma_pool</span><span class="p">;</span>
	<span class="cm">/* Get consistent memory allocated for CT SNS commands */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_pkt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_ms_iocb</span><span class="p">;</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span>
		    <span class="s">&quot;ms_iocb=%p ct_sns=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for request ring */</span>
	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">req_que</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for req.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_req</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">req_len</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">((</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for req_ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_req_ring</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate memory for response ring */</span>
	<span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for rsp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_rsp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">rsp_len</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">((</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x002b</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for rsp_ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_rsp_ring</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span>
	    <span class="s">&quot;req=%p req-&gt;length=%d req-&gt;ring=%p rsp=%p &quot;</span>
	    <span class="s">&quot;rsp-&gt;length=%d rsp-&gt;ring=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
	<span class="cm">/* Allocate memory for NVRAM data for vports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_npiv_entry</span><span class="p">)</span> <span class="o">*</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">,</span>
			    <span class="s">&quot;Failed to allocate memory for npiv_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_npiv_info</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Get consistent memory allocated for EX-INIT-CB. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_ex_init_cb</span><span class="p">;</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x002e</span><span class="p">,</span>
		    <span class="s">&quot;ex_init_cb=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_list</span><span class="p">);</span>

	<span class="cm">/* Get consistent memory allocated for Async Port-Database. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_async_pd</span><span class="p">;</span>
		<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x002f</span><span class="p">,</span>
		    <span class="s">&quot;async_pd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">fail_async_pd:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">);</span>
<span class="nl">fail_ex_init_cb:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">);</span>
<span class="nl">fail_npiv_info:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_rsp_ring:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
<span class="nl">fail_rsp:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">((</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_req_ring:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="nl">fail_req:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_pkt</span><span class="p">),</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_free_ms_iocb:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_dma_pool:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">ql2xenabledif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fail_dl_dma_pool:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">ql2xenabledif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fail_s_dma_pool:</span>
	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail_free_nvram:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail_free_ctx_mempool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail_free_srb_mempool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail_free_gid_list:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">),</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">,</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_dma</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_free_tgt_mem:</span>
	<span class="n">qlt_mem_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="nl">fail_free_init_cb:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">,</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span>
	    <span class="s">&quot;Memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_free_fw_dump</span>
<span class="cm">*	Frees fw dump stuff.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*	ha = adapter block pointer.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_free_fw_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FCE_SIZE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="n">ntohl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">eft_size</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_reading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_mem_free</span>
<span class="cm">*      Frees all adapter allocated memory.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha = adapter block pointer.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_mem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla2x00_free_fw_dump</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DCBX_TLV_DATA_SIZE</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">XGMAC_DATA_SIZE</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">),</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_pkt</span><span class="p">),</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">)</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">),</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dsd_dma</span> <span class="o">*</span><span class="n">dsd_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">tdsd_ptr</span><span class="p">;</span>

			<span class="cm">/* clean up allocated prev pool */</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="p">,</span>
				<span class="n">tdsd_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span>
				<span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span><span class="p">,</span> <span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">)</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">)</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">);</span>

	<span class="n">qlt_mem_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">swl</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="nf">qla2x00_create_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scsi_qla_host_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0107</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate host from the scsi layer, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear our data area */</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scsi_qla_host_t</span><span class="p">));</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_str</span><span class="p">,</span> <span class="s">&quot;%s_%ld&quot;</span><span class="p">,</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span>
	    <span class="s">&quot;Allocated the host=%p hw=%p vha=%p dev_name=%s&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span>
	    <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">vha</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">vha</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span>
<span class="nf">qla2x00_alloc_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qla_work_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bail</span><span class="p">;</span>

	<span class="n">QLA_VHA_MARK_BUSY</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">bail</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bail</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_work_evt</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QLA_VHA_MARK_NOT_BUSY</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">QLA_EVT_FLAG_FREE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_post_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_post_aen_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_host_event_code</span> <span class="n">code</span><span class="p">,</span>
    <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">qla2x00_alloc_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">QLA_EVT_AEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qla2x00_post_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_post_idc_ack_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">qla2x00_alloc_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">QLA_EVT_IDC_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">idc_ack</span><span class="p">.</span><span class="n">mb</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">QLA_IDC_ACK_REGS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">qla2x00_post_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define qla2x00_post_async_work(name, type)	\</span>
<span class="cp">int qla2x00_post_async_##name##_work(		\</span>
<span class="cp">    struct scsi_qla_host *vha,			\</span>
<span class="cp">    fc_port_t *fcport, uint16_t *data)		\</span>
<span class="cp">{						\</span>
<span class="cp">	struct qla_work_evt *e;			\</span>
<span class="cp">						\</span>
<span class="cp">	e = qla2x00_alloc_work(vha, type);	\</span>
<span class="cp">	if (!e)					\</span>
<span class="cp">		return QLA_FUNCTION_FAILED;	\</span>
<span class="cp">						\</span>
<span class="cp">	e-&gt;u.logio.fcport = fcport;		\</span>
<span class="cp">	if (data) {				\</span>
<span class="cp">		e-&gt;u.logio.data[0] = data[0];	\</span>
<span class="cp">		e-&gt;u.logio.data[1] = data[1];	\</span>
<span class="cp">	}					\</span>
<span class="cp">	return qla2x00_post_work(vha, e);	\</span>
<span class="cp">}</span>

<span class="n">qla2x00_post_async_work</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">QLA_EVT_ASYNC_LOGIN</span><span class="p">);</span>
<span class="n">qla2x00_post_async_work</span><span class="p">(</span><span class="n">login_done</span><span class="p">,</span> <span class="n">QLA_EVT_ASYNC_LOGIN_DONE</span><span class="p">);</span>
<span class="n">qla2x00_post_async_work</span><span class="p">(</span><span class="n">logout</span><span class="p">,</span> <span class="n">QLA_EVT_ASYNC_LOGOUT</span><span class="p">);</span>
<span class="n">qla2x00_post_async_work</span><span class="p">(</span><span class="n">logout_done</span><span class="p">,</span> <span class="n">QLA_EVT_ASYNC_LOGOUT_DONE</span><span class="p">);</span>
<span class="n">qla2x00_post_async_work</span><span class="p">(</span><span class="n">adisc</span><span class="p">,</span> <span class="n">QLA_EVT_ASYNC_ADISC</span><span class="p">);</span>
<span class="n">qla2x00_post_async_work</span><span class="p">(</span><span class="n">adisc_done</span><span class="p">,</span> <span class="n">QLA_EVT_ASYNC_ADISC_DONE</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">qla2x00_post_uevent_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">qla2x00_alloc_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">QLA_EVT_UEVENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">uevent</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qla2x00_post_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_uevent_emit</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">event_string</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">event_string</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLA_UEVENT_CODE_FW_DUMP</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">event_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event_string</span><span class="p">),</span> <span class="s">&quot;FW_DUMP=%ld&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_do_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA_EVT_AEN</span>:
			<span class="n">fc_host_post_event</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">fc_get_event_number</span><span class="p">(),</span>
			    <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_IDC_ACK</span>:
			<span class="n">qla81xx_idc_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">idc_ack</span><span class="p">.</span><span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_ASYNC_LOGIN</span>:
			<span class="n">qla2x00_async_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">fcport</span><span class="p">,</span>
			    <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_ASYNC_LOGIN_DONE</span>:
			<span class="n">qla2x00_async_login_done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">fcport</span><span class="p">,</span>
			    <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_ASYNC_LOGOUT</span>:
			<span class="n">qla2x00_async_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">fcport</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_ASYNC_LOGOUT_DONE</span>:
			<span class="n">qla2x00_async_logout_done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">fcport</span><span class="p">,</span>
			    <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_ASYNC_ADISC</span>:
			<span class="n">qla2x00_async_adisc</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">fcport</span><span class="p">,</span>
			    <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_ASYNC_ADISC_DONE</span>:
			<span class="n">qla2x00_async_adisc_done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">fcport</span><span class="p">,</span>
			    <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_EVT_UEVENT</span>:
			<span class="n">qla2x00_uevent_emit</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">uevent</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLA_EVT_FLAG_FREE</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

		<span class="cm">/* For each work completed decrement vha ref count */</span>
		<span class="n">QLA_VHA_MARK_NOT_BUSY</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Relogins all the fcports of a vport</span>
<span class="cm"> * Context: dpc thread</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qla2x00_relogin</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span>       <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint16_t</span>        <span class="n">next_loopid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the port is not ONLINE then try to login</span>
<span class="cm">	 * to it if we haven&#39;t run out of retries.</span>
<span class="cm">	 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FCS_ONLINE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FABRIC_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">)</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
							<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
							<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
							<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
							<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">next_loopid</span> <span class="o">=</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">min_external_loopid</span><span class="p">;</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_find_new_loop_id</span><span class="p">(</span>
					    <span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Ran out of IDs to use */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">IS_ALOGIO_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
					<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">QLA_LOGIO_LOGIN_RETRIED</span><span class="p">;</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_post_async_login_work</span><span class="p">(</span>
					    <span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="cm">/* Attempt a retry. */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_fabric_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
					    <span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_loopid</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span>  <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">int</span> <span class="n">status2</span><span class="p">;</span>
						<span class="kt">uint8_t</span> <span class="n">opts</span><span class="p">;</span>

						<span class="n">opts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
						    <span class="n">FCF_FCP2_DEVICE</span><span class="p">)</span>
							<span class="n">opts</span> <span class="o">|=</span> <span class="n">BIT_1</span><span class="p">;</span>
							<span class="n">status2</span> <span class="o">=</span>
							    <span class="n">qla2x00_get_port_database</span><span class="p">(</span>
								<span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span>
								<span class="n">opts</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
							<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_local_device_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
								<span class="n">fcport</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">old_loop_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>

				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2003</span><span class="p">,</span>
				    <span class="s">&quot;Port login OK: logged in ID 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>

				<span class="n">qla2x00_update_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="cm">/* retry the login again */</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2007</span><span class="p">,</span>
				    <span class="s">&quot;Retrying %d login again loop_id 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">* qla2x00_do_dpc</span>
<span class="cm">*   This kernel thread is a task that is schedule by the interrupt handler</span>
<span class="cm">*   to perform the background processing for interrupts.</span>
<span class="cm">*</span>
<span class="cm">* Notes:</span>
<span class="cm">* This task always run in the context of a kernel thread.  It</span>
<span class="cm">* is kick-off by the driver&#39;s detect code and starts up</span>
<span class="cm">* up one per adapter. It immediately goes to sleep and waits for</span>
<span class="cm">* some fibre event.  When either the interrupt handler or</span>
<span class="cm">* the timer routine detects a event it will one of the task</span>
<span class="cm">* bits then wake us up.</span>
<span class="cm">**************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_do_dpc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span>
		    <span class="s">&quot;DPC handler sleeping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end_loop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4003</span><span class="p">,</span>
			    <span class="s">&quot;eeh_busy=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">end_loop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4001</span><span class="p">,</span>
		    <span class="s">&quot;DPC handler waking up, dpc_flags=0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">qla2x00_do_work</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ISP_UNRECOVERABLE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
					<span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
				<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4004</span><span class="p">,</span>
				    <span class="s">&quot;HW State: FAILED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">qla82xx_device_state_handler</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4005</span><span class="p">,</span>
				    <span class="s">&quot;FCoE context reset scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_fcoe_ctx_reset</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* FCoE-ctx reset failed.</span>
<span class="cm">						 * Escalate to chip-reset</span>
<span class="cm">						 */</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4006</span><span class="p">,</span>
				    <span class="s">&quot;FCoE context reset end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4007</span><span class="p">,</span>
			    <span class="s">&quot;ISP abort scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">abort_isp</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* failed. retry later */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4008</span><span class="p">,</span>
			    <span class="s">&quot;ISP abort end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla2x00_update_fcports</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SCR_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_send_change_request</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x121</span><span class="p">,</span>
				    <span class="s">&quot;Failed to enable receiving of RSCN &quot;</span>
				    <span class="s">&quot;requests: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">SCR_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_QUIESCE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4009</span><span class="p">,</span>
			    <span class="s">&quot;Quiescence mode scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla82xx_device_state_handler</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_QUIESCE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">quiesce_owner</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla2x00_perform_loop_resync</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

				<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">qla82xx_clear_qsnt_ready</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
				<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x400a</span><span class="p">,</span>
			    <span class="s">&quot;Quiescence mode end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))))</span> <span class="p">{</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x400b</span><span class="p">,</span>
			    <span class="s">&quot;Reset marker scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla2x00_rst_aen</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x400c</span><span class="p">,</span>
			    <span class="s">&quot;Reset marker end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Retry each device up to login retry count */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x400d</span><span class="p">,</span>
			    <span class="s">&quot;Relogin scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla2x00_relogin</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x400e</span><span class="p">,</span>
			    <span class="s">&quot;Relogin end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x400f</span><span class="p">,</span>
			    <span class="s">&quot;Loop resync scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>

				<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_loop_resync</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

				<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4010</span><span class="p">,</span>
			    <span class="s">&quot;Loop resync end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NPIV_CONFIG_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">NPIV_CONFIG_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">qla2xxx_flash_npiv_conf</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BEACON_BLINK_NEEDED</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">beacon_blink</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

		<span class="n">qla2x00_do_dpc_all_vps</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">end_loop:</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* End of while(1) */</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x4011</span><span class="p">,</span>
	    <span class="s">&quot;DPC handler exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that nobody tries to wake us up again.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Cleanup any residual CTX SRBs. */</span>
	<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2xxx_wake_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="p">)</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  qla2x00_rst_aen</span>
<span class="cm">*      Processes asynchronous reset.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha  = adapter block pointer.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_rst_aen</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Issue marker command only when we are going to start</span>
<span class="cm">			 * the I/O.</span>
<span class="cm">			 */</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">*   qla2x00_timer</span>
<span class="cm">*</span>
<span class="cm">* Description:</span>
<span class="cm">*   One second timer</span>
<span class="cm">*</span>
<span class="cm">* Context: Interrupt</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span>
<span class="nf">qla2x00_timer</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">cpu_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">start_dpc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">index</span><span class="p">;</span>
	<span class="n">srb_t</span>		<span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">uint16_t</span>        <span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">,</span>
		    <span class="s">&quot;EEH = %d, restarting timer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">);</span>
		<span class="n">qla2x00_restart_timer</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">WATCH_INTERVAL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware read to raise pending EEH errors during mailbox waits. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="cm">/* Make sure qla82xx_watchdog is run only for physical port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">&amp;&amp;</span> <span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_QUIESCE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
			<span class="n">start_dpc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qla82xx_watchdog</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Loop down handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6008</span><span class="p">,</span>
			    <span class="s">&quot;Loop down - aborting the queues before time expires.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">)</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DEAD</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Schedule an ISP abort to return any FCP2-device</span>
<span class="cm">			 * commands.</span>
<span class="cm">			 */</span>
			<span class="cm">/* NPIV - scan physical port only */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span>
				    <span class="n">cpu_flags</span><span class="p">);</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				    <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span>
				    <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">sfcp</span><span class="p">;</span>

					<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SRB_SCSI_CMD</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="n">sfcp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sfcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span>
								<span class="n">cpu_flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">start_dpc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if the loop has been down for 4 minutes, reinit adapter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_NO_CABLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6009</span><span class="p">,</span>
				    <span class="s">&quot;Loop down - aborting ISP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x600a</span><span class="p">,</span>
		    <span class="s">&quot;Loop down - seconds remaining %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Check if beacon LED needs to be blinked for physical host only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* There is no beacon_blink function for ISP82xx */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BEACON_BLINK_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">start_dpc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Process any deferred work. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">))</span>
		<span class="n">start_dpc</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Schedule the DPC routine if needed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">start_dpc</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">BEACON_BLINK_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">VP_DPC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x600b</span><span class="p">,</span>
		    <span class="s">&quot;isp_abort_needed=%d loop_resync_needed=%d &quot;</span>
		    <span class="s">&quot;fcport_update_needed=%d start_dpc=%d &quot;</span>
		    <span class="s">&quot;reset_marker_needed=%d&quot;</span><span class="p">,</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">start_dpc</span><span class="p">,</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">));</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x600c</span><span class="p">,</span>
		    <span class="s">&quot;beacon_blink_needed=%d isp_unrecoverable=%d &quot;</span>
		    <span class="s">&quot;fcoe_ctx_reset_needed=%d vp_dpc_needed=%d &quot;</span>
		    <span class="s">&quot;relogin_needed=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">BEACON_BLINK_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">VP_DPC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">),</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">));</span>
		<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla2x00_restart_timer</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">WATCH_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Firmware interface routines. */</span>

<span class="cp">#define FW_BLOBS	10</span>
<span class="cp">#define FW_ISP21XX	0</span>
<span class="cp">#define FW_ISP22XX	1</span>
<span class="cp">#define FW_ISP2300	2</span>
<span class="cp">#define FW_ISP2322	3</span>
<span class="cp">#define FW_ISP24XX	4</span>
<span class="cp">#define FW_ISP25XX	5</span>
<span class="cp">#define FW_ISP81XX	6</span>
<span class="cp">#define FW_ISP82XX	7</span>
<span class="cp">#define FW_ISP2031	8</span>
<span class="cp">#define FW_ISP8031	9</span>

<span class="cp">#define FW_FILE_ISP21XX	&quot;ql2100_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP22XX	&quot;ql2200_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP2300	&quot;ql2300_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP2322	&quot;ql2322_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP24XX	&quot;ql2400_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP25XX	&quot;ql2500_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP81XX	&quot;ql8100_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP82XX	&quot;ql8200_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP2031	&quot;ql2600_fw.bin&quot;</span>
<span class="cp">#define FW_FILE_ISP8031	&quot;ql8300_fw.bin&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">qla_fw_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fw_blob</span> <span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_BLOBS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP21XX</span><span class="p">,</span> <span class="p">.</span><span class="n">segs</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP22XX</span><span class="p">,</span> <span class="p">.</span><span class="n">segs</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP2300</span><span class="p">,</span> <span class="p">.</span><span class="n">segs</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x800</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP2322</span><span class="p">,</span> <span class="p">.</span><span class="n">segs</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x800</span><span class="p">,</span> <span class="mh">0x1c000</span><span class="p">,</span> <span class="mh">0x1e000</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP24XX</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP25XX</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP81XX</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP82XX</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP2031</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FW_FILE_ISP8031</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fw_blob</span> <span class="o">*</span>
<span class="nf">qla2x00_request_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP21XX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP22XX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2312</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6312</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP2300</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP2322</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP24XX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP25XX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP81XX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP82XX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP2031</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">FW_ISP8031</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_fw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">,</span>
		    <span class="s">&quot;Failed to load firmware image (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_fw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">blob</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_release_firmware</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_fw_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">FW_BLOBS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">qla_fw_blobs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_fw_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qla2xxx_pci_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">,</span>
	    <span class="s">&quot;PCI error detected, state %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pci_channel_io_normal</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_frozen</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* For ISP82XX complete any pending mailbox cmd */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">,</span> <span class="s">&quot;Pci channel io frozen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla82xx_clear_pending_mbx</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qla2x00_free_irqs</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="cm">/* Return back all IOs */</span>
		<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_perm_failure</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qla2xxx_pci_mmio_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">risc_paused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg24</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)){</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HCCR_RISC_PAUSE</span><span class="p">)</span>
			<span class="n">risc_paused</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSR_RISC_PAUSED</span><span class="p">)</span>
			<span class="n">risc_paused</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg24</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_PAUSED</span><span class="p">)</span>
			<span class="n">risc_paused</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">risc_paused</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9003</span><span class="p">,</span>
		    <span class="s">&quot;RISC paused -- mmio_enabled, Dumping firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">qla82xx_error_recovery</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">drv_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">other_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9006</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Abort all outstanding commands,</span>
<span class="cm">		 * so as to be requeued later */</span>
		<span class="n">qla2x00_abort_isp_cleanup</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">fn</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fn</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9007</span><span class="p">,</span>
		    <span class="s">&quot;Finding pci device at function = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
		<span class="n">other_pdev</span> <span class="o">=</span>
		    <span class="n">pci_get_domain_bus_and_slot</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		    <span class="n">fn</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">other_pdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other_pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9008</span><span class="p">,</span>
			    <span class="s">&quot;Found PCI func available and enable at 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">fn</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">other_pdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">other_pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset owner */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9009</span><span class="p">,</span>
		    <span class="s">&quot;This devfn is reset owner = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
		    <span class="n">QLA82XX_DEV_INITIALIZING</span><span class="p">);</span>

		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_IDC_VERSION</span><span class="p">,</span>
		    <span class="n">QLA82XX_IDC_VERSION</span><span class="p">);</span>

		<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x900a</span><span class="p">,</span>
		    <span class="s">&quot;drv_active = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>

		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="cm">/* Reset if device is not already reset</span>
<span class="cm">		 * drv_active would be 0 if a reset has already been done</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drv_active</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_start_firmware</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x900b</span><span class="p">,</span>
			    <span class="s">&quot;HW State: FAILED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla82xx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x900c</span><span class="p">,</span>
			    <span class="s">&quot;HW State: READY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_READY</span><span class="p">);</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_restart_isp</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="cm">/* Clear driver state register */</span>
			<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qla82xx_set_drv_active</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x900d</span><span class="p">,</span>
		    <span class="s">&quot;This devfn is not reset owner = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">QLA82XX_DEV_READY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_restart_isp</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla82xx_set_drv_active</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qla2xxx_pci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_ers_result_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9004</span><span class="p">,</span>
	    <span class="s">&quot;Slot Reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Workaround: qla2xxx driver which access hardware earlier</span>
<span class="cm">	 * needs error state to be pci_channel_io_online.</span>
<span class="cm">	 * Otherwise mailbox command timesout.</span>
<span class="cm">	 */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">=</span> <span class="n">pci_channel_io_normal</span><span class="p">;</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* pci_restore_state() clears the saved_state flag of the device</span>
<span class="cm">	 * save restored state which resets saved_state flag</span>
<span class="cm">	 */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_only</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span>
		    <span class="s">&quot;Can&#39;t re-enable PCI device after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_request_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">pci_config</span><span class="p">(</span><span class="n">base_vha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_error_recovery</span><span class="p">(</span><span class="n">base_vha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">&amp;&amp;</span> <span class="n">retries</span><span class="o">--</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">abort_isp</span><span class="p">(</span><span class="n">base_vha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>


<span class="nl">exit_slot_reset:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x900e</span><span class="p">,</span>
	    <span class="s">&quot;slot_reset return %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_aer</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x900f</span><span class="p">,</span>
	    <span class="s">&quot;pci_resume.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x9002</span><span class="p">,</span>
		    <span class="s">&quot;The device failed to resume I/O from slot/link_reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">qla2xxx_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">qla2xxx_pci_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmio_enabled</span> <span class="o">=</span> <span class="n">qla2xxx_pci_mmio_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">qla2xxx_pci_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qla2xxx_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">qla2xxx_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2100</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2200</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2300</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2312</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2322</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP6312</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP6322</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2422</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2432</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8432</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP5422</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP5432</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2532</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP2031</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8001</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8021</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">qla2xxx_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">qla2xxx_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">qla2xxx_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">qla2x00_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">qla2x00_remove_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">qla2x00_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">qla2xxx_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">apidev_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_module_init - Module initialization.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">qla2x00_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate cache for SRBs. */</span>
	<span class="n">srb_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qla2xxx_srbs&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">srb_t</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate SRB cache...Failing load!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize target kmem_cache and mem_pools */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlt_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If initiator mode is explictly disabled by qlt_init(),</span>
<span class="cm">		 * prevent scsi_transport_fc.c:fc_scsi_scan_rport() from</span>
<span class="cm">		 * performing scsi_scan_target() during LOOP UP event.</span>
<span class="cm">		 */</span>
		<span class="n">qla2xxx_transport_functions</span><span class="p">.</span><span class="n">disable_target_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qla2xxx_transport_vport_functions</span><span class="p">.</span><span class="n">disable_target_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Derive version string. */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">qla2x00_version_str</span><span class="p">,</span> <span class="n">QLA2XXX_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xextended_error_logging</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">qla2x00_version_str</span><span class="p">,</span> <span class="s">&quot;-debug&quot;</span><span class="p">);</span>

	<span class="n">qla2xxx_transport_template</span> <span class="o">=</span>
	    <span class="n">fc_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla2xxx_transport_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2xxx_transport_template</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span>
		    <span class="s">&quot;fc_attach_transport failed...Failing load!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qlt_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">apidev_major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QLA2XXX_APIDEV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apidev_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apidev_major</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span>
		    <span class="s">&quot;Unable to register char device %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QLA2XXX_APIDEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla2xxx_transport_vport_template</span> <span class="o">=</span>
	    <span class="n">fc_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla2xxx_transport_vport_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2xxx_transport_vport_template</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
		<span class="n">qlt_exit</span><span class="p">();</span>
		<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">qla2xxx_transport_template</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span>
		    <span class="s">&quot;fc_attach_transport vport failed...Failing load!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span>
	    <span class="s">&quot;QLogic Fibre Channel HBA Driver: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">qla2x00_version_str</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla2xxx_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
		<span class="n">qlt_exit</span><span class="p">();</span>
		<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">qla2xxx_transport_template</span><span class="p">);</span>
		<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">qla2xxx_transport_vport_template</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span>
		    <span class="s">&quot;pci_register_driver failed...ret=%d Failing load!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_module_exit - Module cleanup.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">qla2x00_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">apidev_major</span><span class="p">,</span> <span class="n">QLA2XXX_APIDEV</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla2xxx_pci_driver</span><span class="p">);</span>
	<span class="n">qla2x00_release_firmware</span><span class="p">();</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
	<span class="n">qlt_exit</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx_cachep</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ctx_cachep</span><span class="p">);</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">qla2xxx_transport_template</span><span class="p">);</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">qla2xxx_transport_vport_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qla2x00_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qla2x00_module_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;QLogic Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QLogic Fibre Channel HBA Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">QLA2XXX_VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_ISP21XX</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_ISP22XX</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_ISP2300</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_ISP2322</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_ISP24XX</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_ISP25XX</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
