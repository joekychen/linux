<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_iocb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_iocb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qla25xx_set_que</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">**</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * qla2x00_get_cmd_direction() - Determine control_flag data direction.</span>
<span class="cm"> * @cmd: SCSI command</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the proper CF_* direction based on CDB.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span>
<span class="nf">qla2x00_get_cmd_direction</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">cflags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>

	<span class="n">cflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set transfer direction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cflags</span> <span class="o">=</span> <span class="n">CF_WRITE</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">output_bytes</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cflags</span> <span class="o">=</span> <span class="n">CF_READ</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">input_bytes</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_calc_iocbs_32() - Determine number of Command Type 2 and</span>
<span class="cm"> * Continuation Type 0 IOCBs to allocate.</span>
<span class="cm"> *</span>
<span class="cm"> * @dsds: number of data segment decriptors needed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of IOCB entries needed to store @dsds.</span>
<span class="cm"> */</span>
<span class="kt">uint16_t</span>
<span class="nf">qla2x00_calc_iocbs_32</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">iocbs</span><span class="p">;</span>

	<span class="n">iocbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocbs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dsds</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">iocbs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">iocbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_calc_iocbs_64() - Determine number of Command Type 3 and</span>
<span class="cm"> * Continuation Type 1 IOCBs to allocate.</span>
<span class="cm"> *</span>
<span class="cm"> * @dsds: number of data segment decriptors needed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of IOCB entries needed to store @dsds.</span>
<span class="cm"> */</span>
<span class="kt">uint16_t</span>
<span class="nf">qla2x00_calc_iocbs_64</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">iocbs</span><span class="p">;</span>

	<span class="n">iocbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocbs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dsds</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">iocbs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">iocbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_cont_type0_iocb() - Initialize a Continuation Type 0 IOCB.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the Continuation Type 0 IOCB packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">cont_entry_t</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_cont_type0_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cont_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cont_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cont_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>

	<span class="cm">/* Load packet defaults. */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">CONTINUE_TYPE</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cont_pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_cont_type1_iocb() - Initialize a Continuation Type 1 IOCB.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the continuation type 1 IOCB packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">cont_a64_entry_t</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_cont_type1_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cont_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>

	<span class="cm">/* Load packet defaults. */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">CONTINUE_A64_TYPE</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cont_pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla24xx_configure_prot_mode</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">fw_prot_opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="kt">uint8_t</span>	<span class="n">guard</span> <span class="o">=</span> <span class="n">scsi_host_get_guard</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* We only support T10 DIF right now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">guard</span> <span class="o">!=</span> <span class="n">SHOST_DIX_GUARD_CRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3007</span><span class="p">,</span>
		    <span class="s">&quot;Unsupported guard: %d for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">guard</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We always use DIFF Bundling for best performance */</span>
	<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Translate SCSI opcode to a protection opcode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_READ_STRIP</span>:
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_REMOVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_INSERT</span>:
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_INSERT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_READ_INSERT</span>:
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_INSERT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_STRIP</span>:
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_REMOVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_READ_PASS</span>:
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_PASS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_PASS</span>:
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_PASS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* Normal Request */</span>
		<span class="o">*</span><span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_MODE_DIF_PASS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_build_scsi_iocbs_32() - Build IOCB command utilizing 32bit</span>
<span class="cm"> * capable IOCB types.</span>
<span class="cm"> *</span>
<span class="cm"> * @sp: SRB command to process</span>
<span class="cm"> * @cmd_pkt: Command type 2 IOCB</span>
<span class="cm"> * @tot_dsds: Total number of segments to transfer</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qla2x00_build_scsi_iocbs_32</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">cmd_entry_t</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">avail_dsds</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="o">*</span><span class="n">cur_dsd</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Update entry type to indicate Command Type 2 IOCB */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">COMMAND_TYPE</span><span class="p">);</span>

	<span class="cm">/* No data transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qla2x00_get_cmd_direction</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>

	<span class="cm">/* Three DSDs are available in the Command Type 2 IOCB */</span>
	<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

	<span class="cm">/* Load data segments */</span>
	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cont_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Seven DSDs are available in the Continuation</span>
<span class="cm">			 * Type 0 IOCB.</span>
<span class="cm">			 */</span>
			<span class="n">cont_pkt</span> <span class="o">=</span> <span class="n">qla2x00_prep_cont_type0_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_build_scsi_iocbs_64() - Build IOCB command utilizing 64bit</span>
<span class="cm"> * capable IOCB types.</span>
<span class="cm"> *</span>
<span class="cm"> * @sp: SRB command to process</span>
<span class="cm"> * @cmd_pkt: Command type 3 IOCB</span>
<span class="cm"> * @tot_dsds: Total number of segments to transfer</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qla2x00_build_scsi_iocbs_64</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">cmd_entry_t</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">avail_dsds</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="o">*</span><span class="n">cur_dsd</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Update entry type to indicate Command Type 3 IOCB */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">COMMAND_A64_TYPE</span><span class="p">);</span>

	<span class="cm">/* No data transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qla2x00_get_cmd_direction</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>

	<span class="cm">/* Two DSDs are available in the Command Type 3 IOCB */</span>
	<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

	<span class="cm">/* Load data segments */</span>
	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span>	<span class="n">sle_dma</span><span class="p">;</span>
		<span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Five DSDs are available in the Continuation</span>
<span class="cm">			 * Type 1 IOCB.</span>
<span class="cm">			 */</span>
			<span class="n">cont_pkt</span> <span class="o">=</span> <span class="n">qla2x00_prep_cont_type1_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_start_scsi() - Send a SCSI command to the ISP</span>
<span class="cm"> * @sp: command to send to the ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if a failure occurred, else zero.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_start_scsi</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">,</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="o">*</span><span class="n">clr_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>        <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="n">cmd_entry_t</span>	<span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">req_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">tot_dsds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Setup device pointers. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/* So we know we haven&#39;t pci_map&#39;ed anything yet */</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">QLA_FUNCTION_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Acquire ring specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check for room in outstanding command list. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="cm">/* Map the sg table so we have an accurate count of sg entries needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		    <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nseg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="cm">/* Calculate the number of request entries needed. */</span>
	<span class="n">req_cnt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">calc_req_entries</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_WORD_RELAXED</span><span class="p">(</span><span class="n">ISP_REQ_Q_OUT</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="cm">/* If still no head room then bail out */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Build command packet */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="cm">/* Zero out remaining portion of packet. */</span>
	<span class="n">clr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd_pkt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">clr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>

	<span class="cm">/* Set target ID and LUN number*/</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="cm">/* Update tagged queuing modifier */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
			    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_HEAD_TAG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
			    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_ORDERED_TAG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
			    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_SIMPLE_TAG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Load SCSI command packet. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">scsi_cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* Build IOCB segments */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">build_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">cmd_pkt</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">);</span>

	<span class="cm">/* Set total data segment count. */</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_DMA_VALID</span><span class="p">;</span>

	<span class="cm">/* Set chip new ring index. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_REQ_Q_IN</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
	<span class="n">RD_REG_WORD_RELAXED</span><span class="p">(</span><span class="n">ISP_REQ_Q_IN</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>	<span class="cm">/* PCI Posting. */</span>

	<span class="cm">/* Manage unprocessed RIO/ZIO commands in response queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">)</span>
		<span class="n">qla2x00_process_response_queue</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">QLA_SUCCESS</span><span class="p">);</span>

<span class="nl">queuing_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_dsds</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">QLA_FUNCTION_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_start_iocbs() - Execute the IOCB command</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_start_iocbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ISP_QUE_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla82xx_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Adjust ring index. */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Set chip new ring index. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
			<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
			<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_in</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_REQ_Q_IN</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">),</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
			<span class="n">RD_REG_WORD_RELAXED</span><span class="p">(</span><span class="n">ISP_REQ_Q_IN</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_marker() - Send a marker IOCB to the firmware.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @loop_id: loop ID</span>
<span class="cm"> * @lun: LUN</span>
<span class="cm"> * @type: marker modifier</span>
<span class="cm"> *</span>
<span class="cm"> * Can be called from both normal and interrupt context.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if a failure occurred, else zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__qla2x00_marker</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span>
			<span class="kt">uint16_t</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mrk_entry_t</span> <span class="o">*</span><span class="n">mrk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mrk_entry_24xx</span> <span class="o">*</span><span class="n">mrk24</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mrk24</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mrk</span> <span class="o">=</span> <span class="p">(</span><span class="n">mrk_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mrk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x3026</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate Marker IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_FUNCTION_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mrk</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MARKER_TYPE</span><span class="p">;</span>
	<span class="n">mrk</span><span class="o">-&gt;</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mrk24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mrk_entry_24xx</span> <span class="o">*</span><span class="p">)</span> <span class="n">mrk</span><span class="p">;</span>
			<span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">host_to_fcp_swap</span><span class="p">(</span><span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
			<span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
			<span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mrk24</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mrk</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>
			<span class="n">mrk</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">lun</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">QLA_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_marker</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">lun</span><span class="p">,</span>
		<span class="kt">uint8_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_issue_marker</span>
<span class="cm"> *</span>
<span class="cm"> * Issue marker</span>
<span class="cm"> * Caller CAN have hardware lock held as specified by ha_locked parameter.</span>
<span class="cm"> * Might release it, then reaquire.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qla2x00_issue_marker</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ha_locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_calc_iocbs() - Determine number of Command Type 3 and</span>
<span class="cm"> * Continuation Type 1 IOCBs to allocate.</span>
<span class="cm"> *</span>
<span class="cm"> * @dsds: number of data segment decriptors needed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of IOCB entries needed to store @dsds.</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">uint16_t</span>
<span class="nf">qla24xx_calc_iocbs</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">iocbs</span><span class="p">;</span>

	<span class="n">iocbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocbs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dsds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">iocbs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">iocbs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla24xx_build_scsi_type_6_iocbs</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_type_6</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">cur_dsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">scatterlist</span> <span class="o">*</span><span class="n">cur_seg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dsd_seg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">next_dsd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">avail_dsds</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">first_iocb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsd_list_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsd_dma</span> <span class="o">*</span><span class="n">dsd_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct6_dsd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Update entry type to indicate Command Type 3 IOCB */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
		<span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">COMMAND_TYPE_6</span><span class="p">);</span>

	<span class="cm">/* No data transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Set transfer direction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_WRITE_DATA</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">output_bytes</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_READ_DATA</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">input_bytes</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cur_seg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">GET_CMD_CTX_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tot_dsds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">avail_dsds</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_dsds</span> <span class="o">&gt;</span> <span class="n">QLA_DSDS_PER_IOCB</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">QLA_DSDS_PER_IOCB</span> <span class="o">:</span> <span class="n">tot_dsds</span><span class="p">;</span>
		<span class="n">tot_dsds</span> <span class="o">-=</span> <span class="n">avail_dsds</span><span class="p">;</span>
		<span class="n">dsd_list_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">QLA_DSD_SIZE</span><span class="p">;</span>

		<span class="n">dsd_ptr</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_list</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">dsd_dma</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">next_dsd</span> <span class="o">=</span> <span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_avail</span><span class="o">--</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dsd_use_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_inuse</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first_iocb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first_iocb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dsd_seg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_data_dseg_address</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dsd_seg</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">dsd_seg</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_data_dseg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dsd_list_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dsd_list_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">next_dsd</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">avail_dsds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span>	<span class="n">sle_dma</span><span class="p">;</span>

			<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">cur_seg</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">cur_seg</span><span class="p">));</span>
			<span class="n">cur_seg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">cur_seg</span><span class="p">);</span>
			<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Null termination */</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">CF_DATA_SEG_DESCR_ENABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_calc_dsd_lists() - Determine number of DSD list required</span>
<span class="cm"> * for Command Type 6.</span>
<span class="cm"> *</span>
<span class="cm"> * @dsds: number of data segment decriptors needed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of dsd list needed to store @dsds.</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">uint16_t</span>
<span class="nf">qla24xx_calc_dsd_lists</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">dsd_lists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsd_lists</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsds</span><span class="o">/</span><span class="n">QLA_DSDS_PER_IOCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">%</span> <span class="n">QLA_DSDS_PER_IOCB</span><span class="p">)</span>
		<span class="n">dsd_lists</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dsd_lists</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * qla24xx_build_scsi_iocbs() - Build IOCB command utilizing Command Type 7</span>
<span class="cm"> * IOCB types.</span>
<span class="cm"> *</span>
<span class="cm"> * @sp: SRB command to process</span>
<span class="cm"> * @cmd_pkt: Command type 3 IOCB</span>
<span class="cm"> * @tot_dsds: Total number of segments to transfer</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla24xx_build_scsi_iocbs</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_type_7</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">avail_dsds</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="o">*</span><span class="n">cur_dsd</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Update entry type to indicate Command Type 3 IOCB */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">COMMAND_TYPE_7</span><span class="p">);</span>

	<span class="cm">/* No data transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* Set transfer direction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task_mgmt_flags</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">TMF_WRITE_DATA</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">output_bytes</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task_mgmt_flags</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">TMF_READ_DATA</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">input_bytes</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* One DSD is available in the Command Type 3 IOCB */</span>
	<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

	<span class="cm">/* Load data segments */</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span>	<span class="n">sle_dma</span><span class="p">;</span>
		<span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Five DSDs are available in the Continuation</span>
<span class="cm">			 * Type 1 IOCB.</span>
<span class="cm">			 */</span>
			<span class="n">cont_pkt</span> <span class="o">=</span> <span class="n">qla2x00_prep_cont_type1_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fw_dif_context</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ref_tag</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">app_tag</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Validation/Replacement Mask*/</span>
	<span class="kt">uint8_t</span> <span class="n">app_tag_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Validation/Replacement Mask*/</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_set_t10dif_tags_from_cmd - Extract Ref and App tags from SCSI command</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla24xx_set_t10dif_tags</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_dif_context</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">protcnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_get_prot_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * No check for ql2xenablehba_err_chk, as it would be an</span>
<span class="cm">		 * I/O error if hba tag generation is not done.</span>
<span class="cm">		 */</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span>
		    <span class="p">(</span><span class="mh">0xffffffff</span> <span class="o">&amp;</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">cmd</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_hba_err_chk_enabled</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For TYPE 2 protection: 16 bit GUARD + 32 bit REF tag has to</span>
<span class="cm">	 * match LBA in CDB + N</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE2</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span>
		    <span class="p">(</span><span class="mh">0xffffffff</span> <span class="o">&amp;</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">cmd</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_hba_err_chk_enabled</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* enable ALL bytes of the ref tag */</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* For Type 3 protection: 16 bit GUARD only */</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE3</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
								<span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For TYpe 1 protection: 16 bit GUARD tag, 32 bit REF tag, and</span>
<span class="cm">	 * 16 bit app tag.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE1</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span>
		    <span class="p">(</span><span class="mh">0xffffffff</span> <span class="o">&amp;</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">cmd</span><span class="p">)));</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_hba_err_chk_enabled</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* enable ALL bytes of the ref tag */</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3009</span><span class="p">,</span>
	    <span class="s">&quot;Setting protection Tags: (BIG) ref tag = 0x%x, app tag = 0x%x, &quot;</span>
	    <span class="s">&quot;prot SG count %d, cmd lba 0x%x, prot_type=%u cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">ref_tag</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">app_tag</span><span class="p">,</span> <span class="n">protcnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">scsi_get_prot_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">qla2_sgx</span> <span class="p">{</span>
	<span class="n">dma_addr_t</span>		<span class="n">dma_addr</span><span class="p">;</span>	<span class="cm">/* OUT */</span>
	<span class="kt">uint32_t</span>		<span class="n">dma_len</span><span class="p">;</span>	<span class="cm">/* OUT */</span>

	<span class="kt">uint32_t</span>		<span class="n">tot_bytes</span><span class="p">;</span>	<span class="cm">/* IN */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">cur_sg</span><span class="p">;</span>	<span class="cm">/* IN */</span>

	<span class="cm">/* for book keeping, bzero on initial invocation */</span>
	<span class="kt">uint32_t</span>		<span class="n">bytes_consumed</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">num_bytes</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">tot_partial</span><span class="p">;</span>

	<span class="cm">/* for debugging */</span>
	<span class="kt">uint32_t</span>		<span class="n">num_sg</span><span class="p">;</span>
	<span class="n">srb_t</span>			<span class="o">*</span><span class="n">sp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_get_one_block_sg</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">blk_sz</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla2_sgx</span> <span class="o">*</span><span class="n">sgx</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">partial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cumulative_partial</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">sg_dma_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sgx</span><span class="o">-&gt;</span><span class="n">num_bytes</span> <span class="o">==</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">tot_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">;</span>
	<span class="n">cumulative_partial</span> <span class="o">=</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">tot_partial</span><span class="p">;</span>

	<span class="n">sg_dma_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

	<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sg_dma_addr</span> <span class="o">+</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">bytes_consumed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cumulative_partial</span> <span class="o">+</span> <span class="p">(</span><span class="n">sg_len</span> <span class="o">-</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">bytes_consumed</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">blk_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk_sz</span> <span class="o">-</span> <span class="n">cumulative_partial</span><span class="p">);</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">tot_partial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">num_bytes</span> <span class="o">+=</span> <span class="n">blk_sz</span><span class="p">;</span>
		<span class="o">*</span><span class="n">partial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">sg_len</span> <span class="o">-</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">bytes_consumed</span><span class="p">;</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">tot_partial</span> <span class="o">+=</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">partial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">bytes_consumed</span> <span class="o">+=</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_len</span> <span class="o">==</span> <span class="n">sgx</span><span class="o">-&gt;</span><span class="n">bytes_consumed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">cur_sg</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
		<span class="n">sgx</span><span class="o">-&gt;</span><span class="n">bytes_consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_walk_and_build_sglist_no_difb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dsd</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">next_dsd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsd_list_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsd_dma</span> <span class="o">*</span><span class="n">dsd_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_prot</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">cur_dsd</span> <span class="o">=</span> <span class="n">dsd</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">used_dsds</span> <span class="o">=</span> <span class="n">tot_dsds</span><span class="p">;</span>

	<span class="kt">uint32_t</span>	<span class="n">prot_int</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">partial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla2_sgx</span> <span class="n">sgx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">sle_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">sle_dma_len</span><span class="p">,</span> <span class="n">tot_prot_dma_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">prot_int</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2_sgx</span><span class="p">));</span>
	<span class="n">sgx</span><span class="p">.</span><span class="n">tot_bytes</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">sgx</span><span class="p">.</span><span class="n">cur_sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">sgx</span><span class="p">.</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>

	<span class="n">sg_prot</span> <span class="o">=</span> <span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qla24xx_get_one_block_sg</span><span class="p">(</span><span class="n">prot_int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">partial</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sgx</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">sle_dma_len</span> <span class="o">=</span> <span class="n">sgx</span><span class="p">.</span><span class="n">dma_len</span><span class="p">;</span>
<span class="nl">alloc_and_fill:</span>
		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="p">(</span><span class="n">used_dsds</span> <span class="o">&gt;</span> <span class="n">QLA_DSDS_PER_IOCB</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">QLA_DSDS_PER_IOCB</span> <span class="o">:</span> <span class="n">used_dsds</span><span class="p">;</span>
			<span class="n">dsd_list_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">used_dsds</span> <span class="o">-=</span> <span class="n">avail_dsds</span><span class="p">;</span>

			<span class="cm">/* allocate tracking DS */</span>
			<span class="n">dsd_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsd_dma</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsd_ptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* allocate new list */</span>
			<span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span> <span class="o">=</span> <span class="n">next_dsd</span> <span class="o">=</span>
			    <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_dsd</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Need to cleanup only this dsd_ptr, rest</span>
<span class="cm">				 * will be done by sp_free_dma()</span>
<span class="cm">				 */</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">crc_context</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">);</span>

			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_CRC_CTX_DSD_VALID</span><span class="p">;</span>

			<span class="cm">/* add new list to cmd iocb or last list */</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsd_list_len</span><span class="p">;</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">next_dsd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sle_dma_len</span><span class="p">);</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">partial</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Got a full protection interval */</span>
			<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_prot</span><span class="p">)</span> <span class="o">+</span> <span class="n">tot_prot_dma_len</span><span class="p">;</span>
			<span class="n">sle_dma_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">tot_prot_dma_len</span> <span class="o">+=</span> <span class="n">sle_dma_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tot_prot_dma_len</span> <span class="o">==</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_prot</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tot_prot_dma_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sg_prot</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg_prot</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">partial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* So as to not re-enter this block */</span>
			<span class="k">goto</span> <span class="n">alloc_and_fill</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Null termination */</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_walk_and_build_sglist</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dsd</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">next_dsd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsd_list_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsd_dma</span> <span class="o">*</span><span class="n">dsd_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">cur_dsd</span> <span class="o">=</span> <span class="n">dsd</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">used_dsds</span> <span class="o">=</span> <span class="n">tot_dsds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="kt">uint8_t</span>		<span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span>	<span class="n">sle_dma</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="p">(</span><span class="n">used_dsds</span> <span class="o">&gt;</span> <span class="n">QLA_DSDS_PER_IOCB</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">QLA_DSDS_PER_IOCB</span> <span class="o">:</span> <span class="n">used_dsds</span><span class="p">;</span>
			<span class="n">dsd_list_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">used_dsds</span> <span class="o">-=</span> <span class="n">avail_dsds</span><span class="p">;</span>

			<span class="cm">/* allocate tracking DS */</span>
			<span class="n">dsd_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsd_dma</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsd_ptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* allocate new list */</span>
			<span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span> <span class="o">=</span> <span class="n">next_dsd</span> <span class="o">=</span>
			    <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_dsd</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Need to cleanup only this dsd_ptr, rest</span>
<span class="cm">				 * will be done by sp_free_dma()</span>
<span class="cm">				 */</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">crc_context</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">);</span>

			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_CRC_CTX_DSD_VALID</span><span class="p">;</span>

			<span class="cm">/* add new list to cmd iocb or last list */</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsd_list_len</span><span class="p">;</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">next_dsd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x300a</span><span class="p">,</span>
		    <span class="s">&quot;sg entry %d - addr=0x%x 0x%x, &quot;</span> <span class="s">&quot;len=%d for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">i</span><span class="p">,</span> <span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">),</span> <span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">),</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_PASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x300b</span><span class="p">,</span>
			    <span class="s">&quot;User data buffer=%p for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Null termination */</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_walk_and_build_prot_sglist</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
							<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dsd</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">next_dsd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsd_list_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsd_dma</span> <span class="o">*</span><span class="n">dsd_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">cur_dsd</span> <span class="o">=</span> <span class="n">dsd</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">used_dsds</span> <span class="o">=</span> <span class="n">tot_dsds</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">uint8_t</span>		<span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">scsi_for_each_prot_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span>	<span class="n">sle_dma</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="p">(</span><span class="n">used_dsds</span> <span class="o">&gt;</span> <span class="n">QLA_DSDS_PER_IOCB</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">QLA_DSDS_PER_IOCB</span> <span class="o">:</span> <span class="n">used_dsds</span><span class="p">;</span>
			<span class="n">dsd_list_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">used_dsds</span> <span class="o">-=</span> <span class="n">avail_dsds</span><span class="p">;</span>

			<span class="cm">/* allocate tracking DS */</span>
			<span class="n">dsd_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsd_dma</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsd_ptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* allocate new list */</span>
			<span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span> <span class="o">=</span> <span class="n">next_dsd</span> <span class="o">=</span>
			    <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_dsd</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Need to cleanup only this dsd_ptr, rest</span>
<span class="cm">				 * will be done by sp_free_dma()</span>
<span class="cm">				 */</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">crc_context</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">);</span>

			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_CRC_CTX_DSD_VALID</span><span class="p">;</span>

			<span class="cm">/* add new list to cmd iocb or last list */</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">));</span>
			<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsd_list_len</span><span class="p">;</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">next_dsd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_PASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3027</span><span class="p">,</span>
			    <span class="s">&quot;%s(): %p, sg_entry %d - &quot;</span>
			    <span class="s">&quot;addr=0x%x0x%x, len=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">cur_dsd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			    <span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">),</span> <span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">),</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_PASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3028</span><span class="p">,</span>
			    <span class="s">&quot;%s(): Protection Data buffer = %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Null termination */</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_build_scsi_crc_2_iocbs() - Build IOCB command utilizing Command</span>
<span class="cm"> *							Type 6 IOCB types.</span>
<span class="cm"> *</span>
<span class="cm"> * @sp: SRB command to process</span>
<span class="cm"> * @cmd_pkt: Command type 3 IOCB</span>
<span class="cm"> * @tot_dsds: Total number of segments to transfer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla24xx_build_scsi_crc_2_iocbs</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_type_crc_2</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">tot_prot_dsds</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">fw_prot_opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span>		<span class="o">*</span><span class="n">cur_dsd</span><span class="p">,</span> <span class="o">*</span><span class="n">fcp_dl</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span>		<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">cur_seg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">sgc</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">data_bytes</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">dif_bytes</span><span class="p">;</span>
	<span class="kt">uint8_t</span>			<span class="n">bundling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">blk_size</span><span class="p">;</span>
	<span class="kt">uint8_t</span>			<span class="o">*</span><span class="n">clr_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crc_context</span>	<span class="o">*</span><span class="n">crc_ctx_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span>	<span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">uint8_t</span>			<span class="n">additional_fcpcdb_len</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">fcp_cmnd_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcp_cmnd</span>		<span class="o">*</span><span class="n">fcp_cmnd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">crc_ctx_dma</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">sgc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Update entry type to indicate Command Type CRC_2 IOCB */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">))</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">COMMAND_TYPE_CRC_2</span><span class="p">);</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* No data transfer */</span>
	<span class="n">data_bytes</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_bytes</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="cm">/* Set transfer direction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_WRITE_DATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_READ_DATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_READ_INSERT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_STRIP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_READ_STRIP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_INSERT</span><span class="p">))</span>
		<span class="n">bundling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate CRC context from global pool */</span>
	<span class="n">crc_ctx_pkt</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span> <span class="o">=</span>
	    <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc_ctx_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crc_ctx_pkt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">crc_queuing_error</span><span class="p">;</span>

	<span class="cm">/* Zero out CTX area. */</span>
	<span class="n">clr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">crc_ctx_pkt</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">clr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">crc_ctx_pkt</span><span class="p">));</span>

	<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">crc_ctx_dma</span> <span class="o">=</span> <span class="n">crc_ctx_dma</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_CRC_CTX_DMA_VALID</span><span class="p">;</span>

	<span class="cm">/* Set handle */</span>
	<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">);</span>

	<span class="n">qla24xx_set_t10dif_tags</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_dif_context</span> <span class="o">*</span><span class="p">)</span>
	    <span class="o">&amp;</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">ref_tag</span><span class="p">,</span> <span class="n">tot_prot_dsds</span><span class="p">);</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">crc_context_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">crc_ctx_dma</span><span class="p">));</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">crc_context_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">crc_ctx_dma</span><span class="p">));</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">crc_context_len</span> <span class="o">=</span> <span class="n">CRC_CONTEXT_LEN_FW</span><span class="p">;</span>

	<span class="cm">/* Determine SCSI command length -- align to 4 byte boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">additional_fcpcdb_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SCSI cmd &gt; 16 bytes must be multiple of 4 */</span>
			<span class="k">goto</span> <span class="n">crc_queuing_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fcp_cmnd_len</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">additional_fcpcdb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fcp_cmnd_len</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcp_cmnd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="p">;</span>

	<span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">additional_cdb_len</span> <span class="o">=</span> <span class="n">additional_fcpcdb_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">additional_cdb_len</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">additional_cdb_len</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dseg_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fcp_cmnd_len</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dseg_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
	    <span class="n">LSD</span><span class="p">(</span><span class="n">crc_ctx_dma</span> <span class="o">+</span> <span class="n">CRC_CONTEXT_FCPCMND_OFF</span><span class="p">));</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dseg_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
	    <span class="n">MSD</span><span class="p">(</span><span class="n">crc_ctx_dma</span> <span class="o">+</span> <span class="n">CRC_CONTEXT_FCPCMND_OFF</span><span class="p">));</span>
	<span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_management</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update tagged queuing modifier if using command tag queuing</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
		    <span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">=</span> <span class="n">TSK_HEAD_OF_QUEUE</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
		    <span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">=</span> <span class="n">TSK_ORDERED</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		    <span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_rsp_dseg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Let response come in status iocb */</span>

	<span class="cm">/* Compute dif len and adjust data len to incude protection */</span>
	<span class="n">dif_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blk_size</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="n">dif_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_bytes</span> <span class="o">/</span> <span class="n">blk_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">)))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_READ_INSERT</span>:
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_STRIP</span>:
	    <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">data_bytes</span><span class="p">;</span>
	    <span class="n">data_bytes</span> <span class="o">+=</span> <span class="n">dif_bytes</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_PROT_READ_STRIP</span>:
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_INSERT</span>:
	<span class="k">case</span> <span class="n">SCSI_PROT_READ_PASS</span>:
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_PASS</span>:
	    <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">data_bytes</span> <span class="o">+</span> <span class="n">dif_bytes</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	    <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_hba_err_chk_enabled</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* Disable Guard tag checking */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bundling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nobundling</span><span class="p">.</span><span class="n">data_address</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Configure Bundling if we need to fetch interlaving</span>
<span class="cm">		 * protection PCI accesses</span>
<span class="cm">		 */</span>
		<span class="n">fw_prot_opts</span> <span class="o">|=</span> <span class="n">PO_ENABLE_DIF_BUNDLING</span><span class="p">;</span>
		<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bundling</span><span class="p">.</span><span class="n">dif_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dif_bytes</span><span class="p">);</span>
		<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bundling</span><span class="p">.</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span> <span class="o">-</span>
							<span class="n">tot_prot_dsds</span><span class="p">);</span>
		<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bundling</span><span class="p">.</span><span class="n">data_address</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finish the common fields of CRC pkt */</span>
	<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blk_size</span><span class="p">);</span>
	<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">prot_opts</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fw_prot_opts</span><span class="p">);</span>
	<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">);</span>
	<span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">guard_seed</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Fibre channel byte count */</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="n">fcp_dl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">cdb</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span>
	    <span class="n">additional_fcpcdb_len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fcp_dl</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_bytes</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Walks data segments */</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_DATA_SEG_DESCR_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bundling</span> <span class="o">&amp;&amp;</span> <span class="n">tot_prot_dsds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_walk_and_build_sglist_no_difb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span>
		    <span class="n">cur_dsd</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">crc_queuing_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_walk_and_build_sglist</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">cur_dsd</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">tot_dsds</span> <span class="o">-</span> <span class="n">tot_prot_dsds</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">crc_queuing_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bundling</span> <span class="o">&amp;&amp;</span> <span class="n">tot_prot_dsds</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Walks dif segments */</span>
		<span class="n">cur_seg</span> <span class="o">=</span> <span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span>
			<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_DIF_SEG_DESCR_ENABLE</span><span class="p">);</span>
		<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">crc_ctx_pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bundling</span><span class="p">.</span><span class="n">dif_address</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_walk_and_build_prot_sglist</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">cur_dsd</span><span class="p">,</span>
		    <span class="n">tot_prot_dsds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">crc_queuing_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">crc_queuing_error:</span>
	<span class="cm">/* Cleanup will be performed by the caller */</span>

	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_start_scsi() - Send a SCSI command to the ISP</span>
<span class="cm"> * @sp: command to send to the ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if a failure occurred, else zero.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_start_scsi</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">,</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="o">*</span><span class="n">clr_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>        <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_type_7</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">req_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">tot_dsds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Setup device pointers. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qla25xx_set_que</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* So we know we haven&#39;t pci_map&#39;ed anything yet */</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Acquire ring specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check for room in outstanding command list. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Map the sg table so we have an accurate count of sg entries needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		    <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nseg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="n">req_cnt</span> <span class="o">=</span> <span class="n">qla24xx_calc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Build command packet. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_type_7</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="cm">/* Zero out remaining portion of packet. */</span>
	<span class="cm">/*    tagged queuing modifier -- default is TSK_SIMPLE (0). */</span>
	<span class="n">clr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd_pkt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">clr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>

	<span class="cm">/* Set NPORT-ID and LUN number*/</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">host_to_fcp_swap</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

	<span class="cm">/* Update tagged queuing modifier -- default is TSK_SIMPLE (0). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">TSK_HEAD_OF_QUEUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">TSK_ORDERED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Load SCSI command packet. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">host_to_fcp_swap</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cdb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cdb</span><span class="p">));</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* Build IOCB segments */</span>
	<span class="n">qla24xx_build_scsi_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">cmd_pkt</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">);</span>

	<span class="cm">/* Set total data segment count. */</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">req_cnt</span><span class="p">;</span>
	<span class="cm">/* Specify response queue number where completion should happen */</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_DMA_VALID</span><span class="p">;</span>

	<span class="cm">/* Set chip new ring index. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">);</span>

	<span class="cm">/* Manage unprocessed RIO/ZIO commands in response queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">&amp;&amp;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">)</span>
		<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">queuing_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_dsds</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * qla24xx_dif_start_scsi() - Send a SCSI command to the ISP</span>
<span class="cm"> * @sp: command to send to the ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if a failure occurred, else zero.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_dif_start_scsi</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">nseg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="o">*</span><span class="n">clr_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">index</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">handle</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">tot_dsds</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">tot_prot_dsds</span><span class="p">;</span>
	<span class="kt">uint16_t</span>		<span class="n">fw_prot_opts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span>		<span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span>	<span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span>	<span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_type_crc_2</span>	<span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define QDSS_GOT_Q_SPACE	BIT_0</span>

	<span class="cm">/* Only process protection or &gt;16 cdb in this routine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qla24xx_start_scsi</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup device pointers. */</span>

	<span class="n">qla25xx_set_que</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* So we know we haven&#39;t pci_map&#39;ed anything yet */</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Acquire ring specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check for room in outstanding command list. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="cm">/* Compute number of required data segments */</span>
	<span class="cm">/* Map the sg table so we have an accurate count of sg entries needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		    <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nseg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_DMA_VALID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_READ_INSERT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_STRIP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">qla2_sgx</span> <span class="n">sgx</span><span class="p">;</span>
			<span class="kt">uint32_t</span>	<span class="n">partial</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2_sgx</span><span class="p">));</span>
			<span class="n">sgx</span><span class="p">.</span><span class="n">tot_bytes</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">sgx</span><span class="p">.</span><span class="n">cur_sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">sgx</span><span class="p">.</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>

			<span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">qla24xx_get_one_block_sg</span><span class="p">(</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">partial</span><span class="p">))</span>
				<span class="n">nseg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* number of required data segments */</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="cm">/* Compute number of required protection segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_configure_prot_mode</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_prot_opts</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		    <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nseg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_CRC_PROT_DMA_VALID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_READ_INSERT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_STRIP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">/</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Total Data and protection sg segment(s) */</span>
	<span class="n">tot_prot_dsds</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="n">tot_dsds</span> <span class="o">+=</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">|=</span> <span class="n">QDSS_GOT_Q_SPACE</span><span class="p">;</span>

	<span class="cm">/* Build header part of command packet (excluding the OPCODE). */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="cm">/* Fill-in common area */</span>
	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_type_crc_2</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="n">clr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd_pkt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">clr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Set NPORT-ID and LUN number*/</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">host_to_fcp_swap</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

	<span class="cm">/* Total Data and protection segment(s) */</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>

	<span class="cm">/* Build IOCB segments and adjust for data protection segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_build_scsi_crc_2_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_type_crc_2</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">tot_prot_dsds</span><span class="p">,</span> <span class="n">fw_prot_opts</span><span class="p">)</span> <span class="o">!=</span>
		<span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">req_cnt</span><span class="p">;</span>
	<span class="cm">/* Specify response queue number where completion should happen */</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Set chip new ring index. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">);</span>

	<span class="cm">/* Manage unprocessed RIO/ZIO commands in response queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">)</span>
		<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">queuing_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">QDSS_GOT_Q_SPACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">+=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Cleanup will be performed by the caller (queuecommand) */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla25xx_set_que</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">**</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">affinity</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">affinity</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">affinity</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">affinity</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	 <span class="k">else</span>
		<span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* Generic Control-SRB manipulation functions. */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ISP_QUE_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">request_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_cmd_array</span><span class="p">;</span>

	<span class="cm">/* Check for room in outstanding command list. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x700b</span><span class="p">,</span>
		    <span class="s">&quot;No room on oustanding cmd array.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prep command array. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="cm">/* Adjust entry-counts as needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SRB_SCSI_CMD</span><span class="p">)</span>
		<span class="n">req_cnt</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">iocbs</span><span class="p">;</span>

<span class="nl">skip_cmd_array:</span>
	<span class="cm">/* Check for room on request queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">req_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">qla2x00_debounce_register</span><span class="p">(</span>
			    <span class="n">ISP_REQ_Q_OUT</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">));</span>

		<span class="k">if</span>  <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">req_cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="cm">/* Prep packet */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">pkt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

<span class="nl">queuing_error:</span>
	<span class="k">return</span> <span class="n">pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_login_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="n">logio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>

	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">LOGINOUT_PORT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COMMAND_PLOGI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_COND_PLOGI</span><span class="p">)</span>
		<span class="n">logio</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COND_PLOGI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_SKIP_PRLI</span><span class="p">)</span>
		<span class="n">logio</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LCF_SKIP_PRLI</span><span class="p">);</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_login_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbx_entry</span> <span class="o">*</span><span class="n">mbx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">opts</span><span class="p">;</span>

	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MBX_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mbx</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MBC_LOGIN_FABRIC_PORT</span><span class="p">);</span>
	<span class="n">opts</span> <span class="o">=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_COND_PLOGI</span> <span class="o">?</span> <span class="n">BIT_0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opts</span> <span class="o">|=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_SKIP_PRLI</span> <span class="o">?</span> <span class="n">BIT_1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
		<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb10</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">opts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">opts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb3</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb9</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_logout_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="n">logio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">LOGINOUT_PORT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COMMAND_LOGO</span><span class="o">|</span><span class="n">LCF_IMPL_LOGO</span><span class="p">);</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_logout_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbx_entry</span> <span class="o">*</span><span class="n">mbx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MBX_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mbx</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MBC_LOGOUT_FABRIC_PORT</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span> <span class="o">=</span> <span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">)</span><span class="o">:</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb3</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb9</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="cm">/* Implicit: mbx-&gt;mbx10 = 0. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_adisc_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="n">logio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">LOGINOUT_PORT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COMMAND_ADISC</span><span class="p">);</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">logio</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_adisc_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbx_entry</span> <span class="o">*</span><span class="n">mbx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MBX_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mbx</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MBC_GET_PORT_DATABASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
		<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb10</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">BIT_0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span><span class="p">));</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb3</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span><span class="p">));</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb6</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span><span class="p">)));</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb7</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">async_pd_dma</span><span class="p">)));</span>
	<span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb9</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_tm_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsk_mgmt_entry</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">TSK_MGMT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">TCF_LUN_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">host_to_fcp_swap</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_els_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">els_entry_24xx</span> <span class="o">*</span><span class="n">els_iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">bsg_job</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bsg_job</span><span class="p">;</span>

        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">ELS_IOCB_TYPE</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">tx_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">);</span>
	<span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">sof_type</span> <span class="o">=</span> <span class="n">EST_SOFI3</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">rx_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">);</span>

	<span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SRB_ELS_CMD_RPT</span> <span class="o">?</span>
	    <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">r_els</span><span class="p">.</span><span class="n">els_code</span> <span class="o">:</span>
	    <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_els</span><span class="p">.</span><span class="n">command_code</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">rx_byte_count</span> <span class="o">=</span>
            <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">tx_byte_count</span> <span class="o">=</span>
            <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>

        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">tx_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">tx_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">));</span>

        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">rx_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">rx_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
        <span class="n">els_iocb</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_ct_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ct_iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>        <span class="n">avail_dsds</span><span class="p">;</span>
	<span class="kt">uint32_t</span>        <span class="o">*</span><span class="n">cur_dsd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">bsg_job</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bsg_job</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop_iterartion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cont_iocb_prsnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ct_iocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">handle1</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">total_dsd_count</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">req_bytecount</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">rsp_bytecount</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>

	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_req_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
	    <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_req_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
	    <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_req_length</span> <span class="o">=</span> <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">req_bytecount</span><span class="p">;</span>

	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
	    <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
	    <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_rsp_length</span> <span class="o">=</span> <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">rsp_bytecount</span><span class="p">;</span>

	<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span>       <span class="n">sle_dma</span><span class="p">;</span>
		<span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			* Five DSDs are available in the Cont.</span>
<span class="cm">			* Type 1 IOCB.</span>
<span class="cm">			       */</span>
			<span class="n">cont_pkt</span> <span class="o">=</span> <span class="n">qla2x00_prep_cont_type1_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">cont_iocb_prsnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">entry_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">loop_iterartion</span><span class="o">++</span><span class="p">;</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="n">entry_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_ct_iocb</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="n">ct_iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>        <span class="n">avail_dsds</span><span class="p">;</span>
	<span class="kt">uint32_t</span>        <span class="o">*</span><span class="n">cur_dsd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">;</span>
        <span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">bsg_job</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bsg_job</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop_iterartion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cont_iocb_prsnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CT_IOCB_TYPE</span><span class="p">;</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span>
            <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">);</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">rsp_dsd_count</span> <span class="o">=</span>
            <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">);</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span> <span class="o">=</span>
            <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span> <span class="o">=</span>
            <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sg_dma_address</span>
           <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">)));</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_0_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span>
            <span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">));</span>

	<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span>       <span class="n">sle_dma</span><span class="p">;</span>
		<span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="n">cont_pkt</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			* Five DSDs are available in the Cont.</span>
<span class="cm">			* Type 1 IOCB.</span>
<span class="cm">			       */</span>
			<span class="n">cont_pkt</span> <span class="o">=</span> <span class="n">qla2x00_prep_cont_type1_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">cont_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">cont_iocb_prsnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">entry_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="o">*</span><span class="n">cur_dsd</span><span class="o">++</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">loop_iterartion</span><span class="o">++</span><span class="p">;</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">ct_iocb</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="n">entry_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla82xx_start_scsi() - Send a SCSI command to the ISP</span>
<span class="cm"> * @sp: command to send to the ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if a failure occurred, else zero.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla82xx_start_scsi</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">,</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="o">*</span><span class="n">clr_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>        <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">req_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">tot_dsds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dbval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">fcp_dl</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">additional_cdb_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct6_dsd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Setup device pointers. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* So we know we haven&#39;t pci_map&#39;ed anything yet */</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbval</span> <span class="o">=</span> <span class="mh">0x04</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			<span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x300c</span><span class="p">,</span>
			    <span class="s">&quot;qla2x00_marker failed for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Acquire ring specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check for room in outstanding command list. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="cm">/* Map the sg table so we have an accurate count of sg entries needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
		    <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nseg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tot_dsds</span> <span class="o">&gt;</span> <span class="n">ql2xshiftctondsd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd_type_6</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">more_dsd_lists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dsd_dma</span> <span class="o">*</span><span class="n">dsd_ptr</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">more_dsd_lists</span> <span class="o">=</span> <span class="n">qla24xx_calc_dsd_lists</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">more_dsd_lists</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_inuse</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">NUM_DSD_CHAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x300d</span><span class="p">,</span>
			    <span class="s">&quot;Num of DSD list %d is than %d for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">more_dsd_lists</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_inuse</span><span class="p">,</span> <span class="n">NUM_DSD_CHAIN</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">more_dsd_lists</span> <span class="o">&lt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_avail</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">sufficient_dsds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">more_dsd_lists</span> <span class="o">-=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_avail</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">more_dsd_lists</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsd_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsd_dma</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsd_ptr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x300e</span><span class="p">,</span>
				    <span class="s">&quot;Failed to allocate memory for dsd_dma &quot;</span>
				    <span class="s">&quot;for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dl_dma_pool</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_list_dma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">dsd_addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dsd_ptr</span><span class="p">);</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x300f</span><span class="p">,</span>
				    <span class="s">&quot;Failed to allocate memory for dsd_addr &quot;</span>
				    <span class="s">&quot;for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsd_ptr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_list</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gbl_dsd_avail</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">sufficient_dsds:</span>
		<span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ctx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span> <span class="o">=</span>
		    <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3010</span><span class="p">,</span>
			    <span class="s">&quot;Failed to allocate ctx for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct6_dsd</span><span class="p">));</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">,</span>
			<span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3011</span><span class="p">,</span>
			    <span class="s">&quot;Failed to allocate fcp_cmnd for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize the DSD list and dma handle */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dsd_list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dsd_use_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">additional_cdb_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* SCSI command bigger than 16 bytes must be</span>
<span class="cm">				 * multiple of 4</span>
<span class="cm">				 */</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3012</span><span class="p">,</span>
				    <span class="s">&quot;scsi cmd len %d not multiple of 4 &quot;</span>
				    <span class="s">&quot;for cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">queuing_error_fcp_cmnd</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_len</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">additional_cdb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_len</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_type_6</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

		<span class="cm">/* Zero out remaining portion of packet. */</span>
		<span class="cm">/*    tagged queuing modifier -- default is TSK_SIMPLE (0). */</span>
		<span class="n">clr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd_pkt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">clr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>

		<span class="cm">/* Set NPORT-ID and LUN number*/</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

		<span class="cm">/* Build IOCB segments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_build_scsi_type_6_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">cmd_pkt</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error_fcp_cmnd</span><span class="p">;</span>

		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">host_to_fcp_swap</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

		<span class="cm">/* build FCP_CMND IU */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcp_cmnd</span><span class="p">));</span>
		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">additional_cdb_len</span> <span class="o">=</span> <span class="n">additional_cdb_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">additional_cdb_len</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">additional_cdb_len</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Update tagged queuing modifier -- default is TSK_SIMPLE (0).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">=</span>
				    <span class="n">TSK_HEAD_OF_QUEUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">=</span>
				    <span class="n">TSK_ORDERED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Populate the FCP_PRIO. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fcp_prio_enabled</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">task_attribute</span> <span class="o">|=</span>
			    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcp_prio</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

		<span class="n">fcp_dl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="o">-&gt;</span><span class="n">cdb</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span>
		    <span class="n">additional_cdb_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">fcp_dl</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dseg_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_len</span><span class="p">);</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dseg_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma</span><span class="p">));</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dseg_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma</span><span class="p">));</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_FCP_CMND_DMA_VALID</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="cm">/* Set total data segment count. */</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">req_cnt</span><span class="p">;</span>
		<span class="cm">/* Specify response queue number where</span>
<span class="cm">		 * completion should happen</span>
<span class="cm">		 */</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd_type_7</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
		<span class="n">req_cnt</span> <span class="o">=</span> <span class="n">qla24xx_calc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span>
			    <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

		<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_type_7</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

		<span class="cm">/* Zero out remaining portion of packet. */</span>
		<span class="cm">/* tagged queuing modifier -- default is TSK_SIMPLE (0).*/</span>
		<span class="n">clr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd_pkt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">clr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>

		<span class="cm">/* Set NPORT-ID and LUN number*/</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">host_to_fcp_swap</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Update tagged queuing modifier -- default is TSK_SIMPLE (0).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
				<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">TSK_HEAD_OF_QUEUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
				<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">TSK_ORDERED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Populate the FCP_PRIO. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fcp_prio_enabled</span><span class="p">)</span>
			<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">|=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcp_prio</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/* Load SCSI command packet. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
		<span class="n">host_to_fcp_swap</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cdb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">fcp_cdb</span><span class="p">));</span>

		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

		<span class="cm">/* Build IOCB segments */</span>
		<span class="n">qla24xx_build_scsi_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">cmd_pkt</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">);</span>

		<span class="cm">/* Set total data segment count. */</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">req_cnt</span><span class="p">;</span>
		<span class="cm">/* Specify response queue number where</span>
<span class="cm">		 * completion should happen.</span>
<span class="cm">		 */</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* Build command packet. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_DMA_VALID</span><span class="p">;</span>

	<span class="cm">/* Set chip new ring index. */</span>
	<span class="cm">/* write, read and verify logic */</span>
	<span class="n">dbval</span> <span class="o">=</span> <span class="n">dbval</span> <span class="o">|</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xdbwr</span><span class="p">)</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span> <span class="n">dbval</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span>
			<span class="n">dbval</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_rd_ptr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span>
				<span class="n">dbval</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Manage unprocessed RIO/ZIO commands in response queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">)</span>
		<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">queuing_error_fcp_cmnd:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma_pool</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_dma</span><span class="p">);</span>
<span class="nl">queuing_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_dsds</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ctx_mempool</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_start_sp</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pkt</span> <span class="o">=</span> <span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x700c</span><span class="p">,</span>
		    <span class="s">&quot;qla2x00_alloc_iocbs failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SRB_LOGIN_CMD</span>:
		<span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">qla24xx_login_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">qla2x00_login_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_LOGOUT_CMD</span>:
		<span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">qla24xx_logout_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">qla2x00_logout_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_ELS_CMD_RPT</span>:
	<span class="k">case</span> <span class="n">SRB_ELS_CMD_HST</span>:
		<span class="n">qla24xx_els_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_CT_CMD</span>:
		<span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">qla24xx_ct_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">qla2x00_ct_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_ADISC_CMD</span>:
		<span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">qla24xx_adisc_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">qla2x00_adisc_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_TM_CMD</span>:
		<span class="n">qla24xx_tm_iocb</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
