<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_isr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_isr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_bsg_fc.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_mbx_completion</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint16_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_process_completed_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_status_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_status_cont_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">,</span> <span class="n">sts_cont_entry_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla2x00_error_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">,</span>
	<span class="n">sts_entry_t</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qla2100_intr_handler() - Process interrupts for the ISP2100 and ISP2200.</span>
<span class="cm"> * @irq:</span>
<span class="cm"> * @dev_id: SCSI driver HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Called by system whenever the host adapter generates an interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns handled flag.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span>
<span class="nf">qla2100_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">iter</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">hccr</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x505d</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">IRQ_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">iter</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">hccr</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hccr</span> <span class="o">&amp;</span> <span class="n">HCCR_RISC_PAUSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Issue a &quot;HARD&quot; reset in order for the RISC interrupt</span>
<span class="cm">			 * bit to be cleared.  Schedule a big hammer to get</span>
<span class="cm">			 * out of the RISC PAUSED state.</span>
<span class="cm">			 */</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RESET_RISC</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISR_RISC_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_RISC_INT</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

			<span class="cm">/* Get mailbox data. */</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x3fff</span> <span class="o">&amp;&amp;</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla2x00_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x7fff</span> <span class="o">&amp;&amp;</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*EMPTY*/</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5025</span><span class="p">,</span>
				    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="cm">/* Release mailbox registers. */</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qla2x00_process_response_queue</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>

			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_RISC_INT</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MBX_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IRQ_HANDLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2300_intr_handler() - Process interrupts for the ISP23xx and ISP63xx.</span>
<span class="cm"> * @irq:</span>
<span class="cm"> * @dev_id: SCSI driver HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Called by system whenever the host adapter generates an interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns handled flag.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span>
<span class="nf">qla2300_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">iter</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">stat</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">hccr</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x5058</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">IRQ_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">iter</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSR_RISC_PAUSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">hccr</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hccr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_15</span> <span class="o">|</span> <span class="n">BIT_13</span> <span class="o">|</span> <span class="n">BIT_11</span> <span class="o">|</span> <span class="n">BIT_8</span><span class="p">))</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5026</span><span class="p">,</span>
				    <span class="s">&quot;Parity error -- HCCR=%x, Dumping &quot;</span>
				    <span class="s">&quot;firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hccr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5027</span><span class="p">,</span>
				    <span class="s">&quot;RISC paused -- HCCR=%x, Dumping &quot;</span>
				    <span class="s">&quot;firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hccr</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Issue a &quot;HARD&quot; reset in order for the RISC</span>
<span class="cm">			 * interrupt bit to be cleared.  Schedule a big</span>
<span class="cm">			 * hammer to get out of the RISC PAUSED state.</span>
<span class="cm">			 */</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RESET_RISC</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSR_RISC_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">case</span> <span class="mh">0x10</span>:
		<span class="k">case</span> <span class="mh">0x11</span>:
			<span class="n">qla2x00_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>

			<span class="cm">/* Release mailbox registers. */</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>:
			<span class="n">qla2x00_process_response_queue</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x15</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_CMPLT_1_16BIT</span><span class="p">;</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x16</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5028</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_RISC_INT</span><span class="p">);</span>
		<span class="n">RD_REG_WORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MBX_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IRQ_HANDLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_mbx_completion() - Process mailbox command completions.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @mb0: Mailbox0 register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_mbx_completion</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">mb0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">mboxes</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="cm">/* Read all mbox registers? */</span>
	<span class="n">mboxes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5001</span><span class="p">,</span> <span class="s">&quot;MBX pointer ERRROR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mboxes</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span><span class="p">;</span>

	<span class="cm">/* Load return mailbox registers. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb0</span><span class="p">;</span>
	<span class="n">mboxes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mboxes</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">qla2x00_debounce_register</span><span class="p">(</span><span class="n">wptr</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mboxes</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">wptr</span><span class="p">);</span>

		<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mboxes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla81xx_idc_event</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">aen</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">descr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="s">&quot;Request Notification&quot;</span><span class="p">,</span> <span class="s">&quot;Time Extension&quot;</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg24</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="n">QLA_IDC_ACK_REGS</span><span class="p">];</span>

	<span class="cm">/* Seed data -- mailbox1 -&gt; mailbox7. */</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg24</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">QLA_IDC_ACK_REGS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">wptr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">wptr</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5021</span><span class="p">,</span>
	    <span class="s">&quot;Inter-Driver Communication %s -- &quot;</span>
	    <span class="s">&quot;%04x %04x %04x %04x %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">event</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="cm">/* Acknowledgement needed? [Notify &amp;&amp; non-zero timeout]. */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">descr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aen</span> <span class="o">!=</span> <span class="n">MBA_IDC_NOTIFY</span> <span class="o">||</span> <span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5022</span><span class="p">,</span>
	    <span class="s">&quot;%lu Inter-Driver Communication %s -- ACK timeout=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">],</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_post_idc_ack_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5023</span><span class="p">,</span>
		    <span class="s">&quot;IDC failed to post ACK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LS_UNKNOWN	2</span>
<span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla2x00_get_link_speed_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">link_speeds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">,</span> <span class="s">&quot;8&quot;</span><span class="p">,</span> <span class="s">&quot;16&quot;</span><span class="p">,</span> <span class="s">&quot;10&quot;</span><span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">link_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_speed</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">link_speed</span> <span class="o">=</span> <span class="n">link_speeds</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fw_speed</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span>
		<span class="n">link_speed</span> <span class="o">=</span> <span class="n">link_speeds</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">link_speed</span> <span class="o">=</span> <span class="n">link_speeds</span><span class="p">[</span><span class="n">LS_UNKNOWN</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_speed</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">link_speed</span> <span class="o">=</span>
			    <span class="n">link_speeds</span><span class="p">[</span><span class="n">fw_speed</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">link_speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_async_event() - Process aynchronous events.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @mb: Mailbox registers (0 - 3)</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_async_event</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">handle_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">,</span> <span class="n">mbx</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">handles</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg24</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg82</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">rscn_entry</span><span class="p">,</span> <span class="n">host_pid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Setup to process RIO completion. */</span>
	<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_rio</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBA_SCSI_COMPLETION</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_CMPLT_1_16BIT</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_CMPLT_2_16BIT</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_CMPLT_3_16BIT</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_CMPLT_4_16BIT</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_CMPLT_5_16BIT</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_CMPLT_2_32BIT</span>:
		<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
		    <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
		    <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">handle_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">skip_rio:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBA_SCSI_COMPLETION</span>:	<span class="cm">/* Fast Post */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">handle_cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qla2x00_process_completed_request</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
				<span class="n">handles</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_RESET</span>:			<span class="cm">/* Reset */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5002</span><span class="p">,</span>
		    <span class="s">&quot;Asynchronous RESET.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_SYSTEM_ERR</span>:		<span class="cm">/* System Error */</span>
		<span class="n">mbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg24</span><span class="o">-&gt;</span><span class="n">mailbox7</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5003</span><span class="p">,</span>
		    <span class="s">&quot;ISP System Error - mbx1=%xh mbx2=%xh mbx3=%xh &quot;</span>
		    <span class="s">&quot;mbx7=%xh.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mbx</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5004</span><span class="p">,</span>
				    <span class="s">&quot;Unrecoverable Hardware Error: adapter &quot;</span>
				    <span class="s">&quot;marked OFFLINE!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">DFLG_DEV_FAILED</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Check to see if MPI timeout occurred */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">mbx</span> <span class="o">&amp;</span> <span class="n">MBX_3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">MPI_RESET_NEEDED</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

				<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5005</span><span class="p">,</span>
			    <span class="s">&quot;Unrecoverable Hardware Error: adapter marked &quot;</span>
			    <span class="s">&quot;OFFLINE!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">DFLG_DEV_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_REQ_TRANSFER_ERR</span>:	<span class="cm">/* Request Transfer Error */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5006</span><span class="p">,</span>
		    <span class="s">&quot;ISP Request Transfer Error (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_RSP_TRANSFER_ERR</span>:	<span class="cm">/* Response Transfer Error */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5007</span><span class="p">,</span>
		    <span class="s">&quot;ISP Response Transfer Error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_WAKEUP_THRES</span>:		<span class="cm">/* Request Queue Wake-up */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5008</span><span class="p">,</span>
		    <span class="s">&quot;Asynchronous WAKEUP_THRES.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_LIP_OCCURRED</span>:		<span class="cm">/* Loop Initialization Procedure */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5009</span><span class="p">,</span>
		    <span class="s">&quot;LIP occurred (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FC4_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FDMI_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla2x00_post_aen_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">FCH_EVT_LIP</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_LOOP_UP</span>:		<span class="cm">/* Loop Up Event */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span> <span class="o">=</span> <span class="n">PORT_SPEED_1GB</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x500a</span><span class="p">,</span>
		    <span class="s">&quot;LOOP UP detected (%s Gbps).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">qla2x00_get_link_speed_str</span><span class="p">(</span><span class="n">ha</span><span class="p">));</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla2x00_post_aen_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">FCH_EVT_LINKUP</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_LOOP_DOWN</span>:		<span class="cm">/* Loop Down Event */</span>
		<span class="n">mbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="o">?</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg24</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mbx</span> <span class="o">=</span> <span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg82</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">:</span> <span class="n">mbx</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x500b</span><span class="p">,</span>
		    <span class="s">&quot;LOOP DOWN detected (%x %x %x %x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mbx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">DFLG_NO_CABLE</span><span class="p">;</span>
			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span> <span class="o">=</span> <span class="n">PORT_SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="n">qla2x00_post_aen_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">FCH_EVT_LINKDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_LIP_RESET</span>:		<span class="cm">/* LIP reset occurred */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x500c</span><span class="p">,</span>
		    <span class="s">&quot;LIP reset occurred (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">LOOP</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla2x00_post_aen_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">FCH_EVT_LIPRESET</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* case MBA_DCBX_COMPLETE: */</span>
	<span class="k">case</span> <span class="n">MBA_POINT_TO_POINT</span>:	<span class="cm">/* Point-to-Point */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x500d</span><span class="p">,</span>
			    <span class="s">&quot;DCBX Completed -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">notify_dcbx_comp</span><span class="p">)</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_comp</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x500e</span><span class="p">,</span>
			    <span class="s">&quot;Asynchronous P2P MODE received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Until there&#39;s a transition from loop down to loop up, treat</span>
<span class="cm">		 * this as loop down only.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span>
				    <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FC4_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FDMI_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">gpsc_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_CHG_IN_CONNECTION</span>:	<span class="cm">/* Change in connection mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x500f</span><span class="p">,</span>
		    <span class="s">&quot;Configuration change detected: value=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span>
				    <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_PORT_UPDATE</span>:		<span class="cm">/* Port database update */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Handle only global and vn-port update events</span>
<span class="cm">		 *</span>
<span class="cm">		 * Relevant inputs:</span>
<span class="cm">		 * mb[1] = N_Port handle of changed port</span>
<span class="cm">		 * OR 0xffff for global event</span>
<span class="cm">		 * mb[2] = New login state</span>
<span class="cm">		 * 7 = Port logged out</span>
<span class="cm">		 * mb[3] = LSB is vp_idx, 0xff = all vps</span>
<span class="cm">		 *</span>
<span class="cm">		 * Skip processing if:</span>
<span class="cm">		 *       Event is global, vp_idx is NOT all vps,</span>
<span class="cm">		 *           vp_idx does not match</span>
<span class="cm">		 *       Event is not global, vp_idx does not match</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2XXX_MIDTYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">!=</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Global event -- port logout or port unavailable. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5010</span><span class="p">,</span>
			    <span class="s">&quot;Port unavailable %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x505e</span><span class="p">,</span>
			    <span class="s">&quot;Link is offline.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span>
				    <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">DFLG_NO_CABLE</span><span class="p">;</span>
				<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
				<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span>
				    <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
				<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span> <span class="o">=</span> <span class="n">PORT_SPEED_UNKNOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If PORT UPDATE is global (received LIP_OCCURRED/LIP_RESET</span>
<span class="cm">		 * event etc. earlier indicating loop is down) then process</span>
<span class="cm">		 * it.  Otherwise ignore it and Wait for RSCN to come in.</span>
<span class="cm">		 */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DEAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5011</span><span class="p">,</span>
			    <span class="s">&quot;Asynchronous PORT UPDATE ignored %04x/%04x/%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

			<span class="n">qlt_async_event</span><span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5012</span><span class="p">,</span>
		    <span class="s">&quot;Port database changed %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x505f</span><span class="p">,</span>
		    <span class="s">&quot;Link is operational (%s Gbps).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">qla2x00_get_link_speed_str</span><span class="p">(</span><span class="n">ha</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Mark all devices as missing so we will login again.</span>
<span class="cm">		 */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_UP</span><span class="p">);</span>

		<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SCR_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="n">qlt_async_event</span><span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_RSCN_UPDATE</span>:		<span class="cm">/* State Change Registration */</span>
		<span class="cm">/* Check if the Vport has issued a SCR */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">VP_SCR_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_flags</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Only handle SCNs for our Vport index. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span> <span class="o">&amp;&amp;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">!=</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5013</span><span class="p">,</span>
		    <span class="s">&quot;RSCN database changed -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">rscn_entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">host_pid</span> <span class="o">=</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rscn_entry</span> <span class="o">==</span> <span class="n">host_pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5014</span><span class="p">,</span>
			    <span class="s">&quot;Ignoring RSCN update to local host &quot;</span>
			    <span class="s">&quot;port ID (%06x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host_pid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Ignore reserved bits from RSCN-payload. */</span>
		<span class="n">rscn_entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">qla2x00_post_aen_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">FCH_EVT_RSCN</span><span class="p">,</span> <span class="n">rscn_entry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* case MBA_RIO_RESPONSE: */</span>
	<span class="k">case</span> <span class="n">MBA_ZIO_RESPONSE</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5015</span><span class="p">,</span>
		    <span class="s">&quot;[R|Z]IO update completion.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla2x00_process_response_queue</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_DISCARD_RND_FRAME</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5016</span><span class="p">,</span>
		    <span class="s">&quot;Discard RND Frame -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_TRACE_NOTIFICATION</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5017</span><span class="p">,</span>
		    <span class="s">&quot;Trace Notification -- %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_ISP84XX_ALERT</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5018</span><span class="p">,</span>
		    <span class="s">&quot;ISP84XX Alert Notification -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">A84_PANIC_RECOVERY</span>:
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5019</span><span class="p">,</span>
			    <span class="s">&quot;Alert 84XX: panic recovery %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">A84_OP_LOGIN_COMPLETE</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">op_fw_version</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x501a</span><span class="p">,</span>
			    <span class="s">&quot;Alert 84XX: firmware version %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">op_fw_version</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">A84_DIAG_LOGIN_COMPLETE</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">diag_fw_version</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x501b</span><span class="p">,</span>
			    <span class="s">&quot;Alert 84XX: diagnostic firmware version %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">diag_fw_version</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">A84_GOLD_LOGIN_COMPLETE</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">diag_fw_version</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">fw_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x501c</span><span class="p">,</span>
			    <span class="s">&quot;Alert 84XX: gold firmware version %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x501d</span><span class="p">,</span>
			    <span class="s">&quot;Alert 84xx: Invalid Alert %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_DCBX_START</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x501e</span><span class="p">,</span>
		    <span class="s">&quot;DCBX Started -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_DCBX_PARAM_UPDATE</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x501f</span><span class="p">,</span>
		    <span class="s">&quot;DCBX Parameters Updated -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_FCF_CONF_ERR</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5020</span><span class="p">,</span>
		    <span class="s">&quot;FCF Configuration Error -- %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_IDC_COMPLETE</span>:
	<span class="k">case</span> <span class="n">MBA_IDC_NOTIFY</span>:
	<span class="k">case</span> <span class="n">MBA_IDC_TIME_EXT</span>:
		<span class="n">qla81xx_idc_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5057</span><span class="p">,</span>
		    <span class="s">&quot;Unknown AEN:%04x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">qlt_async_event</span><span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_vhosts</span><span class="p">)</span>
		<span class="n">qla2x00_alert_all_vps</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_process_completed_request() - Process a Fast Post response.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @index: SRB index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_process_completed_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Validate handle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3014</span><span class="p">,</span>
		    <span class="s">&quot;Invalid SCSI command index (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Free outstanding command slot. */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Save ISP completion status */</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3016</span><span class="p">,</span> <span class="s">&quot;Invalid SCSI SRB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">srb_t</span> <span class="o">*</span>
<span class="nf">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">sts_entry_t</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5031</span><span class="p">,</span>
		    <span class="s">&quot;Invalid command index (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5032</span><span class="p">,</span>
		    <span class="s">&quot;Invalid completion handle (%x) -- timed-out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5033</span><span class="p">,</span>
		    <span class="s">&quot;SRB handle (%x) mismatch %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_mbx_iocb_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">mbx_entry</span> <span class="o">*</span><span class="n">mbx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">func</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;MBX-IOCB&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mbx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_RETRIED</span> <span class="o">?</span>
	    <span class="n">QLA_LOGIO_LOGIN_RETRIED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5043</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error entry - hdl=%x portid=%02x%02x%02x &quot;</span>
		    <span class="s">&quot;entry-status=%x status=%x state-flag=%x &quot;</span>
		    <span class="s">&quot;status-flags=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">mbx</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">state_flags</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">status_flags</span><span class="p">));</span>

		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_async</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5029</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mbx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbx</span><span class="p">));</span>

		<span class="k">goto</span> <span class="n">logio_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x30</span> <span class="o">&amp;&amp;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SRB_LOGIN_CMD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span><span class="p">)</span> <span class="o">==</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span><span class="p">)</span> <span class="o">==</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5045</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s complete - hdl=%x portid=%02x%02x%02x mbx1=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span><span class="p">));</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SRB_LOGIN_CMD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_TARGET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_INITIATOR</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">logio_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBS_PORT_ID_USED</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBS_LOOP_ID_USED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5046</span><span class="p">,</span>
	    <span class="s">&quot;Async-%s failed - hdl=%x portid=%02x%02x%02x status=%x &quot;</span>
	    <span class="s">&quot;mb0=%x mb1=%x mb2=%x mb6=%x mb7=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
	    <span class="n">status</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb0</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb1</span><span class="p">),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb2</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb6</span><span class="p">),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mbx</span><span class="o">-&gt;</span><span class="n">mb7</span><span class="p">));</span>

<span class="nl">logio_done:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_ct_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="n">sts_entry_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iocb_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">func</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;CT_IOCB&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">bsg_job</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">comp_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bsg_job</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bsg_job</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;ct pass-through&quot;</span><span class="p">;</span>

	<span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>

	<span class="cm">/* return FC_CTELS_STATUS_OK and leave the decoding of the ELS/CT</span>
<span class="cm">	 * fc payload  to the caller</span>
<span class="cm">	 */</span>
	<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">ctels_reply</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">FC_CTELS_STATUS_OK</span><span class="p">;</span>
	<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_reply</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">CS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">==</span> <span class="n">CS_DATA_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="n">sts_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rsp_info_len</span><span class="p">);</span>

			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5048</span><span class="p">,</span>
			    <span class="s">&quot;CT pass-through-%s error &quot;</span>
			    <span class="s">&quot;comp_status-status=0x%x total_byte = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">type</span><span class="p">,</span> <span class="n">comp_status</span><span class="p">,</span>
			    <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5049</span><span class="p">,</span>
			    <span class="s">&quot;CT pass-through-%s error &quot;</span>
			    <span class="s">&quot;comp_status-status=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">comp_status</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_async</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5035</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pkt</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
		    <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
		<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_els_ct_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iocb_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">func</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ELS_CT_IOCB&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">bsg_job</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">comp_status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_status</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">uint8_t</span><span class="o">*</span> <span class="n">fw_sts_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bsg_job</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">bsg_job</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SRB_ELS_CMD_RPT</span>:
	<span class="k">case</span> <span class="n">SRB_ELS_CMD_HST</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;els&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_CT_CMD</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;ct pass-through&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x503e</span><span class="p">,</span>
		    <span class="s">&quot;Unrecognized SRB: (%p) type=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">comp_status</span> <span class="o">=</span> <span class="n">fw_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
	<span class="n">fw_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">els_sts_entry_24xx</span><span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">error_subcode_1</span><span class="p">);</span>
	<span class="n">fw_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">els_sts_entry_24xx</span><span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">error_subcode_2</span><span class="p">);</span>

	<span class="cm">/* return FC_CTELS_STATUS_OK and leave the decoding of the ELS/CT</span>
<span class="cm">	 * fc payload  to the caller</span>
<span class="cm">	 */</span>
	<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">ctels_reply</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">FC_CTELS_STATUS_OK</span><span class="p">;</span>
	<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_reply</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">CS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">==</span> <span class="n">CS_DATA_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">els_sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">total_byte_count</span><span class="p">);</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x503f</span><span class="p">,</span>
			    <span class="s">&quot;ELS-CT pass-through-%s error hdl=%x comp_status-status=0x%x &quot;</span>
			    <span class="s">&quot;error subcode 1=0x%x error subcode 2=0x%x total_byte = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">comp_status</span><span class="p">,</span> <span class="n">fw_status</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fw_status</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			    <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">els_sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">total_byte_count</span><span class="p">));</span>
			<span class="n">fw_sts_ptr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_reply</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span> <span class="n">fw_sts_ptr</span><span class="p">,</span> <span class="n">fw_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_status</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5040</span><span class="p">,</span>
			    <span class="s">&quot;ELS-CT pass-through-%s error hdl=%x comp_status-status=0x%x &quot;</span>
			    <span class="s">&quot;error subcode 1=0x%x error subcode 2=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">comp_status</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">els_sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">error_subcode_1</span><span class="p">),</span>
			    <span class="n">le16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">els_sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span>
				    <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">error_subcode_2</span><span class="p">));</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fw_sts_ptr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_reply</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span> <span class="n">fw_sts_ptr</span><span class="p">,</span> <span class="n">fw_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_status</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_user</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5056</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pkt</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span>  <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
		<span class="n">bsg_job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_logio_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="n">logio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">func</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;LOGIO-IOCB&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">iop</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">logio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_RETRIED</span> <span class="o">?</span>
		<span class="n">QLA_LOGIO_LOGIN_RETRIED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x5034</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error entry - hdl=%x&quot;</span>
		    <span class="s">&quot;portid=%02x%02x%02x entry-status=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
		    <span class="n">logio</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_async</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x504d</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">logio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">logio</span><span class="p">));</span>

		<span class="k">goto</span> <span class="n">logio_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x5036</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s complete - hdl=%x portid=%02x%02x%02x &quot;</span>
		    <span class="s">&quot;iop0=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SRB_LOGIN_CMD</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">logio_done</span><span class="p">;</span>

		<span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_TARGET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_8</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_5</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_INITIATOR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">||</span> <span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">||</span> <span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">logio_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">iop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LSC_SCODE_PORTID_USED</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_PORT_ID_USED</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LSC_SCODE_NPORT_USED</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_LOOP_ID_USED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x5037</span><span class="p">,</span>
	    <span class="s">&quot;Async-%s failed - hdl=%x portid=%02x%02x%02x comp=%x &quot;</span>
	    <span class="s">&quot;iop0=%x iop1=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">logio</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

<span class="nl">logio_done:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_tm_iocb_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">tsk_mgmt_entry</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">func</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;TMF-IOCB&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">sts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">tsk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x5038</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error - hdl=%x entry-status(%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CS_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x5039</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error - hdl=%x completion status(%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">SS_RESPONSE_INFO_LEN_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x503a</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error - hdl=%x no response info(%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">rsp_data_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x503b</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error - hdl=%x not enough response(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">rsp_data_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x503c</span><span class="p">,</span>
		    <span class="s">&quot;Async-%s error - hdl=%x response(%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">type</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_async</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5055</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">sts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sts</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_process_response_queue() - Process response queue entries.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_process_response_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">sts_entry_t</span>	<span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>        <span class="n">handle_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>        <span class="n">cnt</span><span class="p">;</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>

		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_error_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="p">((</span><span class="n">response_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">;</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATUS_TYPE</span>:
			<span class="n">qla2x00_status_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATUS_TYPE_21</span>:
			<span class="n">handle_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">sts21_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handle_count</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">handle_cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla2x00_process_completed_request</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">sts21_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATUS_TYPE_22</span>:
			<span class="n">handle_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">sts22_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handle_count</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">handle_cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla2x00_process_completed_request</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">sts22_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATUS_CONT_TYPE</span>:
			<span class="n">qla2x00_status_cont_entry</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="p">(</span><span class="n">sts_cont_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MBX_IOCB_TYPE</span>:
			<span class="n">qla2x00_mbx_iocb_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">mbx_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CT_IOCB_TYPE</span>:
			<span class="n">qla2x00_ct_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">CT_IOCB_TYPE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Type Not Supported. */</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x504a</span><span class="p">,</span>
			    <span class="s">&quot;Received unknown response pkt type %x &quot;</span>
			    <span class="s">&quot;entry status=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">((</span><span class="n">response_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust ring index */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_RSP_Q_OUT</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_handle_sense</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sense_data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">par_sense_len</span><span class="p">,</span>
		     <span class="kt">uint32_t</span> <span class="n">sense_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">track_sense_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">&gt;=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">)</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>

	<span class="n">SET_CMD_SENSE_LEN</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>
	<span class="n">SET_CMD_SENSE_PTR</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">);</span>
	<span class="n">track_sense_len</span> <span class="o">=</span> <span class="n">sense_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="n">par_sense_len</span><span class="p">)</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="n">par_sense_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>

	<span class="n">SET_CMD_SENSE_PTR</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">+</span> <span class="n">sense_len</span><span class="p">);</span>
	<span class="n">track_sense_len</span> <span class="o">-=</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="n">SET_CMD_SENSE_LEN</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">track_sense_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">track_sense_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x301c</span><span class="p">,</span>
		    <span class="s">&quot;Check condition Sense data, nexus%ld:%d:%d cmd=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		    <span class="n">cp</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_io</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x302b</span><span class="p">,</span>
		    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">scsi_dif_tuple</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">guard</span><span class="p">;</span>       <span class="cm">/* Checksum */</span>
	<span class="n">__be16</span> <span class="n">app_tag</span><span class="p">;</span>         <span class="cm">/* APPL identifer */</span>
	<span class="n">__be32</span> <span class="n">ref_tag</span><span class="p">;</span>         <span class="cm">/* Target LBA or indirect LBA */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Checks the guard or meta-data for the type of error</span>
<span class="cm"> * detected by the HBA. In case of errors, we set the</span>
<span class="cm"> * ASC/ASCQ fields in the sense buffer with ILLEGAL_REQUEST</span>
<span class="cm"> * to indicate to the kernel that the HBA detected error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla2x00_handle_dif_error</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">sts24</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="kt">uint8_t</span>		<span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">uint8_t</span>		<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">uint32_t</span>	<span class="n">e_ref_tag</span><span class="p">,</span> <span class="n">a_ref_tag</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">e_app_tag</span><span class="p">,</span> <span class="n">a_app_tag</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">e_guard</span><span class="p">,</span> <span class="n">a_guard</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * swab32 of the &quot;data&quot; field in the beginning of qla2x00_status_entry()</span>
<span class="cm">	 * would make guard field appear at offset 2</span>
<span class="cm">	 */</span>
	<span class="n">a_guard</span>   <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ap</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">a_app_tag</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ap</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">a_ref_tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ap</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">e_guard</span>   <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ep</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">e_app_tag</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ep</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">e_ref_tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">ep</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3023</span><span class="p">,</span>
	    <span class="s">&quot;iocb(s) %p Returned STATUS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts24</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3024</span><span class="p">,</span>
	    <span class="s">&quot;DIF ERROR in cmd 0x%x lba 0x%llx act ref&quot;</span>
	    <span class="s">&quot; tag=0x%x, exp ref_tag=0x%x, act app tag=0x%x, exp app&quot;</span>
	    <span class="s">&quot; tag=0x%x, act guard=0x%x, exp guard=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">a_ref_tag</span><span class="p">,</span> <span class="n">e_ref_tag</span><span class="p">,</span>
	    <span class="n">a_app_tag</span><span class="p">,</span> <span class="n">e_app_tag</span><span class="p">,</span> <span class="n">a_guard</span><span class="p">,</span> <span class="n">e_guard</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ignore sector if:</span>
<span class="cm">	 * For type     3: ref &amp; app tag is all &#39;f&#39;s</span>
<span class="cm">	 * For type 0,1,2: app tag is all &#39;f&#39;s</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a_app_tag</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">scsi_get_prot_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCSI_PROT_DIF_TYPE3</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">a_ref_tag</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">blocks_done</span><span class="p">,</span> <span class="n">resid</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">lba_s</span> <span class="o">=</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* 2TB boundary case covered automatically with this */</span>
		<span class="n">blocks_done</span> <span class="o">=</span> <span class="n">e_ref_tag</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">lba_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">resid</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">blocks_done</span> <span class="o">*</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>

		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="cm">/* Update protection tag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_ent</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sd_dif_tuple</span> <span class="o">*</span><span class="n">spt</span><span class="p">;</span>

			<span class="cm">/* Patch the corresponding protection tags */</span>
			<span class="n">scsi_for_each_prot_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span>
			    <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">num_ent</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">num_ent</span> <span class="o">&lt;</span> <span class="n">blocks_done</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">k</span> <span class="o">+=</span> <span class="n">num_ent</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">blocks_done</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">blocks_done</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">blocks_done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x302f</span><span class="p">,</span>
				    <span class="s">&quot;unexpected tag values tag:lba=%x:%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">e_ref_tag</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">lba_s</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spt</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">spt</span> <span class="o">+=</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">spt</span><span class="o">-&gt;</span><span class="n">app_tag</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_get_prot_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSI_PROT_DIF_TYPE3</span><span class="p">)</span>
				<span class="n">spt</span><span class="o">-&gt;</span><span class="n">ref_tag</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check guard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e_guard</span> <span class="o">!=</span> <span class="n">a_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_build_sense_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		    <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">set_driver_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DRIVER_SENSE</span><span class="p">);</span>
		<span class="n">set_host_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DID_ABORT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check ref tag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e_ref_tag</span> <span class="o">!=</span> <span class="n">a_ref_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_build_sense_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		    <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">set_driver_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DRIVER_SENSE</span><span class="p">);</span>
		<span class="n">set_host_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DID_ABORT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check appl tag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e_app_tag</span> <span class="o">!=</span> <span class="n">a_app_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_build_sense_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		    <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="n">set_driver_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DRIVER_SENSE</span><span class="p">);</span>
		<span class="n">set_host_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DID_ABORT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_status_entry() - Process a Status IOCB entry.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @pkt: Entry pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_status_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span>		<span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">fc_port_t</span>	<span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">sts_entry_t</span> <span class="o">*</span><span class="n">sts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">sts24</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">comp_status</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">scsi_status</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">ox_id</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">lscsi_status</span><span class="p">;</span>
	<span class="kt">int32_t</span>		<span class="n">resid</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sense_len</span><span class="p">,</span> <span class="n">par_sense_len</span><span class="p">,</span> <span class="n">rsp_info_len</span><span class="p">,</span> <span class="n">resid_len</span><span class="p">,</span>
	    <span class="n">fw_resid_len</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="o">*</span><span class="n">rsp_info</span><span class="p">,</span> <span class="o">*</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">que</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">logit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="n">sts24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
		<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SS_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
		<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SS_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">LSW</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">que</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">];</span>

	<span class="cm">/* Fast path completion. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">==</span> <span class="n">CS_COMPLETE</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_process_completed_request</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validate handle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">];</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3017</span><span class="p">,</span>
		    <span class="s">&quot;Invalid status handle (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3018</span><span class="p">,</span>
		    <span class="s">&quot;Command already returned (0x%x/%p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sts</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

  	<span class="n">lscsi_status</span> <span class="o">=</span> <span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">STATUS_MASK</span><span class="p">;</span>

	<span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>

	<span class="n">ox_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">par_sense_len</span> <span class="o">=</span> <span class="n">rsp_info_len</span> <span class="o">=</span> <span class="n">resid_len</span> <span class="o">=</span>
	    <span class="n">fw_resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_SENSE_LEN_VALID</span><span class="p">)</span>
			<span class="n">sense_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_RESPONSE_INFO_LEN_VALID</span><span class="p">)</span>
			<span class="n">rsp_info_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">rsp_data_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SS_RESIDUAL_UNDER</span> <span class="o">|</span> <span class="n">SS_RESIDUAL_OVER</span><span class="p">))</span>
			<span class="n">resid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">rsp_residual_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">==</span> <span class="n">CS_DATA_UNDERRUN</span><span class="p">)</span>
			<span class="n">fw_resid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">residual_len</span><span class="p">);</span>
		<span class="n">rsp_info</span> <span class="o">=</span> <span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">sense_data</span> <span class="o">=</span> <span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">host_to_fcp_swap</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">ox_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">);</span>
		<span class="n">par_sense_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sts24</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_SENSE_LEN_VALID</span><span class="p">)</span>
			<span class="n">sense_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">req_sense_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_RESPONSE_INFO_LEN_VALID</span><span class="p">)</span>
			<span class="n">rsp_info_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">rsp_info_len</span><span class="p">);</span>
		<span class="n">resid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">residual_length</span><span class="p">);</span>
		<span class="n">rsp_info</span> <span class="o">=</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">rsp_info</span><span class="p">;</span>
		<span class="n">sense_data</span> <span class="o">=</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">req_sense_data</span><span class="p">;</span>
		<span class="n">par_sense_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">req_sense_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check for any FCP transport errors. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_RESPONSE_INFO_LEN_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sense data lies beyond any FCP RESPONSE data. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sense_data</span> <span class="o">+=</span> <span class="n">rsp_info_len</span><span class="p">;</span>
			<span class="n">par_sense_len</span> <span class="o">-=</span> <span class="n">rsp_info_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp_info_len</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">rsp_info</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3019</span><span class="p">,</span>
			    <span class="s">&quot;FCP I/O protocol failure (0x%x/0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">rsp_info_len</span><span class="p">,</span> <span class="n">rsp_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check for overrun. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">comp_status</span> <span class="o">==</span> <span class="n">CS_COMPLETE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_RESIDUAL_OVER</span><span class="p">)</span>
		<span class="n">comp_status</span> <span class="o">=</span> <span class="n">CS_DATA_OVERRUN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Based on Host and scsi status generate status code for Linux</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">comp_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS_COMPLETE</span>:
	<span class="k">case</span> <span class="n">CS_QUEUE_FULL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SS_RESIDUAL_UNDER</span> <span class="o">|</span> <span class="n">SS_RESIDUAL_OVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">resid</span> <span class="o">=</span> <span class="n">resid_len</span><span class="p">;</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lscsi_status</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">-</span> <span class="n">resid</span><span class="p">)</span> <span class="o">&lt;</span>
			     <span class="n">cp</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x301a</span><span class="p">,</span>
				    <span class="s">&quot;Mid-layer underflow &quot;</span>
				    <span class="s">&quot;detected (0x%x of 0x%x bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">resid</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

				<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lscsi_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lscsi_status</span> <span class="o">==</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x301b</span><span class="p">,</span>
			    <span class="s">&quot;QUEUE FULL detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">logit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lscsi_status</span> <span class="o">!=</span> <span class="n">SS_CHECK_CONDITION</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_SENSE_LEN_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">qla2x00_handle_sense</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">par_sense_len</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span>
		    <span class="n">rsp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_DATA_UNDERRUN</span>:
		<span class="cm">/* Use F/W calculated residual length. */</span>
		<span class="n">resid</span> <span class="o">=</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="n">fw_resid_len</span> <span class="o">:</span> <span class="n">resid_len</span><span class="p">;</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_RESIDUAL_UNDER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fw_resid_len</span> <span class="o">!=</span> <span class="n">resid_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x301d</span><span class="p">,</span>
				    <span class="s">&quot;Dropped frame(s) detected &quot;</span>
				    <span class="s">&quot;(0x%x of 0x%x bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">resid</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

				<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lscsi_status</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">check_scsi_status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lscsi_status</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">-</span> <span class="n">resid</span><span class="p">)</span> <span class="o">&lt;</span>
			    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x301e</span><span class="p">,</span>
				    <span class="s">&quot;Mid-layer underflow &quot;</span>
				    <span class="s">&quot;detected (0x%x of 0x%x bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">resid</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

				<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lscsi_status</span> <span class="o">!=</span> <span class="n">SAM_STAT_TASK_SET_FULL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">lscsi_status</span> <span class="o">!=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * scsi status of task set and busy are considered to be</span>
<span class="cm">			 * task not completed.</span>
<span class="cm">			 */</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x301f</span><span class="p">,</span>
			    <span class="s">&quot;Dropped frame(s) detected (0x%x &quot;</span>
			    <span class="s">&quot;of 0x%x bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span>
			    <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lscsi_status</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">check_scsi_status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3030</span><span class="p">,</span>
			    <span class="s">&quot;scsi_status: 0x%x, lscsi_status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">scsi_status</span><span class="p">,</span> <span class="n">lscsi_status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lscsi_status</span><span class="p">;</span>
		<span class="n">logit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">check_scsi_status:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check to see if SCSI Status is non zero. If so report SCSI</span>
<span class="cm">		 * Status.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lscsi_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lscsi_status</span> <span class="o">==</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3020</span><span class="p">,</span>
				    <span class="s">&quot;QUEUE FULL detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">logit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lscsi_status</span> <span class="o">!=</span> <span class="n">SS_CHECK_CONDITION</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SS_SENSE_LEN_VALID</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">qla2x00_handle_sense</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">par_sense_len</span><span class="p">,</span>
			    <span class="n">sense_len</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_PORT_LOGGED_OUT</span>:
	<span class="k">case</span> <span class="n">CS_PORT_CONFIG_CHG</span>:
	<span class="k">case</span> <span class="n">CS_PORT_BUSY</span>:
	<span class="k">case</span> <span class="n">CS_INCOMPLETE</span>:
	<span class="k">case</span> <span class="n">CS_PORT_UNAVAILABLE</span>:
	<span class="k">case</span> <span class="n">CS_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">CS_RESET</span>:

		<span class="cm">/*</span>
<span class="cm">		 * We are going to have the fc class block the rport</span>
<span class="cm">		 * while we try to recover so instruct the mid layer</span>
<span class="cm">		 * to requeue until the class decides how to handle this.</span>
<span class="cm">		 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_TRANSPORT_DISRUPTED</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">==</span> <span class="n">CS_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">status_flags</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">SF_LOGOUT_SENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3021</span><span class="p">,</span>
		    <span class="s">&quot;Port down status: port-state=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_ONLINE</span><span class="p">)</span>
			<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_ABORTED</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_DIF_ERROR</span>:
		<span class="n">logit</span> <span class="o">=</span> <span class="n">qla2x00_handle_dif_error</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sts24</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logit</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_io</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3022</span><span class="p">,</span>
		    <span class="s">&quot;FCP command status: 0x%x-0x%x (0x%x) &quot;</span>
		    <span class="s">&quot;nexus=%ld:%d:%d portid=%02x%02x%02x oxid=0x%x &quot;</span>
		    <span class="s">&quot;cdb=%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x len=0x%x &quot;</span>
		    <span class="s">&quot;rsp_info=0x%x resid=0x%x fw_resid=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">comp_status</span><span class="p">,</span> <span class="n">scsi_status</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">ox_id</span><span class="p">,</span>
		    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="n">rsp_info_len</span><span class="p">,</span>
		    <span class="n">resid_len</span><span class="p">,</span> <span class="n">fw_resid_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_status_cont_entry() - Process a Status Continuations entry.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @pkt: Entry pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Extended sense data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_status_cont_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="n">sts_cont_entry_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span>	<span class="n">sense_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status_srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sense_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span> <span class="o">||</span> <span class="o">!</span><span class="n">GET_CMD_SENSE_LEN</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">GET_CMD_SENSE_LEN</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">sense_ptr</span> <span class="o">=</span> <span class="n">GET_CMD_SENSE_PTR</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x3025</span><span class="p">,</span>
		    <span class="s">&quot;cmd is NULL: already returned to OS (sp=%p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>

		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="n">sense_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sense_sz</span> <span class="o">=</span> <span class="n">sense_len</span><span class="p">;</span>

	<span class="cm">/* Move sense data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">host_to_fcp_swap</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sense_ptr</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sense_sz</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_io</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x302c</span><span class="p">,</span>
		<span class="n">sense_ptr</span><span class="p">,</span> <span class="n">sense_sz</span><span class="p">);</span>

	<span class="n">sense_len</span> <span class="o">-=</span> <span class="n">sense_sz</span><span class="p">;</span>
	<span class="n">sense_ptr</span> <span class="o">+=</span> <span class="n">sense_sz</span><span class="p">;</span>

	<span class="n">SET_CMD_SENSE_PTR</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sense_ptr</span><span class="p">);</span>
	<span class="n">SET_CMD_SENSE_LEN</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>

	<span class="cm">/* Place command on done queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_error_entry() - Process an error entry.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @pkt: Entry pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_error_entry</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="n">sts_entry_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">func</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ERROR-IOCB&quot;</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">que</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x502a</span><span class="p">,</span>
	    <span class="s">&quot;type of error status in response: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">que</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">fatal</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;</span> <span class="n">RF_BUSY</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp_from_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">fatal:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5030</span><span class="p">,</span>
	    <span class="s">&quot;Error entry - invalid handle/queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_mbx_completion() - Process mailbox command completions.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @mb0: Mailbox0 register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_mbx_completion</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">mb0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">mboxes</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="cm">/* Read all mbox registers? */</span>
	<span class="n">mboxes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x504e</span><span class="p">,</span> <span class="s">&quot;MBX pointer ERRROR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mboxes</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span><span class="p">;</span>

	<span class="cm">/* Load return mailbox registers. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb0</span><span class="p">;</span>
	<span class="n">mboxes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mboxes</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">wptr</span><span class="p">);</span>

		<span class="n">mboxes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_process_response_queue() - Process response queue entries.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qla24xx_process_response_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>

		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_error_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="p">(</span><span class="n">sts_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">);</span>

			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">qlt_24xx_process_response_error</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>

			<span class="p">((</span><span class="n">response_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">;</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATUS_TYPE</span>:
			<span class="n">qla2x00_status_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STATUS_CONT_TYPE</span>:
			<span class="n">qla2x00_status_cont_entry</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="p">(</span><span class="n">sts_cont_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VP_RPT_ID_IOCB_TYPE</span>:
			<span class="n">qla24xx_report_id_acquisition</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">vp_rpt_id_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LOGINOUT_PORT_IOCB_TYPE</span>:
			<span class="n">qla24xx_logio_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TSK_MGMT_IOCB_TYPE</span>:
			<span class="n">qla24xx_tm_iocb_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">tsk_mgmt_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">CT_IOCB_TYPE</span>:
			<span class="n">qla24xx_els_ct_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">CT_IOCB_TYPE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">ELS_IOCB_TYPE</span>:
			<span class="n">qla24xx_els_ct_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">ELS_IOCB_TYPE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ABTS_RECV_24XX</span>:
			<span class="cm">/* ensure that the ATIO queue is empty */</span>
			<span class="n">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">ABTS_RESP_24XX</span>:
		<span class="k">case</span> <span class="n">CTIO_TYPE7</span>:
		<span class="k">case</span> <span class="n">NOTIFY_ACK_TYPE</span>:
			<span class="n">qlt_response_pkt_all_vps</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="n">response_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MARKER_TYPE</span>:
			<span class="cm">/* Do nothing in this case, this check is to prevent it</span>
<span class="cm">			 * from falling into default case</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Type Not Supported. */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5042</span><span class="p">,</span>
			    <span class="s">&quot;Received unknown response pkt type %x &quot;</span>
			    <span class="s">&quot;entry status=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">((</span><span class="n">response_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust ring index */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_check_risc_status</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_addr</span><span class="p">,</span> <span class="mh">0x7C00</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_addr</span><span class="p">);</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">next_test</span><span class="p">;</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">next_test:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_c8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_3</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x504c</span><span class="p">,</span>
		    <span class="s">&quot;Additional code -- 0x55AA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iobase_window</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_intr_handler() - Process interrupts for the ISP23xx and ISP24xx.</span>
<span class="cm"> * @irq:</span>
<span class="cm"> * @dev_id: SCSI driver HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Called by system whenever the host adapter generates an interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns handled flag.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span>
<span class="nf">qla24xx_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">iter</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">stat</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">hccr</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x5059</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">iter</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_PAUSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">hccr</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x504b</span><span class="p">,</span>
			    <span class="s">&quot;RISC paused -- HCCR=%x, Dumping firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">hccr</span><span class="p">);</span>

			<span class="n">qla2xxx_check_risc_status</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">case</span> <span class="mh">0x10</span>:
		<span class="k">case</span> <span class="mh">0x11</span>:
			<span class="n">qla24xx_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">);</span>
			<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>:
		<span class="k">case</span> <span class="mh">0x14</span>:
			<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1C</span>: <span class="cm">/* ATIO queue updated */</span>
			<span class="n">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1D</span>: <span class="cm">/* ATIO and response queues updated */</span>
			<span class="n">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x504f</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span> <span class="o">*</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_RISC_INT</span><span class="p">);</span>
		<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MBX_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">qla24xx_msix_rsp_q</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x505a</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_msix_handshake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_RISC_INT</span><span class="p">);</span>
		<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">qla25xx_msix_rsp_q</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x505b</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Clear the interrupt, if enabled, for this response queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_msix_handshake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_RISC_INT</span><span class="p">);</span>
		<span class="n">RD_REG_DWORD_RELAXED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">queue_work_on</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">q_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">qla24xx_msix_default</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">stat</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">hccr</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x505c</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_PAUSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">hccr</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5050</span><span class="p">,</span>
			    <span class="s">&quot;RISC paused -- HCCR=%x, Dumping firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">hccr</span><span class="p">);</span>

			<span class="n">qla2xxx_check_risc_status</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">case</span> <span class="mh">0x10</span>:
		<span class="k">case</span> <span class="mh">0x11</span>:
			<span class="n">qla24xx_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">);</span>
			<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>:
		<span class="k">case</span> <span class="mh">0x14</span>:
			<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1C</span>: <span class="cm">/* ATIO queue updated */</span>
			<span class="n">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1D</span>: <span class="cm">/* ATIO and response queues updated */</span>
			<span class="n">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5051</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_RISC_INT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MBX_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handling helpers. */</span>

<span class="k">struct</span> <span class="n">qla_init_msix_entry</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_init_msix_entry</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;qla2xxx (default)&quot;</span><span class="p">,</span> <span class="n">qla24xx_msix_default</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;qla2xxx (rsp_q)&quot;</span><span class="p">,</span> <span class="n">qla24xx_msix_rsp_q</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;qla2xxx (multiq)&quot;</span><span class="p">,</span> <span class="n">qla25xx_msix_rsp_q</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_init_msix_entry</span> <span class="n">qla82xx_msix_entries</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;qla2xxx (default)&quot;</span><span class="p">,</span> <span class="n">qla82xx_msix_default</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;qla2xxx (rsp_q)&quot;</span><span class="p">,</span> <span class="n">qla82xx_msix_rsp_q</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_disable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_msix_entry</span> <span class="o">*</span><span class="n">qentry</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qentry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">have_irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">qentry</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span>
	    <span class="s">&quot;Disabled the MSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define MIN_MSIX_COUNT	2</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_msix_entry</span> <span class="o">*</span><span class="n">qentry</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">)</span> <span class="o">*</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00bc</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for msix_entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">MIN_MSIX_COUNT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">msix_failed</span><span class="p">;</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c6</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X: Failed to enable support &quot;</span>
		    <span class="s">&quot;-- %d/%d</span><span class="se">\n</span><span class="s"> Retry with %d vectors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">msix_failed:</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c7</span><span class="p">,</span>
			    <span class="s">&quot;MSI-X: Failed to enable support, &quot;</span>
			    <span class="s">&quot;giving   up -- %d/%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">msix_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_msix_entry</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c8</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for ha-&gt;msix_entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">msix_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qentry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">have_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable MSI-X vectors for the base queue */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qentry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span>
				<span class="n">qla82xx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">qla82xx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span>
				<span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00cb</span><span class="p">,</span>
			    <span class="s">&quot;MSI-X: unable to register handler -- %x/%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">qentry</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">qla24xx_disable_msix</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">msix_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">have_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span> <span class="o">=</span> <span class="n">qentry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable MSI-X vector for response queue update for queue 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msixbase</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xc005</span><span class="p">,</span>
	    <span class="s">&quot;mqiobase=%p, max_rsp_queues=%d, max_req_queues=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0055</span><span class="p">,</span>
	    <span class="s">&quot;mqiobase=%p, max_rsp_queues=%d, max_req_queues=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>

<span class="nl">msix_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_request_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* If possible, enable MSI-X. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2432</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2532</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA8432</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_msi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_HP</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x7040</span> <span class="o">||</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x7041</span> <span class="o">||</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x1705</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X: Unsupported ISP 2432 SSVID/SSDID (0x%X,0x%X).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_msi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2432</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">QLA_MSIX_CHIP_REV_24XX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X; Unsupported ISP2432 (0x%X, 0x%X).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">QLA_MSIX_CHIP_REV_24XX</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_msix</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_enable_msix</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X: Enabled (0x%X, 0x%X).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">chip_revision</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clear_risc_ints</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">,</span>
	    <span class="s">&quot;MSI-X Falling back-to MSI mode -%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="nl">skip_msix:</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA24XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2532</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA8432</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_QLA8001</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_msi</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span>
		    <span class="s">&quot;MSI: Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msi_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0039</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X; Falling back-to INTa mode -- %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="nl">skip_msi:</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">intr_handler</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msi_enabled</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
	    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">,</span>
		    <span class="s">&quot;Failed to reserve interrupt %d already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">clear_risc_ints:</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Noted that 8014s were being dropped during NK testing.</span>
<span class="cm">	 * Timing deltas during MSI-X/INTa transitions?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_HOST_INT</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_RISC_INT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">.</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_RISC_INT</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_HOST_INT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_free_irqs</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to check that ha-&gt;rsp_q_map is valid in case we are called</span>
<span class="cm">	 * from a probe failure context.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">qla24xx_disable_msix</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">qla25xx_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_init_msix_entry</span> <span class="o">*</span><span class="n">intr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_msix_entry</span> <span class="o">*</span><span class="n">msix</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">intr</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00e6</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X: Unable to register handler -- %x/%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msix</span><span class="o">-&gt;</span><span class="n">have_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msix</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
