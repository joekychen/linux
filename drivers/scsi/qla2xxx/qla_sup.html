<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_sup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_sup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * NVRAM support routines</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_lock_nvram_access() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_lock_nvram_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">NVR_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Lock resource */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Lock failed */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_unlock_nvram_access() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_unlock_nvram_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2300</span><span class="p">.</span><span class="n">host_semaphore</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_nv_write() - Prepare for NVRAM read/write operation.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @data: Serial interface selector</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_nv_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">NVR_SELECT</span> <span class="o">|</span> <span class="n">NVR_WRT_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">NVR_SELECT</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span> <span class="o">|</span>
	    <span class="n">NVR_WRT_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">NVR_SELECT</span> <span class="o">|</span> <span class="n">NVR_WRT_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_nvram_request() - Sends read command to NVRAM and gets data from</span>
<span class="cm"> *	NVRAM.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @nv_cmd: NVRAM command</span>
<span class="cm"> *</span>
<span class="cm"> * Bit definitions for NVRAM command:</span>
<span class="cm"> *</span>
<span class="cm"> *	Bit 26     = start bit</span>
<span class="cm"> *	Bit 25, 24 = opcode</span>
<span class="cm"> *	Bit 23-16  = address</span>
<span class="cm"> *	Bit 15-0   = write data</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the word read from nvram @addr.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint16_t</span>
<span class="nf">qla2x00_nvram_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">nv_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span>		<span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">reg_data</span><span class="p">;</span>

	<span class="cm">/* Send command to NVRAM. */</span>
	<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_cmd</span> <span class="o">&amp;</span> <span class="n">BIT_31</span><span class="p">)</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read data from NVRAM. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
		<span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg_data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_data</span> <span class="o">&amp;</span> <span class="n">NVR_DATA_IN</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Deselect chip. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_DESELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * qla2x00_get_nvram_word() - Calculates word position in NVRAM and calls the</span>
<span class="cm"> *	request routine to get the word from NVRAM.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Address in NVRAM to read</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the word read from nvram @addr.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint16_t</span>
<span class="nf">qla2x00_get_nvram_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">nv_cmd</span><span class="p">;</span>

	<span class="n">nv_cmd</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">nv_cmd</span> <span class="o">|=</span> <span class="n">NV_READ_OP</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">qla2x00_nvram_request</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nv_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_nv_deselect() - Deselect NVRAM operations.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_nv_deselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_DESELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_write_nvram_word() - Write NVRAM data.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Address in NVRAM to write</span>
<span class="cm"> * @data: word to program</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_write_nvram_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">nv_cmd</span><span class="p">,</span> <span class="n">wait_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Write data */</span>
	<span class="n">nv_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">NV_WRITE_OP</span><span class="p">;</span>
	<span class="n">nv_cmd</span> <span class="o">|=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_cmd</span> <span class="o">&amp;</span> <span class="n">BIT_31</span><span class="p">)</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Wait for NVRAM to become ready */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">wait_cnt</span> <span class="o">=</span> <span class="n">NVR_WAIT_CNT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">wait_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x708d</span><span class="p">,</span>
			    <span class="s">&quot;NVRAM didn&#39;t go ready...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">NVR_DATA_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Disable writes */</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_write_nvram_word_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">tmo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">nv_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Write data */</span>
	<span class="n">nv_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">NV_WRITE_OP</span><span class="p">;</span>
	<span class="n">nv_cmd</span> <span class="o">|=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_cmd</span> <span class="o">&amp;</span> <span class="n">BIT_31</span><span class="p">)</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Wait for NVRAM to become ready */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">tmo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">NVR_DATA_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Disable writes */</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_clear_nvram_protection() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_clear_nvram_protection</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">word</span><span class="p">,</span> <span class="n">wait_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">wprot</span><span class="p">,</span> <span class="n">wprot_old</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Clear NVRAM write protection. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">wprot_old</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qla2x00_get_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">));</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">qla2x00_write_nvram_word_tmo</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">,</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">),</span> <span class="mi">100000</span><span class="p">);</span>
	<span class="n">wprot</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qla2x00_get_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span> <span class="o">||</span> <span class="n">wprot</span> <span class="o">!=</span> <span class="mh">0x1234</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write enable. */</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>

		<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="cm">/* Enable protection register. */</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span> <span class="o">|</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>

		<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="cm">/* Clear protection register (ffff is cleared). */</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span> <span class="o">|</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>

		<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="cm">/* Wait for NVRAM to become ready. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
		<span class="n">wait_cnt</span> <span class="o">=</span> <span class="n">NVR_WAIT_CNT</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">wait_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x708e</span><span class="p">,</span>
				    <span class="s">&quot;NVRAM didn&#39;t go ready...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">NVRAM_DELAY</span><span class="p">();</span>
			<span class="n">word</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">NVR_DATA_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wait_cnt</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qla2x00_write_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">,</span> <span class="n">wprot_old</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_set_nvram_protection</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">word</span><span class="p">,</span> <span class="n">wait_cnt</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set NVRAM write protection. */</span>
	<span class="cm">/* Write enable. */</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Enable protection register. */</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_DATA_OUT</span> <span class="o">|</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Enable protection register. */</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>
	<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span> <span class="o">|</span> <span class="n">NVR_DATA_OUT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla2x00_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NVR_PR_ENABLE</span><span class="p">);</span>

	<span class="n">qla2x00_nv_deselect</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Wait for NVRAM to become ready. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">wait_cnt</span> <span class="o">=</span> <span class="n">NVR_WAIT_CNT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">wait_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x708f</span><span class="p">,</span>
			    <span class="s">&quot;NVRAM didn&#39;t go ready...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">NVR_DATA_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* Flash Manipulation Routines                                               */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">flash_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">|</span> <span class="n">faddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">flash_data_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">|</span> <span class="n">faddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">nvram_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_conf_off</span> <span class="o">|</span> <span class="n">naddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">nvram_data_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_data_off</span> <span class="o">|</span> <span class="n">naddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">qla24xx_read_flash_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FARX_DATA_FLAG</span><span class="p">);</span>
	<span class="cm">/* Wait for READ cycle to complete. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	    <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FARX_DATA_FLAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: What happens if we time out? */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mh">0xDEADDEAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="o">*</span>
<span class="nf">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">dwords</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Dword reads to flash. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwords</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">faddr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dwptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qla24xx_read_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">dwptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_write_flash_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">|</span> <span class="n">FARX_DATA_FLAG</span><span class="p">);</span>
	<span class="cm">/* Wait for Write cycle to complete. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FARX_DATA_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_get_flash_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">man_id</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">flash_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ids</span><span class="p">;</span>

	<span class="n">ids</span> <span class="o">=</span> <span class="n">qla24xx_read_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x03ab</span><span class="p">));</span>
	<span class="o">*</span><span class="n">man_id</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span>
	<span class="o">*</span><span class="n">flash_id</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span>

	<span class="cm">/* Check if man_id and flash_id are valid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ids</span> <span class="o">!=</span> <span class="mh">0xDEADDEAD</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">man_id</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Read information using 0x9f opcode</span>
<span class="cm">		 * Device ID, Mfg ID would be read in the format:</span>
<span class="cm">		 *   &lt;Ext Dev Info&gt;&lt;Device ID Part2&gt;&lt;Device ID Part 1&gt;&lt;Mfg ID&gt;</span>
<span class="cm">		 * Example: ATMEL 0x00 01 45 1F</span>
<span class="cm">		 * Extract MFG and Dev ID from last two bytes.</span>
<span class="cm">		 */</span>
		<span class="n">ids</span> <span class="o">=</span> <span class="n">qla24xx_read_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">));</span>
		<span class="o">*</span><span class="n">man_id</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span>
		<span class="o">*</span><span class="n">flash_id</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_find_flt_start</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;DEF&quot;</span><span class="p">,</span> <span class="s">&quot;PCI&quot;</span> <span class="p">};</span>
	<span class="kt">uint32_t</span> <span class="n">pcihdr</span><span class="p">,</span> <span class="n">pcids</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dcode</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">bcode</span><span class="p">,</span> <span class="n">last_image</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">chksum</span><span class="p">,</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_flt_location</span> <span class="o">*</span><span class="n">fltl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * FLT-location structure resides after the last PCI region.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Begin with sane defaults. */</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">FA_FLASH_LAYOUT_ADDR_24</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">FA_FLASH_LAYOUT_ADDR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">FA_FLASH_LAYOUT_ADDR_81</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">FA_FLASH_LAYOUT_ADDR_82</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">FA_FLASH_LAYOUT_ADDR_83</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Begin with first PCI expansion ROM header. */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">dcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">pcihdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_image</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Verify PCI expansion ROM header. */</span>
		<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">pcihdr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">bcode</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">pcihdr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x55</span> <span class="o">||</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="cm">/* Locate PCI data structure. */</span>
		<span class="n">pcids</span> <span class="o">=</span> <span class="n">pcihdr</span> <span class="o">+</span> <span class="p">((</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]);</span>
		<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">bcode</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">pcihdr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Validate signature of PCI data structure. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;C&#39;</span> <span class="o">||</span>
		    <span class="n">bcode</span><span class="p">[</span><span class="mh">0x2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="n">last_image</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">;</span>

		<span class="cm">/* Locate next PCI expansion ROM. */</span>
		<span class="n">pcihdr</span> <span class="o">+=</span> <span class="p">((</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x10</span><span class="p">])</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last_image</span><span class="p">);</span>

	<span class="cm">/* Now verify FLT-location structure. */</span>
	<span class="n">fltl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_location</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">pcihdr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_location</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fltl</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;Q&#39;</span> <span class="o">||</span> <span class="n">fltl</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;F&#39;</span> <span class="o">||</span>
	    <span class="n">fltl</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;L&#39;</span> <span class="o">||</span> <span class="n">fltl</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_location</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent FLTL detected: checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chksum</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x010e</span><span class="p">,</span>
		    <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_location</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Good data.  Use specified location. */</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fltl</span><span class="o">-&gt;</span><span class="n">start_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fltl</span><span class="o">-&gt;</span><span class="n">start_lo</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="nl">end:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span>
	    <span class="s">&quot;FLTL[%s] = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_get_flt_info</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">flt_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;DEF&quot;</span><span class="p">,</span> <span class="s">&quot;FLT&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_fw</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_RISC_CODE_ADDR</span><span class="p">,</span> <span class="n">FA_RISC_CODE_ADDR</span><span class="p">,</span> <span class="n">FA_RISC_CODE_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_boot</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_BOOT_CODE_ADDR</span><span class="p">,</span> <span class="n">FA_BOOT_CODE_ADDR</span><span class="p">,</span> <span class="n">FA_BOOT_CODE_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_vpd_nvram</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_VPD_NVRAM_ADDR</span><span class="p">,</span> <span class="n">FA_VPD_NVRAM_ADDR</span><span class="p">,</span> <span class="n">FA_VPD_NVRAM_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_vpd0</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FA_VPD0_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_vpd1</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FA_VPD1_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_nvram0</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FA_NVRAM0_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_nvram1</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FA_NVRAM1_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_fdt</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_FLASH_DESCR_ADDR_24</span><span class="p">,</span> <span class="n">FA_FLASH_DESCR_ADDR</span><span class="p">,</span>
			<span class="n">FA_FLASH_DESCR_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_npiv_conf0</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_NPIV_CONF0_ADDR_24</span><span class="p">,</span> <span class="n">FA_NPIV_CONF0_ADDR</span><span class="p">,</span>
			<span class="n">FA_NPIV_CONF0_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">def_npiv_conf1</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_NPIV_CONF1_ADDR_24</span><span class="p">,</span> <span class="n">FA_NPIV_CONF1_ADDR</span><span class="p">,</span>
			<span class="n">FA_NPIV_CONF1_ADDR_81</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">fcp_prio_cfg0</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_FCP_PRIO0_ADDR</span><span class="p">,</span> <span class="n">FA_FCP_PRIO0_ADDR_25</span><span class="p">,</span>
			<span class="mi">0</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">fcp_prio_cfg1</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">FA_FCP_PRIO1_ADDR</span><span class="p">,</span> <span class="n">FA_FCP_PRIO1_ADDR_25</span><span class="p">,</span>
			<span class="mi">0</span> <span class="p">};</span>
	<span class="kt">uint32_t</span> <span class="n">def</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_flt_header</span> <span class="o">*</span><span class="n">flt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_flt_region</span> <span class="o">*</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">def</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">def</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Assign FCP prio region since older adapters may not have FLT, or</span>
<span class="cm">	   FCP prio region in it&#39;s FLT.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fcp_prio</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span> <span class="o">?</span>
	    <span class="n">fcp_prio_cfg0</span><span class="p">[</span><span class="n">def</span><span class="p">]</span> <span class="o">:</span> <span class="n">fcp_prio_cfg1</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_flt</span> <span class="o">=</span> <span class="n">flt_addr</span><span class="p">;</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">flt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">region</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_region</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">flt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
	    <span class="n">flt_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0047</span><span class="p">,</span>
		    <span class="s">&quot;Unsupported FLT detected: version=0x%x length=0x%x checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent FLT detected: version=0x%x length=0x%x checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_region</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">,</span> <span class="n">region</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Store addresses as DWORD offsets. */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0049</span><span class="p">,</span>
		    <span class="s">&quot;FLT[%02x]: start=0x%x &quot;</span>
		    <span class="s">&quot;end=0x%x size=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">),</span>
		    <span class="n">start</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCOE_FW</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FW</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_BOOT_CODE</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_VPD_0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_VPD_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_NVRAM_0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_NVRAM_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FDT</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_NPIV_CONF_0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_npiv_conf</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_NPIV_CONF_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_npiv_conf</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_GOLD_FW</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_gold_fw</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCP_PRIO_0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fcp_prio</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCP_PRIO_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fcp_prio</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_BOOT_CODE_82XX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FW_82XX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_GOLD_FW_82XX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_gold_fw</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_BOOTLOAD_82XX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_bootload</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_VPD_82XX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCOE_VPD_0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCOE_VPD_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCOE_NVRAM_0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FCOE_NVRAM_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">no_flash_data:</span>
	<span class="cm">/* Use hardcoded defaults. */</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">=</span> <span class="n">def_fw</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span> <span class="o">=</span> <span class="n">def_boot</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span> <span class="o">=</span> <span class="n">def_vpd_nvram</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span> <span class="o">?</span>
	    <span class="n">def_vpd0</span><span class="p">[</span><span class="n">def</span><span class="p">]</span> <span class="o">:</span> <span class="n">def_vpd1</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span> <span class="o">?</span>
	    <span class="n">def_nvram0</span><span class="p">[</span><span class="n">def</span><span class="p">]</span> <span class="o">:</span> <span class="n">def_nvram1</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span> <span class="o">=</span> <span class="n">def_fdt</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_npiv_conf</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span> <span class="o">?</span>
	    <span class="n">def_npiv_conf0</span><span class="p">[</span><span class="n">def</span><span class="p">]</span> <span class="o">:</span> <span class="n">def_npiv_conf1</span><span class="p">[</span><span class="n">def</span><span class="p">];</span>
<span class="nl">done:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x004a</span><span class="p">,</span>
	    <span class="s">&quot;FLT[%s]: boot=0x%x fw=0x%x vpd_nvram=0x%x vpd=0x%x nvram=0x%x &quot;</span>
	    <span class="s">&quot;fdt=0x%x flt=0x%x npiv=0x%x fcp_prif_cfg=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">loc</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_flt</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_npiv_conf</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fcp_prio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_get_fdt_info</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define FLASH_BLK_SIZE_4K	0x1000</span>
<span class="cp">#define FLASH_BLK_SIZE_32K	0x8000</span>
<span class="cp">#define FLASH_BLK_SIZE_64K	0x10000</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;MID&quot;</span><span class="p">,</span> <span class="s">&quot;FDT&quot;</span> <span class="p">};</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_fdt_layout</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">fdt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_fdt_layout</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;Q&#39;</span> <span class="o">||</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;L&#39;</span> <span class="o">||</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span>
	    <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;D&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_fdt_layout</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x004c</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent FDT detected:&quot;</span>
		    <span class="s">&quot; checksum=0x%x id=%c version0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chksum</span><span class="p">,</span>
		    <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0113</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">fdt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fdt</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">man_id</span><span class="p">);</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span> <span class="o">=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">wrt_disable_bits</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">erase_cmd</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">unprotect_sec_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span>
		    <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">unprotect_sec_cmd</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_protect_sec_cmd</span> <span class="o">=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">protect_sec_cmd</span> <span class="o">?</span>
		    <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">protect_sec_cmd</span><span class="p">)</span><span class="o">:</span>
		    <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0336</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="nl">no_flash_data:</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_64K</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qla24xx_get_flash_manufacturer</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">man_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_id</span><span class="p">);</span>
	<span class="n">mid</span> <span class="o">=</span> <span class="n">man_id</span><span class="p">;</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">flash_id</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span> <span class="o">=</span> <span class="mh">0x9c</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x03d8</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">man_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0xbf</span>: <span class="cm">/* STT flash. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x8e</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_64K</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_32K</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0352</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* ST M25P80. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_64K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1f</span>: <span class="cm">/* Atmel 26DF081A. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_4K</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0320</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0339</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_protect_sec_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0336</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Default to 64 kb sector size. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_64K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span>
	    <span class="s">&quot;FDT[%s]: (0x%x/0x%x) erase=0x%x &quot;</span>
	    <span class="s">&quot;pr=%x wrtd=0x%x blk=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">loc</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_protect_sec_cmd</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2xxx_get_idc_param</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define QLA82XX_IDC_PARAM_ADDR       0x003e885c</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
		<span class="n">QLA82XX_IDC_PARAM_ADDR</span> <span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">=</span> <span class="n">QLA82XX_ROM_DEV_INIT_TIMEOUT</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span> <span class="o">=</span> <span class="n">QLA82XX_ROM_DRV_RESET_ACK_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x004e</span><span class="p">,</span>
	    <span class="s">&quot;nx_dev_init_timeout=%d &quot;</span>
	    <span class="s">&quot;nx_reset_timeout=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2xxx_get_flash_info</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2xxx_find_flt_start</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flt_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">qla2xxx_get_flt_info</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">flt_addr</span><span class="p">);</span>
	<span class="n">qla2xxx_get_fdt_info</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla2xxx_get_idc_param</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2xxx_flash_npiv_conf</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define NPIV_CONFIG_SIZE	(16*1024)</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_npiv_header</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_npiv_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_hdlr_active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_npiv_conf</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_npiv_header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7090</span><span class="p">,</span>
		    <span class="s">&quot;Unsupported NPIV-Config &quot;</span>
		    <span class="s">&quot;detected: version=0x%x entries=0x%x checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">entries</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">checksum</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">NPIV_CONFIG_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7091</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_npiv_conf</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NPIV_CONFIG_SIZE</span><span class="p">);</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_npiv_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_npiv_entry</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7092</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent NPIV-Config &quot;</span>
		    <span class="s">&quot;detected: version=0x%x entries=0x%x checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">entries</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">checksum</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_npiv_header</span><span class="p">);</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">,</span> <span class="n">entry</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">flags</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_vport_identifiers</span> <span class="n">vid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_npiv_entry</span><span class="p">));</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vid</span><span class="p">));</span>
		<span class="n">vid</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_PORT_ROLE_FCP_INITIATOR</span><span class="p">;</span>
		<span class="n">vid</span><span class="p">.</span><span class="n">vport_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPIV</span><span class="p">;</span>
		<span class="n">vid</span><span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">vid</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
		<span class="n">vid</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7093</span><span class="p">,</span>
		    <span class="s">&quot;NPIV[%02x]: wwpn=%llx &quot;</span>
		    <span class="s">&quot;wwnn=%llx vf_id=0x%x Q_qos=0x%x F_qos=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vid</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vid</span><span class="p">.</span><span class="n">node_name</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">),</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">q_qos</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">f_qos</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLA_PRECONFIG_VPORTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vport</span> <span class="o">=</span> <span class="n">fc_vport_create</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7094</span><span class="p">,</span>
				    <span class="s">&quot;NPIV-Config Failed to create vport [%02x]: &quot;</span>
				    <span class="s">&quot;wwpn=%llx wwnn=%llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vid</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vid</span><span class="p">.</span><span class="n">node_name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_unprotect_flash</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fac_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qla81xx_fac_do_write_enable</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable flash write. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span>
	    <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">|</span> <span class="n">CSRX_FLASH_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Disable flash write-protection, first clear SR protection bit */</span>
	<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Then write zero again to clear remaining SR bits.*/</span>
	<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_protect_flash</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fac_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qla81xx_fac_do_write_enable</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_wrt_protect</span><span class="p">;</span>

	<span class="cm">/* Enable flash write-protection and wait for completion. */</span>
	<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">),</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span>
	    <span class="n">qla24xx_read_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x005</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">;</span>
	    <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">skip_wrt_protect:</span>
	<span class="cm">/* Disable flash write. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span>
	    <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSRX_FLASH_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_erase_sector</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">fdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fac_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">fdata</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">finish</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">qla81xx_fac_erase_sector</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">start</span><span class="p">),</span> <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">finish</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">fdata</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fdata</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">fdata</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_write_flash_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">dwords</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">liter</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="n">rest_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdata</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">optrom_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">optrom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Prepare burst-capable write on supported ISPs. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">faddr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dwords</span> <span class="o">&gt;</span> <span class="n">OPTROM_BURST_DWORDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">optrom</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">optrom_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optrom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7095</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate &quot;</span>
			    <span class="s">&quot;memory for optrom burst write (%x KB).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">OPTROM_BURST_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rest_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sec_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">rest_addr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_unprotect_flash</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7096</span><span class="p">,</span>
		    <span class="s">&quot;Unable to unprotect flash for update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">liter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">liter</span> <span class="o">&lt;</span> <span class="n">dwords</span><span class="p">;</span> <span class="n">liter</span><span class="o">++</span><span class="p">,</span> <span class="n">faddr</span><span class="o">++</span><span class="p">,</span> <span class="n">dwptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">faddr</span> <span class="o">&amp;</span> <span class="n">sec_mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* Are we at the beginning of a sector? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">faddr</span> <span class="o">&amp;</span> <span class="n">rest_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Do sector unprotect. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span><span class="p">)</span>
				<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">fdata</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fdata</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fdata</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_erase_sector</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fdata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7007</span><span class="p">,</span>
				    <span class="s">&quot;Unable to erase erase sector: address=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">faddr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Go with burst-write. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optrom</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">liter</span> <span class="o">+</span> <span class="n">OPTROM_BURST_DWORDS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dwords</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Copy data to DMA&#39;ble buffer. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">optrom</span><span class="p">,</span> <span class="n">dwptr</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_load_ram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">,</span>
			    <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">),</span>
			    <span class="n">OPTROM_BURST_DWORDS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7097</span><span class="p">,</span>
				    <span class="s">&quot;Unable to burst-write optrom segment &quot;</span>
				    <span class="s">&quot;(%x/%x/%llx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
				    <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">),</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">optrom_dma</span><span class="p">);</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7098</span><span class="p">,</span>
				    <span class="s">&quot;Reverting to slow-write.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span> <span class="n">optrom</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">);</span>
				<span class="n">optrom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">liter</span> <span class="o">+=</span> <span class="n">OPTROM_BURST_DWORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">faddr</span> <span class="o">+=</span> <span class="n">OPTROM_BURST_DWORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dwptr</span> <span class="o">+=</span> <span class="n">OPTROM_BURST_DWORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">),</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">dwptr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7006</span><span class="p">,</span>
			    <span class="s">&quot;Unable to program flash address=%x data=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">faddr</span><span class="p">,</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Do sector protect. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">faddr</span> <span class="o">&amp;</span> <span class="n">rest_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">rest_addr</span><span class="p">))</span>
			<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_protect_sec_cmd</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">fdata</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fdata</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fdata</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_protect_flash</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7099</span><span class="p">,</span>
		    <span class="s">&quot;Unable to protect flash after update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optrom</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span> <span class="n">optrom</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla2x00_read_nvram_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Word reads to NVRAM via registers. */</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">qla2x00_lock_nvram_access</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">naddr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qla2x00_get_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">naddr</span><span class="p">));</span>
	<span class="n">qla2x00_unlock_nvram_access</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla24xx_read_nvram_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span>  <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Dword reads to flash. */</span>
	<span class="n">dwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">naddr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dwptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qla24xx_read_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">nvram_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">naddr</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_write_nvram_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qla2x00_lock_nvram_access</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Disable NVRAM write-protection. */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">qla2x00_clear_nvram_protection</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">naddr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_write_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">naddr</span><span class="p">,</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="p">));</span>
		<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable NVRAM write-protection. */</span>
	<span class="n">qla2x00_set_nvram_protection</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="n">qla2x00_unlock_nvram_access</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_write_nvram_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Enable flash write. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span>
	    <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">|</span> <span class="n">CSRX_FLASH_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

	<span class="cm">/* Disable NVRAM write-protection. */</span>
	<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nvram_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nvram_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Dword writes to flash. */</span>
	<span class="n">dwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">naddr</span><span class="o">++</span><span class="p">,</span> <span class="n">dwptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">nvram_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">naddr</span><span class="p">),</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">dwptr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x709a</span><span class="p">,</span>
			    <span class="s">&quot;Unable to program nvram address=%x data=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">naddr</span><span class="p">,</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable NVRAM write-protection. */</span>
	<span class="n">qla24xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nvram_conf_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">),</span> <span class="mh">0x8c</span><span class="p">);</span>

	<span class="cm">/* Disable flash write. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span>
	    <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSRX_FLASH_ENABLE</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla25xx_read_nvram_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Dword reads to flash. */</span>
	<span class="n">dwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">naddr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dwptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qla24xx_read_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span> <span class="o">|</span> <span class="n">naddr</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla25xx_write_nvram_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">naddr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
<span class="cp">#define RMW_BUFFER_SIZE	(64 * 1024)</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dbuf</span><span class="p">;</span>

	<span class="n">dbuf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">RMW_BUFFER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dbuf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="n">RMW_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">naddr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">write_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dbuf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd_nvram</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="n">RMW_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">dbuf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_flip_colors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">pflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Flip all colors. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">==</span> <span class="n">QLA_LED_ALL_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Turn off. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="n">GPIO_LED_ALL_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Turn on. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="n">QLA_LED_ALL_ON</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="n">GPIO_LED_RGA_ON</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Flip green led only. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">==</span> <span class="n">QLA_LED_GRN_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Turn off. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="n">GPIO_LED_GREEN_OFF_AMBER_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Turn on. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="n">QLA_LED_GRN_ON</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="n">GPIO_LED_GREEN_ON_AMBER_OFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define PIO_REG(h, r) ((h)-&gt;pio_address + offsetof(struct device_reg_2xxx, r))</span>

<span class="kt">void</span>
<span class="nf">qla2x00_beacon_blink</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">gpio_enable</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">led_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Save the Original GPIOE. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_enable</span> <span class="o">=</span> <span class="n">RD_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpioe</span><span class="p">));</span>
		<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpiod</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gpio_enable</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpioe</span><span class="p">);</span>
		<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the modified gpio_enable values */</span>
	<span class="n">gpio_enable</span> <span class="o">|=</span> <span class="n">GPIO_LED_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpioe</span><span class="p">),</span> <span class="n">gpio_enable</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpioe</span><span class="p">,</span> <span class="n">gpio_enable</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpioe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla2x00_flip_colors</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_color</span><span class="p">);</span>

	<span class="cm">/* Clear out any previously set LED color. */</span>
	<span class="n">gpio_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_LED_MASK</span><span class="p">;</span>

	<span class="cm">/* Set the new input LED color to GPIOD. */</span>
	<span class="n">gpio_data</span> <span class="o">|=</span> <span class="n">led_color</span><span class="p">;</span>

	<span class="cm">/* Set the modified gpio_data values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpiod</span><span class="p">),</span> <span class="n">gpio_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">,</span> <span class="n">gpio_data</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_beacon_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">gpio_enable</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FO1_SET_EMPHASIS_SWING</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">FO1_DISABLE_GPIO6_7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x709b</span><span class="p">,</span>
		    <span class="s">&quot;Unable to update fw options (beacon on).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn off LEDs. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_enable</span> <span class="o">=</span> <span class="n">RD_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpioe</span><span class="p">));</span>
		<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpiod</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gpio_enable</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpioe</span><span class="p">);</span>
		<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gpio_enable</span> <span class="o">|=</span> <span class="n">GPIO_LED_MASK</span><span class="p">;</span>

	<span class="cm">/* Set the modified gpio_enable values. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpioe</span><span class="p">),</span> <span class="n">gpio_enable</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpioe</span><span class="p">,</span> <span class="n">gpio_enable</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpioe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear out previously set LED colour. */</span>
	<span class="n">gpio_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_LED_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gpiod</span><span class="p">),</span> <span class="n">gpio_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">,</span> <span class="n">gpio_data</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let the per HBA timer kick off the blinking process based on</span>
<span class="cm">	 * the following flags. No need to do anything else now.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_beacon_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the on flag so when it gets flipped it will be off. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="n">QLA_LED_ALL_ON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="n">QLA_LED_GRN_ON</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">beacon_blink</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>	<span class="cm">/* This turns green LED off */</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FO1_SET_EMPHASIS_SWING</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FO1_DISABLE_GPIO6_7</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x709c</span><span class="p">,</span>
		    <span class="s">&quot;Unable to update fw options (beacon off).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla24xx_flip_colors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">pflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Flip all colors. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">==</span> <span class="n">QLA_LED_ALL_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn off. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Turn on. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="n">QLA_LED_ALL_ON</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pflags</span> <span class="o">=</span> <span class="n">GPDX_LED_YELLOW_ON</span> <span class="o">|</span> <span class="n">GPDX_LED_AMBER_ON</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla24xx_beacon_blink</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">led_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="cm">/* Save the Original GPIOD. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>

	<span class="cm">/* Enable the gpio_data reg for update. */</span>
	<span class="n">gpio_data</span> <span class="o">|=</span> <span class="n">GPDX_LED_UPDATE_MASK</span><span class="p">;</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">,</span> <span class="n">gpio_data</span><span class="p">);</span>
	<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>

	<span class="cm">/* Set the color bits. */</span>
	<span class="n">qla24xx_flip_colors</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_color</span><span class="p">);</span>

	<span class="cm">/* Clear out any previously set LED color. */</span>
	<span class="n">gpio_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPDX_LED_COLOR_MASK</span><span class="p">;</span>

	<span class="cm">/* Set the new input LED color to GPIOD. */</span>
	<span class="n">gpio_data</span> <span class="o">|=</span> <span class="n">led_color</span><span class="p">;</span>

	<span class="cm">/* Set the modified gpio_data values. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">,</span> <span class="n">gpio_data</span><span class="p">);</span>
	<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla83xx_beacon_blink</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">led_select_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">orig_led_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span>
			<span class="n">led_select_value</span> <span class="o">=</span> <span class="mh">0x00201320</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">led_select_value</span> <span class="o">=</span> <span class="mh">0x00201328</span><span class="p">;</span>

		<span class="n">qla83xx_write_remote_reg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">led_select_value</span><span class="p">,</span> <span class="mh">0x40002000</span><span class="p">);</span>
		<span class="n">qla83xx_write_remote_reg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">led_select_value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x40002000</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">qla83xx_write_remote_reg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">led_select_value</span><span class="p">,</span> <span class="mh">0x40004000</span><span class="p">);</span>
		<span class="n">qla83xx_write_remote_reg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">led_select_value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x40004000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

		<span class="cm">/* Save Current */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla81xx_get_led_config</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">orig_led_cfg</span><span class="p">);</span>
		<span class="cm">/* Do the blink */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla81xx_set_led_config</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">led_cfg</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">led_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla81xx_set_led_config</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">led_cfg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* On exit, restore original (presumes no status change) */</span>
		<span class="n">qla81xx_set_led_config</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">orig_led_cfg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_beacon_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_gpio</span><span class="p">;</span> <span class="cm">/* let blink handle it */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable firmware for update */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ADD_FO1_DISABLE_GPIO_LED_CTRL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_get_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7009</span><span class="p">,</span>
			    <span class="s">&quot;Unable to update fw options (beacon on).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip_gpio</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>

		<span class="cm">/* Enable the gpio_data reg for update. */</span>
		<span class="n">gpio_data</span> <span class="o">|=</span> <span class="n">GPDX_LED_UPDATE_MASK</span><span class="p">;</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">,</span> <span class="n">gpio_data</span><span class="p">);</span>
		<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* So all colors blink together. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">skip_gpio:</span>
	<span class="cm">/* Let the per HBA timer kick off the blinking process. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_beacon_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">gpio_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">set_fw_options</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_color_state</span> <span class="o">=</span> <span class="n">QLA_LED_ALL_ON</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">beacon_blink</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>	<span class="cm">/* Will flip to all off. */</span>

	<span class="cm">/* Give control back to firmware. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">gpio_data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>

	<span class="cm">/* Disable the gpio_data reg for update. */</span>
	<span class="n">gpio_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPDX_LED_UPDATE_MASK</span><span class="p">;</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">,</span> <span class="n">gpio_data</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpiod</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">set_fw_options:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADD_FO1_DISABLE_GPIO_LED_CTRL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x704d</span><span class="p">,</span>
		    <span class="s">&quot;Unable to update fw options (beacon on).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_get_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x704e</span><span class="p">,</span>
		    <span class="s">&quot;Unable to update fw options (beacon on).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Flash support routines</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_flash_enable() - Setup flash for reading and writing.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_flash_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">CSR_FLASH_ENABLE</span><span class="p">;</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_flash_disable() - Disable flash and allow RISC to run.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_flash_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_FLASH_ENABLE</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_read_flash_byte() - Reads a byte from flash</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Address in flash to read</span>
<span class="cm"> *</span>
<span class="cm"> * A word is read from the chip, but, only the lower byte is valid.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the byte read from flash @addr.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">qla2x00_read_flash_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">bank_select</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">bank_select</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Specify 64K address range: */</span>
		<span class="cm">/*  clear out Module Select and Flash Address bits [19:16]. */</span>
		<span class="n">bank_select</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf8</span><span class="p">;</span>
		<span class="n">bank_select</span> <span class="o">|=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">bank_select</span> <span class="o">|=</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">bank_select</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_address</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup bit 16 of flash address. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">BIT_16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">bank_select</span> <span class="o">&amp;</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bank_select</span> <span class="o">|=</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">bank_select</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">BIT_16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bank_select</span> <span class="o">&amp;</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bank_select</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_FLASH_64K_BANK</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">bank_select</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span>

	<span class="cm">/* Always perform IO mapped accesses to the FLASH registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">data2</span><span class="p">;</span>

		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_address</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_data</span><span class="p">));</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="n">data2</span> <span class="o">=</span> <span class="n">RD_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_data</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">data2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_address</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">qla2x00_debounce_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_write_flash_byte() - Write a byte to flash</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Address in flash to write</span>
<span class="cm"> * @data: Data to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_write_flash_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">bank_select</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">bank_select</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Specify 64K address range: */</span>
		<span class="cm">/*  clear out Module Select and Flash Address bits [19:16]. */</span>
		<span class="n">bank_select</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf8</span><span class="p">;</span>
		<span class="n">bank_select</span> <span class="o">|=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">bank_select</span> <span class="o">|=</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">bank_select</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_address</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup bit 16 of flash address. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">BIT_16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">bank_select</span> <span class="o">&amp;</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bank_select</span> <span class="o">|=</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">bank_select</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">BIT_16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bank_select</span> <span class="o">&amp;</span> <span class="n">CSR_FLASH_64K_BANK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bank_select</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_FLASH_64K_BANK</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">bank_select</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span>

	<span class="cm">/* Always perform IO mapped accesses to the FLASH registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_address</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD_PIO</span><span class="p">(</span><span class="n">PIO_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flash_data</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_address</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_poll_flash() - Polls flash for completion.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Address in flash to poll</span>
<span class="cm"> * @poll_data: Data to be polled</span>
<span class="cm"> * @man_id: Flash manufacturer ID</span>
<span class="cm"> * @flash_id: Flash ID</span>
<span class="cm"> *</span>
<span class="cm"> * This function polls the device until bit 7 of what is read matches data</span>
<span class="cm"> * bit 7 or until data bit 5 becomes a 1.  If that hapens, the flash ROM timed</span>
<span class="cm"> * out (a fatal error).  The flash book recommeds reading bit 7 again after</span>
<span class="cm"> * reading bit 5 as a 1.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, else non-zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_poll_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">poll_data</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">man_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">flash_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">flash_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Wait for 30 seconds for command to finish. */</span>
	<span class="n">poll_data</span> <span class="o">&amp;=</span> <span class="n">BIT_7</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">3000000</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flash_data</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flash_data</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="o">==</span> <span class="n">poll_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">!=</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">!=</span> <span class="mh">0xda</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">flash_data</span> <span class="o">&amp;</span> <span class="n">BIT_5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_program_flash_address() - Programs a flash address</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Address in flash to program</span>
<span class="cm"> * @data: Data to be written in flash</span>
<span class="cm"> * @man_id: Flash manufacturer ID</span>
<span class="cm"> * @flash_id: Flash ID</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, else non-zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_program_flash_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">man_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">flash_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Write Program Command Sequence. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_OEM_001</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xaaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x555</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xaaa</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0xda</span> <span class="o">&amp;&amp;</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x7e</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
			<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
			<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Wait for write to complete. */</span>
	<span class="k">return</span> <span class="n">qla2x00_poll_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_erase_flash() - Erase the flash.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @man_id: Flash manufacturer ID</span>
<span class="cm"> * @flash_id: Flash ID</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, else non-zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_erase_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">man_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">flash_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Individual Sector Erase Command Sequence */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_OEM_001</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xaaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x555</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xaaa</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xaaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x555</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xaaa</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Wait for erase to complete. */</span>
	<span class="k">return</span> <span class="n">qla2x00_poll_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_erase_flash_sector() - Erase a flash sector.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @addr: Flash sector to erase</span>
<span class="cm"> * @sec_mask: Sector address mask</span>
<span class="cm"> * @man_id: Flash manufacturer ID</span>
<span class="cm"> * @flash_id: Flash ID</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, else non-zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_erase_flash_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">man_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">flash_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Individual Sector Erase Command Sequence */</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x1f</span> <span class="o">&amp;&amp;</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Wait for erase to complete. */</span>
	<span class="k">return</span> <span class="n">qla2x00_poll_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_get_flash_manufacturer() - Read manufacturer ID from flash chip.</span>
<span class="cm"> * @man_id: Flash manufacturer ID</span>
<span class="cm"> * @flash_id: Flash ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_flash_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">man_id</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">flash_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
	<span class="o">*</span><span class="n">man_id</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="o">*</span><span class="n">flash_id</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_read_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">tmp_buf</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">saddr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">midpoint</span><span class="p">,</span> <span class="n">ilength</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">midpoint</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ilength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ilength</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">saddr</span><span class="o">++</span><span class="p">,</span> <span class="n">ilength</span><span class="o">++</span><span class="p">,</span> <span class="n">tmp_buf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ilength</span> <span class="o">==</span> <span class="n">midpoint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">saddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saddr</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tmp_buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_suspend_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="cm">/* Suspend HBA. */</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_UPDATE_FLASH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

	<span class="cm">/* Pause RISC. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_PAUSE_RISC</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCCR_RISC_PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_resume_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Resume HBA. */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_UPDATE_FLASH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla2x00_wait_for_chip_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla2x00_read_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">midpoint</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="cm">/* Suspend HBA. */</span>
	<span class="n">qla2x00_suspend_hba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Go with read. */</span>
	<span class="n">midpoint</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">qla2x00_flash_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">midpoint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qla2x00_flash_disable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Resume HBA. */</span>
	<span class="n">qla2x00_resume_hba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_write_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">wd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">liter</span><span class="p">,</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="n">rest_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="cm">/* Suspend HBA. */</span>
	<span class="n">qla2x00_suspend_hba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">sec_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset ISP chip. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">CSR_ISP_SOFT_RESET</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wd</span><span class="p">);</span>

	<span class="cm">/* Go with write. */</span>
	<span class="n">qla2x00_flash_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>	<span class="cm">/* Loop once to provide quick error exit */</span>
		<span class="cm">/* Structure of flash memory based on manufacturer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_OEM_001</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* OEM variant with special flash part. */</span>
			<span class="n">man_id</span> <span class="o">=</span> <span class="n">flash_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">sec_mask</span>   <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">update_flash</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qla2x00_get_flash_manufacturer</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">man_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_id</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">man_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* ST flash. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0xd2</span> <span class="o">||</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0xe3</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * ST m29w008at part - 64kb sector size with</span>
<span class="cm">				 * 32kb,8kb,8kb,16kb sectors at memory address</span>
<span class="cm">				 * 0xf0000.</span>
<span class="cm">				 */</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>   
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * ST m29w010b part - 16kb sector size</span>
<span class="cm">			 * Default to 16kb sectors</span>
<span class="cm">			 */</span>
			<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
			<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1c000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x40</span>: <span class="cm">/* Mostel flash. */</span>
			<span class="cm">/* Mostel v29c51001 part - 512 byte sector size. */</span>
			<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x1ff</span><span class="p">;</span>
			<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1fe00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xbf</span>: <span class="cm">/* SST flash. */</span>
			<span class="cm">/* SST39sf10 part - 4kb sector size. */</span>
			<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
			<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1f000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xda</span>: <span class="cm">/* Winbond flash. */</span>
			<span class="cm">/* Winbond W29EE011 part - 256 byte sector size. */</span>
			<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1ff80</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc2</span>: <span class="cm">/* Macronix flash. */</span>
			<span class="cm">/* 64k sector size. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x38</span> <span class="o">||</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x4f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Fall through... */</span>

		<span class="k">case</span> <span class="mh">0x1f</span>: <span class="cm">/* Atmel flash. */</span>
			<span class="cm">/* 512k sector size. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span>   <span class="mh">0x80000000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Fall through... */</span>

		<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* AMD flash. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x38</span> <span class="o">||</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">||</span>
			    <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x4f</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Am29LV081 part - 64kb sector size. */</span>
				<span class="cm">/* Am29LV002BT part - 64kb sector size. */</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x3e</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Am29LV008b part - 64kb sector size with</span>
<span class="cm">				 * 32kb,8kb,8kb,16kb sector at memory address</span>
<span class="cm">				 * h0xf0000.</span>
<span class="cm">				 */</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x6e</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Am29LV010 part or AM29f010 - 16kb sector</span>
<span class="cm">				 * size.</span>
<span class="cm">				 */</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1c000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x6d</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Am29LV001 part - 8kb sector size. */</span>
				<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x1fff</span><span class="p">;</span>
				<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1e000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="cm">/* Default to 16 kb sector size. */</span>
			<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
			<span class="n">sec_mask</span> <span class="o">=</span> <span class="mh">0x1c000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">update_flash:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_erase_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">liter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">liter</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">liter</span><span class="o">++</span><span class="p">,</span>
		    <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">liter</span><span class="p">];</span>
			<span class="cm">/* Are we at the beginning of a sector? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">rest_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x10000UL</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						    <span class="p">((</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span>
							<span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x3e</span><span class="p">)</span> <span class="o">||</span>
						     <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span>
							 <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0xd2</span><span class="p">)))</span> <span class="p">{</span>
							<span class="n">sec_number</span><span class="o">++</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">sec_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">rest_addr</span> <span class="o">=</span>
								    <span class="mh">0x7fff</span><span class="p">;</span>
								<span class="n">sec_mask</span> <span class="o">=</span>
								    <span class="mh">0x18000</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
							    <span class="n">sec_number</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>
							    <span class="n">sec_number</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">rest_addr</span> <span class="o">=</span>
								    <span class="mh">0x1fff</span><span class="p">;</span>
								<span class="n">sec_mask</span> <span class="o">=</span>
								    <span class="mh">0x1e000</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
							    <span class="n">sec_number</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">rest_addr</span> <span class="o">=</span>
								    <span class="mh">0x3fff</span><span class="p">;</span>
								<span class="n">sec_mask</span> <span class="o">=</span>
								    <span class="mh">0x1c000</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NVR_SELECT</span><span class="p">);</span>
					<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0xda</span> <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span>
					    <span class="mh">0xaa</span><span class="p">);</span>
					<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span>
					    <span class="mh">0x55</span><span class="p">);</span>
					<span class="n">qla2x00_write_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span>
					    <span class="mh">0xa0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Then erase it */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_erase_flash_sector</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">addr</span><span class="p">,</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="n">man_id</span><span class="p">,</span>
					    <span class="n">flash_id</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x6d</span><span class="p">)</span>
						<span class="n">sec_number</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">flash_id</span> <span class="o">==</span> <span class="mh">0x6d</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sec_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
				    <span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="n">rest_addr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x0fff</span><span class="p">;</span>
					<span class="n">sec_mask</span>   <span class="o">=</span> <span class="mh">0x1f000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sec_number</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x7ffe</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rest_addr</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
					<span class="n">sec_mask</span>   <span class="o">=</span> <span class="mh">0x1c000</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_program_flash_address</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			    <span class="n">man_id</span><span class="p">,</span> <span class="n">flash_id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">qla2x00_flash_disable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Resume HBA. */</span>
	<span class="n">qla2x00_resume_hba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla24xx_read_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Suspend HBA. */</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_UPDATE_FLASH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

	<span class="cm">/* Go with read. */</span>
	<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Resume HBA. */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_UPDATE_FLASH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_write_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Suspend HBA. */</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_UPDATE_FLASH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

	<span class="cm">/* Go with write. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla24xx_write_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_UPDATE_FLASH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla25xx_read_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">optrom_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">optrom</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">burst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">try_fast</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">slow_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">slow_read</span><span class="p">;</span>

<span class="nl">try_fast:</span>
	<span class="n">optrom</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">optrom_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optrom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00cc</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for optrom burst read (%x KB).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">OPTROM_BURST_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">slow_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">faddr</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">burst</span> <span class="o">=</span> <span class="n">OPTROM_BURST_DWORDS</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_dump_ram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">,</span>
		    <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">),</span> <span class="n">burst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00f5</span><span class="p">,</span>
			    <span class="s">&quot;Unable to burst-read optrom segment (%x/%x/%llx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">rval</span><span class="p">,</span> <span class="n">flash_data_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">),</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">optrom_dma</span><span class="p">);</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00f6</span><span class="p">,</span>
			    <span class="s">&quot;Reverting to slow-read.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span>
			    <span class="n">optrom</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">slow_read</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">optrom</span><span class="p">,</span> <span class="n">burst</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">left</span> <span class="o">-=</span> <span class="n">burst</span><span class="p">;</span>
		<span class="n">faddr</span> <span class="o">+=</span> <span class="n">burst</span><span class="p">;</span>
		<span class="n">pbuf</span> <span class="o">+=</span> <span class="n">burst</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span> <span class="n">optrom</span><span class="p">,</span>
	    <span class="n">optrom_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>

<span class="nl">slow_read:</span>
    <span class="k">return</span> <span class="n">qla24xx_read_optrom_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_get_fcode_version() - Determine an FCODE image&#39;s version.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @pcids: Pointer to the FCODE PCI data structure</span>
<span class="cm"> *</span>
<span class="cm"> * The process of retrieving the FCODE version information is at best</span>
<span class="cm"> * described as interesting.</span>
<span class="cm"> *</span>
<span class="cm"> * Within the first 100h bytes of the image an ASCII string is present</span>
<span class="cm"> * which contains several pieces of information including the FCODE</span>
<span class="cm"> * version.  Unfortunately it seems the only reliable way to retrieve</span>
<span class="cm"> * the version is by scanning for another sentinel within the string,</span>
<span class="cm"> * the FCODE build date:</span>
<span class="cm"> *</span>
<span class="cm"> *	... 2.00.02 10/17/02 ...</span>
<span class="cm"> *</span>
<span class="cm"> * Returns QLA_SUCCESS on successful retrieval of version.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_fcode_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pcids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="n">vend</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">do_next</span><span class="p">,</span> <span class="n">rbyte</span><span class="p">,</span> <span class="o">*</span><span class="n">vbyte</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">));</span>

	<span class="cm">/* Skip the PCI data structure. */</span>
	<span class="n">istart</span> <span class="o">=</span> <span class="n">pcids</span> <span class="o">+</span>
	    <span class="p">((</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x0B</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x0A</span><span class="p">));</span>
	<span class="n">iend</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Scan for the sentinel date string...eeewww. */</span>
		<span class="n">do_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">istart</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">iter</span> <span class="o">&lt;</span> <span class="n">iend</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iter</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span>
				    <span class="sc">&#39;/&#39;</span><span class="p">)</span>
					<span class="n">do_next</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				    <span class="n">iter</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
					<span class="n">do_next</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Backtrack to previous &#39; &#39; (space). */</span>
		<span class="n">do_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="n">istart</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iter</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
				<span class="n">do_next</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Mark end of version tag, and find previous &#39; &#39; (space) or</span>
<span class="cm">		 * string length (recent FCODE images -- major hack ahead!!!).</span>
<span class="cm">		 */</span>
		<span class="n">vend</span> <span class="o">=</span> <span class="n">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">do_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="n">istart</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iter</span><span class="o">--</span><span class="p">;</span>
			<span class="n">rbyte</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rbyte</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">rbyte</span> <span class="o">==</span> <span class="mh">0xd</span> <span class="o">||</span> <span class="n">rbyte</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="n">do_next</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Mark beginning of version tag, and copy data. */</span>
		<span class="n">iter</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vend</span> <span class="o">-</span> <span class="n">iter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">vend</span> <span class="o">-</span> <span class="n">iter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">vbyte</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">iter</span> <span class="o">&lt;=</span> <span class="n">vend</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">vbyte</span><span class="o">++</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
				<span class="n">iter</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_get_flash_version</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">code_type</span><span class="p">,</span> <span class="n">last_image</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pcihdr</span><span class="p">,</span> <span class="n">pcids</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dbyte</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">dcode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">));</span>

	<span class="n">qla2x00_flash_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Begin with first PCI expansion ROM header. */</span>
	<span class="n">pcihdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_image</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Verify PCI expansion ROM header. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcihdr</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span> <span class="o">||</span>
		    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcihdr</span> <span class="o">+</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No signature */</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span>
			    <span class="s">&quot;No matching ROM signature.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Locate PCI data structure. */</span>
		<span class="n">pcids</span> <span class="o">=</span> <span class="n">pcihdr</span> <span class="o">+</span>
		    <span class="p">((</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcihdr</span> <span class="o">+</span> <span class="mh">0x19</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcihdr</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>

		<span class="cm">/* Validate signature of PCI data structure. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span>
		    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;C&#39;</span> <span class="o">||</span>
		    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span>
		    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Incorrect header. */</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span>
			    <span class="s">&quot;PCI data struct not found pcir_adr=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcids</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read version */</span>
		<span class="n">code_type</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">code_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROM_CODE_TYPE_BIOS</span>:
			<span class="cm">/* Intel x86, PC-AT compatible. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x13</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span>
			    <span class="s">&quot;Read BIOS %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROM_CODE_TYPE_FCODE</span>:
			<span class="cm">/* Open Firmware standard for PCI (FCode). */</span>
			<span class="cm">/* Eeeewww... */</span>
			<span class="n">qla2x00_get_fcode_version</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROM_CODE_TYPE_EFI</span>:
			<span class="cm">/* Extensible Firmware Interface (EFI). */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x13</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span>
			    <span class="s">&quot;Read EFI %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized code type %x at pcids %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">code_type</span><span class="p">,</span> <span class="n">pcids</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">last_image</span> <span class="o">=</span> <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">;</span>

		<span class="cm">/* Locate next PCI expansion ROM. */</span>
		<span class="n">pcihdr</span> <span class="o">+=</span> <span class="p">((</span><span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">qla2x00_read_flash_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">))</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last_image</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Read firmware image information. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">));</span>
		<span class="n">dbyte</span> <span class="o">=</span> <span class="n">mbuf</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dbyte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dbyte</span><span class="p">;</span>

		<span class="n">qla2x00_read_flash_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dbyte</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
		    <span class="mi">8</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x010a</span><span class="p">,</span>
		    <span class="s">&quot;Dumping fw &quot;</span>
		    <span class="s">&quot;ver from flash:.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x010b</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dbyte</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0057</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized fw revision at %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* values are in big endian */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbyte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dbyte</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbyte</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dbyte</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbyte</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dbyte</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span>
			    <span class="s">&quot;FW Version: &quot;</span>
			    <span class="s">&quot;%d.%d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qla2x00_flash_disable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_get_flash_version</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pcihdr</span><span class="p">,</span> <span class="n">pcids</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dcode</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bcode</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">code_type</span><span class="p">,</span> <span class="n">last_image</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">));</span>

	<span class="n">dcode</span> <span class="o">=</span> <span class="n">mbuf</span><span class="p">;</span>

	<span class="cm">/* Begin with first PCI expansion ROM header. */</span>
	<span class="n">pcihdr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">last_image</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Verify PCI expansion ROM header. */</span>
		<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">pcihdr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">bcode</span> <span class="o">=</span> <span class="n">mbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">pcihdr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x55</span> <span class="o">||</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No signature */</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span>
			    <span class="s">&quot;No matching ROM signature.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Locate PCI data structure. */</span>
		<span class="n">pcids</span> <span class="o">=</span> <span class="n">pcihdr</span> <span class="o">+</span> <span class="p">((</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]);</span>

		<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">pcids</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">bcode</span> <span class="o">=</span> <span class="n">mbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">pcihdr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Validate signature of PCI data structure. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;C&#39;</span> <span class="o">||</span>
		    <span class="n">bcode</span><span class="p">[</span><span class="mh">0x2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Incorrect header. */</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span>
			    <span class="s">&quot;PCI data struct not found pcir_adr=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcids</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read version */</span>
		<span class="n">code_type</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x14</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">code_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROM_CODE_TYPE_BIOS</span>:
			<span class="cm">/* Intel x86, PC-AT compatible. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x12</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x13</span><span class="p">];</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x005b</span><span class="p">,</span>
			    <span class="s">&quot;Read BIOS %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROM_CODE_TYPE_FCODE</span>:
			<span class="cm">/* Open Firmware standard for PCI (FCode). */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x12</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x13</span><span class="p">];</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x005c</span><span class="p">,</span>
			    <span class="s">&quot;Read FCODE %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROM_CODE_TYPE_EFI</span>:
			<span class="cm">/* Extensible Firmware Interface (EFI). */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x12</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x13</span><span class="p">];</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x005d</span><span class="p">,</span>
			    <span class="s">&quot;Read EFI %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized code type %x at pcids %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">code_type</span><span class="p">,</span> <span class="n">pcids</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">last_image</span> <span class="o">=</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">;</span>

		<span class="cm">/* Locate next PCI expansion ROM. */</span>
		<span class="n">pcihdr</span> <span class="o">+=</span> <span class="p">((</span><span class="n">bcode</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">bcode</span><span class="p">[</span><span class="mh">0x10</span><span class="p">])</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last_image</span><span class="p">);</span>

	<span class="cm">/* Read firmware image information. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">));</span>
	<span class="n">dcode</span> <span class="o">=</span> <span class="n">mbuf</span><span class="p">;</span>

	<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x005f</span><span class="p">,</span>
		    <span class="s">&quot;Unrecognized fw revision at %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span>
		    <span class="s">&quot;Firmware revision %d.%d.%d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Check for golden firmware and get version if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Golden firmware is not present in non 81XX adapters */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">));</span>
	<span class="n">dcode</span> <span class="o">=</span> <span class="n">mbuf</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dcode</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_gold_fw</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dcode</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span>
		    <span class="s">&quot;Unrecognized golden fw at 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_gold_fw</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2xxx_is_vpd_valid</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x82</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x90</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x78</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2xxx_get_vpd_field</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">qla2xxx_is_vpd_valid</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x78</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="mh">0x82</span><span class="p">)</span> <span class="o">?</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x90</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x91</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">-</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pos</span> <span class="o">!=</span> <span class="mh">0x78</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_read_fcp_prio_cfg</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">max_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fcp_prio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">FCP_PRIO_CFG_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d5</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate memory for fcp priorty data (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">FCP_PRIO_CFG_SIZE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FCP_PRIO_CFG_SIZE</span><span class="p">);</span>

	<span class="n">fcp_prio_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fcp_prio</span><span class="p">;</span>

	<span class="cm">/* first read the fcp priority data header from flash */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">,</span>
			<span class="n">fcp_prio_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">FCP_PRIO_CFG_HDR_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla24xx_fcp_prio_cfg_valid</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* read remaining FCP CMD config data from flash */</span>
	<span class="n">fcp_prio_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">FCP_PRIO_CFG_HDR_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="n">FCP_PRIO_CFG_ENTRY_SIZE</span><span class="p">;</span>
	<span class="n">max_len</span> <span class="o">=</span> <span class="n">FCP_PRIO_CFG_SIZE</span> <span class="o">-</span> <span class="n">FCP_PRIO_CFG_HDR_SIZE</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">fcp_prio_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">max_len</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">max_len</span><span class="p">));</span>

	<span class="cm">/* revalidate the entire FCP priority config data, including entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla24xx_fcp_prio_cfg_valid</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fcp_prio_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
