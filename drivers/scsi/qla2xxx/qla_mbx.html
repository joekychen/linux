<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_mbx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_mbx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>


<span class="cm">/*</span>
<span class="cm"> * qla2x00_mailbox_command</span>
<span class="cm"> *	Issue mailbox command and waits for completion.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	mcp = driver internal mbx struct pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Output:</span>
<span class="cm"> *	mb[MAX_MAILBOX_REGISTER_COUNT] = returned mailbox data.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0 : QLA_SUCCESS = cmd performed success</span>
<span class="cm"> *	1 : QLA_FUNCTION_FAILED   (error encountered)</span>
<span class="cm"> *	6 : QLA_FUNCTION_TIMEOUT (timeout condition encountered)</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">abort_active</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">io_lock_on</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="o">*</span><span class="n">iptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">optr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">mboxes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">wait_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">&gt;</span> <span class="n">pci_channel_io_frozen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1001</span><span class="p">,</span>
		    <span class="s">&quot;error_state is greater than pci_channel_io_frozen, &quot;</span>
		    <span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">,</span>
		    <span class="s">&quot;Device in failed state, exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">io_lock_on</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">abort_active</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1003</span><span class="p">,</span>
		    <span class="s">&quot;Perm failure on EEH timeout MBX, exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setting Link-Down error */</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_LINK_DOWN_ERROR</span><span class="p">;</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1004</span><span class="p">,</span>
		    <span class="s">&quot;FW hung = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for active mailbox commands to finish by waiting at most tov</span>
<span class="cm">	 * seconds. This is to serialize actual issuing of mailbox cmds during</span>
<span class="cm">	 * non ISP abort time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_comp</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Timeout occurred. Return error. */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1005</span><span class="p">,</span>
		    <span class="s">&quot;Cmd access timeout, cmd=0x%x, Exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Save mailbox command for debug */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span> <span class="o">=</span> <span class="n">mcp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1006</span><span class="p">,</span>
	    <span class="s">&quot;Prepare to issue mbox cmd=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Load mailbox registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">optr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">mailbox_in</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">optr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">mailbox0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">optr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">iptr</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">command</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mboxes</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">optr</span> <span class="o">=</span>
			    <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mboxes</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">optr</span><span class="p">,</span> <span class="o">*</span><span class="n">iptr</span><span class="p">);</span>

		<span class="n">mboxes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">optr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1111</span><span class="p">,</span>
	    <span class="s">&quot;Loaded MBX registers (displayed in bytes) =.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1112</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1113</span><span class="p">,</span>
	    <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1114</span><span class="p">,</span>
	    <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1115</span><span class="p">,</span>
	    <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1116</span><span class="p">,</span>
	    <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1117</span><span class="p">,</span>
	    <span class="s">&quot;I/O Address = %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">optr</span><span class="p">);</span>
	<span class="n">ql_dump_regs</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100e</span><span class="p">);</span>

	<span class="cm">/* Issue set host interrupt command to send cmd out. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

	<span class="cm">/* Unlock mbx registers and wait for interrupt */</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100f</span><span class="p">,</span>
	    <span class="s">&quot;Going to unlock irq &amp; waiting for interrupts. &quot;</span>
	    <span class="s">&quot;jiffies=%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/* Wait for mbx cmd completion until timeout */</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">abort_active</span> <span class="o">&amp;&amp;</span> <span class="n">io_lock_on</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_NOPOLLING_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">hint</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">HINT_MBX_INT_PENDING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span>
					<span class="n">flags</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">,</span>
				    <span class="s">&quot;Pending mailbox timeout, exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">premature_exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">hint</span><span class="p">,</span> <span class="n">HINT_MBX_INT_PENDING</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_SET_HOST_INT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_SET_HOST_INT</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1011</span><span class="p">,</span>
		    <span class="s">&quot;Cmd=%x Polling Mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">hint</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">HINT_MBX_INT_PENDING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span>
					<span class="n">flags</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1012</span><span class="p">,</span>
				    <span class="s">&quot;Pending mailbox timeout, exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">premature_exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">.</span><span class="n">hint</span><span class="p">,</span> <span class="n">HINT_MBX_INT_PENDING</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_SET_HOST_INT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">.</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_SET_HOST_INT</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">wait_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span> <span class="cm">/* wait at most tov secs */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Check for pending interrupts. */</span>
			<span class="n">qla2x00_poll</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">command</span> <span class="o">==</span> <span class="n">MBC_LOAD_RISC_RAM_EXTENDED</span><span class="p">))</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="cm">/* while */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1013</span><span class="p">,</span>
		    <span class="s">&quot;Waited %d sec.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="p">(</span><span class="n">wait_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)))</span><span class="o">/</span><span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Check whether we timed out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">iptr2</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1014</span><span class="p">,</span>
		    <span class="s">&quot;Cmd=%x completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

		<span class="cm">/* Got interrupt. Clear the flag. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Setting Link-Down error */</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_LINK_DOWN_ERROR</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1015</span><span class="p">,</span>
			    <span class="s">&quot;FW hung = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">premature_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

		<span class="cm">/* Load return mailbox registers. */</span>
		<span class="n">iptr2</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">;</span>
		<span class="n">iptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mboxes</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mboxes</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">iptr2</span> <span class="o">=</span> <span class="o">*</span><span class="n">iptr</span><span class="p">;</span>

			<span class="n">mboxes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">iptr2</span><span class="o">++</span><span class="p">;</span>
			<span class="n">iptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="kt">uint16_t</span> <span class="n">mb0</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">ictrl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mb0</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">mailbox0</span><span class="p">);</span>
			<span class="n">ictrl</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">ictrl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mb0</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ictrl</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">.</span><span class="n">ictrl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1119</span><span class="p">,</span>
		    <span class="s">&quot;MBX Command timeout for cmd %x, iocontrol=%x jiffies=%lx &quot;</span>
		    <span class="s">&quot;mb[0]=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">ictrl</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">mb0</span><span class="p">);</span>
		<span class="n">ql_dump_regs</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1019</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Attempt to capture a firmware dump for further analysis</span>
<span class="cm">		 * of the current firmware state</span>
<span class="cm">		 */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clean up */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">abort_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">io_lock_on</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_NOPOLLING_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x101a</span><span class="p">,</span>
		    <span class="s">&quot;Checking for additional resp interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* polling mode for non isp_abort commands. */</span>
		<span class="n">qla2x00_poll</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_FUNCTION_TIMEOUT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBC_GEN_SYSTEM_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_lock_on</span> <span class="o">||</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IOCTL_CMD</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not in dpc. schedule it for dpc to take over. */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x101b</span><span class="p">,</span>
			    <span class="s">&quot;Timeout, schedule isp_abort_needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x112a</span><span class="p">,</span>
					    <span class="s">&quot;disabling pause transmit on port &quot;</span>
					    <span class="s">&quot;0 &amp; 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">,</span>
					    <span class="n">CRB_NIU_XG_PAUSE_CTL_P0</span><span class="o">|</span>
					    <span class="n">CRB_NIU_XG_PAUSE_CTL_P1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x101c</span><span class="p">,</span>
				    <span class="s">&quot;Mailbox cmd timeout occurred, cmd=0x%x, &quot;</span>
				    <span class="s">&quot;mb[0]=0x%x, eeh_busy=0x%x. Scheduling ISP &quot;</span>
				    <span class="s">&quot;abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">abort_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* call abort directly since we are in the DPC thread */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x101d</span><span class="p">,</span>
			    <span class="s">&quot;Timeout, calling abort_isp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x112b</span><span class="p">,</span>
					    <span class="s">&quot;disabling pause transmit on port &quot;</span>
					    <span class="s">&quot;0 &amp; 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">,</span>
					    <span class="n">CRB_NIU_XG_PAUSE_CTL_P0</span><span class="o">|</span>
					    <span class="n">CRB_NIU_XG_PAUSE_CTL_P1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x101e</span><span class="p">,</span>
				    <span class="s">&quot;Mailbox cmd timeout occurred, cmd=0x%x, &quot;</span>
				    <span class="s">&quot;mb[0]=0x%x. Scheduling ISP abort &quot;</span><span class="p">,</span>
				    <span class="n">command</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="cm">/* Allow next mbx cmd to come in. */</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_comp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">abort_isp</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Failed. retry later. */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x101f</span><span class="p">,</span>
				    <span class="s">&quot;Finished abort_isp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">mbx_done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">premature_exit:</span>
	<span class="cm">/* Allow next mbx cmd to come in. */</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_comp</span><span class="p">);</span>

<span class="nl">mbx_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">,</span>
		    <span class="s">&quot;**** Failed mbx[0]=%x, mb[1]=%x, mb[2]=%x, mb[3]=%x, cmd=%x ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">command</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x1021</span><span class="p">,</span> <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_load_ram</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">req_dma</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">risc_code_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1022</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LOAD_RISC_RAM_EXTENDED</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LOAD_RISC_RAM</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">req_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">req_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">risc_code_size</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_code_size</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_code_size</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1023</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1024</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define	EXTENDED_BB_CREDITS	BIT_0</span>
<span class="cm">/*</span>
<span class="cm"> * qla2x00_execute_fw</span>
<span class="cm"> *     Start adapter firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *     ha = adapter block pointer.</span>
<span class="cm"> *     TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *     ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *     qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *     Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_execute_fw</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_EXECUTE_FIRMWARE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nvram_81xx</span> <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">enhanced_features</span> <span class="o">&amp;</span>
			    <span class="n">EXTENDED_BB_CREDITS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1026</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1027</span><span class="p">,</span>
			    <span class="s">&quot;Done exchanges=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span>
			    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_fw_version</span>
<span class="cm"> *	Get firmware version.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha:		adapter state pointer.</span>
<span class="cm"> *	major:		pointer for major number.</span>
<span class="cm"> *	minor:		pointer for minor number.</span>
<span class="cm"> *	subminor:	pointer for subminor number.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_fw_version</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>	<span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>	<span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1029</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_FIRMWARE_VERSION</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_17</span><span class="o">|</span><span class="n">MBX_16</span><span class="o">|</span><span class="n">MBX_15</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/* Return mailbox data. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_memory_size</span> <span class="o">=</span> <span class="mh">0x1FFFF</span><span class="p">;</span>		<span class="cm">/* Defaults to 128KB. */</span>
	<span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_memory_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_capabilities</span> <span class="o">=</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes_h</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1139</span><span class="p">,</span>
			    <span class="s">&quot;%s: FW_attributes Upper: 0x%x, Lower: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x112f</span><span class="p">,</span>
			    <span class="s">&quot;%s: FwAttributes [Upper]  invalid, MB6:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x102a</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x102b</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_fw_options</span>
<span class="cm"> *	Set firmware options.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	fwopt = pointer for firmware options.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_fw_options</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">fwopts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x102c</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_FIRMWARE_OPTION</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x102d</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fwopts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">fwopts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">fwopts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">fwopts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x102e</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * qla2x00_set_fw_options</span>
<span class="cm"> *	Set firmware options.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	fwopt = pointer for firmware options.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">fwopts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x102f</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_FIRMWARE_OPTION</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwopts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwopts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwopts</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwopts</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwopts</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Undocumented, but used */</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="n">fwopts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1030</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x (%x/%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1031</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_mbx_reg_test</span>
<span class="cm"> *	Mailbox register wrap test.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_mbx_reg_test</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1032</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_MAILBOX_REGISTER_TEST</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAAAA</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5555</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA55</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55AA</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA5A5</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5A5A</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2525</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xAAAA</span> <span class="o">||</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x5555</span> <span class="o">||</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xAA55</span> <span class="o">||</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x55AA</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xA5A5</span> <span class="o">||</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x5A5A</span> <span class="o">||</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2525</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1033</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1034</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_verify_checksum</span>
<span class="cm"> *	Verify firmware checksum.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_verify_checksum</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1035</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_VERIFY_CHECKSUM</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1036</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x chm sum=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1037</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_issue_iocb</span>
<span class="cm"> *	Issue IOCB using mailbox command</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter state pointer.</span>
<span class="cm"> *	buffer = buffer pointer.</span>
<span class="cm"> *	phys_addr = physical address of buffer.</span>
<span class="cm"> *	size = size of buffer.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_issue_iocb_timeout</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
    <span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">tov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>	<span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>	<span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1038</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_IOCB_COMMAND_A64</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">tov</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1039</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sts_entry_t</span> <span class="o">*</span><span class="n">sts_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="cm">/* Mask reserved bits. */</span>
		<span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;=</span>
		    <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">RF_MASK_24XX</span> <span class="o">:</span> <span class="n">RF_MASK</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x103a</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">qla2x00_issue_iocb_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
	    <span class="n">MBX_TOV_SECONDS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_abort_command</span>
<span class="cm"> *	Abort command aborts a specified IOCB.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	sp = SB structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_abort_command</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>	<span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>	<span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="n">fc_port_t</span>	<span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">GET_CMD_SP</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x103b</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">handle</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">==</span> <span class="n">sp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* command not found */</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_ABORT_COMMAND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">handle</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x103c</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x103d</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_abort_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">rval2</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>  <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>  <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x103e</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_ABORT_TARGET</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x103f</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue marker IOCB. */</span>
	<span class="n">rval2</span> <span class="o">=</span> <span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">MK_SYNC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval2</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1040</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue marker IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1041</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_lun_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">rval2</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>  <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span>  <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1042</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LUN_RESET</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue marker IOCB. */</span>
	<span class="n">rval2</span> <span class="o">=</span> <span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
								<span class="n">MK_SYNC_ID_LUN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval2</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1044</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue marker IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1045</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_adapter_id</span>
<span class="cm"> *	Get adapter ID and topology.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	id = pointer for loop ID.</span>
<span class="cm"> *	al_pa = pointer for AL_PA.</span>
<span class="cm"> *	area = pointer for area.</span>
<span class="cm"> *	domain = pointer for domain.</span>
<span class="cm"> *	top = pointer for topology.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_adapter_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">al_pa</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">area</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">sw_cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1046</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_ADAPTER_LOOP_ID</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_COMMAND_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_INVALID_COMMAND</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_INVALID_COMMAND</span><span class="p">;</span>

	<span class="cm">/* Return data. */</span>
	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">area</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">domain</span>	<span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="o">*</span><span class="n">sw_cap</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1047</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1048</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vlan_id</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_fcf_idx</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_retry_cnt</span>
<span class="cm"> *	Get current firmware login retry count and delay.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	retry_cnt = pointer to login retry count.</span>
<span class="cm"> *	tov = pointer to login timeout value.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_retry_cnt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">retry_cnt</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">tov</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">r_a_tov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ratov</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1049</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_RETRY_COUNT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x104a</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Convert returned data and check our values. */</span>
		<span class="o">*</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ratov</span> <span class="o">=</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* mb[3] value is in 100ms */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratov</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">retry_cnt</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">tov</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Update to the larger values */</span>
			<span class="o">*</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="o">*</span><span class="n">tov</span> <span class="o">=</span> <span class="n">ratov</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x104b</span><span class="p">,</span>
		    <span class="s">&quot;Done %s mb3=%d ratov=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ratov</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_init_firmware</span>
<span class="cm"> *	Initialize adapter firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	dptr = Initialization control block pointer.</span>
<span class="cm"> *	size = size of initialization control block.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_init_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x104c</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xdbwr</span><span class="p">)</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span>
			<span class="p">(</span><span class="mh">0x04</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span><span class="p">)</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_MID_INITIALIZE_FIRMWARE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_INITIALIZE_FIRMWARE</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="o">-&gt;</span><span class="n">ex_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">));</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb_dma</span><span class="p">));</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_14</span><span class="o">|</span><span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 1 and 2 should normally be captured. */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="cm">/* mb3 is additional info about the installed SFP. */</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span>  <span class="o">|=</span> <span class="n">MBX_3</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x104d</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x, mb[1]=%x, mb[2]=%x, mb[3]=%x,.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x104e</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_node_name_list</span>
<span class="cm"> *      Issue get node name list mailbox command, kmalloc()</span>
<span class="cm"> *      and return the resulting list. Caller must kfree() it!</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter state pointer.</span>
<span class="cm"> *      out_data = resulting list</span>
<span class="cm"> *      out_len = length of the resulting list</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *      Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_node_name_list</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">out_data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_port_24xx_data</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pmap</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pmap_dma</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">dma_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_size</span> <span class="o">=</span> <span class="n">left</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">);</span>
		<span class="n">pmap</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">pmap_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x113f</span><span class="p">,</span>
			    <span class="s">&quot;%s(%ld): DMA Alloc failed of %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_PORT_NODE_NAME_LIST</span><span class="p">;</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_3</span><span class="p">;</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">);</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">);</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">));</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">));</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_size</span><span class="p">;</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_8</span><span class="p">;</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="n">mc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_IN</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xA</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">left</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mc</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_port_24xx_data</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dma_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1140</span><span class="p">,</span>
			    <span class="s">&quot;%s(%ld): failed to allocate node names list &quot;</span>
			    <span class="s">&quot;structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">);</span>
<span class="nl">restart:</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">pmap_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">out_data</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
	<span class="o">*</span><span class="n">out_len</span> <span class="o">=</span> <span class="n">dma_size</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">pmap_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_port_database</span>
<span class="cm"> *	Issue normal/enhanced get port database mailbox command</span>
<span class="cm"> *	and copy device name as necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter state pointer.</span>
<span class="cm"> *	dev = structure pointer.</span>
<span class="cm"> *	opt = enhanced cmd option byte.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_port_database</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="n">port_database_t</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_database_24xx</span> <span class="o">*</span><span class="n">pd24</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pd_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x104f</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pd24</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span>  <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1050</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate port database structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="n">PORT_DATABASE_SIZE</span><span class="p">,</span> <span class="n">PORT_DATABASE_24XX_SIZE</span><span class="p">));</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_PORT_DATABASE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_ENHANCED_GET_PORT_DATABASE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">pd_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">pd_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">pd_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">pd_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">opt</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">PORT_DATABASE_24XX_SIZE</span> <span class="o">:</span> <span class="n">PORT_DATABASE_SIZE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_IN</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gpd_error_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pd24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">port_database_24xx</span> <span class="o">*</span><span class="p">)</span> <span class="n">pd</span><span class="p">;</span>

		<span class="cm">/* Check for logged in state. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd24</span><span class="o">-&gt;</span><span class="n">current_login_state</span> <span class="o">!=</span> <span class="n">PDS_PRLI_COMPLETE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">last_login_state</span> <span class="o">!=</span> <span class="n">PDS_PRLI_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1051</span><span class="p">,</span>
			    <span class="s">&quot;Unable to verify login-state (%x/%x) for &quot;</span>
			    <span class="s">&quot;loop_id %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">current_login_state</span><span class="p">,</span>
			    <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">last_login_state</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">gpd_error_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">FC_NO_LOOP_ID</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">memcmp</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* We lost the device mid way. */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_NOT_LOGGED_IN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">gpd_error_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Names are little-endian. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

		<span class="cm">/* Get port_id of device. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">pd24</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* If not target must be initiator or unknown type. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pd24</span><span class="o">-&gt;</span><span class="n">prli_svc_param_word_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_INITIATOR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_TARGET</span><span class="p">;</span>

		<span class="cm">/* Passback COS information. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd24</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PDF_CLASS_2</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">FC_COS_CLASS2</span> <span class="o">:</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pd24</span><span class="o">-&gt;</span><span class="n">prli_svc_param_word_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check for logged in state. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">master_state</span> <span class="o">!=</span> <span class="n">PD_STATE_PORT_LOGGED_IN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pd</span><span class="o">-&gt;</span><span class="n">slave_state</span> <span class="o">!=</span> <span class="n">PD_STATE_PORT_LOGGED_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100a</span><span class="p">,</span>
			    <span class="s">&quot;Unable to verify login-state (%x/%x) - &quot;</span>
			    <span class="s">&quot;portid=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">master_state</span><span class="p">,</span>
			    <span class="n">pd</span><span class="o">-&gt;</span><span class="n">slave_state</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">gpd_error_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">FC_NO_LOOP_ID</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">memcmp</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* We lost the device mid way. */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_NOT_LOGGED_IN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">gpd_error_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Names are little-endian. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

		<span class="cm">/* Get port_id of device. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* If not target must be initiator or unknown type. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">prli_svc_param_word_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_INITIATOR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_TARGET</span><span class="p">;</span>

		<span class="cm">/* Passback COS information. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="o">?</span>
		    <span class="nl">FC_COS_CLASS2:</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">gpd_error_out:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">pd_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1052</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1053</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_firmware_state</span>
<span class="cm"> *	Get adapter firmware state.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	dptr = pointer for firmware state.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_firmware_state</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">states</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1054</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_FIRMWARE_STATE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="cm">/* Return firmware states. */</span>
	<span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">states</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">states</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">states</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1055</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1056</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_port_name</span>
<span class="cm"> *	Issue get port name mailbox command.</span>
<span class="cm"> *	Returned name is in big endian format.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	loop_id = loop ID of device.</span>
<span class="cm"> *	name = pointer for name.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_port_name</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1057</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_PORT_NAME</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">opt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1058</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This function returns name in big endian. */</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">name</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1059</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_lip_reset</span>
<span class="cm"> *	Issue LIP reset mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_lip_reset</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x105a</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Logout across all FCFs. */</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LIP_FULL_LOGIN</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LIP_FULL_LOGIN</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_6</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LIP_RESET</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00ff</span><span class="p">;</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x105b</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x105c</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_send_sns</span>
<span class="cm"> *	Send SNS command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	sns = pointer for command.</span>
<span class="cm"> *	cmd_size = command size.</span>
<span class="cm"> *	buf_size = response/command size.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_send_sns</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">sns_phys_address</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">cmd_size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x105d</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x105e</span><span class="p">,</span>
	    <span class="s">&quot;Retry cnt=%d ratov=%d total tov=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SEND_SNS_COMMAND</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_size</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">sns_phys_address</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">sns_phys_address</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sns_phys_address</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sns_phys_address</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="o">|</span><span class="n">MBX_DMA_IN</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x105f</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1060</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_login_fabric</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">domain</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">area</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">al_pa</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="n">lg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">lg_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">iop</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1061</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">)</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">lg</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lg_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1062</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate login IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">logio_entry_24xx</span><span class="p">));</span>

	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">LOGINOUT_PORT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">lg</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COMMAND_PLOGI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
		<span class="n">lg</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COND_PLOGI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span>
		<span class="n">lg</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">LCF_SKIP_PRLI</span><span class="p">);</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">al_pa</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lg_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1063</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue login IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1064</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- error status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CS_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">iop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1065</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- completion  status (%x) &quot;</span>
		    <span class="s">&quot;ioparam=%x/%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">),</span>
		    <span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iop</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LSC_SCODE_PORTID_USED</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_PORT_ID_USED</span><span class="p">;</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LSC_SCODE_NPORT_USED</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_LOOP_ID_USED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LSC_SCODE_NOLINK</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NOIOCB</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NOXCB</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_CMD_FAILED</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NOFABRIC</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_FW_NOT_READY</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NOT_LOGGED_IN</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NOPCB</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_ELS_REJECT</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_CMD_PARAM_ERR</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NONPORT</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_LOGGED_IN</span>:
		<span class="k">case</span> <span class="n">LSC_SCODE_NOFLOGI_ACC</span>:
		<span class="nl">default:</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1066</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_8</span><span class="p">)</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>

		<span class="cm">/* Passback COS information. */</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">||</span> <span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>	<span class="cm">/* Class 2. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">||</span> <span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_1</span><span class="p">;</span>	<span class="cm">/* Class 3. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_7</span><span class="p">))</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_7</span><span class="p">;</span>	<span class="cm">/* Confirmed Completion</span>
<span class="cm">						 * Allowed</span>
<span class="cm">						 */</span>
	<span class="p">}</span>

	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lg_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_login_fabric</span>
<span class="cm"> *	Issue login fabric port mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	loop_id = device loop ID.</span>
<span class="cm"> *	domain = device domain.</span>
<span class="cm"> *	area = device area.</span>
<span class="cm"> *	al_pa = device AL_PA.</span>
<span class="cm"> *	status = pointer for return status.</span>
<span class="cm"> *	opt = command options.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_login_fabric</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">domain</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">area</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">al_pa</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1067</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LOGIN_FABRIC_PORT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">al_pa</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="cm">/* Return mailbox statuses. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="cm">/* COS retrieved from Get-Port-Database mailbox command. */</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RLU tmp code: need to change main mailbox_command function to</span>
<span class="cm">		 * return ok even when the mailbox completion value is not</span>
<span class="cm">		 * SUCCESS. The caller needs to be responsible to interpret</span>
<span class="cm">		 * the return values of this mailbox command if we&#39;re not</span>
<span class="cm">		 * to change too much of the existing code.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4001</span> <span class="o">||</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4002</span> <span class="o">||</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4003</span> <span class="o">||</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4005</span> <span class="o">||</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4006</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1068</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x mb[2]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1069</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_login_local_device</span>
<span class="cm"> *           Issue login loop port mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *           ha = adapter block pointer.</span>
<span class="cm"> *           loop_id = device loop ID.</span>
<span class="cm"> *           opt = command options.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *            Return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *            Kernel context.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_login_local_device</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb_ret</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x106a</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla24xx_login_fabric</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">mb_ret</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LOGIN_LOOP_PORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
 	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

 	<span class="cm">/* Return mailbox statuses. */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">mb_ret</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">mb_ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
 		<span class="n">mb_ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
 		<span class="n">mb_ret</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
 		<span class="n">mb_ret</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
 	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
 		<span class="cm">/* AV tmp code: need to change main mailbox_command function to</span>
<span class="cm"> 		 * return ok even when the mailbox completion value is not</span>
<span class="cm"> 		 * SUCCESS. The caller needs to be responsible to interpret</span>
<span class="cm"> 		 * the return values of this mailbox command if we&#39;re not</span>
<span class="cm"> 		 * to change too much of the existing code.</span>
<span class="cm"> 		 */</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4005</span> <span class="o">||</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4006</span><span class="p">)</span>
 			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x106b</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x mb[6]=%x mb[7]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x106c</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_fabric_logout</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">domain</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">area</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">al_pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">logio_entry_24xx</span> <span class="o">*</span><span class="n">lg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">lg_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x106d</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">lg</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lg_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x106e</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate logout IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">logio_entry_24xx</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmaxqueues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">LOGINOUT_PORT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">lg</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">LCF_COMMAND_LOGO</span><span class="o">|</span><span class="n">LCF_IMPL_LOGO</span><span class="o">|</span>
		<span class="n">LCF_FREE_NPORT</span><span class="p">);</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">al_pa</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">lg</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lg_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x106f</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue logout IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1070</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- error status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lg</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CS_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1071</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- completion status (%x) &quot;</span>
		    <span class="s">&quot;ioparam=%x/%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lg</span><span class="o">-&gt;</span><span class="n">io_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1072</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">lg</span><span class="p">,</span> <span class="n">lg_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_fabric_logout</span>
<span class="cm"> *	Issue logout fabric port mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	loop_id = device loop ID.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_fabric_logout</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">domain</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">area</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">al_pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1073</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LOGOUT_FABRIC_PORT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1074</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1075</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_full_login_lip</span>
<span class="cm"> *	Issue full login LIP mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	TARGET_QUEUE_LOCK must be released.</span>
<span class="cm"> *	ADAPTER_STATE_LOCK must be released.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_full_login_lip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1076</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LIP_FULL_LOGIN</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">BIT_3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1077</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1078</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_id_list</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_id_list</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">id_list</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">id_list_dma</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1079</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_ID_LIST</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">));</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">));</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">));</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">id_list_dma</span><span class="p">));</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x107a</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">entries</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x107b</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_resource_cnts</span>
<span class="cm"> *	Get current firmware resource counts.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_resource_cnts</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">cur_xchg_cnt</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">orig_xchg_cnt</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">cur_iocb_cnt</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">orig_iocb_cnt</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">max_npiv_vports</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">max_fcfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x107c</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_RESOURCE_COUNTS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_12</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x107d</span><span class="p">,</span>
		    <span class="s">&quot;Failed mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x107e</span><span class="p">,</span>
		    <span class="s">&quot;Done %s mb1=%x mb2=%x mb3=%x mb6=%x mb7=%x mb10=%x &quot;</span>
		    <span class="s">&quot;mb11=%x mb12=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_xchg_cnt</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cur_xchg_cnt</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_xchg_cnt</span><span class="p">)</span>
			<span class="o">*</span><span class="n">orig_xchg_cnt</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_iocb_cnt</span><span class="p">)</span>
			<span class="o">*</span><span class="n">cur_iocb_cnt</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_iocb_cnt</span><span class="p">)</span>
			<span class="o">*</span><span class="n">orig_iocb_cnt</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span> <span class="o">&amp;&amp;</span> <span class="n">max_npiv_vports</span><span class="p">)</span>
			<span class="o">*</span><span class="n">max_npiv_vports</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">max_fcfs</span><span class="p">)</span>
			<span class="o">*</span><span class="n">max_fcfs</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_fcal_position_map</span>
<span class="cm"> *	Get FCAL (LILP) position map using mailbox command</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter state pointer.</span>
<span class="cm"> *	pos_map = buffer pointer (can be NULL).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_fcal_position_map</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pos_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pmap</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pmap_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x107f</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pmap</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmap_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmap</span>  <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1080</span><span class="p">,</span>
		    <span class="s">&quot;Memory alloc failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FCAL_MAP_SIZE</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_FC_AL_POSITION_MAP</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">pmap_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">FCAL_MAP_SIZE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_IN</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1081</span><span class="p">,</span>
		    <span class="s">&quot;mb0/mb1=%x/%X FC/AL position map size (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">pmap</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x111d</span><span class="p">,</span>
		    <span class="n">pmap</span><span class="p">,</span> <span class="n">pmap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pos_map</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pos_map</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">FCAL_MAP_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">pmap_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1082</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1083</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_get_link_status</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	loop_id = device loop ID.</span>
<span class="cm"> *	ret_buf = pointer to link status return buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0 = success.</span>
<span class="cm"> *	BIT_0 = mem alloc error.</span>
<span class="cm"> *	BIT_1 = mailbox error.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_get_link_status</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">link_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">stats_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">siter</span><span class="p">,</span> <span class="o">*</span><span class="n">diter</span><span class="p">,</span> <span class="n">dwords</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1084</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_LINK_STATUS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_EXTENDED_IDS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IOCTL_CMD</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1085</span><span class="p">,</span>
			    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Copy over data -- firmware data is LE. */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1086</span><span class="p">,</span>
			    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dwords</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_statistics</span><span class="p">,</span> <span class="n">unused1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">siter</span> <span class="o">=</span> <span class="n">diter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">link_fail_cnt</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dwords</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">diter</span><span class="o">++</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">siter</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Failed. */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1087</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_get_isp_stats</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
    <span class="n">dma_addr_t</span> <span class="n">stats_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">siter</span><span class="p">,</span> <span class="o">*</span><span class="n">diter</span><span class="p">,</span> <span class="n">dwords</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1088</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_LINK_PRIV_STATS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_statistics</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IOCTL_CMD</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1089</span><span class="p">,</span>
			    <span class="s">&quot;Failed mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x108a</span><span class="p">,</span>
			    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* Copy over data -- firmware data is LE. */</span>
			<span class="n">dwords</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_statistics</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">siter</span> <span class="o">=</span> <span class="n">diter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">link_fail_cnt</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dwords</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">diter</span><span class="o">++</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">siter</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Failed. */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x108b</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_abort_command</span><span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">abort_entry_24xx</span> <span class="o">*</span><span class="n">abt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">abt_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="n">fc_port_t</span>	<span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x108c</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">handle</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">==</span> <span class="n">sp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Command not found. */</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">abt</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abt_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x108d</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate abort IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">abt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">abort_entry_24xx</span><span class="p">));</span>

	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">ABORT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">abt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">handle_to_abort</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="n">abt</span><span class="o">-&gt;</span><span class="n">req_que_no</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">abt</span><span class="p">,</span> <span class="n">abt_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x108e</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x108f</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- error status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">abt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1090</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- completion status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">abt</span><span class="o">-&gt;</span><span class="n">nport_handle</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1091</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">abt</span><span class="p">,</span> <span class="n">abt_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tsk_mgmt_cmd</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tsk_mgmt_entry</span> <span class="n">tsk</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">p</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__qla24xx_issue_tmf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">,</span> <span class="n">rval2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsk_mgmt_cmd</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">sts</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">tsk_dma</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1092</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">)</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">tsk</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsk_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1093</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate task management IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsk_mgmt_cmd</span><span class="p">));</span>

	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">TSK_MGMT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TCF_LUN_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">host_to_fcp_swap</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">lun</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">tsk</span><span class="p">.</span><span class="n">lun</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">sts</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tsk</span><span class="p">,</span> <span class="n">tsk_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1094</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue %s reset IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1095</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- error status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sts</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CS_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1096</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- completion status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">SS_RESPONSE_INFO_LEN_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">rsp_data_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1097</span><span class="p">,</span>
			    <span class="s">&quot;Ignoring inconsistent data length -- not enough &quot;</span>
			    <span class="s">&quot;response info (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">rsp_data_len</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1098</span><span class="p">,</span>
			    <span class="s">&quot;Failed to complete IOCB -- response (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">sts</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Issue marker IOCB. */</span>
	<span class="n">rval2</span> <span class="o">=</span> <span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
	    <span class="n">type</span> <span class="o">==</span> <span class="n">TCF_LUN_RESET</span> <span class="o">?</span> <span class="n">MK_SYNC_ID_LUN</span><span class="o">:</span> <span class="n">MK_SYNC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval2</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1099</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue marker IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x109a</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">tsk</span><span class="p">,</span> <span class="n">tsk_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_abort_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ql2xasynctmfenable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_async_tm_cmd</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">TCF_TARGET_RESET</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__qla24xx_issue_tmf</span><span class="p">(</span><span class="s">&quot;Target&quot;</span><span class="p">,</span> <span class="n">TCF_TARGET_RESET</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_lun_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ql2xasynctmfenable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_async_tm_cmd</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">TCF_LUN_RESET</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__qla24xx_issue_tmf</span><span class="p">(</span><span class="s">&quot;Lun&quot;</span><span class="p">,</span> <span class="n">TCF_LUN_RESET</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_system_error</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x109b</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GEN_SYSTEM_ERROR</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x109c</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x109d</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_set_serdes_params() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_set_serdes_params</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">sw_em_1g</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">sw_em_2g</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">sw_em_4g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x109e</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SERDES_PARAMS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_em_1g</span> <span class="o">|</span> <span class="n">BIT_15</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_em_2g</span> <span class="o">|</span> <span class="n">BIT_15</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_em_4g</span> <span class="o">|</span> <span class="n">BIT_15</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x109f</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a0</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_stop_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a1</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_STOP_FIRMWARE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a2</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_INVALID_COMMAND</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_INVALID_COMMAND</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a3</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_enable_eft_trace</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">eft_dma</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">buffers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a4</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_TRACE_CONTROL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_EFT_ENABLE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">eft_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">eft_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">eft_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">eft_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffers</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_AEN_DISABLE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a5</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a6</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_disable_eft_trace</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a7</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_TRACE_CONTROL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_EFT_DISABLE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a8</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10a9</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_enable_fce_trace</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">fce_dma</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">buffers</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwords</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10aa</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_TRACE_CONTROL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_FCE_ENABLE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">fce_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">fce_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">fce_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">fce_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffers</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_AEN_DISABLE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_FCE_DEFAULT_RX_SIZE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_FCE_DEFAULT_TX_SIZE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span>
	    <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ab</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ac</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwords</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dwords</span> <span class="o">=</span> <span class="n">buffers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_disable_fce_trace</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">wr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">rd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ad</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_TRACE_CONTROL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_FCE_DISABLE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_FCE_DISABLE_TRACE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span>
	    <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ae</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10af</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wr</span><span class="p">)</span>
			<span class="o">*</span><span class="n">wr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span> <span class="o">|</span>
			    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
			    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">)</span>
			<span class="o">*</span><span class="n">rd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span> <span class="o">|</span>
			    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
			    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_get_idma_speed</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">port_speed</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b0</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IIDMA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_PORT_PARAMS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="cm">/* Return mailbox statuses. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b1</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b2</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_speed</span><span class="p">)</span>
			<span class="o">*</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_set_idma_speed</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">port_speed</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b3</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IIDMA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_PORT_PARAMS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_speed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_5</span><span class="o">|</span><span class="n">BIT_4</span><span class="o">|</span><span class="n">BIT_3</span><span class="o">|</span><span class="n">BIT_2</span><span class="o">|</span><span class="n">BIT_1</span><span class="o">|</span><span class="n">BIT_0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_speed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_2</span><span class="o">|</span><span class="n">BIT_1</span><span class="o">|</span><span class="n">BIT_0</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="cm">/* Return mailbox statuses. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b4</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b5</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla24xx_report_id_acquisition</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">vp_rpt_id_entry_24xx</span> <span class="o">*</span><span class="n">rptid_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">vp_idx</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b6</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b7</span><span class="p">,</span>
		    <span class="s">&quot;Format 0 : Number of VPs setup %d, number of &quot;</span>
		    <span class="s">&quot;VPs acquired %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">MSB</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">vp_count</span><span class="p">)),</span>
		    <span class="n">LSB</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">vp_count</span><span class="p">)));</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b8</span><span class="p">,</span>
		    <span class="s">&quot;Primary port id %02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vp_idx</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10b9</span><span class="p">,</span>
		    <span class="s">&quot;Format 1: VP[%d] enabled - status %d - with &quot;</span>
		    <span class="s">&quot;port id %02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vp_idx</span><span class="p">,</span> <span class="n">MSB</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span>
		    <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">vp</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MSB</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reg_needed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">MSB</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ba</span><span class="p">,</span>
			    <span class="s">&quot;Could not acquire ID for VP[%d].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vp_idx</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp_idx</span> <span class="o">==</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vp</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span>  <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">rptid_entry</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Cannot configure here as we are still sitting on the</span>
<span class="cm">		 * response queue. Handle it in dpc context.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">VP_IDX_ACQUIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_flags</span><span class="p">);</span>

<span class="nl">reg_needed:</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FC4_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FDMI_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">VP_DPC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_modify_vp_config</span>
<span class="cm"> *	Change VP configuration for vha</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	vha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2xxx local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_modify_vp_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vp_config_entry_24xx</span> <span class="o">*</span><span class="n">vpmod</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">vpmod_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* This can be called by the parent */</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10bb</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">vpmod</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpmod_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpmod</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10bc</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate modify VP IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">vpmod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vp_config_entry_24xx</span><span class="p">));</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">VP_CONFIG_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">VCT_COMMAND_MOD_ENABLE_VPS</span><span class="p">;</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">vp_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">vp_index1</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">options_idx1</span> <span class="o">=</span> <span class="n">BIT_3</span><span class="o">|</span><span class="n">BIT_4</span><span class="o">|</span><span class="n">BIT_5</span><span class="p">;</span>

	<span class="n">qlt_modify_vp_config</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vpmod</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">node_name_idx1</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">port_name_idx1</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">vpmod</span><span class="p">,</span> <span class="n">vpmod_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10bd</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue VP config IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10be</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- error status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CS_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10bf</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- completion status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* EMPTY */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c0</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_INITIALIZING</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">vpmod</span><span class="p">,</span> <span class="n">vpmod_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_control_vp</span>
<span class="cm"> *	Enable a virtual port for given host</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	vhba = virtual adapter (unused)</span>
<span class="cm"> *	index = index number for enabled VP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2xxx local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_control_vp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">map</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vp_ctrl_entry_24xx</span>   <span class="o">*</span><span class="n">vce</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">vce_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c1</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s enabling index %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vp_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vp_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vp_index</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_PARAMETER_ERROR</span><span class="p">;</span>

	<span class="n">vce</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vce_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c2</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate VP control IOCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vce</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vp_ctrl_entry_24xx</span><span class="p">));</span>

	<span class="n">vce</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">VP_CTRL_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">vce</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vce</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">vce</span><span class="o">-&gt;</span><span class="n">vp_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* index map in firmware starts with 1; decrement index</span>
<span class="cm">	 * this is ok as we never use index 0</span>
<span class="cm">	 */</span>
	<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">vp_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">vce</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">[</span><span class="n">map</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">vce</span><span class="p">,</span> <span class="n">vce_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c3</span><span class="p">,</span>
		    <span class="s">&quot;Failed to issue VP control IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vce</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c4</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complete IOCB -- error status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vce</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vce</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CS_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c5</span><span class="p">,</span>
		    <span class="s">&quot;Failed to complet IOCB -- completion status (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vce</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c6</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">vce</span><span class="p">,</span> <span class="n">vce_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_send_change_request</span>
<span class="cm"> *	Receive or disable RSCN request from fabric controller</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer</span>
<span class="cm"> *	format = registration format:</span>
<span class="cm"> *		0 - Reserved</span>
<span class="cm"> *		1 - Fabric detected registration</span>
<span class="cm"> *		2 - N_port detected registration</span>
<span class="cm"> *		3 - Full registration</span>
<span class="cm"> *		FF - clear registration</span>
<span class="cm"> *	vp_idx = Virtual port index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel Context</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">qla2x00_send_change_request</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">format</span><span class="p">,</span>
			    <span class="kt">uint16_t</span> <span class="n">vp_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c7</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SEND_CHANGE_REQUEST</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_dump_ram</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">req_dma</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1009</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MSW</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_DUMP_RISC_RAM_EXTENDED</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_DUMP_RISC_RAM</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">req_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">req_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1007</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 84XX Support **************************************************************/</span>

<span class="k">struct</span> <span class="n">cs84xx_mgmt_cmd</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">verify_chip_entry_84xx</span> <span class="n">req</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">verify_chip_rsp_84xx</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">p</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">qla84xx_verify_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs84xx_mgmt_cmd</span> <span class="o">*</span><span class="n">mn</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mn_dma</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">options</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c8</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mn</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mn_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Force Update? */</span>
	<span class="n">options</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">fw_update</span> <span class="o">?</span> <span class="n">VCO_FORCE_UPDATE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Diagnostic firmware? */</span>
	<span class="cm">/* options |= MENLO_DIAG_FW; */</span>
	<span class="cm">/* We update the firmware with only one data sequence. */</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">VCO_END_OF_DATA</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mn</span><span class="p">));</span>
		<span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">VERIFY_CHIP_IOCB_TYPE</span><span class="p">;</span>
		<span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x111c</span><span class="p">,</span>
		    <span class="s">&quot;Dump of Verify Request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x111e</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mn</span><span class="p">));</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">mn_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10cb</span><span class="p">,</span>
			    <span class="s">&quot;Failed to issue verify IOCB (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">verify_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1110</span><span class="p">,</span>
		    <span class="s">&quot;Dump of Verify Response.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1118</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mn</span><span class="p">));</span>

		<span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">comp_status</span><span class="p">);</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CS_VCS_CHIP_FAILURE</span> <span class="o">?</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">failure_code</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ce</span><span class="p">,</span>
		    <span class="s">&quot;cs=%x fc=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">VCO_DONT_UPDATE_FW</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10cf</span><span class="p">,</span>
				    <span class="s">&quot;Firmware update failed. Retrying &quot;</span>
				    <span class="s">&quot;without update firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">options</span> <span class="o">|=</span> <span class="n">VCO_DONT_UPDATE_FW</span><span class="p">;</span>
				<span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VCO_FORCE_UPDATE</span><span class="p">;</span>
				<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d0</span><span class="p">,</span>
			    <span class="s">&quot;Firmware updated to %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">));</span>

			<span class="cm">/* NOTE: we only update OP firmware. */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">op_fw_version</span> <span class="o">=</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mn</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">,</span>
			    <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="p">);</span>

<span class="nl">verify_done:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">mn_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d1</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d2</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla25xx_init_req_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_25xxmq</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d3</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_INITIALIZE_MULTIQ</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">)</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device_reg_25xxmq</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">QLA_QUE_PAGE</span> <span class="o">*</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="cm">/* que in ptr index */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* que out ptr index */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_14</span><span class="o">|</span><span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span>
			<span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_15</span><span class="p">;</span>
		<span class="cm">/* debug q create issue in SR-IOV */</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_9</span> <span class="o">|</span> <span class="n">MBX_8</span> <span class="o">|</span> <span class="n">MBX_7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d4</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d5</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla25xx_init_rsp_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_25xxmq</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d6</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_INITIALIZE_MULTIQ</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device_reg_25xxmq</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqiobase</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">QLA_QUE_PAGE</span> <span class="o">*</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="cm">/* que in ptr index */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* que out ptr index */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_14</span><span class="o">|</span><span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span>
			<span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_15</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
		<span class="cm">/* debug q create issue in SR-IOV */</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_9</span> <span class="o">|</span> <span class="n">MBX_8</span> <span class="o">|</span> <span class="n">MBX_7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d7</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d8</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_idc_ack</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10d9</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_IDC_ACK</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">,</span> <span class="n">QLA_IDC_ACK_REGS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10da</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10db</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_fac_get_sector_size</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">sector_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10dc</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_FLASH_ACCESS_CTRL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAC_OPT_CMD_GET_SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10dd</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10de</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="o">*</span><span class="n">sector_size</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_fac_do_write_enable</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10df</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_FLASH_ACCESS_CTRL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">FAC_OPT_CMD_WRITE_ENABLE</span> <span class="o">:</span>
	    <span class="n">FAC_OPT_CMD_WRITE_PROTECT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e0</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e1</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_fac_erase_sector</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">finish</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e2</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_FLASH_ACCESS_CTRL</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAC_OPT_CMD_ERASE_SECTOR</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">finish</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">finish</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e3</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x mb[2]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e4</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_restart_mpi_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e5</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_RESTART_MPI_FW</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="o">|</span><span class="n">MBX_1</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e6</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e7</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_read_sfp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">sfp_dma</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sfp</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e8</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">opt</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_READ_SFP</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">sfp</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10e9</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ea</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_write_sfp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">sfp_dma</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sfp</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10eb</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">opt</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">sfp</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_WRITE_SFP</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">sfp_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ec</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ed</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_get_xgmac_stats</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">stats_dma</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">actual_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ee</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_XGMAC_STATS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_in_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ef</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x mb[2]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f0</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>


		<span class="o">*</span><span class="n">actual_size</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_get_dcbx_params</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">tlv_dma</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f1</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_DCBX_PARAMS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">tlv_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">tlv_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">tlv_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">tlv_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f2</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x mb[2]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f3</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_read_ram_word</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f4</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_READ_RAM_EXTENDED</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f5</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f6</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_loopback_test</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_echo_lb</span> <span class="o">*</span><span class="n">mreq</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mresp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">iter_cnt</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f7</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_DIAGNOSTIC_LOOP_BACK</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|</span> <span class="n">BIT_6</span><span class="p">;</span>	<span class="c1">// BIT_6 specifies 64 bit addressing</span>

	<span class="cm">/* transfer count */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">transfer_size</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">transfer_size</span><span class="p">);</span>

	<span class="cm">/* send data address */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">));</span>

	<span class="cm">/* receive data address */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">));</span>

	<span class="cm">/* Iteration count */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">iter_cnt</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">iter_cnt</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_21</span><span class="o">|</span><span class="n">MBX_20</span><span class="o">|</span><span class="n">MBX_19</span><span class="o">|</span><span class="n">MBX_18</span><span class="o">|</span><span class="n">MBX_17</span><span class="o">|</span><span class="n">MBX_16</span><span class="o">|</span><span class="n">MBX_15</span><span class="o">|</span>
	    <span class="n">MBX_14</span><span class="o">|</span><span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_2</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_19</span><span class="o">|</span><span class="n">MBX_18</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">transfer_size</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="o">|</span><span class="n">MBX_DMA_IN</span><span class="o">|</span><span class="n">IOCTL_CMD</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f8</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x mb[2]=%x mb[3]=%x mb[18]=%x &quot;</span>
		    <span class="s">&quot;mb[19]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		    <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10f9</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Copy mailbox information */</span>
	<span class="n">memcpy</span><span class="p">(</span> <span class="n">mresp</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_echo_test</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_echo_lb</span> <span class="o">*</span><span class="n">mreq</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mresp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10fa</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_DIAGNOSTIC_ECHO</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|</span> <span class="n">BIT_6</span><span class="p">;</span>	<span class="cm">/* BIT_6 specifies 64bit address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_15</span><span class="p">;</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_fcf_idx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">rcv_dma</span><span class="p">));</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">transfer_size</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">mreq</span><span class="o">-&gt;</span><span class="n">send_dma</span><span class="p">));</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_21</span><span class="o">|</span><span class="n">MBX_20</span><span class="o">|</span><span class="n">MBX_17</span><span class="o">|</span><span class="n">MBX_16</span><span class="o">|</span><span class="n">MBX_15</span><span class="o">|</span>
	    <span class="n">MBX_14</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_2</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_3</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="o">|</span><span class="n">MBX_DMA_IN</span><span class="o">|</span><span class="n">IOCTL_CMD</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">mreq</span><span class="o">-&gt;</span><span class="n">transfer_size</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10fb</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x mb[1]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10fc</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Copy mailbox information */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mresp</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla84xx_reset_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">enable_diagnostic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10fd</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s enable_diag=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enable_diagnostic</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_ISP84XX_RESET</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">enable_diagnostic</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="o">|</span><span class="n">MBX_DMA_IN</span><span class="o">|</span><span class="n">IOCTL_CMD</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10fe</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ff</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_write_ram_word</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1100</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_WRITE_RAM_WORD_EXTENDED</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">risc_addr</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_8</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1101</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1102</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_write_mpi_register</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">stat</span><span class="p">,</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1103</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>

	<span class="cm">/* Write the MBC data to the registers */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">,</span> <span class="n">MBC_WRITE_MPI_REGISTER</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_SET_HOST_INT</span><span class="p">);</span>

	<span class="cm">/* Poll for MBC interrupt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span> <span class="n">timer</span><span class="p">;</span> <span class="n">timer</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check for pending interrupts. */</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="mh">0x1</span> <span class="o">||</span> <span class="n">stat</span> <span class="o">==</span> <span class="mh">0x2</span> <span class="o">||</span>
			    <span class="n">stat</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">||</span> <span class="n">stat</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
				<span class="n">mb0</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
				<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span>
				    <span class="n">HCCRX_CLR_RISC_INT</span><span class="p">);</span>
				<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">))</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">mb0</span> <span class="o">&amp;</span> <span class="n">MBS_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1104</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1105</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_get_data_rate</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1106</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_DATA_RATE</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_3</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1107</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1108</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x7</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_get_port_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1109</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_PORT_CONFIG</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x110a</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Copy all bits to preserve original value */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x110b</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_set_port_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x110c</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_PORT_CONFIG</span><span class="p">;</span>
	<span class="cm">/* Copy all bits to preserve original setting */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x110d</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x110e</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">qla24xx_set_fcp_prio</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">priority</span><span class="p">,</span>
		<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x110f</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_PORT_PARAMS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fcp_prio_enabled</span><span class="p">)</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_2</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10cd</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10cc</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_get_thermal_temp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">temp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">frac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">byte</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10ca</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Integer part */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_read_sfp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BIT_13</span><span class="o">|</span><span class="n">BIT_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10c9</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">thermal_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>

	<span class="cm">/* Fraction part */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_read_sfp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BIT_13</span><span class="o">|</span><span class="n">BIT_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1019</span><span class="p">,</span> <span class="s">&quot;Failed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">thermal_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">25</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1018</span><span class="p">,</span>
	    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_mbx_intr_enable</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1017</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbx_cmd_t</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_TOGGLE_INTERRUPT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1016</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100e</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_mbx_intr_disable</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100d</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbx_cmd_t</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_TOGGLE_INTERRUPT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100c</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x100b</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_md_get_template_size</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x111f</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MBC_DIAGNOSTIC_MINIDUMP_TEMPLATE</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MBC_DIAGNOSTIC_MINIDUMP_TEMPLATE</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">RQST_TMPLT_SIZE</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">RQST_TMPLT_SIZE</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_14</span><span class="o">|</span><span class="n">MBX_13</span><span class="o">|</span><span class="n">MBX_12</span><span class="o">|</span><span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span>
	    <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="o">|</span><span class="n">MBX_DMA_IN</span><span class="o">|</span><span class="n">IOCTL_CMD</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="cm">/* Always copy back return mailbox values. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1120</span><span class="p">,</span>
		    <span class="s">&quot;mailbox command FAILED=0x%x, subcode=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1121</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1122</span><span class="p">,</span>
			    <span class="s">&quot;Null template size obtained.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_md_get_template</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1123</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	   <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1124</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for Minidump template.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MBC_DIAGNOSTIC_MINIDUMP_TEMPLATE</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MBC_DIAGNOSTIC_MINIDUMP_TEMPLATE</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">RQST_TMPLT</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">RQST_TMPLT</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MBX_DMA_OUT</span><span class="o">|</span><span class="n">MBX_DMA_IN</span><span class="o">|</span><span class="n">IOCTL_CMD</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_11</span><span class="o">|</span><span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_9</span><span class="o">|</span><span class="n">MBX_8</span><span class="o">|</span>
	    <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1125</span><span class="p">,</span>
		    <span class="s">&quot;mailbox command FAILED=0x%x, subcode=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">((</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		    <span class="p">((</span><span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1126</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_set_led_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">led_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1133</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbx_cmd_t</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_LED_CONFIG</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">|=</span> <span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1134</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1135</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_get_led_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">led_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1136</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbx_cmd_t</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_LED_CONFIG</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">|=</span> <span class="n">MBX_6</span><span class="o">|</span><span class="n">MBX_5</span><span class="o">|</span><span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1137</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">led_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">led_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">led_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">led_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">led_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">led_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1138</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_mbx_beacon_ctl</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1127</span><span class="p">,</span>
		<span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbx_cmd_t</span><span class="p">));</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_LED_CONFIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_7</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1128</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1129</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla83xx_write_remote_reg</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1130</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_WRITE_REMOTE_REG</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_4</span><span class="o">|</span><span class="n">MBX_3</span><span class="o">|</span><span class="n">MBX_2</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>

	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1131</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1132</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_port_logout</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">mbx_cmd_t</span> <span class="o">*</span><span class="n">mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x113b</span><span class="p">,</span>
		    <span class="s">&quot;Implicit LOGO Unsupported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x113c</span><span class="p">,</span>
	    <span class="s">&quot;Entering %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Perform Implicit LOGO. */</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_PORT_LOGOUT</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_15</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">out_mb</span> <span class="o">=</span> <span class="n">MBX_10</span><span class="o">|</span><span class="n">MBX_1</span><span class="o">|</span><span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">in_mb</span> <span class="o">=</span> <span class="n">MBX_0</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">tov</span> <span class="o">=</span> <span class="n">MBX_TOV_SECONDS</span><span class="p">;</span>
	<span class="n">mcp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mailbox_command</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x113d</span><span class="p">,</span>
		    <span class="s">&quot;Failed=%x mb[0]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">mcp</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_mbx</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x113e</span><span class="p">,</span>
		    <span class="s">&quot;Done %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
