<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_mid.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_mid.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_gbl.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="kt">void</span>
<span class="nf">qla2x00_vp_stop_timer</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">&amp;&amp;</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">qla24xx_allocate_vp_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">vp_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Find an empty slot and assign an vp_id */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">vp_id</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp_id</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa000</span><span class="p">,</span>
		    <span class="s">&quot;vp_id %d is bigger than max-supported %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vp_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">vp_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">vp_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_vhosts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="n">vp_id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">);</span>

	<span class="n">qlt_update_vp_map</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">SET_VP_IDX</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vp_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla24xx_deallocate_vp_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">vp_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for all pending activities to finish before removing vport from</span>
<span class="cm">	 * the list.</span>
<span class="cm">	 * Lock needs to be held for safe removal from the list (it</span>
<span class="cm">	 * ensures no active vp_list traversal while the vport is removed</span>
<span class="cm">	 * from the queue)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">qlt_update_vp_map</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RESET_VP_IDX</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">vp_id</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_vhosts</span><span class="o">--</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vp_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">scsi_qla_host_t</span> <span class="o">*</span>
<span class="nf">qla24xx_find_vhost_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">port_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">tvha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Locate matching device in database. */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tvha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">vha</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_mark_vp_devices_dead</span>
<span class="cm"> *	Updates fcport state when device goes offline.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	fcport = port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	None.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_mark_vp_devices_dead</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * !!! NOTE !!!</span>
<span class="cm">	 * This function, if called in contexts other than vp create, disable</span>
<span class="cm">	 * or delete, please make sure this is synchronized with the</span>
<span class="cm">	 * delete thread.</span>
<span class="cm">	 */</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa001</span><span class="p">,</span>
		    <span class="s">&quot;Marking port dead, loop_id=0x%04x : %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

		<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_UNCONFIGURED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_disable_vp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_control_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">VCE_COMMAND_DISABLE_VPS_LOGO_ALL</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>

	<span class="cm">/* Remove port id from vp target map */</span>
	<span class="n">qlt_update_vp_map</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RESET_AL_PA</span><span class="p">);</span>

	<span class="n">qla2x00_mark_vp_devices_dead</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_enable_vp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Check if physical ha port is Up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DOWN</span>  <span class="o">||</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DEAD</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">&amp;</span> <span class="n">ISP_CFG_F</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_err_state</span> <span class="o">=</span>  <span class="n">VP_ERR_PORTDWN</span><span class="p">;</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_LINKDOWN</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enable_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the new vport unless it is a persistent port */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_modify_vp_config</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enable_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x801a</span><span class="p">,</span>
	    <span class="s">&quot;Virtual port with id: %d - Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">enable_failed:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x801b</span><span class="p">,</span>
	    <span class="s">&quot;Virtual port with id: %d - Disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla24xx_configure_vp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fc_vport</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa002</span><span class="p">,</span>
	    <span class="s">&quot;%s: change request #3.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_send_change_request</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa003</span><span class="p">,</span> <span class="s">&quot;Failed to enable &quot;</span>
		    <span class="s">&quot;receiving of RSCN requests: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Corresponds to SCR enabled */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">VP_SCR_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla24xx_configure_vhba</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_ACTIVE</span><span class="p">);</span>
	<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_ACTIVE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_alert_all_vps</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MBA_LIP_OCCURRED</span>:
			<span class="k">case</span> <span class="n">MBA_LOOP_UP</span>:
			<span class="k">case</span> <span class="n">MBA_LOOP_DOWN</span>:
			<span class="k">case</span> <span class="n">MBA_LIP_RESET</span>:
			<span class="k">case</span> <span class="n">MBA_POINT_TO_POINT</span>:
			<span class="k">case</span> <span class="n">MBA_CHG_IN_CONNECTION</span>:
			<span class="k">case</span> <span class="n">MBA_PORT_UPDATE</span>:
			<span class="k">case</span> <span class="n">MBA_RSCN_UPDATE</span>:
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5024</span><span class="p">,</span>
				    <span class="s">&quot;Async_event for VP[%d], mb=0x%x vha=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>
				<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_vp_abort_isp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Physical port will do most of the abort and recovery work. We can</span>
<span class="cm">	 * just treat it as a loop down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
		<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * To exclusively reset vport, we need to log it out first.  Note: this</span>
<span class="cm">	 * control_vp can fail if ISP reset is already issued, this is</span>
<span class="cm">	 * expected, as the vp would be already logged out due to ISP reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">qla24xx_control_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">VCE_COMMAND_DISABLE_VPS_LOGO_ALL</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x801d</span><span class="p">,</span>
	    <span class="s">&quot;Scheduling enable of Vport %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qla24xx_enable_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_do_dpc_vp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4012</span><span class="p">,</span>
	    <span class="s">&quot;Entering %s vp_flags: 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_flags</span><span class="p">);</span>

	<span class="n">qla2x00_do_work</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">VP_IDX_ACQUIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* VP acquired. complete port configuration */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4014</span><span class="p">,</span>
		    <span class="s">&quot;Configure VP scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla24xx_configure_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4015</span><span class="p">,</span>
		    <span class="s">&quot;Configure VP end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4016</span><span class="p">,</span>
		    <span class="s">&quot;FCPort update scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla2x00_update_fcports</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4017</span><span class="p">,</span>
		    <span class="s">&quot;FCPort update end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4018</span><span class="p">,</span>
		    <span class="s">&quot;Relogin needed scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla2x00_relogin</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x4019</span><span class="p">,</span>
		    <span class="s">&quot;Relogin needed end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x401a</span><span class="p">,</span>
			    <span class="s">&quot;Loop resync scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla2x00_loop_resync</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x401b</span><span class="p">,</span>
			    <span class="s">&quot;Loop resync end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_dpc</span> <span class="o">+</span> <span class="n">ql_dbg_verbose</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x401c</span><span class="p">,</span>
	    <span class="s">&quot;Exiting %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_do_dpc_all_vps</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">VP_DPC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">&amp;</span> <span class="n">ISP_CFG_F</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_do_dpc_vp</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_vport_create_req_sanity_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">port_name</span><span class="p">[</span><span class="n">WWN_SIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">roles</span> <span class="o">!=</span> <span class="n">FC_PORT_ROLE_FCP_INITIATOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_UNSUPPORTED</span><span class="p">;</span>

	<span class="cm">/* Check up the F/W and H/W support NPIV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_UNSUPPORTED</span><span class="p">;</span>

	<span class="cm">/* Check up whether npiv supported switch presented */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">switch_cap</span> <span class="o">&amp;</span> <span class="n">FLOGI_MID_SUPPORT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">VPCERR_NO_FABRIC_SUPP</span><span class="p">;</span>

	<span class="cm">/* Check up unique WWPN */</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">port_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">qla24xx_find_vhost_by_name</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">port_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>

	<span class="cm">/* Check up max-npiv-supports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_vhosts</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa004</span><span class="p">,</span>
		    <span class="s">&quot;num_vhosts %ud is bigger &quot;</span>
		    <span class="s">&quot;than max_npiv_vports %ud.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_vhosts</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">VPCERR_UNSUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">scsi_qla_host_t</span> <span class="o">*</span>
<span class="nf">qla24xx_create_vhost</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla2xxx_driver_template</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">qla2x00_create_host</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa005</span><span class="p">,</span>
		    <span class="s">&quot;scsi_host_alloc() failed for vport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
	<span class="cm">/* New host info */</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_vport</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="n">qla24xx_allocate_vp_id</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa006</span><span class="p">,</span>
		    <span class="s">&quot;Couldn&#39;t allocate vp_id.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">create_vhost_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * To fix the issue of processing a parent&#39;s RSCN for the vport before</span>
<span class="cm">	 * its SCR is complete.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">VP_SCR_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_flags</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>

	<span class="n">qla2x00_start_timer</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">qla2x00_timer</span><span class="p">,</span> <span class="n">WATCH_INTERVAL</span><span class="p">);</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_T10_PI_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xenabledif</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">MAX_CMDSZ</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">MAX_BUSES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">ql2xmaxlun</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">qla2xxx_transport_vport_template</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_vport</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xa007</span><span class="p">,</span>
	    <span class="s">&quot;Detect vport hba %ld at address = %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cur_vport_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vha</span><span class="p">;</span>

<span class="nl">create_vhost_failed:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla25xx_free_req_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">que_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">que_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">que_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla25xx_free_rsp_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">que_id</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span> <span class="o">&amp;&amp;</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">have_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">have_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">),</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">que_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">que_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">que_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla25xx_delete_req_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_init_req_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">qla25xx_free_req_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla25xx_delete_rsp_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_init_rsp_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">qla25xx_free_rsp_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Delete all queues for a given vhost */</span>
<span class="kt">int</span>
<span class="nf">qla25xx_delete_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Delete request queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_delete_req_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ea</span><span class="p">,</span>
				    <span class="s">&quot;Couldn&#39;t delete req que %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Delete response queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_delete_rsp_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00eb</span><span class="p">,</span>
				    <span class="s">&quot;Couldn&#39;t delete rsp que %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla25xx_create_req_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">options</span><span class="p">,</span>
	<span class="kt">uint8_t</span> <span class="n">vp_idx</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rsp_que</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">que_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">req_que</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00d9</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for request queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT_24XX</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00da</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocte memory for request_ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">que_id</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">que_id</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00db</span><span class="p">,</span>
		    <span class="s">&quot;No resources to create additional request queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">que_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">=</span> <span class="n">rid</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">=</span> <span class="n">qos</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xc002</span><span class="p">,</span>
	    <span class="s">&quot;queue_id=%d rid=%d vp_idx=%d qos=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">que_id</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00dc</span><span class="p">,</span>
	    <span class="s">&quot;queue_id=%d rid=%d vp_idx=%d qos=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">que_id</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_que</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">rsp_que</span><span class="p">];</span>
	<span class="cm">/* Use alternate PCI bus number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MSB</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">))</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_4</span><span class="p">;</span>
	<span class="cm">/* Use alternate PCI devfn */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LSB</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">))</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_5</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xc003</span><span class="p">,</span>
	    <span class="s">&quot;options=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00dd</span><span class="p">,</span>
	    <span class="s">&quot;options=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">que_id</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ISP_QUE_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">que_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xc004</span><span class="p">,</span>
	    <span class="s">&quot;ring_ptr=%p ring_index=%d, &quot;</span>
	    <span class="s">&quot;cnt=%d id=%d max_q_depth=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">,</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00de</span><span class="p">,</span>
	    <span class="s">&quot;ring_ptr=%p ring_index=%d, &quot;</span>
	    <span class="s">&quot;cnt=%d id=%d max_q_depth=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_init_req_que</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00df</span><span class="p">,</span>
		    <span class="s">&quot;%s failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">que_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

<span class="nl">que_failed:</span>
	<span class="n">qla25xx_free_req_que</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">failed:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla_do_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsp_que</span><span class="p">,</span> <span class="n">q_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* create response queue */</span>
<span class="kt">int</span>
<span class="nf">qla25xx_create_rsp_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">options</span><span class="p">,</span>
	<span class="kt">uint8_t</span> <span class="n">vp_idx</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">que_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for response queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT_MQ</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00e1</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for response ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">que_id</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">que_id</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00e2</span><span class="p">,</span>
		    <span class="s">&quot;No resources to create additional request queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">que_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">que_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00e3</span><span class="p">,</span>
		    <span class="s">&quot;MSIX not enalbled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">que_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">=</span> <span class="n">rid</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00e4</span><span class="p">,</span>
	    <span class="s">&quot;queue_id=%d rid=%d vp_idx=%d hw=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">que_id</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* Use alternate PCI bus number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MSB</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">))</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_4</span><span class="p">;</span>
	<span class="cm">/* Use alternate PCI devfn */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LSB</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">))</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_5</span><span class="p">;</span>
	<span class="cm">/* Enable MSIX handshake mode on for uncapable adapters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_MSIX_NACK_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">BIT_6</span><span class="p">;</span>

	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">que_id</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ISP_QUE_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">que_id</span><span class="p">);</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">rsp_q_in</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">rsp_q_out</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xc00b</span><span class="p">,</span>
	    <span class="s">&quot;options=%x id=%d rsp_q_in=%p rsp_q_out=%p&quot;</span><span class="p">,</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">,</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00e5</span><span class="p">,</span>
	    <span class="s">&quot;options=%x id=%d rsp_q_in=%p rsp_q_out=%p&quot;</span><span class="p">,</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">,</span>
	    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_request_irq</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_init_rsp_que</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00e7</span><span class="p">,</span>
		    <span class="s">&quot;%s failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">que_id</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">que_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">req</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">qla2x00_init_response_q_entries</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">q_work</span><span class="p">,</span> <span class="n">qla_do_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

<span class="nl">que_failed:</span>
	<span class="n">qla25xx_free_rsp_que</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
<span class="nl">failed:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
