<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_target.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_target.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  qla_target.c SCSI LLD infrastructure for QLogic 22xx/23xx/24xx/25xx</span>
<span class="cm"> *</span>
<span class="cm"> *  based on qla2x00t.c code:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004 - 2010 Vladislav Bolkhovitin &lt;vst@vlnb.net&gt;</span>
<span class="cm"> *  Copyright (C) 2004 - 2005 Leonid Stoljar</span>
<span class="cm"> *  Copyright (C) 2006 Nathaniel Clark &lt;nate@misrule.us&gt;</span>
<span class="cm"> *  Copyright (C) 2006 - 2010 ID7 Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *  Forward port and refactoring to modern qla2xxx and target/configfs</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2010-2011 Nicholas A. Bellinger &lt;nab@kernel.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation, version 2</span>
<span class="cm"> *  of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;target/target_core_base.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric.h&gt;</span>

<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">qlini_mode</span> <span class="o">=</span> <span class="n">QLA2XXX_INI_MODE_STR_ENABLED</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlini_mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlini_mode</span><span class="p">,</span>
	<span class="s">&quot;Determines when initiator mode will be enabled. Possible values: &quot;</span>
	<span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">exclusive</span><span class="se">\&quot;</span><span class="s"> - initiator mode will be enabled on load, &quot;</span>
	<span class="s">&quot;disabled on enabling target mode and then on disabling target mode &quot;</span>
	<span class="s">&quot;enabled back; &quot;</span>
	<span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">disabled</span><span class="se">\&quot;</span><span class="s"> - initiator mode will never be enabled; &quot;</span>
	<span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">enabled</span><span class="se">\&quot;</span><span class="s"> (default) - initiator mode will always stay enabled.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ql2x_ini_mode</span> <span class="o">=</span> <span class="n">QLA2XXX_INI_MODE_EXCLUSIVE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * From scsi/fc/fc_fcp.h</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">fcp_resp_rsp_codes</span> <span class="p">{</span>
	<span class="n">FCP_TMF_CMPL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">FCP_DATA_LEN_INVALID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">FCP_CMND_FIELDS_INVALID</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">FCP_DATA_PARAM_MISMATCH</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">FCP_TMF_REJECTED</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">FCP_TMF_FAILED</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">FCP_TMF_INVALID_LUN</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fc_pri_ta from scsi/fc/fc_fcp.h</span>
<span class="cm"> */</span>
<span class="cp">#define FCP_PTA_SIMPLE      0   </span><span class="cm">/* simple task attribute */</span><span class="cp"></span>
<span class="cp">#define FCP_PTA_HEADQ       1   </span><span class="cm">/* head of queue task attribute */</span><span class="cp"></span>
<span class="cp">#define FCP_PTA_ORDERED     2   </span><span class="cm">/* ordered task attribute */</span><span class="cp"></span>
<span class="cp">#define FCP_PTA_ACA         4   </span><span class="cm">/* auto. contigent allegiance */</span><span class="cp"></span>
<span class="cp">#define FCP_PTA_MASK        7   </span><span class="cm">/* mask for task attribute field */</span><span class="cp"></span>
<span class="cp">#define FCP_PRI_SHIFT       3   </span><span class="cm">/* priority field starts in bit 3 */</span><span class="cp"></span>
<span class="cp">#define FCP_PRI_RESVD_MASK  0x80        </span><span class="cm">/* reserved bits in priority field */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * This driver calls qla2x00_alloc_iocbs() and qla2x00_issue_marker(), which</span>
<span class="cm"> * must be called under HW lock and could unlock/lock it inside.</span>
<span class="cm"> * It isn&#39;t an issue, since in the current implementation on the time when</span>
<span class="cm"> * those functions are called:</span>
<span class="cm"> *</span>
<span class="cm"> *   - Either context is IRQ and only IRQ handler can modify HW data,</span>
<span class="cm"> *     including rings related fields,</span>
<span class="cm"> *</span>
<span class="cm"> *   - Or access to target mode variables from struct qla_tgt doesn&#39;t</span>
<span class="cm"> *     cross those functions boundaries, except tgt_stop, which</span>
<span class="cm"> *     additionally protected by irq_cmd_count.</span>
<span class="cm"> */</span>
<span class="cm">/* Predefs for callbacks handed to qla2xxx LLD */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlt_24xx_atio_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlt_response_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">response_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlt_issue_task_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">lun</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt_cmd</span>
	<span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ha_locked</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlt_reject_free_srr_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">imm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ha_lock</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * Global Variables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">qla_tgt_mgmt_cmd_cachep</span><span class="p">;</span>
<span class="k">static</span> <span class="n">mempool_t</span> <span class="o">*</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">qla_tgt_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">qla_tgt_glist</span><span class="p">);</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry (to protect tgt-&gt;sess_list) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="nf">qlt_find_sess_by_port_name</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">port_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">,</span> <span class="n">sess_list_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">sess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Might release hw lock, then reaquire!! */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qlt_issue_marker</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vha_locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">qla2x00_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha_locked</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe03d</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): issue_marker() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="nf">qlt_find_host_by_d_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">d_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">vp_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">!=</span> <span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">!=</span> <span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">==</span> <span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">vha</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">vp_idx</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]].</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">vha</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="nf">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">vp_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span> <span class="o">==</span> <span class="n">vp_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vha</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">vha</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlt_24xx_atio_pkt_all_vps</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATIO_TYPE7</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_d_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">d_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe03e</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Received ATIO_TYPE7 &quot;</span>
			    <span class="s">&quot;with unknown d_id %x:%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
			    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qlt_24xx_atio_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IMMED_NOTIFY_TYPE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">atio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe03f</span><span class="p">,</span>
				    <span class="s">&quot;qla_target(%d): Received &quot;</span>
				    <span class="s">&quot;ATIO (IMMED_NOTIFY_TYPE) &quot;</span>
				    <span class="s">&quot;with unknown vp_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">qlt_24xx_atio_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe040</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Received unknown ATIO atio &quot;</span>
		    <span class="s">&quot;type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlt_response_pkt_all_vps</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">response_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTIO_TYPE7</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">ctio7_from_24xx</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_from_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vp_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe041</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Response pkt (CTIO_TYPE7) &quot;</span>
			    <span class="s">&quot;received, with unknown vp_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vp_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qlt_response_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IMMED_NOTIFY_TYPE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>

		<span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe042</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Response pkt (IMMED_NOTIFY_TYPE) &quot;</span>
			    <span class="s">&quot;received, with unknown vp_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qlt_response_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">NOTIFY_ACK_TYPE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nack_to_isp</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nack_to_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">!=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe043</span><span class="p">,</span>
				    <span class="s">&quot;qla_target(%d): Response &quot;</span>
				    <span class="s">&quot;pkt (NOTIFY_ACK_TYPE) &quot;</span>
				    <span class="s">&quot;received, with unknown &quot;</span>
				    <span class="s">&quot;vp_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
				    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">qlt_response_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">ABTS_RECV_24XX</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vp_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe044</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Response pkt &quot;</span>
			    <span class="s">&quot;(ABTS_RECV_24XX) received, with unknown &quot;</span>
			    <span class="s">&quot;vp_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vp_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qlt_response_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">ABTS_RESP_24XX</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">abts_resp_to_24xx</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">abts_resp_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">qlt_find_host_by_vp_idx</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vp_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe045</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Response pkt &quot;</span>
			    <span class="s">&quot;(ABTS_RECV_24XX) received, with unknown &quot;</span>
			    <span class="s">&quot;vp_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vp_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qlt_response_pkt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">qlt_response_pkt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_free_session_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span><span class="p">,</span>
	    <span class="n">free_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Release the target session for FC Nexus from fabric module code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">free_session</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf001</span><span class="p">,</span>
	    <span class="s">&quot;Unregistration of sess %p finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to protect against race, when tgt is freed before or</span>
<span class="cm">	 * inside wake_up()</span>
<span class="cm">	 */</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">waitQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="kt">void</span> <span class="nf">qlt_unreg_sess</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">clear_nacl_from_fcport_map</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_list_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">del_list_entry</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">free_work</span><span class="p">,</span> <span class="n">qlt_free_session_done</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">free_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_unreg_sess</span><span class="p">);</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">loop_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loop_id</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* FIXME: Re-enable Global event handling.. */</span>
<span class="c">		/* Global event */</span>
<span class="c">		atomic_inc(&amp;ha-&gt;tgt.qla_tgt-&gt;tgt_global_resets_count);</span>
<span class="c">		qlt_clear_tgt_db(ha-&gt;tgt.qla_tgt, 1);</span>
<span class="c">		if (!list_empty(&amp;ha-&gt;tgt.qla_tgt-&gt;sess_list)) {</span>
<span class="c">			sess = list_entry(ha-&gt;tgt.qla_tgt-&gt;sess_list.next,</span>
<span class="c">			    typeof(*sess), sess_list_entry);</span>
<span class="c">			switch (mcmd) {</span>
<span class="c">			case QLA_TGT_NEXUS_LOSS_SESS:</span>
<span class="c">				mcmd = QLA_TGT_NEXUS_LOSS;</span>
<span class="c">				break;</span>
<span class="c">			case QLA_TGT_ABORT_ALL_SESS:</span>
<span class="c">				mcmd = QLA_TGT_ABORT_ALL;</span>
<span class="c">				break;</span>
<span class="c">			case QLA_TGT_NEXUS_LOSS:</span>
<span class="c">			case QLA_TGT_ABORT_ALL:</span>
<span class="c">				break;</span>
<span class="c">			default:</span>
<span class="c">				ql_dbg(ql_dbg_tgt, vha, 0xe046,</span>
<span class="c">				    &quot;qla_target(%d): Not allowed &quot;</span>
<span class="c">				    &quot;command %x in %s&quot;, vha-&gt;vp_idx,</span>
<span class="c">				    mcmd, __func__);</span>
<span class="c">				sess = NULL;</span>
<span class="c">				break;</span>
<span class="c">			}</span>
<span class="c">		} else</span>
<span class="c">			sess = NULL;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_loop_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe000</span><span class="p">,</span>
	    <span class="s">&quot;Using sess for qla_tgt_reset: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe047</span><span class="p">,</span>
	    <span class="s">&quot;scsi(%ld): resetting (session %p from port &quot;</span>
	    <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x, &quot;</span>
	    <span class="s">&quot;mcmd %x, loop_id %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
	    <span class="n">mcmd</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">qlt_issue_task_mgmt</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">mcmd</span><span class="p">,</span>
	    <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA24XX_MGMT_SEND_NACK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_schedule_sess_for_deletion</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">immediate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe001</span><span class="p">,</span>
	    <span class="s">&quot;Scheduling sess %p for deletion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">del_list_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">del_sess_list</span><span class="p">);</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">immediate</span><span class="p">)</span>
		<span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">dev_loss_tmo</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe048</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): session for port %02x:%02x:%02x:&quot;</span>
	    <span class="s">&quot;%02x:%02x:%02x:%02x:%02x (loop ID %d) scheduled for &quot;</span>
	    <span class="s">&quot;deletion in %u secs (expires: %lu) immed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">dev_loss_tmo</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">,</span> <span class="n">immediate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">immediate</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_del_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_del_work</span><span class="p">,</span>
		    <span class="n">jiffies</span> <span class="o">-</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_clear_tgt_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">bool</span> <span class="n">local_only</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">,</span> <span class="n">sess_list_entry</span><span class="p">)</span>
		<span class="n">qlt_schedule_sess_for_deletion</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* At this point tgt could be already dead */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla24xx_get_loop_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">s_id</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">loop_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">gid_list_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="n">gid_list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">id_iter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">entries</span><span class="p">;</span>

	<span class="n">gid_list</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">),</span>
	    <span class="o">&amp;</span><span class="n">gid_list_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gid_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf044</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): DMA Alloc failed of %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get list of logged in devices */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla2x00_get_id_list</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">gid_list_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf045</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): get_id_list() failed: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_id_list</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">id_iter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">gid_list</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="n">gid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="p">)</span><span class="n">id_iter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">al_pa</span> <span class="o">==</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">area</span> <span class="o">==</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">==</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">gid</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">id_iter</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free_id_list:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">),</span>
	    <span class="n">gid_list</span><span class="p">,</span> <span class="n">gid_list_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">qlt_check_fcport_exist</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_port_24xx_data</span> <span class="o">*</span><span class="n">pmap24</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">res</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">loop_id</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span> <span class="cm">/* to eliminate compiler&#39;s warning */</span>
	<span class="kt">uint16_t</span> <span class="n">entries</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmap_len</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">global_resets</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="n">global_resets</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla2x00_get_node_name_list</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmap_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmap24</span> <span class="o">=</span> <span class="n">pmap</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">pmap_len</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmap24</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">pmap24</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">loop_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pmap24</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf046</span><span class="p">,</span>
	    <span class="s">&quot;qlt_check_fcport_exist(): loop_id %d&quot;</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>

	<span class="n">fcport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf047</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Allocation of tmp FC port failed&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla2x00_get_port_database</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf048</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Failed to retrieve fcport &quot;</span>
		    <span class="s">&quot;information -- get_port_database() returned %x &quot;</span>
		    <span class="s">&quot;(loop_id=0x%04x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_fcport</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">global_resets</span> <span class="o">!=</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf002</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): global reset during session discovery&quot;</span>
		    <span class="s">&quot; (counter was %d, new %d), retrying&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">global_resets</span><span class="p">,</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf003</span><span class="p">,</span>
	    <span class="s">&quot;Updating sess %p s_id %x:%x:%x, loop_id %d) to d_id %x:%x:%x, &quot;</span>
	    <span class="s">&quot;loop_id %d&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">;</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">out_free_fcport:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_undelete_sess</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">del_list_entry</span><span class="p">);</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_del_sess_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt</span><span class="p">,</span>
	    <span class="n">sess_del_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">del_sess_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">del_sess_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">sess</span><span class="p">),</span>
		    <span class="n">del_list_entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">cancel</span><span class="p">;</span>

			<span class="n">qlt_undelete_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cancel</span> <span class="o">=</span> <span class="n">qlt_check_fcport_exist</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cancel</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * sess was again deleted while we were</span>
<span class="cm">					 * discovering it</span>
<span class="cm">					 */</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span>
					    <span class="n">flags</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf049</span><span class="p">,</span>
				    <span class="s">&quot;qla_target(%d): cancel deletion of &quot;</span>
				    <span class="s">&quot;session for port %02x:%02x:%02x:%02x:%02x:&quot;</span>
				    <span class="s">&quot;%02x:%02x:%02x (loop ID %d), because &quot;</span>
				    <span class="s">&quot; it isn&#39;t deleted by firmware&quot;</span><span class="p">,</span>
				    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
				    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf004</span><span class="p">,</span>
				    <span class="s">&quot;Timeout: sess %p about to be deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">sess</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">shutdown_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_del_work</span><span class="p">,</span>
			    <span class="n">jiffies</span> <span class="o">-</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adds an extra ref to allow to drop hw lock after adding sess to the list.</span>
<span class="cm"> * Caller must put it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="nf">qlt_create_sess</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">be_sid</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Check to avoid double sessions */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">,</span>
				<span class="n">sess_list_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf005</span><span class="p">,</span>
			    <span class="s">&quot;Double sess %p found (s_id %x:%x:%x, &quot;</span>
			    <span class="s">&quot;loop_id %d), updating to d_id %x:%x:%x, &quot;</span>
			    <span class="s">&quot;loop_id %d&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span>
				<span class="n">qlt_undelete_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>

			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">sess_kref</span><span class="p">);</span>
			<span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">;</span>
			<span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
			<span class="n">sess</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
			    <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="p">)</span>
				<span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">sess</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sess</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf04a</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%u): session allocation failed, &quot;</span>
		    <span class="s">&quot;all commands from port %02x:%02x:%02x:%02x:&quot;</span>
		    <span class="s">&quot;%02x:%02x:%02x:%02x will be refused&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">;</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf006</span><span class="p">,</span>
	    <span class="s">&quot;Adding sess %p to tgt %p via -&gt;check_initiator_node_acl()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sess</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">);</span>

	<span class="n">be_sid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">be_sid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">be_sid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Determine if this fc_port-&gt;port_name is allowed to access</span>
<span class="cm">	 * target mode using explict NodeACLs+MappedLUNs, or using</span>
<span class="cm">	 * TPG demo mode.  If this is successful a target mode FC nexus</span>
<span class="cm">	 * is created.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">check_initiator_node_acl</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">be_sid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Take an extra reference to -&gt;sess_kref here to handle qla_tgt_sess</span>
<span class="cm">	 * access across -&gt;hardware_lock reaquire.</span>
<span class="cm">	 */</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">sess_kref</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">sess_list_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">sess_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf04b</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): %ssession for wwn %02x:%02x:%02x:%02x:&quot;</span>
	    <span class="s">&quot;%02x:%02x:%02x:%02x (loop_id %d, s_id %x:%x:%x, confirmed&quot;</span>
	    <span class="s">&quot; completion %ssupported) added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">local</span> <span class="o">?</span>  <span class="s">&quot;local &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
	    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span> <span class="o">?</span>
	    <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sess</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from drivers/scsi/qla2xxx/qla_init.c:qla2x00_reg_remote_port()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qlt_fc_port_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span> <span class="o">||</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_INITIATOR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_find_sess_by_port_name</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_create_sess</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">sess_kref</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlt_undelete_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf04c</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%u): %ssession for port %02x:&quot;</span>
			    <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x:%02x (loop ID %d) &quot;</span>
			    <span class="s">&quot;reappeared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">?</span> <span class="s">&quot;local &quot;</span>
			    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf007</span><span class="p">,</span>
			    <span class="s">&quot;Reappeared sess %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">s_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">;</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span> <span class="o">&amp;&amp;</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf04d</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%u): local session for &quot;</span>
		    <span class="s">&quot;port %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x &quot;</span>
		    <span class="s">&quot;(loop ID %d) became global</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlt_fc_port_deleted</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span> <span class="o">||</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_INITIATOR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_find_sess_by_port_name</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf008</span><span class="p">,</span> <span class="s">&quot;qla_tgt_fc_port_deleted %p&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qlt_schedule_sess_for_deletion</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">test_tgt_sess_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to protect against race, when tgt is freed before or</span>
<span class="cm">	 * inside wake_up()</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe002</span><span class="p">,</span>
	    <span class="s">&quot;tgt %p, empty(sess_list)=%d sess_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">tgt</span><span class="p">,</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_count</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by tcm_qla2xxx configfs code */</span>
<span class="kt">void</span> <span class="nf">qlt_stop_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span> <span class="o">||</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf04e</span><span class="p">,</span>
		    <span class="s">&quot;Already in tgt-&gt;tgt_stop or tgt_stopped state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe003</span><span class="p">,</span> <span class="s">&quot;Stopping target for host %ld(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Mutex needed to sync with qla_tgt_fc_port_[added,deleted].</span>
<span class="cm">	 * Lock is needed, because we still can get an incoming packet.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qlt_clear_tgt_db</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>

	<span class="n">flush_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_del_work</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf009</span><span class="p">,</span>
	    <span class="s">&quot;Waiting for sess works (tgt %p)&quot;</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_works_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">flush_scheduled_work</span><span class="p">();</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf00a</span><span class="p">,</span>
	    <span class="s">&quot;Waiting for tgt %p: list_empty(sess_list)=%d &quot;</span>
	    <span class="s">&quot;sess_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">),</span>
	    <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_count</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">waitQ</span><span class="p">,</span> <span class="n">test_tgt_sess_count</span><span class="p">(</span><span class="n">tgt</span><span class="p">));</span>

	<span class="cm">/* Big hammer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">host_shutting_down</span> <span class="o">&amp;&amp;</span> <span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">qlt_disable_vha</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Wait for sessions to clear out (just in case) */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">waitQ</span><span class="p">,</span> <span class="n">test_tgt_sess_count</span><span class="p">(</span><span class="n">tgt</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_stop_phase1</span><span class="p">);</span>

<span class="cm">/* Called by tcm_qla2xxx configfs code */</span>
<span class="kt">void</span> <span class="nf">qlt_stop_phase2</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf04f</span><span class="p">,</span>
		    <span class="s">&quot;Already in tgt-&gt;tgt_stopped state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf00b</span><span class="p">,</span>
	    <span class="s">&quot;Waiting for %d IRQ commands to complete (tgt %p)&quot;</span><span class="p">,</span>
	    <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf00c</span><span class="p">,</span> <span class="s">&quot;Stop of tgt %p finished&quot;</span><span class="p">,</span>
	    <span class="n">tgt</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_stop_phase2</span><span class="p">);</span>

<span class="cm">/* Called from qlt_remove_target() -&gt; qla2x00_remove_one() */</span>
<span class="kt">void</span> <span class="nf">qlt_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stopped</span><span class="p">)</span>
		<span class="n">qlt_stop_phase2</span><span class="p">(</span><span class="n">tgt</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf00d</span><span class="p">,</span>
	    <span class="s">&quot;Release of tgt %p finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tgt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_sched_sess_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess_work_param</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">prm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">prm</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf050</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Unable to create session &quot;</span>
		    <span class="s">&quot;work, command will be refused&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf00e</span><span class="p">,</span>
	    <span class="s">&quot;Scheduling work (type %d, prm %p)&quot;</span>
	    <span class="s">&quot; to find session for param %p (size %d, tgt %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">type</span><span class="p">,</span> <span class="n">prm</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">tm_iocb</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sess_works_list_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_works_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_send_notify_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">ntfy</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">add_flags</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">resp_code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">resp_code_valid</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">srr_flags</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">srr_reject_code</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">srr_explan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">request_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nack_to_isp</span> <span class="o">*</span><span class="n">nack</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe004</span><span class="p">,</span> <span class="s">&quot;Sending NOTIFY_ACK (ha=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">request_t</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe049</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s failed: unable to allocate &quot;</span>
		    <span class="s">&quot;request packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">notify_ack_expected</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">NOTIFY_ACK_TYPE</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">nack</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nack_to_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">;</span>

	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">IMM_NTFY_ELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">NOTIFY24XX_FLAGS_PUREX_IOCB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_rx_id</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_rx_id</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_address</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_address</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_rel_offs</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_rel_offs</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_ui</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_ui</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">srr_flags</span><span class="p">);</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_reject_code</span> <span class="o">=</span> <span class="n">srr_reject_code</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_reject_code_expl</span> <span class="o">=</span> <span class="n">srr_explan</span><span class="p">;</span>
	<span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">vp_index</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe005</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): Sending 24xx Notify Ack %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">nack</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="n">abts</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">ids_reversed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abts_resp_to_24xx</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">f_ctl</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe006</span><span class="p">,</span>
	    <span class="s">&quot;Sending task mgmt ABTS response (ha=%p, atio=%p, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">abts_resp_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe04a</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s failed: unable to allocate &quot;</span>
		    <span class="s">&quot;request packet&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">ABTS_RESP_24XX</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">nport_handle</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">sof_type</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">sof_type</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">exchange_address</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">exchange_address</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">;</span>
	<span class="n">f_ctl</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">F_CTL_EXCH_CONTEXT_RESP</span> <span class="o">|</span>
	    <span class="n">F_CTL_LAST_SEQ</span> <span class="o">|</span> <span class="n">F_CTL_END_SEQ</span> <span class="o">|</span>
	    <span class="n">F_CTL_SEQ_INITIATIVE</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">f_ctl</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">f_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">f_ctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">f_ctl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ids_reversed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">exchange_addr_to_abort</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">exchange_addr_to_abort</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">FCP_TMF_CMPL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">r_ctl</span> <span class="o">=</span> <span class="n">R_CTL_BASIC_LINK_SERV</span> <span class="o">|</span> <span class="n">R_CTL_B_ACC</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ba_acct</span><span class="p">.</span><span class="n">seq_id_valid</span> <span class="o">=</span> <span class="n">SEQ_ID_INVALID</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ba_acct</span><span class="p">.</span><span class="n">low_seq_cnt</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ba_acct</span><span class="p">.</span><span class="n">high_seq_cnt</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ba_acct</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">ox_id</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ba_acct</span><span class="p">.</span><span class="n">rx_id</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">rx_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">r_ctl</span> <span class="o">=</span> <span class="n">R_CTL_BASIC_LINK_SERV</span> <span class="o">|</span> <span class="n">R_CTL_B_RJT</span><span class="p">;</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">ba_rjt</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">=</span>
			<span class="n">BA_RJT_REASON_CODE_UNABLE_TO_PERFORM</span><span class="p">;</span>
		<span class="cm">/* Other bytes are zero */</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">abts_resp_expected</span><span class="o">++</span><span class="p">;</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_24xx_retry_term_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">abts_resp_from_24xx_fw</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">ctio</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe007</span><span class="p">,</span>
	    <span class="s">&quot;Sending retry TERM EXCH CTIO7 (ha=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctio</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe04b</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s failed: unable to allocate &quot;</span>
		    <span class="s">&quot;request packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;ve got on entrance firmware&#39;s response on by us generated</span>
<span class="cm">	 * ABTS response. So, in it ID fields are reversed.</span>
<span class="cm">	 */</span>

	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CTIO_TYPE7</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">nport_handle</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">QLA_TGT_SKIP_HANDLE</span> <span class="o">|</span>	<span class="n">CTIO_COMPLETION_HANDLE_MARK</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">QLA_TGT_TIMEOUT</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">exchange_addr</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">exchange_addr_to_abort</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_1</span> <span class="o">|</span>
		<span class="n">CTIO7_FLAGS_TERMINATE</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">ox_id</span><span class="p">;</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>

	<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">,</span>
	    <span class="n">FCP_TMF_CMPL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qlt_24xx_handle_abts</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="n">abts</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf00f</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): task abort (tag=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">exchange_addr_to_abort</span><span class="p">);</span>

	<span class="n">mcmd</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf051</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s: Allocation of ABORT cmd failed&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mcmd</span><span class="p">));</span>

	<span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">abts</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">abts</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">handle_tmr</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TMR_ABORT_TASK</span><span class="p">,</span>
	    <span class="n">abts</span><span class="o">-&gt;</span><span class="n">exchange_addr_to_abort</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf052</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d):  tgt_ops-&gt;handle_tmr()&quot;</span>
		    <span class="s">&quot; failed: %d&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_24xx_handle_abts</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="n">abts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">exchange_addr_to_abort</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ABTS_PARAM_ABORT_SEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf053</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): ABTS: Abort Sequence not &quot;</span>
		    <span class="s">&quot;supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="n">FCP_TMF_REJECTED</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">ATIO_EXCHANGE_ADDRESS_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf010</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): ABTS: Unknown Exchange &quot;</span>
		    <span class="s">&quot;Address received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="n">FCP_TMF_REJECTED</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf011</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): task abort (s_id=%x:%x:%x, &quot;</span>
	    <span class="s">&quot;tag=%d, param=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag</span><span class="p">,</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">parameter</span><span class="p">));</span>

	<span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">abts</span><span class="o">-&gt;</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_s_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf012</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): task abort for non-existant session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qlt_sched_sess_work</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">,</span>
		    <span class="n">QLA_TGT_SESS_WORK_ABORT</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">abts</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="n">FCP_TMF_REJECTED</span><span class="p">,</span>
			    <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">__qlt_24xx_handle_abts</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf054</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): __qlt_24xx_handle_abts() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">abts</span><span class="p">,</span> <span class="n">FCP_TMF_REJECTED</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_24xx_send_task_mgmt_ctio</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">resp_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">atio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">ctio</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="mh">0xe008</span><span class="p">,</span>
	    <span class="s">&quot;Sending task mgmt CTIO7 (ha=%p, atio=%p, resp_code=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="n">resp_code</span><span class="p">);</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctio</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="mh">0xe04c</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s failed: unable to allocate &quot;</span>
		    <span class="s">&quot;request packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CTIO_TYPE7</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">QLA_TGT_SKIP_HANDLE</span> <span class="o">|</span> <span class="n">CTIO_COMPLETION_HANDLE_MARK</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">QLA_TGT_TIMEOUT</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">exchange_addr</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_addr</span><span class="p">;</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_1</span> <span class="o">|</span>
		<span class="n">CTIO7_FLAGS_SEND_STATUS</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">ox_id</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">SS_RESPONSE_INFO_LEN_VALID</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">response_len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">resp_code</span><span class="p">);</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlt_free_mcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_free_mcmd</span><span class="p">);</span>

<span class="cm">/* callback from target fabric module code */</span>
<span class="kt">void</span> <span class="nf">qlt_xmit_tm_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf013</span><span class="p">,</span>
	    <span class="s">&quot;TM response mcmd (%p) status %#x state %#x&quot;</span><span class="p">,</span>
	    <span class="n">mcmd</span><span class="p">,</span> <span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">fc_tm_rsp</span><span class="p">,</span> <span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">QLA24XX_MGMT_SEND_NACK</span><span class="p">)</span>
		<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">imm_ntfy</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">.</span><span class="n">se_tmr_req</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">TMR_ABORT_TASK</span><span class="p">)</span>
			<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">abts</span><span class="p">,</span>
			    <span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">fc_tm_rsp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qlt_24xx_send_task_mgmt_ctio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mcmd</span><span class="p">,</span>
			    <span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">fc_tm_rsp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make the callback for -&gt;free_mcmd() to queue_work() and invoke</span>
<span class="cm">	 * target_put_sess_cmd() to drop cmd_kref to 1.  The final</span>
<span class="cm">	 * target_put_sess_cmd() call will be made from TFO-&gt;check_stop_free()</span>
<span class="cm">	 * -&gt; tcm_qla2xxx_check_stop_free() to release the TMR associated se_cmd</span>
<span class="cm">	 * descriptor after TFO-&gt;queue_tm_rsp() -&gt; tcm_qla2xxx_queue_tm_rsp() -&gt;</span>
<span class="cm">	 * qlt_xmit_tm_rsp() returns here..</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">free_mcmd</span><span class="p">(</span><span class="n">mcmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_xmit_tm_rsp</span><span class="p">);</span>

<span class="cm">/* No locks */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_pci_map_calc_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="o">*</span><span class="n">prm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma_data_direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If greater than four sg entries then we need to allocate</span>
<span class="cm">	 * the continuation entries</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cmd</span><span class="p">)</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">req_cnt</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">-</span>
		    <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cmd</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cont</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe009</span><span class="p">,</span> <span class="s">&quot;seg_cnt=%d, req_cnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">req_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe04d</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): PCI mapping failed: sg_cnt=%d&quot;</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlt_unmap_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma_data_direction</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_check_reserve_free_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">req_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe00a</span><span class="p">,</span>
		    <span class="s">&quot;Request ring circled: cnt=%d, vha-&gt;-&gt;ring_index=%d, &quot;</span>
		    <span class="s">&quot;vha-&gt;req-&gt;cnt=%d, req_cnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">);</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe00b</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): There is no room in the &quot;</span>
		    <span class="s">&quot;request ring: vha-&gt;req-&gt;ring_index=%d, vha-&gt;req-&gt;cnt=%d, &quot;</span>
		    <span class="s">&quot;req_cnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">qlt_get_req_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cont_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="nf">qlt_make_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">current_handle</span><span class="p">;</span>
	<span class="cm">/* always increment cmd handle */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">h</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
			<span class="n">h</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 0 is QLA_TGT_NULL_HANDLE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">current_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe04e</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Ran out of &quot;</span>
			    <span class="s">&quot;empty cmd slots in ha %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">QLA_TGT_NULL_HANDLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">h</span> <span class="o">==</span> <span class="n">QLA_TGT_NULL_HANDLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">QLA_TGT_SKIP_HANDLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">!=</span> <span class="n">QLA_TGT_NULL_HANDLE</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">current_handle</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_24xx_build_ctio_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="o">*</span><span class="n">prm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">;</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pkt</span><span class="p">));</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CTIO_TYPE7</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">qlt_make_handle</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">QLA_TGT_NULL_HANDLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * CTIO type 7 from the firmware doesn&#39;t provide a way to</span>
<span class="cm">		 * know the initiator&#39;s LOOP ID, hence we can&#39;t find</span>
<span class="cm">		 * the session and, so, the command.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">h</span> <span class="o">|</span> <span class="n">CTIO_COMPLETION_HANDLE_MARK</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">QLA_TGT_TIMEOUT</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">exchange_addr</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_addr</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">ox_id</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">relative_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe00c</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): handle(cmd) -&gt; %08x, timeout %d, ox_id %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">QLA_TGT_TIMEOUT</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">ox_id</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. We have already made sure</span>
<span class="cm"> * that there is sufficient amount of request entries to not drop it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_load_cont_data_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="o">*</span><span class="n">prm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dword_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_64bit_addressing</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_enable_64bit_addr</span><span class="p">;</span>

	<span class="cm">/* Build continuation packets */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="n">cont_pkt64</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">cont_a64_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">qlt_get_req_pkt</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make sure that from cont_pkt64 none of</span>
<span class="cm">		 * 64-bit specific fields used for 32-bit</span>
<span class="cm">		 * addressing. Cast to (cont_entry_t *) for</span>
<span class="cm">		 * that.</span>
<span class="cm">		 */</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cont_pkt64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cont_pkt64</span><span class="p">));</span>

		<span class="n">cont_pkt64</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cont_pkt64</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable_64bit_addressing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cont_pkt64</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CONTINUE_A64_TYPE</span><span class="p">;</span>
			<span class="n">dword_ptr</span> <span class="o">=</span>
			    <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cont_pkt64</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cont_pkt64</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CONTINUE_TYPE</span><span class="p">;</span>
			<span class="n">dword_ptr</span> <span class="o">=</span>
			    <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">cont_entry_t</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">cont_pkt64</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Load continuation entry data segments */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cont</span> <span class="o">&amp;&amp;</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="p">;</span>
		    <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span>
				<span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">enable_64bit_addressing</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span>
					<span class="p">(</span><span class="n">sg_dma_address</span>
					<span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">));</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe00d</span><span class="p">,</span>
			    <span class="s">&quot;S/G Segment Cont. phys_addr=%llx:%llx, len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
			    <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)),</span>
			    <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
			    <span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)),</span>
			    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">));</span>

			<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. We have already made sure</span>
<span class="cm"> * that there is sufficient amount of request entries to not drop it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_load_data_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="o">*</span><span class="n">prm</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dword_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_64bit_addressing</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_enable_64bit_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">pkt24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe00e</span><span class="p">,</span>
	    <span class="s">&quot;iocb-&gt;scsi_status=%x, iocb-&gt;flags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">scsi_status</span><span class="p">),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">pkt24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">);</span>

	<span class="cm">/* Setup packet address segment pointer */</span>
	<span class="n">dword_ptr</span> <span class="o">=</span> <span class="n">pkt24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">dseg_0_address</span><span class="p">;</span>

	<span class="cm">/* Set total data segment count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="p">)</span>
		<span class="n">pkt24</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No data transfer */</span>
		<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dword_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If scatter gather */</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe00f</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Building S/G data segments...&quot;</span><span class="p">);</span>

	<span class="cm">/* Load command entry data segments */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="p">;</span>
	    <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable_64bit_addressing</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span><span class="p">(</span>
				<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">));</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe010</span><span class="p">,</span>
		    <span class="s">&quot;S/G Segment phys_addr=%llx:%llx, len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span>
		    <span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)),</span>
		    <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span>
		    <span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)),</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">));</span>

		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qlt_load_cont_data_segments</span><span class="p">(</span><span class="n">prm</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qlt_has_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called without ha-&gt;hardware_lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_pre_xmit_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="o">*</span><span class="n">prm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xmit_type</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">scsi_status</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">full_req_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">aborted</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf014</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): terminating exchange &quot;</span>
		    <span class="s">&quot;for aborted cmd=%p (se_cmd=%p, tag=%d)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
		    <span class="n">se_cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLA_TGT_STATE_ABORTED</span><span class="p">;</span>

		<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* !! At this point cmd could be already freed !! */</span>
		<span class="k">return</span> <span class="n">QLA_TGT_PRE_XMIT_RESP_CMD_ABORTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe011</span><span class="p">,</span> <span class="s">&quot;qla_target(%d): tag=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">tgt</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span> <span class="o">=</span> <span class="n">scsi_status</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer_len</span> <span class="o">=</span> <span class="n">TRANSPORT_SENSE_BUFFER</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">seg_cnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">add_status_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe012</span><span class="p">,</span> <span class="s">&quot;rq_result=%x, xmit_type=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span><span class="p">,</span> <span class="n">xmit_type</span><span class="p">);</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe013</span><span class="p">,</span> <span class="s">&quot;CTIO start: vha(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">xmit_type</span> <span class="o">&amp;</span> <span class="n">QLA_TGT_XMIT_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">qlt_pci_map_calc_cnt</span><span class="p">(</span><span class="n">prm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">full_req_cnt</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">req_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCF_UNDERFLOW_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">residual_count</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe014</span><span class="p">,</span>
		    <span class="s">&quot;Residual underflow: %d (tag %d, &quot;</span>
		    <span class="s">&quot;op %x, bufflen %d, rq_result %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">residual</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span> <span class="o">?</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span><span class="p">);</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span> <span class="o">|=</span> <span class="n">SS_RESIDUAL_UNDER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCF_OVERFLOW_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">residual_count</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe015</span><span class="p">,</span>
		    <span class="s">&quot;Residual overflow: %d (tag %d, &quot;</span>
		    <span class="s">&quot;op %x, bufflen %d, rq_result %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">residual</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span> <span class="o">?</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span><span class="p">);</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span> <span class="o">|=</span> <span class="n">SS_RESIDUAL_OVER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xmit_type</span> <span class="o">&amp;</span> <span class="n">QLA_TGT_XMIT_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If QLA_TGT_XMIT_DATA is not set, add_status_pkt will be</span>
<span class="cm">		 * ignored in *xmit_response() below</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">QLA_TGT_SENSE_VALID</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">prm</span><span class="o">-&gt;</span><span class="n">add_status_pkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">full_req_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe016</span><span class="p">,</span>
	    <span class="s">&quot;req_cnt=%d, full_req_cnt=%d, add_status_pkt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">prm</span><span class="o">-&gt;</span><span class="n">req_cnt</span><span class="p">,</span> <span class="o">*</span><span class="n">full_req_cnt</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">add_status_pkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qlt_need_explicit_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sending_sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">enable_class_2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sending_sense</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">enable_explicit_conf</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QLA_TGT_DEBUG_SRR</span>
<span class="cm">/*</span>
<span class="cm"> *  Original taken from the XFS code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">qlt_srr_random</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">Inited</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RandomValue</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* cycles pseudo-randomly through all values between 1 and 2^31 - 2 */</span>
	<span class="k">register</span> <span class="kt">long</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">long</span> <span class="n">lo</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">long</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Inited</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RandomValue</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">Inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">RandomValue</span><span class="p">;</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">/</span> <span class="mi">127773</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">%</span> <span class="mi">127773</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="mi">16807</span> <span class="o">*</span> <span class="n">lo</span> <span class="o">-</span> <span class="mi">2836</span> <span class="o">*</span> <span class="n">hi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">+=</span> <span class="mi">2147483647</span><span class="p">;</span>
	<span class="n">RandomValue</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_check_srr_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">xmit_type</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* This is not a real status packets lost, so it won&#39;t lead to SRR */</span>
<span class="c">	if ((*xmit_type &amp; QLA_TGT_XMIT_STATUS) &amp;&amp; (qlt_srr_random() % 200)</span>
<span class="c">	    == 50) {</span>
<span class="c">		*xmit_type &amp;= ~QLA_TGT_XMIT_STATUS;</span>
<span class="c">		ql_dbg(ql_dbg_tgt_mgt, cmd-&gt;vha, 0xf015,</span>
<span class="c">		    &quot;Dropping cmd %p (tag %d) status&quot;, cmd, cmd-&gt;tag);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s currently not possible to simulate SRRs for FCP_WRITE without</span>
<span class="cm">	 * a physical link layer failure, so don&#39;t even try here..</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma_data_direction</span> <span class="o">!=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">qlt_srr_random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">leave</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tot_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">leave</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">leave</span> <span class="o">=</span> <span class="n">qlt_srr_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">leave</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tot_len</span> <span class="o">+=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf016</span><span class="p">,</span>
		    <span class="s">&quot;Cutting cmd %p (tag %d) buffer&quot;</span>
		    <span class="s">&quot; tail to len %d, sg_cnt %d (cmd-&gt;bufflen %d,&quot;</span>
		    <span class="s">&quot; cmd-&gt;sg_cnt %d)&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">tot_len</span><span class="p">,</span> <span class="n">leave</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span> <span class="o">=</span> <span class="n">tot_len</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">=</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">qlt_srr_random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">70</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">qlt_srr_random</span><span class="p">()</span> <span class="o">%</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf017</span><span class="p">,</span>
		    <span class="s">&quot;Cutting cmd %p (tag %d) buffer head &quot;</span>
		    <span class="s">&quot;to offset %d (cmd-&gt;bufflen %d)&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">xmit_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA_TGT_XMIT_DATA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qlt_set_data_offset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf018</span><span class="p">,</span>
			    <span class="s">&quot;qlt_set_data_offset() failed (tag %d)&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlt_check_srr_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">xmit_type</span><span class="p">)</span>
<span class="p">{}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_24xx_init_ctio_to_isp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">ctio</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="o">*</span><span class="n">prm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer_len</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_data</span><span class="p">));</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_SEND_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_need_explicit_conf</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
		    <span class="n">CTIO7_FLAGS_EXPLICIT_CONFORM</span> <span class="o">|</span>
		    <span class="n">CTIO7_FLAGS_CONFORM_REQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">residual</span><span class="p">);</span>
	<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rq_result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">QLA_TGT_SENSE_VALID</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_need_explicit_conf</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe017</span><span class="p">,</span>
				    <span class="s">&quot;Skipping EXPLICIT_CONFORM and &quot;</span>
				    <span class="s">&quot;CTIO7_FLAGS_CONFORM_REQ for FCP READ w/ &quot;</span>
				    <span class="s">&quot;non GOOD status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">skip_explict_conf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
			    <span class="n">CTIO7_FLAGS_EXPLICIT_CONFORM</span> <span class="o">|</span>
			    <span class="n">CTIO7_FLAGS_CONFORM_REQ</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">skip_explict_conf:</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_0</span><span class="p">);</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_1</span><span class="p">);</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">|=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">SS_SENSE_LEN_VALID</span><span class="p">);</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_length</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer_len</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer_len</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_data</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_be32</span><span class="p">(((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if (unlikely((prm-&gt;sense_buffer_len % 4) != 0)) {</span>
<span class="c">			static int q;</span>
<span class="c">			if (q &lt; 10) {</span>
<span class="c">				ql_dbg(ql_dbg_tgt, vha, 0xe04f,</span>
<span class="c">				    &quot;qla_target(%d): %d bytes of sense &quot;</span>
<span class="c">				    &quot;lost&quot;, prm-&gt;tgt-&gt;ha-&gt;vp_idx,</span>
<span class="c">				    prm-&gt;sense_buffer_len % 4);</span>
<span class="c">				q++;</span>
<span class="c">			}</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_0</span><span class="p">);</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_1</span><span class="p">);</span>
		<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">sense_data</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Sense with len &gt; 24, is it possible ??? */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback to setup response of xmit_type of QLA_TGT_XMIT_DATA and *</span>
<span class="cm"> * QLA_TGT_XMIT_STATUS for &gt;= 24xx silicon</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qlt_xmit_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xmit_type</span><span class="p">,</span>
	<span class="kt">uint8_t</span> <span class="n">scsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="n">prm</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">full_req_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prm</span><span class="p">));</span>
	<span class="n">qlt_check_srr_debug</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmit_type</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe018</span><span class="p">,</span>
	    <span class="s">&quot;is_send_status=%d, cmd-&gt;bufflen=%d, cmd-&gt;sg_cnt=%d, &quot;</span>
	    <span class="s">&quot;cmd-&gt;dma_data_direction=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">xmit_type</span> <span class="o">&amp;</span> <span class="n">QLA_TGT_XMIT_STATUS</span><span class="p">)</span> <span class="o">?</span>
	    <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma_data_direction</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_pre_xmit_response</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="n">xmit_type</span><span class="p">,</span> <span class="n">scsi_status</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">full_req_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">QLA_TGT_PRE_XMIT_RESP_CMD_ABORTED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Does F/W have an IOCBs for this request */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_check_reserve_free_req</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">full_req_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unmap_unlock</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_24xx_build_ctio_pkt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unmap_unlock</span><span class="p">;</span>


	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">prm</span><span class="p">.</span><span class="n">pkt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">xmit_type</span> <span class="o">&amp;</span> <span class="n">QLA_TGT_XMIT_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_DATA_IN</span> <span class="o">|</span>
			<span class="n">CTIO7_FLAGS_STATUS_MODE_0</span><span class="p">);</span>

		<span class="n">qlt_load_data_segments</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="p">.</span><span class="n">add_status_pkt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xmit_type</span> <span class="o">&amp;</span> <span class="n">QLA_TGT_XMIT_STATUS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">=</span>
				    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prm</span><span class="p">.</span><span class="n">rq_result</span><span class="p">);</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">prm</span><span class="p">.</span><span class="n">residual</span><span class="p">);</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
				    <span class="n">CTIO7_FLAGS_SEND_STATUS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qlt_need_explicit_conf</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
					    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
						<span class="n">CTIO7_FLAGS_EXPLICIT_CONFORM</span> <span class="o">|</span>
						<span class="n">CTIO7_FLAGS_CONFORM_REQ</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We have already made sure that there is sufficient</span>
<span class="cm">			 * amount of request entries to not drop HW lock in</span>
<span class="cm">			 * req_pkt().</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">ctio</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">qlt_get_req_pkt</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe019</span><span class="p">,</span>
			    <span class="s">&quot;Building additional status packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">ctio</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctio</span><span class="p">));</span>
			<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
			    <span class="n">CTIO7_FLAGS_DATA_IN</span><span class="p">);</span>

			<span class="cm">/* Real finish is ctio_m1&#39;s finish */</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">|=</span> <span class="n">CTIO_INTERMEDIATE_HANDLE_MARK</span><span class="p">;</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
			    <span class="n">CTIO7_FLAGS_DONT_RET_CTIO</span><span class="p">);</span>
			<span class="n">qlt_24xx_init_ctio_to_isp</span><span class="p">((</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ctio</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">prm</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Status CTIO7: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctio</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qlt_24xx_init_ctio_to_isp</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prm</span><span class="p">);</span>


	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLA_TGT_STATE_PROCESSED</span><span class="p">;</span> <span class="cm">/* Mid-level is done processing */</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe01a</span><span class="p">,</span>
	    <span class="s">&quot;Xmitting CTIO7 response pkt for 24xx: %p scsi_status: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pkt</span><span class="p">,</span> <span class="n">scsi_status</span><span class="p">);</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unmap_unlock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span><span class="p">)</span>
		<span class="n">qlt_unmap_sg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_xmit_response</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qlt_rdy_to_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_prm</span> <span class="n">prm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prm</span><span class="p">));</span>
	<span class="n">prm</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">prm</span><span class="p">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">tgt</span><span class="p">;</span>
	<span class="n">prm</span><span class="p">.</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">prm</span><span class="p">.</span><span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Send marker if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe01b</span><span class="p">,</span> <span class="s">&quot;CTIO_start: vha(%d)&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

	<span class="cm">/* Calculate number of entries and segments required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_pci_map_calc_cnt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Does F/W have an IOCBs for this request */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_check_reserve_free_req</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">prm</span><span class="p">.</span><span class="n">req_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock_free_unmap</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_24xx_build_ctio_pkt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock_free_unmap</span><span class="p">;</span>
	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">prm</span><span class="p">.</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status0</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_DATA_OUT</span> <span class="o">|</span>
	    <span class="n">CTIO7_FLAGS_STATUS_MODE_0</span><span class="p">);</span>
	<span class="n">qlt_load_data_segments</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">,</span> <span class="n">vha</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLA_TGT_STATE_NEED_DATA</span><span class="p">;</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

<span class="nl">out_unlock_free_unmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span><span class="p">)</span>
		<span class="n">qlt_unmap_sg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_rdy_to_xfer</span><span class="p">);</span>

<span class="cm">/* If hardware_lock held on entry, might drop it, then reaquire */</span>
<span class="cm">/* This function sends the appropriate CTIO to ISP 2xxx or 24xx */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qlt_send_term_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">ctio24</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">request_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe01c</span><span class="p">,</span> <span class="s">&quot;Sending TERM EXCH CTIO (ha=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">request_t</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe050</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s failed: unable to allocate &quot;</span>
		    <span class="s">&quot;request packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">QLA_TGT_STATE_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe051</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Terminating cmd %p with &quot;</span>
			    <span class="s">&quot;incorrect state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">QLA_TGT_SKIP_HANDLE</span> <span class="o">|</span> <span class="n">CTIO_COMPLETION_HANDLE_MARK</span><span class="p">;</span>

	<span class="n">ctio24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CTIO_TYPE7</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">:</span> <span class="n">CTIO7_NHANDLE_UNRECOGNIZED</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">QLA_TGT_TIMEOUT</span><span class="p">);</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">exchange_addr</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_addr</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CTIO7_FLAGS_STATUS_MODE_1</span> <span class="o">|</span>
		<span class="n">CTIO7_FLAGS_TERMINATE</span><span class="p">);</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">ox_id</span><span class="p">);</span>

	<span class="cm">/* Most likely, it isn&#39;t needed */</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">get_unaligned</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="o">&amp;</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb</span><span class="p">[</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb_len</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">residual</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">|=</span> <span class="n">SS_RESIDUAL_UNDER</span><span class="p">;</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_send_term_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ha_locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlt_issue_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha_locked</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha_locked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="cm">/* just in case */</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">free_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlt_free_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">free_sg</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_free_cmd</span><span class="p">);</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_prepare_srr_ctio</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_ctio</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">imm</span><span class="p">;</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf019</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): CTIO with SRR status received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf055</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): SRR CTIO, but ctio is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="cm">/* IRQ is already OFF */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_ctio_list</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf01a</span><span class="p">,</span>
		    <span class="s">&quot;CTIO SRR %p added (id %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">imm_srr_id</span> <span class="o">==</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_imm_list</span><span class="p">,</span>
			    <span class="n">srr_list_entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">==</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf01b</span><span class="p">,</span>
				    <span class="s">&quot;Scheduling srr work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_work</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf056</span><span class="p">,</span>
				    <span class="s">&quot;qla_target(%d): imm_srr_id &quot;</span>
				    <span class="s">&quot;== ctio_srr_id (%d), but there is no &quot;</span>
				    <span class="s">&quot;corresponding SRR IMM, deleting CTIO &quot;</span>
				    <span class="s">&quot;SRR %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
				    <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>

				<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf057</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Unable to allocate SRR CTIO entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_imm_list</span><span class="p">,</span>
		    <span class="n">srr_list_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">==</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf01c</span><span class="p">,</span>
				    <span class="s">&quot;IMM SRR %p deleted (id %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">imm</span><span class="p">,</span> <span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">);</span>
				<span class="n">qlt_reject_free_srr_imm</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_term_ctio_exchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctio</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctio</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ctio7_from_24xx</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_from_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ctio</span><span class="p">;</span>
		<span class="n">term</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">OF_TERM_EXCH</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">term</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">term</span><span class="p">)</span>
		<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">term</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="nf">qlt_get_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">handle</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">];</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="nf">qlt_ctio_to_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Clear out internal marks */</span>
	<span class="n">handle</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CTIO_COMPLETION_HANDLE_MARK</span> <span class="o">|</span>
	    <span class="n">CTIO_INTERMEDIATE_HANDLE_MARK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">QLA_TGT_NULL_HANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">QLA_TGT_SKIP_HANDLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe01d</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;SKIP_HANDLE CTIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* handle-1 is actually used */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">handle</span> <span class="o">&gt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe052</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Wrong handle %x received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">qlt_get_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe053</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Suspicious: unable to &quot;</span>
			    <span class="s">&quot;find the command with handle %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
			    <span class="n">handle</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctio</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We can&#39;t get loop ID from CTIO7 */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe054</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Wrong CTIO received: QLA24xx doesn&#39;t &quot;</span>
		    <span class="s">&quot;support NULL handles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_do_ctio_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="o">*</span><span class="n">tfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe01e</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): handle(ctio %p status %#x) &lt;- %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ctio</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&amp;</span> <span class="n">CTIO_INTERMEDIATE_HANDLE_MARK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* That could happen only in case of an error/reset/abort */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CTIO_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf01d</span><span class="p">,</span>
			    <span class="s">&quot;Intermediate CTIO received&quot;</span>
			    <span class="s">&quot; (status %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">qlt_ctio_to_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">ctio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="n">tfo</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_mapped</span><span class="p">)</span>
		<span class="n">qlt_unmap_sg</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CTIO_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CTIO_LIP_RESET</span>:
		<span class="k">case</span> <span class="n">CTIO_TARGET_RESET</span>:
		<span class="k">case</span> <span class="n">CTIO_ABORTED</span>:
		<span class="k">case</span> <span class="n">CTIO_TIMEOUT</span>:
		<span class="k">case</span> <span class="n">CTIO_INVALID_RX_ID</span>:
			<span class="cm">/* They are OK */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf058</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): CTIO with &quot;</span>
			    <span class="s">&quot;status %#x received, state %x, se_cmd %p, &quot;</span>
			    <span class="s">&quot;(LIP_RESET=e, ABORTED=2, TARGET_RESET=17, &quot;</span>
			    <span class="s">&quot;TIMEOUT=b, INVALID_RX_ID=8)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">se_cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CTIO_PORT_LOGGED_OUT</span>:
		<span class="k">case</span> <span class="n">CTIO_PORT_UNAVAILABLE</span>:
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf059</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): CTIO with PORT LOGGED &quot;</span>
			    <span class="s">&quot;OUT (29) or PORT UNAVAILABLE (28) status %x &quot;</span>
			    <span class="s">&quot;received (state %x, se_cmd %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">se_cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CTIO_SRR_RECEIVED</span>:
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf05a</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): CTIO with SRR_RECEIVED&quot;</span>
			    <span class="s">&quot; status %x received (state %x, se_cmd %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">se_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qlt_prepare_srr_ctio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ctio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf05b</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): CTIO with error status &quot;</span>
			    <span class="s">&quot;0x%x received (state %x, se_cmd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">se_cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QLA_TGT_STATE_NEED_DATA</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qlt_term_ctio_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ctio</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLA_TGT_STATE_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe01f</span><span class="p">,</span> <span class="s">&quot;Command %p finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLA_TGT_STATE_NEED_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rx_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLA_TGT_STATE_DATA_IN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CTIO_SUCCESS</span><span class="p">))</span>
			<span class="n">rx_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">write_data_transferred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe020</span><span class="p">,</span>
		    <span class="s">&quot;Data received, context %x, rx_status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="mh">0x0</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">handle_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLA_TGT_STATE_ABORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf01e</span><span class="p">,</span>
		    <span class="s">&quot;Aborted command %p (tag %d) finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf05c</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): A command in state (%d) should &quot;</span>
		    <span class="s">&quot;not return a CTIO complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CTIO_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf01f</span><span class="p">,</span> <span class="s">&quot;Finishing failed CTIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">free_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="cm">/* called via callback from qla2xxx */</span>
<span class="kt">void</span> <span class="nf">qlt_ctio_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tgt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe021</span><span class="p">,</span>
		    <span class="s">&quot;CTIO, but target mode not enabled&quot;</span>
		    <span class="s">&quot; (ha %d %p handle %#x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qlt_do_ctio_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">CTIO_SUCCESS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qlt_get_fcp_task_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint8_t</span> <span class="n">task_codes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fcp_task_attr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task_codes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATIO_SIMPLE_QUEUE</span>:
		<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATIO_HEAD_OF_QUEUE</span>:
		<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">MSG_HEAD_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATIO_ORDERED_QUEUE</span>:
		<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATIO_ACA_QUEUE</span>:
		<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">MSG_ACA_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATIO_UNTAGGED</span>:
		<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf05d</span><span class="p">,</span>
		    <span class="s">&quot;qla_target: unknown task code %x, use ORDERED instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">task_codes</span><span class="p">);</span>
		<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fcp_task_attr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">qlt_make_local_sess</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span>
					<span class="kt">uint8_t</span> <span class="o">*</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * Process context for I/O path into tcm_qla2xxx code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_do_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt_cmd</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">data_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fcp_task_attr</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">bidi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_s_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">tearing_down</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Do the extra kref_get() before dropping</span>
<span class="cm">			 * qla_hw_data-&gt;hardware_lock.</span>
<span class="cm">			 */</span>
			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">sess_kref</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">s_id</span> <span class="o">=</span>	<span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf022</span><span class="p">,</span>
			<span class="s">&quot;qla_target(%d): Unable to find wwn login&quot;</span>
			<span class="s">&quot; (s_id %x:%x:%x), trying to create it manually</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf023</span><span class="p">,</span>
				<span class="s">&quot;Dropping multy entry cmd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_make_local_sess</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">s_id</span><span class="p">);</span>
		<span class="cm">/* sess has an extra creation ref. */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">conf_compl_supported</span><span class="p">;</span>

	<span class="n">cdb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_addr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">(</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">rddata</span> <span class="o">&amp;&amp;</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">wrdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bidi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data_dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">rddata</span><span class="p">)</span>
		<span class="n">data_dir</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">wrdata</span><span class="p">)</span>
		<span class="n">data_dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data_dir</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>

	<span class="n">fcp_task_attr</span> <span class="o">=</span> <span class="n">qlt_get_fcp_task_attr</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">task_attr</span><span class="p">);</span>
	<span class="n">data_length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">get_unaligned</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="o">&amp;</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb</span><span class="p">[</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb_len</span><span class="p">]));</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe022</span><span class="p">,</span>
	    <span class="s">&quot;qla_target: START qla command: %p lun: 0x%04x (tag %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">handle_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="n">data_length</span><span class="p">,</span>
	    <span class="n">fcp_task_attr</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">bidi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Drop extra session reference from qla_tgt_handle_cmd_for_atio*(</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_term:</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf020</span><span class="p">,</span> <span class="s">&quot;Terminating work cmd %p&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * cmd has not sent to target yet, so pass NULL as the second</span>
<span class="cm">	 * argument to qlt_send_term_exchange() and free the memory here.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_handle_cmd_for_atio</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf021</span><span class="p">,</span>
		    <span class="s">&quot;New command while device %p is shutting down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf05e</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Allocation of cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">atio</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLA_TGT_STATE_NEW</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">qlt_do_work</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">qla_tgt_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_issue_task_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">lun</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">tmr_func</span><span class="p">;</span>

	<span class="n">mcmd</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10009</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Allocation of management &quot;</span>
		    <span class="s">&quot;command failed, some commands and their data could &quot;</span>
		    <span class="s">&quot;leak</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mcmd</span><span class="p">));</span>
	<span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">imm_ntfy</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">imm_ntfy</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">tmr_func</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
	<span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLA_TGT_CLEAR_ACA</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): CLEAR_ACA received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">tmr_func</span> <span class="o">=</span> <span class="n">TMR_CLEAR_ACA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLA_TGT_TARGET_RESET</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10001</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): TARGET_RESET received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">tmr_func</span> <span class="o">=</span> <span class="n">TMR_TARGET_WARM_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLA_TGT_LUN_RESET</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10002</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): LUN_RESET received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">tmr_func</span> <span class="o">=</span> <span class="n">TMR_LUN_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLA_TGT_CLEAR_TS</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10003</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): CLEAR_TS received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">tmr_func</span> <span class="o">=</span> <span class="n">TMR_CLEAR_TASK_SET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLA_TGT_ABORT_TS</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x10004</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): ABORT_TS received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">tmr_func</span> <span class="o">=</span> <span class="n">TMR_ABORT_TASK_SET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	case QLA_TGT_ABORT_ALL:</span>
<span class="c">		ql_dbg(ql_dbg_tgt_tmr, vha, 0x10005,</span>
<span class="c">		    &quot;qla_target(%d): Doing ABORT_ALL_TASKS\n&quot;,</span>
<span class="c">		    sess-&gt;vha-&gt;vp_idx);</span>
<span class="c">		tmr_func = 0;</span>
<span class="c">		break;</span>

<span class="c">	case QLA_TGT_ABORT_ALL_SESS:</span>
<span class="c">		ql_dbg(ql_dbg_tgt_tmr, vha, 0x10006,</span>
<span class="c">		    &quot;qla_target(%d): Doing ABORT_ALL_TASKS_SESS\n&quot;,</span>
<span class="c">		    sess-&gt;vha-&gt;vp_idx);</span>
<span class="c">		tmr_func = 0;</span>
<span class="c">		break;</span>

<span class="c">	case QLA_TGT_NEXUS_LOSS_SESS:</span>
<span class="c">		ql_dbg(ql_dbg_tgt_tmr, vha, 0x10007,</span>
<span class="c">		    &quot;qla_target(%d): Doing NEXUS_LOSS_SESS\n&quot;,</span>
<span class="c">		    sess-&gt;vha-&gt;vp_idx);</span>
<span class="c">		tmr_func = 0;</span>
<span class="c">		break;</span>

<span class="c">	case QLA_TGT_NEXUS_LOSS:</span>
<span class="c">		ql_dbg(ql_dbg_tgt_tmr, vha, 0x10008,</span>
<span class="c">		    &quot;qla_target(%d): Doing NEXUS_LOSS\n&quot;, sess-&gt;vha-&gt;vp_idx);</span>
<span class="c">		tmr_func = 0;</span>
<span class="c">		break;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1000a</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Unknown task mgmt fn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">handle_tmr</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tmr_func</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_tmr</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x1000b</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): tgt.tgt_ops-&gt;handle_tmr() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sess</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_handle_task_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">lun</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lun_size</span><span class="p">,</span> <span class="n">fn</span><span class="p">;</span>

	<span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">lun_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">fn</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">task_mgmt_flags</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_s_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf024</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): task mgmt fn 0x%x for &quot;</span>
		    <span class="s">&quot;non-existant session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">qlt_sched_sess_work</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">QLA_TGT_SESS_WORK_TM</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">qlt_issue_task_mgmt</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qlt_abort_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">lun</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mcmd</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf05f</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s: Allocation of ABORT cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mcmd</span><span class="p">));</span>

	<span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">imm_ntfy</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">mcmd</span><span class="o">-&gt;</span><span class="n">orig_iocb</span><span class="p">.</span><span class="n">imm_ntfy</span><span class="p">));</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">handle_tmr</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">TMR_ABORT_TASK</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">seq_id</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf060</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): tgt_ops-&gt;handle_tmr() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mcmd</span><span class="p">,</span> <span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_abort_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop_id</span><span class="p">;</span>

	<span class="n">loop_id</span> <span class="o">=</span> <span class="n">GET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">iocb</span><span class="p">);</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_loop_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf025</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): task abort for unexisting &quot;</span>
		    <span class="s">&quot;session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">qlt_sched_sess_work</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">,</span>
		    <span class="n">QLA_TGT_SESS_WORK_ABORT</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iocb</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">__qlt_abort_task</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_24xx_handle_els</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf026</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): Port ID: 0x%02x:%02x:%02x&quot;</span>
	    <span class="s">&quot; ELS opcode: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELS_PLOGI</span>:
	<span class="k">case</span> <span class="n">ELS_FLOGI</span>:
	<span class="k">case</span> <span class="n">ELS_PRLI</span>:
	<span class="k">case</span> <span class="n">ELS_LOGO</span>:
	<span class="k">case</span> <span class="n">ELS_PRLO</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_NEXUS_LOSS_SESS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_PDISC</span>:
	<span class="k">case</span> <span class="n">ELS_ADISC</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* send notify ack */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf061</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Unsupported ELS command %x &quot;</span>
		    <span class="s">&quot;received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_NEXUS_LOSS_SESS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlt_set_data_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="o">*</span><span class="n">sgp</span><span class="p">,</span> <span class="o">*</span><span class="n">sg_srr</span><span class="p">,</span> <span class="o">*</span><span class="n">sg_srr_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">first_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rem_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sg_srr_cnt</span><span class="p">,</span> <span class="n">bufflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe023</span><span class="p">,</span>
	    <span class="s">&quot;Entering qla_tgt_set_data_offset: cmd: %p, cmd-&gt;sg: %p, &quot;</span>
	    <span class="s">&quot;cmd-&gt;sg_cnt: %u, direction: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dma_data_direction</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Reject non zero SRR relative offset until we can test</span>
<span class="cm">	 * this code properly.</span>
<span class="cm">	 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Rejecting non zero SRR rel_offs: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe055</span><span class="p">,</span>
		    <span class="s">&quot;Missing cmd-&gt;sg or zero cmd-&gt;sg_cnt in&quot;</span>
		    <span class="s">&quot; qla_tgt_set_data_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Walk the current cmd-&gt;sg list until we locate the new sg_srr_start</span>
<span class="cm">	 */</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe024</span><span class="p">,</span>
		    <span class="s">&quot;sg[%d]: %p page: %p, length: %d, offset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">i</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first_offset</span> <span class="o">=</span> <span class="n">rem_offset</span><span class="p">;</span>
			<span class="n">sg_srr_start</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe025</span><span class="p">,</span>
			    <span class="s">&quot;Found matching sg[%d], using %p as sg_srr_start, &quot;</span>
			    <span class="s">&quot;and using first_offset: %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span>
			    <span class="n">first_offset</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">rem_offset</span> <span class="o">-=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_srr_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe056</span><span class="p">,</span>
		    <span class="s">&quot;Unable to locate sg_srr_start for offset: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sg_srr_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">sg_srr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">)</span> <span class="o">*</span> <span class="n">sg_srr_cnt</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_srr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe057</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate sgp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">sg_srr</span><span class="p">,</span> <span class="n">sg_srr_cnt</span><span class="p">);</span>
	<span class="n">sgp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sg_srr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Walk the remaining list for sg_srr_start, mapping to the newly</span>
<span class="cm">	 * allocated sg_srr taking first_offset into account.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg_srr_start</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_srr_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sgp</span><span class="p">,</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">first_offset</span><span class="p">),</span> <span class="n">first_offset</span><span class="p">);</span>
			<span class="n">first_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sgp</span><span class="p">,</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bufflen</span> <span class="o">+=</span> <span class="n">sgp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="n">sgp</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sgp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sgp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_srr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">=</span> <span class="n">sg_srr_cnt</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span> <span class="o">=</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">free_sg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe026</span><span class="p">,</span> <span class="s">&quot;New cmd-&gt;sg: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe027</span><span class="p">,</span> <span class="s">&quot;New cmd-&gt;sg_cnt: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe028</span><span class="p">,</span> <span class="s">&quot;New cmd-&gt;bufflen: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xe029</span><span class="p">,</span> <span class="s">&quot;New cmd-&gt;offset: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qlt_srr_adjust_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">srr_rel_offs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">xmit_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rel_offs</span><span class="p">;</span>

	<span class="n">rel_offs</span> <span class="o">=</span> <span class="n">srr_rel_offs</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf027</span><span class="p">,</span> <span class="s">&quot;srr_rel_offs=%d, rel_offs=%d&quot;</span><span class="p">,</span>
	    <span class="n">srr_rel_offs</span><span class="p">,</span> <span class="n">rel_offs</span><span class="p">);</span>

	<span class="o">*</span><span class="n">xmit_type</span> <span class="o">=</span> <span class="n">QLA_TGT_XMIT_ALL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rel_offs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0xf062</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): SRR rel_offs (%d) &lt; 0&quot;</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rel_offs</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rel_offs</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">)</span>
		<span class="o">*</span><span class="n">xmit_type</span> <span class="o">=</span> <span class="n">QLA_TGT_XMIT_STATUS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rel_offs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">qlt_set_data_offset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rel_offs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* No locks, thread context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_handle_srr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_ctio</span> <span class="o">*</span><span class="n">sctio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">imm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">ntfy</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">imm_ntfy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">srr_ui</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_rel_offs</span><span class="p">);</span>
	<span class="n">srr_ui</span> <span class="o">=</span> <span class="n">ntfy</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_ui</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf028</span><span class="p">,</span> <span class="s">&quot;SRR cmd %p, srr_ui %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">cmd</span><span class="p">,</span> <span class="n">srr_ui</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srr_ui</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SRR_IU_STATUS</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ntfy</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NOTIFY_ACK_SRR_FLAGS_ACCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">xmit_type</span> <span class="o">=</span> <span class="n">QLA_TGT_XMIT_STATUS</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRR_IU_DATA_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf063</span><span class="p">,</span>
			    <span class="s">&quot;Unable to process SRR_IU_DATA_IN due to&quot;</span>
			    <span class="s">&quot; missing cmd-&gt;sg, state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe02a</span><span class="p">,</span>
			    <span class="s">&quot;Rejecting SRR_IU_DATA_IN with non GOOD &quot;</span>
			    <span class="s">&quot;scsi_status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qlt_srr_adjust_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmit_type</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ntfy</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NOTIFY_ACK_SRR_FLAGS_ACCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf064</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): SRR for in data for cmd &quot;</span>
			    <span class="s">&quot;without them (tag %d, SCSI status %d), &quot;</span>
			    <span class="s">&quot;reject&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">.</span><span class="n">scsi_status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRR_IU_DATA_OUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf065</span><span class="p">,</span>
			    <span class="s">&quot;Unable to process SRR_IU_DATA_OUT due to&quot;</span>
			    <span class="s">&quot; missing cmd-&gt;sg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe02b</span><span class="p">,</span>
			    <span class="s">&quot;Rejecting SRR_IU_DATA_OUT&quot;</span>
			    <span class="s">&quot; with non GOOD scsi_status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_has_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qlt_srr_adjust_data</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmit_type</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ntfy</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NOTIFY_ACK_SRR_FLAGS_ACCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xmit_type</span> <span class="o">&amp;</span> <span class="n">QLA_TGT_XMIT_DATA</span><span class="p">)</span>
				<span class="n">qlt_rdy_to_xfer</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf066</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): SRR for out data for cmd &quot;</span>
			    <span class="s">&quot;without them (tag %d, SCSI status %d), &quot;</span>
			    <span class="s">&quot;reject&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">.</span><span class="n">scsi_status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf067</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Unknown srr_ui value %x&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">srr_ui</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Transmit response in case of status and data-in cases */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="p">)</span>
		<span class="n">qlt_xmit_response</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">xmit_type</span><span class="p">,</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_reject:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ntfy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_FLAGS_REJECT</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_REJECT_REASON_UNABLE_TO_PERFORM</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_FLAGS_REJECT_EXPL_NO_EXPL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLA_TGT_STATE_NEED_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLA_TGT_STATE_DATA_IN</span><span class="p">;</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_reject_free_srr_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">imm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ha_locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha_locked</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">imm_ntfy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_FLAGS_REJECT</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_REJECT_REASON_UNABLE_TO_PERFORM</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_FLAGS_REJECT_EXPL_NO_EXPL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha_locked</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">imm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_handle_srr_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt</span><span class="p">,</span> <span class="n">srr_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_ctio</span> <span class="o">*</span><span class="n">sctio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf029</span><span class="p">,</span> <span class="s">&quot;Entering SRR work (tgt %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">tgt</span><span class="p">);</span>

<span class="nl">restart:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sctio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_ctio_list</span><span class="p">,</span> <span class="n">srr_list_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">imm</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qla_tgt_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">;</span>

		<span class="n">imm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_imm_list</span><span class="p">,</span>
						<span class="n">srr_list_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">==</span> <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">imm</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf068</span><span class="p">,</span>
					  <span class="s">&quot;qla_target(%d): There must be &quot;</span>
					  <span class="s">&quot;only one IMM SRR per CTIO SRR &quot;</span>
					  <span class="s">&quot;(IMM SRR %p, id %d, CTIO %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">,</span> <span class="n">sctio</span><span class="p">);</span>
					<span class="n">qlt_reject_free_srr_imm</span><span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">imm</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf02a</span><span class="p">,</span>
		    <span class="s">&quot;IMM SRR %p, CTIO SRR %p (id %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">sctio</span><span class="p">,</span>
		    <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">imm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf02b</span><span class="p">,</span>
			    <span class="s">&quot;Not found matching IMM for SRR CTIO (id %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reset qla_tgt_cmd SRR values and SGL pointer+count to follow</span>
<span class="cm">		 * tcm_qla2xxx_write_pending() and tcm_qla2xxx_queue_data_in()</span>
<span class="cm">		 * logic..</span>
<span class="cm">		 */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">free_sg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">free_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf02c</span><span class="p">,</span>
		    <span class="s">&quot;SRR cmd %p (se_cmd %p, tag %d, op %x), &quot;</span>
		    <span class="s">&quot;sg_cnt=%d, offset=%d&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
		    <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_task_cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

		<span class="n">qlt_handle_srr</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sctio</span><span class="p">,</span> <span class="n">imm</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">imm</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sctio</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_prepare_srr_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_imm</span> <span class="o">*</span><span class="n">imm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_srr_ctio</span> <span class="o">*</span><span class="n">sctio</span><span class="p">;</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">imm_srr_id</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf02d</span><span class="p">,</span> <span class="s">&quot;qla_target(%d): SRR received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

	<span class="n">imm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">imm</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imm</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">imm_ntfy</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">imm_ntfy</span><span class="p">));</span>

		<span class="cm">/* IRQ is already OFF */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
		<span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">imm_srr_id</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_imm_list</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf02e</span><span class="p">,</span>
		    <span class="s">&quot;IMM NTFY SRR %p added (id %d, ui %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">imm</span><span class="p">,</span> <span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">,</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">srr_ui</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">imm_srr_id</span> <span class="o">==</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sctio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_ctio_list</span><span class="p">,</span>
			    <span class="n">srr_list_entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">==</span> <span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf02f</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				    <span class="s">&quot;Scheduling srr work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_work</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf030</span><span class="p">,</span>
				    <span class="s">&quot;qla_target(%d): imm_srr_id &quot;</span>
				    <span class="s">&quot;== ctio_srr_id (%d), but there is no &quot;</span>
				    <span class="s">&quot;corresponding SRR CTIO, deleting IMM &quot;</span>
				    <span class="s">&quot;SRR %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctio_srr_id</span><span class="p">,</span>
				    <span class="n">imm</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imm</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">);</span>

				<span class="n">kfree</span><span class="p">(</span><span class="n">imm</span><span class="p">);</span>

				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt_srr_ctio</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf069</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Unable to allocate SRR IMM &quot;</span>
		    <span class="s">&quot;entry, SRR request will be rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

		<span class="cm">/* IRQ is already OFF */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sctio</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_ctio_list</span><span class="p">,</span>
		    <span class="n">srr_list_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_id</span> <span class="o">==</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">imm_srr_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf031</span><span class="p">,</span>
				    <span class="s">&quot;CTIO SRR %p deleted (id %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">sctio</span><span class="p">,</span> <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_id</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sctio</span><span class="o">-&gt;</span><span class="n">srr_list_entry</span><span class="p">);</span>
				<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">sctio</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sctio</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sctio</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_reject:</span>
	<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_FLAGS_REJECT</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_REJECT_REASON_UNABLE_TO_PERFORM</span><span class="p">,</span>
	    <span class="n">NOTIFY_ACK_SRR_FLAGS_REJECT_EXPL_NO_EXPL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_handle_imm_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">add_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IMM_NTFY_LIP_RESET</span>:
	<span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf032</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): LIP reset (loop %#x), subcode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span><span class="p">),</span>
		    <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_ABORT_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_LIP_LINK_REINIT</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf033</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): LINK REINIT (loop %#x, &quot;</span>
		    <span class="s">&quot;subcode %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span><span class="p">),</span>
		    <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iocb</span><span class="p">));</span>
		<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * QLogic requires to wait after LINK REINIT for possible</span>
<span class="cm">		 * PDISC or ADISC ELS commands</span>
<span class="cm">		 */</span>
		<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_PORT_LOGOUT</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf034</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Port logout (loop &quot;</span>
		    <span class="s">&quot;%#x, subcode %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">nport_handle</span><span class="p">),</span>
		    <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">status_subcode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_NEXUS_LOSS_SESS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* The sessions will be cleared in the callback, if needed */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_GLBL_TPRLO</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf035</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Global TPRLO (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_NEXUS_LOSS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* The sessions will be cleared in the callback, if needed */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_PORT_CONFIG</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf036</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Port config changed (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_ABORT_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* The sessions will be cleared in the callback, if needed */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_GLBL_LOGO</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf06a</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Link failure detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="cm">/* I_T nexus loss */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">QLA_TGT_NEXUS_LOSS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_IOCB_OVERFLOW</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf06b</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Cannot provide requested &quot;</span>
		    <span class="s">&quot;capability (IOCB overflowed the immediate notify &quot;</span>
		    <span class="s">&quot;resource count)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_ABORT_TASK</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf037</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Abort Task (S %08x I %#x -&gt; &quot;</span>
		    <span class="s">&quot;L %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">seq_id</span><span class="p">),</span>
		    <span class="n">GET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">iocb</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">lun</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_abort_task</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_RESOURCE</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf06c</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Out of resources, host %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_MSG_RX</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf038</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Immediate notify task %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">task_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_handle_task_mgmt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_ELS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">qlt_24xx_handle_els</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMM_NTFY_SRR</span>:
		<span class="n">qlt_prepare_srr_imm</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">);</span>
		<span class="n">send_notify_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf06d</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Received unknown immediate &quot;</span>
		    <span class="s">&quot;notify status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_notify_ack</span><span class="p">)</span>
		<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">add_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> * This function sends busy to ISP 2xxx or 24xx.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_send_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="n">ctio24</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">request_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_s_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Sending marker isn&#39;t necessary, since we called from ISR */</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">request_t</span> <span class="o">*</span><span class="p">)</span><span class="n">qla2x00_alloc_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf06e</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): %s failed: unable to allocate &quot;</span>
		    <span class="s">&quot;request packet&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">QLA_TGT_SKIP_HANDLE</span> <span class="o">|</span> <span class="n">CTIO_COMPLETION_HANDLE_MARK</span><span class="p">;</span>

	<span class="n">ctio24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_to_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CTIO_TYPE7</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">QLA_TGT_TIMEOUT</span><span class="p">);</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">exchange_addr</span> <span class="o">=</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_addr</span><span class="p">;</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">attr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span>
		<span class="n">CTIO7_FLAGS_STATUS_MODE_1</span> <span class="o">|</span> <span class="n">CTIO7_FLAGS_SEND_STATUS</span> <span class="o">|</span>
		<span class="n">CTIO7_FLAGS_DONT_RET_CTIO</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * CTIO from fw w/o se_cmd doesn&#39;t provide enough info to retry it,</span>
<span class="cm">	 * if the explicit conformation is used.</span>
<span class="cm">	 */</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">ox_id</span><span class="p">);</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">get_unaligned</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="o">&amp;</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb</span><span class="p">[</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb_len</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">residual</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ctio24</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status1</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">|=</span> <span class="n">SS_RESIDUAL_UNDER</span><span class="p">;</span>

	<span class="n">qla2x00_start_iocbs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="cm">/* called via callback from qla2xxx */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_24xx_atio_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tgt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf039</span><span class="p">,</span>
		    <span class="s">&quot;ATIO pkt, but no tgt (ha %p)&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe02c</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): ATIO pkt %p: type %02x count %02x&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_type</span><span class="p">,</span>
	    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_count</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * In tgt_stop mode we also should allow all requests to pass.</span>
<span class="cm">	 * Otherwise, some commands can stuck.</span>
<span class="cm">	 */</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATIO_TYPE7</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe02d</span><span class="p">,</span>
		    <span class="s">&quot;ATIO_TYPE7 instance %d, lun %Lx, read/write %d/%d, &quot;</span>
		    <span class="s">&quot;add_cdb_len %d, data_length %04x, s_id %x:%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">,</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">rddata</span><span class="p">,</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">wrdata</span><span class="p">,</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb_len</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">get_unaligned</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb</span><span class="p">[</span>
			<span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">add_cdb_len</span><span class="p">])),</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">exchange_addr</span> <span class="o">==</span>
		    <span class="n">ATIO_EXCHANGE_ADDRESS_UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe058</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): ATIO_TYPE7 &quot;</span>
			    <span class="s">&quot;received with UNKNOWN exchange address, &quot;</span>
			    <span class="s">&quot;sending QUEUE_FULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
			<span class="n">qlt_send_busy</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">task_mgmt_flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qlt_handle_cmd_for_atio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qlt_handle_task_mgmt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 1 </span><span class="cm">/* With TERM EXCHANGE some FC cards refuse to boot */</span><span class="cp"></span>
				<span class="n">qlt_send_busy</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="n">SAM_STAT_BUSY</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe059</span><span class="p">,</span>
					    <span class="s">&quot;qla_target: Unable to send &quot;</span>
					    <span class="s">&quot;command to target for req, &quot;</span>
					    <span class="s">&quot;ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe05a</span><span class="p">,</span>
					    <span class="s">&quot;qla_target(%d): Unable to send &quot;</span>
					    <span class="s">&quot;command to target, sending BUSY &quot;</span>
					    <span class="s">&quot;status.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
					<span class="n">qlt_send_busy</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="n">SAM_STAT_BUSY</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IMMED_NOTIFY_TYPE</span>:
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe05b</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Received ATIO packet %x &quot;</span>
			    <span class="s">&quot;with error status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
			    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_type</span><span class="p">,</span>
			    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">entry_status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe02e</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;IMMED_NOTIFY ATIO&quot;</span><span class="p">);</span>
		<span class="n">qlt_handle_imm_notify</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">atio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe05c</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Received unknown ATIO atio &quot;</span>
		    <span class="s">&quot;type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ha-&gt;hardware_lock supposed to be held on entry */</span>
<span class="cm">/* called via callback from qla2xxx */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_response_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">response_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tgt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe05d</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Response pkt %x received, but no &quot;</span>
		    <span class="s">&quot;tgt (ha %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe02f</span><span class="p">,</span>
	    <span class="s">&quot;qla_target(%d): response pkt %p: T %02x C %02x S %02x &quot;</span>
	    <span class="s">&quot;handle %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span>
	    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In tgt_stop mode we also should allow all requests to pass.</span>
<span class="cm">	 * Otherwise, some commands can stuck.</span>
<span class="cm">	 */</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTIO_TYPE7</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">ctio7_from_24xx</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio7_from_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe030</span><span class="p">,</span> <span class="s">&quot;CTIO_TYPE7: instance %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">qlt_do_ctio_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
		    <span class="n">entry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">ACCEPT_TGT_IO_TYPE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">atio</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe031</span><span class="p">,</span>
		    <span class="s">&quot;ACCEPT_TGT_IO instance %d status %04x &quot;</span>
		    <span class="s">&quot;lun %04x read/write %d data_length %04x &quot;</span>
		    <span class="s">&quot;target_id %02x rx_id %04x</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">lun</span><span class="p">),</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">execution_codes</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">data_length</span><span class="p">),</span> <span class="n">GET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">atio</span><span class="p">),</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">rx_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ATIO_CDB_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe05e</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): ATIO with error &quot;</span>
			    <span class="s">&quot;status %x received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe032</span><span class="p">,</span>
		    <span class="s">&quot;FCP CDB: 0x%02x, sizeof(cdb): %lu&quot;</span><span class="p">,</span>
		    <span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span>
		    <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">cdb</span><span class="p">));</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">qlt_handle_cmd_for_atio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 1 </span><span class="cm">/* With TERM EXCHANGE some FC cards refuse to boot */</span><span class="cp"></span>
				<span class="n">qlt_send_busy</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe05f</span><span class="p">,</span>
					    <span class="s">&quot;qla_target: Unable to send &quot;</span>
					    <span class="s">&quot;command to target, sending TERM &quot;</span>
					    <span class="s">&quot;EXCHANGE for rsp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="n">atio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe060</span><span class="p">,</span>
					    <span class="s">&quot;qla_target(%d): Unable to send &quot;</span>
					    <span class="s">&quot;command to target, sending BUSY &quot;</span>
					    <span class="s">&quot;status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
					<span class="n">qlt_send_busy</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">atio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CONTINUE_TGT_IO_TYPE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">ctio_to_2xxx</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio_to_2xxx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe033</span><span class="p">,</span>
		    <span class="s">&quot;CONTINUE_TGT_IO: instance %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">qlt_do_ctio_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
		    <span class="n">entry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CTIO_A64_TYPE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">ctio_to_2xxx</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ctio_to_2xxx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe034</span><span class="p">,</span> <span class="s">&quot;CTIO_A64: instance %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">qlt_do_ctio_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
		    <span class="n">entry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IMMED_NOTIFY_TYPE</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe035</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;IMMED_NOTIFY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qlt_handle_imm_notify</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imm_ntfy_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NOTIFY_ACK_TYPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">notify_ack_expected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nack_to_isp</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nack_to_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe036</span><span class="p">,</span>
			    <span class="s">&quot;NOTIFY_ACK seq %08x status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">seq_id</span><span class="p">),</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">notify_ack_expected</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span>
			    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">NOTIFY_ACK_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe061</span><span class="p">,</span>
				    <span class="s">&quot;qla_target(%d): NOTIFY_ACK &quot;</span>
				    <span class="s">&quot;failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp2x</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe062</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Unexpected NOTIFY_ACK received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ABTS_RECV_24XX</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe037</span><span class="p">,</span>
		    <span class="s">&quot;ABTS_RECV_24XX: instance %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="n">qlt_24xx_handle_abts</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">abts_recv_from_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ABTS_RESP_24XX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">abts_resp_expected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">abts_resp_from_24xx_fw</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">abts_resp_from_24xx_fw</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe038</span><span class="p">,</span>
			    <span class="s">&quot;ABTS_RESP_24XX: compl_status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl_status</span><span class="p">);</span>
			<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">abts_resp_expected</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl_status</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">ABTS_RESP_COMPL_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">error_subcode1</span> <span class="o">==</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">error_subcode2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * We&#39;ve got a race here: aborted</span>
<span class="cm">					 * exchange not terminated, i.e.</span>
<span class="cm">					 * response for the aborted command was</span>
<span class="cm">					 * sent between the abort request was</span>
<span class="cm">					 * received and processed.</span>
<span class="cm">					 * Unfortunately, the firmware has a</span>
<span class="cm">					 * silly requirement that all aborted</span>
<span class="cm">					 * exchanges must be explicitely</span>
<span class="cm">					 * terminated, otherwise it refuses to</span>
<span class="cm">					 * send responses for the abort</span>
<span class="cm">					 * requests. So, we have to</span>
<span class="cm">					 * (re)terminate the exchange and retry</span>
<span class="cm">					 * the abort response.</span>
<span class="cm">					 */</span>
					<span class="n">qlt_24xx_retry_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
					    <span class="n">entry</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe063</span><span class="p">,</span>
					    <span class="s">&quot;qla_target(%d): ABTS_RESP_24XX &quot;</span>
					    <span class="s">&quot;failed %x (subcode %x:%x)&quot;</span><span class="p">,</span>
					    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl_status</span><span class="p">,</span>
					    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">error_subcode1</span><span class="p">,</span>
					    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">error_subcode2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe064</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Unexpected ABTS_RESP_24XX &quot;</span>
			    <span class="s">&quot;received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe065</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Received unknown response pkt &quot;</span>
		    <span class="s">&quot;type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ha-&gt;hardware_lock supposed to be held on entry. Might drop it, then reaquire</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qlt_async_event</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reason_code</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe039</span><span class="p">,</span>
	    <span class="s">&quot;scsi(%ld): ha state %d init_done %d oper_mode %d topo %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">),</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tgt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe03a</span><span class="p">,</span>
		    <span class="s">&quot;ASYNC EVENT %#x, but no tgt (ha %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">code</span> <span class="o">==</span> <span class="n">MBA_POINT_TO_POINT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MBA_CHG_IN_CONNECTION</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * In tgt_stop mode we also should allow all requests to pass.</span>
<span class="cm">	 * Otherwise, some commands can stuck.</span>
<span class="cm">	 */</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBA_RESET</span>:			<span class="cm">/* Reset */</span>
	<span class="k">case</span> <span class="n">MBA_SYSTEM_ERR</span>:		<span class="cm">/* System Error */</span>
	<span class="k">case</span> <span class="n">MBA_REQ_TRANSFER_ERR</span>:	<span class="cm">/* Request Transfer Error */</span>
	<span class="k">case</span> <span class="n">MBA_RSP_TRANSFER_ERR</span>:	<span class="cm">/* Response Transfer Error */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf03a</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): System error async event %#x &quot;</span>
		    <span class="s">&quot;occured&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBA_WAKEUP_THRES</span>:		<span class="cm">/* Request Queue Wake-up. */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_LOOP_UP</span>:
	<span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf03b</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Async LOOP_UP occured &quot;</span>
		    <span class="s">&quot;(m[1]=%x, m[2]=%x, m[3]=%x, m[4]=%x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlt_send_notify_ack</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">link_reinit_iocb_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MBA_LIP_OCCURRED</span>:
	<span class="k">case</span> <span class="n">MBA_LOOP_DOWN</span>:
	<span class="k">case</span> <span class="n">MBA_LIP_RESET</span>:
	<span class="k">case</span> <span class="n">MBA_RSCN_UPDATE</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf03c</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Async event %#x occured &quot;</span>
		    <span class="s">&quot;(m[1]=%x, m[2]=%x, m[3]=%x, m[4]=%x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBA_PORT_UPDATE</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf03d</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Port update async event %#x &quot;</span>
		    <span class="s">&quot;occured: updating the ports database (m[1]=%x, m[2]=%x, &quot;</span>
		    <span class="s">&quot;m[3]=%x, m[4]=%x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="n">reason_code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">==</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf03e</span><span class="p">,</span>
			    <span class="s">&quot;Async MB 2: Got PLOGI Complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf03f</span><span class="p">,</span>
			    <span class="s">&quot;Async MB 2: Port Logged Out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf040</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Async event %#x occured: &quot;</span>
		    <span class="s">&quot;ignore (m[1]=%x, m[2]=%x, m[3]=%x, m[4]=%x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">code</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">irq_cmd_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="nf">qlt_get_port_database</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">fcport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf06f</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Allocation of tmp FC port failed&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf041</span><span class="p">,</span> <span class="s">&quot;loop_id %d&quot;</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla2x00_get_port_database</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf070</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): Failed to retrieve fcport &quot;</span>
		    <span class="s">&quot;information -- get_port_database() returned %x &quot;</span>
		    <span class="s">&quot;(loop_id=0x%04x)&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be called under tgt_mutex */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="nf">qlt_make_local_sess</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">s_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">global_resets</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">loop_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="n">global_resets</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla24xx_get_loop_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">s_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loop_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFC</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This is Domain Controller, so it should be</span>
<span class="cm">			 * OK to drop SCSI commands from it.</span>
<span class="cm">			 */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf042</span><span class="p">,</span>
			    <span class="s">&quot;Unable to find initiator with S_ID %x:%x:%x&quot;</span><span class="p">,</span>
			    <span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf071</span><span class="p">,</span>
			    <span class="s">&quot;qla_target(%d): Unable to find &quot;</span>
			    <span class="s">&quot;initiator with S_ID %x:%x:%x&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span> <span class="o">=</span> <span class="n">qlt_get_port_database</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">global_resets</span> <span class="o">!=</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf043</span><span class="p">,</span>
		    <span class="s">&quot;qla_target(%d): global reset during session discovery &quot;</span>
		    <span class="s">&quot;(counter was %d, new %d), retrying&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span>
		    <span class="n">global_resets</span><span class="p">,</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_create_sess</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sess</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_abort_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess_work_param</span> <span class="o">*</span><span class="n">prm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">be_s_id</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>

	<span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">abts</span><span class="p">.</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">abts</span><span class="p">.</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">abts</span><span class="p">.</span><span class="n">fcp_hdr_le</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_s_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">be_s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_make_local_sess</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">s_id</span><span class="p">);</span>
		<span class="cm">/* sess has got an extra creation ref */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">sess_kref</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">__qlt_24xx_handle_abts</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">abts</span><span class="p">,</span> <span class="n">sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_term:</span>
	<span class="n">qlt_24xx_send_abts_resp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">abts</span><span class="p">,</span> <span class="n">FCP_TMF_REJECTED</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_tmr_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess_work_param</span> <span class="o">*</span><span class="n">prm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">tm_iocb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt_sess</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">s_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* to hide compiler warnings */</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">lun</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lun_size</span><span class="p">,</span> <span class="n">fn</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>

	<span class="n">s_id</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">tm_iocb2</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_hdr</span><span class="p">.</span><span class="n">s_id</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">find_sess_by_s_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">qlt_make_local_sess</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">s_id</span><span class="p">);</span>
		<span class="cm">/* sess has got an extra creation ref */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">sess_kref</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iocb</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">lun_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">fn</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isp24</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">.</span><span class="n">task_mgmt_flags</span><span class="p">;</span>
	<span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qlt_issue_task_mgmt</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_term</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_term:</span>
	<span class="n">qlt_send_term_exchange</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">tm_iocb2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span><span class="o">-&gt;</span><span class="n">put_sess</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_sess_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_tgt</span><span class="p">,</span> <span class="n">sess_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt_mgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="s">&quot;Sess work (tgt %p)&quot;</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_works_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qla_tgt_sess_work_param</span> <span class="o">*</span><span class="n">prm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span>
		    <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_works_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">prm</span><span class="p">),</span>
		    <span class="n">sess_works_list_entry</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This work can be scheduled on several CPUs at time, so we</span>
<span class="cm">		 * must delete the entry to eliminate double processing</span>
<span class="cm">		 */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">sess_works_list_entry</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA_TGT_SESS_WORK_ABORT</span>:
			<span class="n">qlt_abort_work</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">prm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA_TGT_SESS_WORK_TM</span>:
			<span class="n">qlt_tmr_work</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">prm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">prm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Must be called under tgt_host_action_mutex */</span>
<span class="kt">int</span> <span class="nf">qlt_add_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xe03b</span><span class="p">,</span>
	    <span class="s">&quot;Registering target for host %ld(%p)&quot;</span><span class="p">,</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="n">tgt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xe066</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate struct qla_tgt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">supported_mode</span> <span class="o">&amp;</span> <span class="n">MODE_TARGET</span><span class="p">))</span>
		<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">supported_mode</span> <span class="o">|=</span> <span class="n">MODE_TARGET</span><span class="p">;</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">waitQ</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">del_sess_list</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_del_work</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">))</span><span class="n">qlt_del_sess_work_fn</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work_lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_work</span><span class="p">,</span> <span class="n">qlt_sess_work_fn</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sess_works_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_ctio_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_imm_list</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">srr_work</span><span class="p">,</span> <span class="n">qlt_handle_srr_work</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_global_resets_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span> <span class="o">=</span> <span class="n">tgt</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0xe067</span><span class="p">,</span>
		<span class="s">&quot;qla_target(%d): using 64 Bit PCI addressing&quot;</span><span class="p">,</span>
		<span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_enable_64bit_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* 3 is reserved */</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">QLA_TGT_MAX_SG_24XX</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cmd</span> <span class="o">=</span> <span class="n">QLA_TGT_DATASEGS_PER_CMD_24XX</span><span class="p">;</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">datasegs_per_cont</span> <span class="o">=</span> <span class="n">QLA_TGT_DATASEGS_PER_CONT_24XX</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_list_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qla_tgt_glist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be called under tgt_host_action_mutex */</span>
<span class="kt">int</span> <span class="nf">qlt_remove_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="o">-&gt;</span><span class="n">tgt_list_entry</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe03c</span><span class="p">,</span> <span class="s">&quot;Unregistering target for host %ld(%p)&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="n">qlt_release</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlt_lport_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">u64</span> <span class="n">wwpn</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;qla2xxx HW vha-&gt;node_name: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WWN_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;qla2xxx HW vha-&gt;port_name: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WWN_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;qla2xxx passed configfs WWPN: &quot;</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">wwpn</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WWN_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla_tgt_lport_register - register lport with external module</span>
<span class="cm"> *</span>
<span class="cm"> * @qla_tgt_ops: Pointer for tcm_qla2xxx qla_tgt_ops</span>
<span class="cm"> * @wwpn: Passwd FC target WWPN</span>
<span class="cm"> * @callback:  lport initialization callback for tcm_qla2xxx code</span>
<span class="cm"> * @target_lport_ptr: pointer for tcm_qla2xxx specific lport data</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qlt_lport_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_func_tmpl</span> <span class="o">*</span><span class="n">qla_tgt_ops</span><span class="p">,</span> <span class="n">u64</span> <span class="n">wwpn</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">target_lport_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="n">WWN_SIZE</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qla_tgt_glist</span><span class="p">,</span> <span class="n">tgt_list_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vha</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
		<span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

		<span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">supported_mode</span> <span class="o">&amp;</span> <span class="n">MODE_TARGET</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">&amp;</span> <span class="n">MODE_TARGET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MODE_TARGET already active on qla2xxx(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe068</span><span class="p">,</span>
			    <span class="s">&quot;Unable to scsi_host_get() for&quot;</span>
			    <span class="s">&quot; qla2xxx scsi_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qlt_lport_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">wwpn</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Setup passed parameters ahead of invoking callback</span>
<span class="cm">		 */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span> <span class="o">=</span> <span class="n">qla_tgt_ops</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">target_lport_ptr</span> <span class="o">=</span> <span class="n">target_lport_ptr</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">target_lport_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_tgt_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_lport_register</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qla_tgt_lport_deregister - Degister lport</span>
<span class="cm"> *</span>
<span class="cm"> * @vha:  Registered scsi_qla_host pointer</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">qlt_lport_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear the target_lport_ptr qla_target_template pointer in qla_hw_data</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">target_lport_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Release the Scsi_Host reference for the underlying qla2xxx host</span>
<span class="cm">	 */</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_lport_deregister</span><span class="p">);</span>

<span class="cm">/* Must be called under HW lock */</span>
<span class="kt">void</span> <span class="nf">qlt_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ql2x_ini_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLA2XXX_INI_MODE_DISABLED</span>:
	<span class="k">case</span> <span class="n">QLA2XXX_INI_MODE_EXCLUSIVE</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">=</span> <span class="n">MODE_TARGET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLA2XXX_INI_MODE_ENABLED</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">|=</span> <span class="n">MODE_TARGET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">ini_mode_force_reverse</span><span class="p">)</span>
		<span class="n">qla_reverse_ini_mode</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Must be called under HW lock */</span>
<span class="kt">void</span> <span class="nf">qlt_clear_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ql2x_ini_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLA2XXX_INI_MODE_DISABLED</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">=</span> <span class="n">MODE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLA2XXX_INI_MODE_EXCLUSIVE</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">=</span> <span class="n">MODE_INITIATOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLA2XXX_INI_MODE_ENABLED</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_TARGET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">ini_mode_force_reverse</span><span class="p">)</span>
		<span class="n">qla_reverse_ini_mode</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla_tgt_enable_vha - NO LOCK HELD</span>
<span class="cm"> *</span>
<span class="cm"> * host_reset, bring up w/ Target Mode Enabled</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qlt_enable_vha</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe069</span><span class="p">,</span>
		    <span class="s">&quot;Unable to locate qla_tgt pointer from&quot;</span>
		    <span class="s">&quot; struct qla_hw_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qlt_set_mode</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qlt_enable_vha</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * qla_tgt_disable_vha - NO LOCK HELD</span>
<span class="cm"> *</span>
<span class="cm"> * Disable Target Mode and reset the adapter</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qlt_disable_vha</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_tgt</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">qla_tgt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_tgt</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xe06a</span><span class="p">,</span>
		    <span class="s">&quot;Unable to locate qla_tgt pointer from&quot;</span>
		    <span class="s">&quot; struct qla_hw_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qlt_clear_mode</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from qla_init.c:qla24xx_vport_create() contex to setup</span>
<span class="cm"> * the target mode specific struct scsi_qla_host and struct qla_hw_data</span>
<span class="cm"> * members.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qlt_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_host_action_mutex</span><span class="p">);</span>

	<span class="n">qlt_clear_mode</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: Currently the value is kept the same for &lt;24xx and</span>
<span class="cm">	 * &gt;=24xx ISPs. If it is necessary to change it,</span>
<span class="cm">	 * the check should be added for specific ISPs,</span>
<span class="cm">	 * assigning the value appropriately.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span> <span class="o">=</span> <span class="n">ATIO_ENTRY_CNT_24XX</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_rff_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FC-4 Feature bit 0 indicates target functionality to the name server.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
			<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">fc4_feature</span> <span class="o">=</span> <span class="n">BIT_0</span> <span class="o">|</span> <span class="n">BIT_1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">fc4_feature</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">fc4_feature</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qlt_init_atio_q_entries() - Initializes ATIO queue entries.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Beginning of ATIO ring has initialization control block already built</span>
<span class="cm"> * by nvram config routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qlt_init_atio_q_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">ATIO_PROCESSED</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qlt_24xx_process_atio_queue() - Process ATIO queue entries.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">ATIO_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_ptr</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">entry_count</span><span class="p">;</span>

		<span class="n">qlt_24xx_atio_pkt_all_vps</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_index</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_ptr</span><span class="o">++</span><span class="p">;</span>

			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">ATIO_PROCESSED</span><span class="p">;</span>
			<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_ptr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust ring index */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">atio_q_out</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_24xx_config_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

<span class="cm">/* FIXME: atio_q in/out for ha-&gt;mqenable=1..? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		WRT_REG_DWORD(&amp;reg-&gt;isp25mq.atio_q_in, 0);</span>
<span class="c">		WRT_REG_DWORD(&amp;reg-&gt;isp25mq.atio_q_out, 0);</span>
<span class="c">		RD_REG_DWORD(&amp;reg-&gt;isp25mq.atio_q_out);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Setup APTIO registers for target mode */</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">atio_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">atio_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">atio_q_out</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_24xx_config_nvram_stage1</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nvram_24xx</span> <span class="o">*</span><span class="n">nv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We save only once */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_exchange_count</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">exchange_count</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_firmware_options_1</span> <span class="o">=</span>
			    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_firmware_options_2</span> <span class="o">=</span>
			    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_firmware_options_3</span> <span class="o">=</span>
			    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_3</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">exchange_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>

		<span class="cm">/* Enable target mode */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_4</span><span class="p">);</span>

		<span class="cm">/* Disable ini mode, if requested */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_5</span><span class="p">);</span>

		<span class="cm">/* Disable Full Login after LIP */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BIT_13</span><span class="p">);</span>
		<span class="cm">/* Enable initial LIP */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BIT_9</span><span class="p">);</span>
		<span class="cm">/* Enable FC tapes support */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_12</span><span class="p">);</span>
		<span class="cm">/* Disable Full Login after LIP */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BIT_10</span><span class="p">);</span>
		<span class="cm">/* Enable target PRLI control */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_14</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">exchange_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_exchange_count</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">=</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_firmware_options_1</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">=</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_firmware_options_2</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_3</span> <span class="o">=</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">saved_firmware_options_3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* out-of-order frames reassembly */</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_3</span> <span class="o">|=</span> <span class="n">BIT_6</span><span class="o">|</span><span class="n">BIT_9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">enable_class_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span>
			<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">FC_COS_CLASS2</span> <span class="o">|</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span>
			<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_24xx_config_nvram_stage2</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="n">icb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">node_name_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_14</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qlt_24xx_process_response_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sts_entry_24xx</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ABTS_RECV_24XX</span>:
	<span class="k">case</span> <span class="n">ABTS_RESP_24XX</span>:
	<span class="k">case</span> <span class="n">CTIO_TYPE7</span>:
	<span class="k">case</span> <span class="n">NOTIFY_ACK_TYPE</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_modify_vp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">vp_config_entry_24xx</span> <span class="o">*</span><span class="n">vpmod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">options_idx1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_5</span><span class="p">;</span>
	<span class="cm">/* Disable ini mode, if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">vpmod</span><span class="o">-&gt;</span><span class="n">options_idx1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_4</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_probe_one_stage1</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_host_action_mutex</span><span class="p">);</span>
	<span class="n">qlt_clear_mode</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qlt_mem_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_vp_map</span><span class="p">)</span> <span class="o">*</span>
	    <span class="n">MAX_MULTI_ID_FABRIC</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span><span class="p">),</span>
	    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlt_mem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atio_from_isp</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* vport_slock to be held by the caller */</span>
<span class="kt">void</span>
<span class="nf">qlt_update_vp_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_VP_IDX</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">vha</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_AL_PA</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESET_VP_IDX</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">vha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESET_AL_PA</span>:
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">tgt_vp_map</span><span class="p">[</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qlt_parse_ini_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">qlini_mode</span><span class="p">,</span> <span class="n">QLA2XXX_INI_MODE_STR_EXCLUSIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql2x_ini_mode</span> <span class="o">=</span> <span class="n">QLA2XXX_INI_MODE_EXCLUSIVE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">qlini_mode</span><span class="p">,</span> <span class="n">QLA2XXX_INI_MODE_STR_DISABLED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql2x_ini_mode</span> <span class="o">=</span> <span class="n">QLA2XXX_INI_MODE_DISABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">qlini_mode</span><span class="p">,</span> <span class="n">QLA2XXX_INI_MODE_STR_ENABLED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql2x_ini_mode</span> <span class="o">=</span> <span class="n">QLA2XXX_INI_MODE_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">qlt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qlt_parse_ini_mode</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xe06b</span><span class="p">,</span>
		    <span class="s">&quot;qlt_parse_ini_mode() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qla_tgt_cmd_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qla_tgt_cmd_cachep&quot;</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span><span class="p">),</span> <span class="n">__alignof__</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xe06c</span><span class="p">,</span>
		    <span class="s">&quot;kmem_cache_create for qla_tgt_cmd_cachep failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla_tgt_mgmt_cmd_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qla_tgt_mgmt_cmd_cachep&quot;</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_tgt_mgmt_cmd</span><span class="p">),</span> <span class="n">__alignof__</span><span class="p">(</span><span class="k">struct</span>
	    <span class="n">qla_tgt_mgmt_cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_tgt_mgmt_cmd_cachep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xe06d</span><span class="p">,</span>
		    <span class="s">&quot;kmem_cache_create for qla_tgt_mgmt_cmd_cachep failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla_tgt_mgmt_cmd_mempool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">mempool_alloc_slab</span><span class="p">,</span>
	    <span class="n">mempool_free_slab</span><span class="p">,</span> <span class="n">qla_tgt_mgmt_cmd_cachep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xe06e</span><span class="p">,</span>
		    <span class="s">&quot;mempool_create for qla_tgt_mgmt_cmd_mempool failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mgmt_cmd_cachep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla_tgt_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;qla_tgt_wq&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_tgt_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xe06f</span><span class="p">,</span>
		    <span class="s">&quot;alloc_workqueue for qla_tgt_wq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_cmd_mempool</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Return 1 to signal that initiator-mode is being disabled</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ql2x_ini_mode</span> <span class="o">==</span> <span class="n">QLA2XXX_INI_MODE_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_cmd_mempool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
<span class="nl">out_mgmt_cmd_cachep:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_cachep</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA_TGT_MODE_ENABLED</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">qla_tgt_wq</span><span class="p">);</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_mempool</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qla_tgt_mgmt_cmd_cachep</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qla_tgt_cmd_cachep</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
