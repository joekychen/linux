<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_gbl.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;qla_devtbl.h&quot;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;target/target_core_base.h&gt;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">*  QLogic ISP2x00 Hardware Support Function Prototypes.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_isp_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_setup_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_init_rings</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_fw_ready</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_configure_hba</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_configure_loop</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_configure_local_loop</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_configure_fabric</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_find_all_fabric_devs</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_fabric_dev_login</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_restart_isp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_chip_state_84xx</span> <span class="o">*</span><span class="n">qla84xx_get_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla84xx_init_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla25xx_init_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* SRB Extensions ---------------------------------------------------------- */</span>

<span class="kt">void</span>
<span class="nf">qla2x00_sp_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">__data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_sp_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>

	<span class="n">QLA_VHA_MARK_NOT_BUSY</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Asynchronous Login/Logout Routines -------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla2x00_get_async_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Firmware should use switch negotiated r_a_tov for timeout. */</span>
	<span class="n">tmo</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Except for earlier ISPs where the timeout is seeded from the</span>
<span class="cm">		 * initialization control block.</span>
<span class="cm">		 */</span>
		<span class="n">tmo</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tmo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_async_iocb_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x2071</span><span class="p">,</span>
	    <span class="s">&quot;Async-%s timeout - hdl=%x portid=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SRB_LOGIN_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
		<span class="n">qla2x00_post_async_logout_work</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* Retry as needed. */</span>
		<span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">;</span>
		<span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_LOGIN_RETRIED</span> <span class="o">?</span>
			<span class="n">QLA_LOGIO_LOGIN_RETRIED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla2x00_post_async_login_done_work</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span>
			<span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_async_login_sp_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">qla2x00_post_async_login_done_work</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">,</span>
		    <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_async_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SRB_LOGIN_CMD</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;login&quot;</span><span class="p">;</span>
	<span class="n">qla2x00_init_timer</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">qla2x00_get_async_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">lio</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">qla2x00_async_iocb_timeout</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">qla2x00_async_login_sp_done</span><span class="p">;</span>
	<span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_LOGIN_COND_PLOGI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">QLA_LOGIO_LOGIN_RETRIED</span><span class="p">)</span>
		<span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_LOGIN_RETRIED</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_start_sp</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_free_sp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2072</span><span class="p">,</span>
	    <span class="s">&quot;Async-login - hdl=%x, loopid=%x portid=%02x%02x%02x &quot;</span>
	    <span class="s">&quot;retries=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">done_free_sp:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_async_logout_sp_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">qla2x00_post_async_logout_done_work</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">,</span>
		    <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_async_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SRB_LOGOUT_CMD</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;logout&quot;</span><span class="p">;</span>
	<span class="n">qla2x00_init_timer</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">qla2x00_get_async_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">lio</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">qla2x00_async_iocb_timeout</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">qla2x00_async_logout_sp_done</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_start_sp</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_free_sp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2070</span><span class="p">,</span>
	    <span class="s">&quot;Async-logout - hdl=%x loop-id=%x portid=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">done_free_sp:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_async_adisc_sp_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">qla2x00_post_async_adisc_done_work</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">,</span>
		    <span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_async_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">lio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SRB_ADISC_CMD</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;adisc&quot;</span><span class="p">;</span>
	<span class="n">qla2x00_init_timer</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">qla2x00_get_async_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">lio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">lio</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">qla2x00_async_iocb_timeout</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">qla2x00_async_adisc_sp_done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">QLA_LOGIO_LOGIN_RETRIED</span><span class="p">)</span>
		<span class="n">lio</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">logio</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_LOGIN_RETRIED</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_start_sp</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_free_sp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x206f</span><span class="p">,</span>
	    <span class="s">&quot;Async-adisc - hdl=%x loopid=%x portid=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">done_free_sp:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_async_tm_cmd_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>

		<span class="cm">/* Issue Marker IOCB */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">==</span> <span class="n">TCF_LUN_RESET</span> <span class="o">?</span> <span class="n">MK_SYNC_ID_LUN</span> <span class="o">:</span> <span class="n">MK_SYNC_ID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8030</span><span class="p">,</span>
			    <span class="s">&quot;TM IOCB failed (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla2x00_async_tm_cmd</span><span class="p">(</span><span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">tm_flags</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">lun</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb_iocb</span> <span class="o">*</span><span class="n">tcf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">qla2x00_get_sp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SRB_TM_CMD</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tmf&quot;</span><span class="p">;</span>
	<span class="n">qla2x00_init_timer</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">qla2x00_get_async_timeout</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">tcf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iocb_cmd</span><span class="p">;</span>
	<span class="n">tcf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">tm_flags</span><span class="p">;</span>
	<span class="n">tcf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">tcf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tmf</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">tcf</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">qla2x00_async_iocb_timeout</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">qla2x00_async_tm_cmd_done</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_start_sp</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_free_sp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x802f</span><span class="p">,</span>
	    <span class="s">&quot;Async-tmf hdl=%x loop-id=%x portid=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">done_free_sp:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_async_login_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBS_COMMAND_COMPLETE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Driver must validate login state - If PRLI not complete,</span>
<span class="cm">		 * force a relogin attempt via implicit LOGO, PLOGI, and PRLI</span>
<span class="cm">		 * requests.</span>
<span class="cm">		 */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_port_database</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_NOT_LOGGED_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_LOGIN_NEEDED</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_post_async_logout_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">qla2x00_post_async_login_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_post_async_adisc_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qla2x00_update_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBS_COMMAND_ERROR</span>:
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">QLA_LOGIO_LOGIN_RETRIED</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBS_PORT_ID_USED</span>:
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">qla2x00_post_async_logout_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">qla2x00_post_async_login_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBS_LOOP_ID_USED</span>:
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_find_new_loop_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
			<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qla2x00_post_async_login_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_async_logout_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_async_adisc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_update_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Retry login. */</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">QLA_LOGIO_LOGIN_RETRIED</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RELOGIN_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                QLogic ISP2x00 Hardware Support Functions.                */</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_initialize_adapter</span>
<span class="cm">*      Initialize board.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha = adapter block pointer.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0 = success</span>
<span class="cm">*/</span>
<span class="kt">int</span>
<span class="nf">qla2x00_initialize_adapter</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Clear adapter flags. */</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">thermal_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">=</span> <span class="n">DFLG_NO_CABLE</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_qid_map</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_qid_map</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">,</span>
	    <span class="s">&quot;Configuring PCI space...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">pci_config</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span>
		    <span class="s">&quot;Unable to configure PCI space.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2xxx_get_flash_info</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x004f</span><span class="p">,</span>
		    <span class="s">&quot;Unable to validate FLASH data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">get_flash_version</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">,</span>
	    <span class="s">&quot;Configure NVRAM parameters...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">nvram_config</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_serdes</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mask HBA via NVRAM settings? */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0077</span><span class="p">,</span>
		    <span class="s">&quot;Masking HBA WWPN &quot;</span>
		    <span class="s">&quot;%02x%02x%02x%02x%02x%02x%02x%02x (via NVRAM).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span>
	    <span class="s">&quot;Verifying loaded RISC code...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_isp_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">chip_diag</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_setup_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA84XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span> <span class="o">=</span> <span class="n">qla84xx_get_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d0</span><span class="p">,</span>
			    <span class="s">&quot;Unable to configure ISP84XX.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_init_rings</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">IS_QLA84XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Issue verify 84xx FW IOCB to complete 84xx initialization */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla84xx_init_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d4</span><span class="p">,</span>
			    <span class="s">&quot;Unable to initialize ISP84XX.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla84xx_put_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">qla24xx_read_fcp_prio_cfg</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2100_pci_config() - Setup ISP21xx PCI configuration registers.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2100_pci_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="n">pci_disable_rom</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Get PCI bus information. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pci_attr</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2300_pci_config() - Setup ISP23xx PCI configuration registers.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2300_pci_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is a 2300 card and not 2312, reset the</span>
<span class="cm">	 * COMMAND_INVALIDATE due to a bug in the 2300. Unfortunately,</span>
<span class="cm">	 * the 2310 also reports itself as a 2300 so we need to get the</span>
<span class="cm">	 * fb revision level -- a 6 indicates it really is a 2300 and</span>
<span class="cm">	 * not a 2310.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Pause RISC. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_PAUSE_RISC</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCCR_RISC_PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Select FPM registers. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

		<span class="cm">/* Get the fb rev level */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fb_rev</span> <span class="o">=</span> <span class="n">RD_FB_CMD_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fb_rev</span> <span class="o">==</span> <span class="n">FPM_2300</span><span class="p">)</span>
			<span class="n">pci_clear_mwi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

		<span class="cm">/* Deselect FPM registers. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

		<span class="cm">/* Release RISC module. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RELEASE_RISC</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCCR_RISC_PAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">pci_disable_rom</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Get PCI bus information. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pci_attr</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_pci_config() - Setup ISP24xx PCI configuration registers.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_pci_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* PCI-X -- adjust Maximum Memory Read Byte Count (2048). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">))</span>
		<span class="n">pcix_set_mmrbc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>

	<span class="cm">/* PCIe -- adjust Maximum Read Request Size (2048). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">))</span>
		<span class="n">pcie_set_readrq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>

	<span class="n">pci_disable_rom</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="cm">/* Get PCI bus information. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pci_attr</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla25xx_pci_config() - Setup ISP25xx PCI configuration registers.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla25xx_pci_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/* PCIe -- adjust Maximum Read Request Size (2048). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">))</span>
		<span class="n">pcie_set_readrq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>

	<span class="n">pci_disable_rom</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_isp_firmware() - Choose firmware image.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_isp_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">loop_id</span><span class="p">,</span> <span class="n">topo</span><span class="p">,</span> <span class="n">sw_cap</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">domain</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">al_pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Assume loading risc code */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_risc_code_load</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">,</span> <span class="s">&quot;RISC CODE NOT loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Verify checksum of loaded RISC code. */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_verify_checksum</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_srisc_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* And, verify we are not in ROM code. */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_adapter_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loop_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al_pa</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">area</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">topo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_cap</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x007a</span><span class="p">,</span>
		    <span class="s">&quot;**** Load RISC code ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_reset_chip() - Reset ISP chip.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_reset_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Turn off master enable */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Pause RISC. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_PAUSE_RISC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">HCCR_RISC_PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Select FPM registers. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>

		<span class="cm">/* FPM Soft Reset. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">fpm_diag_config</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">fpm_diag_config</span><span class="p">);</span>	<span class="cm">/* PCI Posting. */</span>

		<span class="cm">/* Toggle Fpm Reset. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">fpm_diag_config</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">fpm_diag_config</span><span class="p">);</span> <span class="cm">/* PCI Posting. */</span>
		<span class="p">}</span>

		<span class="cm">/* Select frame buffer registers. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>

		<span class="cm">/* Reset frame buffer FIFOs. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WRT_FB_CMD_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xa000</span><span class="p">);</span>
			<span class="n">RD_FB_CMD_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WRT_FB_CMD_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x00fc</span><span class="p">);</span>

			<span class="cm">/* Read back fb_cmd until zero or 3 seconds max */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">RD_FB_CMD_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Select RISC module registers. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>

		<span class="cm">/* Reset RISC processor. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RESET_RISC</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>

		<span class="cm">/* Release RISC processor. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RELEASE_RISC</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_RISC_INT</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_CLR_HOST_INT</span><span class="p">);</span>

	<span class="cm">/* Reset ISP chip. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">CSR_ISP_SOFT_RESET</span><span class="p">);</span>

	<span class="cm">/* Wait for RISC to recover from reset. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * It is necessary to for a delay here since the card doesn&#39;t</span>
<span class="cm">		 * respond to PCI reads during a reset. On some architectures</span>
<span class="cm">		 * this will result in an MCA.</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">CSR_ISP_SOFT_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Reset RISC processor. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RESET_RISC</span><span class="p">);</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Release RISC processor. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RELEASE_RISC</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>			<span class="cm">/* PCI Posting. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MBS_BUSY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Turn on master enable */</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Disable RISC pause on FPM parity error. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_DISABLE_PARITY_PAUSE</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>		<span class="cm">/* PCI Posting. */</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla81xx_reset_mpi() - Reset&#39;s MPI FW via Write MPI Register MBC.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla81xx_reset_mpi</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1010</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">qla81xx_write_mpi_register</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_reset_risc() - Perform full reset of ISP24xx RISC.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla24xx_reset_risc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">d2</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">wd</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">abts_cnt</span><span class="p">;</span> <span class="cm">/* ISP abort retry counts */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset RISC. */</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">CSRX_DMA_SHUTDOWN</span><span class="o">|</span><span class="n">MWB_4096_BYTES</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSRX_DMA_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span>
	    <span class="n">CSRX_ISP_SOFT_RESET</span><span class="o">|</span><span class="n">CSRX_DMA_SHUTDOWN</span><span class="o">|</span><span class="n">MWB_4096_BYTES</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wd</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* Wait for firmware to complete NVRAM accesses. */</span>
	<span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">10000</span> <span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">d2</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for soft-reset to complete. */</span>
	<span class="n">d2</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">6000000</span> <span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d2</span> <span class="o">&amp;</span> <span class="n">CSRX_ISP_SOFT_RESET</span><span class="p">);</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">d2</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* If required, do an MPI FW reset now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MPI_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla81xx_reset_mpi</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">abts_cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MPI_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We exhausted the ISP abort retries. We have to</span>
<span class="cm">				 * set the board offline.</span>
<span class="cm">				 */</span>
				<span class="n">abts_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_SET_RISC_RESET</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_REL_RISC_PAUSE</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_CLR_RISC_RESET</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>

	<span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">6000000</span> <span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">d2</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOPOLLING_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_reset_chip() - Reset ISP24xx chip.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla24xx_reset_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Perform RISC reset. */</span>
	<span class="n">qla24xx_reset_risc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_chip_diag() - Test chip for proper operation.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_chip_diag</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Assume a failed state */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x007b</span><span class="p">,</span>
	    <span class="s">&quot;Testing device at %lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">flash_address</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset ISP chip. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">,</span> <span class="n">CSR_ISP_SOFT_RESET</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to have a delay here since the card will not respond while</span>
<span class="cm">	 * in reset causing an MCA on some architectures.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">qla2x00_debounce_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">6000000</span> <span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CSR_ISP_SOFT_RESET</span><span class="p">);</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">chip_diag_failed</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x007c</span><span class="p">,</span>
	    <span class="s">&quot;Reset register cleared by chip reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Reset RISC processor. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RESET_RISC</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RELEASE_RISC</span><span class="p">);</span>

	<span class="cm">/* Workaround for QLA2312 PCI parity error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">qla2x00_debounce_register</span><span class="p">(</span><span class="n">MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">MBS_BUSY</span><span class="p">);</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">barrier</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">chip_diag_failed</span><span class="p">;</span>

	<span class="cm">/* Check product ID of chip */</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x007d</span><span class="p">,</span> <span class="s">&quot;Checking product Id of chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">qla2x00_debounce_register</span><span class="p">(</span><span class="n">MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PROD_ID_1</span> <span class="o">||</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PROD_ID_2</span> <span class="o">&amp;&amp;</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PROD_ID_2a</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PROD_ID_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span>
		    <span class="s">&quot;Wrong product ID = 0x%x,0x%x,0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="k">goto</span> <span class="n">chip_diag_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Adjust fw RISC transfer size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">*</span>
		    <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">RD_MAILBOX_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA2200A_RISC_ROM_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Limit firmware transfer size with a 2200A */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x007e</span><span class="p">,</span> <span class="s">&quot;Found QLA2200A Chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">|=</span> <span class="n">DT_ISP2200A</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wrap Incoming Mailboxes Test. */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x007f</span><span class="p">,</span> <span class="s">&quot;Checking mailboxes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mbx_reg_test</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">,</span>
		    <span class="s">&quot;Failed mailbox send register test.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Flag a successful rval */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">chip_diag_failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0081</span><span class="p">,</span>
		    <span class="s">&quot;Chip diagnostics **** FAILED ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_chip_diag() - Test ISP24xx for proper operation.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_chip_diag</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">*</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mbx_reg_test</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0082</span><span class="p">,</span>
		    <span class="s">&quot;Failed mailbox send register test.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Flag a successful rval */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_alloc_fw_dump</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dump_size</span><span class="p">,</span> <span class="n">fixed_size</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">,</span> <span class="n">req_q_size</span><span class="p">,</span> <span class="n">rsp_q_size</span><span class="p">,</span>
	    <span class="n">eft_size</span><span class="p">,</span> <span class="n">fce_size</span><span class="p">,</span> <span class="n">mq_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tc_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00bd</span><span class="p">,</span>
		    <span class="s">&quot;Firmware dump already allocated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fixed_size</span> <span class="o">=</span> <span class="n">mem_size</span> <span class="o">=</span> <span class="n">eft_size</span> <span class="o">=</span> <span class="n">fce_size</span> <span class="o">=</span> <span class="n">mq_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fixed_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2100_fw_dump</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fixed_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2300_fw_dump</span><span class="p">,</span> <span class="n">data_ram</span><span class="p">);</span>
		<span class="n">mem_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_memory_size</span> <span class="o">-</span> <span class="mh">0x11000</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">fixed_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla83xx_fw_dump</span><span class="p">,</span> <span class="n">ext_mem</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">fixed_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla81xx_fw_dump</span><span class="p">,</span> <span class="n">ext_mem</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">fixed_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla25xx_fw_dump</span><span class="p">,</span> <span class="n">ext_mem</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fixed_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla24xx_fw_dump</span><span class="p">,</span> <span class="n">ext_mem</span><span class="p">);</span>
		<span class="n">mem_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_memory_size</span> <span class="o">-</span> <span class="mh">0x100000</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="n">mq_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2xxx_mq_chain</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Allocate maximum buffer size for all queues.</span>
<span class="cm">			 * Resizing must be done at end-of-dump processing.</span>
<span class="cm">			 */</span>
			<span class="n">mq_size</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">));</span>
			<span class="n">mq_size</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span><span class="p">)</span>
			<span class="n">mq_size</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">);</span>
		<span class="cm">/* Allocate memory for Fibre Channel Event Buffer. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">try_eft</span><span class="p">;</span>

		<span class="n">tc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FCE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_dma</span><span class="p">,</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00be</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate (%d KB) for FCE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">FCE_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try_eft</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FCE_SIZE</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_enable_fce_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tc_dma</span><span class="p">,</span> <span class="n">FCE_NUM_BUFFERS</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_mb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">,</span>
			    <span class="s">&quot;Unable to initialize FCE (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FCE_SIZE</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span>
			    <span class="n">tc_dma</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_eft</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c0</span><span class="p">,</span>
		    <span class="s">&quot;Allocate (%d KB) for FCE...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FCE_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

		<span class="n">fce_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2xxx_fce_chain</span><span class="p">)</span> <span class="o">+</span> <span class="n">FCE_SIZE</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span> <span class="o">=</span> <span class="n">tc_dma</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span> <span class="o">=</span> <span class="n">tc</span><span class="p">;</span>
<span class="nl">try_eft:</span>
		<span class="cm">/* Allocate memory for Extended Trace Buffer. */</span>
		<span class="n">tc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EFT_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_dma</span><span class="p">,</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c1</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate (%d KB) for EFT.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">EFT_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cont_alloc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EFT_SIZE</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_enable_eft_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tc_dma</span><span class="p">,</span> <span class="n">EFT_NUM_BUFFERS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c2</span><span class="p">,</span>
			    <span class="s">&quot;Unable to initialize EFT (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EFT_SIZE</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span>
			    <span class="n">tc_dma</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cont_alloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c3</span><span class="p">,</span>
		    <span class="s">&quot;Allocated (%d KB) EFT ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">EFT_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

		<span class="n">eft_size</span> <span class="o">=</span> <span class="n">EFT_SIZE</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span> <span class="o">=</span> <span class="n">tc_dma</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span> <span class="o">=</span> <span class="n">tc</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">cont_alloc:</span>
	<span class="n">req_q_size</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">);</span>
	<span class="n">rsp_q_size</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response_t</span><span class="p">);</span>

	<span class="n">dump_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2xxx_fw_dump</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
	<span class="n">dump_size</span> <span class="o">+=</span> <span class="n">fixed_size</span> <span class="o">+</span> <span class="n">mem_size</span> <span class="o">+</span> <span class="n">req_q_size</span> <span class="o">+</span> <span class="n">rsp_q_size</span> <span class="o">+</span> <span class="n">eft_size</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chain_offset</span> <span class="o">=</span> <span class="n">dump_size</span><span class="p">;</span>
	<span class="n">dump_size</span> <span class="o">+=</span> <span class="n">mq_size</span> <span class="o">+</span> <span class="n">fce_size</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">dump_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c4</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate (%d KB) for firmware dump.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dump_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FCE_SIZE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">eft_size</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c5</span><span class="p">,</span>
	    <span class="s">&quot;Allocated (%d KB) for firmware dump.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dump_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_len</span> <span class="o">=</span> <span class="n">dump_size</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;Q&#39;</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;G&#39;</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">__constant_htonl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">fixed_size</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">fixed_size</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">mem_size</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mem_size</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">req_q_size</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">req_q_size</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">rsp_q_size</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">rsp_q_size</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">eft_size</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">eft_size</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">eft_addr_l</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">eft_addr_h</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span><span class="p">));</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">header_size</span> <span class="o">=</span>
	    <span class="n">htonl</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla2xxx_fw_dump</span><span class="p">,</span> <span class="n">isp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla81xx_mpi_sync</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define MPS_MASK	0xe0</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">dc</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_write_ram_word</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x7c00</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0105</span><span class="p">,</span>
		    <span class="s">&quot;Unable to acquire semaphore.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_read_ram_word</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x7a15</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0067</span><span class="p">,</span> <span class="s">&quot;Unable to read sync.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dc</span> <span class="o">&amp;=</span> <span class="n">MPS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dc</span> <span class="o">==</span> <span class="p">(</span><span class="n">dw</span> <span class="o">&amp;</span> <span class="n">MPS_MASK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done_release</span><span class="p">;</span>

	<span class="n">dw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPS_MASK</span><span class="p">;</span>
	<span class="n">dw</span> <span class="o">|=</span> <span class="n">dc</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_write_ram_word</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x7a15</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0114</span><span class="p">,</span> <span class="s">&quot;Unable to gain sync.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done_release:</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_write_ram_word</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x7c00</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x006d</span><span class="p">,</span>
		    <span class="s">&quot;Unable to release semaphore.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_setup_chip() - Load and start RISC firmware.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_setup_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">srisc_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fw_major_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">load_risc</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srisc_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">enable_82xx_npiv</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Disable SRAM, Instruction RAM and GP RAM parity.  */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="p">(</span><span class="n">HCCR_ENABLE_PARITY</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">));</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla81xx_mpi_sync</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Load firmware sequences */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">load_risc</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srisc_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00c9</span><span class="p">,</span>
		    <span class="s">&quot;Verifying Checksum of loaded RISC code.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_verify_checksum</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Start firmware execution. */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ca</span><span class="p">,</span>
			    <span class="s">&quot;Starting firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_execute_fw</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_address</span><span class="p">);</span>
			<span class="cm">/* Retrieve firmware information. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">enable_82xx_npiv:</span>
				<span class="n">fw_major_version</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
					<span class="n">qla82xx_check_md_needed</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_fw_version</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2XXX_MIDTYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					 <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
					    <span class="n">MIN_MULTI_ID_FABRIC</span><span class="p">))</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span> <span class="o">=</span>
						    <span class="n">MIN_MULTI_ID_FABRIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">qla2x00_get_resource_cnts</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_xcb_count</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_major_version</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xallocfwdump</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
					<span class="n">qla2x00_alloc_fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00cd</span><span class="p">,</span>
			    <span class="s">&quot;ISP Firmware failed checksum.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable proper parity. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="cm">/* SRAM parity */</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_ENABLE_PARITY</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* SRAM, Instruction RAM and GP RAM parity */</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_ENABLE_PARITY</span> <span class="o">+</span> <span class="mh">0x7</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_fac_check</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">IS_FAC_REQUIRED</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla81xx_fac_get_sector_size</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fac_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ce</span><span class="p">,</span>
			    <span class="s">&quot;Unsupported FAC firmware (%d.%02d.%02d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">);</span>
<span class="nl">skip_fac_check:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fac_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00cf</span><span class="p">,</span>
		    <span class="s">&quot;Setup chip ****FAILED****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_init_response_q_entries() - Initializes response queue entries.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Beginning of request ring has initialization control block already built</span>
<span class="cm"> * by nvram config routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_init_response_q_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">response_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_index</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pkt</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_update_fw_options() - Read and process firmware options.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_update_fw_options</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">swing</span><span class="p">,</span> <span class="n">emphasis</span><span class="p">,</span> <span class="n">tx_sens</span><span class="p">,</span> <span class="n">rx_sens</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">));</span>
	<span class="n">qla2x00_get_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Serial Link options. */</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0115</span><span class="p">,</span>
	    <span class="s">&quot;Serial link options.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0109</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">));</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FO1_SET_EMPHASIS_SWING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">FO1_SET_EMPHASIS_SWING</span><span class="p">;</span>

		<span class="cm">/*  1G settings */</span>
		<span class="n">swing</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">emphasis</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_4</span> <span class="o">|</span> <span class="n">BIT_3</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">tx_sens</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">rx_sens</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">emphasis</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">swing</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2312</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6312</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_sens</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="n">rx_sens</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tx_sens</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">rx_sens</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_5</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">rx_sens</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">tx_sens</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">));</span>

		<span class="cm">/*  2G settings */</span>
		<span class="n">swing</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">emphasis</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">tx_sens</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">rx_sens</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">emphasis</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">swing</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2312</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6312</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_sens</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="n">rx_sens</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tx_sens</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">rx_sens</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2322</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA6322</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_5</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">rx_sens</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">tx_sens</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* FCP2 options. */</span>
	<span class="cm">/*  Return command IOCBs without waiting for an ABTS to complete. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_13</span><span class="p">;</span>

	<span class="cm">/* LED scheme. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_led_scheme</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_12</span><span class="p">;</span>

	<span class="cm">/* Detect ISP6312. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA6312</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_13</span><span class="p">;</span>

	<span class="cm">/* Update firmware options. */</span>
	<span class="n">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla24xx_update_fw_options</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Update Serial Link options. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options24</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_set_serdes_params</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options24</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options24</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options24</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0104</span><span class="p">,</span>
		    <span class="s">&quot;Unable to update Serial Link options (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_config_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Setup ring parameters in initialization control block. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">request_q_outpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">response_q_inpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">request_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">response_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">request_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">request_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">response_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">response_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_REQ_Q_IN</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_REQ_Q_OUT</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_RSP_Q_IN</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">ISP_RSP_Q_OUT</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">ISP_RSP_Q_OUT</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>		<span class="cm">/* PCI Posting. */</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla24xx_config_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ISP_QUE_REG</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_msix_entry</span> <span class="o">*</span><span class="n">msix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="n">icb</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Setup ring parameters in initialization control block. */</span>
	<span class="n">icb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_outpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_inpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>

	<span class="cm">/* Setup ATIO queue dma pointers for target mode */</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">atio_q_inpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">atio_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_q_length</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">atio_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">atio_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_dma</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mqenable</span> <span class="o">||</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">QLA_DEFAULT_QUE_QOS</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">rid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00fd</span><span class="p">,</span>
			    <span class="s">&quot;Registering vector 0x%x for base que.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">msix</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">msix</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">msix</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Use alternate PCI bus number */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MSB</span><span class="p">(</span><span class="n">rid</span><span class="p">))</span>
			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span>
				<span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_19</span><span class="p">);</span>
		<span class="cm">/* Use alternate PCI devfn */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LSB</span><span class="p">(</span><span class="n">rid</span><span class="p">))</span>
			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span>
				<span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_18</span><span class="p">);</span>

		<span class="cm">/* Use Disable MSIX Handshake mode for capable adapters */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_MSIX_NACK_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">&amp;=</span>
				<span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BIT_22</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_msix_handshake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00fe</span><span class="p">,</span>
			    <span class="s">&quot;MSIX Handshake Disable Mode turned on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span>
				<span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_22</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_23</span><span class="p">);</span>

		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">req_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">rsp_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp25mq</span><span class="p">.</span><span class="n">rsp_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">req_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">rsp_q_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">.</span><span class="n">rsp_q_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qlt_24xx_config_rings</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* PCI posting */</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioreg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_init_rings() - Initializes firmware.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Beginning of request ring has initialization control block already built</span>
<span class="cm"> * by nvram config routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_init_rings</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">que</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mid_init_cb_24xx</span> <span class="o">*</span><span class="n">mid_init_cb</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">mid_init_cb_24xx</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Clear outstanding commands array. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">que</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">que</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">;</span> <span class="n">que</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">current_outstanding_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Initialize firmware. */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span>  <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cnt</span>      <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">que</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">que</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">;</span> <span class="n">que</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Initialize response queue entries */</span>
		<span class="n">qla2x00_init_response_q_entries</span><span class="p">(</span><span class="n">rsp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">atio_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Initialize ATIO queue entries */</span>
	<span class="n">qlt_init_atio_q_entries</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">config_rings</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Update any ISP specific firmware options before initialization. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">update_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d1</span><span class="p">,</span> <span class="s">&quot;Issue init firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">npiv_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">LOOP</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span> <span class="o">=</span> <span class="n">MIN_MULTI_ID_FABRIC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mid_init_cb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mid_init_cb</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">BIT_1</span><span class="p">);</span>
		<span class="n">mid_init_cb</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">.</span><span class="n">execution_throttle</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_xcb_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_init_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d2</span><span class="p">,</span>
		    <span class="s">&quot;Init Firmware **** FAILED ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00d3</span><span class="p">,</span>
		    <span class="s">&quot;Init Firmware -- success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_fw_ready() - Waits for firmware ready.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_fw_ready</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">wtime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">cs84xx_time</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">min_wait</span><span class="p">;</span>	<span class="cm">/* Minimum wait time if loop is down */</span>
	<span class="kt">uint16_t</span>	<span class="n">wait_time</span><span class="p">;</span>	<span class="cm">/* Wait time if loop is coming ready */</span>
	<span class="kt">uint16_t</span>	<span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* 20 seconds for loop down. */</span>
	<span class="n">min_wait</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware should take at most one RATOV to login, plus 5 seconds for</span>
<span class="cm">	 * our own processing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wait_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_time</span> <span class="o">=</span> <span class="n">min_wait</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Min wait time if loop down */</span>
	<span class="n">mtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">min_wait</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="cm">/* wait time before firmware ready */</span>
	<span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">wait_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="cm">/* Wait for ISP to finish LIP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x801e</span><span class="p">,</span>
		    <span class="s">&quot;Waiting for LIP to complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_firmware_state</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">FSTATE_LOSS_OF_SYNC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DFLG_NO_CABLE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA84XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FSTATE_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x801f</span><span class="p">,</span>
				    <span class="s">&quot;fw_state=%x 84xx=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSTATE_LOGGED_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				     <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSTATE_WAITING_FOR_VERIFY</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8028</span><span class="p">,</span>
					    <span class="s">&quot;Sending verify iocb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="n">cs84xx_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">qla84xx_init_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span>
						    <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8007</span><span class="p">,</span>
						    <span class="s">&quot;Init chip failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="cm">/* Add time taken to initialize. */</span>
					<span class="n">cs84xx_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">cs84xx_time</span><span class="p">;</span>
					<span class="n">wtime</span> <span class="o">+=</span> <span class="n">cs84xx_time</span><span class="p">;</span>
					<span class="n">mtime</span> <span class="o">+=</span> <span class="n">cs84xx_time</span><span class="p">;</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8008</span><span class="p">,</span>
					    <span class="s">&quot;Increasing wait time by %ld. &quot;</span>
					    <span class="s">&quot;New time %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs84xx_time</span><span class="p">,</span>
					    <span class="n">wtime</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">FSTATE_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8037</span><span class="p">,</span>
				    <span class="s">&quot;F/W Ready - OK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">qla2x00_get_retry_cnt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">);</span>

				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FSTATE_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Loop down. Timeout on min_wait for states</span>
<span class="cm">				 * other than Wait for Login.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8038</span><span class="p">,</span>
					    <span class="s">&quot;Cable is unplugged...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">DFLG_NO_CABLE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Mailbox cmd failed. Timeout on min_wait. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wtime</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Delay for a while */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x803a</span><span class="p">,</span>
	    <span class="s">&quot;fw_state=%x (%x, %x, %x, %x) &quot;</span> <span class="s">&quot;curr time=%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_NO_CABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x803b</span><span class="p">,</span>
		    <span class="s">&quot;Firmware ready **** FAILED ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  qla2x00_configure_hba</span>
<span class="cm">*      Setup adapter context.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha = adapter state pointer.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0 = success</span>
<span class="cm">*</span>
<span class="cm">* Context:</span>
<span class="cm">*      Kernel context.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_configure_hba</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>       <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span>      <span class="n">loop_id</span><span class="p">;</span>
	<span class="kt">uint16_t</span>      <span class="n">topo</span><span class="p">;</span>
	<span class="kt">uint16_t</span>      <span class="n">sw_cap</span><span class="p">;</span>
	<span class="kt">uint8_t</span>       <span class="n">al_pa</span><span class="p">;</span>
	<span class="kt">uint8_t</span>       <span class="n">area</span><span class="p">;</span>
	<span class="kt">uint8_t</span>       <span class="n">domain</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">connect_type</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Get host addresses. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_adapter_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">loop_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al_pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">area</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">topo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOOP_TRANSITION</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_COMMAND_ERROR</span> <span class="o">&amp;&amp;</span> <span class="n">loop_id</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2008</span><span class="p">,</span>
			    <span class="s">&quot;Loop is in a transition state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2009</span><span class="p">,</span>
			    <span class="s">&quot;Unable to get host loop ID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">topo</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x200a</span><span class="p">,</span>
		    <span class="s">&quot;Cannot get topology - retrying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_FUNCTION_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>

	<span class="cm">/* initialize */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">min_external_loopid</span> <span class="o">=</span> <span class="n">SNS_FIRST_LOOP_ID</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">LOOP</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">switch_cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">topo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x200b</span><span class="p">,</span> <span class="s">&quot;HBA in NL topology.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">=</span> <span class="n">ISP_CFG_NL</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">connect_type</span><span class="p">,</span> <span class="s">&quot;(Loop)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x200c</span><span class="p">,</span> <span class="s">&quot;HBA in FL topology.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">switch_cap</span> <span class="o">=</span> <span class="n">sw_cap</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">=</span> <span class="n">ISP_CFG_FL</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">connect_type</span><span class="p">,</span> <span class="s">&quot;(FL_Port)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x200d</span><span class="p">,</span> <span class="s">&quot;HBA in N P2P topology.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">P2P</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">=</span> <span class="n">ISP_CFG_N</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">connect_type</span><span class="p">,</span> <span class="s">&quot;(N_Port-to-N_Port)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x200e</span><span class="p">,</span> <span class="s">&quot;HBA in F P2P topology.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">switch_cap</span> <span class="o">=</span> <span class="n">sw_cap</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">P2P</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">=</span> <span class="n">ISP_CFG_F</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">connect_type</span><span class="p">,</span> <span class="s">&quot;(F_Port)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x200f</span><span class="p">,</span>
		    <span class="s">&quot;HBA in unknown topology %x, using NL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">topo</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">=</span> <span class="n">ISP_CFG_NL</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">connect_type</span><span class="p">,</span> <span class="s">&quot;(Loop)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save Host port and loop ID. */</span>
	<span class="cm">/* byte order - Big Endian */</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">al_pa</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">);</span>
	<span class="n">qlt_update_vp_map</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">SET_AL_PA</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2010</span><span class="p">,</span>
		    <span class="s">&quot;Topology - %s, Host Loop address 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">connect_type</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2011</span><span class="p">,</span>
		    <span class="s">&quot;%s FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2012</span><span class="p">,</span>
		    <span class="s">&quot;%s success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla2x00_set_model_info</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">en</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_tbl</span> <span class="o">=</span> <span class="o">!</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">BINZERO</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">en</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">;</span>
		<span class="n">en</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">en</span> <span class="o">&gt;</span> <span class="n">st</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">en</span> <span class="o">!=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">en</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">*</span><span class="n">en</span><span class="o">--</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_tbl</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span> <span class="o">&amp;&amp;</span>
		    <span class="n">index</span> <span class="o">&lt;</span> <span class="n">QLA_MODEL_NAMES</span><span class="p">)</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">,</span>
			    <span class="n">qla2x00_model_name</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_tbl</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span> <span class="o">&amp;&amp;</span>
		    <span class="n">index</span> <span class="o">&lt;</span> <span class="n">QLA_MODEL_NAMES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span>
			    <span class="n">qla2x00_model_name</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]);</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">,</span>
			    <span class="n">qla2x00_model_name</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="n">def</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">qla2xxx_get_vpd_field</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x82</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* On sparc systems, obtain port and node WWN from firmware</span>
<span class="cm"> * properties.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla2xxx_nvram_wwn_from_ofw</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">nvram_t</span> <span class="o">*</span><span class="n">nv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;port-wwn&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">WWN_SIZE</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;node-wwn&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">WWN_SIZE</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* NVRAM configuration for ISP 2xxx</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha                = adapter block pointer.</span>
<span class="cm">*</span>
<span class="cm">* Output:</span>
<span class="cm">*      initialization control block in response_ring</span>
<span class="cm">*      host adapters parameters in host adapter block</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0 = success.</span>
<span class="cm">*/</span>
<span class="kt">int</span>
<span class="nf">qla2x00_nvram_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint8_t</span>         <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span>        <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint8_t</span>         <span class="o">*</span><span class="n">dptr1</span><span class="p">,</span> <span class="o">*</span><span class="n">dptr2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">init_cb_t</span>       <span class="o">*</span><span class="n">icb</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>
	<span class="n">nvram_t</span>         <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="kt">uint8_t</span>         <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Determine NVRAM starting address. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nvram_t</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/* Get NVRAM data and calculate checksum. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x010f</span><span class="p">,</span>
	    <span class="s">&quot;Contents of NVRAM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0110</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">nv</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>

	<span class="cm">/* Bad NVRAM data, set defaults parameters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span> <span class="o">||</span>
	    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset NVRAM data. */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent NVRAM &quot;</span>
		    <span class="s">&quot;detected: checksum=0x%x id=%c version=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">chksum</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0065</span><span class="p">,</span>
		    <span class="s">&quot;Falling back to &quot;</span>
		    <span class="s">&quot;functioning (yet invalid -- WWPN) defaults.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set default initialization control block.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">parameter_block_version</span> <span class="o">=</span> <span class="n">ICB_VERSION</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_5</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_5</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">special_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_7</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_5</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_5</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_1</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_5</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">max_iocb_allocation</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">139</span><span class="p">;</span>

		<span class="n">qla2xxx_nvram_wwn_from_ofw</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">nv</span><span class="p">);</span>

		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set default host adapter parameters</span>
<span class="cm">		 */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_2</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">reset_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">max_luns_per_target</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)</span>
	<span class="cm">/*</span>
<span class="cm">	 * The SN2 does not provide BIOS emulation which means you can&#39;t change</span>
<span class="cm">	 * potentially bogus BIOS settings. Force the use of default settings</span>
<span class="cm">	 * for link rate and frame size.  Hope that the rest of the settings</span>
<span class="cm">	 * are valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_platform_is</span><span class="p">(</span><span class="s">&quot;sn2&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">special_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_7</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Reset Initialization control block */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">icb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup driver NVRAM options.</span>
<span class="cm">	 */</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_1</span><span class="p">);</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">);</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_2</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_3</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">special_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_6</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2300</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fb_rev</span> <span class="o">==</span> <span class="n">FPM_2310</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="s">&quot;QLA2310&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="s">&quot;QLA2300&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qla2x00_set_model_info</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">),</span> <span class="s">&quot;QLA23xx&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_2</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * &#39;Point-to-point preferred, else loop&#39; is not a safe</span>
<span class="cm">		 * connection mode setting.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Force &#39;loop preferred, else point-to-point&#39;. */</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">);</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="s">&quot;QLA22xx&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/*if (IS_QLA2100(ha))*/</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span> <span class="s">&quot;QLA2100&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy over NVRAM RISC parameter block to initialization control block.</span>
<span class="cm">	 */</span>
	<span class="n">dptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">icb</span><span class="p">;</span>
	<span class="n">dptr2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">parameter_block_version</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_outpointer</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dptr1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">dptr2</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Copy 2nd half. */</span>
	<span class="n">dptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">reserved_3</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dptr1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">dptr2</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Use alternate WWN? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">alternate_node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">alternate_port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare nodename */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Firmware will apply the following mask if the nodename was</span>
<span class="cm">		 * not provided.</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set host adapter parameters.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * BIT_7 in the host-parameters section allows for modification to</span>
<span class="cm">	 * internal driver logging.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
		<span class="n">ql2xextended_error_logging</span> <span class="o">=</span> <span class="n">QL_DBG_DEFAULT1_MASK</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_risc_code_load</span> <span class="o">=</span> <span class="p">((</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Always load RISC code on non ISP2[12]00 chips. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_risc_code_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_reset</span> <span class="o">=</span> <span class="p">((</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_full_login</span> <span class="o">=</span> <span class="p">((</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_target_reset</span> <span class="o">=</span> <span class="p">((</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_led_scheme</span> <span class="o">=</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">special_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_serdes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">seriallink_options</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options</span><span class="p">));</span>

	<span class="cm">/* save HBA serial number */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial0</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial1</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial2</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="p">;</span>

	<span class="cm">/* Set minimum login_timeout to 4 seconds. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">!=</span> <span class="n">ql2xlogintimeout</span><span class="p">)</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">ql2xlogintimeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">;</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">;</span>

	<span class="cm">/* Set minimum RATOV to 100 tenths of a second. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">reset_delay</span><span class="p">;</span>

	<span class="cm">/* Link Down Timeout = 0:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 	When Port Down timer expires we will start returning</span>
<span class="cm">	 *	I/O&#39;s to OS with &quot;DID_NO_CONNECT&quot;.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Link Down Timeout != 0:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	 The driver waits for the link to come up after link down</span>
<span class="cm">	 *	 before returning I/Os to OS with &quot;DID_NO_CONNECT&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">LOOP_DOWN_TIME</span> <span class="o">-</span> <span class="n">LOOP_DOWN_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">=</span>	 <span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">LOOP_DOWN_TIME</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need enough time to try and get the port back.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlport_down_retry</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">qlport_down_retry</span><span class="p">;</span>
	<span class="cm">/* Set login_retry_count */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span>  <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">==</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xloginretrycount</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ql2xloginretrycount</span><span class="p">;</span>

	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">lun_enables</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">command_resource_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">immediate_notify_resource_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable RIO */</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_3</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_2</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_accumulation_timer</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enable ZIO. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">?</span>
			    <span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">!=</span> <span class="n">QLA_ZIO_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">QLA_ZIO_MODE_6</span><span class="p">;</span>

			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span>
			    <span class="s">&quot;ZIO mode %d enabled; timer delay (%d us).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">add_firmware_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">;</span>
			<span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span>
		    <span class="s">&quot;NVRAM configuration failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_rport_del</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">drport</span> <span class="o">?</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">drport</span><span class="o">:</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">drport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_remote_port_delete</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Release the target mode FC NEXUS in qla_target.c code</span>
<span class="cm">		 * if target mod is enabled.</span>
<span class="cm">		 */</span>
		<span class="n">qlt_fc_port_deleted</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_alloc_fcport() - Allocate a generic fcport.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @flags: allocation flags</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the allocated fcport, or NULL, if none available.</span>
<span class="cm"> */</span>
<span class="n">fc_port_t</span> <span class="o">*</span>
<span class="nf">qla2x00_alloc_fcport</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>

	<span class="n">fcport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fc_port_t</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Setup fcport template structure. */</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_UNKNOWN</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">;</span>
	<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_UNCONFIGURED</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="n">FC_COS_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">scan_state</span> <span class="o">=</span> <span class="n">QLA_FCPORT_SCAN_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_configure_loop</span>
<span class="cm"> *      Updates Fibre Channel Device Database with what is actually on loop.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha                = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success.</span>
<span class="cm"> *      1 = error.</span>
<span class="cm"> *      2 = database was full and device was not configured.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_configure_loop</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">rval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">save_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Get Initiator ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_configure_hba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2013</span><span class="p">,</span>
			    <span class="s">&quot;Unable to configure HBA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">save_flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2014</span><span class="p">,</span>
	    <span class="s">&quot;Configure loop -- dpc flags = 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have both an RSCN and PORT UPDATE pending then handle them</span>
<span class="cm">	 * both at the same time.</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="n">qla2x00_get_data_rate</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Determine what we need to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">==</span> <span class="n">ISP_CFG_FL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">==</span> <span class="n">ISP_CFG_F</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">==</span> <span class="n">ISP_CFG_N</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2015</span><span class="p">,</span>
			    <span class="s">&quot;Loop resync needed, failing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_configure_local_loop</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LOOP_TRANSITION</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x201e</span><span class="p">,</span>
			    <span class="s">&quot;Needs RSCN update and loop transition.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_configure_fabric</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_READY</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2069</span><span class="p">,</span>
			    <span class="s">&quot;LOOP READY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x206a</span><span class="p">,</span>
		    <span class="s">&quot;%s *** FAILED ***.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x206b</span><span class="p">,</span>
		    <span class="s">&quot;%s: exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Restore state if a resync event occurred during processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RSCN_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * qla2x00_configure_local_loop</span>
<span class="cm"> *	Updates Fibre Channel Device Database with local loop devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0 = success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_configure_local_loop</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">,</span> <span class="n">rval2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">found_devs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">found</span><span class="p">;</span>
	<span class="n">fc_port_t</span>	<span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="o">*</span><span class="n">new_fcport</span><span class="p">;</span>

	<span class="kt">uint16_t</span>	<span class="n">index</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">entries</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">id_iter</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">loop_id</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">domain</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">al_pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">found_devs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_fcport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">MAX_FIBRE_DEVICES_LOOP</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2016</span><span class="p">,</span>
	    <span class="s">&quot;Getting FCAL position map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xextended_error_logging</span> <span class="o">&amp;</span> <span class="n">ql_dbg_disc</span><span class="p">)</span>
		<span class="n">qla2x00_get_fcal_position_map</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Get list of logged in devices. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qla2x00_gid_list_size</span><span class="p">(</span><span class="n">ha</span><span class="p">));</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_id_list</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_dma</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_allocation</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2017</span><span class="p">,</span>
	    <span class="s">&quot;Entries in ID list (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2075</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">,</span>
	    <span class="n">entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gid_list_info</span><span class="p">));</span>

	<span class="cm">/* Allocate temporary fcport for any new fcports discovered. */</span>
	<span class="n">new_fcport</span> <span class="o">=</span> <span class="n">qla2x00_alloc_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2018</span><span class="p">,</span>
		    <span class="s">&quot;Memory allocation failed for fcport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup_allocation</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_FABRIC_DEVICE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark local devices that were present with FCF_DEVICE_LOST for now.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_ONLINE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_BROADCAST</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FABRIC_DEVICE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2019</span><span class="p">,</span>
			    <span class="s">&quot;Marking port lost loop_id=0x%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>

			<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_DEVICE_LOST</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Add devices to port list. */</span>
	<span class="n">id_iter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="p">)</span><span class="n">id_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">area</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="p">)</span><span class="n">id_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
		<span class="n">al_pa</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="p">)</span><span class="n">id_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">al_pa</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">loop_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span>
			    <span class="p">((</span><span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="p">)</span><span class="n">id_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">loop_id_2100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">loop_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span>
			    <span class="p">((</span><span class="k">struct</span> <span class="n">gid_list_info</span> <span class="o">*</span><span class="p">)</span><span class="n">id_iter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
		<span class="n">id_iter</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gid_list_info_size</span><span class="p">;</span>

		<span class="cm">/* Bypass reserved domain fields. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">domain</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Bypass if not same domain and area of adapter. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="o">&amp;&amp;</span> <span class="n">domain</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">area</span> <span class="o">!=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">||</span> <span class="n">domain</span> <span class="o">!=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Bypass invalid local loop ID. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loop_id</span> <span class="o">&gt;</span> <span class="n">LAST_LOCAL_LOOP_ID</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Fill in member data. */</span>
		<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
		<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">;</span>
		<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">al_pa</span><span class="p">;</span>
		<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">loop_id</span><span class="p">;</span>
		<span class="n">rval2</span> <span class="o">=</span> <span class="n">qla2x00_get_port_database</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">new_fcport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval2</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x201a</span><span class="p">,</span>
			    <span class="s">&quot;Failed to retrieve fcport information &quot;</span>
			    <span class="s">&quot;-- get_port_database=%x, loop_id=0x%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">rval2</span><span class="p">,</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x201b</span><span class="p">,</span>
			    <span class="s">&quot;Scheduling resync.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check for matching device in port list. */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fcport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span>
			    <span class="n">WWN_SIZE</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_FABRIC_DEVICE</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span>
			    <span class="n">WWN_SIZE</span><span class="p">);</span>

			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* New device, add to fcports list. */</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">);</span>

			<span class="cm">/* Allocate a new replacement fcport. */</span>
			<span class="n">fcport</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="p">;</span>
			<span class="n">new_fcport</span> <span class="o">=</span> <span class="n">qla2x00_alloc_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x201c</span><span class="p">,</span>
				    <span class="s">&quot;Failed to allocate memory for fcport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup_allocation</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_FABRIC_DEVICE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Base iIDMA settings on HBA port speed. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span><span class="p">;</span>

		<span class="n">qla2x00_update_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>

		<span class="n">found_devs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">cleanup_allocation:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_fcport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x201d</span><span class="p">,</span>
		    <span class="s">&quot;Configure local loop error exit: rval=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_iidma_fcport</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">link_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IIDMA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FCS_ONLINE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span> <span class="o">==</span> <span class="n">PORT_SPEED_UNKNOWN</span> <span class="o">||</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_set_idma_speed</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span><span class="p">,</span>
	    <span class="n">mb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2004</span><span class="p">,</span>
		    <span class="s">&quot;Unable to adjust iIDMA &quot;</span>
		    <span class="s">&quot;%02x%02x%02x%02x%02x%02x%02x%02x -- %04x %x %04x &quot;</span>
		    <span class="s">&quot;%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">rval</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">link_speed</span> <span class="o">=</span> <span class="n">qla2x00_get_link_speed_str</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2005</span><span class="p">,</span>
		    <span class="s">&quot;iIDMA adjusted to %s GB/s &quot;</span>
		    <span class="s">&quot;on %02x%02x%02x%02x%02x%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link_speed</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_reg_remote_port</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_identifiers</span> <span class="n">rport_ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">qla2x00_rport_del</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>

	<span class="n">rport_ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>
	<span class="n">rport_ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="n">rport_ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">rport_ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport</span> <span class="o">=</span> <span class="n">fc_remote_port_add</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport_ids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2006</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate fc remote port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Create target mode FC NEXUS in qla_target.c if target mode is</span>
<span class="cm">	 * enabled..</span>
<span class="cm">	 */</span>
	<span class="n">qlt_fc_port_added</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">fc_port_t</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">)</span> <span class="o">=</span> <span class="n">fcport</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span><span class="p">;</span>

	<span class="n">rport_ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FCT_INITIATOR</span><span class="p">)</span>
		<span class="n">rport_ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_INITIATOR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">FCT_TARGET</span><span class="p">)</span>
		<span class="n">rport_ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_TARGET</span><span class="p">;</span>
	<span class="n">fc_remote_port_rolechg</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">rport_ids</span><span class="p">.</span><span class="n">roles</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_update_fcport</span>
<span class="cm"> *	Updates device on list.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	fcport = port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	0  - Success</span>
<span class="cm"> *  BIT_0 - error</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_update_fcport</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span> <span class="o">=</span> <span class="n">vha</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FCF_LOGIN_NEEDED</span> <span class="o">|</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">);</span>

	<span class="n">qla2x00_iidma_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="n">qla24xx_update_fcport_fcp_prio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="n">qla2x00_reg_remote_port</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_configure_fabric</span>
<span class="cm"> *      Setup SNS devices with loop ID&#39;s.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success.</span>
<span class="cm"> *      BIT_0 = error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_configure_fabric</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="n">fc_port_t</span>	<span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">next_loopid</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">uint16_t</span>	<span class="n">loop_id</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">new_fcports</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* If FL port exists, then SNS is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">loop_id</span> <span class="o">=</span> <span class="n">NPH_F_PORT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">loop_id</span> <span class="o">=</span> <span class="n">SNS_FL_PORT</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_port_name</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fabric_node_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x201f</span><span class="p">,</span>
		    <span class="s">&quot;MBX_GET_PORT_NAME failed, No FL Port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SWITCH_FOUND</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_SUCCESS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">SWITCH_FOUND</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* FDMI support. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql2xfdmienable</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">REGISTER_FDMI_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
			<span class="n">qla2x00_fdmi_register</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

		<span class="cm">/* Ensure we are logged into the SNS. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">loop_id</span> <span class="o">=</span> <span class="n">NPH_SNS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">loop_id</span> <span class="o">=</span> <span class="n">SIMPLE_NAME_SERVER</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		    <span class="mh">0xfc</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">BIT_1</span><span class="o">|</span><span class="n">BIT_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2042</span><span class="p">,</span>
			    <span class="s">&quot;Failed SNS login: loop_id=%x mb[0]=%x mb[1]=%x mb[2]=%x &quot;</span>
			    <span class="s">&quot;mb[6]=%x mb[7]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">QLA_SUCCESS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">REGISTER_FC4_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_rft_id</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* EMPTY */</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2045</span><span class="p">,</span>
				    <span class="s">&quot;Register FC-4 TYPE failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_rff_id</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* EMPTY */</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2049</span><span class="p">,</span>
				    <span class="s">&quot;Register FC-4 Features failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_rnn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* EMPTY */</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x204f</span><span class="p">,</span>
				    <span class="s">&quot;Register Node Name failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_rsnn_nn</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* EMPTY */</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2053</span><span class="p">,</span>
				    <span class="s">&quot;Register Symobilic Node Name failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_find_all_fabric_devs</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_fcports</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Add new ports to existing port list */</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_fcports</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">);</span>

		<span class="cm">/* Starting free loop ID. */</span>
		<span class="n">next_loopid</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">min_external_loopid</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FABRIC_DEVICE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Logout lost/gone fabric devices (non-FCP2) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">scan_state</span> <span class="o">!=</span> <span class="n">QLA_FCPORT_SCAN_FOUND</span> <span class="o">&amp;&amp;</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_ONLINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span>
				    <span class="n">ql2xplogiabsentdevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">!=</span> <span class="n">FC_NO_LOOP_ID</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_INITIATOR</span> <span class="o">&amp;&amp;</span>
				    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
					    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
					    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
					    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
					    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">scan_state</span> <span class="o">=</span> <span class="n">QLA_FCPORT_SCAN_NONE</span><span class="p">;</span>

			<span class="cm">/* Login fabric devices that need a login */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_LOGIN_NEEDED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">next_loopid</span><span class="p">;</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_find_new_loop_id</span><span class="p">(</span>
					    <span class="n">base_vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Ran out of IDs to use */</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Login and update database */</span>
			<span class="n">qla2x00_fabric_dev_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_loopid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2068</span><span class="p">,</span>
		    <span class="s">&quot;Configure fabric error exit rval=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_find_all_fabric_devs</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	dev = database device entry pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0 = success.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_find_all_fabric_devs</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">new_fcports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">loop_id</span><span class="p">;</span>
	<span class="n">fc_port_t</span>	<span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="o">*</span><span class="n">new_fcport</span><span class="p">,</span> <span class="o">*</span><span class="n">fcptemp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">found</span><span class="p">;</span>

	<span class="n">sw_info_t</span>	<span class="o">*</span><span class="n">swl</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">swl_idx</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">first_dev</span><span class="p">,</span> <span class="n">last_dev</span><span class="p">;</span>
	<span class="n">port_id_t</span>	<span class="n">wrap</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">nxt_d_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">tvp</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Try GID_PT to get device list, else GAN. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">swl</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">swl</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sw_info_t</span><span class="p">),</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">swl</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">swl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2054</span><span class="p">,</span>
		    <span class="s">&quot;GID_PT allocations failed, fallback on GA_NXT.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">swl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sw_info_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_gid_pt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">swl</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_gpn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">swl</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_gnn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">swl</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ql2xiidmaenable</span> <span class="o">&amp;&amp;</span>
		    <span class="n">qla2x00_gfpn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">swl</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla2x00_gpsc</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">swl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If other queries succeeded probe for FC-4 type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">swl</span><span class="p">)</span>
			<span class="n">qla2x00_gff_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">swl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">swl_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate temporary fcport for any new fcports discovered. */</span>
	<span class="n">new_fcport</span> <span class="o">=</span> <span class="n">qla2x00_alloc_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x205e</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for fcport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FCF_FABRIC_DEVICE</span> <span class="o">|</span> <span class="n">FCF_LOGIN_NEEDED</span><span class="p">);</span>
	<span class="cm">/* Set start port ID scan at adapter ID. */</span>
	<span class="n">first_dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">last_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Starting free loop ID. */</span>
	<span class="n">loop_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">min_external_loopid</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">loop_id</span> <span class="o">&lt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span><span class="p">;</span> <span class="n">loop_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_is_reserved_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">loop_id</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">==</span> <span class="n">ISP_CFG_FL</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">LOOP_TRANSITION</span><span class="p">(</span><span class="n">vha</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">swl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wrap</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span>
				    <span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span>
				    <span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fabric_port_name</span><span class="p">,</span>
				    <span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
				<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">fp_speed</span><span class="p">;</span>
				<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fc4_type</span> <span class="o">=</span> <span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">fc4_type</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">swl</span><span class="p">[</span><span class="n">swl_idx</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">last_dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">swl_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Send GA_NXT to the switch */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_ga_nxt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">new_fcport</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2064</span><span class="p">,</span>
				    <span class="s">&quot;SNS scan failed -- assuming &quot;</span>
				    <span class="s">&quot;zero-entry result.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">fcptemp</span><span class="p">,</span>
				    <span class="n">new_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If wrap on switch device list, exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wrap</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
			<span class="n">first_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">==</span> <span class="n">wrap</span><span class="p">.</span><span class="n">b24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2065</span><span class="p">,</span>
			    <span class="s">&quot;Device wrap (%02x%02x%02x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Bypass if same physical adapter. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">==</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Bypass virtual ports of the same host. */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_vhosts</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">tvp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">==</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Bypass if same domain and area of adapter. */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">&amp;</span> <span class="mh">0xffff00</span><span class="p">)</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">&amp;</span> <span class="mh">0xffff00</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span> <span class="o">==</span>
			<span class="n">ISP_CFG_FL</span><span class="p">)</span>
			    <span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Bypass reserved domain fields. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Bypass ports whose FCP-4 type is not FCP_SCSI */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql2xgffidenable</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fc4_type</span> <span class="o">!=</span> <span class="n">FC4_TYPE_FCP_SCSI</span> <span class="o">&amp;&amp;</span>
		    <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fc4_type</span> <span class="o">!=</span> <span class="n">FC4_TYPE_UNKNOWN</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Locate matching device in database. */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span>
			    <span class="n">WWN_SIZE</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">scan_state</span> <span class="o">=</span> <span class="n">QLA_FCPORT_SCAN_FOUND</span><span class="p">;</span>

			<span class="n">found</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Update port state. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fabric_port_name</span><span class="p">,</span>
			    <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fabric_port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">fp_speed</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If address the same and state FCS_ONLINE, nothing</span>
<span class="cm">			 * changed.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">==</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">&amp;&amp;</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">FCS_ONLINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * If device was not a fabric device before.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FABRIC_DEVICE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">;</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FCF_FABRIC_DEVICE</span> <span class="o">|</span>
				    <span class="n">FCF_LOGIN_NEEDED</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Port ID changed or device was marked to be updated;</span>
<span class="cm">			 * Log it out if still logged in and mark it for</span>
<span class="cm">			 * relogin later.</span>
<span class="cm">			 */</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_LOGIN_NEEDED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">!=</span> <span class="n">FC_NO_LOOP_ID</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_INITIATOR</span> <span class="o">&amp;&amp;</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
				    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
				    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* If device was not in our fcports list, then add it. */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">new_fcports</span><span class="p">);</span>

		<span class="cm">/* Allocate a new replacement fcport. */</span>
		<span class="n">nxt_d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
		<span class="n">new_fcport</span> <span class="o">=</span> <span class="n">qla2x00_alloc_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_fcport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2066</span><span class="p">,</span>
			    <span class="s">&quot;Memory allocation failed for fcport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FCF_FABRIC_DEVICE</span> <span class="o">|</span> <span class="n">FCF_LOGIN_NEEDED</span><span class="p">);</span>
		<span class="n">new_fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">=</span> <span class="n">nxt_d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">new_fcport</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_find_new_loop_id</span>
<span class="cm"> *	Scan through our port list and find a new usable loop ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha:	adapter state pointer.</span>
<span class="cm"> *	dev:	port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_find_new_loop_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">found</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">first_loop_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">tvp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Save starting loop ID. */</span>
	<span class="n">first_loop_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Skip loop ID if already used by adapter. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Skip reserved loop IDs. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">qla2x00_is_reserved_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Reset loop ID if passed the end. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_loop_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* first loop ID. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">min_external_loopid</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check for loop ID being already in use. */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fcport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">tvp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">&amp;&amp;</span>
								<span class="n">fcport</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* ID possibly in use */</span>
					<span class="n">found</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* If not in use then it is free to use. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="mh">0x2086</span><span class="p">,</span>
			    <span class="s">&quot;Assigning new loopid=%x, portid=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* ID in use. Try next value. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* If wrap around. No free ID to use. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">first_loop_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_fabric_dev_login</span>
<span class="cm"> *	Login fabric target device and update FC port database.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha:		adapter state pointer.</span>
<span class="cm"> *	fcport:		port structure list pointer.</span>
<span class="cm"> *	next_loopid:	contains value of a new loop ID that can be used</span>
<span class="cm"> *			by the next login attempt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	qla2x00 local function return status code.</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_fabric_dev_login</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">next_loopid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">retry</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">opts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ALOGIO_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_post_async_login_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FCF_ASYNC_SENT</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fabric_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">next_loopid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send an ADISC to FCP2 devices.*/</span>
		<span class="n">opts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">)</span>
			<span class="n">opts</span> <span class="o">|=</span> <span class="n">BIT_1</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_port_database</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
			<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qla2x00_update_fcport</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Retry Login. */</span>
		<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_fabric_login</span>
<span class="cm"> *	Issue fabric login command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	device = pointer to FC device type structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 - Login successfully</span>
<span class="cm"> *      1 - Login failed</span>
<span class="cm"> *      2 - Initiator device</span>
<span class="cm"> *      3 - Fatal error</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_fabric_login</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">next_loopid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">retry</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tmp_loopid</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp_loopid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span>
		    <span class="s">&quot;Trying Fabric Login w/loop id 0x%04x for port &quot;</span>
		    <span class="s">&quot;%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>

		<span class="cm">/* Login fcport on switch. */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_PORT_ID_USED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Device has another loop ID.  The firmware team</span>
<span class="cm">			 * recommends the driver perform an implicit login with</span>
<span class="cm">			 * the specified ID again. The ID we just used is save</span>
<span class="cm">			 * here so we return with an ID that can be tried by</span>
<span class="cm">			 * the next login.</span>
<span class="cm">			 */</span>
			<span class="n">retry</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tmp_loopid</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2001</span><span class="p">,</span>
			    <span class="s">&quot;Fabric Login: port in use - next loop &quot;</span>
			    <span class="s">&quot;id=0x%04x, port id= %02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Login succeeded.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* A retry occurred before. */</span>
				<span class="o">*</span><span class="n">next_loopid</span> <span class="o">=</span> <span class="n">tmp_loopid</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * No retry occurred before. Just increment the</span>
<span class="cm">				 * ID value for next login.</span>
<span class="cm">				 */</span>
				<span class="o">*</span><span class="n">next_loopid</span> <span class="o">=</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_INITIATOR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">FCT_TARGET</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FCF_FCP2_DEVICE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
					    <span class="n">FCF_CONF_COMP_SUPPORTED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_LOOP_ID_USED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Loop ID already used, try next loop ID.</span>
<span class="cm">			 */</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_find_new_loop_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Ran out of loop IDs to use */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Firmware possibly timed out during login. If NO</span>
<span class="cm">			 * retries are left to do then the device is declared</span>
<span class="cm">			 * dead.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">next_loopid</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
			<span class="n">qla2x00_mark_device_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * unrecoverable / not handled error</span>
<span class="cm">			 */</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">,</span>
			    <span class="s">&quot;Failed=%x port_id=%02x%02x%02x loop_id=%x &quot;</span>
			    <span class="s">&quot;jiffies=%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

			<span class="o">*</span><span class="n">next_loopid</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">=</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">login_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_local_device_login</span>
<span class="cm"> *	Issue local device login command.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *	loop_id = loop id of device to login to.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns (Where&#39;s the #define!!!!):</span>
<span class="cm"> *      0 - Login successfully</span>
<span class="cm"> *      1 - Login failed</span>
<span class="cm"> *      3 - Fatal error</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_local_device_login</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mb</span><span class="p">));</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_login_local_device</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">BIT_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Interrogate mailbox registers for any errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_ERROR</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBS_COMMAND_PARAMETER_ERROR</span><span class="p">)</span>
			<span class="cm">/* device not in PCB table */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  qla2x00_loop_resync</span>
<span class="cm"> *      Resync with fibre channel devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_loop_resync</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">wait_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">)</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fw_ready</span><span class="p">(</span><span class="n">vha</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Wait at most MAX_TARGET RSCNs for a stable link. */</span>
			<span class="n">wait_time</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="cm">/* Issue a marker after FW becomes ready. */</span>
				<span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">MK_SYNC_ALL</span><span class="p">);</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* Remap devices on Loop. */</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

				<span class="n">qla2x00_configure_loop</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="n">wait_time</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="n">wait_time</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_FUNCTION_FAILED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x206c</span><span class="p">,</span>
		    <span class="s">&quot;%s *** FAILED ***.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_perform_loop_resync</span>
<span class="cm">* Description: This function will set the appropriate flags and call</span>
<span class="cm">*              qla2x00_loop_resync. If successful loop will be resynced</span>
<span class="cm">* Arguments : scsi_qla_host_t pointer</span>
<span class="cm">* returm    : Success or Failure</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">qla2x00_perform_loop_resync</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int32_t</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Configure the flags so that resync happens properly*/</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_NO_CABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_UP</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FC4_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_loop_resync</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DEAD</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_update_fcports</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Go with deferred removal of rport references. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">drport</span> <span class="o">&amp;&amp;</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FCS_UNCONFIGURED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

				<span class="n">qla2x00_rport_del</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla82xx_quiescent_state_cleanup</span>
<span class="cm">* Description: This function will block the new I/Os</span>
<span class="cm">*              Its not aborting any I/Os as context</span>
<span class="cm">*              is not destroyed during quiescence</span>
<span class="cm">* Arguments: scsi_qla_host_t</span>
<span class="cm">* return   : void</span>
<span class="cm">*/</span>
<span class="kt">void</span>
<span class="nf">qla82xx_quiescent_state_cleanup</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb002</span><span class="p">,</span>
	    <span class="s">&quot;Performing ISP error recovery - ha=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
		<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span>
					<span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Wait for pending cmds to complete */</span>
	<span class="n">qla2x00_eh_wait_for_pending_commands</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WAIT_HOST</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_abort_isp_cleanup</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>

	<span class="cm">/* For ISP82XX, driver waits for completion of the commands.</span>
<span class="cm">	 * online flag should be set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">total_isp_aborts</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00af</span><span class="p">,</span>
	    <span class="s">&quot;Performing ISP error recovery - ha=%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* For ISP82XX, reset_chip is just disabling interrupts.</span>
<span class="cm">	 * Driver waits for the completion of the commands.</span>
<span class="cm">	 * the interrupts need to be enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
		<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span>
			    <span class="n">LOOP_DOWN_TIME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear all async request states across all VPs. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FCF_LOGIN_NEEDED</span> <span class="o">|</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FCF_LOGIN_NEEDED</span> <span class="o">|</span> <span class="n">FCF_ASYNC_SENT</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure for ISP 82XX IO DMA is complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla82xx_chip_reset_cleanup</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b4</span><span class="p">,</span>
			    <span class="s">&quot;Done chip reset cleanup.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Done waiting for pending commands.</span>
<span class="cm">			 * Reset the online flag.</span>
<span class="cm">			 */</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Requeue all commands in outstanding command list. */</span>
		<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  qla2x00_abort_isp</span>
<span class="cm">*      Resets ISP and aborts all outstanding commands.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha           = adapter block pointer.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0 = success</span>
<span class="cm">*/</span>
<span class="kt">int</span>
<span class="nf">qla2x00_abort_isp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint8_t</span>        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_abort_isp_cleanup</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">get_flash_version</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">nvram_config</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_restart_isp</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Issue marker command only when we are going</span>
<span class="cm">				 * to start the I/O .</span>
<span class="cm">				 */</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="n">qla2x00_get_fw_version</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">fce_calc_size</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">));</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_enable_fce_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_mb</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8033</span><span class="p">,</span>
					    <span class="s">&quot;Unable to reinitialize FCE &quot;</span>
					    <span class="s">&quot;(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EFT_SIZE</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_enable_eft_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span><span class="p">,</span> <span class="n">EFT_NUM_BUFFERS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8034</span><span class="p">,</span>
					    <span class="s">&quot;Unable to reinitialize EFT &quot;</span>
					    <span class="s">&quot;(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* failed the ISP abort */</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8035</span><span class="p">,</span>
					    <span class="s">&quot;ISP error recover failed - &quot;</span>
					    <span class="s">&quot;board disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * The next call disables the board</span>
<span class="cm">					 * completely.</span>
<span class="cm">					 */</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_adapter</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
					<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
					<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* schedule another ISP abort */</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span><span class="o">--</span><span class="p">;</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8020</span><span class="p">,</span>
					    <span class="s">&quot;ISP abort - retry remaining %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span><span class="p">);</span>
					<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">=</span> <span class="n">MAX_RETRIES_OF_ISP_ABORT</span><span class="p">;</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8021</span><span class="p">,</span>
				    <span class="s">&quot;ISP error recovery - retrying (%d) &quot;</span>
				    <span class="s">&quot;more times.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8022</span><span class="p">,</span> <span class="s">&quot;%s succeeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

				<span class="n">qla2x00_vp_abort_isp</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8023</span><span class="p">,</span> <span class="s">&quot;%s **** FAILED ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  qla2x00_restart_isp</span>
<span class="cm">*      restarts the ISP after a reset</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha = adapter block pointer.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*      0 = success</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_restart_isp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">wait_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If firmware needs to be loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_isp_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">chip_diag</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_setup_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_init_rings</span><span class="p">(</span><span class="n">vha</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Initialize the queues in use */</span>
		<span class="n">qla25xx_init_queues</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_fw_ready</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8031</span><span class="p">,</span>
			    <span class="s">&quot;Start configure loop status = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

			<span class="cm">/* Issue a marker after FW becomes ready. */</span>
			<span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">);</span>

			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Process any ATIO queue entries that came in</span>
<span class="cm">			 * while we weren&#39;t online.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla_tgt_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
				<span class="n">qlt_24xx_process_atio_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* Wait at most MAX_TARGET RSCNs for a stable link. */</span>
			<span class="n">wait_time</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">qla2x00_configure_loop</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="n">wait_time</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="n">wait_time</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="cm">/* if no cable then assume it&#39;s good */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_NO_CABLE</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8032</span><span class="p">,</span>
		    <span class="s">&quot;Configure loop done, status = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla25xx_init_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_init_rsp_que</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x00ff</span><span class="p">,</span>
				    <span class="s">&quot;%s Rsp que: %d init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span>
				    <span class="s">&quot;%s Rsp que: %d inited.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear outstanding commands array. */</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_init_req_que</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span>
				    <span class="s">&quot;%s Req que: %d init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">base_vha</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">,</span>
				    <span class="s">&quot;%s Req que: %d inited.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla2x00_reset_adapter</span>
<span class="cm">*      Reset adapter.</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">*      ha = adapter block pointer.</span>
<span class="cm">*/</span>
<span class="kt">void</span>
<span class="nf">qla2x00_reset_adapter</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_2xxx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RESET_RISC</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>			<span class="cm">/* PCI Posting. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCR_RELEASE_RISC</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>			<span class="cm">/* PCI Posting. */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla24xx_reset_adapter</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_24xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_SET_RISC_RESET</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">,</span> <span class="n">HCCRX_REL_RISC_PAUSE</span><span class="p">);</span>
	<span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">hccr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOPOLLING_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* On sparc systems, obtain port and node WWN from firmware</span>
<span class="cm"> * properties.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla24xx_nvram_wwn_from_ofw</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">nvram_24xx</span> <span class="o">*</span><span class="n">nv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;port-wwn&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">WWN_SIZE</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;node-wwn&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">WWN_SIZE</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_nvram_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>   <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="n">icb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_24xx</span> <span class="o">*</span><span class="n">nv</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dptr</span><span class="p">;</span>
	<span class="kt">uint8_t</span>  <span class="o">*</span><span class="n">dptr1</span><span class="p">,</span> <span class="o">*</span><span class="n">dptr2</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">icb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>
	<span class="n">nv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>

	<span class="cm">/* Determine NVRAM starting address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">port0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span> <span class="o">=</span> <span class="n">FA_NVRAM_FUNC0_ADDR</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_base</span> <span class="o">=</span> <span class="n">FA_NVRAM_VPD0_ADDR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span> <span class="o">=</span> <span class="n">FA_NVRAM_FUNC1_ADDR</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_base</span> <span class="o">=</span> <span class="n">FA_NVRAM_VPD1_ADDR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram_24xx</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span> <span class="o">=</span> <span class="n">FA_NVRAM_VPD_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span> <span class="o">=</span> <span class="n">FA_VPD_SIZE_82XX</span><span class="p">;</span>

	<span class="cm">/* Get VPD data into cache */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">+</span> <span class="n">VPD_OFFSET</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span> <span class="o">-</span> <span class="n">FA_NVRAM_FUNC0_ADDR</span><span class="p">,</span> <span class="n">FA_NVRAM_VPD_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Get NVRAM data into cache and calculate checksum. */</span>
	<span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">nv</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dptr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dptr</span><span class="o">++</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span>
	    <span class="s">&quot;Contents of NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x010d</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">nv</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>

	<span class="cm">/* Bad NVRAM data, set defaults parameters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span>
	    <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span>
	    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span> <span class="o">&lt;</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ICB_VERSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reset NVRAM data. */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x006b</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent NVRAM detected: checksum=0x%x id=%c &quot;</span>
		    <span class="s">&quot;version=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chksum</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x006c</span><span class="p">,</span>
		    <span class="s">&quot;Falling back to functioning (yet invalid -- WWPN) &quot;</span>
		    <span class="s">&quot;defaults.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set default initialization control block.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ICB_VERSION</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ICB_VERSION</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">exchange_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">hard_address</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">124</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
		<span class="n">qla24xx_nvram_wwn_from_ofw</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">nv</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_14</span><span class="o">|</span><span class="n">BIT_13</span><span class="o">|</span><span class="n">BIT_2</span><span class="o">|</span><span class="n">BIT_1</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_12</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_3</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_11</span><span class="o">|</span><span class="n">BIT_10</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">efi_parameters</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">reset_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">max_luns_per_target</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_ini_mode_enabled</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t enable full login after initial LIP */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BIT_13</span><span class="p">);</span>
		<span class="cm">/* Don&#39;t enable LIP full login for initiator */</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BIT_10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qlt_24xx_config_nvram_stage1</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">nv</span><span class="p">);</span>

	<span class="cm">/* Reset Initialization control block */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">icb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">);</span>

	<span class="cm">/* Copy 1st segment. */</span>
	<span class="n">dptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">icb</span><span class="p">;</span>
	<span class="n">dptr2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_inpointer</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dptr1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">dptr2</span><span class="o">++</span><span class="p">;</span>

	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">;</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">link_down_on_nos</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_on_nos</span><span class="p">;</span>

	<span class="cm">/* Copy 2nd segment. */</span>
	<span class="n">dptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">;</span>
	<span class="n">dptr2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">reserved_3</span> <span class="o">-</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dptr1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">dptr2</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup driver NVRAM options.</span>
<span class="cm">	 */</span>
	<span class="n">qla2x00_set_model_info</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">),</span>
	    <span class="s">&quot;QLA2462&quot;</span><span class="p">);</span>

	<span class="n">qlt_24xx_config_nvram_stage2</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">icb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span> <span class="o">&amp;</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_15</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Use alternate WWN? */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">alternate_node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">alternate_port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare nodename */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">&amp;</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_14</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Firmware will apply the following mask if the nodename was</span>
<span class="cm">		 * not provided.</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set host adapter parameters. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_risc_code_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_full_login</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_10</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_target_reset</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_11</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_led_scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_serdes</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_5</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options24</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">seriallink_options</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_seriallink_options24</span><span class="p">));</span>

	<span class="cm">/* save HBA serial number */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial0</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial1</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial2</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">);</span>

	<span class="cm">/* Set minimum login_timeout to 4 seconds. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ql2xlogintimeout</span><span class="p">)</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ql2xlogintimeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">;</span>

	<span class="cm">/* Set minimum RATOV to 100 tenths of a second. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">reset_delay</span><span class="p">;</span>

	<span class="cm">/* Link Down Timeout = 0:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 	When Port Down timer expires we will start returning</span>
<span class="cm">	 *	I/O&#39;s to OS with &quot;DID_NO_CONNECT&quot;.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Link Down Timeout != 0:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	 The driver waits for the link to come up after link down</span>
<span class="cm">	 *	 before returning I/Os to OS with &quot;DID_NO_CONNECT&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">LOOP_DOWN_TIME</span> <span class="o">-</span> <span class="n">LOOP_DOWN_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">=</span>	<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">LOOP_DOWN_TIME</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Need enough time to try and get the port back. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlport_down_retry</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">qlport_down_retry</span><span class="p">;</span>

	<span class="cm">/* Set login_retry_count */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">==</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xloginretrycount</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ql2xloginretrycount</span><span class="p">;</span>

	<span class="cm">/* Enable ZIO. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">)</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span>
	    <span class="o">~</span><span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">));</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">!=</span> <span class="n">QLA_ZIO_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">QLA_ZIO_MODE_6</span><span class="p">;</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x006f</span><span class="p">,</span>
		    <span class="s">&quot;ZIO mode %d enabled; timer delay (%d us).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		    <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span>
		    <span class="s">&quot;NVRAM configuration failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_load_risc_flash</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">segments</span><span class="p">,</span> <span class="n">fragment</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dcode</span><span class="p">,</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">risc_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x008b</span><span class="p">,</span>
	    <span class="s">&quot;FW: Loading firmware from flash (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">faddr</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">segments</span> <span class="o">=</span> <span class="n">FA_RISC_CODE_SEGMENTS</span><span class="p">;</span>
	<span class="n">dcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="o">*</span><span class="n">srisc_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Validate firmware image by checking version. */</span>
	<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">faddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x008c</span><span class="p">,</span>
		    <span class="s">&quot;Unable to verify the integrity of flash firmware &quot;</span>
		    <span class="s">&quot;image.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x008d</span><span class="p">,</span>
		    <span class="s">&quot;Firmware data: %08x %08x %08x %08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">segments</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read segment&#39;s load information. */</span>
		<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">faddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">risc_addr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">srisc_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">srisc_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">risc_addr</span> <span class="o">:</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">;</span>
		<span class="n">risc_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">fragment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">risc_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">risc_size</span><span class="p">)</span>
				<span class="n">dlen</span> <span class="o">=</span> <span class="n">risc_size</span><span class="p">;</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x008e</span><span class="p">,</span>
			    <span class="s">&quot;Loading risc segment@ risc addr %x &quot;</span>
			    <span class="s">&quot;number of dwords 0x%x offset 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">risc_addr</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">faddr</span><span class="p">);</span>

			<span class="n">qla24xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">dcode</span><span class="p">,</span> <span class="n">faddr</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_load_ram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">risc_addr</span><span class="p">,</span>
			    <span class="n">dlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x008f</span><span class="p">,</span>
				    <span class="s">&quot;Failed to load segment %d of firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fragment</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">faddr</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">risc_addr</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">risc_size</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">fragment</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Next segment. */</span>
		<span class="n">segments</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define QLA_FW_URL &quot;ftp:</span><span class="c1">//ftp.qlogic.com/outgoing/linux/firmware/&quot;</span>

<span class="kt">int</span>
<span class="nf">qla2x00_load_risc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">fragment</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wcode</span><span class="p">,</span> <span class="o">*</span><span class="n">fwcode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">,</span> <span class="n">risc_size</span><span class="p">,</span> <span class="n">fwclen</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="o">*</span><span class="n">seg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Load firmware blob. */</span>
	<span class="n">blob</span> <span class="o">=</span> <span class="n">qla2x00_request_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blob</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0083</span><span class="p">,</span>
		    <span class="s">&quot;Fimware image unavailable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0084</span><span class="p">,</span>
		    <span class="s">&quot;Firmware images can be retrieved from: &quot;</span><span class="n">QLA_FW_URL</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">wcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="o">*</span><span class="n">srisc_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fwcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fwclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Validate firmware image by checking version. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0085</span><span class="p">,</span>
		    <span class="s">&quot;Unable to verify integrity of firmware image (%Zd).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fw_integrity</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">wcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0086</span><span class="p">,</span>
		    <span class="s">&quot;Unable to verify integrity of firmware image.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0087</span><span class="p">,</span>
		    <span class="s">&quot;Firmware data: %04x %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">wcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">fail_fw_integrity</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seg</span> <span class="o">=</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">segs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">seg</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">risc_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">seg</span><span class="p">;</span>
		<span class="o">*</span><span class="n">srisc_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">srisc_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">*</span><span class="n">seg</span> <span class="o">:</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">;</span>
		<span class="n">risc_size</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="cm">/* Validate firmware image size. */</span>
		<span class="n">fwclen</span> <span class="o">+=</span> <span class="n">risc_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">fwclen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0088</span><span class="p">,</span>
			    <span class="s">&quot;Unable to verify integrity of firmware image &quot;</span>
			    <span class="s">&quot;(%Zd).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_fw_integrity</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fragment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">risc_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">&gt;</span> <span class="n">risc_size</span><span class="p">)</span>
				<span class="n">wlen</span> <span class="o">=</span> <span class="n">risc_size</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0089</span><span class="p">,</span>
			    <span class="s">&quot;Loading risc segment@ risc addr %x number of &quot;</span>
			    <span class="s">&quot;words 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">risc_addr</span><span class="p">,</span> <span class="n">wlen</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">wcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_load_ram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">risc_addr</span><span class="p">,</span>
			    <span class="n">wlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x008a</span><span class="p">,</span>
				    <span class="s">&quot;Failed to load segment %d of firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fragment</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">fwcode</span> <span class="o">+=</span> <span class="n">wlen</span><span class="p">;</span>
			<span class="n">risc_addr</span> <span class="o">+=</span> <span class="n">wlen</span><span class="p">;</span>
			<span class="n">risc_size</span> <span class="o">-=</span> <span class="n">wlen</span><span class="p">;</span>
			<span class="n">fragment</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Next segment. */</span>
		<span class="n">seg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">fail_fw_integrity:</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_load_risc_blob</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">segments</span><span class="p">,</span> <span class="n">fragment</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dcode</span><span class="p">,</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">risc_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">risc_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">fwcode</span><span class="p">,</span> <span class="n">fwclen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Load firmware blob. */</span>
	<span class="n">blob</span> <span class="o">=</span> <span class="n">qla2x00_request_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blob</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0090</span><span class="p">,</span>
		    <span class="s">&quot;Fimware image unavailable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0091</span><span class="p">,</span>
		    <span class="s">&quot;Firmware images can be retrieved from: &quot;</span>
		    <span class="n">QLA_FW_URL</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0092</span><span class="p">,</span>
	    <span class="s">&quot;FW: Loading via request-firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">segments</span> <span class="o">=</span> <span class="n">FA_RISC_CODE_SEGMENTS</span><span class="p">;</span>
	<span class="n">dcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="o">*</span><span class="n">srisc_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fwcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fwclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Validate firmware image by checking version. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0093</span><span class="p">,</span>
		    <span class="s">&quot;Unable to verify integrity of firmware image (%Zd).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fw_integrity</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0094</span><span class="p">,</span>
		    <span class="s">&quot;Unable to verify integrity of firmware image (%Zd).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0095</span><span class="p">,</span>
		    <span class="s">&quot;Firmware data: %08x %08x %08x %08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">fail_fw_integrity</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">segments</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">risc_addr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">srisc_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">srisc_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">risc_addr</span> <span class="o">:</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">;</span>
		<span class="n">risc_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="cm">/* Validate firmware image size. */</span>
		<span class="n">fwclen</span> <span class="o">+=</span> <span class="n">risc_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">fwclen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0096</span><span class="p">,</span>
			    <span class="s">&quot;Unable to verify integrity of firmware image &quot;</span>
			    <span class="s">&quot;(%Zd).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">fail_fw_integrity</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fragment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">risc_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_transfer_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">risc_size</span><span class="p">)</span>
				<span class="n">dlen</span> <span class="o">=</span> <span class="n">risc_size</span><span class="p">;</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">,</span>
			    <span class="s">&quot;Loading risc segment@ risc addr %x &quot;</span>
			    <span class="s">&quot;number of dwords 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">risc_addr</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">dcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">fwcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_load_ram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">risc_addr</span><span class="p">,</span>
			    <span class="n">dlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">,</span>
				    <span class="s">&quot;Failed to load segment %d of firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fragment</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">fwcode</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">risc_addr</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">risc_size</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">fragment</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Next segment. */</span>
		<span class="n">segments</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">fail_fw_integrity:</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_load_risc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xfwloadbin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qla81xx_load_risc</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FW Load priority:</span>
<span class="cm">	 * 1) Firmware via request-firmware interface (.bin file).</span>
<span class="cm">	 * 2) Firmware residing in flash.</span>
<span class="cm">	 */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla24xx_load_risc_blob</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">qla24xx_load_risc_flash</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_addr</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla81xx_load_risc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xfwloadbin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_blob_fw</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FW Load priority:</span>
<span class="cm">	 * 1) Firmware residing in flash.</span>
<span class="cm">	 * 2) Firmware via request-firmware interface (.bin file).</span>
<span class="cm">	 * 3) Golden-Firmware residing in flash -- limited operation.</span>
<span class="cm">	 */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla24xx_load_risc_flash</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">try_blob_fw:</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla24xx_load_risc_blob</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_gold_fw</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0099</span><span class="p">,</span>
	    <span class="s">&quot;Attempting to fallback to golden firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla24xx_load_risc_flash</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">srisc_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_gold_fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x009a</span><span class="p">,</span> <span class="s">&quot;Update operational firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">running_gold_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_try_to_stop_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">retries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_FUNCTION_TIMEOUT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_INVALID_COMMAND</span> <span class="o">&amp;&amp;</span> <span class="n">retries</span> <span class="p">;</span> <span class="n">retries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">chip_diag</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_setup_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8015</span><span class="p">,</span>
		    <span class="s">&quot;Attempting retry of stop-firmware command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla24xx_configure_vhba</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval2</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fw_ready</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">)</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Login to SNS first */</span>
	<span class="n">rval2</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">NPH_SNS</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span>
	    <span class="n">BIT_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval2</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span> <span class="o">||</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval2</span> <span class="o">==</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">)</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span>
			    <span class="s">&quot;Failed SNS login: loop_id=%x, rval2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">NPH_SNS</span><span class="p">,</span> <span class="n">rval2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0103</span><span class="p">,</span>
			    <span class="s">&quot;Failed SNS login: loop_id=%x mb[0]=%x mb[1]=%x &quot;</span>
			    <span class="s">&quot;mb[2]=%x mb[6]=%x mb[7]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">NPH_SNS</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_FUNCTION_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_UP</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">LOCAL_LOOP_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_loop_resync</span><span class="p">(</span><span class="n">base_vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 84XX Support **************************************************************/</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">qla_cs84xx_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">qla_cs84xx_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_chip_state_84xx</span> <span class="o">*</span>
<span class="nf">qla84xx_get_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_chip_state_84xx</span> <span class="o">*</span><span class="n">cs84xx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_cs84xx_mutex</span><span class="p">);</span>

	<span class="cm">/* Find any shared 84xx chip. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cs84xx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qla_cs84xx_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cs84xx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cs84xx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs84xx</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">fw_update_mutex</span><span class="p">);</span>
	<span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qla_cs84xx_list</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_cs84xx_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cs84xx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__qla84xx_chip_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_chip_state_84xx</span> <span class="o">*</span><span class="n">cs84xx</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qla_chip_state_84xx</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_cs84xx_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_cs84xx_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs84xx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla84xx_put_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="p">)</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">__qla84xx_chip_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla84xx_init_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">fw_update_mutex</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla84xx_verify_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">fw_update_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span> <span class="o">||</span> <span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="o">:</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 81XX Support **************************************************************/</span>

<span class="kt">int</span>
<span class="nf">qla81xx_nvram_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>   <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init_cb_81xx</span> <span class="o">*</span><span class="n">icb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_81xx</span> <span class="o">*</span><span class="n">nv</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dptr</span><span class="p">;</span>
	<span class="kt">uint8_t</span>  <span class="o">*</span><span class="n">dptr1</span><span class="p">,</span> <span class="o">*</span><span class="n">dptr2</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">icb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">init_cb_81xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>
	<span class="n">nv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>

	<span class="cm">/* Determine NVRAM starting address. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram_81xx</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span> <span class="o">=</span> <span class="n">FA_NVRAM_VPD_SIZE</span><span class="p">;</span>

	<span class="cm">/* Get VPD data into cache */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">+</span> <span class="n">VPD_OFFSET</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span><span class="p">);</span>

	<span class="cm">/* Get NVRAM data into cache and calculate checksum. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
	<span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">nv</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dptr</span><span class="o">++</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0111</span><span class="p">,</span>
	    <span class="s">&quot;Contents of NVRAM:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_init</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0112</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">nv</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>

	<span class="cm">/* Bad NVRAM data, set defaults parameters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span>
	    <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span>
	    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span> <span class="o">&lt;</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ICB_VERSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reset NVRAM data. */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0073</span><span class="p">,</span>
		    <span class="s">&quot;Inconsistent NVRAM detected: checksum=0x%x id=%c &quot;</span>
		    <span class="s">&quot;version=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chksum</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span><span class="p">));</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span>
		    <span class="s">&quot;Falling back to functioning (yet invalid -- WWPN) &quot;</span>
		    <span class="s">&quot;defaults.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set default initialization control block.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">nvram_version</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ICB_VERSION</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ICB_VERSION</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">exchange_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_14</span><span class="o">|</span><span class="n">BIT_13</span><span class="o">|</span><span class="n">BIT_2</span><span class="o">|</span><span class="n">BIT_1</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_12</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_options_3</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_11</span><span class="o">|</span><span class="n">BIT_10</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">efi_parameters</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">reset_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">max_luns_per_target</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">180</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xDD</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset Initialization control block */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">icb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb_size</span><span class="p">);</span>

	<span class="cm">/* Copy 1st segment. */</span>
	<span class="n">dptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">icb</span><span class="p">;</span>
	<span class="n">dptr2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_inpointer</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dptr1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">dptr2</span><span class="o">++</span><span class="p">;</span>

	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">;</span>

	<span class="cm">/* Copy 2nd segment. */</span>
	<span class="n">dptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">;</span>
	<span class="n">dptr2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">reserved_5</span> <span class="o">-</span>
	    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dptr1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">dptr2</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">));</span>
	<span class="cm">/* Some boards (with valid NVRAMs) still have NULL enode_mac!! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\0\0\0\0\0\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xDD</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use extended-initialization control block. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">ex_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ex_init_cb</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup driver NVRAM options.</span>
<span class="cm">	 */</span>
	<span class="n">qla2x00_set_model_info</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">),</span>
	    <span class="s">&quot;QLE8XXX&quot;</span><span class="p">);</span>

	<span class="cm">/* Use alternate WWN? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span> <span class="o">&amp;</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_15</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">alternate_node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">alternate_port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare nodename */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_1</span> <span class="o">&amp;</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_14</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Firmware will apply the following mask if the nodename was</span>
<span class="cm">		 * not provided.</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set host adapter parameters. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_risc_code_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_lip_full_login</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_10</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_target_reset</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_11</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_led_scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_serdes</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">host_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_5</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* save HBA serial number */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial0</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial1</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial2</span> <span class="o">=</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">icb</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">);</span>

	<span class="cm">/* Set minimum login_timeout to 4 seconds. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ql2xlogintimeout</span><span class="p">)</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ql2xlogintimeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">login_timeout</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_timeout</span><span class="p">;</span>

	<span class="cm">/* Set minimum RATOV to 100 tenths of a second. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_reset_delay</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">reset_delay</span><span class="p">;</span>

	<span class="cm">/* Link Down Timeout = 0:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 	When Port Down timer expires we will start returning</span>
<span class="cm">	 *	I/O&#39;s to OS with &quot;DID_NO_CONNECT&quot;.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Link Down Timeout != 0:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	 The driver waits for the link to come up after link down</span>
<span class="cm">	 *	 before returning I/Os to OS with &quot;DID_NO_CONNECT&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">LOOP_DOWN_TIME</span> <span class="o">-</span> <span class="n">LOOP_DOWN_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span> <span class="o">=</span>	<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">loop_down_abort_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">LOOP_DOWN_TIME</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_down_timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Need enough time to try and get the port back. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlport_down_retry</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">=</span> <span class="n">qlport_down_retry</span><span class="p">;</span>

	<span class="cm">/* Set login_retry_count */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">==</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xloginretrycount</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">login_retry_count</span> <span class="o">=</span> <span class="n">ql2xloginretrycount</span><span class="p">;</span>

	<span class="cm">/* if not running MSI-X we need handshaking on interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msix_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">BIT_22</span><span class="p">);</span>

	<span class="cm">/* Enable ZIO. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span><span class="p">)</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span>
	    <span class="o">~</span><span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">));</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">!=</span> <span class="n">QLA_ZIO_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">QLA_ZIO_MODE_6</span><span class="p">;</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0075</span><span class="p">,</span>
		    <span class="s">&quot;ZIO mode %d enabled; timer delay (%d us).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">firmware_options_2</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		    <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">);</span>
		<span class="n">icb</span><span class="o">-&gt;</span><span class="n">interrupt_delay_timer</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_timer</span><span class="p">);</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">process_response_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span>
		    <span class="s">&quot;NVRAM configuration failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_restart_isp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">wait_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_init_rings</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">chip_reset_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">qla2x00_fw_ready</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x803c</span><span class="p">,</span>
			    <span class="s">&quot;Start configure loop, status =%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

			<span class="cm">/* Issue a marker after FW becomes ready. */</span>
			<span class="n">qla2x00_marker</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">);</span>

			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Wait at most MAX_TARGET RSCNs for a stable link. */</span>
			<span class="n">wait_time</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">qla2x00_configure_loop</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="n">wait_time</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">wait_time</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="cm">/* if no cable then assume it&#39;s good */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_NO_CABLE</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span>
		    <span class="s">&quot;Configure loop done, status = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESET_MARKER_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_down_timer</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Issue marker command only when we are going</span>
<span class="cm">			 * to start the I/O .</span>
<span class="cm">			 */</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">marker_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

		<span class="cm">/* Update the firmware version */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">qla82xx_check_md_needed</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">fce_calc_size</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">));</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_enable_fce_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_dma</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_mb</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fce_bufs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8001</span><span class="p">,</span>
				    <span class="s">&quot;Unable to reinitialize FCE (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">rval</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fce_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EFT_SIZE</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_enable_eft_trace</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">eft_dma</span><span class="p">,</span> <span class="n">EFT_NUM_BUFFERS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8010</span><span class="p">,</span>
				    <span class="s">&quot;Unable to reinitialize EFT (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">rval</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8011</span><span class="p">,</span>
		    <span class="s">&quot;qla82xx_restart_isp succeeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

				<span class="n">qla2x00_vp_abort_isp</span><span class="p">(</span><span class="n">vp</span><span class="p">);</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8016</span><span class="p">,</span>
		    <span class="s">&quot;qla82xx_restart_isp **** FAILED ****.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla81xx_update_fw_options</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql2xetsenable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Enable ETS Burst. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_9</span><span class="p">;</span>
	<span class="n">qla2x00_set_fw_options</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_get_fcp_prio</span>
<span class="cm"> *	Gets the fcp cmd priority value for the logged in port.</span>
<span class="cm"> *	Looks for a match of the port descriptors within</span>
<span class="cm"> *	each of the fcp prio config entries. If a match is found,</span>
<span class="cm"> *	the tag (priority) value is returned.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	vha = scsi host structure pointer.</span>
<span class="cm"> *	fcport = port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	non-zero (if found)</span>
<span class="cm"> *	-1 (if not found)</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> * 	Kernel context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_get_fcp_prio</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">entries</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">pid_match</span><span class="p">,</span> <span class="n">wwn_match</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">pid2</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">wwn1</span><span class="p">,</span> <span class="n">wwn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_fcp_prio_entry</span> <span class="o">*</span><span class="n">pri_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fcp_prio_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">priority</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span>
	<span class="n">pri_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcp_prio_cfg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pid_match</span> <span class="o">=</span> <span class="n">wwn_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCP_PRIO_ENTRY_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pri_entry</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check source pid for a match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCP_PRIO_ENTRY_SPID_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pid1</span> <span class="o">=</span> <span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">src_pid</span> <span class="o">&amp;</span> <span class="n">INVALID_PORT_ID</span><span class="p">;</span>
			<span class="n">pid2</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">&amp;</span> <span class="n">INVALID_PORT_ID</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">==</span> <span class="n">INVALID_PORT_ID</span><span class="p">)</span>
				<span class="n">pid_match</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">==</span> <span class="n">pid2</span><span class="p">)</span>
				<span class="n">pid_match</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check destination pid for a match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCP_PRIO_ENTRY_DPID_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pid1</span> <span class="o">=</span> <span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">dst_pid</span> <span class="o">&amp;</span> <span class="n">INVALID_PORT_ID</span><span class="p">;</span>
			<span class="n">pid2</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b24</span> <span class="o">&amp;</span> <span class="n">INVALID_PORT_ID</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">==</span> <span class="n">INVALID_PORT_ID</span><span class="p">)</span>
				<span class="n">pid_match</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">==</span> <span class="n">pid2</span><span class="p">)</span>
				<span class="n">pid_match</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check source WWN for a match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCP_PRIO_ENTRY_SWWN_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wwn1</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
			<span class="n">wwn2</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">src_wwpn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wwn2</span> <span class="o">==</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">wwn_match</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wwn1</span> <span class="o">==</span> <span class="n">wwn2</span><span class="p">)</span>
				<span class="n">wwn_match</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check destination WWN for a match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCP_PRIO_ENTRY_DWWN_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wwn1</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
			<span class="n">wwn2</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">dst_wwpn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wwn2</span> <span class="o">==</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">wwn_match</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wwn1</span> <span class="o">==</span> <span class="n">wwn2</span><span class="p">)</span>
				<span class="n">wwn_match</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pid_match</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">wwn_match</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Found a matching entry */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FCP_PRIO_ENTRY_TAG_VALID</span><span class="p">)</span>
				<span class="n">priority</span> <span class="o">=</span> <span class="n">pri_entry</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pri_entry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">priority</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_update_fcport_fcp_prio</span>
<span class="cm"> *	Activates fcp priority for the logged in fc port</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	vha = scsi host structure pointer.</span>
<span class="cm"> *	fcp = port structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	QLA_SUCCESS or QLA_FUNCTION_FAILED</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_update_fcport_fcp_prio</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">FCT_TARGET</span> <span class="o">||</span>
	    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">==</span> <span class="n">FC_NO_LOOP_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">priority</span> <span class="o">=</span> <span class="n">qla24xx_get_fcp_prio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcp_prio</span> <span class="o">=</span> <span class="n">priority</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_set_fcp_prio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcp_prio</span> <span class="o">!=</span> <span class="n">priority</span><span class="p">)</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x709e</span><span class="p">,</span>
			    <span class="s">&quot;Updated FCP_CMND priority - value=%d loop_id=%d &quot;</span>
			    <span class="s">&quot;port_id=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcp_prio</span> <span class="o">=</span> <span class="n">priority</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x704f</span><span class="p">,</span>
		    <span class="s">&quot;Unable to update FCP_CMND priority - ret=0x%x for &quot;</span>
		    <span class="s">&quot;loop_id=%d port_id=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="k">return</span>  <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla24xx_update_all_fcp_prio</span>
<span class="cm"> *	Activates fcp priority for all the logged in ports</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	QLA_SUCCESS or QLA_FUNCTION_FAILED</span>
<span class="cm"> *</span>
<span class="cm"> * Context:</span>
<span class="cm"> *	Kernel context.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla24xx_update_all_fcp_prio</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="cm">/* We need to set priority for all logged in ports */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_update_fcport_fcp_prio</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
