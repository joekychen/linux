<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_gs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_gs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_sns_ga_nxt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_sns_gid_pt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_sns_gpn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_sns_gnn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_sns_rft_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla2x00_sns_rnn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_ms_iocb() - Prepare common MS/CT IOCB fields for SNS CT query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @req_size: request size in bytes</span>
<span class="cm"> * @rsp_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the @ha&#39;s ms_iocb.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_ms_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>

	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ms_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>

	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MS_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">SIMPLE_NAME_SERVER</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_READ</span> <span class="o">|</span> <span class="n">CF_HEAD_TAG</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">total_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">rsp_bytecount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rsp_size</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>

	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_length</span> <span class="o">=</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span><span class="p">;</span>

	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_rsp_length</span> <span class="o">=</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">rsp_bytecount</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ms_pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_prep_ms_iocb() - Prepare common CT IOCB fields for SNS CT query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @req_size: request size in bytes</span>
<span class="cm"> * @rsp_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the @ha&#39;s ms_iocb.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">qla24xx_prep_ms_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="n">ct_pkt</span><span class="p">;</span>

	<span class="n">ct_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span><span class="p">));</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">NPH_SNS</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rsp_size</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span><span class="p">;</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ct_pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_ct_req() - Prepare common CT request fields for SNS query.</span>
<span class="cm"> * @ct_req: CT request buffer</span>
<span class="cm"> * @cmd: GS command</span>
<span class="cm"> * @rsp_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the intitialized @ct_req.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_ct_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_pkt</span><span class="p">));</span>

	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">gs_type</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">gs_subtype</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">max_rsp_size</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">((</span><span class="n">rsp_size</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ct_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">ct_sns_rsp</span> <span class="o">*</span><span class="n">ct_rsp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">comp_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2031</span><span class="p">,</span>
		    <span class="s">&quot;%s failed, error status (%x) on port_id: %02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">routine</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
		    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span>
			    <span class="p">((</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ms_pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">comp_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CS_COMPLETE</span>:
		<span class="k">case</span> <span class="n">CS_DATA_UNDERRUN</span>:
		<span class="k">case</span> <span class="n">CS_DATA_OVERRUN</span>:		<span class="cm">/* Overrun? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response</span> <span class="o">!=</span>
			    <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">CT_ACCEPT_RESPONSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2077</span><span class="p">,</span>
				    <span class="s">&quot;%s failed rejected request on port_id: &quot;</span>
				    <span class="s">&quot;%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">routine</span><span class="p">,</span>
				    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
				    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
				<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span>
				    <span class="mh">0x2078</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_rsp_hdr</span><span class="p">));</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_INVALID_COMMAND</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2033</span><span class="p">,</span>
			    <span class="s">&quot;%s failed, completion status (%x) on port_id: &quot;</span>
			    <span class="s">&quot;%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">routine</span><span class="p">,</span> <span class="n">comp_status</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_ga_nxt() - SNS scan for fabric devices via GA_NXT command.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @fcport: fcport entry to updated</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_ga_nxt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>

	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_sns_ga_nxt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>

	<span class="cm">/* Issue GA_NXT */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GA_NXT_REQ_SIZE</span><span class="p">,</span>
	    <span class="n">GA_NXT_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GA_NXT_CMD</span><span class="p">,</span>
	    <span class="n">GA_NXT_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare CT arguments -- port_id */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2062</span><span class="p">,</span>
		    <span class="s">&quot;GA_NXT issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;GA_NXT&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Populate fc_port_t entry. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">node_name</span><span class="p">,</span>
		    <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span>
		    <span class="n">WWN_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">NS_N_PORT_TYPE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">ga_nxt</span><span class="p">.</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">NS_NL_PORT_TYPE</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2063</span><span class="p">,</span>
		    <span class="s">&quot;GA_NXT entry - nn %02x%02x%02x%02x%02x%02x%02x%02x &quot;</span>
		    <span class="s">&quot;pn %02x%02x%02x%02x%02x%02x%02x%02x &quot;</span>
		    <span class="s">&quot;port_id=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla2x00_gid_pt_rsp_size</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_gid_pt() - SNS scan for fabric devices via GID_PT command.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Non-Nx_Ports are not requested.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_gid_pt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ct_sns_gid_pt_data</span> <span class="o">*</span><span class="n">gid_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">gid_pt_rsp_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_sns_gid_pt</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">gid_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gid_pt_rsp_size</span> <span class="o">=</span> <span class="n">qla2x00_gid_pt_rsp_size</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="cm">/* Issue GID_PT */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GID_PT_REQ_SIZE</span><span class="p">,</span>
	    <span class="n">gid_pt_rsp_size</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GID_PT_CMD</span><span class="p">,</span>
	    <span class="n">gid_pt_rsp_size</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare CT arguments -- port_type */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">gid_pt</span><span class="p">.</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">NS_NX_PORT_TYPE</span><span class="p">;</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2055</span><span class="p">,</span>
		    <span class="s">&quot;GID_PT issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;GID_PT&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set port IDs in switch info list. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gid_pt</span><span class="p">.</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">gid_data</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">gid_data</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">gid_data</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">PORT_SPEED_UNKNOWN</span><span class="p">;</span>

			<span class="cm">/* Last one exit. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gid_data</span><span class="o">-&gt;</span><span class="n">control_byte</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">=</span> <span class="n">gid_data</span><span class="o">-&gt;</span><span class="n">control_byte</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;ve used all available slots, then the switch is</span>
<span class="cm">		 * reporting back more devices than we can handle with this</span>
<span class="cm">		 * single call.  Return a failed status, and let GA_NXT handle</span>
<span class="cm">		 * the overload.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_gpn_id() - SNS Get Port Name (GPN_ID) query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_gpn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_sns_gpn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue GPN_ID */</span>
		<span class="cm">/* Prepare common MS IOCB */</span>
		<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GPN_ID_REQ_SIZE</span><span class="p">,</span>
		    <span class="n">GPN_ID_RSP_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare CT request */</span>
		<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GPN_ID_CMD</span><span class="p">,</span>
		    <span class="n">GPN_ID_RSP_SIZE</span><span class="p">);</span>
		<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

		<span class="cm">/* Prepare CT arguments -- port_id */</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

		<span class="cm">/* Execute MS IOCB */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*EMPTY*/</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2056</span><span class="p">,</span>
			    <span class="s">&quot;GPN_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span>
		    <span class="s">&quot;GPN_ID&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Save portname */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">,</span>
			    <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gpn_id</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_gnn_id() - SNS Get Node Name (GNN_ID) query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_gnn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_sns_gnn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue GNN_ID */</span>
		<span class="cm">/* Prepare common MS IOCB */</span>
		<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GNN_ID_REQ_SIZE</span><span class="p">,</span>
		    <span class="n">GNN_ID_RSP_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare CT request */</span>
		<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GNN_ID_CMD</span><span class="p">,</span>
		    <span class="n">GNN_ID_RSP_SIZE</span><span class="p">);</span>
		<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

		<span class="cm">/* Prepare CT arguments -- port_id */</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

		<span class="cm">/* Execute MS IOCB */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*EMPTY*/</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2057</span><span class="p">,</span>
			    <span class="s">&quot;GNN_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span>
		    <span class="s">&quot;GNN_ID&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Save nodename */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">,</span>
			    <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gnn_id</span><span class="p">.</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2058</span><span class="p">,</span>
			    <span class="s">&quot;GID_PT entry - nn %02x%02x%02x%02x%02x%02x%02X%02x &quot;</span>
			    <span class="s">&quot;pn %02x%02x%02x%02x%02x%02x%02X%02x &quot;</span>
			    <span class="s">&quot;portid=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_rft_id() - SNS Register FC-4 TYPEs (RFT_ID) supported by the HBA.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_rft_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_sns_rft_id</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Issue RFT_ID */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RFT_ID_REQ_SIZE</span><span class="p">,</span>
	    <span class="n">RFT_ID_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">RFT_ID_CMD</span><span class="p">,</span>
	    <span class="n">RFT_ID_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare CT arguments -- port_id, FC-4 types */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rft_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rft_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rft_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rft_id</span><span class="p">.</span><span class="n">fc4_types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>		<span class="cm">/* FCP-3 */</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2043</span><span class="p">,</span>
		    <span class="s">&quot;RFT_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;RFT_ID&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2044</span><span class="p">,</span>
		    <span class="s">&quot;RFT_ID exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_rff_id() - SNS Register FC-4 Features (RFF_ID) supported by the HBA.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_rff_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2046</span><span class="p">,</span>
		    <span class="s">&quot;RFF_ID call not supported on ISP2100/ISP2200.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_SUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue RFF_ID */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RFF_ID_REQ_SIZE</span><span class="p">,</span>
	    <span class="n">RFF_ID_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">RFF_ID_CMD</span><span class="p">,</span>
	    <span class="n">RFF_ID_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare CT arguments -- port_id, FC-4 feature, FC-4 type */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

	<span class="n">qlt_rff_id</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ct_req</span><span class="p">);</span>

	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rff_id</span><span class="p">.</span><span class="n">fc4_type</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>		<span class="cm">/* SCSI - FCP */</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2047</span><span class="p">,</span>
		    <span class="s">&quot;RFF_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;RFF_ID&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2048</span><span class="p">,</span>
		    <span class="s">&quot;RFF_ID exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_rnn_id() - SNS Register Node Name (RNN_ID) of the HBA.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_rnn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qla2x00_sns_rnn_id</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Issue RNN_ID */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RNN_ID_REQ_SIZE</span><span class="p">,</span>
	    <span class="n">RNN_ID_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">RNN_ID_CMD</span><span class="p">,</span>
	    <span class="n">RNN_ID_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare CT arguments -- port_id, node_name */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rnn_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rnn_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rnn_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rnn_id</span><span class="p">.</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x204d</span><span class="p">,</span>
		    <span class="s">&quot;RNN_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;RNN_ID&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x204e</span><span class="p">,</span>
		    <span class="s">&quot;RNN_ID exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_get_sym_node_name</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">snn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">snn</span><span class="p">,</span> <span class="s">&quot;%s FW:v%d.%02d.%02d DVR:v%s&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">,</span> <span class="n">qla2x00_version_str</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_rsnn_nn() - SNS Register Symbolic Node Name (RSNN_NN) of the HBA.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_rsnn_nn</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2050</span><span class="p">,</span>
		    <span class="s">&quot;RSNN_ID call unsupported on ISP2100/ISP2200.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">QLA_SUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Issue RSNN_NN */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="cm">/*   Request size adjusted after CT preparation */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RSNN_NN_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">RSNN_NN_CMD</span><span class="p">,</span>
	    <span class="n">RSNN_NN_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare CT arguments -- node_name, symbolic node_name, size */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsnn_nn</span><span class="p">.</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare the Symbolic Node Name */</span>
	<span class="n">qla2x00_get_sym_node_name</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsnn_nn</span><span class="p">.</span><span class="n">sym_node_name</span><span class="p">);</span>

	<span class="cm">/* Calculate SNN length */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsnn_nn</span><span class="p">.</span><span class="n">name_len</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsnn_nn</span><span class="p">.</span><span class="n">sym_node_name</span><span class="p">);</span>

	<span class="cm">/* Update MS IOCB request */</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">24</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rsnn_nn</span><span class="p">.</span><span class="n">name_len</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_length</span> <span class="o">=</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span><span class="p">;</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2051</span><span class="p">,</span>
		    <span class="s">&quot;RSNN_NN issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;RSNN_NN&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2052</span><span class="p">,</span>
		    <span class="s">&quot;RSNN_NN exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_sns_cmd() - Prepare common SNS command request fields for query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @cmd: GS command</span>
<span class="cm"> * @scmd_len: Subcommand length</span>
<span class="cm"> * @data_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the @ha&#39;s sns_cmd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sns_cmd_pkt</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">scmd_len</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>		<span class="n">wc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sns_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
	<span class="n">wc</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>			<span class="cm">/* Size in 16bit words. */</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">));</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">buffer_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">));</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcommand_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scmd_len</span><span class="p">);</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">wc</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* Size in 32bit words. */</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_sns_ga_nxt() - SNS scan for fabric devices via GA_NXT command.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @fcport: fcport entry to updated</span>
<span class="cm"> *</span>
<span class="cm"> * This command uses the old Exectute SNS Command mailbox routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_sns_ga_nxt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>

	<span class="cm">/* Issue GA_NXT. */</span>
	<span class="cm">/* Prepare SNS command request. */</span>
	<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GA_NXT_CMD</span><span class="p">,</span> <span class="n">GA_NXT_SNS_SCMD_LEN</span><span class="p">,</span>
	    <span class="n">GA_NXT_SNS_DATA_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare SNS command arguments -- port_id. */</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>

	<span class="cm">/* Execute SNS command. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_send_sns</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span> <span class="n">GA_NXT_SNS_CMD_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x205f</span><span class="p">,</span>
		    <span class="s">&quot;GA_NXT Send SNS failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">||</span>
	    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2084</span><span class="p">,</span>
		    <span class="s">&quot;GA_NXT failed, rejected request ga_nxt_rsp:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2074</span><span class="p">,</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Populate fc_port_t entry. */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">284</span><span class="p">],</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NS_N_PORT_TYPE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gan_data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NS_NL_PORT_TYPE</span><span class="p">)</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2061</span><span class="p">,</span>
		    <span class="s">&quot;GA_NXT entry - nn %02x%02x%02x%02x%02x%02x%02x%02x &quot;</span>
		    <span class="s">&quot;pn %02x%02x%02x%02x%02x%02x%02x%02x &quot;</span>
		    <span class="s">&quot;port_id=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_sns_gid_pt() - SNS scan for fabric devices via GID_PT command.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * This command uses the old Exectute SNS Command mailbox routine.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Non-Nx_Ports are not requested.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_sns_gid_pt</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">gid_pt_sns_data_size</span><span class="p">;</span>

	<span class="n">gid_pt_sns_data_size</span> <span class="o">=</span> <span class="n">qla2x00_gid_pt_rsp_size</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Issue GID_PT. */</span>
	<span class="cm">/* Prepare SNS command request. */</span>
	<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GID_PT_CMD</span><span class="p">,</span> <span class="n">GID_PT_SNS_SCMD_LEN</span><span class="p">,</span>
	    <span class="n">gid_pt_sns_data_size</span><span class="p">);</span>

	<span class="cm">/* Prepare SNS command arguments -- port_type. */</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NS_NX_PORT_TYPE</span><span class="p">;</span>

	<span class="cm">/* Execute SNS command. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_send_sns</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span> <span class="n">GID_PT_SNS_CMD_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x206d</span><span class="p">,</span>
		    <span class="s">&quot;GID_PT Send SNS failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gid_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">||</span>
	    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gid_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x202f</span><span class="p">,</span>
		    <span class="s">&quot;GID_PT failed, rejected request, gid_rsp:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2081</span><span class="p">,</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gid_data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set port IDs in switch info list. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gid_data</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">];</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

			<span class="cm">/* Last one exit. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;ve used all available slots, then the switch is</span>
<span class="cm">		 * reporting back more devices that we can handle with this</span>
<span class="cm">		 * single call.  Return a failed status, and let GA_NXT handle</span>
<span class="cm">		 * the overload.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_sns_gpn_id() - SNS Get Port Name (GPN_ID) query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * This command uses the old Exectute SNS Command mailbox routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_sns_gpn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue GPN_ID */</span>
		<span class="cm">/* Prepare SNS command request. */</span>
		<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GPN_ID_CMD</span><span class="p">,</span>
		    <span class="n">GPN_ID_SNS_SCMD_LEN</span><span class="p">,</span> <span class="n">GPN_ID_SNS_DATA_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare SNS command arguments -- port_id. */</span>
		<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
		<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>

		<span class="cm">/* Execute SNS command. */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_send_sns</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span>
		    <span class="n">GPN_ID_SNS_CMD_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*EMPTY*/</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2032</span><span class="p">,</span>
			    <span class="s">&quot;GPN_ID Send SNS failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gpn_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">||</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gpn_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x207e</span><span class="p">,</span>
			    <span class="s">&quot;GPN_ID failed, rejected request, gpn_rsp:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x207f</span><span class="p">,</span>
			    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gpn_data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Save portname */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gpn_data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			    <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_sns_gnn_id() - SNS Get Node Name (GNN_ID) query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * This command uses the old Exectute SNS Command mailbox routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_sns_gnn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue GNN_ID */</span>
		<span class="cm">/* Prepare SNS command request. */</span>
		<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GNN_ID_CMD</span><span class="p">,</span>
		    <span class="n">GNN_ID_SNS_SCMD_LEN</span><span class="p">,</span> <span class="n">GNN_ID_SNS_DATA_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare SNS command arguments -- port_id. */</span>
		<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
		<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>

		<span class="cm">/* Execute SNS command. */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_send_sns</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span>
		    <span class="n">GNN_ID_SNS_CMD_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*EMPTY*/</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x203f</span><span class="p">,</span>
			    <span class="s">&quot;GNN_ID Send SNS failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gnn_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">||</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gnn_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2082</span><span class="p">,</span>
			    <span class="s">&quot;GNN_ID failed, rejected request, gnn_rsp:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x207a</span><span class="p">,</span>
			    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gnn_data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Save nodename */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">gnn_data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			    <span class="n">WWN_SIZE</span><span class="p">);</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x206e</span><span class="p">,</span>
			    <span class="s">&quot;GID_PT entry - nn %02x%02x%02x%02x%02x%02x%02x%02x &quot;</span>
			    <span class="s">&quot;pn %02x%02x%02x%02x%02x%02x%02x%02x &quot;</span>
			    <span class="s">&quot;port_id=%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_snd_rft_id() - SNS Register FC-4 TYPEs (RFT_ID) supported by the HBA.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * This command uses the old Exectute SNS Command mailbox routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_sns_rft_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>

	<span class="cm">/* Issue RFT_ID. */</span>
	<span class="cm">/* Prepare SNS command request. */</span>
	<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RFT_ID_CMD</span><span class="p">,</span> <span class="n">RFT_ID_SNS_SCMD_LEN</span><span class="p">,</span>
	    <span class="n">RFT_ID_SNS_DATA_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare SNS command arguments -- port_id, FC-4 types */</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>

	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>			<span class="cm">/* FCP-3 */</span>

	<span class="cm">/* Execute SNS command. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_send_sns</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span> <span class="n">RFT_ID_SNS_CMD_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2060</span><span class="p">,</span>
		    <span class="s">&quot;RFT_ID Send SNS failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rft_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">||</span>
	    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rft_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2083</span><span class="p">,</span>
		    <span class="s">&quot;RFT_ID failed, rejected request rft_rsp:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2080</span><span class="p">,</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rft_data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2073</span><span class="p">,</span>
		    <span class="s">&quot;RFT_ID exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_sns_rnn_id() - SNS Register Node Name (RNN_ID) of the HBA.</span>
<span class="cm"> * HBA.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * This command uses the old Exectute SNS Command mailbox routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_sns_rnn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sns_cmd_pkt</span>	<span class="o">*</span><span class="n">sns_cmd</span><span class="p">;</span>

	<span class="cm">/* Issue RNN_ID. */</span>
	<span class="cm">/* Prepare SNS command request. */</span>
	<span class="n">sns_cmd</span> <span class="o">=</span> <span class="n">qla2x00_prep_sns_cmd</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">RNN_ID_CMD</span><span class="p">,</span> <span class="n">RNN_ID_SNS_SCMD_LEN</span><span class="p">,</span>
	    <span class="n">RNN_ID_SNS_DATA_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare SNS command arguments -- port_id, nodename. */</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>

	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Execute SNS command. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_send_sns</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sns_cmd_dma</span><span class="p">,</span> <span class="n">RNN_ID_SNS_CMD_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sns_cmd_pkt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x204a</span><span class="p">,</span>
		    <span class="s">&quot;RNN_ID Send SNS failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rnn_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">||</span>
	    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rnn_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x207b</span><span class="p">,</span>
		    <span class="s">&quot;RNN_ID failed, rejected request, rnn_rsp:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x207c</span><span class="p">,</span>
		    <span class="n">sns_cmd</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rnn_data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x204c</span><span class="p">,</span>
		    <span class="s">&quot;RNN_ID exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_mgmt_svr_login() - Login to fabric Management Service.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_mgmt_svr_login</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_login</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	    <span class="mh">0xfa</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">BIT_1</span><span class="o">|</span><span class="n">BIT_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span> <span class="o">||</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_MEMORY_ALLOC_FAILED</span><span class="p">)</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2085</span><span class="p">,</span>
			    <span class="s">&quot;Failed management_server login: loopid=%x &quot;</span>
			    <span class="s">&quot;rval=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2024</span><span class="p">,</span>
			    <span class="s">&quot;Failed management_server login: loopid=%x &quot;</span>
			    <span class="s">&quot;mb[0]=%x mb[1]=%x mb[2]=%x mb[6]=%x mb[7]=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
			    <span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">management_server_logged_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_ms_fdmi_iocb() - Prepare common MS IOCB fields for FDMI query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @req_size: request size in bytes</span>
<span class="cm"> * @rsp_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the @ha&#39;s ms_iocb.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_ms_fdmi_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_size</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ms_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>

	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MS_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">SET_TARGET_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CF_READ</span> <span class="o">|</span> <span class="n">CF_HEAD_TAG</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">total_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">rsp_bytecount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rsp_size</span><span class="p">);</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>

	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_length</span> <span class="o">=</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span><span class="p">;</span>

	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_rsp_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_rsp_length</span> <span class="o">=</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">rsp_bytecount</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ms_pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla24xx_prep_ms_fdmi_iocb() - Prepare common MS IOCB fields for FDMI query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @req_size: request size in bytes</span>
<span class="cm"> * @rsp_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the @ha&#39;s ms_iocb.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">qla24xx_prep_ms_fdmi_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_size</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="n">ct_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ct_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span><span class="p">));</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rsp_size</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span><span class="p">;</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ct_pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ms_iocb_entry_t</span> <span class="o">*</span>
<span class="nf">qla2x00_update_ms_fdmi_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="n">ct_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>
		<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>
		<span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">dseg_req_length</span> <span class="o">=</span> <span class="n">ms_pkt</span><span class="o">-&gt;</span><span class="n">req_bytecount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ms_pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_prep_ct_req() - Prepare common CT request fields for SNS query.</span>
<span class="cm"> * @ct_req: CT request buffer</span>
<span class="cm"> * @cmd: GS command</span>
<span class="cm"> * @rsp_size: response size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the intitialized @ct_req.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span>
<span class="nf">qla2x00_prep_ct_fdmi_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_pkt</span><span class="p">));</span>

	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">gs_type</span> <span class="o">=</span> <span class="mh">0xFA</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">gs_subtype</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">max_rsp_size</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">((</span><span class="n">rsp_size</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ct_req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_fdmi_rhba() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_fdmi_rhba</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">alen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">sn</span><span class="p">;</span>

	<span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span> <span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="n">eiter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Issue RHBA */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="cm">/*   Request size adjusted after CT preparation */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_fdmi_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RHBA_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_fdmi_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">RHBA_CMD</span><span class="p">,</span>
	    <span class="n">RHBA_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare FDMI command arguments -- attribute block, attributes. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">entry_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">WWN_SIZE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Attributes */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">attrs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_HBA_ATTR_COUNT</span><span class="p">);</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">;</span>

	<span class="cm">/* Nodename. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_NODE_NAME</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">WWN_SIZE</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2025</span><span class="p">,</span>
	    <span class="s">&quot;NodeName = %02x%02x%02x%02x%02x%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">node_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="cm">/* Manufacturer. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_MANUFACTURER</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">manufacturer</span><span class="p">,</span> <span class="s">&quot;QLogic Corporation&quot;</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">manufacturer</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2026</span><span class="p">,</span>
	    <span class="s">&quot;Manufacturer = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">manufacturer</span><span class="p">);</span>

	<span class="cm">/* Serial number. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_SERIAL_NUMBER</span><span class="p">);</span>
	<span class="n">sn</span> <span class="o">=</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial0</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial1</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="s">&quot;%c%05d&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">sn</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">sn</span> <span class="o">%</span> <span class="mi">100000</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">serial_num</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">,</span>
	    <span class="s">&quot;Serial no. = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">serial_num</span><span class="p">);</span>

	<span class="cm">/* Model name. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_MODEL</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">model</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2028</span><span class="p">,</span>
	    <span class="s">&quot;Model Name = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">model</span><span class="p">);</span>

	<span class="cm">/* Model description. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_MODEL_DESCRIPTION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">model_desc</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">model_desc</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2029</span><span class="p">,</span>
	    <span class="s">&quot;Model Desc = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">model_desc</span><span class="p">);</span>

	<span class="cm">/* Hardware version. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_HARDWARE_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">hw_version</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapter_id</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">hw_version</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x202a</span><span class="p">,</span>
	    <span class="s">&quot;Hardware ver = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">hw_version</span><span class="p">);</span>

	<span class="cm">/* Driver version. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">qla2x00_version_str</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">driver_version</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x202b</span><span class="p">,</span>
	    <span class="s">&quot;Driver ver = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">driver_version</span><span class="p">);</span>

	<span class="cm">/* Option ROM version. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_OPTION_ROM_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">orom_version</span><span class="p">,</span> <span class="s">&quot;0.00&quot;</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">orom_version</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span> <span class="p">,</span> <span class="mh">0x202c</span><span class="p">,</span>
	    <span class="s">&quot;Optrom vers = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">orom_version</span><span class="p">);</span>

	<span class="cm">/* Firmware version */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_hba_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_FIRMWARE_VERSION</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_version_str</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fw_version</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fw_version</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x202d</span><span class="p">,</span>
	    <span class="s">&quot;Firmware vers = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fw_version</span><span class="p">);</span>

	<span class="cm">/* Update MS request size. */</span>
	<span class="n">qla2x00_update_ms_fdmi_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x202e</span><span class="p">,</span>
	    <span class="s">&quot;RHBA identifier = &quot;</span>
	    <span class="s">&quot;%02x%02x%02x%02x%02x%02x%02x%02x size=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_identifier</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2076</span><span class="p">,</span>
	    <span class="n">entries</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2030</span><span class="p">,</span>
		    <span class="s">&quot;RHBA issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;RHBA&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">CT_REASON_CANNOT_PERFORM</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">explanation_code</span> <span class="o">==</span>
		    <span class="n">CT_EXPL_ALREADY_REGISTERED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2034</span><span class="p">,</span>
			    <span class="s">&quot;HBA already registered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ALREADY_REGISTERED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2035</span><span class="p">,</span>
		    <span class="s">&quot;RHBA exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_fdmi_dhba() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_fdmi_dhba</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span> <span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="cm">/* Issue RPA */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_fdmi_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">DHBA_REQ_SIZE</span><span class="p">,</span>
	    <span class="n">DHBA_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_fdmi_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">DHBA_CMD</span><span class="p">,</span>
	    <span class="n">DHBA_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare FDMI command arguments -- portname. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2036</span><span class="p">,</span>
	    <span class="s">&quot;DHBA portname = %02x%02x%02x%02x%02x%02x%02x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2037</span><span class="p">,</span>
		    <span class="s">&quot;DHBA issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;DHBA&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2038</span><span class="p">,</span>
		    <span class="s">&quot;DHBA exiting normally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_fdmi_rpa() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_fdmi_rpa</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">alen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_frame_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span> <span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span> <span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="n">eiter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="n">icb24</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">init_cb_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>

	<span class="cm">/* Issue RPA */</span>
	<span class="cm">/* Prepare common MS IOCB */</span>
	<span class="cm">/*   Request size adjusted after CT preparation */</span>
	<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_fdmi_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RPA_RSP_SIZE</span><span class="p">);</span>

	<span class="cm">/* Prepare CT request */</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_fdmi_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">RPA_CMD</span><span class="p">,</span>
	    <span class="n">RPA_RSP_SIZE</span><span class="p">);</span>
	<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* Prepare FDMI command arguments -- attribute block, attributes. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">WWN_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Attributes */</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">attrs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
	    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_ATTR_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">;</span>

	<span class="cm">/* FC4 types. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_FC4_TYPES</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fc4_types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2039</span><span class="p">,</span>
	    <span class="s">&quot;FC4_TYPES=%02x %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fc4_types</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fc4_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Supported speed. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_SUPPORT_SPEED</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sup_speed</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span>
		    <span class="n">FDMI_PORT_SPEED_10GB</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sup_speed</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span>
		    <span class="n">FDMI_PORT_SPEED_1GB</span><span class="o">|</span><span class="n">FDMI_PORT_SPEED_2GB</span><span class="o">|</span>
		    <span class="n">FDMI_PORT_SPEED_4GB</span><span class="o">|</span><span class="n">FDMI_PORT_SPEED_8GB</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sup_speed</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span>
		    <span class="n">FDMI_PORT_SPEED_1GB</span><span class="o">|</span><span class="n">FDMI_PORT_SPEED_2GB</span><span class="o">|</span>
		    <span class="n">FDMI_PORT_SPEED_4GB</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sup_speed</span> <span class="o">=</span><span class="n">__constant_cpu_to_be32</span><span class="p">(</span>
		    <span class="n">FDMI_PORT_SPEED_1GB</span><span class="o">|</span><span class="n">FDMI_PORT_SPEED_2GB</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sup_speed</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span>
		    <span class="n">FDMI_PORT_SPEED_1GB</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x203a</span><span class="p">,</span>
	    <span class="s">&quot;Supported_Speed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">sup_speed</span><span class="p">);</span>

	<span class="cm">/* Current speed. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_CURRENT_SPEED</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_1GB</span>:
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_1GB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_2GB</span>:
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_2GB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_4GB</span>:
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_4GB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_8GB</span>:
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_8GB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_10GB</span>:
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_10GB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_16GB</span>:
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_16GB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_SPEED_UNKNOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x203b</span><span class="p">,</span>
	    <span class="s">&quot;Current_Speed=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">cur_speed</span><span class="p">);</span>

	<span class="cm">/* Max frame size. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_MAX_FRAME_SIZE</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">icb24</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span><span class="p">)</span><span class="o">:</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="o">-&gt;</span><span class="n">frame_payload_size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">max_frame_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x203c</span><span class="p">,</span>
	    <span class="s">&quot;Max_Frame_Size=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">max_frame_size</span><span class="p">);</span>

	<span class="cm">/* OS device name. */</span>
	<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_OS_DEVICE_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">os_dev_name</span><span class="p">,</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">os_dev_name</span><span class="p">);</span>
	<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x204b</span><span class="p">,</span>
	    <span class="s">&quot;OS_Device_Name=%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">os_dev_name</span><span class="p">);</span>

	<span class="cm">/* Hostname. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">fc_host_system_hostname</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">attrs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
		    <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">FDMI_PORT_ATTR_COUNT</span><span class="p">);</span>
		<span class="n">eiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_fdmi_port_attr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_HOST_NAME</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">host_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">host_name</span><span class="p">),</span>
		    <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">fc_host_system_hostname</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
		<span class="n">alen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">host_name</span><span class="p">);</span>
		<span class="n">alen</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">alen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">eiter</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">alen</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x203d</span><span class="p">,</span>
		    <span class="s">&quot;HostName=%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eiter</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">host_name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update MS request size. */</span>
	<span class="n">qla2x00_update_ms_fdmi_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x203e</span><span class="p">,</span>
	    <span class="s">&quot;RPA portname= %02x%02x%02x%02x%02X%02x%02x%02x size=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
	    <span class="n">size</span><span class="p">);</span>
	<span class="n">ql_dump_buffer</span><span class="p">(</span><span class="n">ql_dbg_disc</span> <span class="o">+</span> <span class="n">ql_dbg_buffer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2079</span><span class="p">,</span>
	    <span class="n">entries</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Execute MS IOCB */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*EMPTY*/</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2040</span><span class="p">,</span>
		    <span class="s">&quot;RPA issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span> <span class="s">&quot;RPA&quot;</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2041</span><span class="p">,</span>
		    <span class="s">&quot;RPA exiting nornally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_fdmi_register() -</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_fdmi_register</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
       <span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mgmt_svr_login</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fdmi_rhba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_ALREADY_REGISTERED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fdmi_dhba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fdmi_rhba</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_fdmi_rpa</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_gfpn_id() - SNS Get Fabric Port Name (GFPN_ID) query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_gfpn_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IIDMA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue GFPN_ID */</span>
		<span class="cm">/* Prepare common MS IOCB */</span>
		<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GFPN_ID_REQ_SIZE</span><span class="p">,</span>
		    <span class="n">GFPN_ID_RSP_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare CT request */</span>
		<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFPN_ID_CMD</span><span class="p">,</span>
		    <span class="n">GFPN_ID_RSP_SIZE</span><span class="p">);</span>
		<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

		<span class="cm">/* Prepare CT arguments -- port_id */</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

		<span class="cm">/* Execute MS IOCB */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*EMPTY*/</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2023</span><span class="p">,</span>
			    <span class="s">&quot;GFPN_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span>
		    <span class="s">&quot;GFPN_ID&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Save fabric portname */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">,</span>
			    <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gfpn_id</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">WWN_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">qla24xx_prep_ms_fm_iocb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_size</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="n">ct_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ct_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_entry_24xx</span><span class="p">));</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">CT_IOCB_TYPE</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">nport_handle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">mgmt_svr_loop_id</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_dsd_count</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rsp_size</span><span class="p">);</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req_size</span><span class="p">);</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">cmd_byte_count</span><span class="p">;</span>

	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns_dma</span><span class="p">));</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">dseg_1_len</span> <span class="o">=</span> <span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">rsp_byte_count</span><span class="p">;</span>
	<span class="n">ct_pkt</span><span class="o">-&gt;</span><span class="n">vp_index</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ct_pkt</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span>
<span class="nf">qla24xx_prep_ct_fm_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_req</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd</span><span class="p">,</span>
    <span class="kt">uint16_t</span> <span class="n">rsp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_sns_pkt</span><span class="p">));</span>

	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">gs_type</span> <span class="o">=</span> <span class="mh">0xFA</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">gs_subtype</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">max_rsp_size</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">((</span><span class="n">rsp_size</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ct_req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_gpsc() - FCS Get Port Speed Capabilities (GPSC) query.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla2x00_gpsc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IIDMA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">gpsc_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_mgmt_svr_login</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue GFPN_ID */</span>
		<span class="cm">/* Prepare common MS IOCB */</span>
		<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">qla24xx_prep_ms_fm_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GPSC_REQ_SIZE</span><span class="p">,</span>
		    <span class="n">GPSC_RSP_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare CT request */</span>
		<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla24xx_prep_ct_fm_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
		    <span class="n">GPSC_CMD</span><span class="p">,</span> <span class="n">GPSC_RSP_SIZE</span><span class="p">);</span>
		<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

		<span class="cm">/* Prepare CT arguments -- port_name */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">gpsc</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">,</span>
		    <span class="n">WWN_SIZE</span><span class="p">);</span>

		<span class="cm">/* Execute MS IOCB */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*EMPTY*/</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x2059</span><span class="p">,</span>
			    <span class="s">&quot;GPSC issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span>
		    <span class="s">&quot;GPSC&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FM command unsupported? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_INVALID_COMMAND</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">==</span>
				<span class="n">CT_REASON_INVALID_COMMAND_CODE</span> <span class="o">||</span>
			     <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">==</span>
				<span class="n">CT_REASON_COMMAND_UNSUPPORTED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x205a</span><span class="p">,</span>
				    <span class="s">&quot;GPSC command unsupported, disabling &quot;</span>
				    <span class="s">&quot;query.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">gpsc_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Save port-speed */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gpsc</span><span class="p">.</span><span class="n">speed</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">BIT_15</span>:
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">PORT_SPEED_1GB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BIT_14</span>:
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">PORT_SPEED_2GB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BIT_13</span>:
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">PORT_SPEED_4GB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BIT_12</span>:
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">PORT_SPEED_10GB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BIT_11</span>:
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp_speed</span> <span class="o">=</span> <span class="n">PORT_SPEED_8GB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x205b</span><span class="p">,</span>
			    <span class="s">&quot;GPSC ext entry - fpn &quot;</span>
			    <span class="s">&quot;%02x%02x%02x%02x%02x%02x%02x%02x speeds=%04x &quot;</span>
			    <span class="s">&quot;speed=%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fabric_port_name</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gpsc</span><span class="p">.</span><span class="n">speeds</span><span class="p">),</span>
			    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gpsc</span><span class="p">.</span><span class="n">speed</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla2x00_gff_id() - SNS Get FC-4 Features (GFF_ID) query.</span>
<span class="cm"> *</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> * @list: switch info entries to populate</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla2x00_gff_id</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="n">sw_info_t</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">ms_iocb_entry_t</span>	<span class="o">*</span><span class="n">ms_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_req</span>	<span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_sns_rsp</span>	<span class="o">*</span><span class="n">ct_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">fcp_scsi_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_fibre_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set default FC4 Type as UNKNOWN so the default is to</span>
<span class="cm">		 * Process this port */</span>
		<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fc4_type</span> <span class="o">=</span> <span class="n">FC4_TYPE_UNKNOWN</span><span class="p">;</span>

		<span class="cm">/* Do not attempt GFF_ID if we are not FWI_2 capable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Prepare common MS IOCB */</span>
		<span class="n">ms_pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">prep_ms_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">GFF_ID_REQ_SIZE</span><span class="p">,</span>
		    <span class="n">GFF_ID_RSP_SIZE</span><span class="p">);</span>

		<span class="cm">/* Prepare CT request */</span>
		<span class="n">ct_req</span> <span class="o">=</span> <span class="n">qla2x00_prep_ct_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFF_ID_CMD</span><span class="p">,</span>
		    <span class="n">GFF_ID_RSP_SIZE</span><span class="p">);</span>
		<span class="n">ct_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ct_sns</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

		<span class="cm">/* Prepare CT arguments -- port_id */</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">port_id</span><span class="p">.</span><span class="n">port_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>

		<span class="cm">/* Execute MS IOCB */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_issue_iocb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_iocb_dma</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_iocb_entry_t</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x205c</span><span class="p">,</span>
			    <span class="s">&quot;GFF_ID issue IOCB failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_chk_ms_status</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ms_pkt</span><span class="p">,</span> <span class="n">ct_rsp</span><span class="p">,</span>
			       <span class="s">&quot;GFF_ID&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_disc</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x205d</span><span class="p">,</span>
			    <span class="s">&quot;GFF_ID IOCB status had a failure status code.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fcp_scsi_features</span> <span class="o">=</span>
			   <span class="n">ct_rsp</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">gff_id</span><span class="p">.</span><span class="n">fc4_features</span><span class="p">[</span><span class="n">GFF_FCP_SCSI_OFFSET</span><span class="p">];</span>
			<span class="n">fcp_scsi_features</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fcp_scsi_features</span><span class="p">)</span>
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fc4_type</span> <span class="o">=</span> <span class="n">FC4_TYPE_FCP_SCSI</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fc4_type</span> <span class="o">=</span> <span class="n">FC4_TYPE_OTHER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Last device exit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">rsvd_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
