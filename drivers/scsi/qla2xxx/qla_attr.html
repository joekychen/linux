<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_attr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_attr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &quot;qla_target.h&quot;</span>

<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla24xx_vport_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="p">,</span> <span class="n">bool</span><span class="p">);</span>

<span class="cm">/* SYSFS attributes --------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_fw_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_reading</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">-=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">,</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_write_fw_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reading</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">reading</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reading</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_reading</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x705d</span><span class="p">,</span>
		    <span class="s">&quot;Firmware dump cleared on (%ld).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla82xx_md_free</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">qla82xx_md_prep</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_reading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_reading</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_reading</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x705e</span><span class="p">,</span>
			    <span class="s">&quot;Raw firmware dump ready for read on (%ld).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">qla2x00_alloc_fw_dump</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla82xx_set_reset_owner</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">qla2x00_system_error</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">)</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x705b</span><span class="p">,</span>
				    <span class="s">&quot;MiniDump supported with this firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x709d</span><span class="p">,</span>
				    <span class="s">&quot;MiniDump not supported with this firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_fw_dump_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fw_dump&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_fw_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_write_fw_dump</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOCACHE_VPD_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_nvram</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_write_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">write_nvram</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Checksum NVRAM. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">chksum</span><span class="p">;</span>

		<span class="n">iter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
			<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="o">++</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="o">~</span><span class="n">chksum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chksum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">chksum</span><span class="p">;</span>

		<span class="n">iter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
			<span class="n">chksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">iter</span><span class="o">++</span><span class="p">;</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="o">~</span><span class="n">chksum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x705f</span><span class="p">,</span>
		    <span class="s">&quot;HBA not online, failing NVRAM update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write NVRAM. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">write_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_base</span><span class="p">,</span>
	    <span class="n">count</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7060</span><span class="p">,</span>
	    <span class="s">&quot;Setting ISP_ABORT_NEEDED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* NVRAM settings take effect immediately. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla2x00_wait_for_chip_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_nvram_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvram&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_nvram</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_write_nvram</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_optrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SREADING</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">,</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_write_optrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SWRITING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_optrom_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;optrom&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_optrom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_write_optrom</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_write_optrom_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">valid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d:%x:%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SREADING</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SWRITING</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">=</span> <span class="n">QLA_SWAITING</span><span class="p">;</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7061</span><span class="p">,</span>
		    <span class="s">&quot;Freeing flash region allocation -- 0x%x bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SWAITING</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">?</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">-</span> <span class="n">start</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">=</span> <span class="n">QLA_SREADING</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7062</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate memory for optrom retrieval &quot;</span>
			    <span class="s">&quot;(%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">=</span> <span class="n">QLA_SWAITING</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7063</span><span class="p">,</span>
			    <span class="s">&quot;HBA not online, failing NVRAM update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7064</span><span class="p">,</span>
		    <span class="s">&quot;Reading flash region -- 0x%x/0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SWAITING</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to be more restrictive on which FLASH regions are</span>
<span class="cm">		 * allowed to be updated via user-space.  Regions accessible</span>
<span class="cm">		 * via this method include:</span>
<span class="cm">		 *</span>
<span class="cm">		 * ISP21xx/ISP22xx/ISP23xx type boards:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 	0x000000 -&gt; 0x020000 -- Boot code.</span>
<span class="cm">		 *</span>
<span class="cm">		 * ISP2322/ISP24xx type boards:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 	0x000000 -&gt; 0x07ffff -- Boot code.</span>
<span class="cm">		 * 	0x080000 -&gt; 0x0fffff -- Firmware.</span>
<span class="cm">		 *</span>
<span class="cm">		 * ISP25xx type boards:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 	0x000000 -&gt; 0x07ffff -- Boot code.</span>
<span class="cm">		 * 	0x080000 -&gt; 0x0fffff -- Firmware.</span>
<span class="cm">		 * 	0x120000 -&gt; 0x12ffff -- VPD and HBA parameters.</span>
<span class="cm">		 */</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">==</span> <span class="n">OPTROM_SIZE_2300</span> <span class="o">&amp;&amp;</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">start</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span>
			<span class="o">||</span> <span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7065</span><span class="p">,</span>
			    <span class="s">&quot;Invalid start region 0x%x/0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">?</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_size</span> <span class="o">-</span> <span class="n">start</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">=</span> <span class="n">QLA_SWRITING</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7066</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate memory for optrom update &quot;</span>
			    <span class="s">&quot;(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">=</span> <span class="n">QLA_SWAITING</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7067</span><span class="p">,</span>
		    <span class="s">&quot;Staging flash region write -- 0x%x/0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_state</span> <span class="o">!=</span> <span class="n">QLA_SWRITING</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7068</span><span class="p">,</span>
			    <span class="s">&quot;HBA not online, failing flash update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7069</span><span class="p">,</span>
		    <span class="s">&quot;Writing flash region -- 0x%x/0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">write_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_buffer</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">optrom_region_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_optrom_ctl_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;optrom_ctl&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_write_optrom_ctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_vpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NOCACHE_VPD_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_optrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_vpd</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_write_vpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">tmp_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_size</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">write_nvram</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x706a</span><span class="p">,</span>
		    <span class="s">&quot;HBA not online, failing VPD update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write NVRAM. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">write_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_base</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">read_nvram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vpd_base</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* Update flash version information for 4Gb &amp; above. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tmp_data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x706b</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for VPD information update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">get_flash_version</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">tmp_data</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_vpd_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vpd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_vpd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_write_vpd</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_sfp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">SFP_DEV_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_read</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x706c</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for SFP read-data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">do_read:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SFP_BLOCK_SIZE</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">SFP_DEV_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">SFP_BLOCK_SIZE</span><span class="p">;</span>
	    <span class="n">iter</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">SFP_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Skip to next device address. */</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="mh">0xa2</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_read_sfp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data_dma</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">,</span>
		    <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SFP_BLOCK_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x706d</span><span class="p">,</span>
			    <span class="s">&quot;Unable to read SFP data (%x/%x/%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span>
			    <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sfp_data</span><span class="p">,</span> <span class="n">SFP_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">SFP_BLOCK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_sfp_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sfp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SFP_DEV_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_sfp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_write_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x2025c</span>:
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x706e</span><span class="p">,</span>
		    <span class="s">&quot;Issuing ISP reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_no_md_cap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla82xx_set_reset_owner</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">qla2x00_wait_for_chip_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2025d</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x706f</span><span class="p">,</span>
		    <span class="s">&quot;Issuing MPI reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Make sure FC side is not in reset */</span>
		<span class="n">qla2x00_wait_for_hba_online</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

		<span class="cm">/* Issue MPI reset */</span>
		<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla81xx_restart_mpi_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7070</span><span class="p">,</span>
			    <span class="s">&quot;MPI reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2025e</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA82XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">vha</span> <span class="o">!=</span> <span class="n">base_vha</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7071</span><span class="p">,</span>
			    <span class="s">&quot;FCoE ctx reset no supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7072</span><span class="p">,</span>
		    <span class="s">&quot;Issuing FCoE ctx reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">qla2xxx_wake_dpc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">qla2x00_wait_for_fcoe_ctx_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_reset_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_write_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_xgmac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">actual_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">XGMAC_DATA_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_read</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">XGMAC_DATA_SIZE</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7076</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for XGMAC read-data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">do_read:</span>
	<span class="n">actual_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XGMAC_DATA_SIZE</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_xgmac_stats</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data_dma</span><span class="p">,</span>
	    <span class="n">XGMAC_DATA_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7077</span><span class="p">,</span>
		    <span class="s">&quot;Unable to read XGMAC data (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">actual_size</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="o">?</span> <span class="n">count</span><span class="o">:</span> <span class="n">actual_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">xgmac_data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_xgmac_stats_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xgmac_stats&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_xgmac_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_sysfs_read_dcbx_tlv</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">)));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">actual_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">DCBX_TLV_DATA_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_read</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DCBX_TLV_DATA_SIZE</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7078</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for DCBX TLV read-data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">do_read:</span>
	<span class="n">actual_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DCBX_TLV_DATA_SIZE</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_dcbx_params</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv_dma</span><span class="p">,</span>
	    <span class="n">DCBX_TLV_DATA_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7079</span><span class="p">,</span>
		    <span class="s">&quot;Unable to read DCBX TLV (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcbx_tlv</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">sysfs_dcbx_tlv_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dcbx_tlv&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qla2x00_sysfs_read_dcbx_tlv</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysfs_entry</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is4GBp_only</span><span class="p">;</span>
<span class="p">}</span> <span class="n">bin_file_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;fw_dump&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_fw_dump_attr</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;nvram&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_nvram_attr</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;optrom&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_optrom_attr</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;optrom_ctl&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_optrom_ctl_attr</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vpd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_vpd_attr</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sfp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_sfp_attr</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_reset_attr</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;xgmac_stats&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_xgmac_stats_attr</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dcbx_tlv&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysfs_dcbx_tlv_attr</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">qla2x00_alloc_sysfs_attr</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sysfs_entry</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="n">bin_file_entries</span><span class="p">;</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">is4GBp_only</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">is4GBp_only</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">is4GBp_only</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
		    <span class="n">iter</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00f3</span><span class="p">,</span>
			    <span class="s">&quot;Unable to create sysfs %s binary attribute (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">iter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00f4</span><span class="p">,</span>
			    <span class="s">&quot;Successfully created sysfs %s binary attribure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">iter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla2x00_free_sysfs_attr</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sysfs_entry</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="n">bin_file_entries</span><span class="p">;</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">is4GBp_only</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">is4GBp_only</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">is4GBp_only</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
		    <span class="n">iter</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">beacon_off</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Scsi_Host attributes. */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_drvr_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qla2x00_version_str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_fw_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fw_str</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fw_version_str</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fw_str</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_serial_num_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla2xxx_get_vpd_field</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="s">&quot;SN&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sn</span> <span class="o">=</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial0</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%c%05d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">sn</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">,</span>
	    <span class="n">sn</span> <span class="o">%</span> <span class="mi">100000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_isp_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;ISP%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_isp_id_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%04x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_model_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_model_desc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model_desc</span> <span class="o">?</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model_desc</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_pci_info_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">char</span> <span class="n">pci_info</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">pci_info_str</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">pci_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_link_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DOWN</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DEAD</span> <span class="o">||</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_NO_CABLE</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;Link Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOOP_READY</span> <span class="o">||</span>
	    <span class="n">qla2x00_reset_active</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;Unknown Link State</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;Link Up - &quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">current_topology</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISP_CFG_NL</span>:
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISP_CFG_FL</span>:
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;FL_Port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISP_CFG_N</span>:
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			    <span class="s">&quot;N_Port to N_Port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISP_CFG_F</span>:
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;F_Port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_zio_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">zio_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLA_ZIO_MODE_6</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Mode 6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLA_ZIO_DISABLED</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_zio_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">zio_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ZIO_SUPPORTED</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">zio_mode</span> <span class="o">=</span> <span class="n">QLA_ZIO_MODE_6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zio_mode</span> <span class="o">=</span> <span class="n">QLA_ZIO_DISABLED</span><span class="p">;</span>

	<span class="cm">/* Update per-hba values and queue a reset. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zio_mode</span> <span class="o">!=</span> <span class="n">QLA_ZIO_DISABLED</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">!=</span> <span class="n">QLA_ZIO_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">zio_mode</span> <span class="o">=</span> <span class="n">zio_mode</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_zio_timer_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d us</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_zio_timer_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">zio_timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">25500</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">zio_timer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">val</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">zio_timer</span> <span class="o">=</span> <span class="n">zio_timer</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_beacon_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_beacon_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2100</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_QLA2200</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x707a</span><span class="p">,</span>
		    <span class="s">&quot;Abort ISP active -- ignoring beacon request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">beacon_on</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">beacon_off</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_optrom_bios_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_optrom_efi_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">efi_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_optrom_fcode_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fcode_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_optrom_fw_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d.%02d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_revision</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_optrom_gold_fw_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA83XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d.%02d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">gold_fw_version</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_total_isp_aborts_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">total_isp_aborts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla24xx_84xx_fw_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA84XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">op_fw_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla84xx_verify_chip</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cs84xx</span><span class="o">-&gt;</span><span class="n">op_fw_version</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_mpi_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d.%02d (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_version</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mpi_capabilities</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_phy_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_QLA81XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_QLA8031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_flash_block_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_vlan_id_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vlan_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_vn_port_mac_address_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">fcoe_vn_port_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_fabric_param_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">switch_cap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_thermal_temp_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">temp</span><span class="p">,</span> <span class="n">frac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">thermal_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_reset_active</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x707b</span><span class="p">,</span>
		    <span class="s">&quot;ISP reset active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_thermal_temp</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">frac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla2x00_fw_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla2x00_reset_active</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x707c</span><span class="p">,</span>
		    <span class="s">&quot;ISP reset active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_firmware_state</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%x 0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_drvr_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_fw_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_serial_num_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">isp_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_isp_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">isp_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_isp_id_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_model_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model_desc</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_model_desc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pci_info</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_pci_info_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">link_state</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_link_state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">zio</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">qla2x00_zio_show</span><span class="p">,</span> <span class="n">qla2x00_zio_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">zio_timer</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">qla2x00_zio_timer_show</span><span class="p">,</span>
		   <span class="n">qla2x00_zio_timer_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">qla2x00_beacon_show</span><span class="p">,</span>
		   <span class="n">qla2x00_beacon_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">optrom_bios_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">qla2x00_optrom_bios_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">optrom_efi_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">qla2x00_optrom_efi_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">optrom_fcode_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">qla2x00_optrom_fcode_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">optrom_fw_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_optrom_fw_version_show</span><span class="p">,</span>
		   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">optrom_gold_fw_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">qla2x00_optrom_gold_fw_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="mi">84</span><span class="n">xx_fw_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla24xx_84xx_fw_version_show</span><span class="p">,</span>
		   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">total_isp_aborts</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_total_isp_aborts_show</span><span class="p">,</span>
		   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mpi_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_mpi_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">phy_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_phy_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">flash_block_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_flash_block_size_show</span><span class="p">,</span>
		   <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vlan_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_vlan_id_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vn_port_mac_address</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">qla2x00_vn_port_mac_address_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fabric_param</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_fabric_param_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_fw_state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">thermal_temp</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">qla2x00_thermal_temp_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">qla2x00_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_driver_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fw_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_serial_num</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_isp_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_isp_id</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model_desc</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pci_info</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_link_state</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_zio</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_zio_timer</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_beacon</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_optrom_bios_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_optrom_efi_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_optrom_fcode_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_optrom_fw_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_84xx_fw_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_total_isp_aborts</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mpi_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_phy_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_flash_block_size</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vlan_id</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vn_port_mac_address</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fabric_param</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fw_state</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_optrom_gold_fw_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_thermal_temp</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Host attributes. */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_host_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_host_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_UNKNOWN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_data_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_1GB</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_2GB</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_2GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_4GB</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_4GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_8GB</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_8GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_10GB</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_SPEED_16GB</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_16GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_host_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPIV</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">current_topology</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_CFG_NL</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_LPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP_CFG_FL</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NLPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP_CFG_N</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_PTP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP_CFG_F</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">port_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_starget_node_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">node_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">&amp;&amp;</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_target_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">node_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fc_starget_node_name</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">node_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_starget_port_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">port_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">&amp;&amp;</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_target_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fc_starget_port_name</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">port_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_starget_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">port_id</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_fcports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">&amp;&amp;</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_target_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_id</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fc_starget_port_id</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_set_rport_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_dev_loss_tmo_callbk</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">rport_to_shost</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">fc_port_t</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Now that the rport has been deleted, set the fcport state to</span>
<span class="cm">	   FCS_DEVICE_DEAD */</span>
	<span class="n">qla2x00_set_fcport_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">FCS_DEVICE_DEAD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Transport has effectively &#39;deleted&#39; the rport, clear</span>
<span class="cm">	 * all local references.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">drport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">fc_port_t</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_terminate_rport_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_port_t</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">fc_port_t</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point all fcport&#39;s software-states are cleared.  Perform any</span>
<span class="cm">	 * final cleanup of firmware resources (PCBs and XCBs).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span> <span class="o">!=</span> <span class="n">FC_NO_LOOP_ID</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">fabric_logout</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span>
			    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">al_pa</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla2x00_port_logout</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">vha</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla2x00_issue_lip</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">qla2x00_loop_reset</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span>
<span class="nf">qla2x00_get_fc_host_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">stats_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">pfc_host_stat</span><span class="p">;</span>

	<span class="n">pfc_host_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fc_host_stat</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pfc_host_stat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_host_statistics</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">UNLOADING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x707d</span><span class="p">,</span>
		    <span class="s">&quot;Failed to allocate memory for stats.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_POOL_SIZE</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla24xx_get_isp_stats</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">stats_dma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_READY</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">qla2x00_reset_active</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Must be in a &#39;READY&#39; state for statistics retrieval. */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_link_status</span><span class="p">(</span><span class="n">base_vha</span><span class="p">,</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_id</span><span class="p">,</span>
						<span class="n">stats</span><span class="p">,</span> <span class="n">stats_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_free</span><span class="p">;</span>

	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">link_failure_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">link_fail_cnt</span><span class="p">;</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">loss_of_sync_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">loss_sync_cnt</span><span class="p">;</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">loss_of_signal_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">loss_sig_cnt</span><span class="p">;</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">prim_seq_protocol_err_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">prim_seq_err_cnt</span><span class="p">;</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">invalid_tx_word_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">inval_xmit_word_cnt</span><span class="p">;</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">invalid_crc_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">inval_crc_cnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FWI2_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">lip_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">lip_cnt</span><span class="p">;</span>
		<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_frames</span><span class="p">;</span>
		<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frames</span><span class="p">;</span>
		<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">dumped_frames</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">dumped_frames</span><span class="p">;</span>
		<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">nos_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nos_rcvd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">fcp_input_megabytes</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">input_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">pfc_host_stat</span><span class="o">-&gt;</span><span class="n">fcp_output_megabytes</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">qla_stats</span><span class="p">.</span><span class="n">output_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>

<span class="nl">done_free:</span>
        <span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">s_dma_pool</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">stats_dma</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">pfc_host_stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_host_symbolic_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">qla2x00_get_sym_node_name</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">shost</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_set_host_system_hostname</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">REGISTER_FDMI_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_host_fabric_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">node_name</span><span class="p">[</span><span class="n">WWN_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> \
		<span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">};</span>
	<span class="n">u64</span> <span class="n">fabric_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">node_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">SWITCH_FOUND</span><span class="p">)</span>
		<span class="n">fabric_name</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fabric_node_name</span><span class="p">);</span>

	<span class="n">fc_host_fabric_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">fabric_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla2x00_get_host_port_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_OFFLINE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LOOP_UPDATE</span>:
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_DIAGNOSTICS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOP_DOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
			<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_DIAGNOSTICS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_LINKDOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOP_DEAD</span>:
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_LINKDOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOP_READY</span>:
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_ONLINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">qos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">base_vha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla24xx_vport_create_req_sanity_check</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x707e</span><span class="p">,</span>
		    <span class="s">&quot;Vport sanity check failed, status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vha</span> <span class="o">=</span> <span class="n">qla24xx_create_vhost</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x707f</span><span class="p">,</span> <span class="s">&quot;Vport create host failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FC_VPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_OFFLINE</span><span class="p">);</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_state</span><span class="p">,</span> <span class="n">VP_FAILED</span><span class="p">);</span>

	<span class="cm">/* ready to create vport */</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7080</span><span class="p">,</span>
	    <span class="s">&quot;VP entry id %d assigned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>

	<span class="cm">/* initialized vport states */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DOWN</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_err_state</span><span class="o">=</span>  <span class="n">VP_ERR_PORTDWN</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_prev_err_state</span><span class="o">=</span>  <span class="n">VP_ERR_UNKWN</span><span class="p">;</span>
	<span class="cm">/* Check if physical ha port is Up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DOWN</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOOP_DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t retry or attempt login of this virtual port */</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7081</span><span class="p">,</span>
		    <span class="s">&quot;Vport loop state is not UP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">loop_state</span><span class="p">,</span> <span class="n">LOOP_DEAD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable</span><span class="p">)</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_LINKDOWN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_T10_PI_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ql2xenabledif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_attributes</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">difdix_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7082</span><span class="p">,</span>
			    <span class="s">&quot;Registered for DIF/DIX type 1 and 3 protection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql2xenabledif</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">prot</span> <span class="o">=</span> <span class="n">SHOST_DIX_TYPE0_PROTECTION</span><span class="p">;</span>
			<span class="n">scsi_host_set_prot</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			    <span class="n">prot</span> <span class="o">|</span> <span class="n">SHOST_DIF_TYPE1_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIF_TYPE2_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIF_TYPE3_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIX_TYPE1_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIX_TYPE2_PROTECTION</span>
			    <span class="o">|</span> <span class="n">SHOST_DIX_TYPE3_PROTECTION</span><span class="p">);</span>
			<span class="n">scsi_host_set_guard</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">SHOST_DIX_GUARD_CRC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">difdix_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host_with_dma</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7083</span><span class="p">,</span>
		    <span class="s">&quot;scsi_add_host failure for VP[%d].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">vport_create_failed_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize attributes */</span>
	<span class="n">fc_host_dev_loss_tmo</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>
	<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span>
		<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span>
		<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">base_vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">qlt_vport_create</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="n">qla24xx_vport_disable</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">disable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xc000</span><span class="p">,</span>
		    <span class="s">&quot;Request queue %p attached with &quot;</span>
		    <span class="s">&quot;VP[%d], cpu affinity =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">req</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">vport_queue</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ql2xmaxqueues</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">vport_queue</span><span class="p">;</span>
	<span class="cm">/* Create a request queue in QoS mode for the vport */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_npiv_size</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span>
					<span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qos</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">npiv_info</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">q_qos</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla25xx_create_req_que</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">qos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7084</span><span class="p">,</span>
			    <span class="s">&quot;Can&#39;t create request queue for VP[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xc001</span><span class="p">,</span>
			    <span class="s">&quot;Request Que:%d Q0s: %d) created for VP[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">,</span> <span class="n">qos</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7085</span><span class="p">,</span>
			    <span class="s">&quot;Request Que:%d Q0s: %d) created for VP[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">,</span> <span class="n">qos</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">ret</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">vport_queue:</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">vport_create_failed_2:</span>
	<span class="n">qla24xx_disable_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla24xx_deallocate_vp_id</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FC_VPORT_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_vport_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">id</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOOP_RESYNC_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FCPORT_UPDATE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">qla24xx_disable_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">delete_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Allow timer to run to drain queued items, when removing vp */</span>
	<span class="n">qla24xx_deallocate_vp_id</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla2x00_vp_stop_timer</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_user</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7086</span><span class="p">,</span>
		    <span class="s">&quot;Timer for the VP[%d] has stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* No pending activities shall be there on the vha now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xextended_error_logging</span> <span class="o">&amp;</span> <span class="n">ql_dbg_user</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">random32</span><span class="p">()</span><span class="o">%</span><span class="mi">10</span><span class="p">);</span>  <span class="cm">/* Just to see if something falls on</span>
<span class="cm">					* the net we have placed below */</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vref_count</span><span class="p">));</span>

	<span class="n">qla2x00_free_fcports</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cur_vport_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">vp_idx_map</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">vport_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cpu_affinity_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla25xx_delete_req_que</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7087</span><span class="p">,</span>
			    <span class="s">&quot;Queue delete failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x7088</span><span class="p">,</span> <span class="s">&quot;VP[%d] deleted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla24xx_vport_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span>
		<span class="n">qla24xx_disable_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qla24xx_enable_vp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">qla2xxx_transport_functions</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_host_port_id</span> <span class="o">=</span> <span class="n">qla2x00_get_host_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">qla2x00_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_type</span> <span class="o">=</span> <span class="n">qla2x00_get_host_port_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_symbolic_name</span> <span class="o">=</span> <span class="n">qla2x00_get_host_symbolic_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_host_system_hostname</span> <span class="o">=</span> <span class="n">qla2x00_set_host_system_hostname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_system_hostname</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_fabric_name</span> <span class="o">=</span> <span class="n">qla2x00_get_host_fabric_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">qla2x00_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">),</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_starget_node_name</span> <span class="o">=</span> <span class="n">qla2x00_get_starget_node_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_port_name</span> <span class="o">=</span> <span class="n">qla2x00_get_starget_port_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_port_id</span>  <span class="o">=</span> <span class="n">qla2x00_get_starget_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">qla2x00_set_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">issue_fc_host_lip</span> <span class="o">=</span> <span class="n">qla2x00_issue_lip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_loss_tmo_callbk</span> <span class="o">=</span> <span class="n">qla2x00_dev_loss_tmo_callbk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">terminate_rport_io</span> <span class="o">=</span> <span class="n">qla2x00_terminate_rport_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">qla2x00_get_fc_host_stats</span><span class="p">,</span>

	<span class="p">.</span><span class="n">vport_create</span> <span class="o">=</span> <span class="n">qla24xx_vport_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_disable</span> <span class="o">=</span> <span class="n">qla24xx_vport_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_delete</span> <span class="o">=</span> <span class="n">qla24xx_vport_delete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">qla24xx_bsg_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_timeout</span> <span class="o">=</span> <span class="n">qla24xx_bsg_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">qla2xxx_transport_vport_functions</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_host_port_id</span> <span class="o">=</span> <span class="n">qla2x00_get_host_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">qla2x00_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_type</span> <span class="o">=</span> <span class="n">qla2x00_get_host_port_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_symbolic_name</span> <span class="o">=</span> <span class="n">qla2x00_get_host_symbolic_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_host_system_hostname</span> <span class="o">=</span> <span class="n">qla2x00_set_host_system_hostname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_system_hostname</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_fabric_name</span> <span class="o">=</span> <span class="n">qla2x00_get_host_fabric_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">qla2x00_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_port</span> <span class="o">*</span><span class="p">),</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_starget_node_name</span> <span class="o">=</span> <span class="n">qla2x00_get_starget_node_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_port_name</span> <span class="o">=</span> <span class="n">qla2x00_get_starget_port_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_port_id</span>  <span class="o">=</span> <span class="n">qla2x00_get_starget_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">qla2x00_set_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">issue_fc_host_lip</span> <span class="o">=</span> <span class="n">qla2x00_issue_lip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_loss_tmo_callbk</span> <span class="o">=</span> <span class="n">qla2x00_dev_loss_tmo_callbk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">terminate_rport_io</span> <span class="o">=</span> <span class="n">qla2x00_terminate_rport_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">qla2x00_get_fc_host_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">qla24xx_bsg_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_timeout</span> <span class="o">=</span> <span class="n">qla24xx_bsg_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">qla2x00_init_host_attr</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_UNKNOWN</span><span class="p">;</span>

	<span class="n">fc_host_dev_loss_tmo</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_down_retry_count</span><span class="p">;</span>
	<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>
	<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">.</span><span class="n">enable_class_2</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">FC_COS_CLASS2</span><span class="o">|</span><span class="n">FC_COS_CLASS3</span><span class="p">)</span> <span class="o">:</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
	<span class="n">fc_host_max_npiv_vports</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_npiv_vports</span><span class="p">;</span>
	<span class="n">fc_host_npiv_vports_inuse</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cur_vport_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CNA_CAPABLE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA2031</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_16GBIT</span> <span class="o">|</span> <span class="n">FC_PORTSPEED_8GBIT</span> <span class="o">|</span>
		    <span class="n">FC_PORTSPEED_4GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA25XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_8GBIT</span> <span class="o">|</span> <span class="n">FC_PORTSPEED_4GBIT</span> <span class="o">|</span>
		    <span class="n">FC_PORTSPEED_2GBIT</span> <span class="o">|</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA24XX_TYPE</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_4GBIT</span> <span class="o">|</span> <span class="n">FC_PORTSPEED_2GBIT</span> <span class="o">|</span>
		    <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_QLA23XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_2GBIT</span> <span class="o">|</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
