<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla2xxx › qla_nx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qla_nx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic Fibre Channel HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2011 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla2xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;qla_def.h&quot;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>

<span class="cp">#define MASK(n)			((1ULL&lt;&lt;(n))-1)</span>
<span class="cp">#define MN_WIN(addr) (((addr &amp; 0x1fc0000) &gt;&gt; 1) | \</span>
<span class="cp">	((addr &gt;&gt; 25) &amp; 0x3ff))</span>
<span class="cp">#define OCM_WIN(addr) (((addr &amp; 0x1ff0000) &gt;&gt; 1) | \</span>
<span class="cp">	((addr &gt;&gt; 25) &amp; 0x3ff))</span>
<span class="cp">#define MS_WIN(addr) (addr &amp; 0x0ffc0000)</span>
<span class="cp">#define QLA82XX_PCI_MN_2M   (0)</span>
<span class="cp">#define QLA82XX_PCI_MS_2M   (0x80000)</span>
<span class="cp">#define QLA82XX_PCI_OCM0_2M (0xc0000)</span>
<span class="cp">#define VALID_OCM_ADDR(addr) (((addr) &amp; 0x3f800) != 0x3f800)</span>
<span class="cp">#define GET_MEM_OFFS_2M(addr) (addr &amp; MASK(18))</span>
<span class="cp">#define BLOCK_PROTECT_BITS 0x0F</span>

<span class="cm">/* CRB window related */</span>
<span class="cp">#define CRB_BLK(off)	((off &gt;&gt; 20) &amp; 0x3f)</span>
<span class="cp">#define CRB_SUBBLK(off)	((off &gt;&gt; 16) &amp; 0xf)</span>
<span class="cp">#define CRB_WINDOW_2M	(0x130060)</span>
<span class="cp">#define QLA82XX_PCI_CAMQM_2M_END	(0x04800800UL)</span>
<span class="cp">#define CRB_HI(off)	((qla82xx_crb_hub_agt[CRB_BLK(off)] &lt;&lt; 20) | \</span>
<span class="cp">			((off) &amp; 0xf0000))</span>
<span class="cp">#define QLA82XX_PCI_CAMQM_2M_BASE	(0x000ff800UL)</span>
<span class="cp">#define CRB_INDIRECT_2M	(0x1e0000UL)</span>

<span class="cp">#define MAX_CRB_XFORM 60</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crb_addr_xform</span><span class="p">[</span><span class="n">MAX_CRB_XFORM</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">qla82xx_crb_table_initialized</span><span class="p">;</span>

<span class="cp">#define qla82xx_crb_addr_transform(name) \</span>
<span class="cp">	(crb_addr_xform[QLA82XX_HW_PX_MAP_CRB_##name] = \</span>
<span class="cp">	QLA82XX_HW_CRB_HUB_AGT_ADR_##name &lt;&lt; 20)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla82xx_crb_addr_transform_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">XDMA</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">TIMR</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SRE</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN3</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN2</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS3</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS2</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX7</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX6</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX5</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX4</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX3</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX2</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">ROMUSB</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SN</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">QMN</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">QMS</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGNI</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGND</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN3</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN2</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGSI</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGSD</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS3</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS2</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PS</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">PH</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">NIU</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">I2Q</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">EG</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">MN</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">MS</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">CAS2</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">CAS1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">CAS0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">CAM</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">C2C1</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">C2C0</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">SMB</span><span class="p">);</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">OCM0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Used only in P3 just define it for P2 also.</span>
<span class="cm">	 */</span>
	<span class="n">qla82xx_crb_addr_transform</span><span class="p">(</span><span class="n">I2C0</span><span class="p">);</span>

	<span class="n">qla82xx_crb_table_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">crb_128M_2M_block_map</span> <span class="n">crb_128M_2M_map</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0100000</span><span class="p">,</span> <span class="mh">0x0102000</span><span class="p">,</span> <span class="mh">0x120000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0110000</span><span class="p">,</span> <span class="mh">0x0120000</span><span class="p">,</span> <span class="mh">0x130000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0120000</span><span class="p">,</span> <span class="mh">0x0122000</span><span class="p">,</span> <span class="mh">0x124000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0130000</span><span class="p">,</span> <span class="mh">0x0132000</span><span class="p">,</span> <span class="mh">0x126000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0140000</span><span class="p">,</span> <span class="mh">0x0142000</span><span class="p">,</span> <span class="mh">0x128000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0150000</span><span class="p">,</span> <span class="mh">0x0152000</span><span class="p">,</span> <span class="mh">0x12a000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0160000</span><span class="p">,</span> <span class="mh">0x0170000</span><span class="p">,</span> <span class="mh">0x110000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0170000</span><span class="p">,</span> <span class="mh">0x0172000</span><span class="p">,</span> <span class="mh">0x12e000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x01e0000</span><span class="p">,</span> <span class="mh">0x01e0800</span><span class="p">,</span> <span class="mh">0x122000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0200000</span><span class="p">,</span> <span class="mh">0x0210000</span><span class="p">,</span> <span class="mh">0x180000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0400000</span><span class="p">,</span> <span class="mh">0x0401000</span><span class="p">,</span> <span class="mh">0x169000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0500000</span><span class="p">,</span> <span class="mh">0x0510000</span><span class="p">,</span> <span class="mh">0x140000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0600000</span><span class="p">,</span> <span class="mh">0x0610000</span><span class="p">,</span> <span class="mh">0x1c0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0700000</span><span class="p">,</span> <span class="mh">0x0704000</span><span class="p">,</span> <span class="mh">0x1b8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="mh">0x0802000</span><span class="p">,</span> <span class="mh">0x170000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x08f0000</span><span class="p">,</span> <span class="mh">0x08f2000</span><span class="p">,</span> <span class="mh">0x172000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0900000</span><span class="p">,</span> <span class="mh">0x0902000</span><span class="p">,</span> <span class="mh">0x174000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x09f0000</span><span class="p">,</span> <span class="mh">0x09f2000</span><span class="p">,</span> <span class="mh">0x176000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0a00000</span><span class="p">,</span> <span class="mh">0x0a02000</span><span class="p">,</span> <span class="mh">0x178000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0af0000</span><span class="p">,</span> <span class="mh">0x0af2000</span><span class="p">,</span> <span class="mh">0x17a000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0b00000</span><span class="p">,</span> <span class="mh">0x0b02000</span><span class="p">,</span> <span class="mh">0x17c000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0bf0000</span><span class="p">,</span> <span class="mh">0x0bf2000</span><span class="p">,</span> <span class="mh">0x17e000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0c00000</span><span class="p">,</span> <span class="mh">0x0c04000</span><span class="p">,</span> <span class="mh">0x1d4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0d00000</span><span class="p">,</span> <span class="mh">0x0d04000</span><span class="p">,</span> <span class="mh">0x1a4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0e00000</span><span class="p">,</span> <span class="mh">0x0e04000</span><span class="p">,</span> <span class="mh">0x1a0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0f00000</span><span class="p">,</span> <span class="mh">0x0f01000</span><span class="p">,</span> <span class="mh">0x164000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="mh">0x1004000</span><span class="p">,</span> <span class="mh">0x1a8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1100000</span><span class="p">,</span> <span class="mh">0x1101000</span><span class="p">,</span> <span class="mh">0x160000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1200000</span><span class="p">,</span> <span class="mh">0x1201000</span><span class="p">,</span> <span class="mh">0x161000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1300000</span><span class="p">,</span> <span class="mh">0x1301000</span><span class="p">,</span> <span class="mh">0x162000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1400000</span><span class="p">,</span> <span class="mh">0x1401000</span><span class="p">,</span> <span class="mh">0x163000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1500000</span><span class="p">,</span> <span class="mh">0x1501000</span><span class="p">,</span> <span class="mh">0x165000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1600000</span><span class="p">,</span> <span class="mh">0x1601000</span><span class="p">,</span> <span class="mh">0x166000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1d00000</span><span class="p">,</span> <span class="mh">0x1d10000</span><span class="p">,</span> <span class="mh">0x190000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1e00000</span><span class="p">,</span> <span class="mh">0x1e01000</span><span class="p">,</span> <span class="mh">0x16a000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1f00000</span><span class="p">,</span> <span class="mh">0x1f10000</span><span class="p">,</span> <span class="mh">0x150000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2100000</span><span class="p">,</span> <span class="mh">0x2102000</span><span class="p">,</span> <span class="mh">0x120000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2110000</span><span class="p">,</span> <span class="mh">0x2120000</span><span class="p">,</span> <span class="mh">0x130000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2120000</span><span class="p">,</span> <span class="mh">0x2122000</span><span class="p">,</span> <span class="mh">0x124000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2130000</span><span class="p">,</span> <span class="mh">0x2132000</span><span class="p">,</span> <span class="mh">0x126000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2140000</span><span class="p">,</span> <span class="mh">0x2142000</span><span class="p">,</span> <span class="mh">0x128000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2150000</span><span class="p">,</span> <span class="mh">0x2152000</span><span class="p">,</span> <span class="mh">0x12a000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2160000</span><span class="p">,</span> <span class="mh">0x2170000</span><span class="p">,</span> <span class="mh">0x110000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2170000</span><span class="p">,</span> <span class="mh">0x2172000</span><span class="p">,</span> <span class="mh">0x12e000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2200000</span><span class="p">,</span> <span class="mh">0x2204000</span><span class="p">,</span> <span class="mh">0x1b0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2800000</span><span class="p">,</span> <span class="mh">0x2804000</span><span class="p">,</span> <span class="mh">0x1a4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2900000</span><span class="p">,</span> <span class="mh">0x2901000</span><span class="p">,</span> <span class="mh">0x16b000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2a00000</span><span class="p">,</span> <span class="mh">0x2a00400</span><span class="p">,</span> <span class="mh">0x1ac400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2b00000</span><span class="p">,</span> <span class="mh">0x2b00400</span><span class="p">,</span> <span class="mh">0x1ac800</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2c00000</span><span class="p">,</span> <span class="mh">0x2c00400</span><span class="p">,</span> <span class="mh">0x1acc00</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2d00000</span><span class="p">,</span> <span class="mh">0x2d00400</span><span class="p">,</span> <span class="mh">0x1ad000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2e00000</span><span class="p">,</span> <span class="mh">0x2e00400</span><span class="p">,</span> <span class="mh">0x1ad400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2f00000</span><span class="p">,</span> <span class="mh">0x2f00400</span><span class="p">,</span> <span class="mh">0x1ad800</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3000000</span><span class="p">,</span> <span class="mh">0x3000400</span><span class="p">,</span> <span class="mh">0x1adc00</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x3100000</span><span class="p">,</span> <span class="mh">0x3104000</span><span class="p">,</span> <span class="mh">0x1a8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3200000</span><span class="p">,</span> <span class="mh">0x3204000</span><span class="p">,</span> <span class="mh">0x1d4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3300000</span><span class="p">,</span> <span class="mh">0x3304000</span><span class="p">,</span> <span class="mh">0x1a0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3500000</span><span class="p">,</span> <span class="mh">0x3500400</span><span class="p">,</span> <span class="mh">0x1ac000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3600000</span><span class="p">,</span> <span class="mh">0x3600400</span><span class="p">,</span> <span class="mh">0x1ae000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3700000</span><span class="p">,</span> <span class="mh">0x3700400</span><span class="p">,</span> <span class="mh">0x1ae400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3800000</span><span class="p">,</span> <span class="mh">0x3804000</span><span class="p">,</span> <span class="mh">0x1d0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3900000</span><span class="p">,</span> <span class="mh">0x3904000</span><span class="p">,</span> <span class="mh">0x1b4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3a00000</span><span class="p">,</span> <span class="mh">0x3a04000</span><span class="p">,</span> <span class="mh">0x1d8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3d00000</span><span class="p">,</span> <span class="mh">0x3d04000</span><span class="p">,</span> <span class="mh">0x1dc000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3e00000</span><span class="p">,</span> <span class="mh">0x3e01000</span><span class="p">,</span> <span class="mh">0x167000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3f00000</span><span class="p">,</span> <span class="mh">0x3f01000</span><span class="p">,</span> <span class="mh">0x168000</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * top 12 bits of crb internal address (hub, agent)</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="n">qla82xx_crb_hub_agt</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PS</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_MN</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_MS</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SRE</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_NIU</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_QMN</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN3</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2Q</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_TIMR</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_ROMUSB</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN4</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_XDMA</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN3</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGND</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGNI</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS3</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGSI</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SN</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_EG</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PS</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_CAM</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_TIMR</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX3</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX4</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX5</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX6</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX7</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_XDMA</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2Q</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_ROMUSB</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX8</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX9</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_OCM0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SMB</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2C0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2C1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGNC</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Device states */</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">q_dev_state</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	 <span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Cold&quot;</span><span class="p">,</span>
	<span class="s">&quot;Initializing&quot;</span><span class="p">,</span>
	<span class="s">&quot;Ready&quot;</span><span class="p">,</span>
	<span class="s">&quot;Need Reset&quot;</span><span class="p">,</span>
	<span class="s">&quot;Need Quiescent&quot;</span><span class="p">,</span>
	<span class="s">&quot;Failed&quot;</span><span class="p">,</span>
	<span class="s">&quot;Quiescent&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">qdev_state</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">q_dev_state</span><span class="p">[</span><span class="n">dev_state</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In: &#39;off&#39; is offset from CRB space in 128M pci map</span>
<span class="cm"> * Out: &#39;off&#39; is 2M pci map addr</span>
<span class="cm"> * side effect: lock crb window</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_pci_set_crbwindow_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">win_read</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span> <span class="o">=</span> <span class="n">CRB_HI</span><span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>

	<span class="cm">/* Read back value to make sure write has gone through before trying</span>
<span class="cm">	 * to use it.</span>
<span class="cm">	 */</span>
	<span class="n">win_read</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb000</span><span class="p">,</span>
		    <span class="s">&quot;%s: Written crbwin (0x%x) &quot;</span>
		    <span class="s">&quot;!= Read crbwin (0x%x), off=0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span><span class="p">,</span> <span class="n">win_read</span><span class="p">,</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla82xx_pci_set_crbwindow</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u64</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/* See if we are currently pointing to the region we want to use next */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_CRB_PCIX_HOST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No need to change window. PCIX and PCIEregs are in both</span>
<span class="cm">		 * regs are in both windows.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_CRB_PCIX_HOST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_CRB_PCIX_HOST2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We are in first CRB window */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">curr_window</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">QLA82XX_CRB_PCIX_HOST2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_CRB_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We are in second CRB window */</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">off</span> <span class="o">-</span> <span class="n">QLA82XX_CRB_PCIX_HOST2</span> <span class="o">+</span> <span class="n">QLA82XX_CRB_PCIX_HOST</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">curr_window</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">off</span><span class="p">;</span>

		<span class="cm">/* We are in the QM or direct access</span>
<span class="cm">		 * register region - do nothing</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_PCI_DIRECT_CRB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_PCI_CAMQM_MAX</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* strange address given */</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb001</span><span class="p">,</span>
	    <span class="s">&quot;%s: Warning: unm_nic_pci_set_crbwindow &quot;</span>
	    <span class="s">&quot;called with an unknown address(%llx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_pci_get_crb_addr_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crb_128M_2M_sub_block_map</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_CRB_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_PCI_CAMQM</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_PCI_CAMQM_2M_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">-</span> <span class="n">QLA82XX_PCI_CAMQM</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">QLA82XX_PCI_CAMQM_2M_BASE</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">off</span> <span class="o">-=</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">;</span>

	<span class="cm">/* Try direct map */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crb_128M_2M_map</span><span class="p">[</span><span class="n">CRB_BLK</span><span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">)].</span><span class="n">sub_block</span><span class="p">[</span><span class="n">CRB_SUBBLK</span><span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">start_128M</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">end_128M</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">off</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="o">*</span><span class="n">off</span> <span class="o">+</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">start_2M</span> <span class="o">-</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">start_128M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Not in direct map, use crb window */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CRB_WIN_LOCK_TIMEOUT 100000000</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla82xx_crb_win_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* acquire semaphore3 from PCI HW block */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM7_LOCK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">CRB_WIN_LOCK_TIMEOUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_WIN_LOCK_ID</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_wr_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">qla82xx_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">qla82xx_crb_win_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_pci_set_crbwindow_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM7_UNLOCK</span><span class="p">));</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_rd_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">qla82xx_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">qla82xx_crb_win_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_pci_set_crbwindow_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM7_UNLOCK</span><span class="p">));</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IDC_LOCK_TIMEOUT 100000000</span>
<span class="kt">int</span> <span class="nf">qla82xx_idc_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* acquire semaphore5 from PCI HW block */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM5_LOCK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">IDC_LOCK_TIMEOUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Yield CPU */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_idc_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM5_UNLOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*  PCI Windowing for DDR regions.  */</span>
<span class="cp">#define QLA82XX_ADDR_IN_RANGE(addr, low, high) \</span>
<span class="cp">	(((addr) &lt;= (high)) &amp;&amp; ((addr) &gt;= (low)))</span>
<span class="cm">/*</span>
<span class="cm"> * check memory access boundary.</span>
<span class="cm"> * used by test agent. support ddr access only for now</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla82xx_pci_mem_bound_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">qla82xx_pci_set_window_warning_count</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla82xx_pci_set_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">window</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">win_read</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DDR network side */</span>
		<span class="n">window</span> <span class="o">=</span> <span class="n">MN_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddr_mn_window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">win_read</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">win_read</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">!=</span> <span class="n">window</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb003</span><span class="p">,</span>
			    <span class="s">&quot;%s: Written MNwin (0x%x) != Read MNwin (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">win_read</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLA82XX_PCI_DDR_NET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_OCM0</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_OCM0_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x00ff800</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff800</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb004</span><span class="p">,</span>
			    <span class="s">&quot;%s: QM access not handled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">window</span> <span class="o">=</span> <span class="n">OCM_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddr_mn_window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">win_read</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">);</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="p">((</span><span class="n">window</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">window</span> <span class="o">&amp;</span> <span class="mh">0x0FFFE0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">temp1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb005</span><span class="p">,</span>
			    <span class="s">&quot;%s: Written OCMwin (0x%x) != Read OCMwin (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">win_read</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLA82XX_PCI_OCM0_2M</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_QDR_NET</span><span class="p">,</span>
		<span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* QDR network side */</span>
		<span class="n">window</span> <span class="o">=</span> <span class="n">MS_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">qdr_sn_window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">win_read</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">window</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb006</span><span class="p">,</span>
			    <span class="s">&quot;%s: Written MSwin (0x%x) != Read MSwin (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">win_read</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLA82XX_PCI_QDR_NET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * peg gdb frequently accesses memory that doesn&#39;t exist,</span>
<span class="cm">		 * this limits the chit chat so debugging isn&#39;t slowed down.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qla82xx_pci_set_window_warning_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">qla82xx_pci_set_window_warning_count</span><span class="o">%</span><span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb007</span><span class="p">,</span>
			    <span class="s">&quot;%s: Warning:%s Unknown address range!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check if address is in the same windows as the previous access */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla82xx_pci_is_same_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">window</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>	<span class="n">qdr_max</span><span class="p">;</span>

	<span class="n">qdr_max</span> <span class="o">=</span> <span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">;</span>

	<span class="cm">/* DDR network side */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_OCM0</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_OCM0_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_OCM1</span><span class="p">,</span>
		<span class="n">QLA82XX_ADDR_OCM1_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_QDR_NET</span><span class="p">,</span> <span class="n">qdr_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* QDR network side */</span>
		<span class="n">window</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">-</span> <span class="n">QLA82XX_ADDR_QDR_NET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qdr_sn_window</span> <span class="o">==</span> <span class="n">window</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla82xx_pci_mem_read_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span>           <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span>             <span class="n">start</span><span class="p">;</span>
	<span class="kt">uint8_t</span>         <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">mem_page</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If attempting to access unknown address or straddle hw windows,</span>
<span class="cm">	 * do not access.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">qla82xx_pci_set_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">qla82xx_pci_is_same_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb008</span><span class="p">,</span>
		    <span class="s">&quot;%s out of bound pci memory &quot;</span>
		    <span class="s">&quot;access, offset is 0x%llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mem_page</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="cm">/* Map two pages whenever user tries to access addresses in two</span>
<span class="cm">	* consecutive pages.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_page</span> <span class="o">!=</span> <span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mem_ptr</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_pci_mem_write_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span>           <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span>             <span class="n">start</span><span class="p">;</span>
	<span class="kt">uint8_t</span>         <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">mem_page</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If attempting to access unknown address or straddle hw windows,</span>
<span class="cm">	 * do not access.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">qla82xx_pci_set_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">qla82xx_pci_is_same_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb009</span><span class="p">,</span>
		    <span class="s">&quot;%s out of bount memory &quot;</span>
		    <span class="s">&quot;access, offset is 0x%llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mem_page</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="cm">/* Map two pages whenever user tries to access addresses in two</span>
<span class="cm">	 * consecutive pages.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_page</span> <span class="o">!=</span> <span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">mem_ptr</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">writew</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">writeq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MTU_FUDGE_FACTOR 100</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla82xx_decode_crb_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pci_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla82xx_crb_table_initialized</span><span class="p">)</span>
		<span class="n">qla82xx_crb_addr_transform_setup</span><span class="p">();</span>

	<span class="n">pci_base</span> <span class="o">=</span> <span class="n">ADDR_ERROR</span><span class="p">;</span>
	<span class="n">base_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CRB_XFORM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crb_addr_xform</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_base</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_base</span> <span class="o">==</span> <span class="n">ADDR_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pci_base</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pci_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">rom_max_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">qla82xx_rom_lock_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_rom_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* acquire semaphore2 from PCI HW block */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM2_LOCK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">qla82xx_rom_lock_timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROM_LOCK_ID</span><span class="p">,</span> <span class="n">ROM_LOCK_DRIVER</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_rom_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM2_UNLOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_wait_rom_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_STATUS</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">&amp;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">rom_max_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb00a</span><span class="p">,</span>
			    <span class="s">&quot;%s: Timeout reached waiting for rom busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_wait_rom_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_STATUS</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">&amp;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">rom_max_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb00b</span><span class="p">,</span>
			    <span class="s">&quot;%s: Timeout reached waiting for rom done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_md_rw_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span>  <span class="n">off_value</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">),</span>
	    <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">));</span>

	<span class="cm">/* Read back value to make sure write has gone through */</span>
	<span class="n">RD_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
	<span class="n">off_value</span>  <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
		    <span class="p">(</span><span class="n">off_value</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">),</span>
		    <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
		    <span class="p">(</span><span class="n">off_value</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_do_rom_fast_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Dword reads to flash. */</span>
	<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_DIRECT_ROM_WINDOW</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_DIRECT_ROM_READ_BASE</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_rom_fast_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">qla82xx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b9</span><span class="p">,</span>
		    <span class="s">&quot;Failed to aquire SEM2 lock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_do_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">valp</span><span class="p">);</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_read_status_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="n">M25P_INSTR_RDSR</span><span class="p">);</span>
	<span class="n">qla82xx_wait_rom_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb00c</span><span class="p">,</span>
		    <span class="s">&quot;Error waiting for rom done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_RDATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_flash_wait_write_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ABYTE_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">done</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_read_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb00d</span><span class="p">,</span>
			    <span class="s">&quot;Timeout reached waiting for write finish.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_flash_set_write_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">qla82xx_wait_rom_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ABYTE_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="n">M25P_INSTR_WREN</span><span class="p">);</span>
	<span class="n">qla82xx_wait_rom_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_read_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_write_status_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_flash_set_write_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_WDATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb00e</span><span class="p">,</span>
		    <span class="s">&quot;Error waiting for rom done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qla82xx_flash_wait_write_finish</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_write_disable_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="n">M25P_INSTR_WRDI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb00f</span><span class="p">,</span>
		    <span class="s">&quot;Error waiting for rom done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ql82xx_rom_lock_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">qla82xx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb010</span><span class="p">,</span>
		    <span class="s">&quot;ROM lock failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_write_flash_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">flashaddr</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ql82xx_rom_lock_d</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb011</span><span class="p">,</span>
		    <span class="s">&quot;ROM lock failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_flash_set_write_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done_write</span><span class="p">;</span>

	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_WDATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ADDRESS</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ABYTE_CNT</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="n">M25P_INSTR_PP</span><span class="p">);</span>
	<span class="n">qla82xx_wait_rom_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb012</span><span class="p">,</span>
		    <span class="s">&quot;Error waiting for rom done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done_write</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_flash_wait_write_finish</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

<span class="nl">done_write:</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine does CRB initialize sequence</span>
<span class="cm"> *  to put the ISP into operational state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_pinit_from_rom</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">crb_addr_pair</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">crb_addr_pair</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* Halt all the indiviual PEGs and other blocks of the ISP */</span>
	<span class="n">qla82xx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* disable all I2Q */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* disable all niu interrupts */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* disable xge rx/tx */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x70000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable xg1 rx/tx */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x80000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable sideband mac */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x90000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable ap0 mac */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0xa0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable ap1 mac */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0xb0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* halt sre */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_SRE</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_SRE</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)));</span>

	<span class="cm">/* halt epg */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_EPG</span> <span class="o">+</span> <span class="mh">0x1300</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* halt timers */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* halt pegs */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_4</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* big hammer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="cm">/* don&#39;t reset CAM block on reset */</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0xfeffffff</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Read the signature value from the flash.</span>
<span class="cm">	 * Offset 0: Contain signature (0xcafecafe)</span>
<span class="cm">	 * Offset 4: Offset and number of addr/value pairs</span>
<span class="cm">	 * that present in CRB initialize sequence</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">!=</span> <span class="mh">0xcafecafeUL</span> <span class="o">||</span>
	    <span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span>
		    <span class="s">&quot;Error Reading crb_init area: n: %08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Offset in flash = lower 16 bits</span>
<span class="cm">	 * Number of entries = upper 16 bits</span>
<span class="cm">	 */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0xffffU</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffU</span><span class="p">;</span>

	<span class="cm">/* number of addr/value pair should not exceed 1024 entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span>  <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0071</span><span class="p">,</span>
		    <span class="s">&quot;Card flash not initialized:n=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span>
	    <span class="s">&quot;%d CRB init values found in ROM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crb_addr_pair</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x010c</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Translate internal CRB initialization</span>
<span class="cm">		 * address to PCI bus address</span>
<span class="cm">		 */</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">qla82xx_decode_crb_addr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">;</span>
		<span class="cm">/* Not all CRB  addr/value pair to be written,</span>
<span class="cm">		 * some of them are skipped</span>
<span class="cm">		 */</span>

		<span class="cm">/* skipping cold reboot MAGIC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* do not reset PCI */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">ROMUSB_GLB</span> <span class="o">+</span> <span class="mh">0xbc</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* skip core clock, so that firmware can increase the clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">ROMUSB_GLB</span> <span class="o">+</span> <span class="mh">0xc8</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* skip the function enable register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SETUP_FUNCTION</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SETUP_FUNCTION2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x0ff00000</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA82XX_CRB_SMB</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x0ff00000</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">ADDR_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0116</span><span class="p">,</span>
			    <span class="s">&quot;Unknow addr: 0x%08lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

		<span class="cm">/* ISP requires much bigger delay to settle down,</span>
<span class="cm">		 * else crb_window returns 0xffffffff</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="cm">/* ISP requires millisec delay between</span>
<span class="cm">		 * successive CRB register updation</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Resetting the data and instruction cache */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_D</span><span class="o">+</span><span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_D</span><span class="o">+</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_I</span><span class="o">+</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Clear all protocol processing engines */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_pci_mem_write_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">off0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shift_amount</span><span class="p">,</span> <span class="n">startword</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">off8</span><span class="p">,</span> <span class="n">mem_crb</span><span class="p">,</span> <span class="n">tmpw</span><span class="p">,</span> <span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * If not MN, go check for MS or invalid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_ADDR_QDR_NET</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;=</span> <span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">)</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_QDR_NET</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_pci_mem_bound_check</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qla82xx_pci_mem_write_direct</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			    <span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">off0</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">off0</span><span class="p">))</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">off0</span><span class="p">);</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">off8</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">;</span>
	<span class="n">loop</span> <span class="o">=</span> <span class="p">(((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">shift_amount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">startword</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_pci_mem_read_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off8</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift_amount</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale</span><span class="p">],</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpw</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="p">]</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">((</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">off0</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="p">]</span> <span class="o">|=</span> <span class="n">tmpw</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">off0</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">tmpw</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">off8</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift_amount</span><span class="p">);</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_WRDATA_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_WRDATA_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span>
		    <span class="n">MIU_TEST_AGT_WRDATA_UPPER_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span>
		    <span class="n">MIU_TEST_AGT_WRDATA_UPPER_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_WRITE</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_START</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_WRITE</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MIU_TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;failed to write through agent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_fw_load_from_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">flashaddr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flt_region_bootload</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">memaddr</span> <span class="o">=</span> <span class="n">BOOTLD_START</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMAGE_START</span> <span class="o">-</span> <span class="n">BOOTLD_START</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">low</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flashaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">high</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span> <span class="p">;</span>
		<span class="n">qla82xx_pci_mem_write_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">memaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">flashaddr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">memaddr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mh">0x1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0x80001e</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_pci_mem_read_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">off0</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span>	      <span class="n">shift_amount</span><span class="p">;</span>
	<span class="kt">uint32_t</span>      <span class="n">temp</span><span class="p">;</span>
	<span class="kt">uint64_t</span>      <span class="n">off8</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mem_crb</span><span class="p">,</span> <span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * If not MN, go check for MS or invalid.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_ADDR_QDR_NET</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;=</span> <span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">)</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_QDR_NET</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_pci_mem_bound_check</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qla82xx_pci_mem_read_direct</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			    <span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">off8</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">;</span>
	<span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">shift_amount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">loop</span> <span class="o">=</span> <span class="p">((</span><span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift_amount</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">off0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">off8</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift_amount</span><span class="p">);</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_START</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MIU_TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;failed to read through agent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">off0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">end</span>   <span class="o">=</span> <span class="p">(</span><span class="n">off0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_RDDATA</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
			<span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))))</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">qla82xx_uri_table_desc</span> <span class="o">*</span>
<span class="nf">qla82xx_get_table_desc</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">unirom</span><span class="p">,</span> <span class="kt">int</span> <span class="n">section</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_uri_table_desc</span> <span class="o">*</span><span class="n">directory</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_uri_table_desc</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tab_type</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">directory</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">directory</span><span class="o">-&gt;</span><span class="n">findex</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">directory</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">));</span>
		<span class="n">tab_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tab_type</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_uri_table_desc</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla82xx_uri_data_desc</span> <span class="o">*</span>
<span class="nf">qla82xx_get_data_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">section</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">unirom</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">file_prd_off</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_offset</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">qla82xx_uri_table_desc</span> <span class="o">*</span><span class="n">tab_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">tab_desc</span> <span class="o">=</span> <span class="n">qla82xx_get_table_desc</span><span class="p">(</span><span class="n">unirom</span><span class="p">,</span> <span class="n">section</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tab_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tab_desc</span><span class="o">-&gt;</span><span class="n">findex</span><span class="p">)</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tab_desc</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_uri_data_desc</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span>
<span class="nf">qla82xx_get_bootld_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">BOOTLD_START</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_uri_data_desc</span> <span class="o">*</span><span class="n">uri_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">==</span> <span class="n">QLA82XX_UNIFIED_ROMIMAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uri_desc</span> <span class="o">=</span> <span class="n">qla82xx_get_data_desc</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">QLA82XX_URI_DIR_SECT_BOOTLD</span><span class="p">,</span> <span class="n">QLA82XX_URI_BOOTLD_IDX_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uri_desc</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">uri_desc</span><span class="o">-&gt;</span><span class="n">findex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__le32</span>
<span class="nf">qla82xx_get_fw_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla82xx_uri_data_desc</span> <span class="o">*</span><span class="n">uri_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">==</span> <span class="n">QLA82XX_UNIFIED_ROMIMAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uri_desc</span> <span class="o">=</span>  <span class="n">qla82xx_get_data_desc</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_URI_DIR_SECT_FW</span><span class="p">,</span>
		    <span class="n">QLA82XX_URI_FIRMWARE_IDX_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uri_desc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">uri_desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">FW_SIZE_OFFSET</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span>
<span class="nf">qla82xx_get_fw_offs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">IMAGE_START</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_uri_data_desc</span> <span class="o">*</span><span class="n">uri_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">==</span> <span class="n">QLA82XX_UNIFIED_ROMIMAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uri_desc</span> <span class="o">=</span> <span class="n">qla82xx_get_data_desc</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_URI_DIR_SECT_FW</span><span class="p">,</span>
			<span class="n">QLA82XX_URI_FIRMWARE_IDX_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uri_desc</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">uri_desc</span><span class="o">-&gt;</span><span class="n">findex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* PCI related functions */</span>
<span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla82xx_pci_info_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcie_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">lwstr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">lnk</span><span class="p">;</span>

	<span class="n">pcie_reg</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_reg</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lnk</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lnk</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCIe (&quot;</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;2.5Gb/s &quot;</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">lwstr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lwstr</span><span class="p">),</span> <span class="s">&quot;x%d)&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_width</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">lwstr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla82xx_pci_region_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">region</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">QLA82XX_PCI_REG_MSIX_TBL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">control</span> <span class="o">+</span> <span class="n">QLA82XX_MSIX_TBL_SPACE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">qla82xx_iospace_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span>
		    <span class="s">&quot;Failed to reserver selected regions.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use MMIO operations for all accesses. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span>
		    <span class="s">&quot;Region #0 not an MMIO resource, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span>
		    <span class="s">&quot;Cannot remap pcibase MMIO, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mapping of IO base pointer */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_reg_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span> <span class="o">+</span>
	    <span class="mh">0xbc000</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql2xdbwr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">((</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)),</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log_pci</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span>
			    <span class="s">&quot;Cannot remap MMIO, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Mapping of IO base pointer,</span>
<span class="cm">		 * door bell read and write pointer</span>
<span class="cm">		 */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_rd_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">?</span>
			<span class="n">QLA82XX_CAMRAM_DB1</span> <span class="o">:</span>
			<span class="n">QLA82XX_CAMRAM_DB2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_rsp_queues</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_multiq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xc006</span><span class="p">,</span>
	    <span class="s">&quot;nx_pci_base=%p iobase=%p &quot;</span>
	    <span class="s">&quot;max_req_queues=%d msix_count=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">);</span>
	<span class="n">ql_dbg_pci</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span>
	    <span class="s">&quot;nx_pci_base=%p iobase=%p &quot;</span>
	    <span class="s">&quot;max_req_queues=%d msix_count=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">iospace_error_exit:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* GS related functions */</span>

<span class="cm">/* Initialization related functions */</span>

<span class="cm">/**</span>
<span class="cm"> * qla82xx_pci_config() - Setup ISP82xx PCI configuration registers.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm">*/</span>
<span class="kt">int</span>
<span class="nf">qla82xx_pci_config</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_mwi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span>
	    <span class="s">&quot;Chip revision:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">chip_revision</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla82xx_reset_chip() - Setup ISP82xx PCI configuration registers.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">qla82xx_reset_chip</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_config_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init_cb_81xx</span> <span class="o">*</span><span class="n">icb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Setup ring parameters in initialization control block. */</span>
	<span class="n">icb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">init_cb_81xx</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">init_cb</span><span class="p">;</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_outpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_inpointer</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">request_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">icb</span><span class="o">-&gt;</span><span class="n">response_q_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSD</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>

	<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qla2x00_try_to_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_fw_load_from_blob</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">ptr64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMAGE_START</span> <span class="o">-</span> <span class="n">BOOTLD_START</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ptr64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">qla82xx_get_bootld_offset</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">flashaddr</span> <span class="o">=</span> <span class="n">BOOTLD_START</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ptr64</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_pci_mem_write_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">flashaddr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flashaddr</span> <span class="o">=</span> <span class="n">FLASH_ADDR_START</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">qla82xx_get_fw_size</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ptr64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">qla82xx_get_fw_offs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ptr64</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_pci_mem_write_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">flashaddr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Write a magic value to CAMRAM register</span>
<span class="cm">	 * at a specified offset to indicate</span>
<span class="cm">	 * that all data is written and</span>
<span class="cm">	 * ready for firmware to initialize.</span>
<span class="cm">	 */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">),</span> <span class="n">QLA82XX_BDINFO_MAGIC</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0x80001e</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_set_product_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla82xx_uri_table_desc</span> <span class="o">*</span><span class="n">ptab_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">unirom</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">file_chiprev</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">chiprev</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">chip_revision</span><span class="p">;</span>
	<span class="cm">/* Hardcoding mn_present flag for P3P */</span>
	<span class="kt">int</span> <span class="n">mn_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flagbit</span><span class="p">;</span>

	<span class="n">ptab_desc</span> <span class="o">=</span> <span class="n">qla82xx_get_table_desc</span><span class="p">(</span><span class="n">unirom</span><span class="p">,</span>
		 <span class="n">QLA82XX_URI_DIR_SECT_PRODUCT_TBL</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptab_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ptab_desc</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ptab_desc</span><span class="o">-&gt;</span><span class="n">findex</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ptab_desc</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">));</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">QLA82XX_URI_FLAGS_OFF</span><span class="p">));</span>
		<span class="n">file_chiprev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unirom</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">QLA82XX_URI_CHIP_REV_OFF</span><span class="p">));</span>

		<span class="n">flagbit</span> <span class="o">=</span> <span class="n">mn_present</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">chiprev</span> <span class="o">==</span> <span class="n">file_chiprev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">flagbit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">file_prd_off</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_validate_firmware_blob</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">fw_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">min_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">=</span> <span class="n">fw_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_type</span> <span class="o">==</span> <span class="n">QLA82XX_UNIFIED_ROMIMAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_set_product_offset</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">min_size</span> <span class="o">=</span> <span class="n">QLA82XX_URI_FW_MIN_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">QLA82XX_FW_MAGIC_OFFSET</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">QLA82XX_BDINFO_MAGIC</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">min_size</span> <span class="o">=</span> <span class="n">QLA82XX_FW_MIN_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_check_cmdpeg_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHAN_INITIALIZE_COMPLETE</span>:
		<span class="k">case</span> <span class="n">PHAN_INITIALIZE_ACK</span>:
			<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHAN_INITIALIZE_FAILED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a8</span><span class="p">,</span>
		    <span class="s">&quot;CRB_CMDPEG_STATE: 0x%x and retries:0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">val</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">);</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a9</span><span class="p">,</span>
	    <span class="s">&quot;Cmd Peg initialization failed: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_PEGTUNE_DONE</span><span class="p">);</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">,</span> <span class="n">PHAN_INITIALIZE_FAILED</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_check_rcvpeg_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_RCVPEG_STATE</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHAN_INITIALIZE_COMPLETE</span>:
		<span class="k">case</span> <span class="n">PHAN_INITIALIZE_ACK</span>:
			<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHAN_INITIALIZE_FAILED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ab</span><span class="p">,</span>
		    <span class="s">&quot;CRB_RCVPEG_STATE: 0x%x and retries: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">val</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">);</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ac</span><span class="p">,</span>
	    <span class="s">&quot;Rcv Peg initializatin failed: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_RCVPEG_STATE</span><span class="p">,</span> <span class="n">PHAN_INITIALIZE_FAILED</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ISR related functions */</span>
<span class="kt">uint32_t</span> <span class="n">qla82xx_isr_int_target_mask_enable</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ISR_INT_TARGET_MASK</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_MASK_F1</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_MASK_F2</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_MASK_F3</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_MASK_F4</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_MASK_F5</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_MASK_F7</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_MASK_F7</span>
<span class="p">};</span>

<span class="kt">uint32_t</span> <span class="n">qla82xx_isr_int_target_status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ISR_INT_TARGET_STATUS</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F1</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F2</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F3</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F4</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F5</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F7</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F7</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla82xx_legacy_intr_set</span> <span class="n">legacy_intr</span><span class="p">[]</span> <span class="o">=</span> \
	<span class="n">QLA82XX_LEGACY_INTR_CONFIG</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * qla82xx_mbx_completion() - Process mailbox command completions.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @mb0: Mailbox0 register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_mbx_completion</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">mb0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Load return mailbox registers. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mb0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_count</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">wptr</span><span class="p">);</span>
		<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mcp</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5053</span><span class="p">,</span>
		    <span class="s">&quot;MBX pointer ERROR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla82xx_intr_handler() - Process interrupts for the ISP23xx and ISP63xx.</span>
<span class="cm"> * @irq:</span>
<span class="cm"> * @dev_id: SCSI driver HA context</span>
<span class="cm"> * @regs:</span>
<span class="cm"> *</span>
<span class="cm"> * Called by system whenever the host adapter generates an interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns handled flag.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span>
<span class="nf">qla82xx_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">iter</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span>	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xb053</span><span class="p">,</span>
		    <span class="s">&quot;%s: NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">int_vec_bit</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

		<span class="n">status1</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_STATE_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISR_IS_LEGACY_INTR_TRIGGERED</span><span class="p">(</span><span class="n">status1</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear the interrupt */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_status_reg</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* read twice to ensure write is flushed */</span>
	<span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>
	<span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">iter</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x1</span>:
			<span class="k">case</span> <span class="mh">0x2</span>:
			<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="k">case</span> <span class="mh">0x11</span>:
				<span class="n">qla82xx_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">));</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x12</span>:
				<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x13</span>:
				<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5054</span><span class="p">,</span>
				    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">);</span>

<span class="cp">#ifdef QL_DEBUG_LEVEL_17</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x503d</span><span class="p">,</span>
		    <span class="s">&quot;isr:status %x, cmd_flags %lx, mbox_int %x, stat %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MBX_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span>
<span class="nf">qla82xx_msix_default</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;%s(): NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x1</span>:
			<span class="k">case</span> <span class="mh">0x2</span>:
			<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="k">case</span> <span class="mh">0x11</span>:
				<span class="n">qla82xx_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">));</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x12</span>:
				<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x13</span>:
				<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_async</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5041</span><span class="p">,</span>
				    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef QL_DEBUG_LEVEL_17</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">eeh_busy</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x5044</span><span class="p">,</span>
		    <span class="s">&quot;isr:status %x, cmd_flags %lx, mbox_int %x, stat %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MBX_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MBX_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span>
<span class="nf">qla82xx_msix_rsp_q</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;%s(): NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_poll</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span>	<span class="o">*</span><span class="n">vha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rsp_que</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;%s(): NULL response queue pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">case</span> <span class="mh">0x10</span>:
		<span class="k">case</span> <span class="mh">0x11</span>:
			<span class="n">qla82xx_mbx_completion</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">MBX_INTERRUPT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>:
			<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSW</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">qla2x00_async_event</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>:
			<span class="n">qla24xx_process_response_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb013</span><span class="p">,</span>
			    <span class="s">&quot;Unrecognized interrupt type (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">stat</span> <span class="o">*</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">WRT_REG_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_enable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla82xx_mbx_intr_enable</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_disable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qla82xx_mbx_intr_disable</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">interrupts_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_init_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla82xx_legacy_intr_set</span> <span class="o">*</span><span class="n">nx_legacy_intr</span><span class="p">;</span>

	<span class="cm">/* ISP 8021 initializations */</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">qdr_sn_window</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddr_mn_window</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">curr_window</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">nx_legacy_intr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">legacy_intr</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">int_vec_bit</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_status_reg</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">pci_int_reg</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">pci_int_reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla82xx_set_drv_active</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>

	<span class="cm">/* If reset value is all FF&#39;s, initialize DRV_ACTIVE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_active</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">,</span>
			<span class="n">QLA82XX_DRV_NOT_ACTIVE</span><span class="p">);</span>
		<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drv_active</span> <span class="o">|=</span> <span class="p">(</span><span class="n">QLA82XX_DRV_ACTIVE</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla82xx_clear_drv_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_active</span><span class="p">;</span>

	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">drv_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QLA82XX_DRV_ACTIVE</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla82xx_need_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_owner</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">drv_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QLA82XX_DRVST_RST_RDY</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla82xx_set_rst_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_state</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>

	<span class="cm">/* If reset value is all FF&#39;s, initialize DRV_STATE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_state</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DRVST_NOT_RDY</span><span class="p">);</span>
		<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drv_state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">QLA82XX_DRVST_RST_RDY</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00bb</span><span class="p">,</span>
	    <span class="s">&quot;drv_state = 0x%08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla82xx_clear_rst_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_state</span><span class="p">;</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">drv_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QLA82XX_DRVST_RST_RDY</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla82xx_set_qsnt_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">qsnt_state</span><span class="p">;</span>

	<span class="n">qsnt_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">qsnt_state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">QLA82XX_DRVST_QSNT_RDY</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">qsnt_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_clear_qsnt_ready</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">qsnt_state</span><span class="p">;</span>

	<span class="n">qsnt_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">qsnt_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QLA82XX_DRVST_QSNT_RDY</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">qsnt_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_load_fw</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_pinit_from_rom</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">,</span>
		    <span class="s">&quot;Error during CRB initialization.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="cm">/* Bring QM and CAMRAM out of reset */</span>
	<span class="n">rst</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">);</span>
	<span class="n">rst</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="n">rst</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FW Load priority:</span>
<span class="cm">	 * 1) Operational firmware residing in flash.</span>
<span class="cm">	 * 2) Firmware via request-firmware interface (.bin file).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xfwloadbin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_blob_fw</span><span class="p">;</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a0</span><span class="p">,</span>
	    <span class="s">&quot;Attempting to load firmware from flash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_fw_load_from_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a1</span><span class="p">,</span>
		    <span class="s">&quot;Firmware loaded successfully from flash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0108</span><span class="p">,</span>
		    <span class="s">&quot;Firmware load from flash failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">try_blob_fw:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a2</span><span class="p">,</span>
	    <span class="s">&quot;Attempting to load firmware from blob.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Load firmware blob. */</span>
	<span class="n">blob</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hablob</span> <span class="o">=</span> <span class="n">qla2x00_request_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blob</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a3</span><span class="p">,</span>
		    <span class="s">&quot;Firmware image not present.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fw_load_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validating firmware blob */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_validate_firmware_blob</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
		<span class="n">QLA82XX_FLASH_ROMIMAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Fallback to URI format */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_validate_firmware_blob</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			<span class="n">QLA82XX_UNIFIED_ROMIMAGE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a4</span><span class="p">,</span>
			    <span class="s">&quot;No valid firmware image found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_fw_load_from_blob</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a5</span><span class="p">,</span>
		    <span class="s">&quot;Firmware loaded successfully from binary blob.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a6</span><span class="p">,</span>
		    <span class="s">&quot;Firmware load failed for binary blob.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">blob</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fw_load_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">fw_load_failed:</span>
	<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_start_firmware</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>           <span class="n">pcie_cap</span><span class="p">;</span>
	<span class="kt">uint16_t</span>      <span class="n">lnk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* scrub dma mask expansion register */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_DMA_SHIFT</span><span class="p">,</span> <span class="n">QLA82XX_DMA_SHIFT_VALUE</span><span class="p">);</span>

	<span class="cm">/* Put both the PEG CMD and RCV PEG to default state</span>
<span class="cm">	 * of 0 before resetting the hardware</span>
<span class="cm">	 */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_RCVPEG_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Overwrite stale initialization register values */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_HALT_STATUS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_HALT_STATUS2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_load_fw</span><span class="p">(</span><span class="n">vha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00a7</span><span class="p">,</span>
		    <span class="s">&quot;Error trying to start fw.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handshake with the card before we register the devices. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_check_cmdpeg_state</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00aa</span><span class="p">,</span>
		    <span class="s">&quot;Error during card handshake.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Negotiated Link width */</span>
	<span class="n">pcie_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lnk</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lnk</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="cm">/* Synchronize with Receive peg */</span>
	<span class="k">return</span> <span class="n">qla82xx_check_rcvpeg_state</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="o">*</span>
<span class="nf">qla82xx_read_flash_data</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Dword reads to flash. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">faddr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x0106</span><span class="p">,</span>
			    <span class="s">&quot;Do ROM fast read failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_read</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dwptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done_read:</span>
	<span class="k">return</span> <span class="n">dwptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_unprotect_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ql82xx_rom_lock_d</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb014</span><span class="p">,</span>
		    <span class="s">&quot;ROM Lock failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_read_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_unprotect</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BLOCK_PROTECT_BITS</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_write_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BLOCK_PROTECT_BITS</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">qla82xx_write_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_write_disable_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb015</span><span class="p">,</span>
		    <span class="s">&quot;Write disable failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">done_unprotect:</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_protect_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ql82xx_rom_lock_d</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb016</span><span class="p">,</span>
		    <span class="s">&quot;ROM Lock failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_read_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_protect</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BLOCK_PROTECT_BITS</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* LOCK all sectors */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_write_status_reg</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb017</span><span class="p">,</span>
		    <span class="s">&quot;Write status register failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_write_disable_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb018</span><span class="p">,</span>
		    <span class="s">&quot;Write disable failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">done_protect:</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_erase_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ql82xx_rom_lock_d</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb019</span><span class="p">,</span>
		    <span class="s">&quot;ROM Lock failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla82xx_flash_set_write_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ADDRESS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ABYTE_CNT</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="n">M25P_INSTR_SE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb01a</span><span class="p">,</span>
		    <span class="s">&quot;Error waiting for rom done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_flash_wait_write_finish</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Address and length are byte address</span>
<span class="cm"> */</span>
<span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla82xx_read_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">qla82xx_read_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_write_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">dwords</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">liter</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sec_mask</span><span class="p">,</span> <span class="n">rest_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">optrom_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">optrom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Prepare burst-capable write on supported ISPs. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_mode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">faddr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dwords</span> <span class="o">&gt;</span> <span class="n">OPTROM_BURST_DWORDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">optrom</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">optrom_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optrom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb01b</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate memory &quot;</span>
			    <span class="s">&quot;for optrom burst write (%x KB).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">OPTROM_BURST_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rest_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sec_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">rest_addr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_unprotect_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb01c</span><span class="p">,</span>
		    <span class="s">&quot;Unable to unprotect flash for update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">write_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">liter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">liter</span> <span class="o">&lt;</span> <span class="n">dwords</span><span class="p">;</span> <span class="n">liter</span><span class="o">++</span><span class="p">,</span> <span class="n">faddr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dwptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Are we at the beginning of a sector? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">faddr</span> <span class="o">&amp;</span> <span class="n">rest_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_erase_sector</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb01d</span><span class="p">,</span>
				    <span class="s">&quot;Unable to erase sector: address=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">faddr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Go with burst-write. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optrom</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">liter</span> <span class="o">+</span> <span class="n">OPTROM_BURST_DWORDS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dwords</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Copy data to DMA&#39;ble buffer. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">optrom</span><span class="p">,</span> <span class="n">dwptr</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla2x00_load_ram</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">|</span> <span class="n">faddr</span><span class="p">),</span>
			    <span class="n">OPTROM_BURST_DWORDS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb01e</span><span class="p">,</span>
				    <span class="s">&quot;Unable to burst-write optrom segment &quot;</span>
				    <span class="s">&quot;(%x/%x/%llx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">|</span> <span class="n">faddr</span><span class="p">),</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">optrom_dma</span><span class="p">);</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb01f</span><span class="p">,</span>
				    <span class="s">&quot;Reverting to slow-write.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span> <span class="n">optrom</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">);</span>
				<span class="n">optrom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">liter</span> <span class="o">+=</span> <span class="n">OPTROM_BURST_DWORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">faddr</span> <span class="o">+=</span> <span class="n">OPTROM_BURST_DWORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dwptr</span> <span class="o">+=</span> <span class="n">OPTROM_BURST_DWORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_write_flash_dword</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">,</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">dwptr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb020</span><span class="p">,</span>
			    <span class="s">&quot;Unable to program flash address=%x data=%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">faddr</span><span class="p">,</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla82xx_protect_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb021</span><span class="p">,</span>
		    <span class="s">&quot;Unable to protect flash after update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">write_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optrom</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="n">OPTROM_BURST_SIZE</span><span class="p">,</span> <span class="n">optrom</span><span class="p">,</span> <span class="n">optrom_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_write_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="cm">/* Suspend HBA. */</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_write_flash_data</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
		<span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Convert return ISP82xx to generic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_start_iocbs</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dbval</span><span class="p">;</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">isp82</span><span class="p">;</span>
	<span class="n">dbval</span> <span class="o">=</span> <span class="mh">0x04</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">dbval</span> <span class="o">=</span> <span class="n">dbval</span> <span class="o">|</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ring_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xdbwr</span><span class="p">)</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span> <span class="n">dbval</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span> <span class="n">dbval</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">RD_REG_DWORD</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_rd_ptr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_DWORD</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nxdb_wr_ptr</span><span class="p">,</span>
				<span class="n">dbval</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_rom_lock_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="cm">/* Someone else is holding the lock. */</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb022</span><span class="p">,</span>
		    <span class="s">&quot;Resetting rom_lock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Either we got the lock, or someone</span>
<span class="cm">	 * else died while holding it.</span>
<span class="cm">	 * In either case, unlock.</span>
<span class="cm">	 */</span>
	<span class="n">qla82xx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla82xx_device_bootstrap</span>
<span class="cm"> *    Initialize device, set DEV_READY, start fw</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *      IDC lock must be held upon entry</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Success : 0</span>
<span class="cm"> *    Failed  : 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_device_bootstrap</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">old_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">peg_stuck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">need_reset</span> <span class="o">=</span> <span class="n">qla82xx_need_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">old_count</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_ALIVE_COUNTER</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
				<span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_ALIVE_COUNTER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">old_count</span><span class="p">)</span>
			<span class="n">peg_stuck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are trying to perform a recovery here. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peg_stuck</span><span class="p">)</span>
			<span class="n">qla82xx_rom_lock_recovery</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dev_initialize</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="cm">/* Start of day for this ha context. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peg_stuck</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Either we are the first or recovery in progress. */</span>
			<span class="n">qla82xx_rom_lock_recovery</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">dev_initialize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* Firmware already running. */</span>
			<span class="k">goto</span> <span class="n">dev_ready</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

<span class="nl">dev_initialize:</span>
	<span class="cm">/* set to DEV_INITIALIZING */</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x009e</span><span class="p">,</span>
	    <span class="s">&quot;HW State: INITIALIZING.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_INITIALIZING</span><span class="p">);</span>

	<span class="cm">/* Driver that sets device state to initializating sets IDC version */</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_IDC_VERSION</span><span class="p">,</span> <span class="n">QLA82XX_IDC_VERSION</span><span class="p">);</span>

	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_start_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ad</span><span class="p">,</span>
		    <span class="s">&quot;HW State: FAILED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla82xx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">dev_ready:</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00ae</span><span class="p">,</span>
	    <span class="s">&quot;HW State: READY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_READY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla82xx_need_qsnt_handler</span>
<span class="cm">*    Code to start quiescence sequence</span>
<span class="cm">*</span>
<span class="cm">* Note:</span>
<span class="cm">*      IDC lock must be held upon entry</span>
<span class="cm">*</span>
<span class="cm">* Return: void</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_need_qsnt_handler</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*Block any further I/O and wait for pending cmnds to complete*/</span>
		<span class="n">qla82xx_quiescent_state_cleanup</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the quiescence ready bit */</span>
	<span class="n">qla82xx_set_qsnt_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/*wait for 30 secs for other functions to ack */</span>
	<span class="n">reset_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="cm">/* Its 2 that is written when qsnt is acked, moving one bit */</span>
	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">drv_active</span> <span class="o">&lt;&lt;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">drv_state</span> <span class="o">!=</span> <span class="n">drv_active</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">reset_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* quiescence timeout, other functions didn&#39;t ack</span>
<span class="cm">			 * changing the state to DEV_READY</span>
<span class="cm">			 */</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb023</span><span class="p">,</span>
			    <span class="s">&quot;%s : QUIESCENT TIMEOUT DRV_ACTIVE:%d &quot;</span>
			    <span class="s">&quot;DRV_STATE:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QLA2XXX_DRIVER_NAME</span><span class="p">,</span>
			    <span class="n">drv_active</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
			<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_READY</span><span class="p">);</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb025</span><span class="p">,</span>
			    <span class="s">&quot;HW State: DEV_READY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla2x00_perform_loop_resync</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

			<span class="n">qla82xx_clear_qsnt_ready</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
		<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
		<span class="n">drv_active</span> <span class="o">=</span> <span class="n">drv_active</span> <span class="o">&lt;&lt;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="cm">/* everyone acked so set the state to DEV_QUIESCENCE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_NEED_QUIESCENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb026</span><span class="p">,</span>
		    <span class="s">&quot;HW State: DEV_QUIESCENT.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_QUIESCENT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* qla82xx_wait_for_state_change</span>
<span class="cm">*    Wait for device state to change from given current state</span>
<span class="cm">*</span>
<span class="cm">* Note:</span>
<span class="cm">*     IDC lock must not be held upon entry</span>
<span class="cm">*</span>
<span class="cm">* Return:</span>
<span class="cm">*    Changed device state.</span>
<span class="cm">*/</span>
<span class="kt">uint32_t</span>
<span class="nf">qla82xx_wait_for_state_change</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">curr_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">curr_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_dev_failed_handler</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Disable the board */</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b8</span><span class="p">,</span>
	    <span class="s">&quot;Disabling the board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Set DEV_FAILED flag to disable timer */</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="n">DFLG_DEV_FAILED</span><span class="p">;</span>
	<span class="n">qla2x00_abort_all_cmds</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">qla2x00_mark_all_devices_lost</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla82xx_need_reset_handler</span>
<span class="cm"> *    Code to start reset sequence</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *      IDC lock must be held upon entry</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Success : 0</span>
<span class="cm"> *    Failed  : 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_need_reset_handler</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">active_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla2x00_abort_isp_cleanup</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">get_flash_version</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">nvram_config</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_owner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb028</span><span class="p">,</span>
		    <span class="s">&quot;reset_acknowledged by 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
		<span class="n">qla82xx_set_rst_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">active_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">QLA82XX_DRV_ACTIVE</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">drv_active</span> <span class="o">&amp;=</span> <span class="n">active_mask</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb029</span><span class="p">,</span>
		    <span class="s">&quot;active_mask: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">active_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait for 10 seconds for reset ack from all functions */</span>
	<span class="n">reset_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb02a</span><span class="p">,</span>
	    <span class="s">&quot;drv_state: 0x%08x, drv_active: 0x%08x, &quot;</span>
	    <span class="s">&quot;dev_state: 0x%08x, active_mask: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">,</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">active_mask</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">drv_state</span> <span class="o">!=</span> <span class="n">drv_active</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_state</span> <span class="o">!=</span> <span class="n">QLA82XX_DEV_INITIALIZING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">reset_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b5</span><span class="p">,</span>
			    <span class="s">&quot;Reset timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
		<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_owner</span><span class="p">)</span>
			<span class="n">drv_active</span> <span class="o">&amp;=</span> <span class="n">active_mask</span><span class="p">;</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb02b</span><span class="p">,</span>
	    <span class="s">&quot;drv_state: 0x%08x, drv_active: 0x%08x, &quot;</span>
	    <span class="s">&quot;dev_state: 0x%08x, active_mask: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">,</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">active_mask</span><span class="p">);</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b6</span><span class="p">,</span>
	    <span class="s">&quot;Device state is 0x%x = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">dev_state</span><span class="p">,</span>
	    <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span> <span class="n">qdev_state</span><span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>

	<span class="cm">/* Force to DEV_COLD unless someone else is starting a reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">!=</span> <span class="n">QLA82XX_DEV_INITIALIZING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_state</span> <span class="o">!=</span> <span class="n">QLA82XX_DEV_COLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b7</span><span class="p">,</span>
		    <span class="s">&quot;HW State: COLD/RE-INIT.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_COLD</span><span class="p">);</span>
		<span class="n">qla82xx_set_rst_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmdenable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_md_collect</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb02c</span><span class="p">,</span>
				    <span class="s">&quot;Minidump not collected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb04f</span><span class="p">,</span>
			    <span class="s">&quot;Minidump disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_check_md_needed</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fw_major_version</span><span class="p">,</span> <span class="n">fw_minor_version</span><span class="p">,</span> <span class="n">fw_subminor_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">fw_major_version</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">;</span>
	<span class="n">fw_minor_version</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span><span class="p">;</span>
	<span class="n">fw_subminor_version</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla2x00_get_fw_version</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmdenable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fw_major_version</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span> <span class="o">||</span>
			    <span class="n">fw_minor_version</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span> <span class="o">||</span>
			    <span class="n">fw_subminor_version</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb02d</span><span class="p">,</span>
				    <span class="s">&quot;Firmware version differs &quot;</span>
				    <span class="s">&quot;Previous version: %d:%d:%d - &quot;</span>
				    <span class="s">&quot;New version: %d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fw_major_version</span><span class="p">,</span> <span class="n">fw_minor_version</span><span class="p">,</span>
				    <span class="n">fw_subminor_version</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_major_version</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_minor_version</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_subminor_version</span><span class="p">);</span>
				<span class="cm">/* Release MiniDump resources */</span>
				<span class="n">qla82xx_md_free</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="cm">/* ALlocate MiniDump resources */</span>
				<span class="n">qla82xx_md_prep</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb02e</span><span class="p">,</span>
			    <span class="s">&quot;Firmware dump available to retrieve</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">qla82xx_check_fw_alive</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">fw_heartbeat_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw_heartbeat_counter</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">QLA82XX_PEG_ALIVE_COUNTER</span><span class="p">);</span>
	<span class="cm">/* all 0xff, assume AER/EEH in progress, ignore */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_heartbeat_counter</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6003</span><span class="p">,</span>
		    <span class="s">&quot;FW heartbeat counter is 0xffffffff, &quot;</span>
		    <span class="s">&quot;returning status=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">fw_heartbeat_counter</span> <span class="o">==</span> <span class="n">fw_heartbeat_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* FW not alive after 2 seconds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vha</span><span class="o">-&gt;</span><span class="n">fw_heartbeat_counter</span> <span class="o">=</span> <span class="n">fw_heartbeat_counter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6004</span><span class="p">,</span>
		    <span class="s">&quot;Returning status=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla82xx_device_state_handler</span>
<span class="cm"> *	Main state handler</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *      IDC lock must be held upon entry</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Success : 0</span>
<span class="cm"> *    Failed  : 1</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla82xx_device_state_handler</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">old_dev_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_init_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_done</span><span class="p">)</span>
		<span class="n">qla82xx_set_drv_active</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="n">old_dev_state</span> <span class="o">=</span> <span class="n">dev_state</span><span class="p">;</span>
	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x009b</span><span class="p">,</span>
	    <span class="s">&quot;Device state is 0x%x = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">dev_state</span><span class="p">,</span>
	    <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span> <span class="n">qdev_state</span><span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>

	<span class="cm">/* wait for 30 seconds for device to go ready */</span>
	<span class="n">dev_init_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_init_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_fatal</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x009c</span><span class="p">,</span>
			    <span class="s">&quot;Device init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_dev_state</span> <span class="o">!=</span> <span class="n">dev_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">loopcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">old_dev_state</span> <span class="o">=</span> <span class="n">dev_state</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loopcount</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x009d</span><span class="p">,</span>
			    <span class="s">&quot;Device state is 0x%x = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev_state</span><span class="p">,</span>
			    <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span> <span class="n">qdev_state</span><span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="o">:</span>
			    <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_READY</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_COLD</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_device_bootstrap</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_INITIALIZING</span>:
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_NEED_RESET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql2xdontresethba</span><span class="p">)</span>
				<span class="n">qla82xx_need_reset_handler</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev_init_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_NEED_QUIESCENT</span>:
			<span class="n">qla82xx_need_qsnt_handler</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="cm">/* Reset timeout value after quiescence handler */</span>
			<span class="n">dev_init_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span>\
							 <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_QUIESCENT</span>:
			<span class="cm">/* Owner will exit and other will wait for the state</span>
<span class="cm">			 * to get changed</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">quiesce_owner</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

			<span class="cm">/* Reset timeout value after quiescence handler */</span>
			<span class="n">dev_init_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span>\
							 <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_FAILED</span>:
			<span class="n">qla82xx_dev_failed_handler</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">loopcount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla82xx_check_temp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_TEMP_STATE</span><span class="p">);</span>
	<span class="n">temp_state</span> <span class="o">=</span> <span class="n">qla82xx_get_temp_state</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp_val</span> <span class="o">=</span> <span class="n">qla82xx_get_temp_val</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">QLA82XX_TEMP_PANIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x600e</span><span class="p">,</span>
		    <span class="s">&quot;Device temperature %d degrees C exceeds &quot;</span>
		    <span class="s">&quot; maximum allowed. Hardware has been shut down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">temp_val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">QLA82XX_TEMP_WARN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x600f</span><span class="p">,</span>
		    <span class="s">&quot;Device temperature %d degrees C exceeds &quot;</span>
		    <span class="s">&quot;operating range. Immediate action needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">temp_val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_clear_pending_mbx</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mbox_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6010</span><span class="p">,</span>
		    <span class="s">&quot;Doing premature completion of mbx command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MBX_INTR_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_cmd_flags</span><span class="p">))</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla82xx_watchdog</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">halt_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* don&#39;t poll if reset is going on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_hdlr_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_check_temp</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">qla82xx_clear_pending_mbx</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_NEED_RESET</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6001</span><span class="p">,</span>
			    <span class="s">&quot;Adapter reset needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_NEED_QUIESCENT</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_QUIESCE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6002</span><span class="p">,</span>
			    <span class="s">&quot;Quiescent needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_QUIESCE_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_check_fw_alive</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_timer</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6011</span><span class="p">,</span>
				    <span class="s">&quot;disabling pause transmit on port 0 &amp; 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">,</span>
				    <span class="n">CRB_NIU_XG_PAUSE_CTL_P0</span><span class="o">|</span><span class="n">CRB_NIU_XG_PAUSE_CTL_P1</span><span class="p">);</span>
				<span class="n">halt_status</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				    <span class="n">QLA82XX_PEG_HALT_STATUS1</span><span class="p">);</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6005</span><span class="p">,</span>
				    <span class="s">&quot;dumping hw/fw registers:.</span><span class="se">\n</span><span class="s"> &quot;</span>
				    <span class="s">&quot; PEG_HALT_STATUS1: 0x%x, PEG_HALT_STATUS2: 0x%x,.</span><span class="se">\n</span><span class="s"> &quot;</span>
				    <span class="s">&quot; PEG_NET_0_PC: 0x%x, PEG_NET_1_PC: 0x%x,.</span><span class="se">\n</span><span class="s"> &quot;</span>
				    <span class="s">&quot; PEG_NET_2_PC: 0x%x, PEG_NET_3_PC: 0x%x,.</span><span class="se">\n</span><span class="s"> &quot;</span>
				    <span class="s">&quot; PEG_NET_4_PC: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">halt_status</span><span class="p">,</span>
				    <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_HALT_STATUS2</span><span class="p">),</span>
				    <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
				    <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_PEG_NET_1</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
				    <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_PEG_NET_2</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
				    <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_PEG_NET_3</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
				    <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">QLA82XX_CRB_PEG_NET_4</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">halt_status</span> <span class="o">&amp;</span> <span class="mh">0x1fffff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x67</span><span class="p">)</span>
					<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb052</span><span class="p">,</span>
					    <span class="s">&quot;Firmware aborted with &quot;</span>
					    <span class="s">&quot;error code 0x00006700. Device is &quot;</span>
					    <span class="s">&quot;being reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">halt_status</span> <span class="o">&amp;</span> <span class="n">HALT_STATUS_UNRECOVERABLE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_UNRECOVERABLE</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6006</span><span class="p">,</span>
					    <span class="s">&quot;Detect abort  needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_NEEDED</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x6007</span><span class="p">,</span> <span class="s">&quot;Firmware hung.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">qla82xx_clear_pending_mbx</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla82xx_load_risc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">srisc_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_device_state_handler</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_set_reset_owner</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>

	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla82xx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb02f</span><span class="p">,</span>
		    <span class="s">&quot;HW State: NEED RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla82xx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			<span class="n">QLA82XX_DEV_NEED_RESET</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_owner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb030</span><span class="p">,</span>
		    <span class="s">&quot;reset_owner is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb031</span><span class="p">,</span>
		    <span class="s">&quot;Device state is 0x%x = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev_state</span><span class="p">,</span>
		    <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span> <span class="n">qdev_state</span><span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  qla82xx_abort_isp</span>
<span class="cm"> *      Resets ISP and aborts all outstanding commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha           = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">qla82xx_abort_isp</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="n">DFLG_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8024</span><span class="p">,</span>
		    <span class="s">&quot;Device in failed state, exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_hdlr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_set_reset_owner</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_device_state_handler</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_clear_rst_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_reset_hdlr_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla82xx_restart_isp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8027</span><span class="p">,</span>
				    <span class="s">&quot;ISP error recover failed - board &quot;</span>
				    <span class="s">&quot;disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * The next call disables the board</span>
<span class="cm">				 * completely.</span>
<span class="cm">				 */</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_adapter</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* schedule another ISP abort */</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8036</span><span class="p">,</span>
				    <span class="s">&quot;ISP abort - retry remaining %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span> <span class="o">=</span> <span class="n">MAX_RETRIES_OF_ISP_ABORT</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_taskm</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x8029</span><span class="p">,</span>
			    <span class="s">&quot;ISP error recovery - retrying (%d) more times.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_abort_cnt</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISP_ABORT_RETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  qla82xx_fcoe_ctx_reset</span>
<span class="cm"> *      Perform a quick reset and aborts all outstanding commands.</span>
<span class="cm"> *      This will only perform an FCoE context reset and avoids a full blown</span>
<span class="cm"> *      chip reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *      is_reset_path = flag for identifying the reset path.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qla82xx_fcoe_ctx_reset</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Abort all outstanding commands, so as to be requeued later */</span>
		<span class="n">qla2x00_abort_isp_cleanup</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Stop currently executing firmware.</span>
<span class="cm">	 * This will destroy existing FCoE context at the F/W end.</span>
<span class="cm">	 */</span>
	<span class="n">qla2x00_try_to_stop_firmware</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="cm">/* Restart. Creates a new FCoE context on INIT_FIRMWARE. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_restart_isp</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla2x00_wait_for_fcoe_ctx_reset</span>
<span class="cm"> *    Wait till the FCoE context is reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *    Does context switching here.</span>
<span class="cm"> *    Release SPIN_LOCK (if any) before calling this routine.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *    Success (fcoe_ctx reset is done) : 0</span>
<span class="cm"> *    Failed  (fcoe_ctx reset not completed within max loop timout ) : 1</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qla2x00_wait_for_fcoe_ctx_reset</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait_reset</span><span class="p">;</span>

	<span class="n">wait_reset</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_LOOP_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_reset</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FCOE_CTX_RESET_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ABORT_ISP_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb027</span><span class="p">,</span>
	       <span class="s">&quot;%s: status=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_chip_reset_cleanup</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Check if 82XX firmware is alive or not</span>
<span class="cm">	 * We may have arrived here from NEED_RESET</span>
<span class="cm">	 * detection only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_check_fw_alive</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">qla82xx_clear_pending_mbx</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b0</span><span class="p">,</span>
	    <span class="s">&quot;Entered %s fw_hung=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">);</span>

	<span class="cm">/* Abort all commands gracefully if fw NOT hung */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_fw_hung</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">que</span><span class="p">;</span>
		<span class="n">srb_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">req_que</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">que</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">que</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_req_queues</span><span class="p">;</span> <span class="n">que</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_map</span><span class="p">[</span><span class="n">que</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scmd</span><span class="p">.</span><span class="n">ctx</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_FCP_CMND_DMA_VALID</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
						    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">abort_command</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span>
							    <span class="mh">0x00b1</span><span class="p">,</span>
							    <span class="s">&quot;mbx abort failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span>
							    <span class="mh">0x00b2</span><span class="p">,</span>
							    <span class="s">&quot;mbx abort success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Wait for pending cmds (physical and virtual) to complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla2x00_eh_wait_for_pending_commands</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">WAIT_HOST</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_init</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0x00b3</span><span class="p">,</span>
			    <span class="s">&quot;Done wait for &quot;</span>
			    <span class="s">&quot;pending commands.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Minidump related functions */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_minidump_process_control</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_crb</span> <span class="o">*</span><span class="n">crb_entry</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">poll_time</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_template_hdr</span> <span class="o">*</span><span class="n">tmplt_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tmplt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_template_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">;</span>
	<span class="n">crb_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_crb</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">crb_addr</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_WR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span>
			    <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_WR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_RW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_RW</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_AND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">read_value</span> <span class="o">&amp;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_AND</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
				<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
			<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_POLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poll_time</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">poll_timeout</span><span class="p">;</span>
			<span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">poll_time</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">read_value</span> <span class="o">&amp;</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">)</span>
				    <span class="o">==</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wtime</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* capturing dump failed */</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					    <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_POLL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_RDSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">crb_addr</span><span class="p">;</span>

			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">;</span>
			<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_RDSTATE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_WRSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">crb_addr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">;</span>
				<span class="n">read_value</span> <span class="o">=</span>
				    <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">read_value</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">;</span>

			<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_WRSTATE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_MDSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">read_value</span> <span class="o">&lt;&lt;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">shl</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">&gt;&gt;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">shr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">)</span>
				<span class="n">read_value</span> <span class="o">&amp;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">+=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">;</span>
			<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_MDSTATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">crb_addr</span> <span class="o">+=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">addr_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_minidump_process_rdocm</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_rdocm</span> <span class="o">*</span><span class="n">ocm_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">ocm_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_rdocm</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">ocm_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">r_stride</span> <span class="o">=</span> <span class="n">ocm_hdr</span><span class="o">-&gt;</span><span class="n">read_addr_stride</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">ocm_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">RD_REG_DWORD</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">r_addr</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="n">r_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_minidump_process_rdmux</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">s_stride</span><span class="p">,</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">s_value</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_mux</span> <span class="o">*</span><span class="n">mux_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">mux_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_mux</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">s_addr</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">select_addr</span><span class="p">;</span>
	<span class="n">s_stride</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">select_value_stride</span><span class="p">;</span>
	<span class="n">s_value</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">select_value</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">s_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s_value</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">s_value</span> <span class="o">+=</span> <span class="n">s_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_minidump_process_rdcrb</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_crb</span> <span class="o">*</span><span class="n">crb_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">crb_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_crb</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">crb_hdr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">r_stride</span> <span class="o">=</span> <span class="n">crb_hdr</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">addr_stride</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">crb_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_addr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="n">r_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_minidump_process_l2tag</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_count</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="n">r_cnt</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_wait</span><span class="p">,</span> <span class="n">w_time</span><span class="p">,</span> <span class="n">p_mask</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">c_value_w</span><span class="p">,</span> <span class="n">c_value_r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_cache</span> <span class="o">*</span><span class="n">cache_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">cache_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_cache</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">c_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">control_addr</span><span class="p">;</span>
	<span class="n">c_value_w</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">write_value</span><span class="p">;</span>

	<span class="n">t_r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">t_value</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">init_tag_value</span><span class="p">;</span>
	<span class="n">r_cnt</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_cnt</span><span class="p">;</span>
	<span class="n">p_wait</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">poll_wait</span><span class="p">;</span>
	<span class="n">p_mask</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">poll_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_value_w</span><span class="p">)</span>
			<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">c_value_w</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">p_wait</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">c_value_r</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">c_value_r</span> <span class="o">&amp;</span> <span class="n">p_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">w_time</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* capturing dump failed */</span>
					<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb032</span><span class="p">,</span>
					    <span class="s">&quot;c_value_r: 0x%x, poll_mask: 0x%lx, &quot;</span>
					    <span class="s">&quot;w_time: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">c_value_r</span><span class="p">,</span> <span class="n">p_mask</span><span class="p">,</span> <span class="n">w_time</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">r_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">r_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t_value</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">tag_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_minidump_process_l1cache</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_count</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="n">r_cnt</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">c_value_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_cache</span> <span class="o">*</span><span class="n">cache_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">cache_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_cache</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">c_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">control_addr</span><span class="p">;</span>
	<span class="n">c_value_w</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">write_value</span><span class="p">;</span>

	<span class="n">t_r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">t_value</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">init_tag_value</span><span class="p">;</span>
	<span class="n">r_cnt</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">c_value_w</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">r_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">r_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t_value</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">tag_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_minidump_process_queue</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">r_cnt</span><span class="p">,</span> <span class="n">qid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_queue</span> <span class="o">*</span><span class="n">q_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">q_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">s_addr</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">select_addr</span><span class="p">;</span>
	<span class="n">r_cnt</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">rd_strd</span><span class="p">.</span><span class="n">read_addr_cnt</span><span class="p">;</span>
	<span class="n">r_stride</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">rd_strd</span><span class="p">.</span><span class="n">read_addr_stride</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">r_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
			<span class="n">r_addr</span> <span class="o">+=</span> <span class="n">r_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qid</span> <span class="o">+=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">q_strd</span><span class="p">.</span><span class="n">queue_id_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_minidump_process_rdrom</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_rdrom</span> <span class="o">*</span><span class="n">rom_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">rom_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_rdrom</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">rom_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">rom_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_DIRECT_ROM_WINDOW</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">r_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">MD_DIRECT_ROM_READ_BASE</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">r_addr</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_minidump_process_rdmem</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">r_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_entry_rdmem</span> <span class="o">*</span><span class="n">m_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">m_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_entry_rdmem</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb033</span><span class="p">,</span>
		    <span class="s">&quot;Read addr 0x%x not 16 bytes alligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb034</span><span class="p">,</span>
		    <span class="s">&quot;Read data[0x%x] not multiple of 16 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb035</span><span class="p">,</span>
	    <span class="s">&quot;[%s]: rdmem_addr: 0x%x, read_data_size: 0x%x, loop_cnt: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">);</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_ADDR_LO</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_ADDR_HI</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_START</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			    <span class="n">MD_MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r_value</span> <span class="o">&amp;</span> <span class="n">MIU_TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_ERR</span>
			    <span class="s">&quot;failed to read through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_data</span> <span class="o">=</span> <span class="n">qla82xx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
			    <span class="n">MD_MIU_TEST_AGT_RDDATA</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla82xx_validate_template_chksum</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">~</span><span class="n">chksum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla82xx_mark_entry_skipped</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">,</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">QLA82XX_DBG_SKIPPED_FLAG</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb036</span><span class="p">,</span>
	    <span class="s">&quot;Skipping entry[%d]: &quot;</span>
	    <span class="s">&quot;ETYPE[0x%x]-ELEVEL[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">index</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span>
	    <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">entry_capture_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_md_collect</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">no_entry_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_template_hdr</span> <span class="o">*</span><span class="n">tmplt_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">total_data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f_capture_mask</span><span class="p">,</span> <span class="n">data_collected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_FUNCTION_FAILED</span><span class="p">;</span>

	<span class="n">tmplt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_template_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">;</span>
	<span class="n">data_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb037</span><span class="p">,</span>
		    <span class="s">&quot;Firmware has been previously dumped (%p) &quot;</span>
		    <span class="s">&quot;-- ignoring request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb038</span><span class="p">,</span>
		    <span class="s">&quot;Memory not allocated for minidump capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_no_md_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb054</span><span class="p">,</span>
		    <span class="s">&quot;Forced reset from application, &quot;</span>
		    <span class="s">&quot;ignore minidump capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isp82xx_no_md_cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla82xx_validate_template_chksum</span><span class="p">(</span><span class="n">vha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb039</span><span class="p">,</span>
		    <span class="s">&quot;Template checksum validation error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">no_entry_hdr</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">num_of_entries</span><span class="p">;</span>
	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb03a</span><span class="p">,</span>
	    <span class="s">&quot;No of entry headers in Template: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">no_entry_hdr</span><span class="p">);</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb03b</span><span class="p">,</span>
	    <span class="s">&quot;Capture Mask obtained: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">capture_debug_level</span><span class="p">);</span>

	<span class="n">f_capture_mask</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">capture_debug_level</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="cm">/* Validate whether required debug level is set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">f_capture_mask</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb03c</span><span class="p">,</span>
		    <span class="s">&quot;Minimum required capture mask[0x%x] level not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">f_capture_mask</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">driver_capture_mask</span> <span class="o">=</span> <span class="n">ql2xmdcapmask</span><span class="p">;</span>

	<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">QLA_DRIVER_MAJOR_VER</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">QLA_DRIVER_MINOR_VER</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">QLA_DRIVER_PATCH_VER</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">QLA_DRIVER_BETA_VER</span><span class="p">;</span>

	<span class="n">total_data_size</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span><span class="p">;</span>

	<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb03d</span><span class="p">,</span>
	    <span class="s">&quot;Total minidump data_size 0x%x to be captured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_data_size</span><span class="p">);</span>

	<span class="cm">/* Check whether template obtained is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">!=</span> <span class="n">QLA82XX_TLHDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb04e</span><span class="p">,</span>
		    <span class="s">&quot;Bad template header entry type: 0x%x obtained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="p">)</span> \
	    <span class="p">(((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">first_entry_offset</span><span class="p">);</span>

	<span class="cm">/* Walk through the entry headers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">no_entry_hdr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data_collected</span> <span class="o">&gt;</span> <span class="n">total_data_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb03e</span><span class="p">,</span>
			    <span class="s">&quot;More MiniDump data collected: [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">data_collected</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">entry_capture_mask</span> <span class="o">&amp;</span>
		    <span class="n">ql2xmdcapmask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span>
			    <span class="n">QLA82XX_DBG_SKIPPED_FLAG</span><span class="p">;</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb03f</span><span class="p">,</span>
			    <span class="s">&quot;Skipping entry[%d]: &quot;</span>
			    <span class="s">&quot;ETYPE[0x%x]-ELEVEL[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">i</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">entry_capture_mask</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_nxt_entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb040</span><span class="p">,</span>
		    <span class="s">&quot;[%s]: data ptr[%d]: %p, entry_hdr: %p</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;entry_type: 0x%x, captrue_mask: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
		    <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span>
		    <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">entry_capture_mask</span><span class="p">);</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb041</span><span class="p">,</span>
		    <span class="s">&quot;Data collected: [0x%x], Dump size left:[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">data_collected</span><span class="p">,</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span> <span class="o">-</span> <span class="n">data_collected</span><span class="p">));</span>

		<span class="cm">/* Decode the entry type and take</span>
<span class="cm">		 * required action to capture debug data */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDEND</span>:
			<span class="n">qla82xx_mark_entry_skipped</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_CNTRL</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_minidump_process_control</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla82xx_mark_entry_skipped</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDCRB</span>:
			<span class="n">qla82xx_minidump_process_rdcrb</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDMEM</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_minidump_process_rdmem</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla82xx_mark_entry_skipped</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_BOARD</span>:
		<span class="k">case</span> <span class="n">QLA82XX_RDROM</span>:
			<span class="n">qla82xx_minidump_process_rdrom</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_L2DTG</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L2ITG</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L2DAT</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L2INS</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_minidump_process_l2tag</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla82xx_mark_entry_skipped</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_L1DAT</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L1INS</span>:
			<span class="n">qla82xx_minidump_process_l1cache</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDOCM</span>:
			<span class="n">qla82xx_minidump_process_rdocm</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDMUX</span>:
			<span class="n">qla82xx_minidump_process_rdmux</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_QUEUE</span>:
			<span class="n">qla82xx_minidump_process_queue</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span>
			    <span class="n">entry_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDNOP</span>:
		<span class="nl">default:</span>
			<span class="n">qla82xx_mark_entry_skipped</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb042</span><span class="p">,</span>
		    <span class="s">&quot;[%s]: data ptr[%d]: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">);</span>

		<span class="n">data_collected</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data_ptr</span> <span class="o">-</span>
		    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">;</span>
<span class="nl">skip_nxt_entry:</span>
		<span class="n">entry_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">qla82xx_md_entry_hdr_t</span> <span class="o">*</span><span class="p">)</span> \
		    <span class="p">(((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_collected</span> <span class="o">!=</span> <span class="n">total_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb043</span><span class="p">,</span>
		    <span class="s">&quot;MiniDump data mismatch: Data collected: [0x%x],&quot;</span>
		    <span class="s">&quot;total_data_size:[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">data_collected</span><span class="p">,</span> <span class="n">total_data_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb044</span><span class="p">,</span>
	    <span class="s">&quot;Firmware dump saved to temp buffer (%ld/%p %ld/%p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">,</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dumped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qla2x00_post_uevent_work</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="n">QLA_UEVENT_CODE_FW_DUMP</span><span class="p">);</span>

<span class="nl">md_failed:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_md_alloc</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_md_template_hdr</span> <span class="o">*</span><span class="n">tmplt_hdr</span><span class="p">;</span>

	<span class="n">tmplt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_md_template_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql2xmdcapmask</span> <span class="o">&lt;</span> <span class="mh">0x3</span> <span class="o">||</span> <span class="n">ql2xmdcapmask</span> <span class="o">&gt;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql2xmdcapmask</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">capture_debug_level</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb045</span><span class="p">,</span>
		    <span class="s">&quot;Forcing driver capture mask to firmware default capture mask: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ql2xmdcapmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DEFAULT_CAP_MASK</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">ql2xmdcapmask</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span> <span class="o">+=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">capture_size_array</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb046</span><span class="p">,</span>
		    <span class="s">&quot;Firmware dump previously allocated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb047</span><span class="p">,</span>
		    <span class="s">&quot;Unable to allocate memory for Minidump size &quot;</span>
		    <span class="s">&quot;(0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_md_free</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Release the template header allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb048</span><span class="p">,</span>
		    <span class="s">&quot;Free MiniDump template: %p, size (%d KB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Release the template data buffer allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb049</span><span class="p">,</span>
		    <span class="s">&quot;Free MiniDump memory: %p, size (%d KB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla82xx_md_prep</span><span class="p">(</span><span class="n">scsi_qla_host_t</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="cm">/* Get Minidump template size */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_md_get_template_size</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb04a</span><span class="p">,</span>
		    <span class="s">&quot;MiniDump Template size obtained (%d KB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

		<span class="cm">/* Get Minidump template */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_md_get_template</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql_dbg</span><span class="p">(</span><span class="n">ql_dbg_p3p</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb04b</span><span class="p">,</span>
			    <span class="s">&quot;MiniDump Template obtained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Allocate memory for minidump */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_md_alloc</span><span class="p">(</span><span class="n">vha</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb04c</span><span class="p">,</span>
				    <span class="s">&quot;MiniDump memory allocated (%d KB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_dump_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_info</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb04d</span><span class="p">,</span>
				    <span class="s">&quot;Free MiniDump template: %p, size: (%d KB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_template_size</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr_dma</span><span class="p">);</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">md_tmplt_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_beacon_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_mbx_beacon_ctl</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb050</span><span class="p">,</span>
		    <span class="s">&quot;mbx set led config failed in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla82xx_beacon_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">vha</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_hw_data</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">vha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">qla82xx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla82xx_mbx_beacon_ctl</span><span class="p">(</span><span class="n">vha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_log</span><span class="p">(</span><span class="n">ql_log_warn</span><span class="p">,</span> <span class="n">vha</span><span class="p">,</span> <span class="mh">0xb051</span><span class="p">,</span>
		    <span class="s">&quot;mbx set led config failed in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">beacon_blink_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">qla82xx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
