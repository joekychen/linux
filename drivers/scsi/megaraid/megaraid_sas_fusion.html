<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › megaraid › megaraid_sas_fusion.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>megaraid_sas_fusion.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Linux MegaRAID driver for SAS based RAID controllers</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2009-2011  LSI Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version 2</span>
<span class="cm"> *  of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> *  FILE: megaraid_sas_fusion.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Authors: LSI Corporation</span>
<span class="cm"> *           Sumant Patro</span>
<span class="cm"> *           Adam Radford &lt;linuxraid@lsi.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Send feedback to: &lt;megaraidlinux@lsi.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Mail to: LSI Corporation, 1621 Barber Lane, Milpitas, CA 95035</span>
<span class="cm"> *     ATTN: Linuxraid</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;megaraid_sas_fusion.h&quot;</span>
<span class="cp">#include &quot;megaraid_sas.h&quot;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">megasas_free_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">megasas_get_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span>
					   <span class="o">*</span><span class="n">instance</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>
<span class="n">megasas_complete_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">alt_status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">megasas_is_ldio</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="kt">int</span>
<span class="n">wait_and_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>

<span class="kt">void</span>
<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">megasas_alloc_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>
<span class="kt">int</span>
<span class="n">megasas_clear_intr_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
<span class="kt">int</span>
<span class="n">megasas_issue_polled</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>

<span class="n">u8</span>
<span class="n">MR_BuildRaidContext</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">IO_REQUEST_INFO</span> <span class="o">*</span><span class="n">io_info</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">RAID_CONTEXT</span> <span class="o">*</span><span class="n">pRAID_Context</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>
<span class="n">u16</span> <span class="n">MR_TargetIdToLdGet</span><span class="p">(</span><span class="n">u32</span> <span class="n">ldTgtId</span><span class="p">,</span> <span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">MR_LD_RAID</span> <span class="o">*</span><span class="n">MR_LdRaidGet</span><span class="p">(</span><span class="n">u32</span> <span class="n">ld</span><span class="p">,</span> <span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>

<span class="n">u16</span> <span class="n">MR_GetLDTgtId</span><span class="p">(</span><span class="n">u32</span> <span class="n">ld</span><span class="p">,</span> <span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>

<span class="kt">void</span>
<span class="n">megasas_check_and_restore_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>

<span class="n">u8</span> <span class="n">MR_ValidateMapInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">LD_LOAD_BALANCE_INFO</span> <span class="o">*</span><span class="n">lbInfo</span><span class="p">);</span>
<span class="n">u16</span> <span class="n">get_updated_dev_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">LD_LOAD_BALANCE_INFO</span> <span class="o">*</span><span class="n">lbInfo</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">IO_REQUEST_INFO</span> <span class="o">*</span><span class="n">in_info</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">megasas_transition_to_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ocr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">megaraid_sas_kill_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>

<span class="k">extern</span> <span class="n">u32</span> <span class="n">megasas_dbg_lvl</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_enable_intr_fusion -	Enables interrupts</span>
<span class="cm"> * @regs:			MFI register set</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_enable_intr_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For Thunderbolt/Invader also clear intr on enable */</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_status</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_status</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">MFI_FUSION_ENABLE_INTERRUPT_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">outbound_intr_mask</span><span class="p">);</span>

	<span class="cm">/* Dummy readl to force pci flush */</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_disable_intr_fusion - Disables interrupt</span>
<span class="cm"> * @regs:			 MFI register set</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_disable_intr_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_mask</span><span class="p">);</span>
	<span class="cm">/* Dummy readl to force pci flush */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">megasas_clear_intr_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if it is our interrupt</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_status</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">outbound_intr_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MFI_FUSION_ENABLE_INTERRUPT_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_get_cmd_fusion -	Get a command from the free pool</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a free command from the pool</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="nf">megasas_get_cmd_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span>
						  <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="p">)</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">((</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">megasas_cmd_fusion</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Command pool (fusion) empty!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_return_cmd_fusion -	Return a cmd to free command pool</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> * @cmd:		Command packet to be returned to free command pool</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">megasas_return_cmd_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="p">)</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sync_cmd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ULONG_MAX</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_teardown_frame_pool_fusion -	Destroy the cmd frame DMA pool</span>
<span class="cm"> * @instance:				Adapter soft state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">megasas_teardown_frame_pool_fusion</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">max_cmd</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span> <span class="o">||</span> <span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: dma pool is null. SG Pool %p, &quot;</span>
		       <span class="s">&quot;sense pool : %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span><span class="p">,</span>
		       <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return all frames to pool</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame</span><span class="p">)</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame_phys_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_phys_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now destroy the pool itself</span>
<span class="cm">	 */</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span><span class="p">);</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">);</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_free_cmds_fusion -	Free all the cmds in the free cmd pool</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_free_cmds_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">max_cmds</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">,</span> <span class="n">io_frames_sz</span><span class="p">;</span>


	<span class="n">req_sz</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">request_alloc_sz</span><span class="p">;</span>
	<span class="n">reply_sz</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_alloc_sz</span><span class="p">;</span>
	<span class="n">io_frames_sz</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_frames_alloc_sz</span><span class="p">;</span>

	<span class="n">max_cmds</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span>

	<span class="cm">/* Free descriptors and request Frames memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span>
				  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span><span class="p">,</span>
				  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">,</span>
			      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">,</span>
			      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_phys</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">,</span>
			      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames</span><span class="p">,</span>
			      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_phys</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free the Fusion frame pool */</span>
	<span class="n">megasas_teardown_frame_pool_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="cm">/* Free all the commands in the cmd_list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Free the cmd_list buffer itself */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">);</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_create_frame_pool_fusion -	Creates DMA pool for cmd frames</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">megasas_create_frame_pool_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_sz_chain_frame</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>
	<span class="n">max_cmd</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span>

	<span class="n">total_sz_chain_frame</span> <span class="o">=</span> <span class="n">MEGASAS_MAX_SZ_CHAIN_FRAME</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use DMA pool facility provided by PCI layer</span>
<span class="cm">	 */</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;megasas sg pool fusion&quot;</span><span class="p">,</span>
					      <span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="n">total_sz_chain_frame</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: failed to setup request pool &quot;</span>
		       <span class="s">&quot;fusion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;megasas sense pool fusion&quot;</span><span class="p">,</span>
						 <span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: failed to setup sense pool &quot;</span>
		       <span class="s">&quot;fusion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span><span class="p">);</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate and attach a frame to each of the commands in cmd_list</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sg_dma_pool</span><span class="p">,</span>
					       <span class="n">GFP_KERNEL</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame_phys_addr</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">,</span>
					    <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_phys_addr</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * megasas_teardown_frame_pool_fusion() takes care of freeing</span>
<span class="cm">		 * whatever has been allocated</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: pci_pool_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">megasas_teardown_frame_pool_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_alloc_cmds_fusion -	Allocates the command packets</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Each frame has a 32-bit field called context. This context is used to get</span>
<span class="cm"> * back the megasas_cmd_fusion from the frame when a frame gets completed</span>
<span class="cm"> * In this driver, the 32 bit values are the indices into an array cmd_list.</span>
<span class="cm"> * This array is used only to look up the megasas_cmd_fusion given the context.</span>
<span class="cm"> * The free commands themselves are maintained in a linked list called cmd_pool.</span>
<span class="cm"> *</span>
<span class="cm"> * cmds are formed in the io_request and sg_frame members of the</span>
<span class="cm"> * megasas_cmd_fusion. The context field is used to get a request descriptor</span>
<span class="cm"> * and is used as SMID of the cmd.</span>
<span class="cm"> * SMID value range is from 1 to max_fw_cmds.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">megasas_alloc_cmds_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_cmd</span><span class="p">,</span> <span class="n">io_frames_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">MPI2_REPLY_DESCRIPTORS_UNION</span> <span class="o">*</span><span class="n">reply_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">io_req_base_phys</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">io_req_base</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">max_cmd</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">request_alloc_sz</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas; Could not allocate memory for &quot;</span>
		       <span class="s">&quot;request_frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_req_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span> <span class="o">=</span>
		<span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;reply_frames pool&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_alloc_sz</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas; Could not allocate memory for &quot;</span>
		       <span class="s">&quot;reply_frame pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_reply_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span> <span class="o">=</span>
		<span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas; Could not allocate memory for &quot;</span>
		       <span class="s">&quot;reply_frame pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_reply_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply_desc</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_q_depth</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">reply_desc</span><span class="o">++</span><span class="p">)</span>
		<span class="n">reply_desc</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>

	<span class="n">io_frames_sz</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_frames_alloc_sz</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span> <span class="o">=</span>
		<span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;io_request_frames pool&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_frames_alloc_sz</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Could not allocate memory for &quot;</span>
		       <span class="s">&quot;io_request_frame pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_io_frames</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames</span> <span class="o">=</span>
		<span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Could not allocate memory for &quot;</span>
		       <span class="s">&quot;io_request_frames frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_io_frames</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * fusion-&gt;cmd_list is an array of struct megasas_cmd_fusion pointers.</span>
<span class="cm">	 * Allocate the dynamic array first and then allocate individual</span>
<span class="cm">	 * commands.</span>
<span class="cm">	 */</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="p">)</span>
				   <span class="o">*</span><span class="n">max_cmd</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: out of memory. Could not alloc &quot;</span>
		       <span class="s">&quot;memory for cmd_list_fusion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_cmd_list</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="p">)</span>
	       <span class="o">*</span><span class="n">max_cmd</span><span class="p">);</span>

	<span class="n">max_cmd</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_cmd_fusion</span><span class="p">),</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not alloc cmd list fusion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">);</span>
			<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_cmd_list</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The first 256 bytes (SMID 0) is not used. Don&#39;t add to cmd list */</span>
	<span class="n">io_req_base</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames</span> <span class="o">+</span>
		<span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span><span class="p">;</span>
	<span class="n">io_req_base_phys</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_phys</span> <span class="o">+</span>
		<span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add all the commands to command pool (fusion-&gt;cmd_pool)</span>
<span class="cm">	 */</span>

	<span class="cm">/* SMID 0 is reserved. Set SMID/index from 1 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_cmd_fusion</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sync_cmd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ULONG_MAX</span><span class="p">;</span> <span class="cm">/* Set to Invalid */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="p">)</span>
		  <span class="p">(</span><span class="n">io_req_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request_phys_addr</span> <span class="o">=</span> <span class="n">io_req_base_phys</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create a frame pool and assign one frame to each cmd</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_create_frame_pool_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: Error creating frame DMA pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">megasas_free_cmds_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_req_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_cmd_list:</span>
	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">,</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames</span><span class="p">,</span>
		      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_phys</span><span class="p">);</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_pool</span><span class="p">);</span>
<span class="nl">fail_io_frames:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">request_alloc_sz</span><span class="p">,</span>
			  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">,</span>
			  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_phys</span><span class="p">);</span>
	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">,</span>
		      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">,</span>
		      <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_phys</span><span class="p">);</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_pool</span><span class="p">);</span>

<span class="nl">fail_reply_desc:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">request_alloc_sz</span><span class="p">,</span>
			  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span><span class="p">,</span>
			  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc_phys</span><span class="p">);</span>
<span class="nl">fail_req_desc:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wait_and_poll -	Issues a polling command</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> * @cmd:			Command packet to be issued</span>
<span class="cm"> *</span>
<span class="cm"> * For polling, MFI requires the cmd_status to be set to 0xFF before posting.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">wait_and_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_header</span> <span class="o">*</span><span class="n">frame_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">msecs</span> <span class="o">=</span> <span class="n">MFI_POLL_TIMEOUT_SECS</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for cmd_status to change</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">msecs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frame_hdr</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_hdr</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_ioc_init_fusion -	Initializes the FW</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> * Issues the IOC Init cmd</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">megasas_ioc_init_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">megasas_init_frame</span> <span class="o">*</span><span class="n">init_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_IOC_INIT_REQUEST</span> <span class="o">*</span><span class="n">IOCInitMessage</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">ioc_init_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="n">req_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_header</span> <span class="o">*</span><span class="n">frame_hdr</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">megasas_get_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not allocate cmd for INIT Frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_get_cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IOCInitMessage</span> <span class="o">=</span>
	  <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_IOC_INIT_REQUEST</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">ioc_init_handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IOCInitMessage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not allocate memory for &quot;</span>
		       <span class="s">&quot;IOCInitMessage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_fw_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">IOCInitMessage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_IOC_INIT_REQUEST</span><span class="p">));</span>

	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_IOC_INIT</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">WhoInit</span>	<span class="o">=</span> <span class="n">MPI2_WHOINIT_HOST_DRIVER</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">MsgVersion</span> <span class="o">=</span> <span class="n">MPI2_VERSION</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">HeaderVersion</span> <span class="o">=</span> <span class="n">MPI2_HEADER_VERSION</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">SystemRequestFrameSize</span> <span class="o">=</span>
		<span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">ReplyDescriptorPostQueueDepth</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_q_depth</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">ReplyDescriptorPostQueueAddress</span>	<span class="o">=</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc_phys</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">SystemRequestFrameBaseAddress</span> <span class="o">=</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_request_frames_phys</span><span class="p">;</span>
	<span class="n">IOCInitMessage</span><span class="o">-&gt;</span><span class="n">HostMSIxVectors</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span><span class="p">;</span>
	<span class="n">init_frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">megasas_init_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">init_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MEGAMFI_FRAME_SIZE</span><span class="p">);</span>

	<span class="n">frame_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">frame_hdr</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">frame_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MFI_FRAME_DONT_POST_IN_REPLY_QUEUE</span><span class="p">;</span>

	<span class="n">init_frame</span><span class="o">-&gt;</span><span class="n">cmd</span>	<span class="o">=</span> <span class="n">MFI_CMD_INIT</span><span class="p">;</span>
	<span class="n">init_frame</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">init_frame</span><span class="o">-&gt;</span><span class="n">queue_info_new_phys_addr_lo</span> <span class="o">=</span> <span class="n">ioc_init_handle</span><span class="p">;</span>
	<span class="n">init_frame</span><span class="o">-&gt;</span><span class="n">data_xfer_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_IOC_INIT_REQUEST</span><span class="p">);</span>

	<span class="n">req_desc</span> <span class="o">=</span>
	  <span class="p">(</span><span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="p">)</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span><span class="p">;</span>

	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame_phys_addr</span><span class="p">;</span>
	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">MFAIo</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_MFA</span> <span class="o">&lt;&lt;</span>
		 <span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable the intr before firing the init frame</span>
<span class="cm">	 */</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">disable_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">fire_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">low</span><span class="p">,</span>
				      <span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">high</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>

	<span class="n">wait_and_poll</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">frame_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_hdr</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_fw_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas:IOC Init cmd success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_fw_init:</span>
	<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IOCInitMessage</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_IOC_INIT_REQUEST</span><span class="p">),</span>
				  <span class="n">IOCInitMessage</span><span class="p">,</span> <span class="n">ioc_init_handle</span><span class="p">);</span>
<span class="nl">fail_get_cmd:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * megasas_get_ld_map_info -	Returns FW&#39;s ld_map structure</span>
<span class="cm"> * @instance:				Adapter soft state</span>
<span class="cm"> * @pend:				Pend the command or not</span>
<span class="cm"> * Issues an internal command (DCMD) to get the FW&#39;s controller PD</span>
<span class="cm"> * list structure.  This information is mainly used to find out SYSTEM</span>
<span class="cm"> * supported by the FW.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">megasas_get_ld_map_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_dcmd_frame</span> <span class="o">*</span><span class="n">dcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">ci</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ci_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size_map_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">megasas_get_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: Failed to get cmd for map info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dcmd</span><span class="p">;</span>

	<span class="n">size_map_info</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_FW_RAID_MAP</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_LD_SPAN_MAP</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">MAX_LOGICAL_DRIVES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)];</span>
	<span class="n">ci_h</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map_phys</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Failed to alloc mem for ld_map_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ci</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MFI_MBOX_SIZE</span><span class="p">);</span>

	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MFI_CMD_DCMD</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">sge_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MFI_FRAME_DIR_READ</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">pad_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">data_xfer_len</span> <span class="o">=</span> <span class="n">size_map_info</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MR_DCMD_LD_MAP_GET_INFO</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">sge32</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">ci_h</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">sge32</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">size_map_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">megasas_issue_polled</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Get LD Map Info Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">megasas_get_map_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">fast_path_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">megasas_get_ld_map_info</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MR_ValidateMapInfo</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)],</span>
				       <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">load_balance_info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">fast_path_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * megasas_sync_map_info -	Returns FW&#39;s ld_map structure</span>
<span class="cm"> * @instance:				Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> * Issues an internal command (DCMD) to get the FW&#39;s controller PD</span>
<span class="cm"> * list structure.  This information is mainly used to find out SYSTEM</span>
<span class="cm"> * supported by the FW.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">megasas_sync_map_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_dcmd_frame</span> <span class="o">*</span><span class="n">dcmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size_sync_info</span><span class="p">,</span> <span class="n">num_lds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_LD_TARGET_SYNC</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_LD_RAID</span>  <span class="o">*</span><span class="n">raid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_LD_TARGET_SYNC</span> <span class="o">*</span><span class="n">ld_sync</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ci_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size_map_info</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">megasas_get_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: Failed to get cmd for sync&quot;</span>
		       <span class="s">&quot;info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">num_lds</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">raidMap</span><span class="p">.</span><span class="n">ldCount</span><span class="p">;</span>

	<span class="n">dcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dcmd</span><span class="p">;</span>

	<span class="n">size_sync_info</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_LD_TARGET_SYNC</span><span class="p">)</span> <span class="o">*</span><span class="n">num_lds</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MFI_MBOX_SIZE</span><span class="p">);</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MR_LD_TARGET_SYNC</span> <span class="o">*</span><span class="p">)</span>
	  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span><span class="p">));</span>

	<span class="n">ci_h</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map_phys</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ld_sync</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MR_LD_TARGET_SYNC</span> <span class="o">*</span><span class="p">)</span><span class="n">ci</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_lds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ld_sync</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raid</span> <span class="o">=</span> <span class="n">MR_LdRaidGet</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="n">ld_sync</span><span class="o">-&gt;</span><span class="n">targetId</span> <span class="o">=</span> <span class="n">MR_GetLDTgtId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="n">ld_sync</span><span class="o">-&gt;</span><span class="n">seqNum</span> <span class="o">=</span> <span class="n">raid</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size_map_info</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_FW_RAID_MAP</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_LD_SPAN_MAP</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">MAX_LOGICAL_DRIVES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MFI_CMD_DCMD</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">sge_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MFI_FRAME_DIR_WRITE</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">pad_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">data_xfer_len</span> <span class="o">=</span> <span class="n">size_map_info</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_lds</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGASAS_DCMD_MBOX_PEND_FLAG</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MR_DCMD_LD_MAP_GET_INFO</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">sge32</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">ci_h</span><span class="p">;</span>
	<span class="n">dcmd</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">sge32</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">size_map_info</span><span class="p">;</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_update_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">issue_dcmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_init_adapter_fusion -	Initializes the FW</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> * This is the main function for initializing firmware.</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">megasas_init_adapter_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">reg_set</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get various operational parameters from status register</span>
<span class="cm">	 */</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span> <span class="o">=</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">read_fw_status_reg</span><span class="p">(</span><span class="n">reg_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFF</span><span class="p">;</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">1008</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reduce the max supported cmds by 1. This is to ensure that the</span>
<span class="cm">	 * reply_q_sz (1 more than the max cmd that driver may send)</span>
<span class="cm">	 * does not exceed max cmds that the FW can support</span>
<span class="cm">	 */</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Only internal cmds (DCMD) need to have MFI frames */</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_mfi_cmds</span> <span class="o">=</span> <span class="n">MEGASAS_INT_CMDS</span><span class="p">;</span>

	<span class="n">max_cmd</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_q_depth</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_cmd</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">request_alloc_sz</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span><span class="p">)</span> <span class="o">*</span><span class="n">max_cmd</span><span class="p">;</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_alloc_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MPI2_REPLY_DESCRIPTORS_UNION</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_q_depth</span><span class="p">);</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">io_frames_alloc_sz</span> <span class="o">=</span> <span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span> <span class="o">*</span>
		 <span class="p">(</span><span class="n">max_cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span> <span class="cm">/* Extra 1 for SMID 0 */</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_main_msg</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span> <span class="o">-</span>
	   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span><span class="p">,</span> <span class="n">SGL</span><span class="p">))</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_chain</span> <span class="o">=</span>
		<span class="n">MEGASAS_MAX_SZ_CHAIN_FRAME</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MPI2_SGE_IO_UNION</span><span class="p">);</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_num_sge</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_main_msg</span> <span class="o">+</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_chain</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Used for pass thru MFI frame (DCMD) */</span>
	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">chain_offset_mfi_pthru</span> <span class="o">=</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">chain_offset_io_request</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">MEGA_MPI2_RAID_DEFAULT_IO_FRAME_SIZE</span> <span class="o">-</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MPI2_SGE_IO_UNION</span><span class="p">))</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate memory for descriptors</span>
<span class="cm">	 * Create a pool of commands</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_alloc_cmds</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_alloc_mfi_cmds</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_alloc_cmds_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_alloc_cmds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_ioc_init_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_ioc_init</span><span class="p">;</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">flag_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">map_sz</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_FW_RAID_MAP</span><span class="p">)</span> <span class="o">+</span>
	  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MR_LD_SPAN_MAP</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">MAX_LOGICAL_DRIVES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">fast_path_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">map_sz</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map_phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Could not allocate memory &quot;</span>
			       <span class="s">&quot;for map info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_map_info</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">megasas_get_map_info</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
		<span class="n">megasas_sync_map_info</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_map_info:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">map_sz</span><span class="p">,</span>
				  <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map_phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">fail_ioc_init:</span>
	<span class="n">megasas_free_cmds_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="nl">fail_alloc_cmds:</span>
	<span class="n">megasas_free_cmds</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="nl">fail_alloc_mfi_cmds:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_fire_cmd_fusion -	Sends command to the FW</span>
<span class="cm"> * @frame_phys_addr :		Physical address of cmd</span>
<span class="cm"> * @frame_count :		Number of frames for the command</span>
<span class="cm"> * @regs :			MFI register set</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_fire_cmd_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			<span class="n">dma_addr_t</span> <span class="n">req_desc_lo</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">req_desc_hi</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">req_desc_lo</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inbound_low_queue_port</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">req_desc_hi</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inbound_high_queue_port</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * map_cmd_status -	Maps FW cmd status to OS cmd status</span>
<span class="cm"> * @cmd :		Pointer to cmd</span>
<span class="cm"> * @status :		status of cmd returned by FW</span>
<span class="cm"> * @ext_status :	ext status of cmd returned by FW</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">map_cmd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ext_status</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MFI_STAT_OK</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MFI_STAT_SCSI_IO_FAILED</span>:
	<span class="k">case</span> <span class="n">MFI_STAT_LD_INIT_IN_PROGRESS</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ext_status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MFI_STAT_SCSI_DONE_WITH_ERROR</span>:

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ext_status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
			       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">DRIVER_SENSE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MFI_STAT_LD_OFFLINE</span>:
	<span class="k">case</span> <span class="n">MFI_STAT_DEVICE_NOT_FOUND</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MFI_STAT_CONFIG_SEQ_MISMATCH</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_IMM_RETRY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;megasas: FW status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_make_sgl_fusion -	Prepares 32-bit SGL</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> * @scp:		SCSI command from the mid-layer</span>
<span class="cm"> * @sgl_ptr:		SGL to be filled in</span>
<span class="cm"> * @cmd:		cmd we are working on</span>
<span class="cm"> *</span>
<span class="cm"> * If successful, this function returns the number of SG elements.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">megasas_make_sgl_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="n">sgl_ptr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sg_processed</span><span class="p">,</span> <span class="n">sge_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">os_sgl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="n">sgl_ptr_end</span> <span class="o">=</span> <span class="n">sgl_ptr</span><span class="p">;</span>
		<span class="n">sgl_ptr_end</span> <span class="o">+=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_main_msg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sgl_ptr_end</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sge_count</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sge_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sge_count</span> <span class="o">&gt;</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_num_sge</span> <span class="o">||</span> <span class="o">!</span><span class="n">sge_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sge_count</span><span class="p">;</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">os_sgl</span><span class="p">,</span> <span class="n">sge_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgl_ptr</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">os_sgl</span><span class="p">);</span>
		<span class="n">sgl_ptr</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">os_sgl</span><span class="p">);</span>
		<span class="n">sgl_ptr</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sge_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">sgl_ptr</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">IEEE_SGE_FLAGS_END_OF_LIST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sgl_ptr</span><span class="o">++</span><span class="p">;</span>

		<span class="n">sg_processed</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sg_processed</span> <span class="o">==</span>  <span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_main_msg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sge_count</span> <span class="o">&gt;</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_main_msg</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="n">sg_chain</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span>
			    <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">&amp;</span>
				<span class="n">MPI25_SAS_DEVICE0_FLAGS_ENABLED_FAST_PATH</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">MPI25_SAS_DEVICE0_FLAGS_ENABLED_FAST_PATH</span><span class="p">)</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span>
						<span class="n">fusion</span><span class="o">-&gt;</span>
						<span class="n">chain_offset_io_request</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span>
					<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">chain_offset_io_request</span><span class="p">;</span>

			<span class="n">sg_chain</span> <span class="o">=</span> <span class="n">sgl_ptr</span><span class="p">;</span>
			<span class="cm">/* Prepare chain element */</span>
			<span class="n">sg_chain</span><span class="o">-&gt;</span><span class="n">NextChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span>
			    <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span>
				<span class="n">sg_chain</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">IEEE_SGE_FLAGS_CHAIN_ELEMENT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sg_chain</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">IEEE_SGE_FLAGS_CHAIN_ELEMENT</span> <span class="o">|</span>
					 <span class="n">MPI2_IEEE_SGE_FLAGS_IOCPLBNTA_ADDR</span><span class="p">);</span>
			<span class="n">sg_chain</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span>  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MPI2_SGE_IO_UNION</span><span class="p">)</span>
					     <span class="o">*</span><span class="p">(</span><span class="n">sge_count</span> <span class="o">-</span> <span class="n">sg_processed</span><span class="p">));</span>
			<span class="n">sg_chain</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame_phys_addr</span><span class="p">;</span>

			<span class="n">sgl_ptr</span> <span class="o">=</span>
			  <span class="p">(</span><span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sg_frame</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sge_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_set_pd_lba -	Sets PD LBA</span>
<span class="cm"> * @cdb:		CDB</span>
<span class="cm"> * @cdb_len:		cdb length</span>
<span class="cm"> * @start_blk:		Start block of IO</span>
<span class="cm"> *</span>
<span class="cm"> * Used to set the PD LBA in CDB for FP IOs</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_set_pd_lba</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="n">io_request</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cdb_len</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">IO_REQUEST_INFO</span> <span class="o">*</span><span class="n">io_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">local_map_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ref_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MR_LD_RAID</span> <span class="o">*</span><span class="n">raid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ld</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start_blk</span> <span class="o">=</span> <span class="n">io_info</span><span class="o">-&gt;</span><span class="n">pdBlock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cdb</span> <span class="o">=</span> <span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">io_info</span><span class="o">-&gt;</span><span class="n">numBlocks</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flagvals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">groupnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if T10 PI (DIF) is enabled for this LD */</span>
	<span class="n">ld</span> <span class="o">=</span> <span class="n">MR_TargetIdToLdGet</span><span class="p">(</span><span class="n">io_info</span><span class="o">-&gt;</span><span class="n">ldTgtId</span><span class="p">,</span> <span class="n">local_map_ptr</span><span class="p">);</span>
	<span class="n">raid</span> <span class="o">=</span> <span class="n">MR_LdRaidGet</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">local_map_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">.</span><span class="n">ldPiMode</span> <span class="o">==</span> <span class="n">MR_PROT_INFO_TYPE_CONTROLLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">));</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">MEGASAS_SCSI_VARIABLE_LENGTH_CMD</span><span class="p">;</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>  <span class="n">MEGASAS_SCSI_ADDL_CDB_LEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGASAS_SCSI_SERVICE_ACTION_READ32</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGASAS_SCSI_SERVICE_ACTION_WRITE32</span><span class="p">;</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGASAS_RD_WR_PROTECT_CHECK_ALL</span><span class="p">;</span>

		<span class="cm">/* LBA */</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* Logical block reference tag */</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">EEDP32</span><span class="p">.</span><span class="n">PrimaryReferenceTag</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ref_tag</span><span class="p">);</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">EEDP32</span><span class="p">.</span><span class="n">PrimaryApplicationTagMask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">num_blocks</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* Specify 32-byte cdb */</span>

		<span class="cm">/* Transfer length */</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cdb</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">num_blocks</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* set SCSI IO EEDPFlags */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">EEDPFlags</span> <span class="o">=</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_INC_PRI_REFTAG</span>  <span class="o">|</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_REFTAG</span> <span class="o">|</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_REMOVE_OP</span> <span class="o">|</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_APPTAG</span> <span class="o">|</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_GUARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">EEDPFlags</span> <span class="o">=</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_INC_PRI_REFTAG</span> <span class="o">|</span>
				<span class="n">MPI2_SCSIIO_EEDPFLAGS_INSERT_OP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">);</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">EEDPBlockSize</span> <span class="o">=</span> <span class="n">MEGASAS_EEDPBLOCKSIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Some drives don&#39;t support 16/12 byte CDB&#39;s, convert to 10 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">cdb_len</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cdb_len</span> <span class="o">==</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">start_blk</span> <span class="o">&lt;=</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cdb_len</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_16</span> <span class="o">?</span> <span class="n">READ_10</span> <span class="o">:</span> <span class="n">WRITE_10</span><span class="p">;</span>
				<span class="n">flagvals</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">groupnum</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
				<span class="n">control</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_12</span> <span class="o">?</span> <span class="n">READ_10</span> <span class="o">:</span> <span class="n">WRITE_10</span><span class="p">;</span>
				<span class="n">flagvals</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">groupnum</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
				<span class="n">control</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">));</span>

			<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagvals</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupnum</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">control</span><span class="p">;</span>

			<span class="cm">/* Transfer length */</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">num_blocks</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* Specify 10-byte cdb */</span>
			<span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cdb_len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Convert to 16 byte CDB for large LBA&#39;s */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cdb_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span> <span class="o">?</span> <span class="n">READ_16</span> <span class="o">:</span> <span class="n">WRITE_16</span><span class="p">;</span>
				<span class="n">control</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">opcode</span> <span class="o">=</span>
					<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span> <span class="o">?</span> <span class="n">READ_16</span> <span class="o">:</span> <span class="n">WRITE_16</span><span class="p">;</span>
				<span class="n">flagvals</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">groupnum</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
				<span class="n">control</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="n">opcode</span> <span class="o">=</span>
					<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_12</span> <span class="o">?</span> <span class="n">READ_16</span> <span class="o">:</span> <span class="n">WRITE_16</span><span class="p">;</span>
				<span class="n">flagvals</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">groupnum</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
				<span class="n">control</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">));</span>

			<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagvals</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupnum</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">control</span><span class="p">;</span>

			<span class="cm">/* Transfer length */</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">num_blocks</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">num_blocks</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* Specify 16-byte cdb */</span>
			<span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Normal case, just load LBA here */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cdb_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">6</span>:
		<span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">;</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">|</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12</span>:
			<span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_build_ldio_fusion -	Prepares IOs to devices</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> * @scp:		SCSI command</span>
<span class="cm"> * @cmd:		Command to be prepared</span>
<span class="cm"> *</span>
<span class="cm"> * Prepares the io_request and chain elements (sg_frame) for IO</span>
<span class="cm"> * The IO can be for PD (Fast Path) or LD</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_build_ldio_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fp_possible</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_lba_lo</span><span class="p">,</span> <span class="n">start_lba_hi</span><span class="p">,</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="n">io_request</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="n">req_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IO_REQUEST_INFO</span> <span class="n">io_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">local_map_ptr</span><span class="p">;</span>

	<span class="n">device_id</span> <span class="o">=</span> <span class="n">MEGASAS_DEV_INDEX</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scp</span><span class="p">);</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">io_request</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">VirtualDiskTgtId</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">exStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="p">;</span>

	<span class="n">start_lba_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">start_lba_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fp_possible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 6-byte READ(0x08) or WRITE(0x0A) cdb</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">start_lba_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">start_lba_lo</span> <span class="o">&amp;=</span> <span class="mh">0x1FFFFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 10-byte READ(0x28) or WRITE(0x2A) cdb</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">start_lba_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 12-byte READ(0xA8) or WRITE(0xAA) cdb</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">start_lba_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 16-byte READ(0x88) or WRITE(0x8A) cdb</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">start_lba_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

		<span class="n">start_lba_hi</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">IO_REQUEST_INFO</span><span class="p">));</span>
	<span class="n">io_info</span><span class="p">.</span><span class="n">ldStartBlock</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">start_lba_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">start_lba_lo</span><span class="p">;</span>
	<span class="n">io_info</span><span class="p">.</span><span class="n">numBlocks</span> <span class="o">=</span> <span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">;</span>
	<span class="n">io_info</span><span class="p">.</span><span class="n">ldTgtId</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span>
		<span class="n">io_info</span><span class="p">.</span><span class="n">isRead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">local_map_ptr</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">MR_TargetIdToLdGet</span><span class="p">(</span><span class="n">device_id</span><span class="p">,</span> <span class="n">local_map_ptr</span><span class="p">)</span> <span class="o">&gt;=</span>
	     <span class="n">MAX_LOGICAL_DRIVES</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">fast_path_io</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockFlags</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fp_possible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MR_BuildRaidContext</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_info</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">,</span>
					<span class="n">local_map_ptr</span><span class="p">))</span>
			<span class="n">fp_possible</span> <span class="o">=</span> <span class="n">io_info</span><span class="p">.</span><span class="n">fpOkForIo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use smp_processor_id() for now until cmd-&gt;request-&gt;cpu is CPU</span>
<span class="cm">	   id by default, not CPU group id, otherwise all MSI-X queues won&#39;t</span>
<span class="cm">	   be utilized */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">MSIxIndex</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">?</span>
		<span class="n">smp_processor_id</span><span class="p">()</span> <span class="o">%</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp_possible</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">megasas_set_pd_lba</span><span class="p">(</span><span class="n">io_request</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_info</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span>
				   <span class="n">local_map_ptr</span><span class="p">,</span> <span class="n">start_lba_lo</span><span class="p">);</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_IO_REQUEST</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">MPI2_REQ_DESCRIPT_FLAGS_HIGH_PRIORITY</span>
			 <span class="o">&lt;&lt;</span> <span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockFlags</span> <span class="o">==</span>
			    <span class="n">REGION_TYPE_UNUSED</span><span class="p">)</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_NO_LOCK</span> <span class="o">&lt;&lt;</span>
					<span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">MPI2_TYPE_CUDA</span><span class="p">;</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">nseg</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">|=</span>
			  <span class="n">MPI25_SAS_DEVICE0_FLAGS_ENABLED_FAST_PATH</span><span class="p">;</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockFlags</span> <span class="o">|=</span>
			  <span class="p">(</span><span class="n">MR_RL_FLAGS_GRANT_DESTINATION_CUDA</span> <span class="o">|</span>
			   <span class="n">MR_RL_FLAGS_SEQ_NUM_ENABLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">load_balance_info</span><span class="p">[</span><span class="n">device_id</span><span class="p">].</span><span class="n">loadBalanceFlag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">io_info</span><span class="p">.</span><span class="n">isRead</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">io_info</span><span class="p">.</span><span class="n">devHandle</span> <span class="o">=</span>
				<span class="n">get_updated_dev_handle</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">load_balance_info</span><span class="p">[</span><span class="n">device_id</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">io_info</span><span class="p">);</span>
			<span class="n">scp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">|=</span> <span class="n">MEGASAS_LOAD_BALANCE_FLAG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">scp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEGASAS_LOAD_BALANCE_FLAG</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">io_info</span><span class="p">.</span><span class="n">devHandle</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">io_info</span><span class="p">.</span><span class="n">devHandle</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">timeoutValue</span> <span class="o">=</span>
			<span class="n">local_map_ptr</span><span class="o">-&gt;</span><span class="n">raidMap</span><span class="p">.</span><span class="n">fpPdIoTimeoutSec</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_LD_IO</span>
			 <span class="o">&lt;&lt;</span> <span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockFlags</span> <span class="o">==</span>
			    <span class="n">REGION_TYPE_UNUSED</span><span class="p">)</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_NO_LOCK</span> <span class="o">&lt;&lt;</span>
					<span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">MPI2_TYPE_CUDA</span><span class="p">;</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockFlags</span> <span class="o">|=</span>
				<span class="p">(</span><span class="n">MR_RL_FLAGS_GRANT_DESTINATION_CPU0</span> <span class="o">|</span>
				 <span class="n">MR_RL_FLAGS_SEQ_NUM_ENABLE</span><span class="p">);</span>
			<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">nseg</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MEGASAS_MPI2_FUNCTION_LD_IO_REQUEST</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* Not FP */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_build_dcdb_fusion -	Prepares IOs to devices</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> * @scp:		SCSI command</span>
<span class="cm"> * @cmd:		Command to be prepared</span>
<span class="cm"> *</span>
<span class="cm"> * Prepares the io_request frame for non-io cmds</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">megasas_build_dcdb_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="n">io_request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MR_FW_RAID_MAP_ALL</span> <span class="o">*</span><span class="n">local_map_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">io_request</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="p">;</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">MEGASAS_DEV_INDEX</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="n">pd_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">*</span> <span class="n">MEGASAS_MAX_DEV_PER_CHANNEL</span><span class="p">)</span>
		<span class="o">+</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">local_map_ptr</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">ld_map</span><span class="p">[(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">map_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)];</span>

	<span class="cm">/* Check if this is a system PD I/O */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pd_list</span><span class="p">[</span><span class="n">pd_index</span><span class="p">].</span><span class="n">driveState</span> <span class="o">==</span> <span class="n">MR_PD_STATE_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span>
			<span class="n">local_map_ptr</span><span class="o">-&gt;</span><span class="n">raidMap</span><span class="p">.</span><span class="n">devHndlInfo</span><span class="p">[</span><span class="n">device_id</span><span class="p">].</span><span class="n">curDevHdl</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">timeoutValue</span> <span class="o">=</span>
			<span class="n">local_map_ptr</span><span class="o">-&gt;</span><span class="n">raidMap</span><span class="p">.</span><span class="n">fpPdIoTimeoutSec</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockRowLBA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">regLockLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">RAIDFlags</span> <span class="o">=</span>
			<span class="n">MR_RAID_FLAGS_IO_SUB_TYPE_SYSTEM_PD</span> <span class="o">&lt;&lt;</span>
			<span class="n">MR_RAID_CTX_RAID_FLAGS_IO_SUB_TYPE_SHIFT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">MPI2_REQ_DESCRIPT_FLAGS_HIGH_PRIORITY</span> <span class="o">&lt;&lt;</span>
			 <span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Function</span>  <span class="o">=</span> <span class="n">MEGASAS_MPI2_FUNCTION_LD_IO_REQUEST</span><span class="p">;</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">MPI2_REQ_DESCRIPT_FLAGS_SCSI_IO</span> <span class="o">&lt;&lt;</span>
			 <span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">VirtualDiskTgtId</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_build_io_fusion -	Prepares IOs to devices</span>
<span class="cm"> * @instance:		Adapter soft state</span>
<span class="cm"> * @scp:		SCSI command</span>
<span class="cm"> * @cmd:		Command to be prepared</span>
<span class="cm"> *</span>
<span class="cm"> * Invokes helper functions to prepare request frames</span>
<span class="cm"> * and sets flags appropriate for IO/Non-IO cmd</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">megasas_build_io_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">sge_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="n">io_request</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="p">;</span>

	<span class="n">device_id</span> <span class="o">=</span> <span class="n">MEGASAS_DEV_INDEX</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scp</span><span class="p">);</span>

	<span class="cm">/* Zero out some fields so they don&#39;t get reused */</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">EEDP32</span><span class="p">.</span><span class="n">PrimaryReferenceTag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">EEDP32</span><span class="p">.</span><span class="n">PrimaryApplicationTagMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">EEDPFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">EEDPBlockSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">RAIDFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">nseg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Just the CDB length,rest of the Flags are zero</span>
<span class="cm">	 * This will be modified for FP in build_ldio_fusion</span>
<span class="cm">	 */</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_is_ldio</span><span class="p">(</span><span class="n">scp</span><span class="p">))</span>
		<span class="n">megasas_build_ldio_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">megasas_build_dcdb_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Construct SGL</span>
<span class="cm">	 */</span>

	<span class="n">sge_count</span> <span class="o">=</span>
		<span class="n">megasas_make_sgl_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sge_count</span> <span class="o">&gt;</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_num_sge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Error. sge_count (0x%x) exceeds &quot;</span>
		       <span class="s">&quot;max (0x%x) allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sge_count</span><span class="p">,</span>
		       <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_num_sge</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">numSGE</span> <span class="o">=</span> <span class="n">sge_count</span><span class="p">;</span>

	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">SGLFlags</span> <span class="o">=</span> <span class="n">MPI2_SGE_FLAGS_64_BIT_ADDRESSING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">)</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_CONTROL_WRITE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span>
		<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_CONTROL_READ</span><span class="p">;</span>

	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">SGLOffset0</span> <span class="o">=</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">SenseBufferLowAddress</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_phys_addr</span><span class="p">;</span>
	<span class="n">io_request</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">scp</span><span class="p">;</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span>
<span class="nf">megasas_get_request_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Invalid SMID (0x%x)request for &quot;</span>
		       <span class="s">&quot;descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">req_frames_desc</span>
		<span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span><span class="p">)</span> <span class="o">*</span><span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_build_and_issue_cmd_fusion -Main routine for building and</span>
<span class="cm"> *                                     issuing non IOCTL cmd</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> * @scmd:			pointer to scsi cmd from OS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">megasas_build_and_issue_cmd_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="n">req_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">megasas_get_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">req_desc</span> <span class="o">=</span> <span class="n">megasas_get_request_descriptor</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span> <span class="o">=</span> <span class="n">req_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_build_io_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">megasas_return_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: Error building command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req_desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request_desc</span><span class="p">;</span>
	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">SMID</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">!=</span> <span class="mh">0xF</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;megasas: The chain offset value is not &quot;</span>
		       <span class="s">&quot;correct : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Issue the command to the FW</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fw_outstanding</span><span class="p">);</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">fire_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
				      <span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">low</span><span class="p">,</span> <span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">high</span><span class="p">,</span>
				      <span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * complete_cmd_fusion -	Completes command</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> * Completes all commands that is in reply descriptor queue</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">complete_cmd_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="n">u32</span> <span class="n">MSIxIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">MPI2_REPLY_DESCRIPTORS_UNION</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_SCSI_IO_SUCCESS_REPLY_DESCRIPTOR</span> <span class="o">*</span><span class="n">reply_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="n">scsi_io_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd_mfi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd_fusion</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">num_completed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reply_descript_type</span><span class="p">,</span> <span class="n">arm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">extStatus</span><span class="p">,</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">desc_value</span> <span class="n">d_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">LD_LOAD_BALANCE_INFO</span> <span class="o">*</span><span class="n">lbinfo</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">==</span> <span class="n">MEGASAS_HW_CRITICAL_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">+=</span> <span class="p">((</span><span class="n">MSIxIndex</span> <span class="o">*</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_alloc_sz</span><span class="p">)</span><span class="o">/</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MPI2_REPLY_DESCRIPTORS_UNION</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">MSIxIndex</span><span class="p">];</span>

	<span class="n">reply_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_SCSI_IO_SUCCESS_REPLY_DESCRIPTOR</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">d_val</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">;</span>

	<span class="n">reply_descript_type</span> <span class="o">=</span> <span class="n">reply_desc</span><span class="o">-&gt;</span><span class="n">ReplyFlags</span> <span class="o">&amp;</span>
		<span class="n">MPI2_RPY_DESCRIPT_FLAGS_TYPE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply_descript_type</span> <span class="o">==</span> <span class="n">MPI2_RPY_DESCRIPT_FLAGS_UNUSED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">d_val</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">;</span>

	<span class="n">num_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">d_val</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">low</span> <span class="o">!=</span> <span class="n">UINT_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d_val</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">high</span> <span class="o">!=</span> <span class="n">UINT_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smid</span> <span class="o">=</span> <span class="n">reply_desc</span><span class="o">-&gt;</span><span class="n">SMID</span><span class="p">;</span>

		<span class="n">cmd_fusion</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">scsi_io_req</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="p">)</span>
		  <span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">)</span>
			<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">scsi_io_req</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
		<span class="n">extStatus</span> <span class="o">=</span> <span class="n">scsi_io_req</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">exStatus</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_io_req</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_FUNCTION_SCSI_IO_REQUEST</span>:  <span class="cm">/*Fast Path IO.*/</span>
			<span class="cm">/* Update load balancing info */</span>
			<span class="n">device_id</span> <span class="o">=</span> <span class="n">MEGASAS_DEV_INDEX</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
						      <span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">);</span>
			<span class="n">lbinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">load_balance_info</span><span class="p">[</span><span class="n">device_id</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;</span>
			    <span class="n">MEGASAS_LOAD_BALANCE_FLAG</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arm</span> <span class="o">=</span> <span class="n">lbinfo</span><span class="o">-&gt;</span><span class="n">raid1DevHandle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
					<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
					<span class="mi">1</span><span class="p">;</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lbinfo</span><span class="o">-&gt;</span><span class="n">scsi_pending_cmds</span><span class="p">[</span><span class="n">arm</span><span class="p">]);</span>
				<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="n">MEGASAS_LOAD_BALANCE_FLAG</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reply_descript_type</span> <span class="o">==</span>
			    <span class="n">MPI2_RPY_DESCRIPT_FLAGS_SCSI_IO_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">megasas_dbg_lvl</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">megasas: FAST Path &quot;</span>
					       <span class="s">&quot;IO Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Fall thru and complete IO */</span>
		<span class="k">case</span> <span class="n">MEGASAS_MPI2_FUNCTION_LD_IO_REQUEST</span>: <span class="cm">/* LD-IO Path */</span>
			<span class="cm">/* Map the FW Cmd Status */</span>
			<span class="n">map_cmd_status</span><span class="p">(</span><span class="n">cmd_fusion</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">extStatus</span><span class="p">);</span>
			<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">);</span>
			<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">);</span>
			<span class="n">scsi_io_req</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scsi_io_req</span><span class="o">-&gt;</span><span class="n">RaidContext</span><span class="p">.</span><span class="n">exStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">megasas_return_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd_fusion</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fw_outstanding</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEGASAS_MPI2_FUNCTION_PASSTHRU_IO_REQUEST</span>: <span class="cm">/*MFI command */</span>
			<span class="n">cmd_mfi</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">sync_cmd_idx</span><span class="p">];</span>
			<span class="n">megasas_complete_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd_mfi</span><span class="p">,</span> <span class="n">DID_OK</span><span class="p">);</span>
			<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">megasas_return_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd_fusion</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">MSIxIndex</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">MSIxIndex</span><span class="p">]</span> <span class="o">&gt;=</span>
		    <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_q_depth</span><span class="p">)</span>
			<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">MSIxIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
		<span class="n">num_completed</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Get the next reply descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">MSIxIndex</span><span class="p">])</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">MSIxIndex</span> <span class="o">*</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_alloc_sz</span><span class="p">)</span><span class="o">/</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">MPI2_REPLY_DESCRIPTORS_UNION</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">desc</span><span class="o">++</span><span class="p">;</span>

		<span class="n">reply_desc</span> <span class="o">=</span>
		  <span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_SCSI_IO_SUCCESS_REPLY_DESCRIPTOR</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">d_val</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">;</span>

		<span class="n">reply_descript_type</span> <span class="o">=</span> <span class="n">reply_desc</span><span class="o">-&gt;</span><span class="n">ReplyFlags</span> <span class="o">&amp;</span>
			<span class="n">MPI2_RPY_DESCRIPT_FLAGS_TYPE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reply_descript_type</span> <span class="o">==</span> <span class="n">MPI2_RPY_DESCRIPT_FLAGS_UNUSED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_completed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">MSIxIndex</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">MSIxIndex</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">);</span>
	<span class="n">megasas_check_and_restore_queue_depth</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_complete_cmd_dpc_fusion -	Completes command</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> *</span>
<span class="cm"> * Tasklet to complete cmds</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_complete_cmd_dpc_fusion</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">instance_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="p">)</span><span class="n">instance_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">MSIxIndex</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If we have already declared adapter dead, donot complete cmds */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">==</span> <span class="n">MEGASAS_HW_CRITICAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">MSIxIndex</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">MSIxIndex</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">MSIxIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="n">complete_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">MSIxIndex</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_isr_fusion - isr entry point</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span> <span class="nf">megasas_isr_fusion</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">megasas_irq_context</span> <span class="o">*</span><span class="n">irq_context</span> <span class="o">=</span> <span class="n">devp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">irq_context</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mfiStatus</span><span class="p">,</span> <span class="n">fw_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfiStatus</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">clear_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mfiStatus</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we are resetting, bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MEGASAS_FUSION_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">clear_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">irq_context</span><span class="o">-&gt;</span><span class="n">MSIxIndex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">clear_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
		<span class="cm">/* If we didn&#39;t complete any commands, check for FW fault */</span>
		<span class="n">fw_state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">read_fw_status_reg</span><span class="p">(</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MFI_STATE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_state</span> <span class="o">==</span> <span class="n">MFI_STATE_FAULT</span><span class="p">)</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">work_init</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * build_mpt_mfi_pass_thru - builds a cmd fo MFI Pass thru</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> * mfi_cmd:			megasas_cmd pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">build_mpt_mfi_pass_thru</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">mfi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="n">mpi25_ieee_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span> <span class="o">*</span><span class="n">io_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_header</span> <span class="o">*</span><span class="n">frame_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mfi_cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">megasas_get_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*  Save the smid. To be used for returning the cmd */</span>
	<span class="n">mfi_cmd</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sync_cmd_idx</span> <span class="o">=</span> <span class="n">mfi_cmd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For cmds where the flag is set, store the flag and check</span>
<span class="cm">	 * on completion. For cmds with this flag, don&#39;t call</span>
<span class="cm">	 * megasas_complete_cmd</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MFI_FRAME_DONT_POST_IN_REPLY_QUEUE</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MFI_FRAME_DONT_POST_IN_REPLY_QUEUE</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>
	<span class="n">io_req</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_LSI_INVADER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="n">sgl_ptr_end</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>
		<span class="n">sgl_ptr_end</span> <span class="o">+=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">max_sge_in_main_msg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sgl_ptr_end</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpi25_ieee_chain</span> <span class="o">=</span>
	  <span class="p">(</span><span class="k">struct</span> <span class="n">MPI25_IEEE_SGE_CHAIN64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">.</span><span class="n">IeeeChain</span><span class="p">;</span>

	<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">Function</span>    <span class="o">=</span> <span class="n">MEGASAS_MPI2_FUNCTION_PASSTHRU_IO_REQUEST</span><span class="p">;</span>
	<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">SGLOffset0</span>  <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPI2_RAID_SCSI_IO_REQUEST</span><span class="p">,</span>
				       <span class="n">SGL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">chain_offset_mfi_pthru</span><span class="p">;</span>

	<span class="n">mpi25_ieee_chain</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">mfi_cmd</span><span class="o">-&gt;</span><span class="n">frame_phys_addr</span><span class="p">;</span>

	<span class="n">mpi25_ieee_chain</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">IEEE_SGE_FLAGS_CHAIN_ELEMENT</span> <span class="o">|</span>
		<span class="n">MPI2_IEEE_SGE_FLAGS_IOCPLBNTA_ADDR</span><span class="p">;</span>

	<span class="n">mpi25_ieee_chain</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">MEGASAS_MAX_SZ_CHAIN_FRAME</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * build_mpt_cmd - Calls helper function to build a cmd MFI Pass thru cmd</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> * @cmd:			mfi cmd to build</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span>
<span class="nf">build_mpt_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="n">req_desc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build_mpt_mfi_pass_thru</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t build MFI pass thru cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">smid</span><span class="p">;</span>

	<span class="n">req_desc</span> <span class="o">=</span> <span class="n">megasas_get_request_descriptor</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_REQ_DESCRIPT_FLAGS_SCSI_IO</span> <span class="o">&lt;&lt;</span>
					 <span class="n">MEGASAS_REQ_DESCRIPT_FLAGS_TYPE_SHIFT</span><span class="p">);</span>

	<span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">SMID</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">req_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_issue_dcmd_fusion - Issues a MFI Pass thru cmd</span>
<span class="cm"> * @instance:			Adapter soft state</span>
<span class="cm"> * @cmd:			mfi cmd pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_issue_dcmd_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="n">req_desc</span><span class="p">;</span>

	<span class="n">req_desc</span> <span class="o">=</span> <span class="n">build_mpt_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t issue MFI pass thru cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">fire_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">low</span><span class="p">,</span>
				      <span class="n">req_desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">high</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_release_fusion -	Reverses the FW initialization</span>
<span class="cm"> * @intance:			Adapter soft state</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">megasas_release_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">megasas_free_cmds</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="n">megasas_free_cmds_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>

	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_read_fw_status_reg_fusion - returns the current FW status value</span>
<span class="cm"> * @regs:			MFI register set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">megasas_read_fw_status_reg_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">outbound_scratch_pad</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_adp_reset_fusion -	For controller reset</span>
<span class="cm"> * @regs:				MFI register set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">megasas_adp_reset_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * megasas_check_reset_fusion -	For controller reset check</span>
<span class="cm"> * @regs:				MFI register set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">megasas_check_reset_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">megasas_register_set</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function waits for outstanding commands on fusion to complete */</span>
<span class="kt">int</span> <span class="nf">megasas_wait_for_outstanding_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">outstanding</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fw_state</span><span class="p">,</span> <span class="n">wait_time</span> <span class="o">=</span> <span class="n">MEGASAS_RESET_WAIT_TIME</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wait_time</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if firmware is in fault state */</span>
		<span class="n">fw_state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">read_fw_status_reg</span><span class="p">(</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MFI_STATE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_state</span> <span class="o">==</span> <span class="n">MFI_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megasas: Found FW in FAULT state,&quot;</span>
			       <span class="s">&quot; will reset adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">outstanding</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fw_outstanding</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outstanding</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">MEGASAS_RESET_NOTICE_INTERVAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;megasas: [%2d]waiting for %d &quot;</span>
			       <span class="s">&quot;commands to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">outstanding</span><span class="p">);</span>
			<span class="n">megasas_complete_cmd_dpc_fusion</span><span class="p">(</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">instance</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fw_outstanding</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;megaraid_sas: pending commands remain after waiting, &quot;</span>
		       <span class="s">&quot;will reset adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="nf">megasas_reset_reply_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">MPI2_REPLY_DESCRIPTORS_UNION</span> <span class="o">*</span><span class="n">reply_desc</span><span class="p">;</span>

	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">msix_vectors</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fusion</span><span class="o">-&gt;</span><span class="n">last_reply_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reply_desc</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_frames_desc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">reply_q_depth</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">reply_desc</span><span class="o">++</span><span class="p">)</span>
		<span class="n">reply_desc</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Core fusion reset function */</span>
<span class="kt">int</span> <span class="nf">megasas_reset_fusion</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd_fusion</span> <span class="o">*</span><span class="n">cmd_fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusion_context</span> <span class="o">*</span><span class="n">fusion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">megasas_cmd</span> <span class="o">*</span><span class="n">cmd_mfi</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">MEGASAS_REQUEST_DESCRIPTOR_UNION</span> <span class="o">*</span><span class="n">req_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">host_diag</span><span class="p">,</span> <span class="n">abs_state</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span> <span class="n">reset_adapter</span><span class="p">;</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">fusion</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">ctrl_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">==</span> <span class="n">MEGASAS_HW_CRITICAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: Hardware critical error, &quot;</span>
		       <span class="s">&quot;returning FAILED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_mutex</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MEGASAS_FUSION_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_flags</span><span class="p">);</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">=</span> <span class="n">MEGASAS_ADPRESET_SM_INFAULT</span><span class="p">;</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">disable_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* First try waiting for commands to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">megasas_wait_for_outstanding_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: resetting fusion &quot;</span>
		       <span class="s">&quot;adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Now return commands back to the OS */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd_fusion</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">);</span>
				<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">scmd</span><span class="p">);</span>
				<span class="n">megasas_return_cmd_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cmd_fusion</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">fw_outstanding</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">status_reg</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">read_fw_status_reg</span><span class="p">(</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
		<span class="n">abs_state</span> <span class="o">=</span> <span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">MFI_STATE_MASK</span><span class="p">;</span>
		<span class="n">reset_adapter</span> <span class="o">=</span> <span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">MFI_RESET_ADAPTER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">disableOnlineCtrlReset</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">abs_state</span> <span class="o">==</span> <span class="n">MFI_STATE_FAULT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reset_adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Reset not supported, kill adapter */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: Reset not supported&quot;</span>
			       <span class="s">&quot;, killing adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">megaraid_sas_kill_hba</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">=</span> <span class="n">MEGASAS_HW_CRITICAL_ERROR</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now try to reset the chip */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEGASAS_FUSION_MAX_RESET_TRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_FLUSH_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_1ST_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_2ND_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_3RD_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_4TH_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_5TH_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_6TH_KEY_VALUE</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_seq_offset</span><span class="p">);</span>

			<span class="cm">/* Check that the diag write enable (DRWE) bit is on */</span>
			<span class="n">host_diag</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_host_diag</span><span class="p">);</span>
			<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host_diag</span> <span class="o">&amp;</span> <span class="n">HOST_DIAG_WRITE_ENABLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">host_diag</span> <span class="o">=</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_host_diag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="o">++</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: &quot;</span>
					       <span class="s">&quot;Host diag unlock failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host_diag</span> <span class="o">&amp;</span> <span class="n">HOST_DIAG_WRITE_ENABLE</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Send chip reset command */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">host_diag</span> <span class="o">|</span> <span class="n">HOST_DIAG_RESET_ADAPTER</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_host_diag</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

			<span class="cm">/* Make sure reset adapter bit is cleared */</span>
			<span class="n">host_diag</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_host_diag</span><span class="p">);</span>
			<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">host_diag</span> <span class="o">&amp;</span> <span class="n">HOST_DIAG_RESET_ADAPTER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">host_diag</span> <span class="o">=</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="o">-&gt;</span><span class="n">fusion_host_diag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="o">++</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: &quot;</span>
					       <span class="s">&quot;Diag reset adapter never &quot;</span>
					       <span class="s">&quot;cleared!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_diag</span> <span class="o">&amp;</span> <span class="n">HOST_DIAG_RESET_ADAPTER</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">abs_state</span> <span class="o">=</span>
				<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">read_fw_status_reg</span><span class="p">(</span>
					<span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MFI_STATE_MASK</span><span class="p">;</span>
			<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">abs_state</span> <span class="o">&lt;=</span> <span class="n">MFI_STATE_FW_INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">retry</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">abs_state</span> <span class="o">=</span>
				<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">read_fw_status_reg</span><span class="p">(</span>
					<span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MFI_STATE_MASK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs_state</span> <span class="o">&lt;=</span> <span class="n">MFI_STATE_FW_INIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: firmware &quot;</span>
				       <span class="s">&quot;state &lt; MFI_STATE_FW_INIT, state = &quot;</span>
				       <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">abs_state</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Wait for FW to become ready */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">megasas_transition_to_ready</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: Failed to &quot;</span>
				       <span class="s">&quot;transition controller to ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">megasas_reset_reply_desc</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">megasas_ioc_init_fusion</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: &quot;</span>
				       <span class="s">&quot;megasas_ioc_init_fusion() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MEGASAS_FUSION_IN_RESET</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_flags</span><span class="p">);</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">enable_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">=</span> <span class="n">MEGASAS_HBA_OPERATIONAL</span><span class="p">;</span>

			<span class="cm">/* Re-fire management commands */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">max_fw_cmds</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd_fusion</span> <span class="o">=</span> <span class="n">fusion</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">sync_cmd_idx</span> <span class="o">!=</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ULONG_MAX</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd_mfi</span> <span class="o">=</span>
					<span class="n">instance</span><span class="o">-&gt;</span>
					<span class="n">cmd_list</span><span class="p">[</span><span class="n">cmd_fusion</span><span class="o">-&gt;</span><span class="n">sync_cmd_idx</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cmd_mfi</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dcmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span>
					    <span class="n">MR_DCMD_LD_MAP_GET_INFO</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">megasas_return_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
								   <span class="n">cmd_mfi</span><span class="p">);</span>
						<span class="n">megasas_return_cmd_fusion</span><span class="p">(</span>
							<span class="n">instance</span><span class="p">,</span> <span class="n">cmd_fusion</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
						<span class="n">req_desc</span> <span class="o">=</span>
						<span class="n">megasas_get_request_descriptor</span><span class="p">(</span>
							<span class="n">instance</span><span class="p">,</span>
							<span class="n">cmd_mfi</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">smid</span>
							<span class="o">-</span><span class="mi">1</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_desc</span><span class="p">)</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
							       <span class="s">&quot;req_desc NULL&quot;</span>
							       <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">else</span> <span class="p">{</span>
							<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span>
							<span class="n">fire_cmd</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
								 <span class="n">req_desc</span><span class="o">-&gt;</span>
								 <span class="n">u</span><span class="p">.</span><span class="n">low</span><span class="p">,</span>
								 <span class="n">req_desc</span><span class="o">-&gt;</span>
								 <span class="n">u</span><span class="p">.</span><span class="n">high</span><span class="p">,</span>
								 <span class="n">instance</span><span class="o">-&gt;</span>
								 <span class="n">reg_set</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Reset load balance info */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">fusion</span><span class="o">-&gt;</span><span class="n">load_balance_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LD_LOAD_BALANCE_INFO</span><span class="p">)</span>
			       <span class="o">*</span><span class="n">MAX_LOGICAL_DRIVES</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">megasas_get_map_info</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
				<span class="n">megasas_sync_map_info</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

			<span class="cm">/* Adapter reset completed successfully */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: Reset &quot;</span>
			       <span class="s">&quot;successful.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Reset failed, kill the adapter */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;megaraid_sas: Reset failed, killing &quot;</span>
		       <span class="s">&quot;adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">megaraid_sas_kill_hba</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MEGASAS_FUSION_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_flags</span><span class="p">);</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">instancet</span><span class="o">-&gt;</span><span class="n">enable_intr</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">);</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adprecovery</span> <span class="o">=</span> <span class="n">MEGASAS_HBA_OPERATIONAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MEGASAS_FUSION_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reset_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fusion OCR work queue */</span>
<span class="kt">void</span> <span class="nf">megasas_fusion_ocr_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">megasas_instance</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">megasas_instance</span><span class="p">,</span> <span class="n">work_init</span><span class="p">);</span>

	<span class="n">megasas_reset_fusion</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">megasas_instance_template</span> <span class="n">megasas_instance_template_fusion</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fire_cmd</span> <span class="o">=</span> <span class="n">megasas_fire_cmd_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intr</span> <span class="o">=</span> <span class="n">megasas_enable_intr_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intr</span> <span class="o">=</span> <span class="n">megasas_disable_intr_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_intr</span> <span class="o">=</span> <span class="n">megasas_clear_intr_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_fw_status_reg</span> <span class="o">=</span> <span class="n">megasas_read_fw_status_reg_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adp_reset</span> <span class="o">=</span> <span class="n">megasas_adp_reset_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reset</span> <span class="o">=</span> <span class="n">megasas_check_reset_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">service_isr</span> <span class="o">=</span> <span class="n">megasas_isr_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tasklet</span> <span class="o">=</span> <span class="n">megasas_complete_cmd_dpc_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_adapter</span> <span class="o">=</span> <span class="n">megasas_init_adapter_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_and_issue_cmd</span> <span class="o">=</span> <span class="n">megasas_build_and_issue_cmd_fusion</span><span class="p">,</span>
	<span class="p">.</span><span class="n">issue_dcmd</span> <span class="o">=</span> <span class="n">megasas_issue_dcmd_fusion</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
