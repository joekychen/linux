<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aic7xxx_old.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>aic7xxx_old.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*+M*************************************************************************</span>
<span class="cm"> * Adaptec AIC7xxx device driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1994 John Aycock</span>
<span class="cm"> *   The University of Calgary Department of Computer Science.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Sources include the Adaptec 1740 driver (aha1740.c), the Ultrastor 24F</span>
<span class="cm"> * driver (ultrastor.c), various Linux kernel source, the Adaptec EISA</span>
<span class="cm"> * config file (!adp7771.cfg), the Adaptec AHA-2740A Series User&#39;s Guide,</span>
<span class="cm"> * the Linux Kernel Hacker&#39;s Guide, Writing a SCSI Device Driver for Linux,</span>
<span class="cm"> * the Adaptec 1542 driver (aha1542.c), the Adaptec EISA overlay file</span>
<span class="cm"> * (adp7770.ovl), the Adaptec AHA-2740 Series Technical Reference Manual,</span>
<span class="cm"> * the Adaptec AIC-7770 Data Book, the ANSI SCSI specification, the</span>
<span class="cm"> * ANSI SCSI-2 specification (draft 10c), ...</span>
<span class="cm"> *</span>
<span class="cm"> * --------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *  Modifications by Daniel M. Eischen (deischen@iworks.InterWorks.org):</span>
<span class="cm"> *</span>
<span class="cm"> *  Substantially modified to include support for wide and twin bus</span>
<span class="cm"> *  adapters, DMAing of SCBs, tagged queueing, IRQ sharing, bug fixes,</span>
<span class="cm"> *  SCB paging, and other rework of the code.</span>
<span class="cm"> *</span>
<span class="cm"> *  Parts of this driver were also based on the FreeBSD driver by</span>
<span class="cm"> *  Justin T. Gibbs.  His copyright follows:</span>
<span class="cm"> *</span>
<span class="cm"> * --------------------------------------------------------------------------  </span>
<span class="cm"> * Copyright (c) 1994-1997 Justin Gibbs.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification, immediately at the beginning of the file.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. The name of the author may not be used to endorse or promote products</span>
<span class="cm"> *    derived from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Where this Software is combined with software released under the terms of </span>
<span class="cm"> * the GNU General Public License (&quot;GPL&quot;) and the terms of the GPL would require the </span>
<span class="cm"> * combined work to also be released under the terms of the GPL, the terms</span>
<span class="cm"> * and conditions of this License will apply in addition to those of the</span>
<span class="cm"> * GPL with the exception of any terms or conditions of this License that</span>
<span class="cm"> * conflict with, or are expressly prohibited by, the GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="cm"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> *      $Id: aic7xxx.c,v 1.119 1997/06/27 19:39:18 gibbs Exp $</span>
<span class="cm"> *---------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *  Thanks also go to (in alphabetical order) the following:</span>
<span class="cm"> *</span>
<span class="cm"> *    Rory Bolt     - Sequencer bug fixes</span>
<span class="cm"> *    Jay Estabrook - Initial DEC Alpha support</span>
<span class="cm"> *    Doug Ledford  - Much needed abort/reset bug fixes</span>
<span class="cm"> *    Kai Makisara  - DMAing of SCBs</span>
<span class="cm"> *</span>
<span class="cm"> *  A Boot time option was also added for not resetting the scsi bus.</span>
<span class="cm"> *</span>
<span class="cm"> *    Form:  aic7xxx=extended</span>
<span class="cm"> *           aic7xxx=no_reset</span>
<span class="cm"> *           aic7xxx=ultra</span>
<span class="cm"> *           aic7xxx=irq_trigger:[0,1]  # 0 edge, 1 level</span>
<span class="cm"> *           aic7xxx=verbose</span>
<span class="cm"> *</span>
<span class="cm"> *  Daniel M. Eischen, deischen@iworks.InterWorks.org, 1/23/97</span>
<span class="cm"> *</span>
<span class="cm"> *  $Id: aic7xxx.c,v 4.1 1997/06/12 08:23:42 deang Exp $</span>
<span class="cm"> *-M*************************************************************************/</span>

<span class="cm">/*+M**************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Further driver modifications made by Doug Ledford &lt;dledford@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1997-1999 Doug Ledford</span>
<span class="cm"> *</span>
<span class="cm"> * These changes are released under the same licensing terms as the FreeBSD</span>
<span class="cm"> * driver written by Justin Gibbs.  Please see his Copyright notice above</span>
<span class="cm"> * for the exact terms and conditions covering my changes as well as the</span>
<span class="cm"> * warranty statement.</span>
<span class="cm"> *</span>
<span class="cm"> * Modifications made to the aic7xxx.c,v 4.1 driver from Dan Eischen include</span>
<span class="cm"> * but are not limited to:</span>
<span class="cm"> *</span>
<span class="cm"> *  1: Import of the latest FreeBSD sequencer code for this driver</span>
<span class="cm"> *  2: Modification of kernel code to accommodate different sequencer semantics</span>
<span class="cm"> *  3: Extensive changes throughout kernel portion of driver to improve</span>
<span class="cm"> *     abort/reset processing and error hanndling</span>
<span class="cm"> *  4: Other work contributed by various people on the Internet</span>
<span class="cm"> *  5: Changes to printk information and verbosity selection code</span>
<span class="cm"> *  6: General reliability related changes, especially in IRQ management</span>
<span class="cm"> *  7: Modifications to the default probe/attach order for supported cards</span>
<span class="cm"> *  8: SMP friendliness has been improved</span>
<span class="cm"> *</span>
<span class="cm"> * Overall, this driver represents a significant departure from the official</span>
<span class="cm"> * aic7xxx driver released by Dan Eischen in two ways.  First, in the code</span>
<span class="cm"> * itself.  A diff between the two version of the driver is now a several</span>
<span class="cm"> * thousand line diff.  Second, in approach to solving the same problem.  The</span>
<span class="cm"> * problem is importing the FreeBSD aic7xxx driver code to linux can be a</span>
<span class="cm"> * difficult and time consuming process, that also can be error prone.  Dan</span>
<span class="cm"> * Eischen&#39;s official driver uses the approach that the linux and FreeBSD</span>
<span class="cm"> * drivers should be as identical as possible.  To that end, his next version</span>
<span class="cm"> * of this driver will be using a mid-layer code library that he is developing</span>
<span class="cm"> * to moderate communications between the linux mid-level SCSI code and the</span>
<span class="cm"> * low level FreeBSD driver.  He intends to be able to essentially drop the</span>
<span class="cm"> * FreeBSD driver into the linux kernel with only a few minor tweaks to some</span>
<span class="cm"> * include files and the like and get things working, making for fast easy</span>
<span class="cm"> * imports of the FreeBSD code into linux.</span>
<span class="cm"> *</span>
<span class="cm"> * I disagree with Dan&#39;s approach.  Not that I don&#39;t think his way of doing</span>
<span class="cm"> * things would be nice, easy to maintain, and create a more uniform driver</span>
<span class="cm"> * between FreeBSD and Linux.  I have no objection to those issues.  My</span>
<span class="cm"> * disagreement is on the needed functionality.  There simply are certain</span>
<span class="cm"> * things that are done differently in FreeBSD than linux that will cause</span>
<span class="cm"> * problems for this driver regardless of any middle ware Dan implements.</span>
<span class="cm"> * The biggest example of this at the moment is interrupt semantics.  Linux</span>
<span class="cm"> * doesn&#39;t provide the same protection techniques as FreeBSD does, nor can</span>
<span class="cm"> * they be easily implemented in any middle ware code since they would truly</span>
<span class="cm"> * belong in the kernel proper and would effect all drivers.  For the time</span>
<span class="cm"> * being, I see issues such as these as major stumbling blocks to the </span>
<span class="cm"> * reliability of code based upon such middle ware.  Therefore, I choose to</span>
<span class="cm"> * use a different approach to importing the FreeBSD code that doesn&#39;t</span>
<span class="cm"> * involve any middle ware type code.  My approach is to import the sequencer</span>
<span class="cm"> * code from FreeBSD wholesale.  Then, to only make changes in the kernel</span>
<span class="cm"> * portion of the driver as they are needed for the new sequencer semantics.</span>
<span class="cm"> * In this way, the portion of the driver that speaks to the rest of the</span>
<span class="cm"> * linux kernel is fairly static and can be changed/modified to solve</span>
<span class="cm"> * any problems one might encounter without concern for the FreeBSD driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: If time and experience should prove me wrong that the middle ware</span>
<span class="cm"> * code Dan writes is reliable in its operation, then I&#39;ll retract my above</span>
<span class="cm"> * statements.  But, for those that don&#39;t know, I&#39;m from Missouri (in the US)</span>
<span class="cm"> * and our state motto is &quot;The Show-Me State&quot;.  Well, before I will put</span>
<span class="cm"> * faith into it, you&#39;ll have to show me that it works :)</span>
<span class="cm"> *</span>
<span class="cm"> *_M*************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * The next three defines are user configurable.  These should be the only</span>
<span class="cm"> * defines a user might need to get in here and change.  There are other</span>
<span class="cm"> * defines buried deeper in the code, but those really shouldn&#39;t need touched</span>
<span class="cm"> * under normal conditions.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * AIC7XXX_STRICT_PCI_SETUP</span>
<span class="cm"> *   Should we assume the PCI config options on our controllers are set with</span>
<span class="cm"> *   sane and proper values, or should we be anal about our PCI config</span>
<span class="cm"> *   registers and force them to what we want?  The main advantage to</span>
<span class="cm"> *   defining this option is on non-Intel hardware where the BIOS may not</span>
<span class="cm"> *   have been run to set things up, or if you have one of the BIOSless</span>
<span class="cm"> *   Adaptec controllers, such as a 2910, that don&#39;t get set up by the</span>
<span class="cm"> *   BIOS.  However, keep in mind that we really do set the most important</span>
<span class="cm"> *   items in the driver regardless of this setting, this only controls some</span>
<span class="cm"> *   of the more esoteric PCI options on these cards.  In that sense, I</span>
<span class="cm"> *   would default to leaving this off.  However, if people wish to try</span>
<span class="cm"> *   things both ways, that would also help me to know if there are some</span>
<span class="cm"> *   machines where it works one way but not another.</span>
<span class="cm"> *</span>
<span class="cm"> *   -- July 7, 17:09</span>
<span class="cm"> *     OK...I need this on my machine for testing, so the default is to</span>
<span class="cm"> *     leave it defined.</span>
<span class="cm"> *</span>
<span class="cm"> *   -- July 7, 18:49</span>
<span class="cm"> *     I needed it for testing, but it didn&#39;t make any difference, so back</span>
<span class="cm"> *     off she goes.</span>
<span class="cm"> *</span>
<span class="cm"> *   -- July 16, 23:04</span>
<span class="cm"> *     I turned it back on to try and compensate for the 2.1.x PCI code</span>
<span class="cm"> *     which no longer relies solely on the BIOS and now tries to set</span>
<span class="cm"> *     things itself.</span>
<span class="cm"> */</span>

<span class="cp">#define AIC7XXX_STRICT_PCI_SETUP</span>

<span class="cm">/*</span>
<span class="cm"> * AIC7XXX_VERBOSE_DEBUGGING</span>
<span class="cm"> *   This option enables a lot of extra printk();s in the code, surrounded</span>
<span class="cm"> *   by if (aic7xxx_verbose ...) statements.  Executing all of those if</span>
<span class="cm"> *   statements and the extra checks can get to where it actually does have</span>
<span class="cm"> *   an impact on CPU usage and such, as well as code size.  Disabling this</span>
<span class="cm"> *   define will keep some of those from becoming part of the code.</span>
<span class="cm"> *</span>
<span class="cm"> *   NOTE:  Currently, this option has no real effect, I will be adding the</span>
<span class="cm"> *   various #ifdef&#39;s in the code later when I&#39;ve decided a section is</span>
<span class="cm"> *   complete and no longer needs debugging.  OK...a lot of things are now</span>
<span class="cm"> *   surrounded by this define, so turning this off does have an impact.</span>
<span class="cm"> */</span>
 
<span class="cm">/*</span>
<span class="cm"> * #define AIC7XXX_VERBOSE_DEBUGGING</span>
<span class="cm"> */</span>
 
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &quot;aic7xxx_old/aic7xxx.h&quot;</span>

<span class="cp">#include &quot;aic7xxx_old/sequencer.h&quot;</span>
<span class="cp">#include &quot;aic7xxx_old/scsi_message.h&quot;</span>
<span class="cp">#include &quot;aic7xxx_old/aic7xxx_reg.h&quot;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>

<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;        </span><span class="cm">/* for kmalloc() */</span><span class="cp"></span>

<span class="cp">#define AIC7XXX_C_VERSION  &quot;5.2.6&quot;</span>

<span class="cp">#define ALL_TARGETS -1</span>
<span class="cp">#define ALL_CHANNELS -1</span>
<span class="cp">#define ALL_LUNS -1</span>
<span class="cp">#define MAX_TARGETS  16</span>
<span class="cp">#define MAX_LUNS     8</span>
<span class="cp">#ifndef TRUE</span>
<span class="cp">#  define TRUE 1</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef FALSE</span>
<span class="cp">#  define FALSE 0</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(__powerpc__) || defined(__i386__) || defined(__x86_64__)</span>
<span class="cp">#  define MMAPIO</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * You can try raising me for better performance or lowering me if you have</span>
<span class="cm"> * flaky devices that go off the scsi bus when hit with too many tagged</span>
<span class="cm"> * commands (like some IBM SCSI-3 LVD drives).</span>
<span class="cm"> */</span>
<span class="cp">#define AIC7XXX_CMDS_PER_DEVICE 32</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tag_commands</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>   <span class="cm">/* Allow for wide/twin adapters. */</span>
<span class="p">}</span> <span class="n">adapter_tag_info_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Make a define that will tell the driver not to the default tag depth</span>
<span class="cm"> * everywhere.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_TAG_COMMANDS {0, 0, 0, 0, 0, 0, 0, 0,\</span>
<span class="cp">                              0, 0, 0, 0, 0, 0, 0, 0}</span>

<span class="cm">/*</span>
<span class="cm"> * Modify this as you see fit for your system.  By setting tag_commands</span>
<span class="cm"> * to 0, the driver will use it&#39;s own algorithm for determining the</span>
<span class="cm"> * number of commands to use (see above).  When 255, the driver will</span>
<span class="cm"> * not enable tagged queueing for that particular device.  When positive</span>
<span class="cm"> * (&gt; 0) and (&lt; 255) the values in the array are used for the queue_depth.</span>
<span class="cm"> * Note that the maximum value for an entry is 254, but you&#39;re insane if</span>
<span class="cm"> * you try to use that many commands on one device.</span>
<span class="cm"> *</span>
<span class="cm"> * In this example, the first line will disable tagged queueing for all</span>
<span class="cm"> * the devices on the first probed aic7xxx adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * The second line enables tagged queueing with 4 commands/LUN for IDs</span>
<span class="cm"> * (1, 2-11, 13-15), disables tagged queueing for ID 12, and tells the</span>
<span class="cm"> * driver to use its own algorithm for ID 1.</span>
<span class="cm"> *</span>
<span class="cm"> * The third line is the same as the first line.</span>
<span class="cm"> *</span>
<span class="cm"> * The fourth line disables tagged queueing for devices 0 and 3.  It</span>
<span class="cm"> * enables tagged queueing for the other IDs, with 16 commands/LUN</span>
<span class="cm"> * for IDs 1 and 4, 127 commands/LUN for ID 8, and 4 commands/LUN for</span>
<span class="cm"> * IDs 2, 5-7, and 9-15.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: The below structure is for reference only, the actual structure</span>
<span class="cm"> *       to modify in order to change things is found after this fake one.</span>
<span class="cm"> *</span>
<span class="cm">adapter_tag_info_t aic7xxx_tag_info[] =</span>
<span class="cm">{</span>
<span class="cm">  {DEFAULT_TAG_COMMANDS},</span>
<span class="cm">  {{4, 0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 255, 4, 4, 4}},</span>
<span class="cm">  {DEFAULT_TAG_COMMANDS},</span>
<span class="cm">  {{255, 16, 4, 255, 16, 4, 4, 4, 127, 4, 4, 4, 4, 4, 4, 4}}</span>
<span class="cm">};</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">adapter_tag_info_t</span> <span class="n">aic7xxx_tag_info</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">},</span>
  <span class="p">{</span><span class="n">DEFAULT_TAG_COMMANDS</span><span class="p">}</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Define an array of board names that can be indexed by aha_type.</span>
<span class="cm"> * Don&#39;t forget to change this when changing the types!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">board_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">&quot;AIC-7xxx Unknown&quot;</span><span class="p">,</span>                                   <span class="cm">/* AIC_NONE */</span>
  <span class="s">&quot;Adaptec AIC-7810 Hardware RAID Controller&quot;</span><span class="p">,</span>          <span class="cm">/* AIC_7810 */</span>
  <span class="s">&quot;Adaptec AIC-7770 SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7770 */</span>
  <span class="s">&quot;Adaptec AHA-274X SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7771 */</span>
  <span class="s">&quot;Adaptec AHA-284X SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_284x */</span>
  <span class="s">&quot;Adaptec AIC-7850 SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7850 */</span>
  <span class="s">&quot;Adaptec AIC-7855 SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7855 */</span>
  <span class="s">&quot;Adaptec AIC-7860 Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7860 */</span>
  <span class="s">&quot;Adaptec AHA-2940A Ultra SCSI host adapter&quot;</span><span class="p">,</span>          <span class="cm">/* AIC_7861 */</span>
  <span class="s">&quot;Adaptec AIC-7870 SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7870 */</span>
  <span class="s">&quot;Adaptec AHA-294X SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7871 */</span>
  <span class="s">&quot;Adaptec AHA-394X SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7872 */</span>
  <span class="s">&quot;Adaptec AHA-398X SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7873 */</span>
  <span class="s">&quot;Adaptec AHA-2944 SCSI host adapter&quot;</span><span class="p">,</span>                 <span class="cm">/* AIC_7874 */</span>
  <span class="s">&quot;Adaptec AIC-7880 Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7880 */</span>
  <span class="s">&quot;Adaptec AHA-294X Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7881 */</span>
  <span class="s">&quot;Adaptec AHA-394X Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7882 */</span>
  <span class="s">&quot;Adaptec AHA-398X Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7883 */</span>
  <span class="s">&quot;Adaptec AHA-2944 Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7884 */</span>
  <span class="s">&quot;Adaptec AHA-2940UW Pro Ultra SCSI host adapter&quot;</span><span class="p">,</span>     <span class="cm">/* AIC_7887 */</span>
  <span class="s">&quot;Adaptec AIC-7895 Ultra SCSI host adapter&quot;</span><span class="p">,</span>           <span class="cm">/* AIC_7895 */</span>
  <span class="s">&quot;Adaptec AIC-7890/1 Ultra2 SCSI host adapter&quot;</span><span class="p">,</span>        <span class="cm">/* AIC_7890 */</span>
  <span class="s">&quot;Adaptec AHA-293X Ultra2 SCSI host adapter&quot;</span><span class="p">,</span>          <span class="cm">/* AIC_7890 */</span>
  <span class="s">&quot;Adaptec AHA-294X Ultra2 SCSI host adapter&quot;</span><span class="p">,</span>          <span class="cm">/* AIC_7890 */</span>
  <span class="s">&quot;Adaptec AIC-7896/7 Ultra2 SCSI host adapter&quot;</span><span class="p">,</span>        <span class="cm">/* AIC_7896 */</span>
  <span class="s">&quot;Adaptec AHA-394X Ultra2 SCSI host adapter&quot;</span><span class="p">,</span>          <span class="cm">/* AIC_7897 */</span>
  <span class="s">&quot;Adaptec AHA-395X Ultra2 SCSI host adapter&quot;</span><span class="p">,</span>          <span class="cm">/* AIC_7897 */</span>
  <span class="s">&quot;Adaptec PCMCIA SCSI controller&quot;</span><span class="p">,</span>                     <span class="cm">/* card bus stuff */</span>
  <span class="s">&quot;Adaptec AIC-7892 Ultra 160/m SCSI host adapter&quot;</span><span class="p">,</span>     <span class="cm">/* AIC_7892 */</span>
  <span class="s">&quot;Adaptec AIC-7899 Ultra 160/m SCSI host adapter&quot;</span><span class="p">,</span>     <span class="cm">/* AIC_7899 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * There should be a specific return value for this in scsi.h, but</span>
<span class="cm"> * it seems that most drivers ignore it.</span>
<span class="cm"> */</span>
<span class="cp">#define DID_UNDERFLOW   DID_ERROR</span>

<span class="cm">/*</span>
<span class="cm"> *  What we want to do is have the higher level scsi driver requeue</span>
<span class="cm"> *  the command to us. There is no specific driver status for this</span>
<span class="cm"> *  condition, but the higher level scsi driver will requeue the</span>
<span class="cm"> *  command on a DID_BUS_BUSY error.</span>
<span class="cm"> *</span>
<span class="cm"> *  Upon further inspection and testing, it seems that DID_BUS_BUSY</span>
<span class="cm"> *  will *always* retry the command.  We can get into an infinite loop</span>
<span class="cm"> *  if this happens when we really want some sort of counter that</span>
<span class="cm"> *  will automatically abort/reset the command after so many retries.</span>
<span class="cm"> *  Using DID_ERROR will do just that.  (Made by a suggestion by</span>
<span class="cm"> *  Doug Ledford 8/1/96)</span>
<span class="cm"> */</span>
<span class="cp">#define DID_RETRY_COMMAND DID_ERROR</span>

<span class="cp">#define HSCSIID        0x07</span>
<span class="cp">#define SCSI_RESET     0x040</span>

<span class="cm">/*</span>
<span class="cm"> * EISA/VL-bus stuff</span>
<span class="cm"> */</span>
<span class="cp">#define MINSLOT                1</span>
<span class="cp">#define MAXSLOT                15</span>
<span class="cp">#define SLOTBASE(x)        ((x) &lt;&lt; 12)</span>
<span class="cp">#define BASE_TO_SLOT(x) ((x) &gt;&gt; 12)</span>

<span class="cm">/*</span>
<span class="cm"> * Standard EISA Host ID regs  (Offset from slot base)</span>
<span class="cm"> */</span>
<span class="cp">#define AHC_HID0              0x80   </span><span class="cm">/* 0,1: msb of ID2, 2-7: ID1      */</span><span class="cp"></span>
<span class="cp">#define AHC_HID1              0x81   </span><span class="cm">/* 0-4: ID3, 5-7: LSB ID2         */</span><span class="cp"></span>
<span class="cp">#define AHC_HID2              0x82   </span><span class="cm">/* product                        */</span><span class="cp"></span>
<span class="cp">#define AHC_HID3              0x83   </span><span class="cm">/* firmware revision              */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * AIC-7770 I/O range to reserve for a card</span>
<span class="cm"> */</span>
<span class="cp">#define MINREG                0xC00</span>
<span class="cp">#define MAXREG                0xCFF</span>

<span class="cp">#define INTDEF                0x5C      </span><span class="cm">/* Interrupt Definition Register */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * AIC-78X0 PCI registers</span>
<span class="cm"> */</span>
<span class="cp">#define        CLASS_PROGIF_REVID        0x08</span>
<span class="cp">#define                DEVREVID        0x000000FFul</span>
<span class="cp">#define                PROGINFC        0x0000FF00ul</span>
<span class="cp">#define                SUBCLASS        0x00FF0000ul</span>
<span class="cp">#define                BASECLASS        0xFF000000ul</span>

<span class="cp">#define        CSIZE_LATTIME                0x0C</span>
<span class="cp">#define                CACHESIZE        0x0000003Ful        </span><span class="cm">/* only 5 bits */</span><span class="cp"></span>
<span class="cp">#define                LATTIME                0x0000FF00ul</span>

<span class="cp">#define        DEVCONFIG                0x40</span>
<span class="cp">#define                SCBSIZE32        0x00010000ul        </span><span class="cm">/* aic789X only */</span><span class="cp"></span>
<span class="cp">#define                MPORTMODE        0x00000400ul        </span><span class="cm">/* aic7870 only */</span><span class="cp"></span>
<span class="cp">#define                RAMPSM           0x00000200ul        </span><span class="cm">/* aic7870 only */</span><span class="cp"></span>
<span class="cp">#define                RAMPSM_ULTRA2    0x00000004</span>
<span class="cp">#define                VOLSENSE         0x00000100ul</span>
<span class="cp">#define                SCBRAMSEL        0x00000080ul</span>
<span class="cp">#define                SCBRAMSEL_ULTRA2 0x00000008</span>
<span class="cp">#define                MRDCEN           0x00000040ul</span>
<span class="cp">#define                EXTSCBTIME       0x00000020ul        </span><span class="cm">/* aic7870 only */</span><span class="cp"></span>
<span class="cp">#define                EXTSCBPEN        0x00000010ul        </span><span class="cm">/* aic7870 only */</span><span class="cp"></span>
<span class="cp">#define                BERREN           0x00000008ul</span>
<span class="cp">#define                DACEN            0x00000004ul</span>
<span class="cp">#define                STPWLEVEL        0x00000002ul</span>
<span class="cp">#define                DIFACTNEGEN      0x00000001ul        </span><span class="cm">/* aic7870 only */</span><span class="cp"></span>

<span class="cp">#define        SCAMCTL                  0x1a                </span><span class="cm">/* Ultra2 only  */</span><span class="cp"></span>
<span class="cp">#define        CCSCBBADDR               0xf0                </span><span class="cm">/* aic7895/6/7  */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Define the different types of SEEPROMs on aic7xxx adapters</span>
<span class="cm"> * and make it also represent the address size used in accessing</span>
<span class="cm"> * its registers.  The 93C46 chips have 1024 bits organized into</span>
<span class="cm"> * 64 16-bit words, while the 93C56 chips have 2048 bits organized</span>
<span class="cm"> * into 128 16-bit words.  The C46 chips use 6 bits to address</span>
<span class="cm"> * each word, while the C56 and C66 (4096 bits) use 8 bits to</span>
<span class="cm"> * address each word.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span><span class="n">C46</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">C56_66</span> <span class="o">=</span> <span class="mi">8</span><span class="p">}</span> <span class="n">seeprom_chip_type</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Define the format of the SEEPROM registers (16 bits).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">seeprom_config</span> <span class="p">{</span>

<span class="cm">/*</span>
<span class="cm"> * SCSI ID Configuration Flags</span>
<span class="cm"> */</span>
<span class="cp">#define CFXFER                0x0007      </span><span class="cm">/* synchronous transfer rate */</span><span class="cp"></span>
<span class="cp">#define CFSYNCH               0x0008      </span><span class="cm">/* enable synchronous transfer */</span><span class="cp"></span>
<span class="cp">#define CFDISC                0x0010      </span><span class="cm">/* enable disconnection */</span><span class="cp"></span>
<span class="cp">#define CFWIDEB               0x0020      </span><span class="cm">/* wide bus device (wide card) */</span><span class="cp"></span>
<span class="cp">#define CFSYNCHISULTRA        0x0040      </span><span class="cm">/* CFSYNC is an ultra offset */</span><span class="cp"></span>
<span class="cp">#define CFNEWULTRAFORMAT      0x0080      </span><span class="cm">/* Use the Ultra2 SEEPROM format */</span><span class="cp"></span>
<span class="cp">#define CFSTART               0x0100      </span><span class="cm">/* send start unit SCSI command */</span><span class="cp"></span>
<span class="cp">#define CFINCBIOS             0x0200      </span><span class="cm">/* include in BIOS scan */</span><span class="cp"></span>
<span class="cp">#define CFRNFOUND             0x0400      </span><span class="cm">/* report even if not found */</span><span class="cp"></span>
<span class="cp">#define CFMULTILUN            0x0800      </span><span class="cm">/* probe mult luns in BIOS scan */</span><span class="cp"></span>
<span class="cp">#define CFWBCACHEYES          0x4000      </span><span class="cm">/* Enable W-Behind Cache on drive */</span><span class="cp"></span>
<span class="cp">#define CFWBCACHENC           0xc000      </span><span class="cm">/* Don&#39;t change W-Behind Cache */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0x3000 */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_flags</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>        <span class="cm">/* words 0-15 */</span>

<span class="cm">/*</span>
<span class="cm"> * BIOS Control Bits</span>
<span class="cm"> */</span>
<span class="cp">#define CFSUPREM        0x0001  </span><span class="cm">/* support all removable drives */</span><span class="cp"></span>
<span class="cp">#define CFSUPREMB       0x0002  </span><span class="cm">/* support removable drives for boot only */</span><span class="cp"></span>
<span class="cp">#define CFBIOSEN        0x0004  </span><span class="cm">/* BIOS enabled */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0x0008 */</span>
<span class="cp">#define CFSM2DRV        0x0010  </span><span class="cm">/* support more than two drives */</span><span class="cp"></span>
<span class="cp">#define CF284XEXTEND    0x0020  </span><span class="cm">/* extended translation (284x cards) */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0x0040 */</span>
<span class="cp">#define CFEXTEND        0x0080  </span><span class="cm">/* extended translation enabled */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0xFF00 */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bios_control</span><span class="p">;</span>  <span class="cm">/* word 16 */</span>

<span class="cm">/*</span>
<span class="cm"> * Host Adapter Control Bits</span>
<span class="cm"> */</span>
<span class="cp">#define CFAUTOTERM      0x0001  </span><span class="cm">/* Perform Auto termination */</span><span class="cp"></span>
<span class="cp">#define CFULTRAEN       0x0002  </span><span class="cm">/* Ultra SCSI speed enable (Ultra cards) */</span><span class="cp"></span>
<span class="cp">#define CF284XSELTO     0x0003  </span><span class="cm">/* Selection timeout (284x cards) */</span><span class="cp"></span>
<span class="cp">#define CF284XFIFO      0x000C  </span><span class="cm">/* FIFO Threshold (284x cards) */</span><span class="cp"></span>
<span class="cp">#define CFSTERM         0x0004  </span><span class="cm">/* SCSI low byte termination */</span><span class="cp"></span>
<span class="cp">#define CFWSTERM        0x0008  </span><span class="cm">/* SCSI high byte termination (wide card) */</span><span class="cp"></span>
<span class="cp">#define CFSPARITY       0x0010  </span><span class="cm">/* SCSI parity */</span><span class="cp"></span>
<span class="cp">#define CF284XSTERM     0x0020  </span><span class="cm">/* SCSI low byte termination (284x cards) */</span><span class="cp"></span>
<span class="cp">#define CFRESETB        0x0040  </span><span class="cm">/* reset SCSI bus at boot */</span><span class="cp"></span>
<span class="cp">#define CFBPRIMARY      0x0100  </span><span class="cm">/* Channel B primary on 7895 chipsets */</span><span class="cp"></span>
<span class="cp">#define CFSEAUTOTERM    0x0400  </span><span class="cm">/* aic7890 Perform SE Auto Term */</span><span class="cp"></span>
<span class="cp">#define CFLVDSTERM      0x0800  </span><span class="cm">/* aic7890 LVD Termination */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0xF280 */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">adapter_control</span><span class="p">;</span>        <span class="cm">/* word 17 */</span>

<span class="cm">/*</span>
<span class="cm"> * Bus Release, Host Adapter ID</span>
<span class="cm"> */</span>
<span class="cp">#define CFSCSIID        0x000F                </span><span class="cm">/* host adapter SCSI ID */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0x00F0 */</span>
<span class="cp">#define CFBRTIME        0xFF00                </span><span class="cm">/* bus release time */</span><span class="cp"></span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">brtime_id</span><span class="p">;</span>                <span class="cm">/* word 18 */</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum targets</span>
<span class="cm"> */</span>
<span class="cp">#define CFMAXTARG        0x00FF        </span><span class="cm">/* maximum targets */</span><span class="cp"></span>
<span class="cm">/* UNUSED                0xFF00 */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">max_targets</span><span class="p">;</span>                <span class="cm">/* word 19 */</span>

  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">res_1</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>                <span class="cm">/* words 20-30 */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">checksum</span><span class="p">;</span>                <span class="cm">/* word 31 */</span>
<span class="p">};</span>

<span class="cp">#define SELBUS_MASK                0x0a</span>
<span class="cp">#define         SELNARROW        0x00</span>
<span class="cp">#define         SELBUSB                0x08</span>
<span class="cp">#define SINGLE_BUS                0x00</span>

<span class="cp">#define SCB_TARGET(scb)         \</span>
<span class="cp">       (((scb)-&gt;hscb-&gt;target_channel_lun &amp; TID) &gt;&gt; 4)</span>
<span class="cp">#define SCB_LUN(scb)            \</span>
<span class="cp">       ((scb)-&gt;hscb-&gt;target_channel_lun &amp; LID)</span>
<span class="cp">#define SCB_IS_SCSIBUS_B(scb)   \</span>
<span class="cp">       (((scb)-&gt;hscb-&gt;target_channel_lun &amp; SELBUSB) != 0)</span>

<span class="cm">/*</span>
<span class="cm"> * If an error occurs during a data transfer phase, run the command</span>
<span class="cm"> * to completion - it&#39;s easier that way - making a note of the error</span>
<span class="cm"> * condition in this location. This then will modify a DID_OK status</span>
<span class="cm"> * into an appropriate error for the higher-level SCSI code.</span>
<span class="cm"> */</span>
<span class="cp">#define aic7xxx_error(cmd)        ((cmd)-&gt;SCp.Status)</span>

<span class="cm">/*</span>
<span class="cm"> * Keep track of the targets returned status.</span>
<span class="cm"> */</span>
<span class="cp">#define aic7xxx_status(cmd)        ((cmd)-&gt;SCp.sent_command)</span>

<span class="cm">/*</span>
<span class="cm"> * The position of the SCSI commands scb within the scb array.</span>
<span class="cm"> */</span>
<span class="cp">#define aic7xxx_position(cmd)        ((cmd)-&gt;SCp.have_data_in)</span>

<span class="cm">/*</span>
<span class="cm"> * The stored DMA mapping for single-buffer data transfers.</span>
<span class="cm"> */</span>
<span class="cp">#define aic7xxx_mapping(cmd)	     ((cmd)-&gt;SCp.phase)</span>

<span class="cm">/*</span>
<span class="cm"> * Get out private data area from a scsi cmd pointer</span>
<span class="cm"> */</span>
<span class="cp">#define AIC_DEV(cmd)	((struct aic_dev_data *)(cmd)-&gt;device-&gt;hostdata)</span>

<span class="cm">/*</span>
<span class="cm"> * So we can keep track of our host structs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">first_aic7xxx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * As of Linux 2.1, the mid-level SCSI code uses virtual addresses</span>
<span class="cm"> * in the scatter-gather lists.  We need to convert the virtual</span>
<span class="cm"> * addresses to physical addresses.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">hw_scatterlist</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum number of SG segments these cards can support.</span>
<span class="cm"> */</span>
<span class="cp">#define        AIC7XXX_MAX_SG 128</span>

<span class="cm">/*</span>
<span class="cm"> * The maximum number of SCBs we could have for ANY type</span>
<span class="cm"> * of card. DON&#39;T FORGET TO CHANGE THE SCB MASK IN THE</span>
<span class="cm"> * SEQUENCER CODE IF THIS IS MODIFIED!</span>
<span class="cm"> */</span>
<span class="cp">#define AIC7XXX_MAXSCB        255</span>


<span class="k">struct</span> <span class="n">aic7xxx_hwscb</span> <span class="p">{</span>
<span class="cm">/* ------------    Begin hardware supported fields    ---------------- */</span>
<span class="cm">/* 0*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">control</span><span class="p">;</span>
<span class="cm">/* 1*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target_channel_lun</span><span class="p">;</span>       <span class="cm">/* 4/1/3 bits */</span>
<span class="cm">/* 2*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target_status</span><span class="p">;</span>
<span class="cm">/* 3*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SG_segment_count</span><span class="p">;</span>
<span class="cm">/* 4*/</span>  <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">SG_list_pointer</span><span class="p">;</span>
<span class="cm">/* 8*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">residual_SG_segment_count</span><span class="p">;</span>
<span class="cm">/* 9*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">residual_data_count</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="cm">/*12*/</span>  <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">data_pointer</span><span class="p">;</span>
<span class="cm">/*16*/</span>  <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">data_count</span><span class="p">;</span>
<span class="cm">/*20*/</span>  <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">SCSI_cmd_pointer</span><span class="p">;</span>
<span class="cm">/*24*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SCSI_cmd_length</span><span class="p">;</span>
<span class="cm">/*25*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tag</span><span class="p">;</span>          <span class="cm">/* Index into our kernel SCB array.</span>
<span class="cm">                                     * Also used as the tag for tagged I/O</span>
<span class="cm">                                     */</span>
<span class="cp">#define SCB_PIO_TRANSFER_SIZE  26   </span><span class="cm">/* amount we need to upload/download</span>
<span class="cm">                                     * via PIO to initialize a transaction.</span>
<span class="cm">                                     */</span><span class="cp"></span>
<span class="cm">/*26*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">next</span><span class="p">;</span>         <span class="cm">/* Used to thread SCBs awaiting selection</span>
<span class="cm">                                     * or disconnected down in the sequencer.</span>
<span class="cm">                                     */</span>
<span class="cm">/*27*/</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev</span><span class="p">;</span>
<span class="cm">/*28*/</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">;</span>           <span class="cm">/*</span>
<span class="cm">                                     * Unused by the kernel, but we require</span>
<span class="cm">                                     * the padding so that the array of</span>
<span class="cm">                                     * hardware SCBs is aligned on 32 byte</span>
<span class="cm">                                     * boundaries so the sequencer can index</span>
<span class="cm">                                     */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
        <span class="n">SCB_FREE</span>                <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
        <span class="n">SCB_DTR_SCB</span>             <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
        <span class="n">SCB_WAITINGQ</span>            <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
        <span class="n">SCB_ACTIVE</span>              <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
        <span class="n">SCB_SENSE</span>               <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
        <span class="n">SCB_ABORT</span>               <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
        <span class="n">SCB_DEVICE_RESET</span>        <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
        <span class="n">SCB_RESET</span>               <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span>
        <span class="n">SCB_RECOVERY_SCB</span>        <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
        <span class="n">SCB_MSGOUT_PPR</span>          <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
        <span class="n">SCB_MSGOUT_SENT</span>         <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
        <span class="n">SCB_MSGOUT_SDTR</span>         <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
        <span class="n">SCB_MSGOUT_WDTR</span>         <span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
        <span class="n">SCB_MSGOUT_BITS</span>         <span class="o">=</span> <span class="n">SCB_MSGOUT_PPR</span> <span class="o">|</span>
                                  <span class="n">SCB_MSGOUT_SENT</span> <span class="o">|</span> 
                                  <span class="n">SCB_MSGOUT_SDTR</span> <span class="o">|</span>
                                  <span class="n">SCB_MSGOUT_WDTR</span><span class="p">,</span>
        <span class="n">SCB_QUEUED_ABORT</span>        <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
        <span class="n">SCB_QUEUED_FOR_DONE</span>     <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
        <span class="n">SCB_WAS_BUSY</span>            <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">SCB_QUEUE_FULL</span>		<span class="o">=</span> <span class="mh">0x8000</span>
<span class="p">}</span> <span class="n">scb_flag_type</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
        <span class="n">AHC_FNONE</span>                 <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
        <span class="n">AHC_PAGESCBS</span>              <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
        <span class="n">AHC_CHANNEL_B_PRIMARY</span>     <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>
        <span class="n">AHC_USEDEFAULTS</span>           <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>
        <span class="n">AHC_INDIRECT_PAGING</span>       <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>
        <span class="n">AHC_CHNLB</span>                 <span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>
        <span class="n">AHC_CHNLC</span>                 <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>
        <span class="n">AHC_EXTEND_TRANS_A</span>        <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">,</span>
        <span class="n">AHC_EXTEND_TRANS_B</span>        <span class="o">=</span> <span class="mh">0x00000200</span><span class="p">,</span>
        <span class="n">AHC_TERM_ENB_A</span>            <span class="o">=</span> <span class="mh">0x00000400</span><span class="p">,</span>
        <span class="n">AHC_TERM_ENB_SE_LOW</span>       <span class="o">=</span> <span class="mh">0x00000400</span><span class="p">,</span>
        <span class="n">AHC_TERM_ENB_B</span>            <span class="o">=</span> <span class="mh">0x00000800</span><span class="p">,</span>
        <span class="n">AHC_TERM_ENB_SE_HIGH</span>      <span class="o">=</span> <span class="mh">0x00000800</span><span class="p">,</span>
        <span class="n">AHC_HANDLING_REQINITS</span>     <span class="o">=</span> <span class="mh">0x00001000</span><span class="p">,</span>
        <span class="n">AHC_TARGETMODE</span>            <span class="o">=</span> <span class="mh">0x00002000</span><span class="p">,</span>
        <span class="n">AHC_NEWEEPROM_FMT</span>         <span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span>
 <span class="cm">/*</span>
<span class="cm">  *  Here ends the FreeBSD defined flags and here begins the linux defined</span>
<span class="cm">  *  flags.  NOTE: I did not preserve the old flag name during this change</span>
<span class="cm">  *  specifically to force me to evaluate what flags were being used properly</span>
<span class="cm">  *  and what flags weren&#39;t.  This way, I could clean up the flag usage on</span>
<span class="cm">  *  a use by use basis.  Doug Ledford</span>
<span class="cm">  */</span>
        <span class="n">AHC_MOTHERBOARD</span>           <span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>
        <span class="n">AHC_NO_STPWEN</span>             <span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
        <span class="n">AHC_RESET_DELAY</span>           <span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>
        <span class="n">AHC_A_SCANNED</span>             <span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
        <span class="n">AHC_B_SCANNED</span>             <span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
        <span class="n">AHC_MULTI_CHANNEL</span>         <span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>
        <span class="n">AHC_BIOS_ENABLED</span>          <span class="o">=</span> <span class="mh">0x00800000</span><span class="p">,</span>
        <span class="n">AHC_SEEPROM_FOUND</span>         <span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span>
        <span class="n">AHC_TERM_ENB_LVD</span>          <span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>
        <span class="n">AHC_ABORT_PENDING</span>         <span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>
        <span class="n">AHC_RESET_PENDING</span>         <span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span>
<span class="cp">#define AHC_IN_ISR_BIT              28</span>
        <span class="n">AHC_IN_ISR</span>                <span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
        <span class="n">AHC_IN_ABORT</span>              <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
        <span class="n">AHC_IN_RESET</span>              <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>
        <span class="n">AHC_EXTERNAL_SRAM</span>         <span class="o">=</span> <span class="mh">0x80000000</span>
<span class="p">}</span> <span class="n">ahc_flag_type</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">AHC_NONE</span>             <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
  <span class="n">AHC_CHIPID_MASK</span>      <span class="o">=</span> <span class="mh">0x00ff</span><span class="p">,</span>
  <span class="n">AHC_AIC7770</span>          <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
  <span class="n">AHC_AIC7850</span>          <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
  <span class="n">AHC_AIC7860</span>          <span class="o">=</span> <span class="mh">0x0003</span><span class="p">,</span>
  <span class="n">AHC_AIC7870</span>          <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
  <span class="n">AHC_AIC7880</span>          <span class="o">=</span> <span class="mh">0x0005</span><span class="p">,</span>
  <span class="n">AHC_AIC7890</span>          <span class="o">=</span> <span class="mh">0x0006</span><span class="p">,</span>
  <span class="n">AHC_AIC7895</span>          <span class="o">=</span> <span class="mh">0x0007</span><span class="p">,</span>
  <span class="n">AHC_AIC7896</span>          <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
  <span class="n">AHC_AIC7892</span>          <span class="o">=</span> <span class="mh">0x0009</span><span class="p">,</span>
  <span class="n">AHC_AIC7899</span>          <span class="o">=</span> <span class="mh">0x000a</span><span class="p">,</span>
  <span class="n">AHC_VL</span>               <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
  <span class="n">AHC_EISA</span>             <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
  <span class="n">AHC_PCI</span>              <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
<span class="p">}</span> <span class="n">ahc_chip</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">AHC_FENONE</span>           <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
  <span class="n">AHC_ULTRA</span>            <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
  <span class="n">AHC_ULTRA2</span>           <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
  <span class="n">AHC_WIDE</span>             <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
  <span class="n">AHC_TWIN</span>             <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
  <span class="n">AHC_MORE_SRAM</span>        <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
  <span class="n">AHC_CMD_CHAN</span>         <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
  <span class="n">AHC_QUEUE_REGS</span>       <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span>
  <span class="n">AHC_SG_PRELOAD</span>       <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
  <span class="n">AHC_SPIOCAP</span>          <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
  <span class="n">AHC_ULTRA3</span>           <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
  <span class="n">AHC_NEW_AUTOTERM</span>     <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
  <span class="n">AHC_AIC7770_FE</span>       <span class="o">=</span> <span class="n">AHC_FENONE</span><span class="p">,</span>
  <span class="n">AHC_AIC7850_FE</span>       <span class="o">=</span> <span class="n">AHC_SPIOCAP</span><span class="p">,</span>
  <span class="n">AHC_AIC7860_FE</span>       <span class="o">=</span> <span class="n">AHC_ULTRA</span><span class="o">|</span><span class="n">AHC_SPIOCAP</span><span class="p">,</span>
  <span class="n">AHC_AIC7870_FE</span>       <span class="o">=</span> <span class="n">AHC_FENONE</span><span class="p">,</span>
  <span class="n">AHC_AIC7880_FE</span>       <span class="o">=</span> <span class="n">AHC_ULTRA</span><span class="p">,</span>
  <span class="n">AHC_AIC7890_FE</span>       <span class="o">=</span> <span class="n">AHC_MORE_SRAM</span><span class="o">|</span><span class="n">AHC_CMD_CHAN</span><span class="o">|</span><span class="n">AHC_ULTRA2</span><span class="o">|</span>
                         <span class="n">AHC_QUEUE_REGS</span><span class="o">|</span><span class="n">AHC_SG_PRELOAD</span><span class="o">|</span><span class="n">AHC_NEW_AUTOTERM</span><span class="p">,</span>
  <span class="n">AHC_AIC7895_FE</span>       <span class="o">=</span> <span class="n">AHC_MORE_SRAM</span><span class="o">|</span><span class="n">AHC_CMD_CHAN</span><span class="o">|</span><span class="n">AHC_ULTRA</span><span class="p">,</span>
  <span class="n">AHC_AIC7896_FE</span>       <span class="o">=</span> <span class="n">AHC_AIC7890_FE</span><span class="p">,</span>
  <span class="n">AHC_AIC7892_FE</span>       <span class="o">=</span> <span class="n">AHC_AIC7890_FE</span><span class="o">|</span><span class="n">AHC_ULTRA3</span><span class="p">,</span>
  <span class="n">AHC_AIC7899_FE</span>       <span class="o">=</span> <span class="n">AHC_AIC7890_FE</span><span class="o">|</span><span class="n">AHC_ULTRA3</span><span class="p">,</span>
<span class="p">}</span> <span class="n">ahc_feature</span><span class="p">;</span>

<span class="cp">#define SCB_DMA_ADDR(scb, addr) ((unsigned long)(addr) + (scb)-&gt;scb_dma-&gt;dma_offset)</span>

<span class="k">struct</span> <span class="n">aic7xxx_scb_dma</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	       <span class="n">dma_offset</span><span class="p">;</span>    <span class="cm">/* Correction you have to add</span>
<span class="cm">					       * to virtual address to get</span>
<span class="cm">					       * dma handle in this region */</span>
	<span class="n">dma_addr_t</span>	       <span class="n">dma_address</span><span class="p">;</span>   <span class="cm">/* DMA handle of the start,</span>
<span class="cm">					       * for unmap */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	       <span class="n">dma_len</span><span class="p">;</span>	      <span class="cm">/* DMA length */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">AHC_BUG_NONE</span>            <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
  <span class="n">AHC_BUG_TMODE_WIDEODD</span>   <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
  <span class="n">AHC_BUG_AUTOFLUSH</span>       <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
  <span class="n">AHC_BUG_CACHETHEN</span>       <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
  <span class="n">AHC_BUG_CACHETHEN_DIS</span>   <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
  <span class="n">AHC_BUG_PCI_2_1_RETRY</span>   <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
  <span class="n">AHC_BUG_PCI_MWI</span>         <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
  <span class="n">AHC_BUG_SCBCHAN_UPLOAD</span>  <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span>
<span class="p">}</span> <span class="n">ahc_bugs</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic7xxx_hwscb</span>	<span class="o">*</span><span class="n">hscb</span><span class="p">;</span>		<span class="cm">/* corresponding hardware scb */</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>		<span class="cm">/* scsi_cmnd for this scb */</span>
	<span class="k">struct</span> <span class="n">aic7xxx_scb</span>	<span class="o">*</span><span class="n">q_next</span><span class="p">;</span>        <span class="cm">/* next scb in queue */</span>
	<span class="k">volatile</span> <span class="n">scb_flag_type</span>	<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* current state of scb */</span>
	<span class="k">struct</span> <span class="n">hw_scatterlist</span>	<span class="o">*</span><span class="n">sg_list</span><span class="p">;</span>	<span class="cm">/* SG list in adapter format */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tag_action</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">sg_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">sense_cmd</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">						 * Allocate 6 characters for</span>
<span class="cm">						 * sense command.</span>
<span class="cm">						 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">sg_length</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">						 * We init this during</span>
<span class="cm">						 * buildscb so we don&#39;t have</span>
<span class="cm">						 * to calculate anything during</span>
<span class="cm">						 * underflow/overflow/stat code</span>
<span class="cm">						 */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">kmalloc_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic7xxx_scb_dma</span>	<span class="o">*</span><span class="n">scb_dma</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Define a linked list of SCBs.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
<span class="p">}</span> <span class="n">scb_queue_type</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">errno</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errmesg</span><span class="p">;</span>
<span class="p">}</span> <span class="n">hard_error</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span> <span class="n">ILLHADDR</span><span class="p">,</span>  <span class="s">&quot;Illegal Host Access&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">ILLSADDR</span><span class="p">,</span>  <span class="s">&quot;Illegal Sequencer Address referenced&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">ILLOPCODE</span><span class="p">,</span> <span class="s">&quot;Illegal Opcode in sequencer program&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">SQPARERR</span><span class="p">,</span>  <span class="s">&quot;Sequencer Ram Parity Error&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">DPARERR</span><span class="p">,</span>   <span class="s">&quot;Data-Path Ram Parity Error&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">MPARERR</span><span class="p">,</span>   <span class="s">&quot;Scratch Ram/SCB Array Ram Parity Error&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">PCIERRSTAT</span><span class="p">,</span><span class="s">&quot;PCI Error detected&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">CIOPARERR</span><span class="p">,</span> <span class="s">&quot;CIOBUS Parity Error&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="n">generic_sense</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">REQUEST_SENSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">scb_queue_type</span> <span class="n">free_scbs</span><span class="p">;</span>        <span class="cm">/*</span>
<span class="cm">                                    * SCBs assigned to free slot on</span>
<span class="cm">                                    * card (no paging required)</span>
<span class="cm">                                    */</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span>   <span class="o">*</span><span class="n">scb_array</span><span class="p">[</span><span class="n">AIC7XXX_MAXSCB</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">aic7xxx_hwscb</span> <span class="o">*</span><span class="n">hscbs</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">numscbs</span><span class="p">;</span>          <span class="cm">/* current number of scbs */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">maxhscbs</span><span class="p">;</span>         <span class="cm">/* hardware scbs */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">maxscbs</span><span class="p">;</span>          <span class="cm">/* max scbs including pageable scbs */</span>
  <span class="n">dma_addr_t</span>	 <span class="n">hscbs_dma</span><span class="p">;</span>	   <span class="cm">/* DMA handle to hscbs */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">hscbs_dma_len</span><span class="p">;</span>    <span class="cm">/* length of the above DMA area */</span>
  <span class="kt">void</span>          <span class="o">*</span><span class="n">hscb_kmalloc_ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">scb_data_type</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">target_cmd</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mesg_bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define AHC_TRANS_CUR    0x0001</span>
<span class="cp">#define AHC_TRANS_ACTIVE 0x0002</span>
<span class="cp">#define AHC_TRANS_GOAL   0x0004</span>
<span class="cp">#define AHC_TRANS_USER   0x0008</span>
<span class="cp">#define AHC_TRANS_QUITE  0x0010</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">width</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">period</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">options</span><span class="p">;</span>
<span class="p">}</span> <span class="n">transinfo_type</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="p">{</span>
  <span class="k">volatile</span> <span class="n">scb_queue_type</span>  <span class="n">delayed_scbs</span><span class="p">;</span>
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">temp_q_depth</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span>           <span class="n">max_q_depth</span><span class="p">;</span>
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">active_cmds</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">   * Statistics Kept:</span>
<span class="cm">   *</span>
<span class="cm">   * Total Xfers (count for each command that has a data xfer),</span>
<span class="cm">   * broken down by reads &amp;&amp; writes.</span>
<span class="cm">   *</span>
<span class="cm">   * Further sorted into a few bins for keeping tabs on how many commands</span>
<span class="cm">   * we get of various sizes.</span>
<span class="cm">   *</span>
<span class="cm">   */</span>
  <span class="kt">long</span> <span class="n">w_total</span><span class="p">;</span>                          <span class="cm">/* total writes */</span>
  <span class="kt">long</span> <span class="n">r_total</span><span class="p">;</span>                          <span class="cm">/* total reads */</span>
  <span class="kt">long</span> <span class="n">barrier_total</span><span class="p">;</span>			 <span class="cm">/* total num of REQ_BARRIER commands */</span>
  <span class="kt">long</span> <span class="n">ordered_total</span><span class="p">;</span>			 <span class="cm">/* How many REQ_BARRIER commands we</span>
<span class="cm">					    used ordered tags to satisfy */</span>
  <span class="kt">long</span> <span class="n">w_bins</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>                       <span class="cm">/* binned write */</span>
  <span class="kt">long</span> <span class="n">r_bins</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>                       <span class="cm">/* binned reads */</span>
  <span class="n">transinfo_type</span>	<span class="n">cur</span><span class="p">;</span>
  <span class="n">transinfo_type</span>	<span class="n">goal</span><span class="p">;</span>
<span class="cp">#define  BUS_DEVICE_RESET_PENDING       0x01</span>
<span class="cp">#define  DEVICE_RESET_DELAY             0x02</span>
<span class="cp">#define  DEVICE_PRINT_DTR               0x04</span>
<span class="cp">#define  DEVICE_WAS_BUSY                0x08</span>
<span class="cp">#define  DEVICE_DTR_SCANNED		0x10</span>
<span class="cp">#define  DEVICE_SCSI_3			0x20</span>
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">flags</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">needppr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">needppr_copy</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">needsdtr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">needsdtr_copy</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">needwdtr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">needwdtr_copy</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">dtr_pending</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDptr</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Define a structure used for each host adapter.  Note, in order to avoid</span>
<span class="cm"> * problems with architectures I can&#39;t test on (because I don&#39;t have one,</span>
<span class="cm"> * such as the Alpha based systems) which happen to give faults for</span>
<span class="cm"> * non-aligned memory accesses, care was taken to align this structure</span>
<span class="cm"> * in a way that guaranteed all accesses larger than 8 bits were aligned</span>
<span class="cm"> * on the appropriate boundary.  It&#39;s also organized to try and be more</span>
<span class="cm"> * cache line efficient.  Be careful when changing this lest you might hurt</span>
<span class="cm"> * overall performance and bring down the wrath of the masses.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="p">{</span>
  <span class="cm">/*</span>
<span class="cm">   *  This is the first 64 bytes in the host struct</span>
<span class="cm">   */</span>

  <span class="cm">/*</span>
<span class="cm">   * We are grouping things here....first, items that get either read or</span>
<span class="cm">   * written with nearly every interrupt</span>
<span class="cm">   */</span>
	<span class="k">volatile</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">ahc_feature</span>	<span class="n">features</span><span class="p">;</span>	<span class="cm">/* chip features */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">base</span><span class="p">;</span>		<span class="cm">/* card base address */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="n">maddr</span><span class="p">;</span>	<span class="cm">/* memory mapped address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">isr_count</span><span class="p">;</span>	<span class="cm">/* Interrupt count */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">spurious_int</span><span class="p">;</span>
	<span class="n">scb_data_type</span>	<span class="o">*</span><span class="n">scb_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic7xxx_cmd_queue</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">completeq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* Things read/written on nearly every entry into aic7xxx_queue()</span>
<span class="cm">	*/</span>
	<span class="k">volatile</span> <span class="n">scb_queue_type</span>	<span class="n">waiting_scbs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">unpause</span><span class="p">;</span>	<span class="cm">/* unpause value for HCNTRL */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">pause</span><span class="p">;</span>		<span class="cm">/* pause value for HCNTRL */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">qoutfifonext</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">activescbs</span><span class="p">;</span>	<span class="cm">/* active scbs */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">max_activescbs</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">qinfifonext</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">untagged_scbs</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">qoutfifo</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">qinfifo</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">dev_last_queue_full</span><span class="p">[</span><span class="n">MAX_TARGETS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">dev_last_queue_full_count</span><span class="p">[</span><span class="n">MAX_TARGETS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">ultraenb</span><span class="p">;</span> <span class="cm">/* Gets downloaded to card as a bitmap */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">discenable</span><span class="p">;</span> <span class="cm">/* Gets downloaded to card as a bitmap */</span>
	<span class="n">transinfo_type</span>	<span class="n">user</span><span class="p">[</span><span class="n">MAX_TARGETS</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">msg_buf</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* The message for the target */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">msg_type</span><span class="p">;</span>
<span class="cp">#define MSG_TYPE_NONE              0x00</span>
<span class="cp">#define MSG_TYPE_INITIATOR_MSGOUT  0x01</span>
<span class="cp">#define MSG_TYPE_INITIATOR_MSGIN   0x02</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">msg_len</span><span class="p">;</span>	<span class="cm">/* Length of message */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">msg_index</span><span class="p">;</span>	<span class="cm">/* Index into msg_buf array */</span>


	<span class="cm">/*</span>
<span class="cm">	 * We put the less frequently used host structure items</span>
<span class="cm">	 * after the more frequently used items to try and ease</span>
<span class="cm">	 * the burden on the cache subsystem.</span>
<span class="cm">	 * These entries are not *commonly* accessed, whereas</span>
<span class="cm">	 * the preceding entries are accessed very often.</span>
<span class="cm">	 */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">;</span>		<span class="cm">/* IRQ for this adapter */</span>
	<span class="kt">int</span>		<span class="n">instance</span><span class="p">;</span>	<span class="cm">/* aic7xxx instance number */</span>
	<span class="kt">int</span>		<span class="n">scsi_id</span><span class="p">;</span>	<span class="cm">/* host adapter SCSI ID */</span>
	<span class="kt">int</span>		<span class="n">scsi_id_b</span><span class="p">;</span>	<span class="cm">/* channel B for twin adapters */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">bios_address</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">board_name_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">bios_control</span><span class="p">;</span>		<span class="cm">/* bios control - SEEPROM */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">adapter_control</span><span class="p">;</span>	<span class="cm">/* adapter control - SEEPROM */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">pci_device_fn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">seeprom_config</span>	<span class="n">sc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">sc_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">sc_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic7xxx_host</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>	<span class="cm">/* allow for multiple IRQs */</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>	<span class="cm">/* pointer to scsi host */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	 <span class="n">aic_devs</span><span class="p">;</span> <span class="cm">/* all aic_dev structs on host */</span>
	<span class="kt">int</span>		<span class="n">host_no</span><span class="p">;</span>	<span class="cm">/* SCSI host number */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">mbase</span><span class="p">;</span>		<span class="cm">/* I/O memory address */</span>
	<span class="n">ahc_chip</span>	<span class="n">chip</span><span class="p">;</span>		<span class="cm">/* chip type */</span>
	<span class="n">ahc_bugs</span>	<span class="n">bugs</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">fifo_dma</span><span class="p">;</span>	<span class="cm">/* DMA handle for fifo arrays */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Valid SCSIRATE values. (p. 3-17)</span>
<span class="cm"> * Provides a mapping of transfer periods in ns/4 to the proper value to</span>
<span class="cm"> * stick in the SCSIRATE reg to use that transfer rate.</span>
<span class="cm"> */</span>
<span class="cp">#define AHC_SYNCRATE_ULTRA3 0</span>
<span class="cp">#define AHC_SYNCRATE_ULTRA2 1</span>
<span class="cp">#define AHC_SYNCRATE_ULTRA  3</span>
<span class="cp">#define AHC_SYNCRATE_FAST   6</span>
<span class="cp">#define AHC_SYNCRATE_CRC 0x40</span>
<span class="cp">#define AHC_SYNCRATE_SE  0x10</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="p">{</span>
  <span class="cm">/* Rates in Ultra mode have bit 8 of sxfr set */</span>
<span class="cp">#define                ULTRA_SXFR 0x100</span>
  <span class="kt">int</span> <span class="n">sxfr_ultra2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">sxfr</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">period</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rate</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">aic7xxx_syncrates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span> <span class="mh">0x42</span><span class="p">,</span>  <span class="mh">0x000</span><span class="p">,</span>   <span class="mi">9</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;80.0&quot;</span><span class="p">,</span> <span class="s">&quot;160.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span>  <span class="mh">0x000</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;40.0&quot;</span><span class="p">,</span> <span class="s">&quot;80.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span>  <span class="mh">0x000</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;33.0&quot;</span><span class="p">,</span> <span class="s">&quot;66.6&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mh">0x100</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;20.0&quot;</span><span class="p">,</span> <span class="s">&quot;40.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span>  <span class="mh">0x110</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;16.0&quot;</span><span class="p">,</span> <span class="s">&quot;32.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span>  <span class="mh">0x120</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;13.4&quot;</span><span class="p">,</span> <span class="s">&quot;26.8&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span>  <span class="mh">0x000</span><span class="p">,</span>  <span class="mi">25</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;10.0&quot;</span><span class="p">,</span> <span class="s">&quot;20.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>  <span class="mh">0x010</span><span class="p">,</span>  <span class="mi">31</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;8.0&quot;</span><span class="p">,</span>  <span class="s">&quot;16.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span>  <span class="mh">0x020</span><span class="p">,</span>  <span class="mi">37</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;6.67&quot;</span><span class="p">,</span> <span class="s">&quot;13.3&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span>  <span class="mh">0x030</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;5.7&quot;</span><span class="p">,</span>  <span class="s">&quot;11.4&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span>  <span class="mh">0x040</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;5.0&quot;</span><span class="p">,</span>  <span class="s">&quot;10.0&quot;</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="mh">0x050</span><span class="p">,</span>  <span class="mi">56</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;4.4&quot;</span><span class="p">,</span>  <span class="s">&quot;8.8&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="mh">0x060</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;4.0&quot;</span><span class="p">,</span>  <span class="s">&quot;8.0&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="mh">0x070</span><span class="p">,</span>  <span class="mi">68</span><span class="p">,</span>  <span class="p">{</span><span class="s">&quot;3.6&quot;</span><span class="p">,</span>  <span class="s">&quot;7.2&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="mh">0x000</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>   <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>   <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define CTL_OF_SCB(scb) (((scb-&gt;hscb)-&gt;target_channel_lun &gt;&gt; 3) &amp; 0x1),  \</span>
<span class="cp">                        (((scb-&gt;hscb)-&gt;target_channel_lun &gt;&gt; 4) &amp; 0xf), \</span>
<span class="cp">                        ((scb-&gt;hscb)-&gt;target_channel_lun &amp; 0x07)</span>

<span class="cp">#define CTL_OF_CMD(cmd) ((cmd-&gt;device-&gt;channel) &amp; 0x01),  \</span>
<span class="cp">                        ((cmd-&gt;device-&gt;id) &amp; 0x0f), \</span>
<span class="cp">                        ((cmd-&gt;device-&gt;lun) &amp; 0x07)</span>

<span class="cp">#define TARGET_INDEX(cmd)  ((cmd)-&gt;device-&gt;id | ((cmd)-&gt;device-&gt;channel &lt;&lt; 3))</span>

<span class="cm">/*</span>
<span class="cm"> * A nice little define to make doing our printks a little easier</span>
<span class="cm"> */</span>

<span class="cp">#define WARN_LEAD KERN_WARNING &quot;(scsi%d:%d:%d:%d) &quot;</span>
<span class="cp">#define INFO_LEAD KERN_INFO &quot;(scsi%d:%d:%d:%d) &quot;</span>

<span class="cm">/*</span>
<span class="cm"> * XXX - these options apply unilaterally to _all_ 274x/284x/294x</span>
<span class="cm"> *       cards in the system.  This should be fixed.  Exceptions to this</span>
<span class="cm"> *       rule are noted in the comments.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Use this as the default queue depth when setting tagged queueing on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aic7xxx_default_queue_depth</span> <span class="o">=</span> <span class="n">AIC7XXX_CMDS_PER_DEVICE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Skip the scsi bus reset.  Non 0 make us skip the reset at startup.  This</span>
<span class="cm"> * has no effect on any later resets that might occur due to things like</span>
<span class="cm"> * SCSI bus timeouts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aic7xxx_no_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Certain PCI motherboards will scan PCI devices from highest to lowest,</span>
<span class="cm"> * others scan from lowest to highest, and they tend to do all kinds of</span>
<span class="cm"> * strange things when they come into contact with PCI bridge chips.  The</span>
<span class="cm"> * net result of all this is that the PCI card that is actually used to boot</span>
<span class="cm"> * the machine is very hard to detect.  Most motherboards go from lowest</span>
<span class="cm"> * PCI slot number to highest, and the first SCSI controller found is the</span>
<span class="cm"> * one you boot from.  The only exceptions to this are when a controller</span>
<span class="cm"> * has its BIOS disabled.  So, we by default sort all of our SCSI controllers</span>
<span class="cm"> * from lowest PCI slot number to highest PCI slot number.  We also force</span>
<span class="cm"> * all controllers with their BIOS disabled to the end of the list.  This</span>
<span class="cm"> * works on *almost* all computers.  Where it doesn&#39;t work, we have this</span>
<span class="cm"> * option.  Setting this option to non-0 will reverse the order of the sort</span>
<span class="cm"> * to highest first, then lowest, but will still leave cards with their BIOS</span>
<span class="cm"> * disabled at the very end.  That should fix everyone up unless there are</span>
<span class="cm"> * really strange cirumstances.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_reverse_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Should we force EXTENDED translation on a controller.</span>
<span class="cm"> *     0 == Use whatever is in the SEEPROM or default to off</span>
<span class="cm"> *     1 == Use whatever is in the SEEPROM or default to on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aic7xxx_extended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * The IRQ trigger method used on EISA controllers. Does not effect PCI cards.</span>
<span class="cm"> *   -1 = Use detected settings.</span>
<span class="cm"> *    0 = Force Edge triggered mode.</span>
<span class="cm"> *    1 = Force Level triggered mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_irq_trigger</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * This variable is used to override the termination settings on a controller.</span>
<span class="cm"> * This should not be used under normal conditions.  However, in the case</span>
<span class="cm"> * that a controller does not have a readable SEEPROM (so that we can&#39;t</span>
<span class="cm"> * read the SEEPROM settings directly) and that a controller has a buggered</span>
<span class="cm"> * version of the cable detection logic, this can be used to force the </span>
<span class="cm"> * correct termination.  It is preferable to use the manual termination</span>
<span class="cm"> * settings in the BIOS if possible, but some motherboard controllers store</span>
<span class="cm"> * those settings in a format we can&#39;t read.  In other cases, auto term</span>
<span class="cm"> * should also work, but the chipset was put together with no auto term</span>
<span class="cm"> * logic (common on motherboard controllers).  In those cases, we have</span>
<span class="cm"> * 32 bits here to work with.  That&#39;s good for 8 controllers/channels.  The</span>
<span class="cm"> * bits are organized as 4 bits per channel, with scsi0 getting the lowest</span>
<span class="cm"> * 4 bits in the int.  A 1 in a bit position indicates the termination setting</span>
<span class="cm"> * that corresponds to that bit should be enabled, a 0 is disabled.</span>
<span class="cm"> * It looks something like this:</span>
<span class="cm"> *</span>
<span class="cm"> *    0x0f =  1111-Single Ended Low Byte Termination on/off</span>
<span class="cm"> *            ||\-Single Ended High Byte Termination on/off</span>
<span class="cm"> *            |\-LVD Low Byte Termination on/off</span>
<span class="cm"> *            \-LVD High Byte Termination on/off</span>
<span class="cm"> *</span>
<span class="cm"> * For non-Ultra2 controllers, the upper 2 bits are not important.  So, to</span>
<span class="cm"> * enable both high byte and low byte termination on scsi0, I would need to</span>
<span class="cm"> * make sure that the override_term variable was set to 0x03 (bits 0011).</span>
<span class="cm"> * To make sure that all termination is enabled on an Ultra2 controller at</span>
<span class="cm"> * scsi2 and only high byte termination on scsi1 and high and low byte</span>
<span class="cm"> * termination on scsi0, I would set override_term=0xf23 (bits 1111 0010 0011)</span>
<span class="cm"> *</span>
<span class="cm"> * For the most part, users should never have to use this, that&#39;s why I</span>
<span class="cm"> * left it fairly cryptic instead of easy to understand.  If you need it,</span>
<span class="cm"> * most likely someone will be telling you what your&#39;s needs to be set to.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_override_term</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Certain motherboard chipset controllers tend to screw</span>
<span class="cm"> * up the polarity of the term enable output pin.  Use this variable</span>
<span class="cm"> * to force the correct polarity for your system.  This is a bitfield variable</span>
<span class="cm"> * similar to the previous one, but this one has one bit per channel instead</span>
<span class="cm"> * of four.</span>
<span class="cm"> *    0 = Force the setting to active low.</span>
<span class="cm"> *    1 = Force setting to active high.</span>
<span class="cm"> * Most Adaptec cards are active high, several motherboards are active low.</span>
<span class="cm"> * To force a 2940 card at SCSI 0 to active high and a motherboard 7895</span>
<span class="cm"> * controller at scsi1 and scsi2 to active low, and a 2910 card at scsi3</span>
<span class="cm"> * to active high, you would need to set stpwlev=0x9 (bits 1001).</span>
<span class="cm"> *</span>
<span class="cm"> * People shouldn&#39;t need to use this, but if you are experiencing lots of</span>
<span class="cm"> * SCSI timeout problems, this may help.  There is one sure way to test what</span>
<span class="cm"> * this option needs to be.  Using a boot floppy to boot the system, configure</span>
<span class="cm"> * your system to enable all SCSI termination (in the Adaptec SCSI BIOS) and</span>
<span class="cm"> * if needed then also pass a value to override_term to make sure that the</span>
<span class="cm"> * driver is enabling SCSI termination, then set this variable to either 0</span>
<span class="cm"> * or 1.  When the driver boots, make sure there are *NO* SCSI cables</span>
<span class="cm"> * connected to your controller.  If it finds and inits the controller</span>
<span class="cm"> * without problem, then the setting you passed to stpwlev was correct.  If</span>
<span class="cm"> * the driver goes into a reset loop and hangs the system, then you need the</span>
<span class="cm"> * other setting for this variable.  If neither setting lets the machine</span>
<span class="cm"> * boot then you have definite termination problems that may not be fixable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_stpwlev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Set this to non-0 in order to force the driver to panic the kernel</span>
<span class="cm"> * and print out debugging info on a SCSI abort or reset cycle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_panic_on_abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * PCI bus parity checking of the Adaptec controllers.  This is somewhat</span>
<span class="cm"> * dubious at best.  To my knowledge, this option has never actually</span>
<span class="cm"> * solved a PCI parity problem, but on certain machines with broken PCI</span>
<span class="cm"> * chipset configurations, it can generate tons of false error messages.</span>
<span class="cm"> * It&#39;s included in the driver for completeness.</span>
<span class="cm"> *   0 = Shut off PCI parity check</span>
<span class="cm"> *  -1 = Normal polarity pci parity checking</span>
<span class="cm"> *   1 = reverse polarity pci parity checking</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: you can&#39;t actually pass -1 on the lilo prompt.  So, to set this</span>
<span class="cm"> * variable to -1 you would actually want to simply pass the variable</span>
<span class="cm"> * name without a number.  That will invert the 0 which will result in</span>
<span class="cm"> * -1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_pci_parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Set this to any non-0 value to cause us to dump the contents of all</span>
<span class="cm"> * the card&#39;s registers in a hex dump format tailored to each model of</span>
<span class="cm"> * controller.</span>
<span class="cm"> * </span>
<span class="cm"> * NOTE: THE CONTROLLER IS LEFT IN AN UNUSABLE STATE BY THIS OPTION.</span>
<span class="cm"> *       YOU CANNOT BOOT UP WITH THIS OPTION, IT IS FOR DEBUGGING PURPOSES</span>
<span class="cm"> *       ONLY</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_dump_card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Set this to a non-0 value to make us dump out the 32 bit instruction</span>
<span class="cm"> * registers on the card after completing the sequencer download.  This</span>
<span class="cm"> * allows the actual sequencer download to be verified.  It is possible</span>
<span class="cm"> * to use this option and still boot up and run your system.  This is</span>
<span class="cm"> * only intended for debugging purposes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_dump_sequencer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Certain newer motherboards have put new PCI based devices into the</span>
<span class="cm"> * IO spaces that used to typically be occupied by VLB or EISA cards.</span>
<span class="cm"> * This overlap can cause these newer motherboards to lock up when scanned</span>
<span class="cm"> * for older EISA and VLB devices.  Setting this option to non-0 will</span>
<span class="cm"> * cause the driver to skip scanning for any VLB or EISA controllers and</span>
<span class="cm"> * only support the PCI controllers.  NOTE: this means that if the kernel</span>
<span class="cm"> * os compiled with PCI support disabled, then setting this to non-0</span>
<span class="cm"> * would result in never finding any devices :)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_no_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * On some machines, enabling the external SCB RAM isn&#39;t reliable yet.  I</span>
<span class="cm"> * haven&#39;t had time to make test patches for things like changing the</span>
<span class="cm"> * timing mode on that external RAM either.  Some of those changes may</span>
<span class="cm"> * fix the problem.  Until then though, we default to external SCB RAM</span>
<span class="cm"> * off and give a command line option to enable it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_scbram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * So that we can set how long each device is given as a selection timeout.</span>
<span class="cm"> * The table of values goes like this:</span>
<span class="cm"> *   0 - 256ms</span>
<span class="cm"> *   1 - 128ms</span>
<span class="cm"> *   2 - 64ms</span>
<span class="cm"> *   3 - 32ms</span>
<span class="cm"> * We default to 64ms because it&#39;s fast.  Some old SCSI-I devices need a</span>
<span class="cm"> * longer time.  The final value has to be left shifted by 3, hence 0x10</span>
<span class="cm"> * is the final value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_seltime</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * So that insmod can find the variable and make it point to something</span>
<span class="cm"> */</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">aic7xxx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">aic7xxx</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define VERBOSE_NORMAL         0x0000</span>
<span class="cp">#define VERBOSE_NEGOTIATION    0x0001</span>
<span class="cp">#define VERBOSE_SEQINT         0x0002</span>
<span class="cp">#define VERBOSE_SCSIINT        0x0004</span>
<span class="cp">#define VERBOSE_PROBE          0x0008</span>
<span class="cp">#define VERBOSE_PROBE2         0x0010</span>
<span class="cp">#define VERBOSE_NEGOTIATION2   0x0020</span>
<span class="cp">#define VERBOSE_MINOR_ERROR    0x0040</span>
<span class="cp">#define VERBOSE_TRACING        0x0080</span>
<span class="cp">#define VERBOSE_ABORT          0x0f00</span>
<span class="cp">#define VERBOSE_ABORT_MID      0x0100</span>
<span class="cp">#define VERBOSE_ABORT_FIND     0x0200</span>
<span class="cp">#define VERBOSE_ABORT_PROCESS  0x0400</span>
<span class="cp">#define VERBOSE_ABORT_RETURN   0x0800</span>
<span class="cp">#define VERBOSE_RESET          0xf000</span>
<span class="cp">#define VERBOSE_RESET_MID      0x1000</span>
<span class="cp">#define VERBOSE_RESET_FIND     0x2000</span>
<span class="cp">#define VERBOSE_RESET_PROCESS  0x4000</span>
<span class="cp">#define VERBOSE_RESET_RETURN   0x8000</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_verbose</span> <span class="o">=</span> <span class="n">VERBOSE_NORMAL</span> <span class="o">|</span> <span class="n">VERBOSE_NEGOTIATION</span> <span class="o">|</span>
           <span class="n">VERBOSE_PROBE</span><span class="p">;</span>                     <span class="cm">/* verbose messages */</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * We&#39;re going to start putting in function declarations so that order of</span>
<span class="cm"> * functions is no longer important.  As needed, they are added here.</span>
<span class="cm"> *</span>
<span class="cm"> ***************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aic7xxx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> 
		<span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">options</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_print_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_print_scratch_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_print_sequencer</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">downloaded</span><span class="p">);</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aic7xxx_check_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * These functions are now used.  They happen to be wrapped in useless</span>
<span class="cm"> * inb/outb port read/writes around the real reads and writes because it</span>
<span class="cm"> * seems that certain very fast CPUs have a problem dealing with us when</span>
<span class="cm"> * going at full speed.</span>
<span class="cm"> *</span>
<span class="cm"> ***************************************************************************/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">aic_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MMAPIO</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="cp">#else</span>
  <span class="k">return</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">port</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MMAPIO</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">mb</span><span class="p">();</span> <span class="cm">/* locked operation in order to force CPU ordering */</span>
    <span class="n">readb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">+</span> <span class="n">HCNTRL</span><span class="p">);</span> <span class="cm">/* dummy read to flush the PCI write */</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">mb</span><span class="p">();</span> <span class="cm">/* locked operation in order to force CPU ordering */</span>
  <span class="p">}</span>
<span class="cp">#else</span>
  <span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
  <span class="n">mb</span><span class="p">();</span> <span class="cm">/* locked operation in order to force CPU ordering */</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_setup</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Handle Linux boot parameters. This routine allows for assigning a value</span>
<span class="cm"> *   to a parameter with a &#39;:&#39; between the parameter and the value.</span>
<span class="cm"> *   ie. aic7xxx=unpause:0x0A,extended</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>   <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

  <span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flag</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">&quot;extended&quot;</span><span class="p">,</span>    <span class="o">&amp;</span><span class="n">aic7xxx_extended</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;no_reset&quot;</span><span class="p">,</span>    <span class="o">&amp;</span><span class="n">aic7xxx_no_reset</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;irq_trigger&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_irq_trigger</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span>     <span class="o">&amp;</span><span class="n">aic7xxx_verbose</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;reverse_scan&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">aic7xxx_reverse_scan</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;override_term&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_override_term</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;stpwlev&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_stpwlev</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;no_probe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_no_probe</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;panic_on_abort&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_panic_on_abort</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;pci_parity&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_pci_parity</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;dump_card&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_dump_card</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;dump_sequencer&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_dump_sequencer</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;default_queue_depth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_default_queue_depth</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;scbram&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_scbram</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;seltime&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aic7xxx_seltime</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;tag_info&quot;</span><span class="p">,</span>    <span class="nb">NULL</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,.&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">options</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;tag_info&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">,</span> <span class="o">*</span><span class="n">tok_end</span><span class="p">,</span> <span class="o">*</span><span class="n">tok_end2</span><span class="p">;</span>
            <span class="kt">char</span> <span class="n">tok_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">,</span> <span class="sc">&#39;{&#39;</span><span class="p">,</span> <span class="sc">&#39;}&#39;</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span> <span class="p">};</span>
            <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

            <span class="n">base</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Forward us just past the &#39;:&#39; */</span>
            <span class="n">tok_end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tok_end</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
              <span class="o">*</span><span class="n">tok_end</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">case</span> <span class="sc">&#39;{&#39;</span>:
                  <span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="n">tok</span><span class="o">++</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="sc">&#39;}&#39;</span>:
                  <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                  <span class="n">tok</span><span class="o">++</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
                <span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
                  <span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">device</span><span class="o">++</span><span class="p">;</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">instance</span><span class="o">++</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="n">MAX_TARGETS</span><span class="p">)</span> <span class="o">||</span> 
                       <span class="p">(</span><span class="n">instance</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aic7xxx_tag_info</span><span class="p">))</span> <span class="p">)</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                  <span class="n">tok</span><span class="o">++</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
                  <span class="p">{</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="n">tok</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="sc">&#39;\0&#39;</span>:
                  <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="nl">default:</span>
                  <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                  <span class="n">tok_end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
                  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">tok_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                  <span class="p">{</span>
                    <span class="n">tok_end2</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">tok_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tok_end2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tok_end2</span> <span class="o">&lt;</span> <span class="n">tok_end</span><span class="p">)</span> <span class="p">)</span>
                    <span class="p">{</span>
                      <span class="n">tok_end</span> <span class="o">=</span> <span class="n">tok_end2</span><span class="p">;</span>
                      <span class="n">done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">instance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="n">instance</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aic7xxx_tag_info</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="n">device</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">aic7xxx_tag_info</span><span class="p">[</span><span class="n">instance</span><span class="p">].</span><span class="n">tag_commands</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span>
                      <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
                  <span class="n">tok</span> <span class="o">=</span> <span class="n">tok_end</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">while</span><span class="p">((</span><span class="n">p</span> <span class="o">!=</span> <span class="n">base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
              <span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,.&quot;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;seltime&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xff29</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">));</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;seltime&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;aic7xxx=&quot;</span><span class="p">,</span> <span class="n">aic7xxx_setup</span><span class="p">);</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   pause_sequencer</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Pause the sequencer and wait for it to actually stop - this</span>
<span class="cm"> *   is important since the sequencer can disable pausing for critical</span>
<span class="cm"> *   sections.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pause_sequencer</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CCSCBCTL</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   unpause_sequencer</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Unpause the sequencer. Unremarkable, yet done often enough to</span>
<span class="cm"> *   warrant an easy way to do it.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unpause_sequencer</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unpause_always</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">unpause_always</span> <span class="o">||</span>
      <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSIINT</span> <span class="o">|</span> <span class="n">SEQINT</span> <span class="o">|</span> <span class="n">BRKADRINT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_HANDLING_REQINITS</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">unpause</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   restart_sequencer</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Restart the sequencer program from address zero.  This assumes</span>
<span class="cm"> *   that the sequencer is already paused.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">restart_sequencer</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FASTMODE</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We include the aic7xxx_seq.c file here so that the other defines have</span>
<span class="cm"> * already been made, and so that it comes before the code that actually</span>
<span class="cm"> * downloads the instructions (since we don&#39;t typically use function</span>
<span class="cm"> * prototype, our code has to be ordered that way, it&#39;s a left-over from</span>
<span class="cm"> * the original driver days.....I should fix it some time DL).</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;aic7xxx_old/aic7xxx_seq.c&quot;</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_check_patch</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   See if the next patch to download should be downloaded.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_check_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
  <span class="k">struct</span> <span class="n">sequencer_patch</span> <span class="o">**</span><span class="n">start_patch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_instr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">skip_addr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">sequencer_patch</span> <span class="o">*</span><span class="n">cur_patch</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sequencer_patch</span> <span class="o">*</span><span class="n">last_patch</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">num_patches</span><span class="p">;</span>

  <span class="n">num_patches</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sequencer_patches</span><span class="p">);</span>
  <span class="n">last_patch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sequencer_patches</span><span class="p">[</span><span class="n">num_patches</span><span class="p">];</span>
  <span class="n">cur_patch</span> <span class="o">=</span> <span class="o">*</span><span class="n">start_patch</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">((</span><span class="n">cur_patch</span> <span class="o">&lt;</span> <span class="n">last_patch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start_instr</span> <span class="o">==</span> <span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">patch_func</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Start rejecting code.</span>
<span class="cm">       */</span>
      <span class="o">*</span><span class="n">skip_addr</span> <span class="o">=</span> <span class="n">start_instr</span> <span class="o">+</span> <span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">skip_instr</span><span class="p">;</span>
      <span class="n">cur_patch</span> <span class="o">+=</span> <span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">skip_patch</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Found an OK patch.  Advance the patch pointer to the next patch</span>
<span class="cm">       * and wait for our instruction pointer to get here.</span>
<span class="cm">       */</span>
      <span class="n">cur_patch</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">start_patch</span> <span class="o">=</span> <span class="n">cur_patch</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">start_instr</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">skip_addr</span><span class="p">)</span>
    <span class="cm">/*</span>
<span class="cm">     * Still skipping</span>
<span class="cm">     */</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_download_instr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Find the next patch to download.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_download_instr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instrptr</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dconsts</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">union</span> <span class="n">ins_formats</span> <span class="n">instr</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">ins_format1</span> <span class="o">*</span><span class="n">fmt1_ins</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">ins_format3</span> <span class="o">*</span><span class="n">fmt3_ins</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opcode</span><span class="p">;</span>

  <span class="n">instr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">union</span> <span class="n">ins_formats</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">seqprog</span><span class="p">[</span><span class="n">instrptr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>

  <span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span><span class="p">);</span>
  
  <span class="n">fmt1_ins</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">.</span><span class="n">format1</span><span class="p">;</span>
  <span class="n">fmt3_ins</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/* Pull the opcode */</span>
  <span class="n">opcode</span> <span class="o">=</span> <span class="n">instr</span><span class="p">.</span><span class="n">format1</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">AIC_OP_JMP</span>:
    <span class="k">case</span> <span class="n">AIC_OP_JC</span>:
    <span class="k">case</span> <span class="n">AIC_OP_JNC</span>:
    <span class="k">case</span> <span class="n">AIC_OP_CALL</span>:
    <span class="k">case</span> <span class="n">AIC_OP_JNE</span>:
    <span class="k">case</span> <span class="n">AIC_OP_JNZ</span>:
    <span class="k">case</span> <span class="n">AIC_OP_JE</span>:
    <span class="k">case</span> <span class="n">AIC_OP_JZ</span>:
    <span class="p">{</span>
      <span class="k">struct</span> <span class="n">sequencer_patch</span> <span class="o">*</span><span class="n">cur_patch</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">address_offset</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">skip_addr</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

      <span class="n">fmt3_ins</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">.</span><span class="n">format3</span><span class="p">;</span>
      <span class="n">address_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">address</span> <span class="o">=</span> <span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
      <span class="n">cur_patch</span> <span class="o">=</span> <span class="n">sequencer_patches</span><span class="p">;</span>
      <span class="n">skip_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">address</span><span class="p">;)</span>
      <span class="p">{</span>
        <span class="n">aic7xxx_check_patch</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_patch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skip_addr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skip_addr</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kt">int</span> <span class="n">end_addr</span><span class="p">;</span>

          <span class="n">end_addr</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">skip_addr</span><span class="p">);</span>
          <span class="n">address_offset</span> <span class="o">+=</span> <span class="n">end_addr</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">=</span> <span class="n">skip_addr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">address</span> <span class="o">-=</span> <span class="n">address_offset</span><span class="p">;</span>
      <span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
      <span class="cm">/* Fall Through to the next code section */</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">AIC_OP_OR</span>:
    <span class="k">case</span> <span class="n">AIC_OP_AND</span>:
    <span class="k">case</span> <span class="n">AIC_OP_XOR</span>:
    <span class="k">case</span> <span class="n">AIC_OP_ADD</span>:
    <span class="k">case</span> <span class="n">AIC_OP_ADC</span>:
    <span class="k">case</span> <span class="n">AIC_OP_BMOV</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">dconsts</span><span class="p">[</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="cm">/* Fall Through to the next code section */</span>
    <span class="k">case</span> <span class="n">AIC_OP_ROL</span>:
      <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

        <span class="cm">/* Calculate odd parity for the instruction */</span>
        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

          <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
          <span class="n">instr</span><span class="p">.</span><span class="n">format1</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fmt3_ins</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span>  <span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span>  <span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">destination</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
                          <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">SEQRAM</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">((</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">SEQRAM</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">((</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">SEQRAM</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">((</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">SEQRAM</span><span class="p">);</span>
      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;aic7xxx: Unknown opcode encountered in sequencer program.&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_loadseq</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Load the sequencer code into the controller memory.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_loadseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">sequencer_patch</span> <span class="o">*</span><span class="n">cur_patch</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">downloaded</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">skip_addr</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">download_consts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Downloading sequencer code...&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  download_consts[TMODE_NUMCMDS] = p-&gt;num_targetcmds;</span>
<span class="cp">#endif</span>
  <span class="n">download_consts</span><span class="p">[</span><span class="n">TMODE_NUMCMDS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">cur_patch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sequencer_patches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">downloaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">skip_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PERRORDIS</span><span class="o">|</span><span class="n">LOADRAM</span><span class="o">|</span><span class="n">FAILDIS</span><span class="o">|</span><span class="n">FASTMODE</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seqprog</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_check_patch</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_patch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skip_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Skip this instruction for this configuration. */</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">aic7xxx_download_instr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">download_consts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">downloaded</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FASTMODE</span> <span class="o">|</span> <span class="n">FAILDIS</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FASTMODE</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d instructions downloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">downloaded</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_dump_sequencer</span><span class="p">)</span>
    <span class="n">aic7xxx_print_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">downloaded</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_print_sequencer</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Print the contents of the sequencer memory to the screen.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_print_sequencer</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">downloaded</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
  
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PERRORDIS</span><span class="o">|</span><span class="n">LOADRAM</span><span class="o">|</span><span class="n">FAILDIS</span><span class="o">|</span><span class="n">FASTMODE</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">);</span>

  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">downloaded</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%03x: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQRAM</span><span class="p">);</span>
    <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQRAM</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQRAM</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQRAM</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%08x&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">++</span><span class="n">k</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FASTMODE</span> <span class="o">|</span> <span class="n">FAILDIS</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FASTMODE</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_info</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Return a string describing the driver.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">aic7xxx_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">dooh</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

  <span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span><span class="n">dooh</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;Adaptec AHA274x/284x/294x (EISA/VLB/PCI-Fast SCSI) &quot;</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">AIC7XXX_C_VERSION</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">AIC7XXX_H_VERSION</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;       &lt;&quot;</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">board_names</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">board_name_index</span><span class="p">]);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>

  <span class="k">return</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_find_syncrate</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Look up the valid period to SCSIRATE conversion in our table</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span>
<span class="nf">aic7xxx_find_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">period</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxsync</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_CRC</span>:
    <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_UNITS</span>:
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA3</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">maxsync</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">,</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_CRC_QUICK</span>:
    <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_UNITS_QUICK</span>:
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA3</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">maxsync</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">,</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * we don&#39;t support the Quick Arbitration variants of dual edge</span>
<span class="cm">         * clocking.  As it turns out, we want to send back the</span>
<span class="cm">         * same basic option, but without the QA attribute.</span>
<span class="cm">         * We know that we are responding because we would never set</span>
<span class="cm">         * these options ourself, we would only respond to them.</span>
<span class="cm">         */</span>
        <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_CRC_QUICK</span>:
            <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="n">MSG_EXT_PPR_OPTION_DT_CRC</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_UNITS_QUICK</span>:
            <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="n">MSG_EXT_PPR_OPTION_DT_UNITS</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">maxsync</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">,</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">syncrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aic7xxx_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">||</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_CRC</span>:
        <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_UNITS</span>:
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span> <span class="o">&amp;</span> <span class="n">AHC_SYNCRATE_CRC</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="cm">/*</span>
<span class="cm">             * oops, we went too low for the CRC/DualEdge signalling, so</span>
<span class="cm">             * clear the options byte</span>
<span class="cm">             */</span>
            <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="cm">/*</span>
<span class="cm">             * We&#39;ll be sending a reply to this packet to set the options</span>
<span class="cm">             * properly, so unilaterally set the period as well.</span>
<span class="cm">             */</span>
            <span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">aic7xxx_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">])</span>
            <span class="p">{</span>
              <span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span> <span class="o">&amp;</span> <span class="n">AHC_SYNCRATE_CRC</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">aic7xxx_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">])</span>
            <span class="p">{</span>
              <span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">syncrate</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
       <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Use async transfers for this target</span>
<span class="cm">     */</span>
    <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="n">syncrate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_find_period</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Look up the valid SCSIRATE to period conversion in our table</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">aic7xxx_find_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsirate</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxsync</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="n">SXFR_ULTRA2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="n">SXFR</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">syncrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aic7xxx_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">==</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">==</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_SYNCRATE_CRC</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">==</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ULTRA_SXFR</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">syncrate</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* async */</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_validate_offset</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Set a valid offset value for a particular card in use and transfer</span>
<span class="cm"> *   settings in use.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_validate_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
  <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wide</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxoffset</span><span class="p">;</span>

  <span class="cm">/* Limit offset to what the card (and device) can do */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">maxoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">maxoffset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wide</span><span class="p">)</span>
      <span class="n">maxoffset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_16BIT</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">maxoffset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="n">maxoffset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_set_syncrate</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Set the actual syncrate down in the card and in our host structs</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_set_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">options</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tindex</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">target_mask</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lun</span><span class="p">,</span> <span class="n">old_options</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_period</span><span class="p">,</span> <span class="n">old_offset</span><span class="p">;</span>

  <span class="n">tindex</span> <span class="o">=</span> <span class="n">target</span> <span class="o">|</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">target_mask</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">;</span>
  <span class="n">lun</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TCL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">old_period</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
  <span class="n">old_offset</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
  <span class="n">old_options</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">options</span><span class="p">;</span>

  
  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_CUR</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsirate</span><span class="p">;</span>

    <span class="n">scsirate</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SXFR_ULTRA2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="n">MSG_EXT_PPR_OPTION_DT_UNITS</span>:
            <span class="cm">/*</span>
<span class="cm">             * mask off the CRC bit in the xfer settings</span>
<span class="cm">             */</span>
            <span class="n">scsirate</span> <span class="o">|=</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_SYNCRATE_CRC</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="nl">default:</span>
            <span class="n">scsirate</span> <span class="o">|=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_ultra2</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SCSIOFFSET</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">TARG_OFFSET</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="cm">/* Not an Ultra2 controller */</span>
    <span class="p">{</span>
      <span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SXFR</span><span class="o">|</span><span class="n">SOFS</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">target_mask</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr</span> <span class="o">&amp;</span> <span class="n">ULTRA_SXFR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">|=</span> <span class="n">target_mask</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">scsirate</span> <span class="o">|=</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr</span> <span class="o">&amp;</span> <span class="n">SXFR</span><span class="p">);</span>
        <span class="n">scsirate</span> <span class="o">|=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">SOFS</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sxfrctl0</span><span class="p">;</span>

        <span class="n">sxfrctl0</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">);</span>
        <span class="n">sxfrctl0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FAST20</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">target_mask</span><span class="p">)</span>
          <span class="n">sxfrctl0</span> <span class="o">|=</span> <span class="n">FAST20</span><span class="p">;</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sxfrctl0</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ULTRA_ENB</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ULTRA_ENB</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_QUITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">int</span> <span class="n">rate_mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Synchronous at %s Mbyte/sec, &quot;</span>
               <span class="s">&quot;offset %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
               <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">rate_mod</span><span class="p">],</span> <span class="n">offset</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Using asynchronous transfers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_GOAL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_USER</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_set_width</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Set the actual width down in the card and in our host structs</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_set_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tindex</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">target_mask</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_width</span><span class="p">;</span>

  <span class="n">tindex</span> <span class="o">=</span> <span class="n">target</span> <span class="o">|</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">target_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">;</span>
  
  <span class="n">old_width</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_CUR</span><span class="p">)</span> 
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsirate</span><span class="p">;</span>

    <span class="n">scsirate</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>

    <span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIDEXFER</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span>
      <span class="n">scsirate</span> <span class="o">|=</span> <span class="n">WIDEXFER</span><span class="p">;</span>

    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">)</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">);</span>

    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_QUITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
          <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Using %s transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
        <span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Wide(16bit)&quot;</span> <span class="o">:</span> <span class="s">&quot;Narrow(8bit)&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_GOAL</span><span class="p">)</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_USER</span><span class="p">)</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_16BIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
      
<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   scbq_init</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   SCB queue initialization.</span>
<span class="cm"> *</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">scbq_init</span><span class="p">(</span><span class="k">volatile</span> <span class="n">scb_queue_type</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   scbq_insert_head</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Add an SCB to the head of the list.</span>
<span class="cm"> *</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">scbq_insert_head</span><span class="p">(</span><span class="k">volatile</span> <span class="n">scb_queue_type</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>       <span class="cm">/* If list was empty, update tail. */</span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   scbq_remove_head</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Remove an SCB from the head of the list.</span>
<span class="cm"> *</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span>
<span class="nf">scbq_remove_head</span><span class="p">(</span><span class="k">volatile</span> <span class="n">scb_queue_type</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span> <span class="n">scbp</span><span class="p">;</span>

  <span class="n">scbp</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>       <span class="cm">/* If list is now empty, update tail. */</span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">return</span><span class="p">(</span><span class="n">scbp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   scbq_remove</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Removes an SCB from the list.</span>
<span class="cm"> *</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">scbq_remove</span><span class="p">(</span><span class="k">volatile</span> <span class="n">scb_queue_type</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">scb</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* At beginning of queue, remove from head. */</span>
    <span class="n">scbq_remove_head</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">curscb</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Search until the next scb is the one we&#39;re looking for, or</span>
<span class="cm">     * we run out of queue.</span>
<span class="cm">     */</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">curscb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">curscb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">!=</span> <span class="n">scb</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">curscb</span> <span class="o">=</span> <span class="n">curscb</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">curscb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Found it. */</span>
      <span class="n">curscb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/* Update the tail when removing the tail. */</span>
        <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">curscb</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   scbq_insert_tail</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Add an SCB at the tail of the list.</span>
<span class="cm"> *</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">scbq_insert_tail</span><span class="p">(</span><span class="k">volatile</span> <span class="n">scb_queue_type</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>       <span class="cm">/* Add the scb at the end of the list. */</span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>             <span class="cm">/* Update the tail. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>       <span class="cm">/* If list was empty, update head. */</span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_match_scb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Checks to see if an scb matches the target/channel as specified.</span>
<span class="cm"> *   If target is ALL_TARGETS (-1), then we&#39;re looking for any device</span>
<span class="cm"> *   on the specified channel; this happens when a channel is going</span>
<span class="cm"> *   to be reset and all devices on that channel must be aborted.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_match_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">targ</span> <span class="o">=</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">slun</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">match</span><span class="p">;</span>

  <span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">chan</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">ALL_CHANNELS</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">targ</span> <span class="o">==</span> <span class="n">target</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">ALL_TARGETS</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">lun</span> <span class="o">==</span> <span class="n">slun</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lun</span> <span class="o">==</span> <span class="n">ALL_LUNS</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">));</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">match</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_add_curscb_to_free_list</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Adds the current scb (in SCBPTR) to the list of free SCBs.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*</span>
<span class="cm">   * Invalidate the tag so that aic7xxx_find_scb doesn&#39;t think</span>
<span class="cm">   * it&#39;s active</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>

  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">),</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">),</span> <span class="n">FREE_SCBH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_rem_scb_from_disc_list</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Removes the current SCB from the disconnected list and adds it</span>
<span class="cm"> *   to the free list.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">aic7xxx_rem_scb_from_disc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scbptr</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">next</span><span class="p">;</span>

  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
  <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_busy_target</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Set the specified target busy.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">aic7xxx_busy_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_index_busy_target</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Returns the index of the busy target, and optionally sets the</span>
<span class="cm"> *   target inactive.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">aic7xxx_index_busy_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tcl</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">unbusy</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busy_scbid</span><span class="p">;</span>

  <span class="n">busy_scbid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span><span class="p">[</span><span class="n">tcl</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">unbusy</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span><span class="p">[</span><span class="n">tcl</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">busy_scbid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_find_scb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Look through the SCB array of the card and attempt to find the</span>
<span class="cm"> *   hardware SCB that corresponds to the passed in SCB.  Return</span>
<span class="cm"> *   SCB_LIST_NULL if unsuccessful.  This routine assumes that the</span>
<span class="cm"> *   card is already paused.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">aic7xxx_find_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_scbptr</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curindex</span><span class="p">;</span>

  <span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">curindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">curindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curindex</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">;</span> <span class="n">curindex</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">curindex</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">)</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">curindex</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">curindex</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">curindex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_allocate_scb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Get an SCB from the free list or by allocating a new one.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_allocate_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span>   <span class="o">*</span><span class="n">scbp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scb_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_scatterlist</span><span class="p">)</span> <span class="o">*</span> <span class="n">AIC7XXX_MAX_SG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">hw_scatterlist</span> <span class="o">*</span><span class="n">hsgp</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb_ap</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb_dma</span> <span class="o">*</span><span class="n">scb_dma</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bufs</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxscbs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Calculate the optimal number of SCBs to allocate.</span>
<span class="cm">     *</span>
<span class="cm">     * NOTE: This formula works because the sizeof(sg_array) is always</span>
<span class="cm">     * 1024.  Therefore, scb_size * i would always be &gt; PAGE_SIZE *</span>
<span class="cm">     * (i/step).  The (i-1) allows the left hand side of the equation</span>
<span class="cm">     * to grow into the right hand side to a point of near perfect</span>
<span class="cm">     * efficiency since scb_size * (i -1) is growing slightly faster</span>
<span class="cm">     * than the right hand side.  If the number of SG array elements</span>
<span class="cm">     * is changed, this function may not be near so efficient any more.</span>
<span class="cm">     *</span>
<span class="cm">     * Since the DMA&#39;able buffers are now allocated in a separate</span>
<span class="cm">     * chunk this algorithm has been modified to match.  The &#39;12&#39;</span>
<span class="cm">     * and &#39;6&#39; factors in scb_size are for the DMA&#39;able command byte</span>
<span class="cm">     * and sensebuffers respectively.  -DaveM</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="n">step</span><span class="p">;;</span> <span class="n">i</span> <span class="o">*=</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">scb_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">step</span><span class="p">))</span> <span class="o">-</span> <span class="mi">64</span> <span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">i</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">scb_count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxscbs</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">);</span>
    <span class="n">scb_ap</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_scb</span><span class="p">)</span> <span class="o">*</span> <span class="n">scb_count</span>
					   <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_scb_dma</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb_ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">scb_dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_scb_dma</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scb_ap</span><span class="p">[</span><span class="n">scb_count</span><span class="p">];</span>
    <span class="n">hsgp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_scatterlist</span> <span class="o">*</span><span class="p">)</span>
      <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scb_size</span> <span class="o">*</span> <span class="n">scb_count</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hsgp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">scb_ap</span><span class="p">);</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hsgp</span><span class="p">[</span><span class="n">scb_count</span> <span class="o">*</span> <span class="n">AIC7XXX_MAX_SG</span><span class="p">];</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Allocating initial %ld SCB structures.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scb_count</span><span class="p">);</span>
      <span class="k">else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Allocating %ld additional SCB structures.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scb_count</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">scb_ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_scb</span><span class="p">)</span> <span class="o">*</span> <span class="n">scb_count</span><span class="p">);</span>
    <span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_address</span>
			  <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hsgp</span><span class="p">;</span>
    <span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">scb_size</span> <span class="o">*</span> <span class="n">scb_count</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scb_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scbp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scb_ap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">];</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsgp</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">AIC7XXX_MAX_SG</span><span class="p">];</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">sense_cmd</span> <span class="o">=</span> <span class="n">bufs</span><span class="p">;</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">bufs</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
      <span class="n">bufs</span> <span class="o">+=</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">scb_dma</span> <span class="o">=</span> <span class="n">scb_dma</span><span class="p">;</span>
      <span class="n">memset</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_hwscb</span><span class="p">));</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">;</span>
      <span class="cm">/*</span>
<span class="cm">       * Place in the scb array; never is removed</span>
<span class="cm">       */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scbp</span><span class="p">;</span>
      <span class="n">scbq_insert_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">kmalloc_ptr</span> <span class="o">=</span> <span class="n">scb_ap</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">scb_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_queue_cmd_complete</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Due to race conditions present in the SCSI subsystem, it is easier</span>
<span class="cm"> *   to queue completed commands, then call scsi_done() on them when</span>
<span class="cm"> *   we&#39;re finished.  This function queues the completed commands.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_queue_cmd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_done_cmds_complete</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Process the completed command queue.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aic7xxx_done_cmds_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_free_scb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Free the scb and insert into the free scb list.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_free_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>

  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_FREE</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>

  <span class="n">scbq_insert_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_done</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Calls the higher level scsi done function and frees the scb.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tindex</span> <span class="o">=</span> <span class="n">TARGET_INDEX</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">queue_depth</span><span class="p">;</span>

        <span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
                     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">),</span>
                     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
                     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_RECOVERY_SCB</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_ABORT_PENDING</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCB_RESET</span><span class="o">|</span><span class="n">SCB_ABORT</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">message_error</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">;</span>
 
    <span class="cm">/*</span>
<span class="cm">     * Check to see if we get an invalid message or a message error</span>
<span class="cm">     * after failing to negotiate a wide or sync transfer message.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
          <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x43</span><span class="p">)</span> <span class="o">||</span>  <span class="cm">/* INVALID_MESSAGE */</span>
          <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x49</span><span class="p">)))</span> <span class="cm">/* MESSAGE_ERROR  */</span>
    <span class="p">{</span>
      <span class="n">message_error</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_WDTR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">message_error</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device failed to complete Wide Negotiation &quot;</span>
            <span class="s">&quot;processing and</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;returned a sense error code for invalid message, &quot;</span>
            <span class="s">&quot;disabling future</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Wide negotiation to this device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
            <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">message_error</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device failed to complete Sync Negotiation &quot;</span>
            <span class="s">&quot;processing and</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;returned a sense error code for invalid message, &quot;</span>
            <span class="s">&quot;disabling future</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Sync negotiation to this device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
            <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_PPR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">message_error</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device failed to complete Parallel Protocol &quot;</span>
            <span class="s">&quot;Request processing and</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;returned a sense error code for invalid message, &quot;</span>
            <span class="s">&quot;disabling future</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Parallel Protocol Request negotiation to this &quot;</span>
            <span class="s">&quot;device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">         * Disable PPR negotiation and revert back to WDTR and SDTR setup</span>
<span class="cm">         */</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">queue_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scbp</span> <span class="o">=</span> <span class="n">scbq_remove_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scbp</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Give extra preference to untagged devices, such as CD-R devices</span>
<span class="cm">         * This makes it more likely that a drive *won&#39;t* stuff up while</span>
<span class="cm">         * waiting on data at a critical time, such as CD-R writing and</span>
<span class="cm">         * audio CD ripping operations.  Should also benefit tape drives.</span>
<span class="cm">         */</span>
        <span class="n">scbq_insert_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">scbq_insert_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Moving SCB from delayed to waiting queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scbp</span><span class="p">));</span>
<span class="cp">#endif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">scbp</span> <span class="o">=</span> <span class="n">scbq_remove_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scbp</span><span class="p">)</span>
          <span class="n">scbq_insert_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_index_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span><span class="p">,</span>
                              <span class="cm">/* unbusy */</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_DTR_SCB</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">--</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">--</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">DID_OK</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">w_total</span><span class="o">++</span><span class="p">;</span>
      <span class="n">ptr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">w_bins</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">r_total</span><span class="o">++</span><span class="p">;</span>
      <span class="n">ptr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">r_bins</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span><span class="p">;</span>
    <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
      <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">aic7xxx_free_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
  <span class="n">aic7xxx_queue_cmd_complete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_run_done_queue</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Calls the aic7xxx_done() for the scsi_cmnd of each scb in the</span>
<span class="cm"> *   aborted list, and adds each scb to the free list.  If complete</span>
<span class="cm"> *   is TRUE, we also process the commands complete list.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_run_done_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="cm">/*complete*/</span> <span class="kt">int</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_QUEUE_FULL</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">QUEUE_FULL</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">))</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Aborting scb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * Clear any residual information since the normal aic7xxx_done() path</span>
<span class="cm">         * doesn&#39;t touch the residuals.</span>
<span class="cm">         */</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_SG_segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">found</span><span class="o">++</span><span class="p">;</span>
      <span class="n">aic7xxx_done</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_RETURN</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_RETURN</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;%d commands found and queued for &quot;</span>
        <span class="s">&quot;completion.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_done_cmds_complete</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_abort_waiting_scb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Manipulate the waiting for selection list and return the</span>
<span class="cm"> *   scb that follows the one that we remove.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">aic7xxx_abort_waiting_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scbpos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curscb</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Select the SCB we want to abort and pull the next pointer out of it.</span>
<span class="cm">   */</span>
  <span class="n">curscb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbpos</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>

  <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Update the waiting list</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * First in the list</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Select the scb that pointed to us and update its next pointer.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">   * Point us back at the original scb position and inform the SCSI</span>
<span class="cm">   * system that the command has been aborted.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">curscb</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">next</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_search_qinfifo</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Search the queue-in FIFO for matching SCBs and conditionally</span>
<span class="cm"> *   requeue.  Returns the number of matching SCBs.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_search_qinfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">requeue</span><span class="p">,</span>
    <span class="k">volatile</span> <span class="n">scb_queue_type</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span>      <span class="n">found</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qinpos</span><span class="p">,</span> <span class="n">qintail</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">;</span>

  <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">qinpos</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">QINPOS</span><span class="p">);</span>
  <span class="n">qintail</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">;</span>

  <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">=</span> <span class="n">qinpos</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">qinpos</span> <span class="o">!=</span> <span class="n">qintail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinpos</span><span class="o">++</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
    <span class="p">{</span>
       <span class="cm">/*</span>
<span class="cm">        * We found an scb that needs to be removed.</span>
<span class="cm">        */</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">requeue</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
       <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
         <span class="p">{</span>
           <span class="n">scbq_remove</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
           <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
           <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
           <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="n">scbq_insert_tail</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
         <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">--</span><span class="p">;</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">--</span><span class="p">;</span>
         <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_WAITINGQ</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="p">)</span>
         <span class="p">{</span>
           <span class="n">aic7xxx_index_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span><span class="p">,</span>
             <span class="n">TRUE</span><span class="p">);</span>
         <span class="p">}</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">requeue</span><span class="p">)</span>
       <span class="p">{</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">else</span>
       <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Preserve any SCB_RECOVERY_SCB flags on this scb then set the</span>
<span class="cm">         * flags we were called with, presumeably so aic7xxx_run_done_queue</span>
<span class="cm">         * can find this scb</span>
<span class="cm">         */</span>
         <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_RECOVERY_SCB</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_index_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span><span class="p">,</span>
                                       <span class="n">FALSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
         <span class="p">{</span>
           <span class="n">aic7xxx_index_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span><span class="p">,</span>
             <span class="n">TRUE</span><span class="p">);</span>
         <span class="p">}</span>
       <span class="p">}</span>
       <span class="n">found</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">   * Now that we&#39;ve done the work, clear out any left over commands in the</span>
<span class="cm">   * qinfifo and update the KERNEL_QINPOS down on the card.</span>
<span class="cm">   *</span>
<span class="cm">   *  NOTE: This routine expect the sequencer to already be paused when</span>
<span class="cm">   *        it is run....make sure it&#39;s that way!</span>
<span class="cm">   */</span>
  <span class="n">qinpos</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">qinpos</span> <span class="o">!=</span> <span class="n">qintail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinpos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_scb_on_qoutfifo</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Is the scb that was passed to us currently on the qoutfifo?</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_scb_on_qoutfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">]</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">]</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_reset_device</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   The device at the given target/channel has been reset.  Abort</span>
<span class="cm"> *   all active and queued scbs for that target/channel.  This function</span>
<span class="cm"> *   need not worry about linked next pointers because if was a MSG_ABORT_TAG</span>
<span class="cm"> *   then we had a tagged command (no linked next), if it was MSG_ABORT or</span>
<span class="cm"> *   MSG_BUS_DEV_RESET then the device won&#39;t know about any commands any more</span>
<span class="cm"> *   and no busy commands will exist, and if it was a bus reset, then nothing</span>
<span class="cm"> *   knows about any linked next commands any more.  In all cases, we don&#39;t</span>
<span class="cm"> *   need to worry about the linked next or busy scb, we just need to clear</span>
<span class="cm"> *   them.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_reset_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
                     <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_scbp</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">active_scb</span><span class="p">,</span> <span class="n">tcl</span><span class="p">,</span> <span class="n">scb_tag</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">init_lists</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Restore this when we&#39;re done</span>
<span class="cm">   */</span>
  <span class="n">active_scb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">scb_tag</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_RESET_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Reset device, hardware_scb %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">active_scb</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Current scb %d, SEQADDR 0x%x, LASTPHASE &quot;</span>
           <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">scb_tag</span><span class="p">,</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">));</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SG_CACHEPTR 0x%x, SG_COUNT %d, SCSISIGI 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
         <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">?</span>  <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_CACHEPTR</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SSTAT0 0x%x, SSTAT1 0x%x, SSTAT2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Deal with the busy target and linked next issues.</span>
<span class="cm">   */</span>
  <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">aic_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">aic_devs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_RESET_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">))</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;processing aic_dev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
		    <span class="n">lun</span><span class="p">,</span> <span class="n">aic_dev</span><span class="p">);</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">SDptr</span><span class="p">;</span>

    <span class="k">if</span><span class="p">((</span><span class="n">target</span> <span class="o">!=</span> <span class="n">ALL_TARGETS</span> <span class="o">&amp;&amp;</span> <span class="n">target</span> <span class="o">!=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
       <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">ALL_CHANNELS</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">!=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">))</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Cleaning up status information &quot;</span>
          <span class="s">&quot;and delayed_scbs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BUS_DEVICE_RESET_PENDING</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">tcl</span> <span class="o">=</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_index_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tcl</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">)</span>
      <span class="n">aic7xxx_index_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tcl</span><span class="p">,</span> <span class="cm">/* unbusy */</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">prev_scbp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
    <span class="n">scbp</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">scbp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">prev_scbp</span> <span class="o">=</span> <span class="n">scbp</span><span class="p">;</span>
      <span class="n">scbp</span> <span class="o">=</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev_scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">,</span> <span class="n">prev_scbp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_ACTIVE</span> <span class="o">|</span> <span class="n">SCB_WAITINGQ</span><span class="p">);</span>
        <span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">))</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Cleaning QINFIFO.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span> <span class="p">);</span>
  <span class="n">aic7xxx_search_qinfifo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
      <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">,</span> <span class="cm">/* requeue */</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Search the waiting_scbs queue for matches, this catches any SCB_QUEUED</span>
<span class="cm"> *  ABORT/RESET commands.</span>
<span class="cm"> */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">))</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Cleaning waiting_scbs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
      <span class="n">target</span><span class="p">,</span> <span class="n">lun</span> <span class="p">);</span>
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_scbp</span><span class="p">;</span>

    <span class="n">prev_scbp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
    <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">scbp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">prev_scbp</span> <span class="o">=</span> <span class="n">scbp</span><span class="p">;</span>
      <span class="n">scbp</span> <span class="o">=</span> <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev_scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">prev_scbp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_ACTIVE</span> <span class="o">|</span> <span class="n">SCB_WAITINGQ</span><span class="p">);</span>
        <span class="n">prev_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>


  <span class="cm">/*</span>
<span class="cm">   * Search waiting for selection list.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">))</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Cleaning waiting for selection &quot;</span>
      <span class="s">&quot;list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">;</span>

    <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>  <span class="cm">/* Start at head of list. */</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
      <span class="p">{</span>
       <span class="cm">/*</span>
<span class="cm">        * No aic7xxx_verbose check here.....we want to see this since it</span>
<span class="cm">        * means either the kernel driver or the sequencer screwed things up</span>
<span class="cm">        */</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Waiting List inconsistency; SCB index=%d, &quot;</span>
          <span class="s">&quot;numscbs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">,</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">);</span>
        <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
        <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">next</span> <span class="o">=</span> <span class="n">aic7xxx_abort_waiting_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_ACTIVE</span> <span class="o">|</span> <span class="n">SCB_WAITINGQ</span><span class="p">);</span>
          <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * This is either the first scb on the waiting list, or we</span>
<span class="cm">             * have already yanked the first and haven&#39;t left any behind.</span>
<span class="cm">             * Either way, we need to turn off the selection hardware if</span>
<span class="cm">             * it isn&#39;t already off.</span>
<span class="cm">             */</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
          <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Go through disconnected list and remove any entries we have queued</span>
<span class="cm">   * for completion, zeroing their control byte too.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_ABORT_PROCESS</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">))</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Cleaning disconnected scbs &quot;</span>
      <span class="s">&quot;list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">;</span>

    <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Disconnected List inconsistency; SCB index=%d, &quot;</span>
          <span class="s">&quot;numscbs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">,</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">);</span>
        <span class="n">next</span> <span class="o">=</span> <span class="n">aic7xxx_rem_scb_from_disc_list</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">next</span> <span class="o">=</span> <span class="n">aic7xxx_rem_scb_from_disc_list</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_ACTIVE</span> <span class="o">|</span> <span class="n">SCB_WAITINGQ</span><span class="p">);</span>
          <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
          <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
          <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Walk the free list making sure no entries on the free list have</span>
<span class="cm">   * a valid SCB_TAG value or SCB_CONTROL byte.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">next</span><span class="p">;</span>

    <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Free list inconsistency!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
          <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
        <span class="n">init_lists</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">next</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
        <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Go through the hardware SCB array looking for commands that</span>
<span class="cm">   * were active but not on any list.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">init_lists</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scbid</span><span class="p">;</span>

    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">init_lists</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
      <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">scbid</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scbid</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scbid</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
          <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Go through the entire SCB array now and look for commands for</span>
<span class="cm">   * for this target that are stillactive.  These are other (most likely</span>
<span class="cm">   * tagged) commands that were disconnected when the reset occurred.</span>
<span class="cm">   * Any commands we find here we know this about, it wasn&#39;t on any queue,</span>
<span class="cm">   * it wasn&#39;t in the qinfifo, it wasn&#39;t in the disconnected or waiting</span>
<span class="cm">   * lists, so it really must have been a paged out SCB.  In that case,</span>
<span class="cm">   * we shouldn&#39;t need to bother with updating any counters, just mark</span>
<span class="cm">   * the correct flags and go on.</span>
<span class="cm">   */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">aic7xxx_scb_on_qoutfifo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
        <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
        <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
      <span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_ACTIVE</span> <span class="o">|</span> <span class="n">SCB_WAITINGQ</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">active_scb</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_clear_intstat</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Clears the interrupt status.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_clear_intstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Clear any interrupt conditions this may have caused. */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELDO</span> <span class="o">|</span> <span class="n">CLRSELDI</span> <span class="o">|</span> <span class="n">CLRSELINGO</span><span class="p">,</span> <span class="n">CLRSINT0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span> <span class="o">|</span> <span class="n">CLRATNO</span> <span class="o">|</span> <span class="n">CLRSCSIRSTI</span> <span class="o">|</span> <span class="n">CLRBUSFREE</span> <span class="o">|</span> <span class="n">CLRSCSIPERR</span> <span class="o">|</span>
       <span class="n">CLRPHASECHG</span> <span class="o">|</span> <span class="n">CLRREQINIT</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span> <span class="o">|</span> <span class="n">CLRSEQINT</span> <span class="o">|</span> <span class="n">CLRBRKADRINT</span> <span class="o">|</span> <span class="n">CLRPARERR</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_reset_current_bus</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Reset the current SCSI bus.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_reset_current_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>

  <span class="cm">/* Disable reset interrupts. */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSCSIRST</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>

  <span class="cm">/* Turn off the bus&#39; current operations, after all, we shouldn&#39;t have any</span>
<span class="cm">   * valid commands left to cause a RSELI and SELO once we&#39;ve tossed the</span>
<span class="cm">   * bus away with this reset, so we might as well shut down the sequencer</span>
<span class="cm">   * until the bus is restarted as opposed to saving the current settings</span>
<span class="cm">   * and restoring them (which makes no sense to me). */</span>

  <span class="cm">/* Turn on the bus reset. */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCSIRSTO</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSIRSTO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Some of the new Ultra2 chipsets need a longer delay after a chip</span>
<span class="cm">   * reset than just the init setup creates, so we have to delay here</span>
<span class="cm">   * before we go into a reset in order to make the chips happy.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

  <span class="cm">/* Turn off the bus reset. */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
  <span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

  <span class="n">aic7xxx_clear_intstat</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="cm">/* Re-enable reset interrupts. */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ENSCSIRST</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_reset_channel</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Reset the channel.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_reset_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initiate_reset</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset_min</span><span class="p">,</span> <span class="n">offset_max</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sblkctl</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">cur_channel</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Reset channel called, %s initiate reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">initiate_reset</span><span class="o">==</span><span class="n">TRUE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;will&quot;</span> <span class="o">:</span> <span class="s">&quot;won&#39;t&quot;</span> <span class="p">);</span>


  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">offset_min</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">offset_max</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Channel A */</span>
      <span class="n">offset_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">offset_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">offset_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">offset_max</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">offset_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">offset_min</span> <span class="o">&lt;</span> <span class="n">offset_max</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Revert to async/narrow transfers until we renegotiate.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">offset_min</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARG_OFFSET</span> <span class="o">+</span> <span class="n">offset_min</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">offset_min</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Reset the bus and unpause/restart the controller</span>
<span class="cm">   */</span>
  <span class="n">sblkctl</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span> <span class="p">)</span>
    <span class="n">cur_channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">sblkctl</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">cur_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">cur_channel</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Case 1: Command for another bus is active</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Stealthily resetting idle channel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Stealthily reset the other bus without upsetting the current bus.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sblkctl</span> <span class="o">^</span> <span class="n">SELBUSB</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENBUSFREE</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initiate_reset</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic7xxx_reset_current_bus</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">),</span> <span class="n">SCSISEQ</span><span class="p">);</span>
    <span class="n">aic7xxx_clear_intstat</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sblkctl</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Case 2: A command from this bus is active or we&#39;re idle.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Resetting currently active channel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ENBUSFREE</span><span class="o">|</span><span class="n">ENREQINIT</span><span class="p">),</span>
      <span class="n">SIMODE1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_NONE</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initiate_reset</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic7xxx_reset_current_bus</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">),</span> <span class="n">SCSISEQ</span><span class="p">);</span>
    <span class="n">aic7xxx_clear_intstat</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_RETURN</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Channel reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">   * Clean up all the state information for the pending transactions</span>
<span class="cm">   * on this bus.</span>
<span class="cm">   */</span>
  <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ALL_TARGETS</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ALL_LUNS</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">restart_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_run_waiting_queues</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Scan the awaiting_scbs queue downloading and starting as many</span>
<span class="cm"> *   scbs as we can.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_run_waiting_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">sent</span><span class="p">;</span>


  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * First handle SCBs that are waiting but have been assigned a slot.</span>
<span class="cm">   */</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">scbq_remove_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span> <span class="o">&gt;=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scbq_insert_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_WAITINGQ</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">aic7xxx_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
        <span class="n">sent</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sent</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">);</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">);</span>
      <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">max_activescbs</span><span class="p">)</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">max_activescbs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="cp">#define  DPE 0x80</span>
<span class="cp">#define  SSE 0x40</span>
<span class="cp">#define  RMA 0x20</span>
<span class="cp">#define  RTA 0x10</span>
<span class="cp">#define  STA 0x08</span>
<span class="cp">#define  DPR 0x01</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_pci_intr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Check the scsi card for PCI errors and clear the interrupt</span>
<span class="cm"> *</span>
<span class="cm"> *   NOTE: If you don&#39;t have this function and a 2940 card encounters</span>
<span class="cm"> *         a PCI error condition, the machine will end up locked as the</span>
<span class="cm"> *         interrupt handler gets slammed with non-stop PCI error interrupts</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_pci_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status1</span><span class="p">;</span>

  <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">DPE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Data Parity Error during PCI address or PCI write&quot;</span>
      <span class="s">&quot;phase.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">SSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Signal System Error Detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">RMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Received a PCI Master Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">RTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Received a PCI Target Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">STA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Signaled a PCI Target Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">DPR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Data Parity Error has been reported via PCI pin &quot;</span>
      <span class="s">&quot;PERR#</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  
  <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">status1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DPR</span><span class="o">|</span><span class="n">RMA</span><span class="o">|</span><span class="n">RTA</span><span class="p">))</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">CLRPARERR</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spurious_int</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_construct_ppr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Build up a Parallel Protocol Request message for use with SCSI-3</span>
<span class="cm"> *   devices.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_construct_ppr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXTENDED</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXT_PPR_LEN</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXT_PPR</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_construct_sdtr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Constucts a synchronous data transfer message in the message</span>
<span class="cm"> *   buffer on the sequencer.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_construct_sdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">period</span><span class="p">,</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXTENDED</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXT_SDTR_LEN</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXT_SDTR</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_construct_wdtr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Constucts a wide data transfer message in the message buffer</span>
<span class="cm"> *   on the sequencer.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_construct_wdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXTENDED</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_LEN</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_width</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_calc_residual</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Calculate the residual data not yet transferred.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_calculate_residual</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic7xxx_hwscb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">cmd</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
  <span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   *  Don&#39;t destroy valid residual information with</span>
<span class="cm">   *  residual coming from a check sense operation.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">DISCONNECTED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     *  We had an underflow. At this time, there&#39;s only</span>
<span class="cm">     *  one other driver that bothers to check for this,</span>
<span class="cm">     *  and cmd-&gt;underflow seems to be set rather half-</span>
<span class="cm">     *  heartedly in the higher-level SCSI code.</span>
<span class="cm">     */</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_SG_segment_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">actual</span> <span class="o">-=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">-</span> <span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">actual</span> <span class="o">-=</span> <span class="p">(</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
              <span class="p">(</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
              <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Underflow - Wanted %u, %s %u, residual SG &quot;</span>
          <span class="s">&quot;count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">,</span>
          <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;wrote&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span>
          <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_SG_segment_count</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;status 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
          <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="cm">/*</span>
<span class="cm">       * In 2.4, only send back the residual information, don&#39;t flag this</span>
<span class="cm">       * as an error.  Before 2.4 we had to flag this as an error because</span>
<span class="cm">       * the mid layer didn&#39;t check residual data counts to see if the</span>
<span class="cm">       * command needs retried.</span>
<span class="cm">       */</span>
      <span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">-</span> <span class="n">actual</span><span class="p">);</span>
      <span class="n">aic7xxx_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Clean out the residual information in the SCB for the</span>
<span class="cm">   * next consumer.</span>
<span class="cm">   */</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_SG_segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_handle_device_reset</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Interrupt handler for sequencer interrupts (SEQINT).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_handle_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tindex</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

  <span class="n">tindex</span> <span class="o">|=</span> <span class="p">((</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Go back to async/narrow transfers and renegotiate.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARG_OFFSET</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>
  <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ALL_LUNS</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Bus Device Reset delivered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
      <span class="n">target</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="cm">/*complete*/</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_handle_seqint</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Interrupt handler for sequencer interrupts (SEQINT).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_handle_seqint</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intstat</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">target_mask</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tindex</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">queue_flag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">channel</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

  <span class="n">target</span> <span class="o">=</span> <span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SAVED_TCL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span> <span class="p">)</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tindex</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">lun</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SAVED_TCL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
  <span class="n">target_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Go ahead and clear the SEQINT now, that avoids any interrupt race</span>
<span class="cm">   * conditions later on in case we enable some other interrupt.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSEQINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SEQINT_MASK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">NO_MATCH</span>:
      <span class="p">{</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">),</span>
                 <span class="n">SCSISEQ</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;No active SCB for reconnecting target - Issuing &quot;</span>
               <span class="s">&quot;BUS DEVICE RESET.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;      SAVED_TCL=0x%x, ARG_1=0x%x, SEQADDR=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
               <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SAVED_TCL</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ARG_1</span><span class="p">),</span>
               <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span>
          <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">SEND_REJECT</span>:
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Rejecting unknown message (0x%x) received from &quot;</span>
            <span class="s">&quot;target, SEQ_FLAGS=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
            <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ACCUM</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">NO_IDENT</span>:
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * The reconnecting target either did not send an identify</span>
<span class="cm">         * message, or did, but we didn&#39;t find an SCB to match and</span>
<span class="cm">         * before it could respond to our ATN/abort, it hit a dataphase.</span>
<span class="cm">         * The only safe thing to do is to blow it away with a bus</span>
<span class="cm">         * reset.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_SEQINT</span> <span class="o">|</span> <span class="n">VERBOSE_RESET_MID</span><span class="p">))</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Target did not send an IDENTIFY message; &quot;</span>
            <span class="s">&quot;LASTPHASE 0x%x, SAVED_TCL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
            <span class="n">lun</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SAVED_TCL</span><span class="p">));</span>

        <span class="n">aic7xxx_reset_channel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="cm">/*initiate reset*/</span> <span class="n">TRUE</span><span class="p">);</span>
        <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>

      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BAD_PHASE</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">P_BUSFREE</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_SEQINT</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Missed busfree.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
            <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
        <span class="n">restart_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_SEQINT</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Unknown scsi bus phase, continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
            <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">EXTENDED_MSG</span>:
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGIN</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Enabling REQINITs for MSG_IN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                 <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
<span class="cp">#endif</span>

       <span class="cm">/*      </span>
<span class="cm">        * To actually receive the message, simply turn on</span>
<span class="cm">        * REQINIT interrupts and let our interrupt handler</span>
<span class="cm">        * do the rest (REQINIT should already be true).</span>
<span class="cm">        */</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ENREQINIT</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>

       <span class="cm">/*</span>
<span class="cm">        * We don&#39;t want the sequencer unpaused yet so we return early</span>
<span class="cm">        */</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="k">case</span> <span class="n">REJECT_MSG</span>:
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * What we care about here is if we had an outstanding SDTR</span>
<span class="cm">         * or WDTR message for this target. If we did, this is a</span>
<span class="cm">         * signal that the target is refusing negotiation.</span>
<span class="cm">         */</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">last_msg</span><span class="p">;</span>

        <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
	<span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
        <span class="n">last_msg</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LAST_MSG</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">last_msg</span> <span class="o">==</span> <span class="n">MSG_IDENTIFYFLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_BITS</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">==</span> <span class="n">MSG_ORDERED_Q_TAG</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * OK...the device seems able to accept tagged commands, but</span>
<span class="cm">             * not ordered tag commands, only simple tag commands.  So, we</span>
<span class="cm">             * disable ordered tag commands and go on with life just like</span>
<span class="cm">             * normal.</span>
<span class="cm">             */</span>
	    <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">,</span>
			    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_Q_TAG</span><span class="p">;</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_TAG_TYPE</span><span class="p">;</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">MSG_SIMPLE_Q_TAG</span><span class="p">;</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
            <span class="cm">/*</span>
<span class="cm">             * OK..we set the tag type to simple tag command, now we re-assert</span>
<span class="cm">             * ATNO and hope this will take us into the identify phase again</span>
<span class="cm">             * so we can resend the tag type and info to the device.</span>
<span class="cm">             */</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_IDENTIFYFLAG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">==</span> <span class="n">MSG_SIMPLE_Q_TAG</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">old_verbose</span><span class="p">;</span>
            <span class="cm">/*</span>
<span class="cm">             * Hmmmm....the device is flaking out on tagged commands.</span>
<span class="cm">             */</span>
	    <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* untagged */</span><span class="p">,</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="cm">/*</span>
<span class="cm">             * We set this command up as a bus device reset.  However, we have</span>
<span class="cm">             * to clear the tag type as it&#39;s causing us problems.  We shouldn&#39;t</span>
<span class="cm">             * have to worry about any other commands being active, since if</span>
<span class="cm">             * the device is refusing tagged commands, this should be the</span>
<span class="cm">             * first tagged command sent to the device, however, we do have</span>
<span class="cm">             * to worry about any other tagged commands that may already be</span>
<span class="cm">             * in the qinfifo.  The easiest way to do this, is to issue a BDR,</span>
<span class="cm">             * send all the commands back to the mid level code, then let them</span>
<span class="cm">             * come back and get rebuilt as untagged commands.</span>
<span class="cm">             */</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TAG_ENB</span> <span class="o">|</span> <span class="n">SCB_TAG_TYPE</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>

            <span class="n">old_verbose</span> <span class="o">=</span> <span class="n">aic7xxx_verbose</span><span class="p">;</span>
            <span class="n">aic7xxx_verbose</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VERBOSE_RESET</span><span class="o">|</span><span class="n">VERBOSE_ABORT</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
              <span class="k">if</span> <span class="p">((</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scbp</span> <span class="o">!=</span> <span class="n">scb</span><span class="p">))</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                <span class="p">{</span>
                  <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
            <span class="n">aic7xxx_verbose</span> <span class="o">=</span> <span class="n">old_verbose</span><span class="p">;</span>
            <span class="cm">/*</span>
<span class="cm">             * Wait until after the for loop to set the busy index since</span>
<span class="cm">             * aic7xxx_reset_device will clear the busy index during its</span>
<span class="cm">             * operation.</span>
<span class="cm">             */</span>
            <span class="n">aic7xxx_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device is refusing tagged commands, using &quot;</span>
              <span class="s">&quot;untagged I/O.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_IDENTIFYFLAG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_PPR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * As per the draft specs, any device capable of supporting any of</span>
<span class="cm">           * the option values other than 0 are not allowed to reject the</span>
<span class="cm">           * PPR message.  Instead, they must negotiate out what they do</span>
<span class="cm">           * support instead of rejecting our offering or else they cause</span>
<span class="cm">           * a parity error during msg_out phase to signal that they don&#39;t</span>
<span class="cm">           * like our settings.</span>
<span class="cm">           */</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
            <span class="p">(</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_QUITE</span><span class="p">),</span> <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_QUITE</span><span class="p">,</span>
			       <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device is rejecting PPR messages, falling &quot;</span>
              <span class="s">&quot;back.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_WDTR</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_WDTR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * note 8bit xfers and clear flag</span>
<span class="cm">           */</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
          <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
            <span class="p">(</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">),</span> <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_QUITE</span><span class="p">,</span>
			       <span class="n">aic_dev</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device is rejecting WDTR messages, using &quot;</span>
              <span class="s">&quot;narrow transfers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">)</span>
        <span class="p">{</span>
         <span class="cm">/*</span>
<span class="cm">          * note asynch xfers and clear flag</span>
<span class="cm">          */</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">(</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">),</span> <span class="n">aic_dev</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device is rejecting SDTR messages, using &quot;</span>
              <span class="s">&quot;async transfers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_SEQINT</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * Otherwise, we ignore it.</span>
<span class="cm">           */</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Received MESSAGE_REJECT for unknown cause.  &quot;</span>
            <span class="s">&quot;Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">BAD_STATUS</span>:
      <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic7xxx_hwscb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* The sequencer will notify us when a command has an error that</span>
<span class="cm">	 * would be of interest to the kernel.  This allows us to leave</span>
<span class="cm">	 * the sequencer running in the common case of command completes</span>
<span class="cm">	 * without error.  The sequencer will have DMA&#39;d the SCB back</span>
<span class="cm">	 * up to us, so we can reference the drivers SCB array.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Set the default return value to 0 indicating not to send</span>
<span class="cm">	 * sense.  The sense code will change this if needed and this</span>
<span class="cm">	 * reduces code duplication.</span>
<span class="cm">	 */</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">);</span>
        <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Invalid SCB during SEQINT 0x%02x, SCB_TAG %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">intstat</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
        <span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Invalid SCB during SEQINT 0x%x, scb %d, flags 0x%x,&quot;</span>
            <span class="s">&quot; cmd 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">intstat</span><span class="p">,</span>
            <span class="n">scb_index</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">cmd</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
          <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TARGET_STATUS</span><span class="p">);</span>
          <span class="n">aic7xxx_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">;</span>

          <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">;</span>

          <span class="k">switch</span> <span class="p">(</span><span class="n">status_byte</span><span class="p">(</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="n">GOOD</span>:
              <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_SEQINT</span><span class="p">)</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Interrupted for status of GOOD???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
              <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">COMMAND_TERMINATED</span>:
            <span class="k">case</span> <span class="n">CHECK_CONDITION</span>:
              <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * Send a sense command to the requesting target.</span>
<span class="cm">                 * XXX - revisit this and get rid of the memcopys.</span>
<span class="cm">                 */</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sense_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">generic_sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="k">sizeof</span><span class="p">(</span><span class="n">generic_sense</span><span class="p">));</span>

                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sense_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sense_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>

                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> 
                  <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
                        <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
                                                   <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
                                                   <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>

                <span class="cm">/*</span>
<span class="cm">                 * XXX - We should allow disconnection, but can&#39;t as it</span>
<span class="cm">                 * might allow overlapped tagged commands.</span>
<span class="cm">                 */</span>
                <span class="cm">/* hscb-&gt;control &amp;= DISCENB; */</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SG_list_pointer</span> <span class="o">=</span> 
		  <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SCB_DMA_ADDR</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">));</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SCSI_cmd_pointer</span> <span class="o">=</span> 
                  <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SCB_DMA_ADDR</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sense_cmd</span><span class="p">));</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">data_count</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">data_pointer</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SCSI_cmd_length</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sense_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_SG_segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_data_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SG_segment_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_SENSE</span><span class="p">;</span>
                <span class="cm">/*</span>
<span class="cm">                 * Ensure the target is busy since this will be an</span>
<span class="cm">                 * an untagged request.</span>
<span class="cm">                 */</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_BITS</span><span class="p">)</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Requesting SENSE with %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                           <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">)</span> <span class="o">?</span>
                           <span class="s">&quot;SDTR&quot;</span> <span class="o">:</span> <span class="s">&quot;WDTR&quot;</span><span class="p">);</span>
                  <span class="k">else</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Requesting SENSE, no MSG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                           <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
                <span class="n">aic7xxx_busy_target</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
                <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEND_SENSE</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">);</span>
                <span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>  <span class="cm">/* first time sense, no errors */</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;CHECK_CONDITION on REQUEST_SENSE, returning &quot;</span>
                     <span class="s">&quot;an error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
              <span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
              <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_SENSE</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">QUEUE_FULL</span>:
              <span class="n">queue_flag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>    <span class="cm">/* Mark that this is a QUEUE_FULL and */</span>
            <span class="k">case</span> <span class="n">BUSY</span>:              <span class="cm">/* drop through to here */</span>
            <span class="p">{</span>
              <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">next_scbp</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_scbp</span><span class="p">;</span>
              <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">active_hscb</span><span class="p">,</span> <span class="n">next_hscb</span><span class="p">,</span> <span class="n">prev_hscb</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">;</span>
              <span class="cm">/*</span>
<span class="cm">               * We have to look three places for queued commands:</span>
<span class="cm">               *  1: p-&gt;waiting_scbs queue</span>
<span class="cm">               *  2: QINFIFO</span>
<span class="cm">               *  3: WAITING_SCBS list on card (for commands that are started</span>
<span class="cm">               *     but haven&#39;t yet made it to the device)</span>
<span class="cm">	       *</span>
<span class="cm">	       * Of special note here is that commands on 2 or 3 above will</span>
<span class="cm">	       * have already been marked as active, while commands on 1 will</span>
<span class="cm">	       * not.  The aic7xxx_done() function will want to unmark them</span>
<span class="cm">	       * from active, so any commands we pull off of 1 need to</span>
<span class="cm">	       * up the active count.</span>
<span class="cm">               */</span>
              <span class="n">next_scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
              <span class="k">while</span> <span class="p">(</span> <span class="n">next_scbp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">prev_scbp</span> <span class="o">=</span> <span class="n">next_scbp</span><span class="p">;</span>
                <span class="n">next_scbp</span> <span class="o">=</span> <span class="n">next_scbp</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev_scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
                     <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">prev_scbp</span><span class="p">);</span>
		  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_QUEUED_FOR_DONE</span> <span class="o">|</span> <span class="n">SCB_QUEUE_FULL</span><span class="p">;</span>
		  <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
		  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="n">aic7xxx_search_qinfifo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
                <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_QUEUED_FOR_DONE</span> <span class="o">|</span> <span class="n">SCB_QUEUE_FULL</span><span class="p">,</span>
	       	<span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
              <span class="n">next_scbp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
              <span class="n">active_hscb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
              <span class="n">prev_hscb</span> <span class="o">=</span> <span class="n">next_hscb</span> <span class="o">=</span> <span class="n">scb_index</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
              <span class="n">next_hscb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
              <span class="k">while</span> <span class="p">(</span><span class="n">next_hscb</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next_hscb</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
                <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">next_scbp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_match_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next_scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
                      <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">)</span>
                  <span class="p">{</span>
		    <span class="n">next_scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_QUEUED_FOR_DONE</span> <span class="o">|</span> <span class="n">SCB_QUEUE_FULL</span><span class="p">;</span>
                    <span class="n">next_hscb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
                    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
                    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
                    <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">prev_hscb</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
                    <span class="p">{</span>
                      <span class="cm">/* We were first on the list,</span>
<span class="cm">                       * so we kill the selection</span>
<span class="cm">                       * hardware.  Let the sequencer</span>
<span class="cm">                       * re-init the hardware itself</span>
<span class="cm">                       */</span>
                      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
                      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
                      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next_hscb</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev_hscb</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
                      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next_hscb</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
                  <span class="k">else</span>
                  <span class="p">{</span>
                    <span class="n">prev_hscb</span> <span class="o">=</span> <span class="n">next_hscb</span><span class="p">;</span>
                    <span class="n">next_hscb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
                  <span class="p">}</span>
                <span class="p">}</span> <span class="cm">/* scb_index &gt;= p-&gt;scb_data-&gt;numscbs */</span>
              <span class="p">}</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">active_hscb</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	      <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
                  
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
              <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span> <span class="o">||</span>
                  <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">queue_flag</span><span class="p">)</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Queue full received; queue depth %d, &quot;</span>
                    <span class="s">&quot;active %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
                    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">);</span>
                <span class="k">else</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Target busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
              <span class="p">}</span>
<span class="cp">#endif</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">queue_flag</span><span class="p">)</span>
              <span class="p">{</span>
		<span class="kt">int</span> <span class="n">diff</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">scsi_track_queue_full</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			       	<span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Tagged Command Queueing disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
		  <span class="n">diff</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">;</span>
		  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Queue depth reduced to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                      <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">result</span><span class="p">);</span>
		  <span class="n">diff</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">-</span> <span class="n">result</span><span class="p">;</span>
		  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		  <span class="cm">/* temp_q_depth could have been dropped to 1 for an untagged</span>
<span class="cm">		   * command that might be coming up */</span>
		  <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">&gt;</span> <span class="n">result</span><span class="p">)</span>
		    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* We should free up the no unused SCB entries.  But, that&#39;s</span>
<span class="cm">		 * a difficult thing to do because we use a direct indexed</span>
<span class="cm">		 * array, so we can&#39;t just take any entries and free them,</span>
<span class="cm">		 * we *have* to free the ones at the end of the array, and</span>
<span class="cm">		 * they very well could be in use right now, which means</span>
<span class="cm">		 * in order to do this right, we have to add a delayed</span>
<span class="cm">		 * freeing mechanism tied into the scb_free() code area.</span>
<span class="cm">		 * We&#39;ll add that later.</span>
<span class="cm">		 */</span>
	      <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="nl">default:</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_SEQINT</span><span class="p">)</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Unexpected target status 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                     <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
              <span class="p">{</span>
                <span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_RETRY_COMMAND</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>  <span class="cm">/* end switch */</span>
        <span class="p">}</span>  <span class="cm">/* end else of */</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">AWAITING_MSG</span>:
      <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">msg_out</span><span class="p">;</span>

        <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
        <span class="n">msg_out</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
	<span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="cm">/*</span>
<span class="cm">         * This SCB had a MK_MESSAGE set in its control byte informing</span>
<span class="cm">         * the sequencer that we wanted to send a special message to</span>
<span class="cm">         * this target.</span>
<span class="cm">         */</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_DEVICE_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span><span class="n">msg_out</span> <span class="o">==</span> <span class="n">MSG_IDENTIFYFLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_DEVICE_RESET</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_BUS_DEV_RESET</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="o">++</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Bus device reset mailed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ABORT</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_ABORT_TAG</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_ABORT</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="o">++</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Abort message mailed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
              <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_PPR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Sending PPR (%d/%d/%d/%d) message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
                   <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span><span class="p">,</span>
                   <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
                   <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
                   <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">aic7xxx_construct_ppr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_WDTR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Sending WDTR message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                   <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="n">aic7xxx_construct_wdtr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_sync</span><span class="p">,</span> <span class="n">period</span><span class="p">;</span>
          <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="cm">/*</span>
<span class="cm">           * Now that the device is selected, use the bits in SBLKCTL and</span>
<span class="cm">           * SSTAT2 to determine the max sync rate for this device.</span>
<span class="cm">           */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENAB40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXP_ACTIVE</span><span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="n">max_sync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">max_sync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">max_sync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">max_sync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">period</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
          <span class="n">aic7xxx_find_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">period</span><span class="p">,</span> <span class="n">max_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Sending SDTR %d/%d message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                   <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">period</span><span class="p">,</span>
                   <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">aic7xxx_construct_sdtr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> 
        <span class="p">{</span>
          <span class="n">panic</span><span class="p">(</span><span class="s">&quot;aic7xxx: AWAITING_MSG for an SCB that does &quot;</span>
                <span class="s">&quot;not have a waiting message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">         * We&#39;ve set everything up to send our message, now to actually do</span>
<span class="cm">         * so we need to enable reqinit interrupts and let the interrupt</span>
<span class="cm">         * handler do the rest.  We don&#39;t want to unpause the sequencer yet</span>
<span class="cm">         * though so we&#39;ll return early.  We also have to make sure that</span>
<span class="cm">         * we clear the SEQINT *BEFORE* we set the REQINIT handler active</span>
<span class="cm">         * or else it&#39;s possible on VLB cards to lose the first REQINIT</span>
<span class="cm">         * interrupt.  Edge triggered EISA cards could also lose this</span>
<span class="cm">         * interrupt, although PCI and level triggered cards should not</span>
<span class="cm">         * have this problem since they continually interrupt the kernel</span>
<span class="cm">         * until we take care of the situation.</span>
<span class="cm">         */</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_SENT</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ENREQINIT</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">DATA_OVERRUN</span>:
      <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lastphase</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">]);</span>
        <span class="cm">/*</span>
<span class="cm">         * XXX - What do we really want to do on an overrun?  The</span>
<span class="cm">         *       mid-level SCSI code should handle this, but for now,</span>
<span class="cm">         *       we&#39;ll just indicate that the command should retried.</span>
<span class="cm">         *    If we retrieved sense info on this target, then the </span>
<span class="cm">         *    base SENSE info should have been saved prior to the</span>
<span class="cm">         *    overrun error.  In that case, we return DID_OK and let</span>
<span class="cm">         *    the mid level code pick up on the sense info.  Otherwise</span>
<span class="cm">         *    we return DID_ERROR so the command will get retried.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Data overrun detected in %s phase, tag %d;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_DATAIN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Data-In&quot;</span> <span class="o">:</span> <span class="s">&quot;Data-Out&quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;  %s seen Data Phase. Length=%d, NumSGs=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPHASE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Have&quot;</span> <span class="o">:</span> <span class="s">&quot;Haven&#39;t&quot;</span><span class="p">,</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;  Raw SCSI Command: 0x&quot;</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SCSI_cmd_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;     sg[%d] - Addr 0x%x : Length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">,</span> 
                 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">),</span>
                 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Data Overrun during SEND_SENSE operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">WIDE_RESIDUE</span>:
      <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">resid_sgcnt</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_addr</span><span class="p">,</span> <span class="n">resid_dcnt</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">native_addr</span><span class="p">,</span> <span class="n">native_length</span><span class="p">,</span> <span class="n">sg_addr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;invalid scb_index during WIDE_RESIDUE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
          <span class="cm">/*</span>
<span class="cm">           * XXX: Add error handling here</span>
<span class="cm">           */</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;invalid scb during WIDE_RESIDUE flags:0x%x &quot;</span>
                 <span class="s">&quot;scb-&gt;cmd:0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
                 <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Got WIDE_RESIDUE message, patching up data &quot;</span>
                 <span class="s">&quot;pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>

        <span class="cm">/*</span>
<span class="cm">         * We have a valid scb to use on this WIDE_RESIDUE message, so</span>
<span class="cm">         * we need to walk the sg list looking for this particular sg</span>
<span class="cm">         * segment, then see if we happen to be at the very beginning of</span>
<span class="cm">         * the segment.  If we are, then we have to back things up to</span>
<span class="cm">         * the previous segment.  If not, then we simply need to remove</span>
<span class="cm">         * one byte from this segments address and add one to the byte</span>
<span class="cm">         * count.</span>
<span class="cm">         */</span>
        <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SHADDR</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SHADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
          <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SHADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SHADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
        <span class="n">sg_addr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
          <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
        <span class="n">resid_sgcnt</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_RESID_SGCNT</span><span class="p">);</span>
        <span class="n">resid_dcnt</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_RESID_DCNT</span><span class="p">)</span> <span class="o">|</span>
          <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_RESID_DCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
          <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_RESID_DCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">-</span> <span class="p">((</span><span class="n">resid_sgcnt</span><span class="p">)</span> <span class="o">?</span> <span class="n">resid_sgcnt</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">native_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
        <span class="n">native_length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * If resid_dcnt == native_length, then we just loaded this SG</span>
<span class="cm">         * segment and we need to back it up one...</span>
<span class="cm">         */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">resid_dcnt</span> <span class="o">==</span> <span class="n">native_length</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * Oops, this isn&#39;t right, we can&#39;t back up to before the</span>
<span class="cm">             * beginning.  This must be a bogus message, ignore it.</span>
<span class="cm">             */</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">resid_dcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">resid_sgcnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">native_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
          <span class="n">native_length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
          <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">native_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">native_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">sg_addr</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_scatterlist</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * resid_dcnt != native_length, so we are in the middle of a SG</span>
<span class="cm">           * element.  Back it up one byte and leave the rest alone.</span>
<span class="cm">           */</span>
          <span class="n">resid_dcnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">cur_addr</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/*</span>
<span class="cm">         * Output the new addresses and counts to the right places on the</span>
<span class="cm">         * card.</span>
<span class="cm">         */</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resid_sgcnt</span><span class="p">,</span> <span class="n">SG_COUNT</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resid_sgcnt</span><span class="p">,</span> <span class="n">SCB_RESID_SGCNT</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sg_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SG_COUNT</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resid_dcnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SCB_RESID_DCNT</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">resid_dcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SCB_RESID_DCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">resid_dcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SCB_RESID_DCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * The sequencer actually wants to find the new address</span>
<span class="cm">         * in the SHADDR register set.  On the Ultra2 and later controllers</span>
<span class="cm">         * this register set is readonly.  In order to get the right number</span>
<span class="cm">         * into the register, you actually have to enter it in HADDR and then</span>
<span class="cm">         * use the PRELOADEN bit of DFCNTRL to drop it through from the</span>
<span class="cm">         * HADDR register to the SHADDR register.  On non-Ultra2 controllers,</span>
<span class="cm">         * we simply write it direct.</span>
<span class="cm">         */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * We might as well be accurate and drop both the resid_dcnt and</span>
<span class="cm">           * cur_addr into HCNT and HADDR and have both of them drop</span>
<span class="cm">           * through to the shadow layer together.</span>
<span class="cm">           */</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resid_dcnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HCNT</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">resid_dcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">resid_dcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cur_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DMAPARAMS</span><span class="p">)</span> <span class="o">|</span> <span class="n">PRELOADEN</span><span class="p">,</span> <span class="n">DFCNTRL</span><span class="p">);</span>
          <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DMAPARAMS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SCSIEN</span><span class="o">|</span><span class="n">HDMAEN</span><span class="p">),</span> <span class="n">DFCNTRL</span><span class="p">);</span>
          <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
          <span class="k">while</span><span class="p">(((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DFCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSIEN</span><span class="o">|</span><span class="n">HDMAEN</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cur_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SHADDR</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SHADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SHADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">SHADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">SEQ_SG_FIXUP</span>:
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">sg_addr</span><span class="p">,</span> <span class="n">sg_length</span><span class="p">;</span>

      <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;invalid scb_index during SEQ_SG_FIXUP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCSISIGI 0x%x, SEQADDR 0x%x, SSTAT0 0x%x, SSTAT1 &quot;</span>
           <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">));</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SG_CACHEPTR 0x%x, SSTAT2 0x%x, STCNT 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_CACHEPTR</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span><span class="p">));</span>
        <span class="cm">/*</span>
<span class="cm">         * XXX: Add error handling here</span>
<span class="cm">         */</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;invalid scb during SEQ_SG_FIXUP flags:0x%x &quot;</span>
               <span class="s">&quot;scb-&gt;cmd:0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
               <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCSISIGI 0x%x, SEQADDR 0x%x, SSTAT0 0x%x, SSTAT1 &quot;</span>
           <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">));</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SG_CACHEPTR 0x%x, SSTAT2 0x%x, STCNT 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_CACHEPTR</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_MINOR_ERROR</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Fixing up SG address for sequencer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
               <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="cm">/*</span>
<span class="cm">       * Advance the SG pointer to the next element in the list</span>
<span class="cm">       */</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_NEXT</span><span class="p">);</span>
      <span class="n">tmp</span> <span class="o">+=</span> <span class="n">SG_SIZEOF</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SG_NEXT</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">SG_SIZEOF</span> <span class="p">)</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_NEXT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SG_NEXT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">SG_COUNT</span><span class="p">);</span>
      <span class="n">sg_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
      <span class="n">sg_length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
      <span class="cm">/*</span>
<span class="cm">       * Now stuff the element we just advanced past down onto the</span>
<span class="cm">       * card so it can be stored in the residual area.</span>
<span class="cm">       */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sg_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sg_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HCNT</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_length</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">LAST_SEG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">SG_CACHEPTR</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DMAPARAMS</span><span class="p">),</span> <span class="n">DFCNTRL</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDONE</span><span class="p">)</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DFCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDMAEN</span><span class="o">|</span><span class="n">SCSIEN</span><span class="p">))</span> <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DFCNTRL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef AIC7XXX_NOT_YET </span>
    <span class="k">case</span> <span class="n">TRACEPOINT2</span>:
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Tracepoint #2 reached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
               <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="cm">/* XXX Fill these in later */</span>
    <span class="k">case</span> <span class="n">MSG_BUFFER_BUSY</span>:
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Message buffer busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MSGIN_PHASEMIS</span>:
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Message-in phasemis.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="nl">default:</span>                   <span class="cm">/* unknown */</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Unknown SEQINT, INTSTAT 0x%x, SCSISIGI 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">intstat</span><span class="p">,</span>
             <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Clear the sequencer interrupt and unpause the sequencer.</span>
<span class="cm">   */</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="cm">/* unpause always */</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_parse_msg</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Parses incoming messages into actions on behalf of</span>
<span class="cm"> *   aic7xxx_handle_reqinit</span>
<span class="cm"> *_F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_parse_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">reject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">done</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target_scsirate</span><span class="p">,</span> <span class="n">tindex</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">target_mask</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">trans_options</span><span class="p">,</span> <span class="n">new_trans_options</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="n">new_period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="n">target</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
  <span class="n">channel</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
  <span class="n">lun</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
  <span class="n">reply</span> <span class="o">=</span> <span class="n">reject</span> <span class="o">=</span> <span class="n">done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">tindex</span> <span class="o">=</span> <span class="n">TARGET_INDEX</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
  <span class="n">target_scsirate</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">tindex</span><span class="p">);</span>
  <span class="n">target_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Parse as much of the message as is available,</span>
<span class="cm">   * rejecting it if we don&#39;t support it.  When</span>
<span class="cm">   * the entire message is available and has been</span>
<span class="cm">   * handled, return TRUE indicating that we have</span>
<span class="cm">   * parsed an entire message.</span>
<span class="cm">   */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXTENDED</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Even if we are an Ultra3 card, don&#39;t allow Ultra3 sync rates when</span>
<span class="cm">   * using the SDTR messages.  We need the PPR messages to enable the</span>
<span class="cm">   * higher speeds that include things like Dual Edge clocking.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENAB40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="o">!</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXP_ACTIVE</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA3</span><span class="p">)</span>
        <span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA3</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Just accept the length byte outright and perform</span>
<span class="cm">   * more checking once we know the message type.</span>
<span class="cm">   */</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">reject</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="n">MSG_EXT_SDTR</span>:
      <span class="p">{</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXT_SDTR_LEN</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSG_EXT_SDTR_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">period</span> <span class="o">=</span> <span class="n">new_period</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">new_offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="n">trans_options</span> <span class="o">=</span> <span class="n">new_trans_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">bus_width</span> <span class="o">=</span> <span class="n">new_bus_width</span> <span class="o">=</span> <span class="n">target_scsirate</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * If our current max syncrate is in the Ultra3 range, bump it back</span>
<span class="cm">         * down to Ultra2 since we can&#39;t negotiate DT transfers using SDTR</span>
<span class="cm">         */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">maxsync</span> <span class="o">==</span> <span class="n">AHC_SYNCRATE_ULTRA3</span><span class="p">)</span>
          <span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * We might have a device that is starting negotiation with us</span>
<span class="cm">         * before we can start up negotiation with it....be prepared to</span>
<span class="cm">         * have a device ask for a higher speed then we want to give it</span>
<span class="cm">         * in that case</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCB_MSGOUT_SENT</span><span class="o">|</span><span class="n">SCB_MSGOUT_SDTR</span><span class="p">))</span> <span class="o">!=</span>
             <span class="p">(</span><span class="n">SCB_MSGOUT_SENT</span><span class="o">|</span><span class="n">SCB_MSGOUT_SDTR</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_DTR_SCANNED</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * We shouldn&#39;t get here unless this is a narrow drive, wide</span>
<span class="cm">             * devices should trigger this same section of code in the WDTR</span>
<span class="cm">             * handler first instead.</span>
<span class="cm">             */</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">period</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_DTR_SCANNED</span> <span class="o">|</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * This is a preemptive message from the target, we&#39;ve already</span>
<span class="cm">             * scanned this target and set our options for it, and we</span>
<span class="cm">             * don&#39;t need a SDTR with this target (for whatever reason),</span>
<span class="cm">             * so reject this incoming SDTR</span>
<span class="cm">             */</span>
            <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="cm">/* The device is sending this message first and we have to reply */</span>
          <span class="n">reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Received pre-emptive SDTR message from &quot;</span>
                   <span class="s">&quot;target.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="cm">/*</span>
<span class="cm">           * Validate the values the device passed to us against our SEEPROM</span>
<span class="cm">           * settings.  We don&#39;t have to do this if we aren&#39;t replying since</span>
<span class="cm">           * the device isn&#39;t allowed to send values greater than the ones</span>
<span class="cm">           * we first sent to it.</span>
<span class="cm">           */</span>
          <span class="n">new_period</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span><span class="p">);</span>
          <span class="n">new_offset</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="cm">/*</span>
<span class="cm">         * Use our new_period, new_offset, bus_width, and card options</span>
<span class="cm">         * to determine the actual syncrate settings</span>
<span class="cm">         */</span>
        <span class="n">syncrate</span> <span class="o">=</span> <span class="n">aic7xxx_find_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_period</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">,</span>
                                         <span class="o">&amp;</span><span class="n">trans_options</span><span class="p">);</span>
        <span class="n">aic7xxx_validate_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * Did we drop to async?  If so, send a reply regardless of whether</span>
<span class="cm">         * or not we initiated this negotiation.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">new_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/*</span>
<span class="cm">         * Did we start this, if not, or if we went too low and had to</span>
<span class="cm">         * go async, then send an SDTR back to the target</span>
<span class="cm">         */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* when sending a reply, make sure that the goal settings are</span>
<span class="cm">           * updated along with current and active since the code that</span>
<span class="cm">           * will actually build the message for the sequencer uses the</span>
<span class="cm">           * goal settings as its guidelines.</span>
<span class="cm">           */</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">new_period</span><span class="p">,</span>
                               <span class="n">new_offset</span><span class="p">,</span> <span class="n">trans_options</span><span class="p">,</span>
                               <span class="n">AHC_TRANS_GOAL</span><span class="o">|</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span>
			       <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">;</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">new_period</span><span class="p">,</span>
                               <span class="n">new_offset</span><span class="p">,</span> <span class="n">trans_options</span><span class="p">,</span>
                               <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">MSG_EXT_WDTR</span>:
      <span class="p">{</span>
          
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXT_WDTR_LEN</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSG_EXT_WDTR_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">bus_width</span> <span class="o">=</span> <span class="n">new_bus_width</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCB_MSGOUT_SENT</span><span class="o">|</span><span class="n">SCB_MSGOUT_WDTR</span><span class="p">))</span> <span class="o">==</span>
             <span class="p">(</span><span class="n">SCB_MSGOUT_SENT</span><span class="o">|</span><span class="n">SCB_MSGOUT_WDTR</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">switch</span><span class="p">(</span><span class="n">bus_width</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="nl">default:</span>
            <span class="p">{</span>
              <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">((</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Requesting %d bit transfers, rejecting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">bus_width</span><span class="p">));</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="cm">/* We fall through on purpose */</span>
            <span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span>:
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">target_mask</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span>:
            <span class="p">{</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">,</span>
                            <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="n">aic_dev</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_DTR_SCANNED</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/* </span>
<span class="cm">             * Well, we now know the WDTR and SYNC caps of this device since</span>
<span class="cm">             * it contacted us first, mark it as such and copy the user stuff</span>
<span class="cm">             * over to the goal stuff.</span>
<span class="cm">             */</span>
            <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">width</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="cm">/*</span>
<span class="cm">             * Devices that support DT transfers don&#39;t start WDTR requests</span>
<span class="cm">             */</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">period</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_16BIT</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_DTR_SCANNED</span> <span class="o">|</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * This is a preemptive message from the target, we&#39;ve already</span>
<span class="cm">             * scanned this target and set our options for it, and we</span>
<span class="cm">             * don&#39;t need a WDTR with this target (for whatever reason),</span>
<span class="cm">             * so reject this incoming WDTR</span>
<span class="cm">             */</span>
            <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="cm">/* The device is sending this message first and we have to reply */</span>
          <span class="n">reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Received pre-emptive WDTR message from &quot;</span>
                   <span class="s">&quot;target.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">switch</span><span class="p">(</span><span class="n">bus_width</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span>:
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">new_bus_width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="cm">/* Fall through if we aren&#39;t a wide card */</span>
            <span class="nl">default:</span>
            <span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span>:
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="n">new_bus_width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_WDTR</span><span class="p">;</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/* there is no other command with SCB_DTR_SCB already set that will</span>
<span class="cm">             * trigger the release of the dtr_pending bit.  Both set the bit</span>
<span class="cm">             * and set scb-&gt;flags |= SCB_DTR_SCB</span>
<span class="cm">             */</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_DTR_SCB</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
          <span class="cm">/* when sending a reply, make sure that the goal settings are</span>
<span class="cm">           * updated along with current and active since the code that</span>
<span class="cm">           * will actually build the message for the sequencer uses the</span>
<span class="cm">           * goal settings as its guidelines.</span>
<span class="cm">           */</span>
          <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">,</span>
                          <span class="n">AHC_TRANS_GOAL</span><span class="o">|</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span>
			  <span class="n">aic_dev</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="cm">/*</span>
<span class="cm">         * By virtue of the SCSI spec, a WDTR message negates any existing</span>
<span class="cm">         * SDTR negotiations.  So, even if needsdtr isn&#39;t marked for this</span>
<span class="cm">         * device, we still have to do a new SDTR message if the device</span>
<span class="cm">         * supports SDTR at all.  Therefore, we check needsdtr_copy instead</span>
<span class="cm">         * of needstr.</span>
<span class="cm">         */</span>
        <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_QUITE</span><span class="p">,</span>
			     <span class="n">aic_dev</span><span class="p">);</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span><span class="p">;</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">MSG_EXT_PPR</span>:
      <span class="p">{</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXT_PPR_LEN</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSG_EXT_PPR_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">period</span> <span class="o">=</span> <span class="n">new_period</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">new_offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
        <span class="n">bus_width</span> <span class="o">=</span> <span class="n">new_bus_width</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="n">trans_options</span> <span class="o">=</span> <span class="n">new_trans_options</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Parsing PPR message (%d/%d/%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span>
                 <span class="n">trans_options</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">         * We might have a device that is starting negotiation with us</span>
<span class="cm">         * before we can start up negotiation with it....be prepared to</span>
<span class="cm">         * have a device ask for a higher speed then we want to give it</span>
<span class="cm">         * in that case</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCB_MSGOUT_SENT</span><span class="o">|</span><span class="n">SCB_MSGOUT_PPR</span><span class="p">))</span> <span class="o">!=</span>
             <span class="p">(</span><span class="n">SCB_MSGOUT_SENT</span><span class="o">|</span><span class="n">SCB_MSGOUT_PPR</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span> 
          <span class="cm">/* Have we scanned the device yet? */</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_DTR_SCANNED</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="cm">/* The device is electing to use PPR messages, so we will too until</span>
<span class="cm">             * we know better */</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          
            <span class="cm">/* We know the device is SCSI-3 compliant due to PPR */</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_SCSI_3</span><span class="p">;</span>
          
            <span class="cm">/*</span>
<span class="cm">             * Not only is the device starting this up, but it also hasn&#39;t</span>
<span class="cm">             * been scanned yet, so this would likely be our TUR or our</span>
<span class="cm">             * INQUIRY command at scan time, so we need to use the</span>
<span class="cm">             * settings from the SEEPROM if they existed.  Of course, even</span>
<span class="cm">             * if we didn&#39;t find a SEEPROM, we stuffed default values into</span>
<span class="cm">             * the user settings anyway, so use those in all cases.</span>
<span class="cm">             */</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">period</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">options</span><span class="p">;</span>
              <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                       <span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_16BIT</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_DTR_SCANNED</span> <span class="o">|</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * This is a preemptive message from the target, we&#39;ve already</span>
<span class="cm">             * scanned this target and set our options for it, and we</span>
<span class="cm">             * don&#39;t need a PPR with this target (for whatever reason),</span>
<span class="cm">             * so reject this incoming PPR</span>
<span class="cm">             */</span>
            <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="cm">/* The device is sending this message first and we have to reply */</span>
          <span class="n">reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Received pre-emptive PPR message from &quot;</span>
                   <span class="s">&quot;target.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="p">}</span>

        <span class="p">}</span>

        <span class="k">switch</span><span class="p">(</span><span class="n">bus_width</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span>:
          <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nl">default:</span>
          <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">((</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">)</span> <span class="o">||</span>
                  <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="n">reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Requesting %d bit transfers, rejecting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">bus_width</span><span class="p">));</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="cm">/* We fall through on purpose */</span>
          <span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span>:
          <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * According to the spec, if we aren&#39;t wide, we also can&#39;t be</span>
<span class="cm">             * Dual Edge so clear the options byte</span>
<span class="cm">             */</span>
            <span class="n">new_trans_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">new_bus_width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* when sending a reply, make sure that the goal settings are</span>
<span class="cm">           * updated along with current and active since the code that</span>
<span class="cm">           * will actually build the message for the sequencer uses the</span>
<span class="cm">           * goal settings as its guidelines.</span>
<span class="cm">           */</span>
          <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">,</span>
                            <span class="n">AHC_TRANS_GOAL</span><span class="o">|</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span>
			    <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">syncrate</span> <span class="o">=</span> <span class="n">aic7xxx_find_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_period</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">new_trans_options</span><span class="p">);</span>
          <span class="n">aic7xxx_validate_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">);</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">new_period</span><span class="p">,</span>
                               <span class="n">new_offset</span><span class="p">,</span> <span class="n">new_trans_options</span><span class="p">,</span>
                               <span class="n">AHC_TRANS_GOAL</span><span class="o">|</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span>
			       <span class="n">aic_dev</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">,</span>
                            <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="n">aic_dev</span><span class="p">);</span>
          <span class="n">syncrate</span> <span class="o">=</span> <span class="n">aic7xxx_find_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_period</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">new_trans_options</span><span class="p">);</span>
          <span class="n">aic7xxx_validate_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">new_bus_width</span><span class="p">);</span>
          <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">new_period</span><span class="p">,</span>
                               <span class="n">new_offset</span><span class="p">,</span> <span class="n">new_trans_options</span><span class="p">,</span>
                               <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="n">aic_dev</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">         * As it turns out, if we don&#39;t *have* to have PPR messages, then</span>
<span class="cm">         * configure ourselves not to use them since that makes some</span>
<span class="cm">         * external drive chassis work (those chassis can&#39;t parse PPR</span>
<span class="cm">         * messages and they mangle the SCSI bus until you send a WDTR</span>
<span class="cm">         * and SDTR that they can understand).</span>
<span class="cm">         */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">new_trans_options</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="n">new_offset</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">new_bus_width</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">((</span><span class="n">new_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * Oops, the syncrate went to low for this card and we fell off</span>
<span class="cm">           * to async (should never happen with a device that uses PPR</span>
<span class="cm">           * messages, but have to be complete)</span>
<span class="cm">           */</span>
          <span class="n">reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
          <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_PPR</span><span class="p">;</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nl">default:</span>
      <span class="p">{</span>
        <span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="cm">/* end of switch(p-&gt;msg_type) */</span>
  <span class="p">}</span> <span class="cm">/* end of if (!reject &amp;&amp; (p-&gt;msg_len &gt; 2)) */</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">&amp;&amp;</span> <span class="n">reject</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_MESSAGE_REJECT</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_handle_reqinit</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Interrupt handler for REQINIT interrupts (used to transfer messages to</span>
<span class="cm"> *    and from devices).</span>
<span class="cm"> *_F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_handle_reqinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lastbyte</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phasemis</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span>:
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="n">panic</span><span class="p">(</span><span class="s">&quot;aic7xxx: REQINIT with no active message!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="n">lastbyte</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
        <span class="n">phasemis</span> <span class="o">=</span> <span class="p">(</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">P_MESGOUT</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">lastbyte</span> <span class="o">||</span> <span class="n">phasemis</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* Time to end the message */</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_NONE</span><span class="p">;</span>
          <span class="cm">/*</span>
<span class="cm">           * NOTE-TO-MYSELF: If you clear the REQINIT after you</span>
<span class="cm">           * disable REQINITs, then cases of REJECT_MSG stop working</span>
<span class="cm">           * and hang the bus</span>
<span class="cm">           */</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENREQINIT</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">phasemis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="p">],</span> <span class="n">SINDEX</span><span class="p">);</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">);</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Completed sending of REQINIT message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
<span class="cp">#endif</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSGOUT_PHASEMIS</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">);</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;PHASEMIS while sending REQINIT message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
<span class="cp">#endif</span>
          <span class="p">}</span>
          <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="cm">/*</span>
<span class="cm">           * Present the byte on the bus (clearing REQINIT) but don&#39;t</span>
<span class="cm">           * unpause the sequencer.</span>
<span class="cm">           */</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRREQINIT</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">],</span> <span class="n">SCSIDATL</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="n">MSG_TYPE_INITIATOR_MSGIN</span>:
      <span class="p">{</span>
        <span class="n">phasemis</span> <span class="o">=</span> <span class="p">(</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">P_MESGIN</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">phasemis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="o">++</span><span class="p">;</span>
          <span class="cm">/* Pull the byte in without acking it */</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSIBUSL</span><span class="p">);</span>
          <span class="n">done</span> <span class="o">=</span> <span class="n">aic7xxx_parse_msg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
          <span class="cm">/* Ack the byte */</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRREQINIT</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
          <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">);</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">phasemis</span> <span class="o">||</span> <span class="n">done</span><span class="p">)</span>
        <span class="p">{</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">phasemis</span><span class="p">)</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;PHASEMIS while receiving REQINIT message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
            <span class="k">else</span>
              <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Completed receipt of REQINIT message.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
          <span class="p">}</span>
<span class="cp">#endif</span>
          <span class="cm">/* Time to end our message session */</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_NONE</span><span class="p">;</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENREQINIT</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
          <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="nl">default:</span>
      <span class="p">{</span>
        <span class="n">panic</span><span class="p">(</span><span class="s">&quot;aic7xxx: Unknown REQINIT message type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span> <span class="cm">/* End of switch(p-&gt;msg_type) */</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_handle_scsiint</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Interrupt handler for SCSI interrupts (SCSIINT).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_handle_scsiint</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intstat</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span> <span class="p">)</span>
      <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Someone else reset the channel!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span>
      <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Go through and abort all commands for the channel, but do not</span>
<span class="cm">     * reset the channel again.</span>
<span class="cm">     */</span>
    <span class="n">aic7xxx_reset_channel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="cm">/* Initiate Reset */</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * First look at what phase we were last in.  If it&#39;s message-out,</span>
<span class="cm">     * chances are pretty good that the bus free was in response to</span>
<span class="cm">     * one of our abort requests.</span>
<span class="cm">     */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lastphase</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_tcl</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SAVED_TCL</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">saved_tcl</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">printerror</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span> <span class="p">)</span>
      <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">),</span>
             <span class="n">SCSISEQ</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">;</span>

      <span class="n">message</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SINDEX</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">message</span> <span class="o">==</span> <span class="n">MSG_ABORT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">MSG_ABORT_TAG</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCB %d abort delivered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
            <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
        <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ALL_LUNS</span><span class="p">,</span>
                <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">MSG_ABORT</span><span class="p">)</span> <span class="o">?</span> <span class="n">SCB_LIST_NULL</span> <span class="o">:</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="p">);</span>
        <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">MSG_BUS_DEV_RESET</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic7xxx_handle_device_reset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_DTR_SCB</span><span class="p">)</span> <span class="p">)</span> 
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Hmmm...error during a negotiation command.  Either we have a</span>
<span class="cm">       * borken bus, or the device doesn&#39;t like our negotiation message.</span>
<span class="cm">       * Since we check the INQUIRY data of a device before sending it</span>
<span class="cm">       * negotiation messages, assume the bus is borken for whatever</span>
<span class="cm">       * reason.  Complete the command.</span>
<span class="cm">       */</span>
      <span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ALL_LUNS</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
      <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">printerror</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tag</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">tag</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">tag</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ALL_LUNS</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
        <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ALL_LUNS</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
        <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Unexpected busfree, LASTPHASE = 0x%x, &quot;</span>
             <span class="s">&quot;SEQADDR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lastphase</span><span class="p">,</span>
             <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">));</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ENBUSFREE</span><span class="o">|</span><span class="n">ENREQINIT</span><span class="p">),</span>
      <span class="n">SIMODE1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRBUSFREE</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
    <span class="n">restart_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scbptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nextscb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

    <span class="n">scbptr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scbptr</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * I&#39;m still trying to track down exactly how this happens, but until</span>
<span class="cm">       * I find it, this code will make sure we aren&#39;t passing bogus values</span>
<span class="cm">       * into the SCBPTR register, even if that register will just wrap</span>
<span class="cm">       * things around, we still don&#39;t like having out of range variables.</span>
<span class="cm">       *</span>
<span class="cm">       * NOTE: Don&#39;t check the aic7xxx_verbose variable, I want this message</span>
<span class="cm">       * to always be displayed.</span>
<span class="cm">       */</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Invalid WAITING_SCBH value %d, improvising.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scbptr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">scbptr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">scbptr</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">scb_index</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>

    <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Referenced SCB %d not valid during SELTO.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;        SCSISEQ = 0x%x SEQADDR = 0x%x SSTAT0 = 0x%x &quot;</span>
             <span class="s">&quot;SSTAT1 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">),</span>
             <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
             <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span>
        <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">cmd</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

      <span class="cm">/*</span>
<span class="cm">       * Clear out this hardware SCB</span>
<span class="cm">       */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>

      <span class="cm">/*</span>
<span class="cm">       * Clear out a few values in the card that are in an undetermined</span>
<span class="cm">       * state.</span>
<span class="cm">       */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>

      <span class="cm">/*</span>
<span class="cm">       * Shift the waiting for selection queue forward</span>
<span class="cm">       */</span>
      <span class="n">nextscb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nextscb</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>

      <span class="cm">/*</span>
<span class="cm">       * Put this SCB back on the free list.</span>
<span class="cm">       */</span>
      <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Selection Timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
<span class="cp">#endif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_QUEUED_ABORT</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * We know that this particular SCB had to be the queued abort since</span>
<span class="cm">         * the disconnected SCB would have gotten a reconnect instead.</span>
<span class="cm">         * What we need to do then is to let the command timeout again so</span>
<span class="cm">         * we get a reset since this abort just failed.</span>
<span class="cm">         */</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * Keep the sequencer from trying to restart any selections</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Make sure the data bits on the bus are released</span>
<span class="cm">     * Don&#39;t do this on 7770 chipsets, it makes them give us</span>
<span class="cm">     * a BRKADDRINT and kills the card.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_PCI</span> <span class="p">)</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSIBUSL</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Delay for the selection timeout delay period then stop the selection</span>
<span class="cm">     */</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">301</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELINGO</span><span class="p">,</span> <span class="n">CLRSINT0</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Clear out all the interrupt status bits</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ENREQINIT</span><span class="o">|</span><span class="n">ENBUSFREE</span><span class="p">),</span> <span class="n">SIMODE1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span> <span class="o">|</span> <span class="n">CLRBUSFREE</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">     * Restarting the sequencer will stop the selection and make sure devices</span>
<span class="cm">     * are allowed to reselect in.</span>
<span class="cm">     */</span>
    <span class="n">restart_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;aic7xxx_isr - referenced scb not valid &quot;</span>
           <span class="s">&quot;during scsiint 0x%x scb(%d)</span><span class="se">\n</span><span class="s">&quot;</span>
           <span class="s">&quot;      SIMODE0 0x%x, SIMODE1 0x%x, SSTAT0 0x%x, SEQADDR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">),</span>
           <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span>
           <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">));</span>
    <span class="cm">/*</span>
<span class="cm">     * Turn off the interrupt and set status to zero, so that it</span>
<span class="cm">     * falls through the rest of the SCSIINT code.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="cm">/* unpause always */</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Determine the bus phase and queue an appropriate message.</span>
<span class="cm">     */</span>
	<span class="kt">char</span>  <span class="o">*</span><span class="n">phase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mesg_out</span> <span class="o">=</span> <span class="n">MSG_NOOP</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lastphase</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sstat2</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">);</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">lastphase</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="n">P_DATAOUT</span>:
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;Data-Out&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_DATAIN</span>:
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;Data-In&quot;</span><span class="p">;</span>
        <span class="n">mesg_out</span> <span class="o">=</span> <span class="n">MSG_INITIATOR_DET_ERR</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_COMMAND</span>:
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;Command&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_MESGOUT</span>:
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;Message-Out&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_STATUS</span>:
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;Status&quot;</span><span class="p">;</span>
        <span class="n">mesg_out</span> <span class="o">=</span> <span class="n">MSG_INITIATOR_DET_ERR</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_MESGIN</span>:
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;Message-In&quot;</span><span class="p">;</span>
        <span class="n">mesg_out</span> <span class="o">=</span> <span class="n">MSG_PARITY_ERROR</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * A parity error has occurred during a data</span>
<span class="cm">     * transfer phase. Flag it and continue.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
        <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AHC_SYNCRATE_CRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_DATAIN</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;CRC error during %s phase.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">phase</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">CRCVALERR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;  CRC error in intermediate CRC packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">CRCENDERR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;  CRC error in ending CRC packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">CRCREQERR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;  Target incorrectly requested a CRC packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">DUAL_EDGE_ERROR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;  Dual Edge transmission error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_MSGOUT_PPR</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * As per the draft specs, any device capable of supporting any of</span>
<span class="cm">       * the option values other than 0 are not allowed to reject the</span>
<span class="cm">       * PPR message.  Instead, they must negotiate out what they do</span>
<span class="cm">       * support instead of rejecting our offering or else they cause</span>
<span class="cm">       * a parity error during msg_out phase to signal that they don&#39;t</span>
<span class="cm">       * like our settings.</span>
<span class="cm">       */</span>
      <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
                        <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_QUITE</span><span class="p">),</span>
			<span class="n">aic_dev</span><span class="p">);</span>
      <span class="n">aic7xxx_set_syncrate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="mi">0</span><span class="p">,</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_QUITE</span><span class="p">,</span>
			   <span class="n">aic_dev</span><span class="p">);</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_MSGOUT_BITS</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;parity error during PPR message, reverting &quot;</span>
               <span class="s">&quot;to WDTR/SDTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * We&#39;ve set the hardware to assert ATN if we get a parity</span>
<span class="cm">     * error on &quot;in&quot; phases, so all we need to do is stuff the</span>
<span class="cm">     * message buffer with the appropriate message.  &quot;In&quot; phases</span>
<span class="cm">     * have set mesg_out to something other than MSG_NOP.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mesg_out</span> <span class="o">!=</span> <span class="n">MSG_NOOP</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mesg_out</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIPERR</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="cm">/* unpause_always */</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_HANDLING_REQINITS</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Handling REQINIT, SSTAT1=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
             <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">));</span>
<span class="cp">#endif</span>
    <span class="n">aic7xxx_handle_reqinit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * We don&#39;t know what&#39;s going on. Turn off the</span>
<span class="cm">     * interrupt source and try to continue.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_SCSIINT</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Unknown SCSIINT status, SSTAT1(0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="cm">/* unpause always */</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_done</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_check_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_scbptr</span><span class="p">,</span> <span class="n">free_scbh</span><span class="p">,</span> <span class="n">dis_scbh</span><span class="p">,</span> <span class="n">wait_scbh</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bogus</span><span class="p">,</span> <span class="n">lost</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_status</span><span class="p">[</span><span class="n">AIC7XXX_MAXSCB</span><span class="p">];</span>

<span class="cp">#define SCB_NO_LIST 0</span>
<span class="cp">#define SCB_FREE_LIST 1</span>
<span class="cp">#define SCB_WAITING_LIST 2</span>
<span class="cp">#define SCB_DISCONNECTED_LIST 4</span>
<span class="cp">#define SCB_CURRENTLY_ACTIVE 8</span>

  <span class="cm">/*</span>
<span class="cm">   * Note, these checks will fail on a regular basis once the machine moves</span>
<span class="cm">   * beyond the bus scan phase.  The problem is race conditions concerning</span>
<span class="cm">   * the scbs and where they are linked in.  When you have 30 or so commands</span>
<span class="cm">   * outstanding on the bus, and run this twice with every interrupt, the</span>
<span class="cm">   * chances get pretty good that you&#39;ll catch the sequencer with an SCB</span>
<span class="cm">   * only partially linked in.  Therefore, once we pass the scan phase</span>
<span class="cm">   * of the bus, we really should disable this function.</span>
<span class="cm">   */</span>
  <span class="n">bogus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scb_status</span><span class="p">));</span>
  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">saved_scbptr</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bogus SCBPTR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">);</span>
    <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">scb_status</span><span class="p">[</span><span class="n">saved_scbptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_CURRENTLY_ACTIVE</span><span class="p">;</span>
  <span class="n">free_scbh</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">free_scbh</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">free_scbh</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bogus FREE_SCBH %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">free_scbh</span><span class="p">);</span>
    <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">free_scbh</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;HSCB %d on multiple lists, status 0x%02x&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
               <span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">|</span> <span class="n">SCB_FREE_LIST</span><span class="p">);</span>
        <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SCB_FREE_LIST</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">dis_scbh</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">dis_scbh</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">dis_scbh</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bogus DISCONNECTED_SCBH %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dis_scbh</span><span class="p">);</span>
    <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">dis_scbh</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;HSCB %d on multiple lists, status 0x%02x&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
               <span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">|</span> <span class="n">SCB_DISCONNECTED_LIST</span><span class="p">);</span>
        <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SCB_DISCONNECTED_LIST</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="n">wait_scbh</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">wait_scbh</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">wait_scbh</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bogus WAITING_SCBH %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wait_scbh</span><span class="p">);</span>
    <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">wait_scbh</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;HSCB %d on multiple lists, status 0x%02x&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
               <span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">|</span> <span class="n">SCB_WAITING_LIST</span><span class="p">);</span>
        <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">scb_status</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SCB_WAITING_LIST</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">lost</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">))</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;HSCB %d bad, SCB_NEXT invalid(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
      <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">temp</span> <span class="o">==</span> <span class="n">i</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;HSCB %d bad, SCB_NEXT points to self.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">bogus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">lost</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lost</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Too many lost scbs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">bogus</span><span class="o">=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bogus</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bogus parameters found in card SCB array structures.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
    <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_handle_command_completion_intr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   SCSI command completion interrupt handler.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_handle_command_completion_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">tindex</span><span class="p">;</span>

<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">isr_count</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Command Complete Int.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
    
  <span class="cm">/*</span>
<span class="cm">   * Read the INTSTAT location after clearing the CMDINT bit.  This forces</span>
<span class="cm">   * any posted PCI writes to flush to memory.  Gerard Roudier suggested</span>
<span class="cm">   * this fix to the possible race of clearing the CMDINT bit but not</span>
<span class="cm">   * having all command bytes flushed onto the qoutfifo.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRCMDINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
  <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">   * The sequencer will continue running when it</span>
<span class="cm">   * issues this interrupt. There may be &gt;1 commands</span>
<span class="cm">   * finished, so loop until we&#39;ve processed them all.</span>
<span class="cm">   */</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scb_index</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">];</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">scb_index</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;CMDCMPLT with invalid SCB index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">scb_index</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;CMDCMPLT without command for SCB %d, SCB flags &quot;</span>
        <span class="s">&quot;0x%x, cmd 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">tindex</span> <span class="o">=</span> <span class="n">TARGET_INDEX</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
    <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_QUEUED_ABORT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">P_BUSFREE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">)</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">aic7xxx_reset_device</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_QUEUED_FOR_DONE</span> <span class="o">|</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_ABORT</span> <span class="o">|</span>
        <span class="n">SCB_QUEUED_ABORT</span><span class="p">);</span>
      <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ABORT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * We started to abort this, but it completed on us, let it</span>
<span class="cm">       * through as successful</span>
<span class="cm">       */</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_ABORT</span><span class="o">|</span><span class="n">SCB_RESET</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x47</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x54</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Signal that we need to re-negotiate things.</span>
<span class="cm">         */</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">residual_SG_segment_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic7xxx_calculate_residual</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">aic7xxx_done</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_isr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   SCSI controller interrupt handler.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intstat</span><span class="p">;</span>

  <span class="n">p</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Just a few sanity checks.  Make sure that we have an int pending.</span>
<span class="cm">   * Also, if PCI, then we are going to check for a PCI bus error status</span>
<span class="cm">   * should we get too many spurious interrupts.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">intstat</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">))</span>
  <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_PCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">spurious_int</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_HANDLING_REQINITS</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCIERRSTAT</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic7xxx_pci_intr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">spurious_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_HANDLING_REQINITS</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">spurious_int</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">p</span><span class="o">-&gt;</span><span class="n">spurious_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Keep track of interrupts for /proc/scsi</span>
<span class="cm">   */</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">isr_count</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">aic7xxx_check_scbs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Bogus settings at start of interrupt.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

  <span class="cm">/*</span>
<span class="cm">   * Handle all the interrupt sources - especially for SCSI</span>
<span class="cm">   * interrupts, we won&#39;t get a second chance at them.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">CMDCMPLT</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_handle_command_completion_intr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">BRKADRINT</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">errno</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">);</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;(scsi%d) BRKADRINT error(0x%x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hard_error</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">&amp;</span> <span class="n">hard_error</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errno</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_error</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errmesg</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;(scsi%d)   SEQADDR=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
      <span class="p">(((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span>
      <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">&amp;</span> <span class="n">PCIERRSTAT</span><span class="p">)</span>
      <span class="n">aic7xxx_pci_intr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SQPARERR</span> <span class="o">|</span> <span class="n">ILLOPCODE</span> <span class="o">|</span> <span class="n">ILLSADDR</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;aic7xxx: unrecoverable BRKADRINT.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">&amp;</span> <span class="n">ILLHADDR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;(scsi%d) BUG! Driver accessed chip without first &quot;</span>
             <span class="s">&quot;pausing controller!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">&amp;</span> <span class="n">DPARERR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DMAPARAMS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DIRECTION</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(scsi%d) while DMAing SCB from host to card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(scsi%d) while DMAing SCB from card to host.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRPARERR</span> <span class="o">|</span> <span class="n">CLRBRKADRINT</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">);</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SEQINT</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Read the CCSCBCTL register to work around a bug in the Ultra2 cards</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CCSCBCTL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">aic7xxx_handle_seqint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SCSIINT</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_handle_scsiint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">isr_count</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">aic7xxx_check_scbs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Bogus settings at end of interrupt.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   do_aic7xxx_isr</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   This is a gross hack to solve a problem in linux kernels 2.1.85 and</span>
<span class="cm"> *   above.  Please, children, do not try this at home, and if you ever see</span>
<span class="cm"> *   anything like it, please inform the Gross Hack Police immediately</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">do_aic7xxx_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu_flags</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  
  <span class="n">p</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">cpu_flags</span><span class="p">);</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_IN_ISR</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_isr</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">)</span> <span class="p">);</span>
  <span class="n">aic7xxx_done_cmds_complete</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic7xxx_run_waiting_queues</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_IN_ISR</span><span class="p">;</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">cpu_flags</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_init_transinfo</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Set up the initial aic_dev values from the BIOS settings and from</span>
<span class="cm"> *   INQUIRY results</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_init_transinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdpnt</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">SDptr</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tindex</span><span class="p">;</span>

  <span class="n">tindex</span> <span class="o">=</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|</span> <span class="p">(</span><span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_DTR_SCANNED</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_DTR_SCANNED</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">wdtr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">aic7xxx_set_width</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
                        <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span> <span class="p">(</span><span class="n">AHC_TRANS_ACTIVE</span> <span class="o">|</span>
                                                 <span class="n">AHC_TRANS_GOAL</span> <span class="o">|</span>
                                                 <span class="n">AHC_TRANS_CUR</span><span class="p">),</span> <span class="n">aic_dev</span> <span class="p">);</span>
      <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">sdtr</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">offset</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">period</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">options</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_16BIT</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">sdpnt</span><span class="o">-&gt;</span><span class="n">ppr</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span>
             <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">tindex</span><span class="p">].</span><span class="n">options</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_SCSI_3</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span><span class="p">);</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVICE_PRINT_DTR</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_slave_alloc</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Set up the initial aic_dev struct pointers</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span><span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic_dev_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">aic_dev</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">   * Check to see if channel was scanned.</span>
<span class="cm">   */</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_A_SCANNED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Scanning channel for devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_A_SCANNED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_B_SCANNED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Scanning channel for devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_B_SCANNED</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">aic_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic_dev_data</span><span class="p">));</span>
  <span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="p">;</span>
  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">SDptr</span> <span class="o">=</span> <span class="n">SDptr</span><span class="p">;</span>
  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">scbq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">);</span>
  <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
  <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">aic_devs</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_device_queue_depth</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Determines the queue depth for a given device.  There are two ways</span>
<span class="cm"> *   a queue depth can be obtained for a tagged queueing device.  One</span>
<span class="cm"> *   way is the default queue depth which is determined by whether</span>
<span class="cm"> *   aic7xxx_default_queue_depth.  The other is by the aic7xxx_tag_info</span>
<span class="cm"> *   array.</span>
<span class="cm"> *</span>
<span class="cm"> *   If tagged queueing isn&#39;t supported on the device, then we set the</span>
<span class="cm"> *   depth to p-&gt;host-&gt;hostt-&gt;cmd_per_lun for internal driver queueing.</span>
<span class="cm"> *   as the default queue depth.  Otherwise, we use either 4 or 8 as the</span>
<span class="cm"> *   default queue depth (dependent on the number of hardware SCBs).</span>
<span class="cm"> *   The other way we determine queue depth is through the use of the</span>
<span class="cm"> *   aic7xxx_tag_info array which is enabled by defining</span>
<span class="cm"> *   AIC7XXX_TAGGED_QUEUEING_BY_DEVICE.  This array can be initialized</span>
<span class="cm"> *   with queue depths for individual devices.  It also allows tagged</span>
<span class="cm"> *   queueing to be [en|dis]abled for a specific adapter.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_device_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">tag_enabled</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tindex</span><span class="p">;</span>

  <span class="n">tindex</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">|</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span> <span class="c1">// We&#39;ve already enabled this device</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">tag_enabled</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Disconnection disabled, unable to &quot;</span>
             <span class="s">&quot;enable tagged queueing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
      <span class="n">tag_enabled</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aic7xxx_tag_info</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="k">static</span> <span class="kt">int</span> <span class="n">print_warning</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">print_warning</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: WARNING, insufficient tag_info instances for&quot;</span>
                           <span class="s">&quot; installed controllers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: Please update the aic7xxx_tag_info array in&quot;</span>
                           <span class="s">&quot; the aic7xxx.c source file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
          <span class="n">print_warning</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span>
		<span class="n">aic7xxx_default_queue_depth</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_tag_info</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">].</span><span class="n">tag_commands</span><span class="p">[</span><span class="n">tindex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">tag_enabled</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_tag_info</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">].</span><span class="n">tag_commands</span><span class="p">[</span><span class="n">tindex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span>
		  <span class="n">aic7xxx_default_queue_depth</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span> <span class="o">=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">temp_q_depth</span> <span class="o">=</span> 
            <span class="n">aic7xxx_tag_info</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">].</span><span class="n">tag_commands</span><span class="p">[</span><span class="n">tindex</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tag_enabled</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
    <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Tagged queuing enabled, queue depth %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
            <span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_NEGOTIATION2</span><span class="p">)</span>
    <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Tagged queuing disabled, queue depth %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
            <span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_slave_destroy</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   prepare for this device to go away</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span> <span class="o">=</span> <span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

  <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
  <span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">aic_dev</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_slave_configure</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Configure the device we are attaching to the controller.  This is</span>
<span class="cm"> *   where we get to do things like scan the INQUIRY data, set queue</span>
<span class="cm"> *   depths, allocate command structs, etc.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scbnum</span><span class="p">;</span>

  <span class="n">aic_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="p">)</span><span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

  <span class="n">aic7xxx_init_transinfo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_dev</span><span class="p">);</span>
  <span class="n">aic7xxx_device_queue_depth</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SDptr</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
    <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">aic_devs</span><span class="p">);</span>

  <span class="n">scbnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">aic_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">aic_devs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">scbnum</span> <span class="o">+=</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">scbnum</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Pre-allocate the needed SCBs to get around the possibility of having</span>
<span class="cm">     * to allocate some when memory is more or less exhausted and we need</span>
<span class="cm">     * the SCB in order to perform a swap operation (possible deadlock)</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">aic7xxx_allocate_scb</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_probe</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Probing for EISA boards: it looks like the first two bytes</span>
<span class="cm"> *   are a manufacturer code - three characters, five bits each:</span>
<span class="cm"> *</span>
<span class="cm"> *               BYTE 0   BYTE 1   BYTE 2   BYTE 3</span>
<span class="cm"> *              ?1111122 22233333 PPPPPPPP RRRRRRRR</span>
<span class="cm"> *</span>
<span class="cm"> *   The characters are baselined off ASCII &#39;@&#39;, so add that value</span>
<span class="cm"> *   to each to get the real ASCII code for it. The next two bytes</span>
<span class="cm"> *   appear to be a product and revision number, probably vendor-</span>
<span class="cm"> *   specific. This is what is being searched for at each port,</span>
<span class="cm"> *   and what should probably correspond to the ID= field in the</span>
<span class="cm"> *   ECU&#39;s .cfg file for the card - if your card is not detected,</span>
<span class="cm"> *   make sure your signature is listed in the array.</span>
<span class="cm"> *</span>
<span class="cm"> *   The fourth byte&#39;s lowest bit seems to be an enabled/disabled</span>
<span class="cm"> *   flag (rest of the bits are reserved?).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:  This function is only needed on Intel and Alpha platforms,</span>
<span class="cm"> *   the other platforms we support don&#39;t have EISA/VLB busses.  So,</span>
<span class="cm"> *   we #ifdef this entire function to avoid compiler warnings about</span>
<span class="cm"> *   an unused function.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="cp">#if defined(__i386__) || defined(__alpha__)</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="n">ahc_flag_type</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

  <span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">signature</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)];</span>
    <span class="n">ahc_chip</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">bios_disabled</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">AIC7xxx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x70</span> <span class="p">},</span>
      <span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_EISA</span><span class="p">,</span> <span class="n">FALSE</span> <span class="p">},</span>  <span class="cm">/* mb 7770  */</span>
    <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x71</span> <span class="p">},</span>
      <span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_EISA</span><span class="p">,</span> <span class="n">FALSE</span> <span class="p">},</span> <span class="cm">/* host adapter 274x */</span>
    <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x56</span> <span class="p">},</span>
      <span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_VL</span><span class="p">,</span> <span class="n">FALSE</span> <span class="p">},</span> <span class="cm">/* 284x BIOS enabled */</span>
    <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x57</span> <span class="p">},</span>
      <span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_VL</span><span class="p">,</span> <span class="n">TRUE</span> <span class="p">}</span>   <span class="cm">/* 284x BIOS disabled */</span>
  <span class="p">};</span>

  <span class="cm">/*</span>
<span class="cm">   * The VL-bus cards need to be primed by</span>
<span class="cm">   * writing before a signature check.</span>
<span class="cm">   */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">AIC7xxx</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Signature match on enabled card?</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">AIC7xxx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">signature</span><span class="p">,</span> <span class="n">AIC7xxx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AIC7xxx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bios_disabled</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_USEDEFAULTS</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;Adaptec 7770 SCSI Host Adapter&gt; &quot;</span>
             <span class="s">&quot;disabled at slot %d, ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* (__i386__) || (__alpha__) */</span><span class="cp"></span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   read_2840_seeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Reads the 2840 serial EEPROM and returns 1 if successful and 0 if</span>
<span class="cm"> *   not successful.</span>
<span class="cm"> *</span>
<span class="cm"> *   See read_seeprom (for the 2940) for the instruction set of the 93C46</span>
<span class="cm"> *   chip.</span>
<span class="cm"> *</span>
<span class="cm"> *   The 2840 interface to the 93C46 serial EEPROM is through the</span>
<span class="cm"> *   STATUS_2840 and SEECTL_2840 registers.  The CS_2840, CK_2840, and</span>
<span class="cm"> *   DO_2840 bits of the SEECTL_2840 register are connected to the chip</span>
<span class="cm"> *   select, clock, and data out lines respectively of the serial EEPROM.</span>
<span class="cm"> *   The DI_2840 bit of the STATUS_2840 is connected to the data in line</span>
<span class="cm"> *   of the serial EEPROM.  The EEPROM_TF bit of STATUS_2840 register is</span>
<span class="cm"> *   useful in that it gives us an 800 nsec timer.  After a read from the</span>
<span class="cm"> *   SEECTL_2840 register the timing flag is cleared and goes high 800 nsec</span>
<span class="cm"> *   later.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_284x_seeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seeprom_config</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">seeprom</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">sc</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">seeprom_cmd</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="p">};</span>
  <span class="k">struct</span> <span class="n">seeprom_cmd</span> <span class="n">seeprom_read</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}};</span>

<span class="cp">#define CLOCK_PULSE(p) \</span>
<span class="cp">  while ((aic_inb(p, STATUS_2840) &amp; EEPROM_TF) == 0)        \</span>
<span class="cp">  {                                                \</span>
<span class="cp">    ;  </span><span class="cm">/* Do nothing */</span><span class="cp">                                \</span>
<span class="cp">  }                                                \</span>
<span class="cp">  (void) aic_inb(p, SEECTL_2840);</span>

  <span class="cm">/*</span>
<span class="cm">   * Read the first 32 registers of the seeprom.  For the 2840,</span>
<span class="cm">   * the 93C46 SEEPROM is a 1024-bit device with 64 16-bit registers</span>
<span class="cm">   * but only the first 32 are used by Adaptec BIOS.  The loop</span>
<span class="cm">   * will range from 0 to 31.</span>
<span class="cm">   */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Send chip select for one clock cycle.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CK_2840</span> <span class="o">|</span> <span class="n">CS_2840</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Now we&#39;re ready to send the read command followed by the</span>
<span class="cm">     * address of the 16-bit register we want to read.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">seeprom_read</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">CS_2840</span> <span class="o">|</span> <span class="n">seeprom_read</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">CK_2840</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * Send the 6 bit address (MSB first, LSB last).</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Mask out all but lower bit. */</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">CS_2840</span> <span class="o">|</span> <span class="n">temp</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">CK_2840</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Now read the 16 bit register.  An initial 0 precedes the</span>
<span class="cm">     * register contents which begins with bit 15 (MSB) and ends</span>
<span class="cm">     * with bit 0 (LSB).  The initial 0 will be shifted off the</span>
<span class="cm">     * top of our word as we let the loop run from 0 to 16.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">CS_2840</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">CK_2840</span><span class="p">;</span>
      <span class="n">seeprom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">seeprom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STATUS_2840</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DI_2840</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * The serial EEPROM has a checksum in the last word.  Keep a</span>
<span class="cm">     * running checksum for all words read except for the last</span>
<span class="cm">     * word.  We&#39;ll verify the checksum after all words have been</span>
<span class="cm">     * read.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span> <span class="o">+</span> <span class="n">seeprom</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Reset the chip select for the next command cycle.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CK_2840</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEECTL_2840</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  printk(&quot;Computed checksum 0x%x, checksum read 0x%x\n&quot;, checksum, sc-&gt;checksum);</span>
<span class="c">  printk(&quot;Serial EEPROM:&quot;);</span>
<span class="c">  for (k = 0; k &lt; (sizeof(*sc) / 2); k++)</span>
<span class="c">  {</span>
<span class="c">    if (((k % 8) == 0) &amp;&amp; (k != 0))</span>
<span class="c">    {</span>
<span class="c">      printk(&quot;\n              &quot;);</span>
<span class="c">    }</span>
<span class="c">    printk(&quot; 0x%x&quot;, seeprom[k]);</span>
<span class="c">  }</span>
<span class="c">  printk(&quot;\n&quot;);</span>
<span class="cp">#endif</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: SEEPROM checksum error, ignoring SEEPROM settings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#undef CLOCK_PULSE</span>
<span class="p">}</span>

<span class="cp">#define CLOCK_PULSE(p)                                               \</span>
<span class="cp">  do {                                                               \</span>
<span class="cp">    int limit = 0;                                                   \</span>
<span class="cp">    do {                                                             \</span>
<span class="cp">      mb();                                                          \</span>
<span class="cp">      pause_sequencer(p);  </span><span class="cm">/* This is just to generate some PCI */</span><span class="cp">   \</span>
<span class="cp">                           </span><span class="cm">/* traffic so the PCI read is flushed */</span><span class="cp">  \</span>
<span class="cp">                           </span><span class="cm">/* it shouldn&#39;t be needed, but some */</span><span class="cp">    \</span>
<span class="cp">                           </span><span class="cm">/* chipsets do indeed appear to need */</span><span class="cp">   \</span>
<span class="cp">                           </span><span class="cm">/* something to force PCI reads to get */</span><span class="cp"> \</span>
<span class="cp">                           </span><span class="cm">/* flushed */</span><span class="cp">                             \</span>
<span class="cp">      udelay(1);           </span><span class="cm">/* Do nothing */</span><span class="cp">                          \</span>
<span class="cp">    } while (((aic_inb(p, SEECTL) &amp; SEERDY) == 0) &amp;&amp; (++limit &lt; 1000)); \</span>
<span class="cp">  } while(0)</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   acquire_seeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Acquires access to the memory port on PCI controllers.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acquire_seeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>

  <span class="cm">/*</span>
<span class="cm">   * Request access of the memory port.  When access is</span>
<span class="cm">   * granted, SEERDY will go high.  We use a 1 second</span>
<span class="cm">   * timeout which should be near 1 second more than</span>
<span class="cm">   * is needed.  Reason: after the 7870 chip reset, there</span>
<span class="cm">   * should be no contention.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEEMS</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEERDY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   release_seeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Releases access to the memory port on PCI controllers.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_seeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*</span>
<span class="cm">   * Make sure the SEEPROM is ready before we release it.</span>
<span class="cm">   */</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   read_seeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Reads the serial EEPROM and returns 1 if successful and 0 if</span>
<span class="cm"> *   not successful.</span>
<span class="cm"> *</span>
<span class="cm"> *   The instruction set of the 93C46/56/66 chips is as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *               Start  OP</span>
<span class="cm"> *     Function   Bit  Code  Address    Data     Description</span>
<span class="cm"> *     -------------------------------------------------------------------</span>
<span class="cm"> *     READ        1    10   A5 - A0             Reads data stored in memory,</span>
<span class="cm"> *                                               starting at specified address</span>
<span class="cm"> *     EWEN        1    00   11XXXX              Write enable must precede</span>
<span class="cm"> *                                               all programming modes</span>
<span class="cm"> *     ERASE       1    11   A5 - A0             Erase register A5A4A3A2A1A0</span>
<span class="cm"> *     WRITE       1    01   A5 - A0   D15 - D0  Writes register</span>
<span class="cm"> *     ERAL        1    00   10XXXX              Erase all registers</span>
<span class="cm"> *     WRAL        1    00   01XXXX    D15 - D0  Writes to all registers</span>
<span class="cm"> *     EWDS        1    00   00XXXX              Disables all programming</span>
<span class="cm"> *                                               instructions</span>
<span class="cm"> *     *Note: A value of X for address is a don&#39;t care condition.</span>
<span class="cm"> *     *Note: The 93C56 and 93C66 have 8 address bits.</span>
<span class="cm"> * </span>
<span class="cm"> *</span>
<span class="cm"> *   The 93C46 has a four wire interface: clock, chip select, data in, and</span>
<span class="cm"> *   data out.  In order to perform one of the above functions, you need</span>
<span class="cm"> *   to enable the chip select for a clock period (typically a minimum of</span>
<span class="cm"> *   1 usec, with the clock high and low a minimum of 750 and 250 nsec</span>
<span class="cm"> *   respectively.  While the chip select remains high, you can clock in</span>
<span class="cm"> *   the instructions (above) starting with the start bit, followed by the</span>
<span class="cm"> *   OP code, Address, and Data (if needed).  For the READ instruction, the</span>
<span class="cm"> *   requested 16-bit register contents is read from the data out line but</span>
<span class="cm"> *   is preceded by an initial zero (leading 0, followed by 16-bits, MSB</span>
<span class="cm"> *   first).  The clock cycling from low to high initiates the next data</span>
<span class="cm"> *   bit to be sent from the chip.</span>
<span class="cm"> *</span>
<span class="cm"> *   The 78xx interface to the 93C46 serial EEPROM is through the SEECTL</span>
<span class="cm"> *   register.  After successful arbitration for the memory port, the</span>
<span class="cm"> *   SEECS bit of the SEECTL register is connected to the chip select.</span>
<span class="cm"> *   The SEECK, SEEDO, and SEEDI are connected to the clock, data out,</span>
<span class="cm"> *   and data in lines respectively.  The SEERDY bit of SEECTL is useful</span>
<span class="cm"> *   in that it gives us an 800 nsec timer.  After a write to the SEECTL</span>
<span class="cm"> *   register, the SEERDY goes high 800 nsec later.  The one exception</span>
<span class="cm"> *   to this is when we first request access to the memory port.  The</span>
<span class="cm"> *   SEERDY goes high to signify that access has been granted and, for</span>
<span class="cm"> *   this case, has no implied timing.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_seeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> 
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">scarray</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">seeprom_chip_type</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">seeprom_cmd</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="p">};</span>
  <span class="k">struct</span> <span class="n">seeprom_cmd</span> <span class="n">seeprom_read</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}};</span>

  <span class="cm">/*</span>
<span class="cm">   * Request access of the memory port.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">acquire_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Read &#39;len&#39; registers of the seeprom.  For the 7870, the 93C46</span>
<span class="cm">   * SEEPROM is a 1024-bit device with 64 16-bit registers but only</span>
<span class="cm">   * the first 32 are used by Adaptec BIOS.  Some adapters use the</span>
<span class="cm">   * 93C56 SEEPROM which is a 2048-bit device.  The loop will range</span>
<span class="cm">   * from 0 to &#39;len&#39; - 1.</span>
<span class="cm">   */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Send chip select for one clock cycle.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEEMS</span> <span class="o">|</span> <span class="n">SEECK</span> <span class="o">|</span> <span class="n">SEECS</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Now we&#39;re ready to send the read command followed by the</span>
<span class="cm">     * address of the 16-bit register we want to read.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">seeprom_read</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">SEEMS</span> <span class="o">|</span> <span class="n">SEECS</span> <span class="o">|</span> <span class="p">(</span><span class="n">seeprom_read</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">SEECK</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * Send the 6 or 8 bit address (MSB first, LSB last).</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">chip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Mask out all but lower bit. */</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">SEEMS</span> <span class="o">|</span> <span class="n">SEECS</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">SEECK</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Now read the 16 bit register.  An initial 0 precedes the</span>
<span class="cm">     * register contents which begins with bit 15 (MSB) and ends</span>
<span class="cm">     * with bit 0 (LSB).  The initial 0 will be shifted off the</span>
<span class="cm">     * top of our word as we let the loop run from 0 to 16.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">SEEMS</span> <span class="o">|</span> <span class="n">SEECS</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">SEECK</span><span class="p">;</span>
      <span class="n">scarray</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scarray</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEEDI</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
      <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * The serial EEPROM should have a checksum in the last word.</span>
<span class="cm">     * Keep a running checksum for all words read except for the</span>
<span class="cm">     * last word.  We&#39;ll verify the checksum after all words have</span>
<span class="cm">     * been read.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span> <span class="o">+</span> <span class="n">scarray</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Reset the chip select for the next command cycle.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEEMS</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEEMS</span> <span class="o">|</span> <span class="n">SEECK</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEEMS</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Release access to the memory port and the serial EEPROM.</span>
<span class="cm">   */</span>
  <span class="n">release_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  printk(&quot;Computed checksum 0x%x, checksum read 0x%x\n&quot;,</span>
<span class="c">         checksum, scarray[len - 1]);</span>
<span class="c">  printk(&quot;Serial EEPROM:&quot;);</span>
<span class="c">  for (k = 0; k &lt; len; k++)</span>
<span class="c">  {</span>
<span class="c">    if (((k % 8) == 0) &amp;&amp; (k != 0))</span>
<span class="c">    {</span>
<span class="c">      printk(&quot;\n              &quot;);</span>
<span class="c">    }</span>
<span class="c">    printk(&quot; 0x%x&quot;, scarray[k]);</span>
<span class="c">  }</span>
<span class="c">  printk(&quot;\n&quot;);</span>
<span class="cp">#endif</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="n">scarray</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   read_brdctl</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Reads the BRDCTL register.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">read_brdctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Make sure the SEEPROM is ready before we access it</span>
<span class="cm">   */</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">brdctl</span> <span class="o">=</span> <span class="n">BRDRW_ULTRA2</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">BRDRW</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7895</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHNLB</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">brdctl</span> <span class="o">|=</span> <span class="n">BRDCS</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   write_brdctl</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Writes a value to the BRDCTL register.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_brdctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brdctl</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Make sure the SEEPROM is ready before we access it</span>
<span class="cm">   */</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">brdctl</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">brdctl</span> <span class="o">|=</span> <span class="n">BRDSTB_ULTRA2</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">brdctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BRDSTB_ULTRA2</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">read_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">brdctl</span> <span class="o">=</span> <span class="n">BRDSTB</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7895</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHNLB</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">brdctl</span> <span class="o">|=</span> <span class="n">BRDCS</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">brdctl</span> <span class="o">=</span> <span class="n">BRDSTB</span> <span class="o">|</span> <span class="n">BRDCS</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">brdctl</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">brdctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BRDSTB</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">brdctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BRDCS</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brdctl</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
    <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic785x_cable_detect</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Detect the cables that are present on aic785x class controller chips</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic785x_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">int_50</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">ext_present</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brdctl</span><span class="p">;</span>

  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRDRW</span> <span class="o">|</span> <span class="n">BRDCS</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRDCTL</span><span class="p">);</span>
  <span class="n">CLOCK_PULSE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="o">*</span><span class="n">int_50</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT5</span><span class="p">);</span>
  <span class="o">*</span><span class="n">ext_present</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT6</span><span class="p">);</span>
  <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SPIOCAP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEPROM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef CLOCK_PULSE</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic2940_uwpro_cable_detect</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Detect the cables that are present on the 2940-UWPro cards</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This function assumes the SEEPROM will have already been acquired</span>
<span class="cm"> *       prior to invocation of this function.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic2940_uwpro_wide_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">int_68</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">ext_68</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brdctl</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * First read the status of our cables.  Set the rom bank to</span>
<span class="cm">   * 0 since the bank setting serves as a multiplexor for the</span>
<span class="cm">   * cable detection logic.  BRDDAT5 controls the bank switch.</span>
<span class="cm">   */</span>
  <span class="n">write_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Now we read the state of the internal 68 connector.  BRDDAT6</span>
<span class="cm">   * is don&#39;t care, BRDDAT7 is internal 68.  The cable is</span>
<span class="cm">   * present if the bit is 0</span>
<span class="cm">   */</span>
  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">read_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="o">*</span><span class="n">int_68</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT7</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Set the bank bit in brdctl and then read the external cable state</span>
<span class="cm">   * and the EEPROM status</span>
<span class="cm">   */</span>
  <span class="n">write_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRDDAT5</span><span class="p">);</span>
  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">read_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="o">*</span><span class="n">ext_68</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT6</span><span class="p">);</span>
  <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT7</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * We&#39;re done, the calling function will release the SEEPROM for us</span>
<span class="cm">   */</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic787x_cable_detect</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Detect the cables that are present on aic787x class controller chips</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This function assumes the SEEPROM will have already been acquired</span>
<span class="cm"> *       prior to invocation of this function.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic787x_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">int_50</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">int_68</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">ext_present</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brdctl</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * First read the status of our cables.  Set the rom bank to</span>
<span class="cm">   * 0 since the bank setting serves as a multiplexor for the</span>
<span class="cm">   * cable detection logic.  BRDDAT5 controls the bank switch.</span>
<span class="cm">   */</span>
  <span class="n">write_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Now we read the state of the two internal connectors.  BRDDAT6</span>
<span class="cm">   * is internal 50, BRDDAT7 is internal 68.  For each, the cable is</span>
<span class="cm">   * present if the bit is 0</span>
<span class="cm">   */</span>
  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">read_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="o">*</span><span class="n">int_50</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT6</span><span class="p">);</span>
  <span class="o">*</span><span class="n">int_68</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT7</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Set the bank bit in brdctl and then read the external cable state</span>
<span class="cm">   * and the EEPROM status</span>
<span class="cm">   */</span>
  <span class="n">write_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">BRDDAT5</span><span class="p">);</span>
  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">read_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="o">*</span><span class="n">ext_present</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT6</span><span class="p">);</span>
  <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT7</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * We&#39;re done, the calling function will release the SEEPROM for us</span>
<span class="cm">   */</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic787x_ultra2_term_detect</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Detect the termination settings present on ultra2 class controllers</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This function assumes the SEEPROM will have already been acquired</span>
<span class="cm"> *       prior to invocation of this function.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_ultra2_term_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">enableSE_low</span><span class="p">,</span>
                           <span class="kt">int</span> <span class="o">*</span><span class="n">enableSE_high</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">enableLVD_low</span><span class="p">,</span>
                           <span class="kt">int</span> <span class="o">*</span><span class="n">enableLVD_high</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eprom_present</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brdctl</span><span class="p">;</span>

  <span class="n">brdctl</span> <span class="o">=</span> <span class="n">read_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="o">*</span><span class="n">eprom_present</span>  <span class="o">=</span> <span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT7</span><span class="p">);</span>
  <span class="o">*</span><span class="n">enableSE_high</span>  <span class="o">=</span> <span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT6</span><span class="p">);</span>
  <span class="o">*</span><span class="n">enableSE_low</span>   <span class="o">=</span> <span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT5</span><span class="p">);</span>
  <span class="o">*</span><span class="n">enableLVD_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT4</span><span class="p">);</span>
  <span class="o">*</span><span class="n">enableLVD_low</span>  <span class="o">=</span> <span class="p">(</span><span class="n">brdctl</span> <span class="o">&amp;</span> <span class="n">BRDDAT3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   configure_termination</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Configures the termination settings on PCI adapters that have</span>
<span class="cm"> *   SEEPROMs available.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">configure_termination</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">internal50_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">internal68_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">external_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">eprom_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">enableSE_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">enableSE_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">enableLVD_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">enableLVD_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brddat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max_target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sxfrctl1</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">acquire_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_WIDE</span><span class="o">|</span><span class="n">AHC_TWIN</span><span class="p">))</span>
      <span class="n">max_target</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">max_target</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEEMS</span> <span class="o">|</span> <span class="n">SEECS</span><span class="p">,</span> <span class="n">SEECTL</span><span class="p">);</span>
    <span class="n">sxfrctl1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STPWEN</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * The termination/cable detection logic is split into three distinct</span>
<span class="cm">     * groups.  Ultra2 and later controllers, 2940UW-Pro controllers, and</span>
<span class="cm">     * older 7850, 7860, 7870, 7880, and 7895 controllers.  Each has its</span>
<span class="cm">     * own unique way of detecting their cables and writing the results</span>
<span class="cm">     * back to the card.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * As long as user hasn&#39;t overridden term settings, always check the</span>
<span class="cm">       * cable detection logic</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_override_term</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic7xxx_ultra2_term_detect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enableSE_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enableSE_high</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">enableLVD_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enableLVD_high</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">eprom_present</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="cm">/*</span>
<span class="cm">       * If the user is overriding settings, then they have been preserved</span>
<span class="cm">       * to here as fake adapter_control entries.  Parse them and allow</span>
<span class="cm">       * them to override the detected settings (if we even did detection).</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFSEAUTOTERM</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">enableSE_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFSTERM</span><span class="p">);</span>
        <span class="n">enableSE_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFWSTERM</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFAUTOTERM</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">enableLVD_low</span> <span class="o">=</span> <span class="n">enableLVD_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFLVDSTERM</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="cm">/*</span>
<span class="cm">       * Now take those settings that we have and translate them into the</span>
<span class="cm">       * values that must be written into the registers.</span>
<span class="cm">       *</span>
<span class="cm">       * Flash Enable = BRDDAT7</span>
<span class="cm">       * Secondary High Term Enable = BRDDAT6</span>
<span class="cm">       * Secondary Low Term Enable = BRDDAT5</span>
<span class="cm">       * LVD/Primary High Term Enable = BRDDAT4</span>
<span class="cm">       * LVD/Primary Low Term Enable = STPWEN bit in SXFRCTL1</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">enableLVD_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_LVD</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) LVD/Primary Low byte termination &quot;</span>
                 <span class="s">&quot;Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="p">}</span>
          
      <span class="k">if</span> <span class="p">(</span><span class="n">enableLVD_high</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">brddat</span> <span class="o">|=</span> <span class="n">BRDDAT4</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) LVD/Primary High byte termination &quot;</span>
                 <span class="s">&quot;Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">enableSE_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">brddat</span> <span class="o">|=</span> <span class="n">BRDDAT5</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Secondary Low byte termination &quot;</span>
                 <span class="s">&quot;Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">enableSE_high</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">brddat</span> <span class="o">|=</span> <span class="n">BRDDAT6</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Secondary High byte termination &quot;</span>
                 <span class="s">&quot;Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_NEW_AUTOTERM</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * The 50 pin connector termination is controlled by STPWEN in the</span>
<span class="cm">       * SXFRCTL1 register.  Since the Adaptec docs typically say the</span>
<span class="cm">       * controller is not allowed to be in the middle of a cable and</span>
<span class="cm">       * this is the only connection on that stub of the bus, there is</span>
<span class="cm">       * no need to even check for narrow termination, it&#39;s simply</span>
<span class="cm">       * always on.</span>
<span class="cm">       */</span>
      <span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Narrow channel termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFAUTOTERM</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic2940_uwpro_wide_cable_detect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal68_present</span><span class="p">,</span>
                                        <span class="o">&amp;</span><span class="n">external_present</span><span class="p">,</span>
                                        <span class="o">&amp;</span><span class="n">eprom_present</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Cables present (Int-50 %s, Int-68 %s, &quot;</span>
               <span class="s">&quot;Ext-68 %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
               <span class="s">&quot;Don&#39;t Care&quot;</span><span class="p">,</span>
               <span class="n">internal68_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">,</span>
               <span class="n">external_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) EEPROM %s present.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
               <span class="n">eprom_present</span> <span class="o">?</span> <span class="s">&quot;is&quot;</span> <span class="o">:</span> <span class="s">&quot;is not&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">internal68_present</span> <span class="o">&amp;&amp;</span> <span class="n">external_present</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">brddat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Wide channel termination Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">brddat</span> <span class="o">=</span> <span class="n">BRDDAT6</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Wide channel termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * The termination of the Wide channel is done more like normal</span>
<span class="cm">         * though, and the setting of this termination is done by writing</span>
<span class="cm">         * either a 0 or 1 to BRDDAT6 of the BRDDAT register</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFWSTERM</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">brddat</span> <span class="o">=</span> <span class="n">BRDDAT6</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Wide channel termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">brddat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFAUTOTERM</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_MOTHERBOARD</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Warning - detected auto-termination</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Please verify driver detected settings &quot;</span>
            <span class="s">&quot;are correct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) If not, then please properly set the &quot;</span>
            <span class="s">&quot;device termination</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) in the Adaptec SCSI BIOS by hitting &quot;</span>
            <span class="s">&quot;CTRL-A when prompted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) during machine bootup.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* Configure auto termination. */</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AHC_AIC7870</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">aic787x_cable_detect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal50_present</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal68_present</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">external_present</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eprom_present</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">aic785x_cable_detect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal50_present</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">external_present</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">eprom_present</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">max_target</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
          <span class="n">internal68_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">max_target</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Cables present (Int-50 %s, Int-68 %s, &quot;</span>
                 <span class="s">&quot;Ext-68 %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                 <span class="n">internal50_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">,</span>
                 <span class="n">internal68_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">,</span>
                 <span class="n">external_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Cables present (Int-50 %s, Ext-50 %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
                 <span class="n">internal50_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">,</span>
                 <span class="n">external_present</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;NO&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) EEPROM %s present.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
               <span class="n">eprom_present</span> <span class="o">?</span> <span class="s">&quot;is&quot;</span> <span class="o">:</span> <span class="s">&quot;is not&quot;</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * Now set the termination based on what we found.  BRDDAT6</span>
<span class="cm">         * controls wide termination enable.</span>
<span class="cm">         * Flash Enable = BRDDAT7</span>
<span class="cm">         * SE High Term Enable = BRDDAT6</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">internal50_present</span> <span class="o">&amp;&amp;</span> <span class="n">internal68_present</span> <span class="o">&amp;&amp;</span> <span class="n">external_present</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Illegal cable configuration!!  Only two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) connectors on the SCSI controller may be &quot;</span>
                 <span class="s">&quot;in use at a time!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
          <span class="cm">/*</span>
<span class="cm">           * Force termination (low and high byte) on.  This is safer than</span>
<span class="cm">           * leaving it completely off, especially since this message comes</span>
<span class="cm">           * most often from motherboard controllers that don&#39;t even have 3</span>
<span class="cm">           * connectors, but instead are failing the cable detection.</span>
<span class="cm">           */</span>
          <span class="n">internal50_present</span> <span class="o">=</span> <span class="n">external_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">enableSE_high</span> <span class="o">=</span> <span class="n">enableSE_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">max_target</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">((</span><span class="n">external_present</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">internal68_present</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">brddat</span> <span class="o">|=</span> <span class="n">BRDDAT6</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) SE High byte termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">internal50_present</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
              <span class="p">(</span><span class="n">internal68_present</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
              <span class="p">(</span><span class="n">external_present</span>   <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_LOW</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) SE Low byte termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="cm">/* p-&gt;adapter_control &amp; CFAUTOTERM */</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFSTERM</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) SE Low byte termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFWSTERM</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">brddat</span> <span class="o">|=</span> <span class="n">BRDDAT6</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) SE High byte termination Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sxfrctl1</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>
    <span class="n">write_brdctl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">brddat</span><span class="p">);</span>
    <span class="n">release_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   detect_maxscb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Detects the maximum number of SCBs for the controller and returns</span>
<span class="cm"> *   the count and a mask in p (p-&gt;maxscbs, p-&gt;qcntmask).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">detect_maxscb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * It&#39;s possible that we&#39;ve already done this for multichannel</span>
<span class="cm">   * adapters.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * We haven&#39;t initialized the SCB settings yet.  Walk the SCBs to</span>
<span class="cm">     * determince how many there are.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AIC7XXX_MAXSCB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>   <span class="cm">/* Clear the control byte. */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>  <span class="cm">/* Set the next pointer. */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>  <span class="cm">/* Make the tag invalid. */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_BUSYTARGETS</span><span class="p">);</span>  <span class="cm">/* no busy untagged */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_BUSYTARGETS</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="cm">/* targets active yet */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_BUSYTARGETS</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_BUSYTARGETS</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Make sure the last SCB terminates the free list. */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>

    <span class="cm">/* Ensure we clear the first (0) SCBs control byte. */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>

    <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * Use direct indexing instead for speed</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">AIC7XXX_MAXSCB</span> <span class="p">)</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_PAGESCBS</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_register</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Register a Adaptec aic7xxx chip SCSI controller with the kernel.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">template</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
  <span class="kt">int</span> <span class="n">reset_delay</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">max_targets</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">term</span><span class="p">,</span> <span class="n">scsi_conf</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

  <span class="n">host</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

  <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxscbs</span> <span class="o">=</span> <span class="n">AIC7XXX_MAXSCB</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">AIC7XXX_MAXSCB</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">AIC7XXX_MAX_SG</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mbase</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
  <span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">isr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">completeq</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">scbq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">);</span>
  <span class="n">scbq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">);</span>
  <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">aic_devs</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * We currently have no commands of any type</span>
<span class="cm">   */</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) &lt;%s&gt; found at &quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
    <span class="n">board_names</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">board_name_index</span><span class="p">]);</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_EISA</span><span class="p">)</span>:
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;EISA slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_VL</span><span class="p">)</span>:
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;VLB slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
        <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Twin Channel, A SCSI ID %d, B SCSI ID %d, &quot;</span><span class="p">,</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id_b</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>

    <span class="n">channel</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">channel</span> <span class="o">=</span> <span class="s">&quot; A&quot;</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHNLB</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; B&quot;</span> <span class="o">:</span> <span class="s">&quot; C&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Wide &quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Narrow &quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Channel%s, SCSI ID=%d, &quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">);</span>

  <span class="n">detect_maxscb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d/%d SCBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxscbs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) BIOS %sabled, IO Port 0x%lx, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">,</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) IO Memory at 0x%lx, MMAP Memory at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mbase</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
  <span class="cm">/*</span>
<span class="cm">   * Now that we know our instance number, we can set the flags we need to</span>
<span class="cm">   * force termination if need be.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_stpwlev</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * This option only applies to PCI controllers.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_PCI</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">devconfig</span><span class="p">;</span>

      <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devconfig</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_stpwlev</span> <span class="o">&gt;&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">devconfig</span> <span class="o">|=</span> <span class="n">STPWLEVEL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(scsi%d) Force setting STPWLEVEL bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">devconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STPWLEVEL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(scsi%d) Force clearing STPWLEVEL bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="n">devconfig</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="cm">/*</span>
<span class="cm">   * That took care of devconfig and stpwlev, now for the actual termination</span>
<span class="cm">   * settings.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_override_term</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Again, this only applies to PCI controllers.  We don&#39;t have problems</span>
<span class="cm">     * with the termination on 274x controllers to the best of my knowledge.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_PCI</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">term_override</span><span class="p">;</span>

      <span class="n">term_override</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic7xxx_override_term</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;=</span> 
        <span class="o">~</span><span class="p">(</span><span class="n">CFSTERM</span><span class="o">|</span><span class="n">CFWSTERM</span><span class="o">|</span><span class="n">CFLVDSTERM</span><span class="o">|</span><span class="n">CFAUTOTERM</span><span class="o">|</span><span class="n">CFSEAUTOTERM</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">term_override</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">|=</span> <span class="n">CFLVDSTERM</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">term_override</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">|=</span> <span class="n">CFWSTERM</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">term_override</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">|=</span> <span class="n">CFSTERM</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SEEPROM_FOUND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">aic7xxx_override_term</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_SPIOCAP</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SPIOCAP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSPIOCPS</span> <span class="p">)</span>
      <span class="cm">/*</span>
<span class="cm">       * Update the settings in sxfrctl1 to match the termination</span>
<span class="cm">       * settings.</span>
<span class="cm">       */</span>
        <span class="n">configure_termination</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AHC_AIC7870</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">configure_termination</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Set the SCSI Id, SXFRCTL0, SXFRCTL1, and SIMODE1, for both channels</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Select channel B */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SELBUSB</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SEEPROM_FOUND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">aic7xxx_override_term</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STPWEN</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">term</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TERM_ENB_B</span><span class="p">)</span> <span class="o">?</span> <span class="n">STPWEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id_b</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">);</span>
    <span class="n">scsi_conf</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSICONF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DFON</span> <span class="o">|</span> <span class="n">SPIOEN</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">scsi_conf</span> <span class="o">&amp;</span> <span class="n">ENSPCHK</span><span class="p">)</span> <span class="o">|</span> <span class="n">aic7xxx_seltime</span> <span class="o">|</span> <span class="n">term</span> <span class="o">|</span> 
         <span class="n">ENSTIMER</span> <span class="o">|</span> <span class="n">ACTNEGEN</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ENSELTIMO</span> <span class="o">|</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="n">ENSCSIPERR</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">);</span>

    <span class="cm">/* Select channel A */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span> <span class="n">SCSIID_ULTRA2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SEEPROM_FOUND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">aic7xxx_override_term</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STPWEN</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">term</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_TERM_ENB_A</span><span class="o">|</span><span class="n">AHC_TERM_ENB_LVD</span><span class="p">))</span> <span class="o">?</span> <span class="n">STPWEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">scsi_conf</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DFON</span> <span class="o">|</span> <span class="n">SPIOEN</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">scsi_conf</span> <span class="o">&amp;</span> <span class="n">ENSPCHK</span><span class="p">)</span> <span class="o">|</span> <span class="n">aic7xxx_seltime</span> <span class="o">|</span> <span class="n">term</span> <span class="o">|</span> 
       <span class="n">ENSTIMER</span> <span class="o">|</span> <span class="n">ACTNEGEN</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">   * If we are a cardbus adapter then don&#39;t enable SCSI reset detection.</span>
<span class="cm">   * We shouldn&#39;t likely be sharing SCSI busses with someone else, and</span>
<span class="cm">   * if we don&#39;t have a cable currently plugged into the controller then</span>
<span class="cm">   * we won&#39;t have a power source for the SCSI termination, which means</span>
<span class="cm">   * we&#39;ll see infinite incoming bus resets.</span>
<span class="cm">   */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_NO_STPWEN</span><span class="p">)</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ENSELTIMO</span> <span class="o">|</span> <span class="n">ENSCSIPERR</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ENSELTIMO</span> <span class="o">|</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="n">ENSCSIPERR</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSIOFFSET</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Look at the information that board initialization or the board</span>
<span class="cm">   * BIOS has left us. In the lower four bits of each target&#39;s</span>
<span class="cm">   * scratch space any value other than 0 indicates that we should</span>
<span class="cm">   * initiate synchronous transfers. If it&#39;s zero, the user or the</span>
<span class="cm">   * BIOS has decided to disable synchronous negotiation to that</span>
<span class="cm">   * target so we don&#39;t activate the needsdtr flag.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_TWIN</span><span class="o">|</span><span class="n">AHC_WIDE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">max_targets</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">max_targets</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aic7xxx_no_reset</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * If we reset the bus, then clear the transfer settings, else leave</span>
<span class="cm">     * them be.</span>
<span class="cm">     */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ULTRA_ENB</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ULTRA_ENB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Allocate enough hardware scbs to handle the maximum number of</span>
<span class="cm">   * concurrent transactions we can have.  We have to make sure that</span>
<span class="cm">   * the allocated memory is contiguous memory.  The Linux kmalloc</span>
<span class="cm">   * routine should only allocate contiguous memory, but note that</span>
<span class="cm">   * this could be a problem if kmalloc() is changed.</span>
<span class="cm">   */</span>
  <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">array_size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hscb_physaddr</span><span class="p">;</span>

    <span class="n">array_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxscbs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_hwscb</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* pci_alloc_consistent enforces the alignment already and</span>
<span class="cm">       * clears the area as well.</span>
<span class="cm">       */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">array_size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs_dma</span><span class="p">);</span>
      <span class="cm">/* We have to use pci_free_consistent, not kfree */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_kmalloc_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs_dma_len</span> <span class="o">=</span> <span class="n">array_size</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(scsi%d) Unable to allocate hardware SCB array; &quot;</span>
             <span class="s">&quot;failing detection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">hscb_physaddr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs_dma</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hscb_physaddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">HSCB_ADDR</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">hscb_physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">HSCB_ADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">hscb_physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">HSCB_ADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">hscb_physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">HSCB_ADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

    <span class="cm">/* Set up the fifo areas at the same time */</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="mi">256</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fifo_dma</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;(scsi%d) Unable to allocate hardware FIFO arrays; &quot;</span>
             <span class="s">&quot;failing detection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hscb_physaddr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fifo_dma</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hscb_physaddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SCBID_ADDR</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">hscb_physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SCBID_ADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">hscb_physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SCBID_ADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">hscb_physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SCBID_ADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* The Q-FIFOs we just set up are all empty */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QINPOS</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QOUTPOS</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_QSIZE_256</span><span class="p">,</span> <span class="n">QOFF_CTLSTA</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDSCB_QOFF</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * We don&#39;t have any waiting selections or disconnected SCBs.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Message out buffer starts empty</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">,</span> <span class="n">LAST_MSG</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Set all the other asundry items that haven&#39;t been set yet.</span>
<span class="cm">   * This includes just dumping init values to a lot of registers simply</span>
<span class="cm">   * to make sure they&#39;ve been touched and are ready for use parity wise</span>
<span class="cm">   * speaking.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TMODE_CMDADDR</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TMODE_CMDADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TMODE_CMDADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TMODE_CMDADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TMODE_CMDADDR_NEXT</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Link us into the list of valid hosts</span>
<span class="cm">   */</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">first_aic7xxx</span><span class="p">;</span>
  <span class="n">first_aic7xxx</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Allocate the first set of scbs for this controller.  This is to stream-</span>
<span class="cm">   * line code elsewhere in the driver.  If we have to check for the existence</span>
<span class="cm">   * of scbs in certain code sections, it slows things down.  However, as</span>
<span class="cm">   * soon as we register the IRQ for this card, we could get an interrupt that</span>
<span class="cm">   * includes possibly the SCSI_RSTI interrupt.  If we catch that interrupt</span>
<span class="cm">   * then we are likely to segfault if we don&#39;t have at least one chunk of</span>
<span class="cm">   * SCBs allocated or add checks all through the reset code to make sure</span>
<span class="cm">   * that the SCBs have been allocated which is an invalid running condition</span>
<span class="cm">   * and therefore I think it&#39;s preferable to simply pre-allocate the first</span>
<span class="cm">   * chunk of SCBs.</span>
<span class="cm">   */</span>
  <span class="n">aic7xxx_allocate_scb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Load the sequencer program, then re-enable the board -</span>
<span class="cm">   * resetting the AIC-7770 disables it, leaving the lights</span>
<span class="cm">   * on with nobody home.</span>
<span class="cm">   */</span>
  <span class="n">aic7xxx_loadseq</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Make sure the AUTOFLUSHDIS bit is *not* set in the SBLKCTL register</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AUTOFLUSHDIS</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">,</span> <span class="n">BCTL</span><span class="p">);</span>  <span class="cm">/* Enable the boards BUS drivers. */</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">aic7xxx_no_reset</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Resetting channel B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SELBUSB</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
      <span class="n">aic7xxx_reset_current_bus</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* Reset SCSI bus A. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
    <span class="p">{</span>  <span class="cm">/* In case we are a 3940, 3985, or 7895, print the right channel */</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="s">&quot; A&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">))</span>
          <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHNLB</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; B&quot;</span> <span class="o">:</span> <span class="s">&quot; C&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Resetting channel%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">aic7xxx_reset_current_bus</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reset_delay</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) Not resetting SCSI bus.  Note: Don&#39;t use &quot;</span>
             <span class="s">&quot;the no_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;(scsi%d) option unless you have a verifiable need &quot;</span>
             <span class="s">&quot;for it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="cm">/*</span>
<span class="cm">   * Register IRQ with the kernel.  Only allow sharing IRQs with</span>
<span class="cm">   * PCI devices.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_PCI</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_aic7xxx_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;aic7xxx&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_aic7xxx_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
              <span class="s">&quot;aic7xxx&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_aic7xxx_isr</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
              <span class="s">&quot;aic7xxx&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;(scsi%d) Couldn&#39;t register IRQ %d, ignoring &quot;</span>
           <span class="s">&quot;controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;spurious interrupt during configuration, cleared.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">aic7xxx_clear_intstat</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="cm">/* unpause_always */</span> <span class="n">TRUE</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_chip_reset</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Perform a chip reset on the aic7xxx SCSI controller.  The controller</span>
<span class="cm"> *   is paused upon return.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sblkctl</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">wait</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * For some 274x boards, we must clear the CHIPRST bit and pause</span>
<span class="cm">   * the sequencer. For some reason, this makes the driver work.</span>
<span class="cm">   */</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PAUSE</span> <span class="o">|</span> <span class="n">CHIPRST</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * In the future, we may call this function as a last resort for</span>
<span class="cm">   * error handling.  Let&#39;s be nice and not do any unnecessary delays.</span>
<span class="cm">   */</span>
  <span class="n">wait</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>  <span class="cm">/* 1 msec (1000 * 1 msec) */</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CHIPRSTACK</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="cm">/* 1 usec */</span>
  <span class="p">}</span>

  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="n">sblkctl</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SELBUSB</span><span class="o">|</span><span class="n">SELWIDE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_PCI</span><span class="p">)</span>
    <span class="n">sblkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">;</span>
  <span class="k">switch</span><span class="p">(</span> <span class="n">sblkctl</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span>:  <span class="cm">/* normal narrow card */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span>:  <span class="cm">/* Wide card */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">AHC_WIDE</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">8</span>:  <span class="cm">/* Twin card */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">AHC_TWIN</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="cm">/* hmmm...we don&#39;t know what this is */</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aic7xxx: Unsupported adapter type %d, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0a</span><span class="p">);</span>
      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_alloc</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Allocate and initialize a host structure.  Returns NULL upon error</span>
<span class="cm"> *   and a pointer to a aic7xxx_host struct upon success.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span>
<span class="nf">aic7xxx_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">temp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Allocate a storage area by registering us with the mid-level</span>
<span class="cm">   * SCSI layer.</span>
<span class="cm">   */</span>
  <span class="n">host</span> <span class="o">=</span> <span class="n">scsi_register</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span><span class="p">));</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

    <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">scb_data_type</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scbq_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * For some reason we don&#39;t have enough memory.  Free the</span>
<span class="cm">       * allocated memory for the aic7xxx_host struct, and return NULL.</span>
<span class="cm">       */</span>
      <span class="n">release_region</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">MAXREG</span> <span class="o">-</span> <span class="n">MINREG</span><span class="p">);</span>
      <span class="n">scsi_unregister</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
      <span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_free</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Frees and releases all resources associated with an instance of</span>
<span class="cm"> *   the driver (struct aic7xxx_host *).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Free the allocated hardware SCB space.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">aic7xxx_scb_dma</span> <span class="o">*</span><span class="n">scb_dma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs_dma_len</span><span class="p">,</span>
			  <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs_dma</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_kmalloc_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * Free the driver SCBs.  These were allocated on an as-need</span>
<span class="cm">     * basis.  We allocated these in groups depending on how many</span>
<span class="cm">     * we could fit into a given amount of RAM.  The tail SCB for</span>
<span class="cm">     * these allocations has a pointer to the alloced area.</span>
<span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scb_dma</span> <span class="o">!=</span> <span class="n">scb_dma</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="n">scb_dma</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scb_dma</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_address</span>
                                     <span class="o">-</span> <span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">),</span>
			    <span class="n">scb_dma</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">kmalloc_ptr</span><span class="p">);</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="cm">/*</span>
<span class="cm">     * Free the SCB data area.</span>
<span class="cm">     */</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">untagged_scbs</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fifo_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_load_seeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Load the seeprom and configure adapter and target settings.</span>
<span class="cm"> *   Returns 1 if the load was successful and 0 otherwise.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_load_seeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sxfrctl1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">have_seeprom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_targets</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">scsi_conf</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">scarray</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">seeprom_config</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seeprom_config</span> <span class="o">*</span><span class="p">)</span> <span class="n">scarray</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: Loading serial EEPROM...&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_EISA</span><span class="p">)</span>:  <span class="cm">/* None of these adapters have seeproms. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TERM_ENB</span><span class="p">)</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_A</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSICONF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TERM_ENB</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_B</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="p">(</span><span class="n">AHC_AIC7770</span><span class="o">|</span><span class="n">AHC_VL</span><span class="p">)</span>:
      <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_284x_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seeprom_config</span> <span class="o">*</span><span class="p">)</span> <span class="n">scarray</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
      <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">)),</span>
                                  <span class="n">scarray</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_type</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_seeprom</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_type</span> <span class="o">==</span> <span class="n">C46</span><span class="p">)</span>
          <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">)),</span>
                                      <span class="n">scarray</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">C56_66</span><span class="p">);</span>
        <span class="k">else</span>
          <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">)),</span>
                                      <span class="n">scarray</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">C46</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_seeprom</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">)),</span>
                                    <span class="n">scarray</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_type</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_seeprom</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_type</span> <span class="o">==</span> <span class="n">C46</span><span class="p">)</span>
            <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">)),</span>
                                        <span class="n">scarray</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">C56_66</span><span class="p">);</span>
          <span class="k">else</span>
            <span class="n">have_seeprom</span> <span class="o">=</span> <span class="n">read_seeprom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_CHNLB</span><span class="o">|</span><span class="n">AHC_CHNLC</span><span class="p">)),</span>
                                        <span class="n">scarray</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_size</span><span class="p">,</span> <span class="n">C46</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_seeprom</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">aic7xxx: No SEEPROM available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_NEWEEPROM_FMT</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_USEDEFAULTS</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id_b</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
      <span class="o">*</span><span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Using default values.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Using leftover BIOS values.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_PCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">sxfrctl1</span> <span class="o">&amp;</span> <span class="n">STPWEN</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_LOW</span> <span class="o">|</span> <span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
      <span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFAUTOTERM</span><span class="p">;</span>
      <span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">|=</span> <span class="n">CFSTERM</span> <span class="o">|</span> <span class="n">CFWSTERM</span> <span class="o">|</span> <span class="n">CFLVDSTERM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_extended</span><span class="p">)</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AHC_EXTEND_TRANS_A</span> <span class="o">|</span> <span class="n">AHC_EXTEND_TRANS_B</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AHC_EXTEND_TRANS_A</span> <span class="o">|</span> <span class="n">AHC_EXTEND_TRANS_B</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Note things in our flags</span>
<span class="cm">     */</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_SEEPROM_FOUND</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Update the settings in sxfrctl1 to match the termination settings.</span>
<span class="cm">     */</span>
    <span class="o">*</span><span class="n">sxfrctl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Get our SCSI ID from the SEEPROM setting...</span>
<span class="cm">     */</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">brtime_id</span> <span class="o">&amp;</span> <span class="n">CFSCSIID</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * First process the settings that are different between the VLB</span>
<span class="cm">     * and PCI adapter seeproms.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* VLB adapter seeproms */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="n">CF284XEXTEND</span><span class="p">)</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_EXTEND_TRANS_A</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CF284XSTERM</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="o">*</span><span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_LOW</span> <span class="o">|</span> <span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/* PCI adapter seeproms */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="n">CFEXTEND</span><span class="p">)</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_EXTEND_TRANS_A</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="n">CFBIOSEN</span><span class="p">)</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFSTERM</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="o">*</span><span class="n">sxfrctl1</span> <span class="o">|=</span> <span class="n">STPWEN</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TERM_ENB_SE_LOW</span> <span class="o">|</span> <span class="n">AHC_TERM_ENB_SE_HIGH</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">seeprom_config</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Limit to 16 targets just in case.  The 2842 for one is known to</span>
<span class="cm">   * blow the max_targets setting, future cards might also.</span>
<span class="cm">   */</span>
  <span class="n">max_targets</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_TWIN</span> <span class="o">|</span> <span class="n">AHC_WIDE</span><span class="p">))</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">have_seeprom</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_targets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFULTRAEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFSYNCHISULTRA</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFNEWULTRAFORMAT</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_NEWEEPROM_FMT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_targets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_seeprom</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * OK...the BIOS set things up and left behind the settings we need.</span>
<span class="cm">         * Just make our sc-&gt;device_flags[i] entry match what the card has</span>
<span class="cm">         * set for this device.</span>
<span class="cm">         */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">=</span>
	  <span class="o">~</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DISC_DSB</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DISC_DSB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">=</span>
          <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ULTRA_ENB</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ULTRA_ENB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="n">CFDISC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">)</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFWIDEB</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_OFFSET</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFSYNCH</span><span class="p">;</span>
            <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x18</span> <span class="p">)</span>
              <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFSYNCHISULTRA</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WIDEXFER</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFSYNCH</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span>
              <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span>
                                      <span class="n">CFSYNCHISULTRA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Assume the BIOS has NOT been run on this card and nothing between</span>
<span class="cm">         * the card and the devices is configured yet.</span>
<span class="cm">         */</span>
        <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CFDISC</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFWIDEB</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA3</span><span class="p">)</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFSYNCHISULTRA</span><span class="p">;</span>
        <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFSYNCH</span><span class="p">;</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TARG_OFFSET</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFDISC</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_NEWEEPROM_FMT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * I know of two different Ultra BIOSes that do this differently.</span>
<span class="cm">         * One on the Gigabyte 6BXU mb that wants flags[i] &amp; CFXFER to</span>
<span class="cm">         * be == to 0x03 and SYNCHISULTRA to be true to mean 40MByte/s</span>
<span class="cm">         * while on the IBM Netfinity 5000 they want the same thing</span>
<span class="cm">         * to be something else, while flags[i] &amp; CFXFER == 0x03 and</span>
<span class="cm">         * SYNCHISULTRA false should be 40MByte/s.  So, we set both to</span>
<span class="cm">         * 40MByte/s and the lower speeds be damned.  People will have</span>
<span class="cm">         * to select around the conversely mapped lower speeds in order</span>
<span class="cm">         * to select lower speeds on these boards.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFNEWULTRAFORMAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFXFER</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFXFER</span><span class="p">;</span>
          <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CFSYNCHISULTRA</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFSYNCHISULTRA</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFNEWULTRAFORMAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFSYNCHISULTRA</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFULTRAEN</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFSYNCH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFXFER</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA3</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFXFER</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x03</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">scsirate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFXFER</span><span class="p">);</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span> <span class="o">=</span> <span class="n">MSG_EXT_PPR_OPTION_DT_CRC</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">scsirate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFXFER</span><span class="p">)</span> <span class="o">|</span>
                     <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x18</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">);</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="n">aic7xxx_find_period</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span>
                                       <span class="n">AHC_SYNCRATE_ULTRA3</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
        <span class="n">scsirate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFXFER</span><span class="p">)</span> <span class="o">|</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x18</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="n">aic7xxx_find_period</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span>
                                       <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">scsirate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFXFER</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kt">short</span> <span class="n">ultraenb</span><span class="p">;</span>
          <span class="n">ultraenb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ULTRA_ENB</span><span class="p">)</span> <span class="o">|</span>
            <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ULTRA_ENB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="n">aic7xxx_find_period</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span>
                                          <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span>
                                          <span class="n">AHC_SYNCRATE_ULTRA</span> <span class="o">:</span>
                                          <span class="n">AHC_SYNCRATE_FAST</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="n">aic7xxx_find_period</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span>
			  		  <span class="n">AHC_SYNCRATE_FAST</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CFWIDEB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="n">DISC_DSB</span><span class="p">);</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">~</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="n">DISC_DSB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * We set the p-&gt;ultraenb from the SEEPROM to begin with, but now we make</span>
<span class="cm">   * it match what is already down in the card.  If we are doing a reset</span>
<span class="cm">   * on the card then this will get put back to a default state anyway.</span>
<span class="cm">   * This allows us to not have to pre-emptively negotiate when using the</span>
<span class="cm">   * no_reset option.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ULTRA_ENB</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ULTRA_ENB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

  
  <span class="n">scsi_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">&amp;</span> <span class="n">HSCSIID</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">have_seeprom</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">bios_control</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="n">AHC_AIC7895</span>:
      <span class="k">case</span> <span class="n">AHC_AIC7896</span>:
      <span class="k">case</span> <span class="n">AHC_AIC7899</span>:
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFBPRIMARY</span><span class="p">)</span>
          <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_CHANNEL_B_PRIMARY</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">CFSPARITY</span><span class="p">)</span>
      <span class="n">scsi_conf</span> <span class="o">|=</span> <span class="n">ENSPCHK</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">scsi_conf</span> <span class="o">|=</span> <span class="n">ENSPCHK</span> <span class="o">|</span> <span class="n">RESET_SCSI</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Only set the SCSICONF and SCSICONF + 1 registers if we are a PCI card.</span>
<span class="cm">   * The 2842 and 2742 cards already have these registers set and we don&#39;t</span>
<span class="cm">   * want to muck with them since we don&#39;t set all the bits they do.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_PCI</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Set the host ID */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scsi_conf</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">);</span>
    <span class="cm">/* In case we are a wide card */</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span> <span class="n">SCSICONF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_configure_bugs</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Take the card passed in and set the appropriate bug flags based upon</span>
<span class="cm"> *   the card model.  Also make any changes needed to device registers or</span>
<span class="cm"> *   PCI registers while we are here.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_configure_bugs</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmp_word</span><span class="p">;</span>
 
  <span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">AHC_AIC7860</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_PCI_2_1_RETRY</span><span class="p">;</span>
      <span class="cm">/* fall through */</span>
    <span class="k">case</span> <span class="n">AHC_AIC7850</span>:
    <span class="k">case</span> <span class="n">AHC_AIC7870</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_TMODE_WIDEODD</span> <span class="o">|</span> <span class="n">AHC_BUG_CACHETHEN</span> <span class="o">|</span> <span class="n">AHC_BUG_PCI_MWI</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_AIC7880</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_TMODE_WIDEODD</span> <span class="o">|</span> <span class="n">AHC_BUG_PCI_2_1_RETRY</span> <span class="o">|</span>
                 <span class="n">AHC_BUG_CACHETHEN</span> <span class="o">|</span> <span class="n">AHC_BUG_PCI_MWI</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_AIC7890</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_AUTOFLUSH</span> <span class="o">|</span> <span class="n">AHC_BUG_CACHETHEN</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_AIC7892</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_SCBCHAN_UPLOAD</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_AIC7895</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_TMODE_WIDEODD</span> <span class="o">|</span> <span class="n">AHC_BUG_PCI_2_1_RETRY</span> <span class="o">|</span>
                 <span class="n">AHC_BUG_CACHETHEN</span> <span class="o">|</span> <span class="n">AHC_BUG_PCI_MWI</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_AIC7896</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_CACHETHEN_DIS</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_AIC7899</span>:
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_SCBCHAN_UPLOAD</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="cm">/* Nothing to do */</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * Now handle the bugs that require PCI register or card register tweaks</span>
<span class="cm">   */</span>
  <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_word</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">&amp;</span> <span class="n">AHC_BUG_PCI_MWI</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">tmp_word</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">tmp_word</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">tmp_word</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">&amp;</span> <span class="n">AHC_BUG_CACHETHEN</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CACHETHEN</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">&amp;</span> <span class="n">AHC_BUG_CACHETHEN_DIS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">|</span> <span class="n">CACHETHEN</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_detect</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Try to detect and register an Adaptec 7770 or 7870 SCSI controller.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX - This should really be called aic7xxx_probe().  A sequence of</span>
<span class="cm"> *       probe(), attach()/detach(), and init() makes more sense than</span>
<span class="cm"> *       one do-it-all function.  This may be useful when (and if) the</span>
<span class="cm"> *       mid-level SCSI code is overhauled.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">template</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">temp_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">current_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">list_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(__i386__) || defined(__alpha__)</span>
  <span class="n">ahc_flag_type</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sxfrctl1</span><span class="p">;</span>
<span class="cp">#if defined(__i386__) || defined(__alpha__)</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hcntrl</span><span class="p">,</span> <span class="n">hostconf</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
  <span class="cm">/*</span>
<span class="cm">   * If we are called as a module, the aic7xxx pointer may not be null</span>
<span class="cm">   * and it would point to our bootup string, just like on the lilo</span>
<span class="cm">   * command line.  IF not NULL, then process this config string with</span>
<span class="cm">   * aic7xxx_setup</span>
<span class="cm">   */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx</span><span class="p">)</span>
    <span class="n">aic7xxx_setup</span><span class="p">(</span><span class="n">aic7xxx</span><span class="p">);</span>
<span class="cp">#endif</span>

  <span class="n">template</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;aic7xxx&quot;</span><span class="p">;</span>
  <span class="n">template</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">AIC7XXX_MAX_SG</span><span class="p">;</span>


<span class="cp">#ifdef CONFIG_PCI</span>
  <span class="cm">/*</span>
<span class="cm">   * PCI-bus probe.</span>
<span class="cm">   */</span>
  <span class="p">{</span>
    <span class="k">static</span> <span class="k">struct</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">vendor_id</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">device_id</span><span class="p">;</span>
      <span class="n">ahc_chip</span>            <span class="n">chip</span><span class="p">;</span>
      <span class="n">ahc_flag_type</span>       <span class="n">flags</span><span class="p">;</span>
      <span class="n">ahc_feature</span>         <span class="n">features</span><span class="p">;</span>
      <span class="kt">int</span>                 <span class="n">board_name_index</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">seeprom_size</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">seeprom_type</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">const</span> <span class="n">aic_pdevs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7810</span><span class="p">,</span> <span class="n">AHC_NONE</span><span class="p">,</span>
       <span class="n">AHC_FNONE</span><span class="p">,</span> <span class="n">AHC_FENONE</span><span class="p">,</span>                                <span class="mi">1</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7850</span><span class="p">,</span> <span class="n">AHC_AIC7850</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span><span class="p">,</span> <span class="n">AHC_AIC7850_FE</span><span class="p">,</span>                         <span class="mi">5</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7855</span><span class="p">,</span> <span class="n">AHC_AIC7850</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span><span class="p">,</span> <span class="n">AHC_AIC7850_FE</span><span class="p">,</span>                         <span class="mi">6</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7821</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                       <span class="mi">7</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_3860</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                       <span class="mi">7</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_38602</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                       <span class="mi">7</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_38602</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                       <span class="mi">7</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7860</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MOTHERBOARD</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                       <span class="mi">7</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7861</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                       <span class="mi">8</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7870</span><span class="p">,</span> <span class="n">AHC_AIC7870</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MOTHERBOARD</span><span class="p">,</span>
       <span class="n">AHC_AIC7870_FE</span><span class="p">,</span>                                       <span class="mi">9</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7871</span><span class="p">,</span> <span class="n">AHC_AIC7870</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7870_FE</span><span class="p">,</span>     <span class="mi">10</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7872</span><span class="p">,</span> <span class="n">AHC_AIC7870</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7870_FE</span><span class="p">,</span>                                      <span class="mi">11</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7873</span><span class="p">,</span> <span class="n">AHC_AIC7870</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7870_FE</span><span class="p">,</span>                                      <span class="mi">12</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7874</span><span class="p">,</span> <span class="n">AHC_AIC7870</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7870_FE</span><span class="p">,</span>     <span class="mi">13</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7880</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MOTHERBOARD</span><span class="p">,</span>
       <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>                                      <span class="mi">14</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7881</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>     <span class="mi">15</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7882</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>                                      <span class="mi">16</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7883</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>                                      <span class="mi">17</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7884</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>     <span class="mi">18</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7885</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>     <span class="mi">18</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7886</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>     <span class="mi">18</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7887</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7880_FE</span> <span class="o">|</span> <span class="n">AHC_NEW_AUTOTERM</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7888</span><span class="p">,</span> <span class="n">AHC_AIC7880</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span> <span class="n">AHC_AIC7880_FE</span><span class="p">,</span>     <span class="mi">18</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_7895</span><span class="p">,</span> <span class="n">AHC_AIC7895</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7895_FE</span><span class="p">,</span>                                      <span class="mi">20</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7890</span><span class="p">,</span> <span class="n">AHC_AIC7890</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7890_FE</span><span class="p">,</span>                                      <span class="mi">21</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7890B</span><span class="p">,</span> <span class="n">AHC_AIC7890</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7890_FE</span><span class="p">,</span>                                      <span class="mi">21</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_2930U2</span><span class="p">,</span> <span class="n">AHC_AIC7890</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7890_FE</span><span class="p">,</span>                                      <span class="mi">22</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_2940U2</span><span class="p">,</span> <span class="n">AHC_AIC7890</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7890_FE</span><span class="p">,</span>                                      <span class="mi">23</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7896</span><span class="p">,</span> <span class="n">AHC_AIC7896</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7896_FE</span><span class="p">,</span>                                      <span class="mi">24</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_3940U2</span><span class="p">,</span> <span class="n">AHC_AIC7896</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7896_FE</span><span class="p">,</span>                                      <span class="mi">25</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_3950U2D</span><span class="p">,</span> <span class="n">AHC_AIC7896</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7896_FE</span><span class="p">,</span>                                      <span class="mi">26</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC_1480A</span><span class="p">,</span> <span class="n">AHC_AIC7860</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_NO_STPWEN</span><span class="p">,</span>
       <span class="n">AHC_AIC7860_FE</span><span class="p">,</span>                                      <span class="mi">27</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7892A</span><span class="p">,</span> <span class="n">AHC_AIC7892</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7892_FE</span><span class="p">,</span>                                      <span class="mi">28</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7892B</span><span class="p">,</span> <span class="n">AHC_AIC7892</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7892_FE</span><span class="p">,</span>                                      <span class="mi">28</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7892D</span><span class="p">,</span> <span class="n">AHC_AIC7892</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7892_FE</span><span class="p">,</span>                                      <span class="mi">28</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7892P</span><span class="p">,</span> <span class="n">AHC_AIC7892</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">,</span>
       <span class="n">AHC_AIC7892_FE</span><span class="p">,</span>                                      <span class="mi">28</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C46</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7899A</span><span class="p">,</span> <span class="n">AHC_AIC7899</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7899_FE</span><span class="p">,</span>                                      <span class="mi">29</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7899B</span><span class="p">,</span> <span class="n">AHC_AIC7899</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7899_FE</span><span class="p">,</span>                                      <span class="mi">29</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7899D</span><span class="p">,</span> <span class="n">AHC_AIC7899</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7899_FE</span><span class="p">,</span>                                      <span class="mi">29</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
      <span class="p">{</span><span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_7899P</span><span class="p">,</span> <span class="n">AHC_AIC7899</span><span class="p">,</span>
       <span class="n">AHC_PAGESCBS</span> <span class="o">|</span> <span class="n">AHC_NEWEEPROM_FMT</span> <span class="o">|</span> <span class="n">AHC_BIOS_ENABLED</span> <span class="o">|</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">,</span>
       <span class="n">AHC_AIC7899_FE</span><span class="p">,</span>                                      <span class="mi">29</span><span class="p">,</span>
       <span class="mi">32</span><span class="p">,</span> <span class="n">C56_66</span> <span class="p">},</span>
    <span class="p">};</span>

    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">command</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">devconfig</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">oldverbose</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">aic_pdevs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">((</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_id</span><span class="p">,</span>
                                     <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_id</span><span class="p">,</span>
                                     <span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="cm">/* We found one, but it&#39;s the 7810 RAID cont. */</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VERBOSE_PROBE</span><span class="o">|</span><span class="n">VERBOSE_PROBE2</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: The 7810 RAID controller is not &quot;</span>
              <span class="s">&quot;supported by</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;         this driver, we are ignoring it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">temp_p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span><span class="p">),</span>
                                    <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chip</span> <span class="o">|</span> <span class="n">AHC_PCI</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">features</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">board_name_index</span> <span class="o">=</span> <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">sc_size</span> <span class="o">=</span> <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seeprom_size</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">sc_type</span> <span class="o">=</span> <span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seeprom_type</span><span class="p">;</span>

          <span class="cm">/*</span>
<span class="cm">           * Read sundry information from PCI BIOS.</span>
<span class="cm">           */</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">current_p</span> <span class="o">=</span> <span class="n">list_p</span><span class="p">;</span>
	  <span class="k">while</span><span class="p">(</span><span class="n">current_p</span> <span class="o">&amp;&amp;</span> <span class="n">temp_p</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">==</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	          <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span> <span class="o">==</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">))</span> <span class="o">||</span>
                 <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="o">||</span>
                 <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">mbase</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">mbase</span> <span class="o">==</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">mbase</span><span class="p">))</span> <span class="p">)</span>
	    <span class="p">{</span>
              <span class="cm">/* duplicate PCI entry, skip it */</span>
	      <span class="n">kfree</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>
	      <span class="n">temp_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
              <span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	  <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;aic7xxx&quot;</span><span class="p">))</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
              <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
              <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span>
              <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
              <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: I/O ports already in use, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">kfree</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
              <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
              <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
              <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
          <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Initial PCI_COMMAND value was 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
              <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">command</span><span class="p">);</span>
          <span class="p">}</span>
<span class="cp">#ifdef AIC7XXX_STRICT_PCI_SETUP</span>
          <span class="n">command</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span>
            <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
<span class="cp">#else</span>
          <span class="n">command</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
<span class="cp">#endif</span>
          <span class="n">command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_pci_parity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_COMMAND_SERR</span> <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span><span class="p">);</span>
          <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
<span class="cp">#ifdef AIC7XXX_STRICT_PCI_SETUP</span>
          <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devconfig</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Initial DEVCONFIG value was 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devconfig</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">devconfig</span> <span class="o">|=</span> <span class="mh">0x80000040</span><span class="p">;</span>
          <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="n">devconfig</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* AIC7XXX_STRICT_PCI_SETUP */</span><span class="cp"></span>

          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">=</span> <span class="n">INTEN</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">|</span> <span class="n">PAUSE</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">mbase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
               <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
              <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
              <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span>
              <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
              <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Controller disabled by BIOS, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">skip_pci_controller</span><span class="p">;</span>
          <span class="p">}</span>

<span class="cp">#ifdef MMAPIO</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">)</span> <span class="o">||</span>
               <span class="p">((</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="p">(</span><span class="n">AHC_AIC7870</span> <span class="o">|</span> <span class="n">AHC_PCI</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="p">(</span><span class="n">AHC_AIC7880</span> <span class="o">|</span> <span class="n">AHC_PCI</span><span class="p">)))</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">mbase</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="cm">/*</span>
<span class="cm">               * We need to check the I/O with the MMAPed address.  Some machines</span>
<span class="cm">               * simply fail to work with MMAPed I/O and certain controllers.</span>
<span class="cm">               */</span>
              <span class="k">if</span><span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * OK.....we failed our test....go back to programmed I/O</span>
<span class="cm">                 */</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                  <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
                  <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span>
                  <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
                  <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: MMAPed I/O failed, reverting to &quot;</span>
                                 <span class="s">&quot;Programmed I/O.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">);</span>
                <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                    <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span>
                    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
                    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
                  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Controller disabled by BIOS, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                  <span class="k">goto</span> <span class="n">skip_pci_controller</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
<span class="cp">#endif</span>

          <span class="cm">/*</span>
<span class="cm">           * We HAVE to make sure the first pause_sequencer() and all other</span>
<span class="cm">           * subsequent I/O that isn&#39;t PCI config space I/O takes place</span>
<span class="cm">           * after the MMAPed I/O region is configured and tested.  The</span>
<span class="cm">           * problem is the PowerPC architecture that doesn&#39;t support</span>
<span class="cm">           * programmed I/O at all, so we have to have the MMAP I/O set up</span>
<span class="cm">           * for this pause to even work on those machines.</span>
<span class="cm">           */</span>
          <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>

          <span class="cm">/*</span>
<span class="cm">           * Clear out any pending PCI error status messages.  Also set</span>
<span class="cm">           * verbose to 0 so that we don&#39;t emit strange PCI error messages</span>
<span class="cm">           * while cleaning out the current status bits.</span>
<span class="cm">           */</span>
          <span class="n">oldverbose</span> <span class="o">=</span> <span class="n">aic7xxx_verbose</span><span class="p">;</span>
          <span class="n">aic7xxx_verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">aic7xxx_pci_intr</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>
          <span class="n">aic7xxx_verbose</span> <span class="o">=</span> <span class="n">oldverbose</span><span class="p">;</span>

          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

          <span class="cm">/*</span>
<span class="cm">           * Remember how the card was setup in case there is no seeprom.</span>
<span class="cm">           */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SCSIID_ULTRA2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OID</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OID</span><span class="p">;</span>
          <span class="cm">/*</span>
<span class="cm">           * Get current termination setting</span>
<span class="cm">           */</span>
          <span class="n">sxfrctl1</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_chip_reset</span><span class="p">(</span><span class="n">temp_p</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">goto</span> <span class="n">skip_pci_controller</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="cm">/*</span>
<span class="cm">           * Very quickly put the term setting back into the register since</span>
<span class="cm">           * the chip reset may cause odd things to happen.  This is to keep</span>
<span class="cm">           * LVD busses with lots of drives from draining the power out of</span>
<span class="cm">           * the diffsense line before we get around to running the</span>
<span class="cm">           * configure_termination() function.  Also restore the STPWLEVEL</span>
<span class="cm">           * bit of DEVCONFIG</span>
<span class="cm">           */</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">sxfrctl1</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>
          <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="n">devconfig</span><span class="p">);</span>
          <span class="n">sxfrctl1</span> <span class="o">&amp;=</span> <span class="n">STPWEN</span><span class="p">;</span>

          <span class="cm">/*</span>
<span class="cm">           * We need to set the CHNL? assignments before loading the SEEPROM</span>
<span class="cm">           * The 3940 and 3985 cards (original stuff, not any of the later</span>
<span class="cm">           * stuff) are 7870 and 7880 class chips.  The Ultra2 stuff falls</span>
<span class="cm">           * under 7896 and 7897.  The 7895 is in a class by itself :)</span>
<span class="cm">           */</span>
          <span class="k">switch</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="n">AHC_AIC7870</span>: <span class="cm">/* 3840 / 3985 */</span>
            <span class="k">case</span> <span class="n">AHC_AIC7880</span>: <span class="cm">/* 3840 UW / 3985 UW */</span>
              <span class="k">if</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">switch</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">))</span>
                <span class="p">{</span>
                  <span class="k">case</span> <span class="mi">5</span>:
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_CHNLB</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                  <span class="k">case</span> <span class="mi">8</span>:
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_CHNLB</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                  <span class="k">case</span> <span class="mi">12</span>:
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_CHNLC</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                  <span class="nl">default:</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">AHC_AIC7895</span>: <span class="cm">/* 7895 */</span>
            <span class="k">case</span> <span class="n">AHC_AIC7896</span>: <span class="cm">/* 7896/7 */</span>
            <span class="k">case</span> <span class="n">AHC_AIC7899</span>: <span class="cm">/* 7899 */</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_CHNLB</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="cm">/*</span>
<span class="cm">               * The 7895 is the only chipset that sets the SCBSIZE32 param</span>
<span class="cm">               * in the DEVCONFIG register.  The Ultra2 chipsets use</span>
<span class="cm">               * the DSCOMMAND0 register instead.</span>
<span class="cm">               */</span>
              <span class="k">if</span> <span class="p">((</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7895</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devconfig</span><span class="p">);</span>
                <span class="n">devconfig</span> <span class="o">|=</span> <span class="n">SCBSIZE32</span><span class="p">;</span>
                <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="n">devconfig</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="nl">default:</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="cm">/*</span>
<span class="cm">           * Loading of the SEEPROM needs to come after we&#39;ve set the flags</span>
<span class="cm">           * to indicate possible CHNLB and CHNLC assigments.  Otherwise,</span>
<span class="cm">           * on 394x and 398x cards we&#39;ll end up reading the wrong settings</span>
<span class="cm">           * for channels B and C</span>
<span class="cm">           */</span>
          <span class="k">switch</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="n">AHC_AIC7892</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7899</span>:
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCAMCTL</span><span class="p">);</span>
              <span class="cm">/*</span>
<span class="cm">               * Switch to the alt mode of the chip...</span>
<span class="cm">               */</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SFUNCT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ALT_MODE</span><span class="p">,</span> <span class="n">SFUNCT</span><span class="p">);</span>
              <span class="cm">/*</span>
<span class="cm">               * Set our options...the last two items set our CRC after x byte</span>
<span class="cm">	       * count in target mode...</span>
<span class="cm">               */</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">AUTO_MSGOUT_DE</span> <span class="o">|</span> <span class="n">DIS_MSGIN_DUALEDGE</span><span class="p">,</span> <span class="n">OPTIONMODE</span><span class="p">);</span>
	      <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>
	      <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
              <span class="cm">/*</span>
<span class="cm">               * switch back to normal mode...</span>
<span class="cm">               */</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SFUNCT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ALT_MODE</span><span class="p">,</span> <span class="n">SFUNCT</span><span class="p">);</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">CRCVALCHKEN</span> <span class="o">|</span> <span class="n">CRCENDCHKEN</span> <span class="o">|</span> <span class="n">CRCREQCHKEN</span> <span class="o">|</span>
			       <span class="n">TARGCRCENDEN</span> <span class="o">|</span> <span class="n">TARGCRCCNTEN</span><span class="p">,</span>
                       <span class="n">CRCCONTROL1</span><span class="p">);</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">|</span> <span class="n">USCBSIZE32</span> <span class="o">|</span>
                                 <span class="n">MPARCKEN</span> <span class="o">|</span> <span class="n">CIOPARCKEN</span> <span class="o">|</span> <span class="n">CACHETHEN</span><span class="p">)</span> <span class="o">&amp;</span> 
                               <span class="o">~</span><span class="n">DPARCKEN</span><span class="p">),</span> <span class="n">DSCOMMAND0</span><span class="p">);</span>
              <span class="n">aic7xxx_load_seeprom</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sxfrctl1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AHC_AIC7890</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7896</span>:
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCAMCTL</span><span class="p">);</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">|</span>
                                <span class="n">CACHETHEN</span> <span class="o">|</span> <span class="n">MPARCKEN</span> <span class="o">|</span> <span class="n">USCBSIZE32</span> <span class="o">|</span>
                                <span class="n">CIOPARCKEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPARCKEN</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">);</span>
              <span class="n">aic7xxx_load_seeprom</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sxfrctl1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AHC_AIC7850</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7860</span>:
              <span class="cm">/*</span>
<span class="cm">               * Set the DSCOMMAND0 register on these cards different from</span>
<span class="cm">               * on the 789x cards.  Also, read the SEEPROM as well.</span>
<span class="cm">               */</span>
              <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">|</span>
                                <span class="n">CACHETHEN</span> <span class="o">|</span> <span class="n">MPARCKEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPARCKEN</span><span class="p">,</span>
                       <span class="n">DSCOMMAND0</span><span class="p">);</span>
              <span class="cm">/* FALLTHROUGH */</span>
            <span class="nl">default:</span>
              <span class="n">aic7xxx_load_seeprom</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sxfrctl1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AHC_AIC7880</span>:
              <span class="cm">/*</span>
<span class="cm">               * Check the rev of the chipset before we change DSCOMMAND0</span>
<span class="cm">               */</span>
              <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devconfig</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">((</span><span class="n">devconfig</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">|</span>
                                  <span class="n">CACHETHEN</span> <span class="o">|</span> <span class="n">MPARCKEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPARCKEN</span><span class="p">,</span>
                         <span class="n">DSCOMMAND0</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="n">aic7xxx_load_seeprom</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sxfrctl1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          

          <span class="cm">/*</span>
<span class="cm">           * and then we need another switch based on the type in order to</span>
<span class="cm">           * make sure the channel B primary flag is set properly on 7895</span>
<span class="cm">           * controllers....Arrrgggghhh!!!  We also have to catch the fact</span>
<span class="cm">           * that when you disable the BIOS on the 7895 on the Intel DK440LX</span>
<span class="cm">           * motherboard, and possibly others, it only sets the BIOS disabled</span>
<span class="cm">           * bit on the A channel...I think I&#39;m starting to lean towards</span>
<span class="cm">           * going postal....</span>
<span class="cm">           */</span>
          <span class="k">switch</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">case</span> <span class="n">AHC_AIC7895</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7896</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7899</span>:
              <span class="n">current_p</span> <span class="o">=</span> <span class="n">list_p</span><span class="p">;</span>
              <span class="k">while</span><span class="p">(</span><span class="n">current_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">==</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                     <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">==</span>
                      <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">))</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                  <span class="p">{</span>
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> 
                      <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHANNEL_B_PRIMARY</span><span class="p">);</span>
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AHC_BIOS_ENABLED</span><span class="o">|</span><span class="n">AHC_USEDEFAULTS</span><span class="p">);</span>
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
                      <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_BIOS_ENABLED</span><span class="o">|</span><span class="n">AHC_USEDEFAULTS</span><span class="p">));</span>
                  <span class="p">}</span>
                  <span class="k">else</span>
                  <span class="p">{</span>
                    <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
                      <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHANNEL_B_PRIMARY</span><span class="p">);</span>
                    <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AHC_BIOS_ENABLED</span><span class="o">|</span><span class="n">AHC_USEDEFAULTS</span><span class="p">);</span>
                    <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
                      <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_BIOS_ENABLED</span><span class="o">|</span><span class="n">AHC_USEDEFAULTS</span><span class="p">));</span>
                  <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="nl">default:</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="cm">/*</span>
<span class="cm">           * We only support external SCB RAM on the 7895/6/7 chipsets.</span>
<span class="cm">           * We could support it on the 7890/1 easy enough, but I don&#39;t</span>
<span class="cm">           * know of any 7890/1 based cards that have it.  I do know</span>
<span class="cm">           * of 7895/6/7 cards that have it and they work properly.</span>
<span class="cm">           */</span>
          <span class="k">switch</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="nl">default:</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AHC_AIC7895</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7896</span>:
            <span class="k">case</span> <span class="n">AHC_AIC7899</span>:
              <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devconfig</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RAMPSM_ULTRA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                     <span class="p">(</span><span class="n">aic7xxx_scbram</span><span class="p">)</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span>
                           <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCBRAMSEL_ULTRA2</span><span class="p">,</span>
                           <span class="n">DSCOMMAND0</span><span class="p">);</span>
                  <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_EXTERNAL_SRAM</span><span class="p">;</span>
                  <span class="n">devconfig</span> <span class="o">|=</span> <span class="n">EXTSCBPEN</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DSCOMMAND0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RAMPSM_ULTRA2</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                    <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span>
                    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
                    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
                  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: external SCB RAM detected, &quot;</span>
                         <span class="s">&quot;but not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">devconfig</span> <span class="o">&amp;</span> <span class="n">RAMPSM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aic7xxx_scbram</span><span class="p">))</span>
                <span class="p">{</span>
                  <span class="n">devconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCBRAMSEL</span><span class="p">;</span>
                  <span class="n">devconfig</span> <span class="o">|=</span> <span class="n">EXTSCBPEN</span><span class="p">;</span>
                  <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_EXTERNAL_SRAM</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devconfig</span> <span class="o">&amp;</span> <span class="n">RAMPSM</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: &lt;%s&gt; at PCI %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                    <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">],</span>
                    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span>
                    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
                    <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
                  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: external SCB RAM detected, &quot;</span>
                         <span class="s">&quot;but not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEVCONFIG</span><span class="p">,</span> <span class="n">devconfig</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_EXTERNAL_SRAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHNLB</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CCSCBBADDR</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="cm">/*</span>
<span class="cm">           * Take the LED out of diagnostic mode</span>
<span class="cm">           */</span>
          <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> 
            <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DIAGLEDEN</span> <span class="o">|</span> <span class="n">DIAGLEDON</span><span class="p">)),</span>
            <span class="n">SBLKCTL</span><span class="p">);</span>

          <span class="cm">/*</span>
<span class="cm">           * We don&#39;t know where this is set in the SEEPROM or by the</span>
<span class="cm">           * BIOS, so we default to 100%.  On Ultra2 controllers, use 75%</span>
<span class="cm">           * instead.</span>
<span class="cm">           */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">RD_DFTHRSH_MAX</span> <span class="o">|</span> <span class="n">WR_DFTHRSH_MAX</span><span class="p">,</span> <span class="n">DFF_THRSH</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">DFTHRSH_100</span><span class="p">,</span> <span class="n">DSPCISTATUS</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="cm">/*</span>
<span class="cm">           * Call our function to fixup any bugs that exist on this chipset.</span>
<span class="cm">           * This may muck with PCI settings and other device settings, so</span>
<span class="cm">           * make sure it&#39;s after all the other PCI and device register</span>
<span class="cm">           * tweaks so it can back out bad settings on specific broken cards.</span>
<span class="cm">           */</span>
          <span class="n">aic7xxx_configure_bugs</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>

          <span class="cm">/* Hold a pci device reference */</span>
          <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span> <span class="n">list_p</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">list_p</span> <span class="o">=</span> <span class="n">current_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">current_p</span> <span class="o">=</span> <span class="n">list_p</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
              <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
          <span class="n">found</span><span class="o">++</span><span class="p">;</span>
	  <span class="k">continue</span><span class="p">;</span>
<span class="nl">skip_pci_controller:</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	  <span class="n">pci_release_regions</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>
	  <span class="n">kfree</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>
        <span class="p">}</span>  <span class="cm">/* Found an Adaptec PCI device. */</span>
        <span class="k">else</span> <span class="cm">/* Well, we found one, but we couldn&#39;t get any memory */</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: Found &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
            <span class="n">board_names</span><span class="p">[</span><span class="n">aic_pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_name_index</span><span class="p">]);</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: Unable to allocate device memory, &quot;</span>
            <span class="s">&quot;skipping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="cm">/* while(pdev=....) */</span>
    <span class="p">}</span> <span class="cm">/* for PCI_DEVICES */</span>
  <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#if defined(__i386__) || defined(__alpha__)</span>
  <span class="cm">/*</span>
<span class="cm">   * EISA/VL-bus card signature probe.</span>
<span class="cm">   */</span>
  <span class="n">slot</span> <span class="o">=</span> <span class="n">MINSLOT</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;=</span> <span class="n">MAXSLOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="o">!</span><span class="p">(</span><span class="n">aic7xxx_no_probe</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">SLOTBASE</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span> <span class="o">+</span> <span class="n">MINREG</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">MAXREG</span> <span class="o">-</span> <span class="n">MINREG</span><span class="p">,</span> <span class="s">&quot;aic7xxx&quot;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Some other driver has staked a</span>
<span class="cm">       * claim to this i/o region already.</span>
<span class="cm">       */</span>
      <span class="n">slot</span><span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span> <span class="cm">/* back to the beginning of the for loop */</span>
    <span class="p">}</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">aic7xxx_probe</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AHC_HID0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">MAXREG</span> <span class="o">-</span> <span class="n">MINREG</span><span class="p">);</span>
      <span class="n">slot</span><span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">temp_p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aic7xxx: Unable to allocate device space.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">MAXREG</span> <span class="o">-</span> <span class="n">MINREG</span><span class="p">);</span>
      <span class="n">slot</span><span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span> <span class="cm">/* back to the beginning of the while loop */</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Pause the card preserving the IRQ type.  Allow the operator</span>
<span class="cm">     * to override the IRQ trigger.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_irq_trigger</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">hcntrl</span> <span class="o">=</span> <span class="n">IRQMS</span><span class="p">;</span>  <span class="cm">/* Level */</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_irq_trigger</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">hcntrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Edge */</span>
    <span class="k">else</span>
      <span class="n">hcntrl</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQMS</span><span class="p">;</span>  <span class="cm">/* Default */</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span><span class="p">));</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">=</span> <span class="n">hcntrl</span> <span class="o">|</span> <span class="n">INTEN</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">=</span> <span class="n">hcntrl</span> <span class="o">|</span> <span class="n">PAUSE</span> <span class="o">|</span> <span class="n">INTEN</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">mbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">hcntrl</span> <span class="o">|</span> <span class="n">PAUSE</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_chip_reset</span><span class="p">(</span><span class="n">temp_p</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">INTDEF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_PAGESCBS</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">9</span>:
      <span class="k">case</span> <span class="mi">10</span>:
      <span class="k">case</span> <span class="mi">11</span>:
      <span class="k">case</span> <span class="mi">12</span>:
      <span class="k">case</span> <span class="mi">14</span>:
      <span class="k">case</span> <span class="mi">15</span>:
        <span class="k">break</span><span class="p">;</span>

      <span class="nl">default:</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aic7xxx: Host adapter uses unsupported IRQ &quot;</span>
          <span class="s">&quot;level %d, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">temp_p</span><span class="p">);</span>
        <span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">MAXREG</span> <span class="o">-</span> <span class="n">MINREG</span><span class="p">);</span>
        <span class="n">slot</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span> <span class="cm">/* back to the beginning of the while loop */</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * We are committed now, everything has been checked and this card</span>
<span class="cm">     * has been found, now we just set it up</span>
<span class="cm">     */</span>

    <span class="cm">/*</span>
<span class="cm">     * Insert our new struct into the list at the end</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">list_p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">list_p</span> <span class="o">=</span> <span class="n">current_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">current_p</span> <span class="o">=</span> <span class="n">list_p</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span>:
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">board_name_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at EISA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">board_names</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">slot</span><span class="p">);</span>
        <span class="cm">/* FALLTHROUGH */</span>
      <span class="k">case</span> <span class="mi">1</span>:
      <span class="p">{</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">AHC_AIC7770</span> <span class="o">|</span> <span class="n">AHC_EISA</span><span class="p">;</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">AHC_AIC7770_FE</span><span class="p">;</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">HA_274_BIOSCTRL</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * Get the primary channel information.  Right now we don&#39;t</span>
<span class="cm">         * do anything with this, but someday we will be able to inform</span>
<span class="cm">         * the mid-level SCSI code which channel is primary.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">board_name_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">board_name_index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at EISA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">board_names</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">slot</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="n">CHANNEL_B_PRIMARY</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_CHANNEL_B_PRIMARY</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="n">BIOSMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">BIOSDISABLED</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_USEDEFAULTS</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mh">0xcc000</span><span class="p">;</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x4000</span> <span class="o">*</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mh">0xd0000</span><span class="p">;</span>
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">*</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_control</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">|=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SCSICONF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">HWSCSIID</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id_b</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HSCSIID</span><span class="p">;</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">scsi_id_b</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">adapter_control</span> <span class="o">&amp;</span> <span class="n">HSCSIID</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">aic7xxx_load_seeprom</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sxfrctl1</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">case</span> <span class="mi">2</span>:
      <span class="k">case</span> <span class="mi">3</span>:
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">AHC_AIC7770</span> <span class="o">|</span> <span class="n">AHC_VL</span><span class="p">;</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">AHC_AIC7770_FE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_BIOS_ENABLED</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TERM_ENB</span><span class="p">)</span>
          <span class="n">sxfrctl1</span> <span class="o">=</span> <span class="n">STPWEN</span><span class="p">;</span>
        <span class="n">aic7xxx_load_seeprom</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sxfrctl1</span><span class="p">);</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">board_name_index</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: &lt;%s&gt; at VLB %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">board_names</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">slot</span><span class="p">);</span>
        <span class="k">switch</span><span class="p">(</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">STATUS_2840</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIOS_SEL</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="mh">0x00</span>:
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mh">0xe0000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="mh">0x20</span>:
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mh">0xc8000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="mh">0x40</span>:
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mh">0xd0000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="mh">0x60</span>:
            <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">=</span> <span class="mh">0xd8000</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="nl">default:</span>
            <span class="k">break</span><span class="p">;</span> <span class="cm">/* can&#39;t get here */</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="nl">default:</span>  <span class="cm">/* Won&#39;t get here. */</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_PROBE2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: BIOS %sabled, IO Port 0x%lx, IRQ %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_USEDEFAULTS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;dis&quot;</span> <span class="o">:</span> <span class="s">&quot;en&quot;</span><span class="p">,</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
        <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
        <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">&amp;</span> <span class="n">IRQMS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;level sensitive&quot;</span> <span class="o">:</span> <span class="s">&quot;edge triggered&quot;</span><span class="p">);</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aic7xxx: Extended translation %sabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_EXTEND_TRANS_A</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * All the 7770 based chipsets have this bug</span>
<span class="cm">     */</span>
    <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">|=</span> <span class="n">AHC_BUG_TMODE_WIDEODD</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Set the FIFO threshold and the bus off time.</span>
<span class="cm">     */</span>
    <span class="n">hostconf</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">HOSTCONF</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">hostconf</span> <span class="o">&amp;</span> <span class="n">DFTHRSH</span><span class="p">,</span> <span class="n">BUSSPD</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="p">(</span><span class="n">hostconf</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BOFF</span><span class="p">,</span> <span class="n">BUSTIME</span><span class="p">);</span>
    <span class="n">slot</span><span class="o">++</span><span class="p">;</span>
    <span class="n">found</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* defined(__i386__) || defined(__alpha__) */</span><span class="cp"></span>

  <span class="cm">/*</span>
<span class="cm">   * Now, we re-order the probed devices by BIOS address and BUS class.</span>
<span class="cm">   * In general, we follow this algorithm to make the adapters show up</span>
<span class="cm">   * in the same order under linux that the computer finds them.</span>
<span class="cm">   *  1: All VLB/EISA cards with BIOS_ENABLED first, according to BIOS</span>
<span class="cm">   *     address, going from lowest to highest.</span>
<span class="cm">   *  2: All PCI controllers with BIOS_ENABLED next, according to BIOS</span>
<span class="cm">   *     address, going from lowest to highest.</span>
<span class="cm">   *  3: Remaining VLB/EISA controllers going in slot order.</span>
<span class="cm">   *  4: Remaining PCI controllers, going in PCI device order (reversible)</span>
<span class="cm">   */</span>

  <span class="p">{</span>
    <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">sort_list</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
    <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">vlb</span><span class="p">,</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">prev_p</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">left</span><span class="p">;</span>

    <span class="n">prev_p</span> <span class="o">=</span> <span class="n">vlb</span> <span class="o">=</span> <span class="n">pci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">temp_p</span> <span class="o">=</span> <span class="n">list_p</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">temp_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="n">AHC_EISA</span>:
        <span class="k">case</span> <span class="n">AHC_VL</span>:
        <span class="p">{</span>
          <span class="n">p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">)</span>
            <span class="n">vlb</span> <span class="o">=</span> <span class="n">sort_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="k">else</span>
            <span class="n">vlb</span> <span class="o">=</span> <span class="n">sort_list</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">vlb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">vlb</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">vlb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">current_p</span> <span class="o">=</span> <span class="n">vlb</span><span class="p">;</span>
            <span class="n">prev_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">current_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">bios_address</span> <span class="o">&lt;</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">bios_address</span><span class="p">))</span>
            <span class="p">{</span>
              <span class="n">prev_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
              <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prev_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">prev_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
              <span class="n">temp_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="n">prev_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">vlb</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
              <span class="n">temp_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="n">vlb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">)</span>
            <span class="n">sort_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vlb</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">sort_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vlb</span><span class="p">;</span>
          
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nl">default:</span>  <span class="cm">/* All PCI controllers fall through to default */</span>
        <span class="p">{</span>

          <span class="n">p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">)</span> 
            <span class="n">pci</span> <span class="o">=</span> <span class="n">sort_list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="k">else</span>
            <span class="n">pci</span> <span class="o">=</span> <span class="n">sort_list</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">pci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">pci</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">pci</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">current_p</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
            <span class="n">prev_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aic7xxx_reverse_scan</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">current_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                      <span class="p">(</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;</span> 
                        <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">prev_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
                <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">current_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                      <span class="p">(</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;</span> 
                        <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">prev_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
                <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="cm">/*</span>
<span class="cm">             * Are we dealing with a 7895/6/7/9 where we need to sort the</span>
<span class="cm">             * channels as well, if so, the bios_address values should</span>
<span class="cm">             * be the same</span>
<span class="cm">             */</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">current_p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">==</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">)</span> <span class="o">==</span>
                  <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">current_p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">))</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHNLB</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHANNEL_B_PRIMARY</span><span class="p">)</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">prev_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
                  <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_CHANNEL_B_PRIMARY</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">prev_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
                  <span class="n">current_p</span> <span class="o">=</span> <span class="n">current_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prev_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">prev_p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
              <span class="n">temp_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="n">prev_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">pci</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
              <span class="n">temp_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
              <span class="n">pci</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_p</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_BIOS_ENABLED</span><span class="p">)</span>
            <span class="n">sort_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">sort_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>

          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>  <span class="cm">/* End of switch(temp_p-&gt;type) */</span>
    <span class="p">}</span> <span class="cm">/* End of while (temp_p != NULL) */</span>
    <span class="cm">/*</span>
<span class="cm">     * At this point, the cards have been broken into 4 sorted lists, now</span>
<span class="cm">     * we run through the lists in order and register each controller</span>
<span class="cm">     */</span>
    <span class="p">{</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
      
      <span class="n">left</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sort_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">temp_p</span> <span class="o">=</span> <span class="n">sort_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">while</span><span class="p">(</span><span class="n">temp_p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">template</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">board_names</span><span class="p">[</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">board_name_index</span><span class="p">];</span>
          <span class="n">p</span> <span class="o">=</span> <span class="n">aic7xxx_alloc</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">temp_p</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">found</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_register</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="o">--</span><span class="n">left</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">found</span><span class="o">--</span><span class="p">;</span>
              <span class="n">aic7xxx_release</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
              <span class="n">scsi_unregister</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_dump_card</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
              <span class="n">aic7xxx_print_card</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
              <span class="n">aic7xxx_print_scratch_ram</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
              <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">current_p</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">;</span>
          <span class="n">temp_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span><span class="n">temp_p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
          <span class="n">kfree</span><span class="p">(</span><span class="n">current_p</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_buildscb</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Build a SCB.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aic7xxx_buildscb</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_hwscb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdptr</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tindex</span> <span class="o">=</span> <span class="n">TARGET_INDEX</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">use_sg</span><span class="p">;</span>

  <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">tindex</span><span class="p">);</span>
  <span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Setup the control byte if we need negotiation and have not</span>
<span class="cm">   * already requested it.</span>
<span class="cm">   */</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">discenable</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">DISCENB</span><span class="p">;</span>
    <span class="cm">/* We always force TEST_UNIT_READY to untagged */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEST_UNIT_READY</span> <span class="o">&amp;&amp;</span> <span class="n">sdptr</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">MSG_SIMPLE_Q_TAG</span><span class="p">;</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_Q_TAG</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span> <span class="o">||</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span> <span class="o">||</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVICE_DTR_SCANNED</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">dtr_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="n">DISCENB</span><span class="p">;</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">MK_MESSAGE</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needppr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_PPR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needwdtr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_WDTR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">needsdtr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_MSGOUT_SDTR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_DTR_SCB</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">target_channel_lun</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * The interpretation of request_buffer and request_bufflen</span>
<span class="cm">   * changes depending on whether or not use_sg is zero; a</span>
<span class="cm">   * non-zero use_sg indicates the number of elements in the</span>
<span class="cm">   * scatter-gather array.</span>
<span class="cm">   */</span>

  <span class="cm">/*</span>
<span class="cm">   * XXX - this relies on the host data being stored in a</span>
<span class="cm">   *       little-endian format.</span>
<span class="cm">   */</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SCSI_cmd_length</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
  <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SCSI_cmd_pointer</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SCB_DMA_ADDR</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">));</span>

  <span class="n">use_sg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="n">BUG_ON</span><span class="p">(</span><span class="n">use_sg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">use_sg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>  <span class="cm">/* Must be mid-level SCSI code scatterlist */</span>

    <span class="cm">/*</span>
<span class="cm">     * We must build an SG list in adapter format, as the kernel&#39;s SG list</span>
<span class="cm">     * cannot be used directly because of data field size (__alpha__)</span>
<span class="cm">     * differences and the kernel SG list uses virtual addresses where</span>
<span class="cm">     * we need physical addresses.</span>
<span class="cm">     */</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


    <span class="cm">/*</span>
<span class="cm">     * Copy the segments into the SG array.  NOTE!!! - We used to</span>
<span class="cm">     * have the first entry both in the data_pointer area and the first</span>
<span class="cm">     * SG element.  That has changed somewhat.  We still have the first</span>
<span class="cm">     * entry in both places, but now we download the address of</span>
<span class="cm">     * scb-&gt;sg_list[1] instead of 0 to the sg pointer in the hscb.</span>
<span class="cm">     */</span>
    <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">use_sg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* Copy the first SG into the data pointer area. */</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">data_pointer</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">data_count</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SG_segment_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SG_list_pointer</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SCB_DMA_ADDR</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SG_segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">SG_list_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">data_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">data_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_queue</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Queue a SCB to the controller.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic7xxx_queue_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>  
<span class="cp">#ifdef AIC7XXX_VERBOSE_DEBUGGING</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span> <span class="o">&gt;</span> <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">max_q_depth</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Commands queued exceeds queue &quot;</span>
           <span class="s">&quot;depth, active=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> 
           <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="n">scb</span> <span class="o">=</span> <span class="n">scbq_remove_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_allocate_scb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="n">scbq_remove_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Couldn&#39;t get a free SCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
             <span class="n">CTL_OF_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* Make sure the scsi_cmnd pointer is saved, the struct it points to</span>
<span class="cm">	* is set up properly, and the parity error flag is reset, then send</span>
<span class="cm">	* the SCB to the sequencer and watch the fun begin.</span>
<span class="cm">	*/</span>
  <span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
  <span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
  <span class="n">aic7xxx_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * Construct the SCB beforehand, so the sequencer is</span>
<span class="cm">   * paused a minimal amount of time.</span>
<span class="cm">   */</span>
  <span class="n">aic7xxx_buildscb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_ACTIVE</span> <span class="o">|</span> <span class="n">SCB_WAITINGQ</span><span class="p">;</span>

  <span class="n">scbq_insert_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
  <span class="n">aic7xxx_run_waiting_queues</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">aic7xxx_queue</span><span class="p">)</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_bus_device_reset</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Abort or reset the current SCSI command(s).  If the scb has not</span>
<span class="cm"> *   previously been aborted, then we attempt to send a BUS_DEVICE_RESET</span>
<span class="cm"> *   message to the target.  If the scb has previously been unsuccessfully</span>
<span class="cm"> *   aborted, then we will reset the channel and have all devices renegotiate.</span>
<span class="cm"> *   Returns an enumerated type that indicates the status of the operation.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__aic7xxx_bus_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span>   <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_hwscb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_scbptr</span><span class="p">,</span> <span class="n">lastphase</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hscb_index</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">disconnected</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aic7xxx_bus_device_reset: called with NULL cmd!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

  <span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>

  <span class="n">aic7xxx_isr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic7xxx_done_cmds_complete</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="cm">/* If the command was already complete or just completed, then we didn&#39;t</span>
<span class="cm">   * do a reset, return FAILED */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">lastphase</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Bus Device reset, scb flags 0x%x, &quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">lastphase</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="n">P_DATAOUT</span>:
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data-Out phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_DATAIN</span>:
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data-In phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_COMMAND</span>:
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Command phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_MESGOUT</span>:
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Message-Out phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_STATUS</span>:
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Status phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">P_MESGIN</span>:
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Message-In phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="nl">default:</span>
      <span class="cm">/*</span>
<span class="cm">       * We&#39;re not in a valid phase, so assume we&#39;re idle.</span>
<span class="cm">       */</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;while idle, LASTPHASE = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lastphase</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCSISIGI 0x%x, SEQADDR 0x%x, SSTAT0 0x%x, SSTAT1 &quot;</span>
         <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">));</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SG_CACHEPTR 0x%x, SSTAT2 0x%x, STCNT 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
         <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span>
         <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">?</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_CACHEPTR</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">STCNT</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">channel</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * Send a Device Reset Message:</span>
<span class="cm">     * The target that is holding up the bus may not be the same as</span>
<span class="cm">     * the one that triggered this timeout (different commands have</span>
<span class="cm">     * different timeout lengths).  Our strategy here is to queue an</span>
<span class="cm">     * abort message to the timed out target if it is disconnected.</span>
<span class="cm">     * Otherwise, if we have an active target we stuff the message buffer</span>
<span class="cm">     * with an abort message and assert ATN in the hopes that the target</span>
<span class="cm">     * will let go of the bus and go to the mesgout phase.  If this</span>
<span class="cm">     * fails, we&#39;ll get another timeout a few seconds later which will</span>
<span class="cm">     * attempt a bus reset.</span>
<span class="cm">     */</span>
  <span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">disconnected</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">!=</span> <span class="n">P_BUSFREE</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Invalid SCB ID %d is active, &quot;</span>
             <span class="s">&quot;SCB flags = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
            <span class="n">CTL_OF_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
      <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">))</span>
    <span class="p">{</span> 
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_MESGIN</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;Device reset, Message buffer &quot;</span>
                <span class="s">&quot;in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
        <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>
	
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Device reset message in &quot;</span>
              <span class="s">&quot;message buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_DEVICE_RESET</span><span class="p">;</span>
      <span class="n">aic7xxx_error</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_RESET</span><span class="p">;</span>
      <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BUS_DEVICE_RESET_PENDING</span><span class="p">;</span>
      <span class="cm">/* Send the abort message to the active SCB. */</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lastphase</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
      <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
      <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BUS_DEVICE_RESET_PENDING</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="cm">/* if (last_phase != P_BUSFREE).....indicates we are idle and can work */</span>
  <span class="cm">/*</span>
<span class="cm">   * Simply set the MK_MESSAGE flag and the SEQINT handler will do</span>
<span class="cm">   * the rest on a reconnect/connect.</span>
<span class="cm">   */</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">MK_MESSAGE</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_RESET</span> <span class="o">|</span> <span class="n">SCB_DEVICE_RESET</span><span class="p">;</span>
  <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BUS_DEVICE_RESET_PENDING</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">   * Check to see if the command is on the qinfifo.  If it is, then we will</span>
<span class="cm">   * not need to queue the command again since the card should start it soon</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_search_qinfifo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">disconnected</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">hscb_index</span> <span class="o">=</span> <span class="n">aic7xxx_find_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scb_control</span><span class="p">;</span>

      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hscb_index</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
      <span class="n">scb_control</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
      <span class="cm">/*</span>
<span class="cm">       * If the DISCONNECTED bit is not set in SCB_CONTROL, then we are</span>
<span class="cm">       * actually on the waiting list, not disconnected, and we don&#39;t</span>
<span class="cm">       * need to requeue the command.</span>
<span class="cm">       */</span>
      <span class="n">disconnected</span> <span class="o">=</span> <span class="p">(</span><span class="n">scb_control</span> <span class="o">&amp;</span> <span class="n">DISCONNECTED</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb_control</span> <span class="o">|</span> <span class="n">MK_MESSAGE</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">disconnected</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Actually requeue this SCB in case we can select the</span>
<span class="cm">       * device before it reconnects.  This can result in the command</span>
<span class="cm">       * being on the qinfifo twice, but we don&#39;t care because it will</span>
<span class="cm">       * all get cleaned up if/when the reset takes place.</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_RESET_PROCESS</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Queueing device reset command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		      <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">);</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_QUEUED_ABORT</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
  <span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
  <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BUS_DEVICE_RESET_PENDING</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic7xxx_bus_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
      <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

      <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="n">__aic7xxx_bus_device_reset</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
      <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

      <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_panic_abort</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Abort the current SCSI command(s).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aic7xxx_panic_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>

  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AIC7XXX_C_VERSION</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Controller type:</span><span class="se">\n</span><span class="s">    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board_names</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">board_name_index</span><span class="p">]);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;p-&gt;flags=0x%lx, p-&gt;chip=0x%x, p-&gt;features=0x%x, &quot;</span>
         <span class="s">&quot;sequencer %s paused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
     <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span>
    <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAUSE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;is&quot;</span> <span class="o">:</span> <span class="s">&quot;isn&#39;t&quot;</span> <span class="p">);</span>
  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">disable_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
  <span class="n">aic7xxx_print_card</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic7xxx_print_scratch_ram</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(;;)</span> <span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_abort</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Abort the current SCSI command(s).</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__aic7xxx_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span>  <span class="o">*</span><span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="kt">int</span>    <span class="n">found</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disconnected</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saved_hscbptr</span><span class="p">,</span> <span class="n">hscbptr</span><span class="p">,</span> <span class="n">scb_control</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aic7xxx_abort: called with NULL cmd!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

  <span class="n">aic7xxx_isr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">aic7xxx_done_cmds_complete</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="cm">/* If the command was already complete or just completed, then we didn&#39;t</span>
<span class="cm">   * do a reset, return FAILED */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * I added a new config option to the driver: &quot;panic_on_abort&quot; that will</span>
<span class="cm">   * cause the driver to panic and the machine to stop on the first abort</span>
<span class="cm">   * or reset call into the driver.  At that point, it prints out a lot of</span>
<span class="cm">   * useful information for me which I can then use to try and debug the</span>
<span class="cm">   * problem.  Simply enable the boot time prompt in order to activate this</span>
<span class="cm">   * code.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span>
    <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Aborting scb %d, flags 0x%x, SEQADDR 0x%x, LASTPHASE &quot;</span>
           <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">));</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SG_CACHEPTR 0x%x, SG_COUNT %d, SCSISIGI 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">?</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_CACHEPTR</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SG_COUNT</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SSTAT0 0x%x, SSTAT1 0x%x, SSTAT2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span>
         <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">),</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_WAITINGQ</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">)</span> 
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCB found on waiting list and &quot;</span>
          <span class="s">&quot;aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
    <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">waiting_scbs</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
    <span class="n">scbq_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">delayed_scbs</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
    <span class="n">aic_dev</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="o">++</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">activescbs</span><span class="o">++</span><span class="p">;</span>
    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCB_WAITINGQ</span> <span class="o">|</span> <span class="n">SCB_ACTIVE</span><span class="p">);</span>
    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_ABORT</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  We just checked the waiting_q, now for the QINFIFO</span>
<span class="cm"> */</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">found</span> <span class="o">=</span> <span class="n">aic7xxx_search_qinfifo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
                     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">SCB_ABORT</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">,</span>
                     <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCB found in QINFIFO and aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		    <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
    <span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  QINFIFO, waitingq, completeq done.  Next, check WAITING_SCB list in card</span>
<span class="cm"> */</span>

  <span class="n">saved_hscbptr</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">hscbptr</span> <span class="o">=</span> <span class="n">aic7xxx_find_scb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hscbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
    <span class="n">scb_control</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
    <span class="n">disconnected</span> <span class="o">=</span> <span class="n">scb_control</span> <span class="o">&amp;</span> <span class="n">DISCONNECTED</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">     * If the DISCONNECTED bit is not set in SCB_CONTROL, then we are</span>
<span class="cm">     * either currently active or on the waiting list.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">disconnected</span> <span class="o">&amp;&amp;</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">P_BUSFREE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCB found on hardware waiting&quot;</span>
          <span class="s">&quot; list and aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
      <span class="cm">/* If we are the only waiting command, stop the selection engine */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">)</span> <span class="o">==</span> <span class="n">hscbptr</span> <span class="o">&amp;&amp;</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">SCB_LIST_NULL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
        <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">);</span>
	<span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">hscbptr</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span>
	      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
	    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hscbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	    <span class="n">next</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="k">else</span>
	  <span class="p">{</span>
	    <span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	    <span class="n">next</span> <span class="o">=</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="p">}</span>
      <span class="p">}</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
      <span class="n">aic7xxx_add_curscb_to_free_list</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_ABORT</span> <span class="o">|</span> <span class="n">SCB_QUEUED_FOR_DONE</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disconnected</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * We are the currently active command</span>
<span class="cm">       */</span>
      <span class="k">if</span><span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">P_MESGIN</span><span class="p">)</span> <span class="o">||</span>
	 <span class="p">(</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">))</span>
      <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Message buffer busy, unable to abort</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;message buffer busy, unable to abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
	<span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* Fallthrough to below, set ATNO after we set SCB_CONTROL */</span>
    <span class="p">}</span> 
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">scb_control</span> <span class="o">|</span> <span class="n">MK_MESSAGE</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">disconnected</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">);</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATNO</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">saved_hscbptr</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
  <span class="p">}</span> 
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * The scb isn&#39;t in the card at all and it is active and it isn&#39;t in</span>
<span class="cm">     * any of the queues, so it must be disconnected and paged out.  Fall</span>
<span class="cm">     * through to the code below.</span>
<span class="cm">     */</span>
    <span class="n">disconnected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
        
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_ABORT_PENDING</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_QUEUED_ABORT</span> <span class="o">|</span> <span class="n">SCB_ABORT</span> <span class="o">|</span> <span class="n">SCB_RECOVERY_SCB</span><span class="p">;</span>
  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">MK_MESSAGE</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">disconnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_PROCESS</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;SCB disconnected.  Queueing Abort&quot;</span>
        <span class="s">&quot; SCB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_SCB</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
  <span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
  <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_ABORT_PENDING</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_RETURN</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Abort never delivered, returning FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		    <span class="n">CTL_OF_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_ABORT_PENDING</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_RETURN</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Abort successful.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">success:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_verbose</span> <span class="o">&amp;</span> <span class="n">VERBOSE_ABORT_RETURN</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Abort successful.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">CTL_OF_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
  <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic7xxx_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__aic7xxx_abort</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_reset</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Resetting the bus always succeeds - is has to, otherwise the</span>
<span class="cm"> *   kernel will panic! Try a surgical technique - sending a BUS</span>
<span class="cm"> *   DEVICE RESET message - on the offending target before pulling</span>
<span class="cm"> *   the SCSI bus reset line.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aic7xxx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic_dev_data</span> <span class="o">*</span><span class="n">aic_dev</span><span class="p">;</span>

  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

  <span class="n">aic_dev</span> <span class="o">=</span> <span class="n">AIC_DEV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scb_array</span><span class="p">[</span><span class="n">aic7xxx_position</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">cmd</span><span class="p">)</span>
      <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * I added a new config option to the driver: &quot;panic_on_abort&quot; that will</span>
<span class="cm">   * cause the driver to panic and the machine to stop on the first abort</span>
<span class="cm">   * or reset call into the driver.  At that point, it prints out a lot of</span>
<span class="cm">   * useful information for me which I can then use to try and debug the</span>
<span class="cm">   * problem.  Simply enable the boot time prompt in order to activate this</span>
<span class="cm">   * code.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">aic7xxx_panic_on_abort</span><span class="p">)</span>
    <span class="n">aic7xxx_panic_abort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="k">while</span><span class="p">((</span><span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_IN_ISR</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_isr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">pause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">aic7xxx_done_cmds_complete</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">scb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * We just completed the command when we ran the isr stuff, so we no</span>
<span class="cm">     * longer have it.</span>
<span class="cm">     */</span>
    <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
  <span class="p">}</span>
    
<span class="cm">/*</span>
<span class="cm"> *  By this point, we want to already know what we are going to do and</span>
<span class="cm"> *  only have the following code implement our course of action.</span>
<span class="cm"> */</span>
  <span class="n">aic7xxx_reset_channel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic7xxx_reset_channel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">^</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">restart_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ENREQINIT</span><span class="o">|</span><span class="n">ENBUSFREE</span><span class="p">),</span> <span class="n">SIMODE1</span><span class="p">);</span>
  <span class="n">aic7xxx_clear_intstat</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_HANDLING_REQINITS</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_NONE</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">aic7xxx_run_done_queue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="n">unpause_sequencer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
  <span class="n">ssleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_biosparam</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Return the disk geometry for the given SCSI device.</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *   This function is broken for today&#39;s really large drives and needs</span>
<span class="cm"> *   fixed.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		<span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">sector_t</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="n">buf</span> <span class="o">=</span> <span class="n">scsi_bios_ptable</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">buf</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_partsize</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_EXTEND_TRANS_A</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
    <span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">*</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">))</span>
      <span class="n">cylinders</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">cylinders</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">capacity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">heads</span><span class="p">;</span>
  <span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sectors</span><span class="p">;</span>
  <span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cylinders</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_release</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Free the passed in Scsi_Host memory structures prior to unloading the</span>
<span class="cm"> *   module.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aic7xxx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
    <span class="n">free_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#ifdef MMAPIO</span>
  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MMAPIO */</span><span class="cp"></span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
    <span class="n">release_region</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">MAXREG</span> <span class="o">-</span> <span class="n">MINREG</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">pci_release_regions</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
    <span class="n">pci_dev_put</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">next</span> <span class="o">=</span> <span class="n">first_aic7xxx</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">first_aic7xxx</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">aic7xxx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_print_card</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Print out all of the control registers on the card</span>
<span class="cm"> *</span>
<span class="cm"> *   NOTE: This function is not yet safe for use on the VLB and EISA</span>
<span class="cm"> *   controllers, so it isn&#39;t used on those controllers at all.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_print_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">chip</span><span class="p">;</span>
  <span class="k">static</span> <span class="k">struct</span> <span class="n">register_ranges</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">num_ranges</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">range_val</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="p">}</span> <span class="n">cards_ds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,}</span> <span class="p">},</span> <span class="cm">/* none */</span>
    <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="cm">/*7771*/</span>
          <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="cm">/*7850*/</span>
          <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="cm">/*7860*/</span>
          <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="cm">/*7870*/</span>
          <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="cm">/*7880*/</span>
          <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">16</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="cm">/*7890*/</span>
          <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span>
          <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span>
          <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="cm">/*7895*/</span>
          <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span>
          <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">16</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="cm">/*7896*/</span>
          <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span>
          <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span>
          <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="cm">/*7892*/</span>
          <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span>
          <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="cm">/*7899*/</span>
          <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span>
          <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">};</span>
  <span class="n">chip</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">;</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s at &quot;</span><span class="p">,</span>
         <span class="n">board_names</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">board_name_index</span><span class="p">]);</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AHC_CHIPID_MASK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">AHC_VL</span>:
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;VLB Slot %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_EISA</span>:
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;EISA Slot %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AHC_PCI</span>:
    <span class="nl">default:</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;PCI %d/%d/%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">),</span>
             <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_device_fn</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">   * the registers on the card....</span>
<span class="cm">   */</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Card Dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">cards_ds</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">num_ranges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span>  <span class="o">=</span> <span class="n">cards_ds</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">range_val</span><span class="p">[</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">];</span>
        <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">cards_ds</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">range_val</span><span class="p">[</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">;</span>
        <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x:%02x &quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
      <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">k</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * If this was an Ultra2 controller, then we just hosed the card in terms</span>
<span class="cm">   * of the QUEUE REGS.  This function is only called at init time or by</span>
<span class="cm">   * the panic_abort function, so it&#39;s safe to assume a generic init time</span>
<span class="cm">   * setting here</span>
<span class="cm">   */</span>

  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDSCB_QOFF</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">);</span>
    <span class="n">aic_outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*+F*************************************************************************</span>
<span class="cm"> * Function:</span>
<span class="cm"> *   aic7xxx_print_scratch_ram</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Print out the scratch RAM values on the card.</span>
<span class="cm"> *-F*************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aic7xxx_print_scratch_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">aic7xxx_host</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Scratch RAM:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SRAM_BASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEQCTL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x:%02x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">k</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MORE_SRAM</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TARG_OFFSET</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x:%02x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">aic_inb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
      <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">k</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#include &quot;aic7xxx_old/aic7xxx_proc.c&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">AIC7XXX_H_VERSION</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">proc_info</span>		<span class="o">=</span> <span class="n">aic7xxx_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>			<span class="o">=</span> <span class="n">aic7xxx_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">aic7xxx_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">aic7xxx_info</span><span class="p">,</span>	
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">aic7xxx_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>		<span class="o">=</span> <span class="n">aic7xxx_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">aic7xxx_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>		<span class="o">=</span> <span class="n">aic7xxx_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">aic7xxx_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">aic7xxx_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">aic7xxx_bus_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">aic7xxx_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#include &quot;scsi_module.c&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we almost follow Linus&#39;s tabbing style.</span>
<span class="cm"> * Emacs will notice this stuff at the end of the file and automatically</span>
<span class="cm"> * adjust the settings for this buffer only.  This must remain at the end</span>
<span class="cm"> * of the file.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-indent-level: 2</span>
<span class="cm"> * c-brace-imaginary-offset: 0</span>
<span class="cm"> * c-brace-offset: -2</span>
<span class="cm"> * c-argdecl-indent: 2</span>
<span class="cm"> * c-label-offset: -2</span>
<span class="cm"> * c-continued-statement-offset: 2</span>
<span class="cm"> * c-continued-brace-offset: 0</span>
<span class="cm"> * indent-tabs-mode: nil</span>
<span class="cm"> * tab-width: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
