<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › pcmcia › sym53c500_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sym53c500_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">*  sym53c500_cs.c	Bob Tracy (rct@frus.com)</span>
<span class="cm">*</span>
<span class="cm">*  A rewrite of the pcmcia-cs add-on driver for newer (circa 1997)</span>
<span class="cm">*  New Media Bus Toaster PCMCIA SCSI cards using the Symbios Logic</span>
<span class="cm">*  53c500 controller: intended for use with 2.6 and later kernels.</span>
<span class="cm">*  The pcmcia-cs add-on version of this driver is not supported</span>
<span class="cm">*  beyond 2.4.  It consisted of three files with history/copyright</span>
<span class="cm">*  information as follows:</span>
<span class="cm">*</span>
<span class="cm">*  SYM53C500.h</span>
<span class="cm">*	Bob Tracy (rct@frus.com)</span>
<span class="cm">*	Original by Tom Corner (tcorner@via.at).</span>
<span class="cm">*	Adapted from NCR53c406a.h which is Copyrighted (C) 1994</span>
<span class="cm">*	Normunds Saumanis (normunds@rx.tech.swh.lv)</span>
<span class="cm">*</span>
<span class="cm">*  SYM53C500.c</span>
<span class="cm">*	Bob Tracy (rct@frus.com)</span>
<span class="cm">*	Original driver by Tom Corner (tcorner@via.at) was adapted</span>
<span class="cm">*	from NCR53c406a.c which is Copyrighted (C) 1994, 1995, 1996 </span>
<span class="cm">*	Normunds Saumanis (normunds@fi.ibm.com)</span>
<span class="cm">*</span>
<span class="cm">*  sym53c500.c</span>
<span class="cm">*	Bob Tracy (rct@frus.com)</span>
<span class="cm">*	Original by Tom Corner (tcorner@via.at) was adapted from a</span>
<span class="cm">*	driver for the Qlogic SCSI card written by</span>
<span class="cm">*	David Hinds (dhinds@allegro.stanford.edu).</span>
<span class="cm">* </span>
<span class="cm">*  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">*  under the terms of the GNU General Public License as published by the</span>
<span class="cm">*  Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm">*  later version.</span>
<span class="cm">*</span>
<span class="cm">*  This program is distributed in the hope that it will be useful, but</span>
<span class="cm">*  WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm">*  General Public License for more details.</span>
<span class="cm">*/</span>

<span class="cp">#define SYM53C500_DEBUG 0</span>
<span class="cp">#define VERBOSE_SYM53C500_DEBUG 0</span>

<span class="cm">/*</span>
<span class="cm">*  Set this to 0 if you encounter kernel lockups while transferring </span>
<span class="cm">*  data in PIO mode.  Note this can be changed via &quot;sysfs&quot;.</span>
<span class="cm">*/</span>
<span class="cp">#define USE_FAST_PIO 1</span>

<span class="cm">/* =============== End of user configurable parameters ============== */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ciscode.h&gt;</span>


<span class="cm">/* ================================================================== */</span>

<span class="cp">#define SYNC_MODE 0 		</span><span class="cm">/* Synchronous transfer mode */</span><span class="cp"></span>

<span class="cm">/* Default configuration */</span>
<span class="cp">#define C1_IMG   0x07		</span><span class="cm">/* ID=7 */</span><span class="cp"></span>
<span class="cp">#define C2_IMG   0x48		</span><span class="cm">/* FE SCSI2 */</span><span class="cp"></span>
<span class="cp">#define C3_IMG   0x20		</span><span class="cm">/* CDB */</span><span class="cp"></span>
<span class="cp">#define C4_IMG   0x04		</span><span class="cm">/* ANE */</span><span class="cp"></span>
<span class="cp">#define C5_IMG   0xa4		</span><span class="cm">/* ? changed from b6= AA PI SIE POL */</span><span class="cp"></span>
<span class="cp">#define C7_IMG   0x80		</span><span class="cm">/* added for SYM53C500 t. corner */</span><span class="cp"></span>

<span class="cm">/* Hardware Registers: offsets from io_port (base) */</span>

<span class="cm">/* Control Register Set 0 */</span>
<span class="cp">#define TC_LSB		0x00		</span><span class="cm">/* transfer counter lsb */</span><span class="cp"></span>
<span class="cp">#define TC_MSB		0x01		</span><span class="cm">/* transfer counter msb */</span><span class="cp"></span>
<span class="cp">#define SCSI_FIFO	0x02		</span><span class="cm">/* scsi fifo register */</span><span class="cp"></span>
<span class="cp">#define CMD_REG		0x03		</span><span class="cm">/* command register */</span><span class="cp"></span>
<span class="cp">#define STAT_REG	0x04		</span><span class="cm">/* status register */</span><span class="cp"></span>
<span class="cp">#define DEST_ID		0x04		</span><span class="cm">/* selection/reselection bus id */</span><span class="cp"></span>
<span class="cp">#define INT_REG		0x05		</span><span class="cm">/* interrupt status register */</span><span class="cp"></span>
<span class="cp">#define SRTIMOUT	0x05		</span><span class="cm">/* select/reselect timeout reg */</span><span class="cp"></span>
<span class="cp">#define SEQ_REG		0x06		</span><span class="cm">/* sequence step register */</span><span class="cp"></span>
<span class="cp">#define SYNCPRD		0x06		</span><span class="cm">/* synchronous transfer period */</span><span class="cp"></span>
<span class="cp">#define FIFO_FLAGS	0x07		</span><span class="cm">/* indicates # of bytes in fifo */</span><span class="cp"></span>
<span class="cp">#define SYNCOFF		0x07		</span><span class="cm">/* synchronous offset register */</span><span class="cp"></span>
<span class="cp">#define CONFIG1		0x08		</span><span class="cm">/* configuration register */</span><span class="cp"></span>
<span class="cp">#define CLKCONV		0x09		</span><span class="cm">/* clock conversion register */</span><span class="cp"></span>
<span class="cm">/* #define TESTREG	0x0A */</span>		<span class="cm">/* test mode register */</span>
<span class="cp">#define CONFIG2		0x0B		</span><span class="cm">/* configuration 2 register */</span><span class="cp"></span>
<span class="cp">#define CONFIG3		0x0C		</span><span class="cm">/* configuration 3 register */</span><span class="cp"></span>
<span class="cp">#define CONFIG4		0x0D		</span><span class="cm">/* configuration 4 register */</span><span class="cp"></span>
<span class="cp">#define TC_HIGH		0x0E		</span><span class="cm">/* transfer counter high */</span><span class="cp"></span>
<span class="cm">/* #define FIFO_BOTTOM	0x0F */</span>		<span class="cm">/* reserve FIFO byte register */</span>

<span class="cm">/* Control Register Set 1 */</span>
<span class="cm">/* #define JUMPER_SENSE	0x00 */</span>		<span class="cm">/* jumper sense port reg (r/w) */</span>
<span class="cm">/* #define SRAM_PTR	0x01 */</span>		<span class="cm">/* SRAM address pointer reg (r/w) */</span>
<span class="cm">/* #define SRAM_DATA	0x02 */</span>		<span class="cm">/* SRAM data register (r/w) */</span>
<span class="cp">#define PIO_FIFO	0x04		</span><span class="cm">/* PIO FIFO registers (r/w) */</span><span class="cp"></span>
<span class="cm">/* #define PIO_FIFO1	0x05 */</span>		<span class="cm">/*  */</span>
<span class="cm">/* #define PIO_FIFO2	0x06 */</span>		<span class="cm">/*  */</span>
<span class="cm">/* #define PIO_FIFO3	0x07 */</span>		<span class="cm">/*  */</span>
<span class="cp">#define PIO_STATUS	0x08		</span><span class="cm">/* PIO status (r/w) */</span><span class="cp"></span>
<span class="cm">/* #define ATA_CMD	0x09 */</span>		<span class="cm">/* ATA command/status reg (r/w) */</span>
<span class="cm">/* #define ATA_ERR	0x0A */</span>		<span class="cm">/* ATA features/error reg (r/w) */</span>
<span class="cp">#define PIO_FLAG	0x0B		</span><span class="cm">/* PIO flag interrupt enable (r/w) */</span><span class="cp"></span>
<span class="cp">#define CONFIG5		0x09		</span><span class="cm">/* configuration 5 register */</span><span class="cp"></span>
<span class="cm">/* #define SIGNATURE	0x0E */</span>		<span class="cm">/* signature register (r) */</span>
<span class="cm">/* #define CONFIG6	0x0F */</span>		<span class="cm">/* configuration 6 register (r) */</span>
<span class="cp">#define CONFIG7		0x0d</span>

<span class="cm">/* select register set 0 */</span>
<span class="cp">#define REG0(x)		(outb(C4_IMG, (x) + CONFIG4))</span>
<span class="cm">/* select register set 1 */</span>
<span class="cp">#define REG1(x)		outb(C7_IMG, (x) + CONFIG7); outb(C5_IMG, (x) + CONFIG5)</span>

<span class="cp">#if SYM53C500_DEBUG</span>
<span class="cp">#define DEB(x) x</span>
<span class="cp">#else</span>
<span class="cp">#define DEB(x)</span>
<span class="cp">#endif</span>

<span class="cp">#if VERBOSE_SYM53C500_DEBUG</span>
<span class="cp">#define VDEB(x) x</span>
<span class="cp">#else</span>
<span class="cp">#define VDEB(x)</span>
<span class="cp">#endif</span>

<span class="cp">#define LOAD_DMA_COUNT(x, count) \</span>
<span class="cp">  outb(count &amp; 0xff, (x) + TC_LSB); \</span>
<span class="cp">  outb((count &gt;&gt; 8) &amp; 0xff, (x) + TC_MSB); \</span>
<span class="cp">  outb((count &gt;&gt; 16) &amp; 0xff, (x) + TC_HIGH);</span>

<span class="cm">/* Chip commands */</span>
<span class="cp">#define DMA_OP               0x80</span>

<span class="cp">#define SCSI_NOP             0x00</span>
<span class="cp">#define FLUSH_FIFO           0x01</span>
<span class="cp">#define CHIP_RESET           0x02</span>
<span class="cp">#define SCSI_RESET           0x03</span>
<span class="cp">#define RESELECT             0x40</span>
<span class="cp">#define SELECT_NO_ATN        0x41</span>
<span class="cp">#define SELECT_ATN           0x42</span>
<span class="cp">#define SELECT_ATN_STOP      0x43</span>
<span class="cp">#define ENABLE_SEL           0x44</span>
<span class="cp">#define DISABLE_SEL          0x45</span>
<span class="cp">#define SELECT_ATN3          0x46</span>
<span class="cp">#define RESELECT3            0x47</span>
<span class="cp">#define TRANSFER_INFO        0x10</span>
<span class="cp">#define INIT_CMD_COMPLETE    0x11</span>
<span class="cp">#define MSG_ACCEPT           0x12</span>
<span class="cp">#define TRANSFER_PAD         0x18</span>
<span class="cp">#define SET_ATN              0x1a</span>
<span class="cp">#define RESET_ATN            0x1b</span>
<span class="cp">#define SEND_MSG             0x20</span>
<span class="cp">#define SEND_STATUS          0x21</span>
<span class="cp">#define SEND_DATA            0x22</span>
<span class="cp">#define DISCONN_SEQ          0x23</span>
<span class="cp">#define TERMINATE_SEQ        0x24</span>
<span class="cp">#define TARG_CMD_COMPLETE    0x25</span>
<span class="cp">#define DISCONN              0x27</span>
<span class="cp">#define RECV_MSG             0x28</span>
<span class="cp">#define RECV_CMD             0x29</span>
<span class="cp">#define RECV_DATA            0x2a</span>
<span class="cp">#define RECV_CMD_SEQ         0x2b</span>
<span class="cp">#define TARGET_ABORT_DMA     0x04</span>

<span class="cm">/* ================================================================== */</span>

<span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">manf_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">*  Repository for per-instance host data.</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">current_SC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fast_pio</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">Phase</span> <span class="p">{</span>
    <span class="n">idle</span><span class="p">,</span>
    <span class="n">data_out</span><span class="p">,</span>
    <span class="n">data_in</span><span class="p">,</span>
    <span class="n">command_ph</span><span class="p">,</span>
    <span class="n">status_ph</span><span class="p">,</span>
    <span class="n">message_out</span><span class="p">,</span>
    <span class="n">message_in</span>
<span class="p">};</span>

<span class="cm">/* ================================================================== */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">chip_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG1</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">PIO_STATUS</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">PIO_FLAG</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">C4_IMG</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CONFIG4</span><span class="p">);</span>	<span class="cm">/* REG0(io_port); */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C3_IMG</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C2_IMG</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CONFIG2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C1_IMG</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CONFIG1</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CLKCONV</span><span class="p">);</span>	<span class="cm">/* clock conversion factor */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x9C</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">SRTIMOUT</span><span class="p">);</span>	<span class="cm">/* Selection timeout */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">SYNCPRD</span><span class="p">);</span>	<span class="cm">/* Synchronous transfer period */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SYNC_MODE</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">SYNCOFF</span><span class="p">);</span>	<span class="cm">/* synchronous mode */</span>  
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SYM53C500_int_host_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C4_IMG</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CONFIG4</span><span class="p">);</span>	<span class="cm">/* REG0(io_port); */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_RESET</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SCSI_NOP</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* required after reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SCSI_RESET</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
	<span class="n">chip_init</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span>
<span class="nf">SYM53C500_pio_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fast_pio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* current scsi fifo size */</span>

	<span class="n">REG1</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reqlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PIO_STATUS</span><span class="p">);</span>
		<span class="cm">/* VDEB(printk(&quot;pio_status=%x\n&quot;, i)); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> 
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mh">0x10</span>:	<span class="cm">/* fifo empty */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span> 
		<span class="k">case</span> <span class="mh">0x8</span>:	<span class="cm">/* fifo 1/3 full */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc</span>:	<span class="cm">/* fifo 2/3 full */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">84</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xe</span>:	<span class="cm">/* fifo full */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* fifo empty and interrupt occurred */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">reqlen</span><span class="p">)</span> 
				<span class="n">len</span> <span class="o">=</span> <span class="n">reqlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fast_pio</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">insl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PIO_FIFO</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">request</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span> 
				<span class="n">reqlen</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span> 
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">request</span><span class="o">++</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PIO_FIFO</span><span class="p">);</span>
					<span class="n">reqlen</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> 
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span>
<span class="nf">SYM53C500_pio_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fast_pio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* current scsi fifo size */</span>

	<span class="n">REG1</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PIO_STATUS</span><span class="p">);</span>
		<span class="cm">/* VDEB(printk(&quot;pio_status=%x\n&quot;, i)); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* error */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">84</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mh">0xe</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">reqlen</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">reqlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fast_pio</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outsl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PIO_FIFO</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">request</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
				<span class="n">reqlen</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">++</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PIO_FIFO</span><span class="p">);</span>
					<span class="n">reqlen</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">SYM53C500_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fifo_size</span><span class="p">;)</span>
	<span class="n">DEB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seq_reg</span><span class="p">;)</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pio_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_base</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">curSC</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">current_SC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fast_pio</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fast_pio</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500_intr called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">REG1</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
	<span class="n">pio_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PIO_STATUS</span><span class="p">);</span>
	<span class="n">REG0</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">STAT_REG</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">seq_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">SEQ_REG</span><span class="p">));</span>
	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">INT_REG</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">FIFO_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

<span class="cp">#if SYM53C500_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;status=%02x, seq_reg=%02x, int_reg=%02x, fifo_size=%02x&quot;</span><span class="p">,</span> 
	    <span class="n">status</span><span class="p">,</span> <span class="n">seq_reg</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, pio=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pio_status</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* SYM53C500_DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SCSI reset intr */</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: reset intr received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idle_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pio_status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Warning: PIO error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idle_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Parity error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Warning: parity error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_PARITY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idle_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Gross error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Warning: gross error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idle_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Disconnect */</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: disconnect intr received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">message_in</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Unexpected disconnect */</span>
			<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Command complete, return status and message */</span>
			<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">((</span><span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">idle_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* scsi phase */</span>
	<span class="k">case</span> <span class="mh">0x00</span>:			<span class="cm">/* DATA-OUT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Target requesting info transfer */</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">;</span>
			<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Data-Out phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
			<span class="n">LOAD_DMA_COUNT</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">curSC</span><span class="p">));</span>	<span class="cm">/* Max transfer size */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">TRANSFER_INFO</span> <span class="o">|</span> <span class="n">DMA_OP</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>

			<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">curSC</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">curSC</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SYM53C500_pio_write</span><span class="p">(</span><span class="n">fast_pio</span><span class="p">,</span> <span class="n">port_base</span><span class="p">,</span>
				    <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">REG0</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x01</span>:		<span class="cm">/* DATA-IN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Target requesting info transfer */</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">data_in</span><span class="p">;</span>
			<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Data-In phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
			<span class="n">LOAD_DMA_COUNT</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">curSC</span><span class="p">));</span>	<span class="cm">/* Max transfer size */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">TRANSFER_INFO</span> <span class="o">|</span> <span class="n">DMA_OP</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>

			<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">curSC</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">curSC</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SYM53C500_pio_read</span><span class="p">(</span><span class="n">fast_pio</span><span class="p">,</span> <span class="n">port_base</span><span class="p">,</span>
					<span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">REG0</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x02</span>:		<span class="cm">/* COMMAND */</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">command_ph</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Warning: Unknown interrupt occurred in command phase!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x03</span>:		<span class="cm">/* STATUS */</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">status_ph</span><span class="p">;</span>
		<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Status phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">INIT_CMD_COMPLETE</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x04</span>:		<span class="cm">/* Reserved */</span>
	<span class="k">case</span> <span class="mh">0x05</span>:		<span class="cm">/* Reserved */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: WARNING: Reserved phase!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x06</span>:		<span class="cm">/* MESSAGE-OUT */</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Message-Out phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">message_out</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SET_ATN</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* Reject the message */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MSG_ACCEPT</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x07</span>:		<span class="cm">/* MESSAGE-IN */</span>
		<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Message-In phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">message_in</span><span class="p">;</span>

		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">SCSI_FIFO</span><span class="p">);</span>
		<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">SCSI_FIFO</span><span class="p">);</span>

		<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSI FIFO size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">FIFO_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Status = %02x  Message = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">,</span> <span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">==</span> <span class="n">SAVE_POINTERS</span> <span class="o">||</span> <span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">==</span> <span class="n">DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SET_ATN</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* Reject message */</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Discarding SAVE_POINTERS message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MSG_ACCEPT</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="nl">idle_out:</span>
	<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">curSC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">curSC</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SYM53C500_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SYM53C500_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	*  Do this before releasing/freeing resources.</span>
<span class="cm">	*/</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	*  Interrupts getting hosed on card removal.  Try</span>
<span class="cm">	*  the following code, mostly from qlogicfas.c.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">&amp;&amp;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>

	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* SYM53C500_release */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>
<span class="nf">SYM53C500_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SChost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">info_msg</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="p">)</span><span class="n">SChost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500_info called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">snprintf</span><span class="p">(</span><span class="n">info_msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info_msg</span><span class="p">),</span>
	    <span class="s">&quot;SYM53C500 at 0x%lx, IRQ %d, %s PIO mode.&quot;</span><span class="p">,</span> 
	    <span class="n">SChost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">SChost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fast_pio</span> <span class="o">?</span> <span class="s">&quot;fast&quot;</span> <span class="o">:</span> <span class="s">&quot;slow&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info_msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">SYM53C500_queue_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_base</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500_queue called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cmd=%02x, cmd_len=%02x, target=%02x, lun=%02x, bufflen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	    <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> 
	    <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>  <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)));</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;cmd[%d]=%02x  &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_SC</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">command_ph</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We are locked here already by the mid layer */</span>
	<span class="n">REG0</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">DEST_ID</span><span class="p">);</span>	<span class="cm">/* set destination */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* reset the fifos */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">SCSI_FIFO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SELECT_NO_ATN</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">CMD_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">SYM53C500_queue</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="n">SYM53C500_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_base</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500_host_reset called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">SYM53C500_int_host_reset</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">SYM53C500_biosparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
    <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">info_array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500_biosparm called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>		<span class="cm">/* heads */</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>		<span class="cm">/* sectors */</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>	<span class="cm">/* cylinders */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* big disk */</span>
		<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="mi">63</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">SYM53C500_show_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SHp</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="p">)</span><span class="n">SHp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fast_pio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">SYM53C500_store_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SHp</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="p">)</span><span class="n">SHp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">pio</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fast_pio</span> <span class="o">=</span> <span class="n">pio</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  SCSI HBA device attributes we want to</span>
<span class="cm">*  make available via sysfs.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">SYM53C500_pio_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fast_pio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">SYM53C500_show_pio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">SYM53C500_store_pio</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">SYM53C500_shost_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">SYM53C500_pio_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">*  scsi_host_template initializer</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">sym53c500_driver_template</span> <span class="o">=</span> <span class="p">{</span>
     <span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
     <span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;SYM53C500&quot;</span><span class="p">,</span>
     <span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">SYM53C500_info</span><span class="p">,</span>
     <span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">SYM53C500_queue</span><span class="p">,</span>
     <span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">SYM53C500_host_reset</span><span class="p">,</span>
     <span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">SYM53C500_biosparm</span><span class="p">,</span>
     <span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="s">&quot;SYM53C500&quot;</span><span class="p">,</span>
     <span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
     <span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
     <span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
     <span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">SYM53C500_shost_attrs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SYM53C500_config_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">io_lines</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IO_DATA_PATH_WIDTH</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IO_DATA_PATH_WIDTH_AUTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SYM53C500_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_level</span><span class="p">,</span> <span class="n">port_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sym53c500_driver_template</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SYM53C500_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">manf_id</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_loop_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">SYM53C500_config_check</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	*  That&#39;s the trouble with copying liberally from another driver.</span>
<span class="cm">	*  Some things probably aren&#39;t relevant, and I suspect this entire</span>
<span class="cm">	*  section dealing with manufacturer IDs can be scrapped.	--rct</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_MACNICA</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_PIONEER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="mh">0x0098</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set ATAcmd */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	*  irq_level == 0 implies tpnt-&gt;can_queue == 0, which</span>
<span class="cm">	*  is not supported in 2.6.  Thus, only irq_level &gt; 0</span>
<span class="cm">	*  will be allowed.</span>
<span class="cm">	*</span>
<span class="cm">	*  Possible port_base values are as follows:</span>
<span class="cm">	*</span>
<span class="cm">	*	0x130, 0x230, 0x280, 0x290,</span>
<span class="cm">	*	0x320, 0x330, 0x340, 0x350</span>
<span class="cm">	*/</span>
	<span class="n">port_base</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">irq_level</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: port_base=0x%x, irq=%d, fast_pio=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">port_base</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">,</span> <span class="n">USE_FAST_PIO</span><span class="p">);)</span>

	<span class="n">chip_init</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Unable to register host, giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sym53c500_data</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">SYM53C500_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;SYM53C500&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: unable to allocate IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_scsi</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: allocated IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: No interrupts detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_free_scsi</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYM53C500: Shouldn&#39;t get here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_free_scsi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_level</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	*  Note fast_pio is set to USE_FAST_PIO by</span>
<span class="cm">	*  default, but can be changed via &quot;sysfs&quot;.</span>
<span class="cm">	*/</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fast_pio</span> <span class="o">=</span> <span class="n">USE_FAST_PIO</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="nl">err_free_scsi:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err_release:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sym53c500_cs: no SCSI devices found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">SYM53C500_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* SYM53C500_config */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym53c500_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* See earlier comment about manufacturer IDs. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_MACNICA</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_PIONEER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="mh">0x0098</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  If things don&#39;t work after a &quot;resume&quot;,</span>
<span class="cm">	 *  this is a good place to start looking.</span>
<span class="cm">	 */</span>
	<span class="n">SYM53C500_int_host_reset</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SYM53C500_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SYM53C500_detach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">SYM53C500_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* SYM53C500_detach */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SYM53C500_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SYM53C500_attach()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Create new SCSI device */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_ENABLE_IRQ</span> <span class="o">|</span> <span class="n">CONF_AUTO_SET_IO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SYM53C500_config</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* SYM53C500_attach */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Bob Tracy &lt;rct@frus.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SYM53C500 PCMCIA SCSI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">sym53c500_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;BASICS by New Media Corporation&quot;</span><span class="p">,</span> <span class="s">&quot;SCSI Sym53C500&quot;</span><span class="p">,</span> <span class="mh">0x23c78a9d</span><span class="p">,</span> <span class="mh">0x0099e7f7</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;New Media Corporation&quot;</span><span class="p">,</span> <span class="s">&quot;SCSI Bus Toaster Sym53C500&quot;</span><span class="p">,</span> <span class="mh">0x085a850b</span><span class="p">,</span> <span class="mh">0x45432eb8</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID2</span><span class="p">(</span><span class="s">&quot;SCSI9000&quot;</span><span class="p">,</span> <span class="mh">0x21648f44</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">sym53c500_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">sym53c500_cs_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sym53c500_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">SYM53C500_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">SYM53C500_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">sym53c500_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">sym53c500_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">init_sym53c500_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sym53c500_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">exit_sym53c500_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sym53c500_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_sym53c500_cs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_sym53c500_cs</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
