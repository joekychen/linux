<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › pcmcia › nsp_cs.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nsp_cs.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*=======================================================/</span>
<span class="cm">  Header file for nsp_cs.c</span>
<span class="cm">      By: YOKOTA Hiroshi &lt;yokota@netlab.is.tsukuba.ac.jp&gt;</span>

<span class="cm">    Ver.1.0 : Cut unused lines.</span>
<span class="cm">    Ver 0.1 : Initial version.</span>

<span class="cm">    This software may be used and distributed according to the terms of</span>
<span class="cm">    the GNU General Public License.</span>

<span class="cm">=========================================================*/</span>

<span class="cp">#ifndef  __nsp_cs__</span>
<span class="cp">#define  __nsp_cs__</span>

<span class="cm">/* for debugging */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define NSP_DEBUG 9</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">#define static</span>
<span class="cm">#define inline</span>
<span class="cm">*/</span>

<span class="cm">/************************************</span>
<span class="cm"> * Some useful macros...</span>
<span class="cm"> */</span>

<span class="cm">/* SCSI initiator must be ID 7 */</span>
<span class="cp">#define NSP_INITIATOR_ID  7</span>

<span class="cp">#define NSP_SELTIMEOUT 200</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * register definitions</span>
<span class="cm"> ***************************************************************************/</span>
<span class="cm">/*========================================================================</span>
<span class="cm"> * base register</span>
<span class="cm"> ========================================================================*/</span>
<span class="cp">#define	IRQCONTROL	0x00  </span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#  define IRQCONTROL_RESELECT_CLEAR     BIT(0)</span>
<span class="cp">#  define IRQCONTROL_PHASE_CHANGE_CLEAR BIT(1)</span>
<span class="cp">#  define IRQCONTROL_TIMER_CLEAR        BIT(2)</span>
<span class="cp">#  define IRQCONTROL_FIFO_CLEAR         BIT(3)</span>
<span class="cp">#  define IRQCONTROL_ALLMASK            0xff</span>
<span class="cp">#  define IRQCONTROL_ALLCLEAR           (IRQCONTROL_RESELECT_CLEAR     | \</span>
<span class="cp">					 IRQCONTROL_PHASE_CHANGE_CLEAR | \</span>
<span class="cp">					 IRQCONTROL_TIMER_CLEAR        | \</span>
<span class="cp">					 IRQCONTROL_FIFO_CLEAR          )</span>
<span class="cp">#  define IRQCONTROL_IRQDISABLE         0xf0</span>

<span class="cp">#define	IRQSTATUS	0x00  </span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#  define IRQSTATUS_SCSI  BIT(0)</span>
<span class="cp">#  define IRQSTATUS_TIMER BIT(2)</span>
<span class="cp">#  define IRQSTATUS_FIFO  BIT(3)</span>
<span class="cp">#  define IRQSTATUS_MASK  0x0f</span>

<span class="cp">#define	IFSELECT	0x01 </span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#  define IF_IFSEL    BIT(0)</span>
<span class="cp">#  define IF_REGSEL   BIT(2)</span>

<span class="cp">#define	FIFOSTATUS	0x01 </span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#  define FIFOSTATUS_CHIP_REVISION_MASK 0x0f</span>
<span class="cp">#  define FIFOSTATUS_CHIP_ID_MASK       0x70</span>
<span class="cp">#  define FIFOSTATUS_FULL_EMPTY         BIT(7)</span>

<span class="cp">#define	INDEXREG	0x02 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define	DATAREG		0x03 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define	FIFODATA	0x04 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define	FIFODATA1	0x05 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define	FIFODATA2	0x06 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define	FIFODATA3	0x07 </span><span class="cm">/* R/W */</span><span class="cp"></span>

<span class="cm">/*====================================================================</span>
<span class="cm"> * indexed register</span>
<span class="cm"> ====================================================================*/</span>
<span class="cp">#define EXTBUSCTRL	0x10 </span><span class="cm">/* R/W,deleted */</span><span class="cp"></span>

<span class="cp">#define CLOCKDIV	0x11 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define CLOCK_40M 0x02</span>
<span class="cp">#  define CLOCK_20M 0x01</span>
<span class="cp">#  define FAST_20   BIT(2)</span>

<span class="cp">#define TERMPWRCTRL	0x13 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define POWER_ON BIT(0)</span>

<span class="cp">#define SCSIIRQMODE	0x15 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define SCSI_PHASE_CHANGE_EI BIT(0)</span>
<span class="cp">#  define RESELECT_EI          BIT(4)</span>
<span class="cp">#  define FIFO_IRQ_EI          BIT(5)</span>
<span class="cp">#  define SCSI_RESET_IRQ_EI    BIT(6)</span>

<span class="cp">#define IRQPHASESENCE	0x16 </span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cp">#  define LATCHED_MSG      BIT(0)</span>
<span class="cp">#  define LATCHED_IO       BIT(1)</span>
<span class="cp">#  define LATCHED_CD       BIT(2)</span>
<span class="cp">#  define LATCHED_BUS_FREE BIT(3)</span>
<span class="cp">#  define PHASE_CHANGE_IRQ BIT(4)</span>
<span class="cp">#  define RESELECT_IRQ     BIT(5)</span>
<span class="cp">#  define FIFO_IRQ         BIT(6)</span>
<span class="cp">#  define SCSI_RESET_IRQ   BIT(7)</span>

<span class="cp">#define TIMERCOUNT	0x17 </span><span class="cm">/* R/W */</span><span class="cp"></span>

<span class="cp">#define SCSIBUSCTRL	0x18 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define SCSI_SEL         BIT(0)</span>
<span class="cp">#  define SCSI_RST         BIT(1)</span>
<span class="cp">#  define SCSI_DATAOUT_ENB BIT(2)</span>
<span class="cp">#  define SCSI_ATN         BIT(3)</span>
<span class="cp">#  define SCSI_ACK         BIT(4)</span>
<span class="cp">#  define SCSI_BSY         BIT(5)</span>
<span class="cp">#  define AUTODIRECTION    BIT(6)</span>
<span class="cp">#  define ACKENB           BIT(7)</span>

<span class="cp">#define SCSIBUSMON	0x19 </span><span class="cm">/* R */</span><span class="cp"></span>

<span class="cp">#define SETARBIT	0x1A </span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#  define ARBIT_GO         BIT(0)</span>
<span class="cp">#  define ARBIT_FLAG_CLEAR BIT(1)</span>

<span class="cp">#define ARBITSTATUS	0x1A </span><span class="cm">/* R */</span><span class="cp"></span>
<span class="cm">/*#  define ARBIT_GO        BIT(0)*/</span>
<span class="cp">#  define ARBIT_WIN        BIT(1)</span>
<span class="cp">#  define ARBIT_FAIL       BIT(2)</span>
<span class="cp">#  define RESELECT_FLAG    BIT(3)</span>

<span class="cp">#define PARITYCTRL	0x1B  </span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#define PARITYSTATUS	0x1B  </span><span class="cm">/* R */</span><span class="cp"></span>

<span class="cp">#define COMMANDCTRL	0x1C  </span><span class="cm">/* W */</span><span class="cp"></span>
<span class="cp">#  define CLEAR_COMMAND_POINTER BIT(0)</span>
<span class="cp">#  define AUTO_COMMAND_GO       BIT(1)</span>

<span class="cp">#define RESELECTID	0x1C  </span><span class="cm">/* R   */</span><span class="cp"></span>
<span class="cp">#define COMMANDDATA	0x1D  </span><span class="cm">/* R/W */</span><span class="cp"></span>

<span class="cp">#define POINTERCLR	0x1E  </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#  define POINTER_CLEAR      BIT(0)</span>
<span class="cp">#  define ACK_COUNTER_CLEAR  BIT(1)</span>
<span class="cp">#  define REQ_COUNTER_CLEAR  BIT(2)</span>
<span class="cp">#  define HOST_COUNTER_CLEAR BIT(3)</span>
<span class="cp">#  define READ_SOURCE        (BIT(4) | BIT(5))</span>
<span class="cp">#    define ACK_COUNTER        (0)</span>
<span class="cp">#    define REQ_COUNTER        (BIT(4))</span>
<span class="cp">#    define HOST_COUNTER       (BIT(5))</span>

<span class="cp">#define TRANSFERCOUNT	0x1E  </span><span class="cm">/* R   */</span><span class="cp"></span>

<span class="cp">#define TRANSFERMODE	0x20  </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define MODE_MEM8   BIT(0)</span>
<span class="cp">#  define MODE_MEM32  BIT(1)</span>
<span class="cp">#  define MODE_ADR24  BIT(2)</span>
<span class="cp">#  define MODE_ADR32  BIT(3)</span>
<span class="cp">#  define MODE_IO8    BIT(4)</span>
<span class="cp">#  define MODE_IO32   BIT(5)</span>
<span class="cp">#  define TRANSFER_GO BIT(6)</span>
<span class="cp">#  define BRAIND      BIT(7)</span>

<span class="cp">#define SYNCREG		0x21 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define SYNCREG_OFFSET_MASK  0x0f</span>
<span class="cp">#  define SYNCREG_PERIOD_MASK  0xf0</span>
<span class="cp">#  define SYNCREG_PERIOD_SHIFT 4</span>

<span class="cp">#define SCSIDATALATCH	0x22 </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#define SCSIDATAIN	0x22 </span><span class="cm">/* R   */</span><span class="cp"></span>
<span class="cp">#define SCSIDATAWITHACK	0x23 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define SCAMCONTROL	0x24 </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#define SCAMSTATUS	0x24 </span><span class="cm">/* R   */</span><span class="cp"></span>
<span class="cp">#define SCAMDATA	0x25 </span><span class="cm">/* R/W */</span><span class="cp"></span>

<span class="cp">#define OTHERCONTROL	0x26 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#  define TPL_ROM_WRITE_EN BIT(0)</span>
<span class="cp">#  define TPWR_OUT         BIT(1)</span>
<span class="cp">#  define TPWR_SENSE       BIT(2)</span>
<span class="cp">#  define RA8_CONTROL      BIT(3)</span>

<span class="cp">#define ACKWIDTH	0x27 </span><span class="cm">/* R/W */</span><span class="cp"></span>
<span class="cp">#define CLRTESTPNT	0x28 </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#define ACKCNTLD	0x29 </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#define REQCNTLD	0x2A </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#define HSTCNTLD	0x2B </span><span class="cm">/*   W */</span><span class="cp"></span>
<span class="cp">#define CHECKSUM	0x2C </span><span class="cm">/* R/W */</span><span class="cp"></span>

<span class="cm">/************************************************************************</span>
<span class="cm"> * Input status bit definitions.</span>
<span class="cm"> ************************************************************************/</span>
<span class="cp">#define S_MESSAGE	BIT(0)    </span><span class="cm">/* Message line from SCSI bus      */</span><span class="cp"></span>
<span class="cp">#define S_IO		BIT(1)    </span><span class="cm">/* Input/Output line from SCSI bus */</span><span class="cp"></span>
<span class="cp">#define S_CD		BIT(2)    </span><span class="cm">/* Command/Data line from SCSI bus */</span><span class="cp"></span>
<span class="cp">#define S_BUSY		BIT(3)    </span><span class="cm">/* Busy line from SCSI bus         */</span><span class="cp"></span>
<span class="cp">#define S_ACK		BIT(4)    </span><span class="cm">/* Acknowledge line from SCSI bus  */</span><span class="cp"></span>
<span class="cp">#define S_REQUEST	BIT(5)    </span><span class="cm">/* Request line from SCSI bus      */</span><span class="cp"></span>
<span class="cp">#define S_SELECT	BIT(6)	  </span><span class="cm">/*                                 */</span><span class="cp"></span>
<span class="cp">#define S_ATN		BIT(7)	  </span><span class="cm">/*                                 */</span><span class="cp"></span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Useful Bus Monitor status combinations.</span>
<span class="cm"> ***********************************************************************/</span>
<span class="cp">#define BUSMON_SEL         S_SELECT</span>
<span class="cp">#define BUSMON_BSY         S_BUSY</span>
<span class="cp">#define BUSMON_REQ         S_REQUEST</span>
<span class="cp">#define BUSMON_IO          S_IO</span>
<span class="cp">#define BUSMON_ACK         S_ACK</span>
<span class="cp">#define BUSMON_BUS_FREE    0</span>
<span class="cp">#define BUSMON_COMMAND     ( S_BUSY | S_CD |                    S_REQUEST )</span>
<span class="cp">#define BUSMON_MESSAGE_IN  ( S_BUSY | S_CD | S_IO | S_MESSAGE | S_REQUEST )</span>
<span class="cp">#define BUSMON_MESSAGE_OUT ( S_BUSY | S_CD |        S_MESSAGE | S_REQUEST )</span>
<span class="cp">#define BUSMON_DATA_IN     ( S_BUSY |        S_IO |             S_REQUEST )</span>
<span class="cp">#define BUSMON_DATA_OUT    ( S_BUSY |                           S_REQUEST )</span>
<span class="cp">#define BUSMON_STATUS      ( S_BUSY | S_CD | S_IO |             S_REQUEST )</span>
<span class="cp">#define BUSMON_SELECT      (                 S_IO |                        S_SELECT )</span>
<span class="cp">#define BUSMON_RESELECT    (                 S_IO |                        S_SELECT )</span>
<span class="cp">#define BUSMON_PHASE_MASK  (          S_CD | S_IO | S_MESSAGE |            S_SELECT )</span>

<span class="cp">#define BUSPHASE_SELECT      ( BUSMON_SELECT      &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_COMMAND     ( BUSMON_COMMAND     &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_MESSAGE_IN  ( BUSMON_MESSAGE_IN  &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_MESSAGE_OUT ( BUSMON_MESSAGE_OUT &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_DATA_IN     ( BUSMON_DATA_IN     &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_DATA_OUT    ( BUSMON_DATA_OUT    &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_STATUS      ( BUSMON_STATUS      &amp; BUSMON_PHASE_MASK )</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>      <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span>                    <span class="n">stop</span><span class="p">;</span>
<span class="p">}</span> <span class="n">scsi_info_t</span><span class="p">;</span>


<span class="cm">/* synchronous transfer negotiation data */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_sync_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SyncNegotiation</span><span class="p">;</span>
<span class="cp">#define SYNC_NOT_YET 0</span>
<span class="cp">#define SYNC_OK      1</span>
<span class="cp">#define SYNC_NG      2</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">SyncPeriod</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">SyncOffset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SyncRegister</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AckWidth</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sync_data</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp_hw_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">BaseAddress</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">NumAddress</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">IrqNumber</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">MmioAddress</span><span class="p">;</span>
<span class="cp">#define NSP_MMIO_OFFSET 0x0800</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">MmioLength</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ScsiClockDiv</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TransferMode</span><span class="p">;</span>

	<span class="kt">int</span>           <span class="n">TimerCount</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">SelectionTimeOut</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">CurrentSC</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>int           CurrnetTarget;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span>           <span class="n">FifoCount</span><span class="p">;</span>

<span class="cp">#define MSGBUF_SIZE 20</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">MsgBuffer</span><span class="p">[</span><span class="n">MSGBUF_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">MsgLen</span><span class="p">;</span>

<span class="cp">#define N_TARGET 8</span>
	<span class="n">sync_data</span>     <span class="n">Sync</span><span class="p">[</span><span class="n">N_TARGET</span><span class="p">];</span>

	<span class="kt">char</span> <span class="n">nspinfo</span><span class="p">[</span><span class="mi">110</span><span class="p">];</span>     <span class="cm">/* description */</span>
	<span class="n">spinlock_t</span> <span class="n">Lock</span><span class="p">;</span>

	<span class="n">scsi_info_t</span>   <span class="o">*</span><span class="n">ScsiInfo</span><span class="p">;</span> <span class="cm">/* attach &lt;-&gt; detect glue */</span>


<span class="cp">#ifdef NSP_DEBUG</span>
	<span class="kt">int</span> <span class="n">CmdId</span><span class="p">;</span> <span class="cm">/* Accepted command serial number.</span>
<span class="cm">		      Used for debugging.             */</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="n">nsp_hw_data</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* Card service functions */</span>
<span class="k">static</span> <span class="kt">void</span>        <span class="n">nsp_cs_detach</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>        <span class="n">nsp_cs_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>        <span class="n">nsp_cs_config</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>

<span class="cm">/* Linux SCSI subsystem specific functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">nsp_detect</span>     <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span>  <span class="kt">char</span>      <span class="o">*</span><span class="n">nsp_info</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span>        <span class="kt">int</span>        <span class="n">nsp_proc_info</span>  <span class="p">(</span>
	                                 <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					 <span class="kt">char</span>   <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					 <span class="kt">char</span>  <span class="o">**</span><span class="n">start</span><span class="p">,</span>
					 <span class="kt">off_t</span>   <span class="n">offset</span><span class="p">,</span>
					 <span class="kt">int</span>     <span class="n">length</span><span class="p">,</span>
					 <span class="kt">int</span>     <span class="n">inout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nsp_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="cm">/* Error handler */</span>
<span class="cm">/*static int nsp_eh_abort       (struct scsi_cmnd *SCpnt);*/</span>
<span class="cm">/*static int nsp_eh_device_reset(struct scsi_cmnd *SCpnt);*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nsp_eh_bus_reset</span>    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nsp_eh_host_reset</span>   <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nsp_bus_reset</span>       <span class="p">(</span><span class="n">nsp_hw_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="cm">/* */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsphw_init</span>           <span class="p">(</span><span class="n">nsp_hw_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsphw_start_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nsp_start_timer</span>      <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">time</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_fifo_count</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nsp_pio_read</span>         <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nsp_pio_write</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_nexus</span>            <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nsp_scsi_done</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_analyze_sdtr</span>     <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_negate_signal</span>    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_expect_signal</span>    <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_phase</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">mask</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_xfer</span>             <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_dataphase_bypass</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nsp_reselected</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">nsp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">);</span>

<span class="cm">/* Interrupt handler */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>static irqreturn<em>t nspintr(int irq, void *dev</em>id);</p></td><td class="code"><div class="highlight"><pre><span class="cm">/* Module entry point*/</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">__init</span> <span class="n">nsp_cs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">nsp_cs_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Debug */</span>
<span class="cp">#ifdef NSP_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_command</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_phase</span>   <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_busphase</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stat</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_message</span> <span class="p">(</span><span class="n">nsp_hw_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp"># define show_command(ptr)   </span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp"># define show_phase(SCpnt)   </span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp"># define show_busphase(stat) </span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp"># define show_message(data)  </span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * SCSI phase</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">_scsi_phase</span> <span class="p">{</span>
	<span class="n">PH_UNDETERMINED</span> <span class="p">,</span>
	<span class="n">PH_ARBSTART</span>     <span class="p">,</span>
	<span class="n">PH_SELSTART</span>     <span class="p">,</span>
	<span class="n">PH_SELECTED</span>     <span class="p">,</span>
	<span class="n">PH_COMMAND</span>      <span class="p">,</span>
	<span class="n">PH_DATA</span>         <span class="p">,</span>
	<span class="n">PH_STATUS</span>       <span class="p">,</span>
	<span class="n">PH_MSG_IN</span>       <span class="p">,</span>
	<span class="n">PH_MSG_OUT</span>      <span class="p">,</span>
	<span class="n">PH_DISCONNECT</span>   <span class="p">,</span>
	<span class="n">PH_RESELECT</span>     <span class="p">,</span>
	<span class="n">PH_ABORT</span>        <span class="p">,</span>
	<span class="n">PH_RESET</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">_data_in_out</span> <span class="p">{</span>
	<span class="n">IO_UNKNOWN</span><span class="p">,</span>
	<span class="n">IO_IN</span><span class="p">,</span>
	<span class="n">IO_OUT</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">_burst_mode</span> <span class="p">{</span>
	<span class="n">BURST_IO8</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BURST_IO32</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">BURST_MEM32</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * SCSI messaage</span>
<span class="cm"> */</span>
<span class="cp">#define MSG_COMMAND_COMPLETE 0x00</span>
<span class="cp">#define MSG_EXTENDED         0x01</span>
<span class="cp">#define MSG_ABORT            0x06</span>
<span class="cp">#define MSG_NO_OPERATION     0x08</span>
<span class="cp">#define MSG_BUS_DEVICE_RESET 0x0c</span>

<span class="cp">#define MSG_EXT_SDTR         0x01</span>

<span class="cm">/* scatter-gather table */</span>
<span class="cp">#  define BUFFER_ADDR ((char *)((sg_virt(SCpnt-&gt;SCp.buffer))))</span>

<span class="cp">#endif  </span><span class="cm">/*__nsp_cs__*/</span><span class="cp"></span>
<span class="cm">/* end */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
