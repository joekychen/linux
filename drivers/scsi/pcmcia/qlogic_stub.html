<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › pcmcia › qlogic_stub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qlogic_stub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*======================================================================</span>

<span class="cm">    A driver for the Qlogic SCSI card</span>

<span class="cm">    qlogic_cs.c 1.79 2000/06/12 21:27:26</span>

<span class="cm">    The contents of this file are subject to the Mozilla Public</span>
<span class="cm">    License Version 1.1 (the &quot;License&quot;); you may not use this file</span>
<span class="cm">    except in compliance with the License. You may obtain a copy of</span>
<span class="cm">    the License at http://www.mozilla.org/MPL/</span>

<span class="cm">    Software distributed under the License is distributed on an &quot;AS</span>
<span class="cm">    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or</span>
<span class="cm">    implied. See the License for the specific language governing</span>
<span class="cm">    rights and limitations under the License.</span>

<span class="cm">    The initial developer of the original code is David A. Hinds</span>
<span class="cm">    &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds</span>
<span class="cm">    are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.</span>

<span class="cm">    Alternatively, the contents of this file may be used under the</span>
<span class="cm">    terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in which</span>
<span class="cm">    case the provisions of the GPL are applicable instead of the</span>
<span class="cm">    above.  If you wish to allow the use of your version of this file</span>
<span class="cm">    only under the terms of the GPL and not to allow others to use</span>
<span class="cm">    your version of this file under the MPL, indicate your decision</span>
<span class="cm">    by deleting the provisions above and replace them with the notice</span>
<span class="cm">    and other provisions required by the GPL.  If you do not delete</span>
<span class="cm">    the provisions above, a recipient may use your version of this</span>
<span class="cm">    file under either the MPL or the GPL.</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &quot;../qlogicfas408.h&quot;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ciscode.h&gt;</span>

<span class="cm">/* Set the following to 2 to use normal interrupt (active high/totempole-</span>
<span class="cm"> * tristate), otherwise use 0 (REQUIRED FOR PCMCIA) for active low, open</span>
<span class="cm"> * drain</span>
<span class="cm"> */</span>
<span class="cp">#define INT_TYPE	0</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">qlogic_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;qlogic_cs&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">qlogicfas_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">qlogic_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="n">qlogic_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">qlogicfas408_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">qlogicfas408_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">qlogicfas408_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">qlogicfas408_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">qlogicfas408_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">scsi_info_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">manf_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">scsi_info_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qlogic_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlogic_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlogic_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span> <span class="n">link</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="nf">qlogic_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qbase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qlirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qltyp</span><span class="p">;</span>		<span class="cm">/* type of chip */</span>
	<span class="kt">int</span> <span class="n">qinitid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>	<span class="cm">/* registered host structure */</span>
	<span class="k">struct</span> <span class="n">qlogicfas408_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">qltyp</span> <span class="o">=</span> <span class="n">qlogicfas408_get_chip_type</span><span class="p">(</span><span class="n">qbase</span><span class="p">,</span> <span class="n">INT_TYPE</span><span class="p">);</span>
	<span class="n">qinitid</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qinitid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">qinitid</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* if no ID, use 7 */</span>

	<span class="n">qlogicfas408_setup</span><span class="p">(</span><span class="n">qbase</span><span class="p">,</span> <span class="n">qinitid</span><span class="p">,</span> <span class="n">INT_TYPE</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">qlogic_name</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicfas408_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">qbase</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlirq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">qlirq</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">get_priv_by_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qlirq</span> <span class="o">=</span> <span class="n">qlirq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qbase</span> <span class="o">=</span> <span class="n">qbase</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">qinitid</span> <span class="o">=</span> <span class="n">qinitid</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">int_type</span> <span class="o">=</span> <span class="n">INT_TYPE</span><span class="p">;</span>					

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">qlirq</span><span class="p">,</span> <span class="n">qlogicfas408_ihandl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qlogic_name</span><span class="p">,</span> <span class="n">shost</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_scsi_host</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qinfo</span><span class="p">,</span>
		<span class="s">&quot;Qlogicfas Driver version 0.46, chip %02X at %03X, IRQ %d, TPdma:%d&quot;</span><span class="p">,</span>
		<span class="n">qltyp</span><span class="p">,</span> <span class="n">qbase</span><span class="p">,</span> <span class="n">qlirq</span><span class="p">,</span> <span class="n">QL_TURBO_PDMA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_interrupt</span><span class="p">;</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">shost</span><span class="p">;</span>

<span class="nl">free_interrupt:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">qlirq</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>

<span class="nl">free_scsi_host:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	
<span class="nl">err:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;qlogic_attach()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Create new SCSI device */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_ENABLE_IRQ</span> <span class="o">|</span> <span class="n">CONF_AUTO_SET_IO</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_regs</span> <span class="o">=</span> <span class="n">PRESENT_OPTION</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">qlogic_config</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* qlogic_attach */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlogic_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;qlogic_detach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qlogic_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

<span class="p">}</span>				<span class="cm">/* qlogic_detach */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogic_config_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">io_lines</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IO_DATA_PATH_WIDTH</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IO_DATA_PATH_WIDTH_AUTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogic_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span> <span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;qlogic_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_loop_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">qlogic_config_check</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_MACNICA</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_PIONEER</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="mh">0x0098</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set ATAcmd */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The KXL-810AN has a bigger IO port window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">host</span> <span class="o">=</span> <span class="n">qlogic_detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlogicfas_driver_template</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">host</span> <span class="o">=</span> <span class="n">qlogic_detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlogicfas_driver_template</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: no SCSI devices found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qlogic_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* qlogic_config */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlogic_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;qlogic_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogic_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_info_t</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_MACNICA</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="n">MANFID_PIONEER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">==</span> <span class="mh">0x0098</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Ugggglllyyyy!!! */</span>
	<span class="n">qlogicfas408_bus_reset</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">qlogic_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;EIger Labs&quot;</span><span class="p">,</span> <span class="s">&quot;PCMCIA-to-SCSI Adapter&quot;</span><span class="p">,</span> <span class="mh">0x88395fa7</span><span class="p">,</span> <span class="mh">0x33b7a5e6</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;EPSON&quot;</span><span class="p">,</span> <span class="s">&quot;SCSI-2 PC Card SC200&quot;</span><span class="p">,</span> <span class="mh">0xd361772f</span><span class="p">,</span> <span class="mh">0x299d1751</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;MACNICA&quot;</span><span class="p">,</span> <span class="s">&quot;MIRACLE SCSI-II mPS110&quot;</span><span class="p">,</span> <span class="mh">0x20841b68</span><span class="p">,</span> <span class="mh">0xab3c3b6d</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;MIDORI ELECTRONICS &quot;</span><span class="p">,</span> <span class="s">&quot;CN-SC43&quot;</span><span class="p">,</span> <span class="mh">0x6534382a</span><span class="p">,</span> <span class="mh">0xd67eee79</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;NEC&quot;</span><span class="p">,</span> <span class="s">&quot;PC-9801N-J03R&quot;</span><span class="p">,</span> <span class="mh">0x18df0ba0</span><span class="p">,</span> <span class="mh">0x24662e8a</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;KME &quot;</span><span class="p">,</span> <span class="s">&quot;KXLC003&quot;</span><span class="p">,</span> <span class="mh">0x82375a27</span><span class="p">,</span> <span class="mh">0xf68e5bf7</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;KME &quot;</span><span class="p">,</span> <span class="s">&quot;KXLC004&quot;</span><span class="p">,</span> <span class="mh">0x82375a27</span><span class="p">,</span> <span class="mh">0x68eace54</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;KME&quot;</span><span class="p">,</span> <span class="s">&quot;KXLC101&quot;</span><span class="p">,</span> <span class="mh">0x3faee676</span><span class="p">,</span> <span class="mh">0x194250ec</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;QLOGIC CORPORATION&quot;</span><span class="p">,</span> <span class="s">&quot;pc05&quot;</span><span class="p">,</span> <span class="mh">0xd77b2930</span><span class="p">,</span> <span class="mh">0xa85b2735</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;QLOGIC CORPORATION&quot;</span><span class="p">,</span> <span class="s">&quot;pc05 rev 1.10&quot;</span><span class="p">,</span> <span class="mh">0xd77b2930</span><span class="p">,</span> <span class="mh">0x70f8b5f8</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID123</span><span class="p">(</span><span class="s">&quot;KME&quot;</span><span class="p">,</span> <span class="s">&quot;KXLC002&quot;</span><span class="p">,</span> <span class="s">&quot;00&quot;</span><span class="p">,</span> <span class="mh">0x3faee676</span><span class="p">,</span> <span class="mh">0x81896b61</span><span class="p">,</span> <span class="mh">0xf99f065f</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;RATOC System Inc.&quot;</span><span class="p">,</span> <span class="s">&quot;SCSI2 CARD 37&quot;</span><span class="p">,</span> <span class="mh">0x85c10e17</span><span class="p">,</span> <span class="mh">0x1a2640c1</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;TOSHIBA&quot;</span><span class="p">,</span> <span class="s">&quot;SCSC200A PC CARD SCSI&quot;</span><span class="p">,</span> <span class="mh">0xb4585a1a</span><span class="p">,</span> <span class="mh">0xa6f06ebe</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;TOSHIBA&quot;</span><span class="p">,</span> <span class="s">&quot;SCSC200B PC CARD SCSI-10&quot;</span><span class="p">,</span> <span class="mh">0xb4585a1a</span><span class="p">,</span> <span class="mh">0x0a88dea0</span><span class="p">),</span>
	<span class="cm">/* these conflict with other cards! */</span>
	<span class="cm">/* PCMCIA_DEVICE_PROD_ID123(&quot;MACNICA&quot;, &quot;MIRACLE SCSI&quot;, &quot;mPS100&quot;, 0x20841b68, 0xf8dedaeb, 0x89f7fafb), */</span>
	<span class="cm">/* PCMCIA_DEVICE_PROD_ID123(&quot;MACNICA&quot;, &quot;MIRACLE SCSI&quot;, &quot;mPS100&quot;, 0x20841b68, 0xf8dedaeb, 0x89f7fafb), */</span>
	<span class="n">PCMCIA_DEVICE_NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">qlogic_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">qlogic_cs_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;qlogic_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">qlogic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">qlogic_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">qlogic_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">qlogic_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_qlogic_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlogic_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_qlogic_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlogic_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Tom Zerucha, Michael Griffith&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for the PCMCIA Qlogic FAS SCSI controllers&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">init_qlogic_cs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_qlogic_cs</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
