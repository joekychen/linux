<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › mvumi.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mvumi.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  * Marvell UMI head file</span>
<span class="cm">  *</span>
<span class="cm">  * Copyright 2011 Marvell. &lt;jyli@marvell.com&gt;</span>
<span class="cm">  *</span>
<span class="cm">  * This file is licensed under GPLv2.</span>
<span class="cm">  *</span>
<span class="cm">  * This program is free software; you can redistribute it and/or</span>
<span class="cm">  * modify it under the terms of the GNU General Public License as</span>
<span class="cm">  * published by the Free Software Foundation; version 2 of the</span>
<span class="cm">  * License.</span>
<span class="cm">  *</span>
<span class="cm">  * This program is distributed in the hope that it will be useful,</span>
<span class="cm">  * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm">  * General Public License for more details.</span>
<span class="cm">  *</span>
<span class="cm">  * You should have received a copy of the GNU General Public License</span>
<span class="cm">  * along with this program; if not, write to the Free Software</span>
<span class="cm">  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span>
<span class="cm">  * USA</span>
<span class="cm"> */</span>

<span class="cp">#ifndef MVUMI_H</span>
<span class="cp">#define MVUMI_H</span>

<span class="cp">#define MAX_BASE_ADDRESS	6</span>

<span class="cp">#define VER_MAJOR		1</span>
<span class="cp">#define VER_MINOR		1</span>
<span class="cp">#define VER_OEM			0</span>
<span class="cp">#define VER_BUILD		1500</span>

<span class="cp">#define MV_DRIVER_NAME			&quot;mvumi&quot;</span>
<span class="cp">#define PCI_VENDOR_ID_MARVELL_2		0x1b4b</span>
<span class="cp">#define PCI_DEVICE_ID_MARVELL_MV9143	0x9143</span>

<span class="cp">#define MVUMI_INTERNAL_CMD_WAIT_TIME	45</span>

<span class="cp">#define IS_DMA64			(sizeof(dma_addr_t) == 8)</span>

<span class="k">enum</span> <span class="n">mvumi_qc_result</span> <span class="p">{</span>
	<span class="n">MV_QUEUE_COMMAND_RESULT_SENT</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MV_QUEUE_COMMAND_RESULT_NO_RESOURCE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/*******************************************/</span>

	<span class="cm">/* ARM Mbus Registers Map	*/</span>

	<span class="cm">/*******************************************/</span>
	<span class="n">CPU_MAIN_INT_CAUSE_REG</span>	<span class="o">=</span> <span class="mh">0x20200</span><span class="p">,</span>
	<span class="n">CPU_MAIN_IRQ_MASK_REG</span>	<span class="o">=</span> <span class="mh">0x20204</span><span class="p">,</span>
	<span class="n">CPU_MAIN_FIQ_MASK_REG</span>	<span class="o">=</span> <span class="mh">0x20208</span><span class="p">,</span>
	<span class="n">CPU_ENPOINTA_MASK_REG</span>	<span class="o">=</span> <span class="mh">0x2020C</span><span class="p">,</span>
	<span class="n">CPU_ENPOINTB_MASK_REG</span>	<span class="o">=</span> <span class="mh">0x20210</span><span class="p">,</span>

	<span class="n">INT_MAP_COMAERR</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">INT_MAP_COMAIN</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">INT_MAP_COMAOUT</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">INT_MAP_COMBERR</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">INT_MAP_COMBIN</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">INT_MAP_COMBOUT</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">,</span>

	<span class="n">INT_MAP_COMAINT</span>	<span class="o">=</span> <span class="p">(</span><span class="n">INT_MAP_COMAOUT</span> <span class="o">|</span> <span class="n">INT_MAP_COMAERR</span><span class="p">),</span>
	<span class="n">INT_MAP_COMBINT</span>	<span class="o">=</span> <span class="p">(</span><span class="n">INT_MAP_COMBOUT</span> <span class="o">|</span> <span class="n">INT_MAP_COMBIN</span> <span class="o">|</span> <span class="n">INT_MAP_COMBERR</span><span class="p">),</span>

	<span class="n">INT_MAP_DL_PCIEA2CPU</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">INT_MAP_DL_CPU2PCIEA</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/***************************************/</span>

	<span class="cm">/* ARM Doorbell Registers Map		*/</span>

	<span class="cm">/***************************************/</span>
	<span class="n">CPU_PCIEA_TO_ARM_DRBL_REG</span>	<span class="o">=</span> <span class="mh">0x20400</span><span class="p">,</span>
	<span class="n">CPU_PCIEA_TO_ARM_MASK_REG</span>	<span class="o">=</span> <span class="mh">0x20404</span><span class="p">,</span>
	<span class="n">CPU_ARM_TO_PCIEA_DRBL_REG</span>	<span class="o">=</span> <span class="mh">0x20408</span><span class="p">,</span>
	<span class="n">CPU_ARM_TO_PCIEA_MASK_REG</span>	<span class="o">=</span> <span class="mh">0x2040C</span><span class="p">,</span>

	<span class="n">DRBL_HANDSHAKE</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DRBL_SOFT_RESET</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">DRBL_BUS_CHANGE</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">DRBL_EVENT_NOTIFY</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">DRBL_MU_RESET</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">DRBL_HANDSHAKE_ISR</span>		<span class="o">=</span> <span class="n">DRBL_HANDSHAKE</span><span class="p">,</span>

	<span class="n">CPU_PCIEA_TO_ARM_MSG0</span>		<span class="o">=</span> <span class="mh">0x20430</span><span class="p">,</span>
	<span class="n">CPU_PCIEA_TO_ARM_MSG1</span>		<span class="o">=</span> <span class="mh">0x20434</span><span class="p">,</span>
	<span class="n">CPU_ARM_TO_PCIEA_MSG0</span>		<span class="o">=</span> <span class="mh">0x20438</span><span class="p">,</span>
	<span class="n">CPU_ARM_TO_PCIEA_MSG1</span>		<span class="o">=</span> <span class="mh">0x2043C</span><span class="p">,</span>

	<span class="cm">/*******************************************/</span>

	<span class="cm">/* ARM Communication List Registers Map    */</span>

	<span class="cm">/*******************************************/</span>
	<span class="n">CLA_INB_LIST_BASEL</span>		<span class="o">=</span> <span class="mh">0x500</span><span class="p">,</span>
	<span class="n">CLA_INB_LIST_BASEH</span>		<span class="o">=</span> <span class="mh">0x504</span><span class="p">,</span>
	<span class="n">CLA_INB_AVAL_COUNT_BASEL</span>	<span class="o">=</span> <span class="mh">0x508</span><span class="p">,</span>
	<span class="n">CLA_INB_AVAL_COUNT_BASEH</span>	<span class="o">=</span> <span class="mh">0x50C</span><span class="p">,</span>
	<span class="n">CLA_INB_DESTI_LIST_BASEL</span>	<span class="o">=</span> <span class="mh">0x510</span><span class="p">,</span>
	<span class="n">CLA_INB_DESTI_LIST_BASEH</span>	<span class="o">=</span> <span class="mh">0x514</span><span class="p">,</span>
	<span class="n">CLA_INB_WRITE_POINTER</span>		<span class="o">=</span> <span class="mh">0x518</span><span class="p">,</span>
	<span class="n">CLA_INB_READ_POINTER</span>		<span class="o">=</span> <span class="mh">0x51C</span><span class="p">,</span>

	<span class="n">CLA_OUTB_LIST_BASEL</span>		<span class="o">=</span> <span class="mh">0x530</span><span class="p">,</span>
	<span class="n">CLA_OUTB_LIST_BASEH</span>		<span class="o">=</span> <span class="mh">0x534</span><span class="p">,</span>
	<span class="n">CLA_OUTB_SOURCE_LIST_BASEL</span>	<span class="o">=</span> <span class="mh">0x538</span><span class="p">,</span>
	<span class="n">CLA_OUTB_SOURCE_LIST_BASEH</span>	<span class="o">=</span> <span class="mh">0x53C</span><span class="p">,</span>
	<span class="n">CLA_OUTB_COPY_POINTER</span>		<span class="o">=</span> <span class="mh">0x544</span><span class="p">,</span>
	<span class="n">CLA_OUTB_READ_POINTER</span>		<span class="o">=</span> <span class="mh">0x548</span><span class="p">,</span>

	<span class="n">CLA_ISR_CAUSE</span>			<span class="o">=</span> <span class="mh">0x560</span><span class="p">,</span>
	<span class="n">CLA_ISR_MASK</span>			<span class="o">=</span> <span class="mh">0x564</span><span class="p">,</span>

	<span class="n">INT_MAP_MU</span>		<span class="o">=</span> <span class="p">(</span><span class="n">INT_MAP_DL_CPU2PCIEA</span> <span class="o">|</span> <span class="n">INT_MAP_COMAINT</span><span class="p">),</span>

	<span class="n">CL_POINTER_TOGGLE</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>

	<span class="n">CLIC_IN_IRQ</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CLIC_OUT_IRQ</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CLIC_IN_ERR_IRQ</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">CLIC_OUT_ERR_IRQ</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span>

	<span class="n">CL_SLOT_NUM_MASK</span>		<span class="o">=</span> <span class="mh">0xFFF</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	* Command flag is the flag for the CDB command itself</span>
<span class="cm">	*/</span>
	<span class="cm">/* 1-non data; 0-data command */</span>
	<span class="n">CMD_FLAG_NON_DATA</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CMD_FLAG_DMA</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CMD_FLAG_PIO</span>			<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* 1-host read data */</span>
	<span class="n">CMD_FLAG_DATA_IN</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="cm">/* 1-host write data */</span>
	<span class="n">CMD_FLAG_DATA_OUT</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>

	<span class="n">SCSI_CMD_MARVELL_SPECIFIC</span>	<span class="o">=</span> <span class="mh">0xE1</span><span class="p">,</span>
	<span class="n">CDB_CORE_SHUTDOWN</span>		<span class="o">=</span> <span class="mh">0xB</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define APICDB0_EVENT			0xF4</span>
<span class="cp">#define APICDB1_EVENT_GETEVENT		0</span>
<span class="cp">#define MAX_EVENTS_RETURNED		6</span>

<span class="k">struct</span> <span class="n">mvumi_driver_event</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">time_stamp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">sequence_no</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">event_id</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">severity</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">param_count</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">device_id</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">sense_data_length</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">Reserved1</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">sense_data</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_event_req</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mvumi_driver_event</span>  <span class="n">events</span><span class="p">[</span><span class="n">MAX_EVENTS_RETURNED</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_events_wq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mvumi_hba</span> <span class="o">*</span><span class="n">mhba</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MVUMI_MAX_SG_ENTRY	32</span>
<span class="cp">#define SGD_EOT			(1L &lt;&lt; 27)</span>

<span class="k">struct</span> <span class="n">mvumi_sgl</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">baseaddr_l</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">baseaddr_h</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_res</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* enum Resource_Type */</span>
<span class="p">};</span>

<span class="cm">/* Resource type */</span>
<span class="k">enum</span> <span class="n">resource_type</span> <span class="p">{</span>
	<span class="n">RESOURCE_CACHED_MEMORY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RESOURCE_UNCACHED_MEMORY</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_sense_data</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">error_eode</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">segment_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sense_key</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">incorrect_length</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">end_of_media</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">file_mark</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">information</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">additional_sense_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">command_specific_information</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">additional_sense_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">additional_sense_code_qualifier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">field_replaceable_unit_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sense_key_specific</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Request initiator must set the status to REQ_STATUS_PENDING. */</span>
<span class="cp">#define REQ_STATUS_PENDING		0x80</span>

<span class="k">struct</span> <span class="n">mvumi_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue_pointer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mvumi_msg_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">sync_cmd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * the function type of the in bound frame</span>
<span class="cm"> */</span>
<span class="cp">#define CL_FUN_SCSI_CMD			0x1</span>

<span class="k">struct</span> <span class="n">mvumi_msg_frame</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_flag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">req_function</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cdb_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sg_counts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_transfer_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cdb</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * the respond flag for data_payload of the out bound frame</span>
<span class="cm"> */</span>
<span class="cp">#define CL_RSP_FLAG_NODATA		0x0</span>
<span class="cp">#define CL_RSP_FLAG_SENSEDATA		0x1</span>

<span class="k">struct</span> <span class="n">mvumi_rsp_frame</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">req_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp_flag</span><span class="p">;</span>	<span class="cm">/* Indicates the type of Data_Payload.*/</span>
	<span class="n">u16</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_ob_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">version_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ver_major</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ver_minor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ver_oem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ver_build</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FW_MAX_DELAY			30</span>
<span class="cp">#define MVUMI_FW_BUSY			(1U &lt;&lt; 0)</span>
<span class="cp">#define MVUMI_FW_ATTACH			(1U &lt;&lt; 1)</span>
<span class="cp">#define MVUMI_FW_ALLOC			(1U &lt;&lt; 2)</span>

<span class="cm">/*</span>
<span class="cm"> * State is the state of the MU</span>
<span class="cm"> */</span>
<span class="cp">#define FW_STATE_IDLE			0</span>
<span class="cp">#define FW_STATE_STARTING		1</span>
<span class="cp">#define FW_STATE_HANDSHAKING		2</span>
<span class="cp">#define FW_STATE_STARTED		3</span>
<span class="cp">#define FW_STATE_ABORT			4</span>

<span class="cp">#define HANDSHAKE_SIGNATURE		0x5A5A5A5AL</span>
<span class="cp">#define HANDSHAKE_READYSTATE		0x55AA5AA5L</span>
<span class="cp">#define HANDSHAKE_DONESTATE		0x55AAA55AL</span>

<span class="cm">/* HandShake Status definition */</span>
<span class="cp">#define HS_STATUS_OK			1</span>
<span class="cp">#define HS_STATUS_ERR			2</span>
<span class="cp">#define HS_STATUS_INVALID		3</span>

<span class="cm">/* HandShake State/Cmd definition */</span>
<span class="cp">#define HS_S_START			1</span>
<span class="cp">#define HS_S_RESET			2</span>
<span class="cp">#define HS_S_PAGE_ADDR			3</span>
<span class="cp">#define HS_S_QUERY_PAGE			4</span>
<span class="cp">#define HS_S_SEND_PAGE			5</span>
<span class="cp">#define HS_S_END			6</span>
<span class="cp">#define HS_S_ABORT			7</span>
<span class="cp">#define HS_PAGE_VERIFY_SIZE		128</span>

<span class="cp">#define HS_GET_STATE(a)			(a &amp; 0xFFFF)</span>
<span class="cp">#define HS_GET_STATUS(a)		((a &amp; 0xFFFF0000) &gt;&gt; 16)</span>
<span class="cp">#define HS_SET_STATE(a, b)		(a |= (b &amp; 0xFFFF))</span>
<span class="cp">#define HS_SET_STATUS(a, b)		(a |= ((b &amp; 0xFFFF) &lt;&lt; 16))</span>

<span class="cm">/* handshake frame */</span>
<span class="k">struct</span> <span class="n">mvumi_hs_frame</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="cm">/* host information */</span>
	<span class="n">u8</span> <span class="n">host_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">version_info</span> <span class="n">host_ver</span><span class="p">;</span> <span class="cm">/* bios or driver version */</span>

	<span class="cm">/* controller information */</span>
	<span class="n">u32</span> <span class="n">system_io_bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slot_number</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_level</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_vector</span><span class="p">;</span>

	<span class="cm">/* communication list configuration */</span>
	<span class="n">u32</span> <span class="n">ib_baseaddr_l</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ib_baseaddr_h</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ob_baseaddr_l</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ob_baseaddr_h</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">ib_entry_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ob_entry_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ob_depth</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ib_depth</span><span class="p">;</span>

	<span class="cm">/* system time */</span>
	<span class="n">u64</span> <span class="n">seconds_since1970</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_hs_header</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">frame_length</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">frame_content</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * the page code type of the handshake header</span>
<span class="cm"> */</span>
<span class="cp">#define HS_PAGE_FIRM_CAP	0x1</span>
<span class="cp">#define HS_PAGE_HOST_INFO	0x2</span>
<span class="cp">#define HS_PAGE_FIRM_CTL	0x3</span>
<span class="cp">#define HS_PAGE_CL_INFO		0x4</span>
<span class="cp">#define HS_PAGE_TOTAL		0x5</span>

<span class="cp">#define HSP_SIZE(i)	sizeof(struct mvumi_hs_page##i)</span>

<span class="cp">#define HSP_MAX_SIZE ({					\</span>
<span class="cp">	int size, m1, m2;				\</span>
<span class="cp">	m1 = max(HSP_SIZE(1), HSP_SIZE(3));		\</span>
<span class="cp">	m2 = max(HSP_SIZE(2), HSP_SIZE(4));		\</span>
<span class="cp">	size = max(m1, m2);				\</span>
<span class="cp">	size;						\</span>
<span class="cp">})</span>

<span class="cm">/* The format of the page code for Firmware capability */</span>
<span class="k">struct</span> <span class="n">mvumi_hs_page1</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">pagecode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_length</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">number_of_ports</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_devices_support</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_io_support</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">umi_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_transfer_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">version_info</span> <span class="n">fw_ver</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cl_in_max_entry_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cl_out_max_entry_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cl_inout_list_depth</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">total_pages</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capability</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The format of the page code for Host information */</span>
<span class="k">struct</span> <span class="n">mvumi_hs_page2</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">pagecode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_length</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">host_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">version_info</span> <span class="n">host_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">system_io_bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slot_number</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_level</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_vector</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">seconds_since1970</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The format of the page code for firmware control  */</span>
<span class="k">struct</span> <span class="n">mvumi_hs_page3</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">pagecode</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">frame_length</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">control</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">host_bufferaddr_l</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">host_bufferaddr_h</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">host_eventaddr_l</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">host_eventaddr_h</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_hs_page4</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">pagecode</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">frame_length</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ib_baseaddr_l</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ib_baseaddr_h</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ob_baseaddr_l</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ob_baseaddr_h</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">ib_entry_size</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">ob_entry_size</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">ob_depth</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">ib_depth</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_tag</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">top</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_hba</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">[</span><span class="n">MAX_BASE_ADDRESS</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">cmd_pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">int_cmd_wait_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unique_id</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">fw_outstanding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mvumi_instance_template</span> <span class="o">*</span><span class="n">instancet</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">ib_list</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ib_list_phys</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">ob_list</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ob_list_phys</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">ib_shadow</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ib_shadow_phys</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">ob_shadow</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ob_shadow_phys</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">handshake_page</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">handshake_page_phys</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">global_isr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isr_status</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">max_sge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">max_target_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_io</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list_num_io</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ib_max_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ob_max_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ib_max_size_setting</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ob_max_size_setting</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_transfer_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hba_total_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fw_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">request_id_enabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hba_capability</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">io_seq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ib_cur_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ob_cur_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_state</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ob_data_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">free_ob_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">res_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">waiting_req_list</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mvumi_tag</span> <span class="n">tag_pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mvumi_cmd</span> <span class="o">**</span><span class="n">tag_cmd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mvumi_instance_template</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fire_cmd</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mvumi_hba</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mvumi_cmd</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">enable_intr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">disable_intr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">clear_intr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_fw_status_reg</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">timezone</span> <span class="n">sys_tz</span><span class="p">;</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
