<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › ips.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ips.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************/</span>
<span class="cm">/* ips.c -- driver for the Adaptec / IBM ServeRAID controller                */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* Written By: Keith Mitchell, IBM Corporation                               */</span>
<span class="cm">/*             Jack Hammer, Adaptec, Inc.                                    */</span>
<span class="cm">/*             David Jeffery, Adaptec, Inc.                                  */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* Copyright (C) 2000 IBM Corporation                                        */</span>
<span class="cm">/* Copyright (C) 2002,2003 Adaptec, Inc.                                     */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* This program is free software; you can redistribute it and/or modify      */</span>
<span class="cm">/* it under the terms of the GNU General Public License as published by      */</span>
<span class="cm">/* the Free Software Foundation; either version 2 of the License, or         */</span>
<span class="cm">/* (at your option) any later version.                                       */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* This program is distributed in the hope that it will be useful,           */</span>
<span class="cm">/* but WITHOUT ANY WARRANTY; without even the implied warranty of            */</span>
<span class="cm">/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             */</span>
<span class="cm">/* GNU General Public License for more details.                              */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* NO WARRANTY                                                               */</span>
<span class="cm">/* THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR        */</span>
<span class="cm">/* CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT      */</span>
<span class="cm">/* LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,      */</span>
<span class="cm">/* MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is    */</span>
<span class="cm">/* solely responsible for determining the appropriateness of using and       */</span>
<span class="cm">/* distributing the Program and assumes all risks associated with its        */</span>
<span class="cm">/* exercise of rights under this Agreement, including but not limited to     */</span>
<span class="cm">/* the risks and costs of program errors, damage to or loss of data,         */</span>
<span class="cm">/* programs or equipment, and unavailability or interruption of operations.  */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* DISCLAIMER OF LIABILITY                                                   */</span>
<span class="cm">/* NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY   */</span>
<span class="cm">/* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL        */</span>
<span class="cm">/* DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND   */</span>
<span class="cm">/* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR     */</span>
<span class="cm">/* TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE    */</span>
<span class="cm">/* USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED  */</span>
<span class="cm">/* HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES             */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* You should have received a copy of the GNU General Public License         */</span>
<span class="cm">/* along with this program; if not, write to the Free Software               */</span>
<span class="cm">/* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* Bugs/Comments/Suggestions about this driver should be mailed to:          */</span>
<span class="cm">/*      ipslinux@adaptec.com        	                                     */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* For system support issues, contact your local IBM Customer support.       */</span>
<span class="cm">/* Directions to find IBM Customer Support for each country can be found at: */</span>
<span class="cm">/*      http://www.ibm.com/planetwide/                                       */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* Change Log                                                                */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* 0.99.02  - Breakup commands that are bigger than 8 * the stripe size      */</span>
<span class="cm">/* 0.99.03  - Make interrupt routine handle all completed request on the     */</span>
<span class="cm">/*            adapter not just the first one                                 */</span>
<span class="cm">/*          - Make sure passthru commands get woken up if we run out of      */</span>
<span class="cm">/*            SCBs                                                           */</span>
<span class="cm">/*          - Send all of the commands on the queue at once rather than      */</span>
<span class="cm">/*            one at a time since the card will support it.                  */</span>
<span class="cm">/* 0.99.04  - Fix race condition in the passthru mechanism -- this required  */</span>
<span class="cm">/*            the interface to the utilities to change                       */</span>
<span class="cm">/*          - Fix error recovery code                                        */</span>
<span class="cm">/* 0.99.05  - Fix an oops when we get certain passthru commands              */</span>
<span class="cm">/* 1.00.00  - Initial Public Release                                         */</span>
<span class="cm">/*            Functionally equivalent to 0.99.05                             */</span>
<span class="cm">/* 3.60.00  - Bump max commands to 128 for use with firmware 3.60            */</span>
<span class="cm">/*          - Change version to 3.60 to coincide with release numbering.     */</span>
<span class="cm">/* 3.60.01  - Remove bogus error check in passthru routine                   */</span>
<span class="cm">/* 3.60.02  - Make DCDB direction based on lookup table                      */</span>
<span class="cm">/*          - Only allow one DCDB command to a SCSI ID at a time             */</span>
<span class="cm">/* 4.00.00  - Add support for ServeRAID 4                                    */</span>
<span class="cm">/* 4.00.01  - Add support for First Failure Data Capture                     */</span>
<span class="cm">/* 4.00.02  - Fix problem with PT DCDB with no buffer                        */</span>
<span class="cm">/* 4.00.03  - Add alternative passthru interface                             */</span>
<span class="cm">/*          - Add ability to flash BIOS                                      */</span>
<span class="cm">/* 4.00.04  - Rename structures/constants to be prefixed with IPS_           */</span>
<span class="cm">/* 4.00.05  - Remove wish_block from init routine                            */</span>
<span class="cm">/*          - Use linux/spinlock.h instead of asm/spinlock.h for kernels     */</span>
<span class="cm">/*            2.3.18 and later                                               */</span>
<span class="cm">/*          - Sync with other changes from the 2.3 kernels                   */</span>
<span class="cm">/* 4.00.06  - Fix timeout with initial FFDC command                          */</span>
<span class="cm">/* 4.00.06a - Port to 2.4 (trivial) -- Christoph Hellwig &lt;hch@infradead.org&gt; */</span>
<span class="cm">/* 4.10.00  - Add support for ServeRAID 4M/4L                                */</span>
<span class="cm">/* 4.10.13  - Fix for dynamic unload and proc file system                    */</span>
<span class="cm">/* 4.20.03  - Rename version to coincide with new release schedules          */</span>
<span class="cm">/*            Performance fixes                                              */</span>
<span class="cm">/*            Fix truncation of /proc files with cat                         */</span>
<span class="cm">/*            Merge in changes through kernel 2.4.0test1ac21                 */</span>
<span class="cm">/* 4.20.13  - Fix some failure cases / reset code                            */</span>
<span class="cm">/*          - Hook into the reboot_notifier to flush the controller cache    */</span>
<span class="cm">/* 4.50.01  - Fix problem when there is a hole in logical drive numbering    */</span>
<span class="cm">/* 4.70.09  - Use a Common ( Large Buffer ) for Flashing from the JCRM CD    */</span>
<span class="cm">/*          - Add IPSSEND Flash Support                                      */</span>
<span class="cm">/*          - Set Sense Data for Unknown SCSI Command                        */</span>
<span class="cm">/*          - Use Slot Number from NVRAM Page 5                              */</span>
<span class="cm">/*          - Restore caller&#39;s DCDB Structure                                */</span>
<span class="cm">/* 4.70.12  - Corrective actions for bad controller ( during initialization )*/</span>
<span class="cm">/* 4.70.13  - Don&#39;t Send CDB&#39;s if we already know the device is not present  */</span>
<span class="cm">/*          - Don&#39;t release HA Lock in ips_next() until SC taken off queue   */</span>
<span class="cm">/*          - Unregister SCSI device in ips_release()                        */</span>
<span class="cm">/* 4.70.15  - Fix Breakup for very large ( non-SG ) requests in ips_done()   */</span>
<span class="cm">/* 4.71.00  - Change all memory allocations to not use GFP_DMA flag          */</span>
<span class="cm">/*            Code Clean-Up for 2.4.x kernel                                 */</span>
<span class="cm">/* 4.72.00  - Allow for a Scatter-Gather Element to exceed MAX_XFER Size     */</span>
<span class="cm">/* 4.72.01  - I/O Mapped Memory release ( so &quot;insmod ips&quot; does not Fail )    */</span>
<span class="cm">/*          - Don&#39;t Issue Internal FFDC Command if there are Active Commands */</span>
<span class="cm">/*          - Close Window for getting too many IOCTL&#39;s active               */</span>
<span class="cm">/* 4.80.00  - Make ia64 Safe                                                 */</span>
<span class="cm">/* 4.80.04  - Eliminate calls to strtok() if 2.4.x or greater                */</span>
<span class="cm">/*          - Adjustments to Device Queue Depth                              */</span>
<span class="cm">/* 4.80.14  - Take all semaphores off stack                                  */</span>
<span class="cm">/*          - Clean Up New_IOCTL path                                        */</span>
<span class="cm">/* 4.80.20  - Set max_sectors in Scsi_Host structure ( if &gt;= 2.4.7 kernel )  */</span>
<span class="cm">/*          - 5 second delay needed after resetting an i960 adapter          */</span>
<span class="cm">/* 4.80.26  - Clean up potential code problems ( Arjan&#39;s recommendations )   */</span>
<span class="cm">/* 4.90.01  - Version Matching for FirmWare, BIOS, and Driver                */</span>
<span class="cm">/* 4.90.05  - Use New PCI Architecture to facilitate Hot Plug Development    */</span>
<span class="cm">/* 4.90.08  - Increase Delays in Flashing ( Trombone Only - 4H )             */</span>
<span class="cm">/* 4.90.08  - Data Corruption if First Scatter Gather Element is &gt; 64K       */</span>
<span class="cm">/* 4.90.11  - Don&#39;t actually RESET unless it&#39;s physically required           */</span>
<span class="cm">/*          - Remove unused compile options                                  */</span>
<span class="cm">/* 5.00.01  - Sarasota ( 5i ) adapters must always be scanned first          */</span>
<span class="cm">/*          - Get rid on IOCTL_NEW_COMMAND code                              */</span>
<span class="cm">/*          - Add Extended DCDB Commands for Tape Support in 5I              */</span>
<span class="cm">/* 5.10.12  - use pci_dma interfaces, update for 2.5 kernel changes          */</span>
<span class="cm">/* 5.10.15  - remove unused code (sem, macros, etc.)                         */</span>
<span class="cm">/* 5.30.00  - use __devexit_p()                                              */</span>
<span class="cm">/* 6.00.00  - Add 6x Adapters and Battery Flash                              */</span>
<span class="cm">/* 6.10.00  - Remove 1G Addressing Limitations                               */</span>
<span class="cm">/* 6.11.xx  - Get VersionInfo buffer off the stack !              DDTS 60401 */</span>
<span class="cm">/* 6.11.xx  - Make Logical Drive Info structure safe for DMA      DDTS 60639 */</span>
<span class="cm">/* 7.10.18  - Add highmem_io flag in SCSI Templete for 2.4 kernels           */</span>
<span class="cm">/*          - Fix path/name for scsi_hosts.h include for 2.6 kernels         */</span>
<span class="cm">/*          - Fix sort order of 7k                                           */</span>
<span class="cm">/*          - Remove 3 unused &quot;inline&quot; functions                             */</span>
<span class="cm">/* 7.12.xx  - Use STATIC functions wherever possible                        */</span>
<span class="cm">/*          - Clean up deprecated MODULE_PARM calls                          */</span>
<span class="cm">/* 7.12.05  - Remove Version Matching per IBM request                        */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Conditional Compilation directives for this driver:</span>
<span class="cm"> *</span>
<span class="cm"> * IPS_DEBUG            - Turn on debugging info</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *</span>
<span class="cm"> * debug:&lt;number&gt;       - Set debug level to &lt;number&gt;</span>
<span class="cm"> *                        NOTE: only works when IPS_DEBUG compile directive is used.</span>
<span class="cm"> *       1              - Normal debug messages</span>
<span class="cm"> *       2              - Verbose debug messages</span>
<span class="cm"> *       11             - Method trace (non interrupt)</span>
<span class="cm"> *       12             - Method trace (includes interrupt)</span>
<span class="cm"> *</span>
<span class="cm"> * noi2o                - Don&#39;t use I2O Queues (ServeRAID 4 only)</span>
<span class="cm"> * nommap               - Don&#39;t use memory mapped I/O</span>
<span class="cm"> * ioctlsize            - Initial size of the IOCTL buffer</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;scsi/sg.h&gt;</span>
<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;ips.h&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/stat.h&gt;</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;linux/smp.h&gt;</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * DRIVER_VER</span>
<span class="cm"> */</span>
<span class="cp">#define IPS_VERSION_HIGH        IPS_VER_MAJOR_STRING &quot;.&quot; IPS_VER_MINOR_STRING</span>
<span class="cp">#define IPS_VERSION_LOW         &quot;.&quot; IPS_VER_BUILD_STRING &quot; &quot;</span>

<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__ia64__) &amp;&amp; !defined(__x86_64__)</span>
<span class="cp">#warning &quot;This driver has only been tested on the x86/ia64/x86_64 platforms&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define IPS_DMA_DIR(scb) ((!scb-&gt;scsi_cmd || ips_is_passthru(scb-&gt;scsi_cmd) || \</span>
<span class="cp">                         DMA_NONE == scb-&gt;scsi_cmd-&gt;sc_data_direction) ? \</span>
<span class="cp">                         PCI_DMA_BIDIRECTIONAL : \</span>
<span class="cp">                         scb-&gt;scsi_cmd-&gt;sc_data_direction)</span>

<span class="cp">#ifdef IPS_DEBUG</span>
<span class="cp">#define METHOD_TRACE(s, i)    if (ips_debug &gt;= (i+10)) printk(KERN_NOTICE s &quot;\n&quot;);</span>
<span class="cp">#define DEBUG(i, s)           if (ips_debug &gt;= i) printk(KERN_NOTICE s &quot;\n&quot;);</span>
<span class="cp">#define DEBUG_VAR(i, s, v...) if (ips_debug &gt;= i) printk(KERN_NOTICE s &quot;\n&quot;, v);</span>
<span class="cp">#else</span>
<span class="cp">#define METHOD_TRACE(s, i)</span>
<span class="cp">#define DEBUG(i, s)</span>
<span class="cp">#define DEBUG_VAR(i, s, v...)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Function prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ips_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_ipsintr</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_hainit</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_map_status</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_stat_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_send_cmd</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_online</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_inquiry</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_rdcap</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_msense</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_reqsen</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_deallocatescbs</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_allocatescbs</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_reset_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_reset_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_reset_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_issue_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_issue_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_issue_i2o</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_issue_i2o_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_isintr_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_isintr_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_isintr_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_wait</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_write_driver_status</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_read_adapter_status</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_read_subsystem_parameters</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_read_config</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_clear_adapter</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_readwrite_page5</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_init_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_init_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_init_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_isinit_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_isinit_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_isinit_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_erase_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_program_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_verify_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_erase_bios_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_program_bios_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_verify_bios_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_flash_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_flash_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_flash_firmware</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_get_bios_version</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_identify_controller</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_chkstatus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">IPS_STATUS</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_enable_int_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_enable_int_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_enable_int_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_intr_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_intr_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_next</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipsintr_blocking</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ips_scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipsintr_done</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ips_scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_done</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_free</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_freescb</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_setup_funclist</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_statinit</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_statinit_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_fix_ffdc_time</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">time_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_ffdc_reset</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_ffdc_time</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">ips_statupd_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">ips_statupd_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">ips_statupd_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">ips_getscb</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_putq_scb_head</span><span class="p">(</span><span class="n">ips_scb_queue_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_putq_wait_tail</span><span class="p">(</span><span class="n">ips_wait_queue_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_putq_copp_tail</span><span class="p">(</span><span class="n">ips_copp_queue_t</span> <span class="o">*</span><span class="p">,</span>
				      <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">ips_removeq_scb_head</span><span class="p">(</span><span class="n">ips_scb_queue_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">ips_removeq_scb</span><span class="p">(</span><span class="n">ips_scb_queue_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">ips_removeq_wait_head</span><span class="p">(</span><span class="n">ips_wait_queue_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">ips_removeq_wait</span><span class="p">(</span><span class="n">ips_wait_queue_t</span> <span class="o">*</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">ips_removeq_copp</span><span class="p">(</span><span class="n">ips_copp_queue_t</span> <span class="o">*</span><span class="p">,</span>
						     <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">ips_removeq_copp_head</span><span class="p">(</span><span class="n">ips_copp_queue_t</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_is_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_make_passthru</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_usrcmd</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_cleanup_passthru</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_scmd_buf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_host_info</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">copy_mem_info</span><span class="p">(</span><span class="n">IPS_INFOSTR</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">copy_info</span><span class="p">(</span><span class="n">IPS_INFOSTR</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_init_phase2</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_init_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">indexPtr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_register_scsi</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ips_poll_for_flush_complete</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ips_flush_and_reset</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * global variables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ips_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ips&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">ips_sh</span><span class="p">[</span><span class="n">IPS_MAX_ADAPTERS</span><span class="p">];</span>	<span class="cm">/* Array of host controller structures */</span>
<span class="k">static</span> <span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">IPS_MAX_ADAPTERS</span><span class="p">];</span>	<span class="cm">/* Array of HA structures */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ips_next_controller</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ips_num_controllers</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ips_released_controllers</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_hotplug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_cmd_timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_reset_timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_force_memio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Always use Memory Mapped I/O    */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_force_i2o</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Always use I2O command delivery */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_ioctlsize</span> <span class="o">=</span> <span class="n">IPS_IOCTL_SIZE</span><span class="p">;</span>	<span class="cm">/* Size of the ioctl buffer        */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_cd_boot</span><span class="p">;</span>			<span class="cm">/* Booting from Manager CD         */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ips_FlashData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* CD Boot - Flash Data Buffer      */</span>
<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="n">ips_flashbusaddr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">ips_FlashDataInUse</span><span class="p">;</span>		<span class="cm">/* CD Boot - Flash Data In Use Flag */</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">MaxLiteCmds</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* Max Active Cmds for a Lite Adapter */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">ips_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect</span>			<span class="o">=</span> <span class="n">ips_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">ips_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">ips_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">ips_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">ips_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">ips_eh_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="s">&quot;ips&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>		<span class="o">=</span> <span class="n">ips_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">ips_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">ips_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">IPS_MAX_SG</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* This table describes all ServeRAID Adapters */</span>
<span class="k">static</span> <span class="k">struct</span>  <span class="n">pci_device_id</span>  <span class="n">ips_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x01BD</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0250</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span> <span class="n">pci</span><span class="p">,</span> <span class="n">ips_pci_table</span> <span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">ips_hot_plug_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ips&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>  <span class="n">ips_insert_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">ips_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ips_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">ips_hot_plug_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ips_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ips_insert_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ips_remove_device</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Necessary forward function protoypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="cp">#define MAX_ADAPTER_NAME 15</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">ips_adapter_name</span><span class="p">[][</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ServeRAID&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID II&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID on motherboard&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID on motherboard&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 3H&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 3L&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 4H&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 4M&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 4L&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 4Mx&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 4Lx&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 5i&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 5i&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 6M&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 6i&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 7t&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 7k&quot;</span><span class="p">,</span>
	<span class="s">&quot;ServeRAID 7M&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ips_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ips_halt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Direction table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ips_command_direction</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span>
	<span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_NONE</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span> <span class="n">IPS_DATA_IN</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_OUT</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span>
	<span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span><span class="p">,</span> <span class="n">IPS_DATA_UNK</span>
<span class="p">};</span>


<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_setup                                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   setup parameters to the driver                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ips_str</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="n">IPS_OPTION</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="s">&quot;noi2o&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ips_force_i2o</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;nommap&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ips_force_memio</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;ioctlsize&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ips_ioctlsize</span><span class="p">,</span> <span class="n">IPS_IOCTL_SIZE</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;cdboot&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ips_cd_boot</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;maxcmds&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MaxLiteCmds</span><span class="p">,</span> <span class="mi">32</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="cm">/* Don&#39;t use strtok() anymore ( if 2.4 Kernel or beyond ) */</span>
	<span class="cm">/* Search for value */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">key</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_str</span><span class="p">,</span> <span class="s">&quot;,.&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">key</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="o">*</span><span class="n">value</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We now have key/value pairs.</span>
<span class="cm">		 * Update the variables</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">options</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strnicmp</span>
			    <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">option_name</span><span class="p">,</span>
			     <span class="n">strlen</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">option_name</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
					<span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">option_flag</span> <span class="o">=</span>
					    <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">option_flag</span> <span class="o">=</span>
					    <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">option_value</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ips=&quot;</span><span class="p">,</span> <span class="n">ips_setup</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_detect                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Detect and initialize the driver                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* NOTE: this routine is called under the io_request_lock spinlock          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span> <span class="n">SHT</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_detect&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="p">)</span>
		<span class="n">ips_setup</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ips_num_controllers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_register_scsi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">ips_free</span><span class="p">(</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ips_released_controllers</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ips_hotplug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ips_num_controllers</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*   configure the function pointers to use the functions that will work    */</span>
<span class="cm">/*   with the found version of the adapter                                  */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_setup_funclist</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup Functions</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPS_IS_MORPHEUS</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">IPS_IS_MARCO</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* morpheus / marco / sebring */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span> <span class="o">=</span> <span class="n">ips_isintr_morpheus</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isinit</span> <span class="o">=</span> <span class="n">ips_isinit_morpheus</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">ips_issue_i2o_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ips_init_morpheus</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statupd</span> <span class="o">=</span> <span class="n">ips_statupd_morpheus</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ips_reset_morpheus</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">intr</span> <span class="o">=</span> <span class="n">ips_intr_morpheus</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">enableint</span> <span class="o">=</span> <span class="n">ips_enable_int_morpheus</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IPS_USE_MEMIO</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* copperhead w/MEMIO */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span> <span class="o">=</span> <span class="n">ips_isintr_copperhead_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isinit</span> <span class="o">=</span> <span class="n">ips_isinit_copperhead_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ips_init_copperhead_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statupd</span> <span class="o">=</span> <span class="n">ips_statupd_copperhead_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statinit</span> <span class="o">=</span> <span class="n">ips_statinit_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ips_reset_copperhead_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">intr</span> <span class="o">=</span> <span class="n">ips_intr_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">erasebios</span> <span class="o">=</span> <span class="n">ips_erase_bios_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">programbios</span> <span class="o">=</span> <span class="n">ips_program_bios_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">verifybios</span> <span class="o">=</span> <span class="n">ips_verify_bios_memio</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">enableint</span> <span class="o">=</span> <span class="n">ips_enable_int_copperhead_memio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPS_USE_I2O_DELIVER</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">ips_issue_i2o_memio</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">ips_issue_copperhead_memio</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* copperhead */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span> <span class="o">=</span> <span class="n">ips_isintr_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isinit</span> <span class="o">=</span> <span class="n">ips_isinit_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">ips_init_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statupd</span> <span class="o">=</span> <span class="n">ips_statupd_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statinit</span> <span class="o">=</span> <span class="n">ips_statinit</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ips_reset_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">intr</span> <span class="o">=</span> <span class="n">ips_intr_copperhead</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">erasebios</span> <span class="o">=</span> <span class="n">ips_erase_bios</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">programbios</span> <span class="o">=</span> <span class="n">ips_program_bios</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">verifybios</span> <span class="o">=</span> <span class="n">ips_verify_bios</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">enableint</span> <span class="o">=</span> <span class="n">ips_enable_int_copperhead</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IPS_USE_I2O_DELIVER</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">ips_issue_i2o</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">ips_issue_copperhead</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_release                                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove a driver                                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_release&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_ADAPTERS</span> <span class="o">&amp;&amp;</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sh</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IPS_MAX_ADAPTERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;(%s) release, invalid Scsi_Host pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ips_name</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">IPS_HA</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

	<span class="cm">/* flush the cache on the controller */</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPS_NORM_STATE</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Flushing Cache.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* send command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Incomplete Flush.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Flushing Complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* free extra memory */</span>
	<span class="n">ips_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* free IRQ */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="n">ips_released_controllers</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_halt                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Perform cleanup when the system reboots                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_RESTART</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_HALT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_POWER_OFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">NOTIFY_DONE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ips_next_controller</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* flush the cache on the controller */</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPS_NORM_STATE</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Flushing Cache.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* send command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">IPS_FAILURE</span><span class="p">)</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;Incomplete Flush.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;Flushing Complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">NOTIFY_OK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_eh_abort                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Abort a command (using the new error code stuff)                       */</span>
<span class="cm">/* Note: this routine is called under the io_request_lock                   */</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ips_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_eh_abort&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SC</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* See if the command is on the copp queue */</span>
	<span class="n">item</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">item</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">!=</span> <span class="n">SC</span><span class="p">))</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Found it */</span>
		<span class="n">ips_removeq_copp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUCCESS</span><span class="p">);</span>

		<span class="cm">/* See if the command is on the wait queue */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ips_removeq_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">,</span> <span class="n">SC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* command not sent yet */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUCCESS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* command must have already been sent */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_eh_reset                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Reset the controller (with new eh error code)                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* NOTE: this routine is called under the io_request_lock spinlock          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ips_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_eh_reset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef NO_IPS_RESET</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>
<span class="cp">#else</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reset called with NULL scsi command&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reset called with NULL ha struct&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>

	<span class="cm">/* See if the command is on the copp queue */</span>
	<span class="n">item</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">item</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">!=</span> <span class="n">SC</span><span class="p">))</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Found it */</span>
		<span class="n">ips_removeq_copp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">SUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* See if the command is on the wait queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips_removeq_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">,</span> <span class="n">SC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* command not sent yet */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">SUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* An explanation for the casual observer:                              */</span>
	<span class="cm">/* Part of the function of a RAID controller is automatic error         */</span>
	<span class="cm">/* detection and recovery.  As such, the only problem that physically   */</span>
	<span class="cm">/* resetting an adapter will ever fix is when, for some reason,         */</span>
	<span class="cm">/* the driver is not successfully communicating with the adapter.       */</span>
	<span class="cm">/* Therefore, we will attempt to flush this adapter.  If that succeeds, */</span>
	<span class="cm">/* then there&#39;s no real purpose in a physical reset. This will complete */</span>
	<span class="cm">/* much faster and avoids any problems that might be caused by a        */</span>
	<span class="cm">/* physical reset ( such as having to fail all the outstanding I/O&#39;s ). */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_reset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* IF Not an IOCTL Requested Reset */</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPS_NORM_STATE</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Attempt the flush command */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;Reset Request - Flushed Cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">SUCCESS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Either we can&#39;t communicate with the adapter or it&#39;s an IOCTL request */</span>
	<span class="cm">/* from a utility.  A physical reset is needed at this point.            */</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Reset the IOCTL Requested Reset Flag */</span>

	<span class="cm">/*</span>
<span class="cm">	 * command must have already been sent</span>
<span class="cm">	 * reset the controller</span>
<span class="cm">	 */</span>
	<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="s">&quot;Resetting controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">reset</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span><span class="p">;</span>

		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Controller reset failed - controller now offline.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Now fail all of the active commands */</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Failing active commands&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">ips_removeq_scb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Now fail all of the pending commands */</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Failing pending commands&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ips_removeq_wait_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_clear_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span><span class="p">;</span>

		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Controller reset failed - controller now offline.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Now fail all of the active commands */</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Failing active commands&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">ips_removeq_scb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Now fail all of the pending commands */</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Failing pending commands&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ips_removeq_wait_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FFDC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x300000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_ffdc</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ips_ffdc_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now fail all of the active commands */</span>
	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Failing active commands&quot;</span><span class="p">,</span> <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">ips_removeq_scb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
		<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset DCDB active command bits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nbus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcdb_active</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset the number of active IOCTLs */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ips_next</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">SUCCESS</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* NO_IPS_RESET */</span><span class="cp"></span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__ips_eh_reset</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_queue                                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Send a command to the controller                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* NOTE:                                                                    */</span>
<span class="cm">/*    Linux obtains io_request_lock before calling this function            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_queue_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">ips_passthru_t</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_queue&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">DID_ERROR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips_is_passthru</span><span class="p">(</span><span class="n">SC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">IPS_MAX_IOCTL_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">done</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">IPS_MAX_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d): ips_queue: cmd 0x%X (%d %d %d)&quot;</span><span class="p">,</span>
		  <span class="n">ips_name</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
		  <span class="n">SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		  <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="cm">/* Check for command to initiator IDs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SC</span><span class="p">)</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ha_id</span><span class="p">[</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SC</span><span class="p">)]))</span> <span class="p">{</span>
		<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips_is_passthru</span><span class="p">(</span><span class="n">SC</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">scratch</span><span class="p">;</span>

		<span class="cm">/* A Reset IOCTL is only sent by the boot CD in extreme cases.           */</span>
		<span class="cm">/* There can never be any system activity ( network or disk ), but check */</span>
		<span class="cm">/* anyway just as a good practice.                                       */</span>
		<span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">reset</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_RESET_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">reset</span><span class="p">.</span><span class="n">adapter_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">done</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* This reset request is from an IOCTL */</span>
			<span class="n">__ips_eh_reset</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
			<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* allocate space for the scribble */</span>
		<span class="n">scratch</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_copp_wait_item_t</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scratch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">done</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">scratch</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">SC</span><span class="p">;</span>
		<span class="n">scratch</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ips_putq_copp_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ips_putq_wait_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">,</span> <span class="n">SC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ips_next</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">ips_queue</span><span class="p">)</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_biosparam                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Set bios geometry for the controller                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ips_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
			 <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_biosparam&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="cm">/* ?!?! host adater info invalid */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_read_adapter_status</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_ON</span><span class="p">))</span>
		<span class="cm">/* ?!?! Enquiry command failed */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="mh">0x400000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucMiscFlag</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="n">IPS_NORM_HEADS</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">IPS_NORM_SECTORS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="n">IPS_COMP_HEADS</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">IPS_COMP_SECTORS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Geometry: heads: %d, sectors: %d, cylinders: %d&quot;</span><span class="p">,</span>
		  <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">);</span>

	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_slave_configure                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Set queue depths on devices once scan is complete                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">SDptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">IPS_HA</span><span class="p">(</span><span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span> <span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">min</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucLogDriveCount</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">SDptr</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">skip_ms_page_8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">SDptr</span><span class="o">-&gt;</span><span class="n">skip_ms_page_3f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: do_ipsintr                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Wrapper for the interrupt handler                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">do_ipsintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irqstatus</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;do_ipsintr&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">];</span>
	<span class="cm">/* interrupt during initialization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">intr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irqstatus</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">intr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* start the next command */</span>
	<span class="n">ips_next</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_ON</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">irqstatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_intr_copperhead                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Polling interrupt handler                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   ASSUMES interrupts are disabled                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span>
<span class="nf">ips_intr_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_stat_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">IPS_STATUS</span> <span class="n">cstatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intrstatus</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_intr&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intrstatus</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Unexpected/Shared interrupt</span>
<span class="cm">		 */</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>

		<span class="n">intrstatus</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrstatus</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cstatus</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statupd</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cstatus</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">command_id</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IPS_MAX_CMDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Spurious Interrupt ? */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ips_chkstatus</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstatus</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">scb_addr</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * use the callback function to finish things up</span>
<span class="cm">		 * NOTE: interrupts are OFF for this</span>
<span class="cm">		 */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span>			<span class="cm">/* end while */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_intr_morpheus                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Polling interrupt handler                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   ASSUMES interrupts are disabled                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span>
<span class="nf">ips_intr_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_stat_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">IPS_STATUS</span> <span class="n">cstatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intrstatus</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_intr_morpheus&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intrstatus</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Unexpected/Shared interrupt</span>
<span class="cm">		 */</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>

		<span class="n">intrstatus</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isintr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intrstatus</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cstatus</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statupd</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cstatus</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="cm">/* No more to process */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cstatus</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">command_id</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IPS_MAX_CMDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;Spurious interrupt; no ccb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ips_chkstatus</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cstatus</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_scb_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">scb_addr</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * use the callback function to finish things up</span>
<span class="cm">		 * NOTE: interrupts are OFF for this</span>
<span class="cm">		 */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span>			<span class="cm">/* end while */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_info                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Return info about the driver                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">ips_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SH</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_info&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">IPS_HA</span><span class="p">(</span><span class="n">SH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;%s%s%s Build %d&quot;</span><span class="p">,</span> <span class="s">&quot;IBM PCI ServeRAID &quot;</span><span class="p">,</span>
		<span class="n">IPS_VERSION_HIGH</span><span class="p">,</span> <span class="n">IPS_VERSION_LOW</span><span class="p">,</span> <span class="n">IPS_BUILD_IDENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">&lt;=</span> <span class="n">MAX_ADAPTER_NAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot; &lt;&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ips_adapter_name</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_proc_info                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   The passthru interface for the driver                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_proc_info&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Find our host structure */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ips_next_controller</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span>
			<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_host_info</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/* Helper Functions                                                         */</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_is_passthru                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Determine if the specified SCSI command is really a passthru command   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_is_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_is_passthru&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SC</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">IPS_IOCTL_COMMAND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">IPS_ADAPTER_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SC</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
                <span class="kt">char</span>  <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

                <span class="cm">/* kmap_atomic() ensures addressability of the user buffer.*/</span>
                <span class="cm">/* local_irq_save() protects the KM_IRQ0 address slot.     */</span>
                <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;O&#39;</span> <span class="o">&amp;&amp;</span>
                    <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span> <span class="o">-</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
                        <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span> <span class="o">-</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
                <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_alloc_passthru_buffer                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   allocate a buffer large enough for the ioctl data if the ioctl buffer  */</span>
<span class="cm">/*   is too small or doesn&#39;t exist                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_alloc_passthru_buffer</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bigger_buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_busaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* there is no buffer or it&#39;s not big enough, allocate a new one */</span>
	<span class="n">bigger_buf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_busaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bigger_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* free the old memory */</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_len</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">);</span>
		<span class="cm">/* use the new memory */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">bigger_buf</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span> <span class="o">=</span> <span class="n">dma_busaddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_make_passthru                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Make a passthru command out of the info in the Scsi block              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_make_passthru</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_passthru_t</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_make_passthru&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SC</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">+=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* wrong size */</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Passthru structure wrong size&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">IPS_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips_alloc_passthru_buffer</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* allocation failure!  If ha-&gt;ioctl_data exists, use it to return</span>
<span class="cm">		   some error codes.  Return a failed command to the scsi layer. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">;</span>
			<span class="n">ips_scmd_buf_read</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">));</span>
			<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
			<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ExtendedStatus</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_datasize</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">ips_scmd_buf_read</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_datasize</span><span class="p">);</span>
	<span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some notes about the passthru interface used</span>
<span class="cm">	 *</span>
<span class="cm">	 * IF the scsi op_code == 0x0d then we assume</span>
<span class="cm">	 * that the data came along with/goes with the</span>
<span class="cm">	 * packet we received from the sg driver. In this</span>
<span class="cm">	 * case the CmdBSize field of the pt structure is</span>
<span class="cm">	 * used for the size of the buffer.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPS_NUMCTRLS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">ips_num_controllers</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">int</span><span class="p">));</span>
		<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">int</span><span class="p">));</span>
		<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS_IMM</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">IPS_COPPUSRCMD</span>:
	<span class="k">case</span> <span class="n">IPS_COPPIOCCMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">IPS_IOCTL_COMMAND</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CmdBSize</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* wrong size */</span>
				<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					  <span class="s">&quot;(%s%d) Passthru structure wrong size&quot;</span><span class="p">,</span>
					  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

				<span class="k">return</span> <span class="p">(</span><span class="n">IPS_FAILURE</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">IPS_DEVICEID_COPPERHEAD</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span>
			    <span class="n">IPS_CMD_RW_BIOSFW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_flash_copperhead</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span>
						   <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ips_usrcmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">IPS_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>			<span class="cm">/* end switch */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IPS_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* Routine Name: ips_flash_copperhead                                       */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Flash the BIOS/FW on a Copperhead style controller                     */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_flash_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span> <span class="n">pt</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">datasize</span><span class="p">;</span>

	<span class="cm">/* Trombone is the only copperhead that can do packet flash, but only</span>
<span class="cm">	 * for firmware. No one said it had to make sense. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPS_IS_TROMBONE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_FW_IMAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_usrcmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ExtendedStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* IF it&#39;s OK to Use the &quot;CD BOOT&quot; Flash Buffer, then you can     */</span>
	<span class="cm">/* avoid allocating a huge buffer per adapter ( which can fail ). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_BIOS_IMAGE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IPS_ERASE_BIOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ips_flash_bios</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">packet_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_FlashData</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ips_FlashDataInUse</span><span class="p">)){</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span> <span class="o">=</span> <span class="n">ips_FlashData</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_busaddr</span> <span class="o">=</span> <span class="n">ips_flashbusaddr</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">datasize</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">total_packets</span> <span class="o">*</span>
			    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					                      <span class="n">datasize</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_busaddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">){</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to allocate a flash buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_len</span> <span class="o">=</span> <span class="n">datasize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span> <span class="o">&gt;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;failed size sanity check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span><span class="p">],</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span> <span class="o">+=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">packet_num</span> <span class="o">==</span>
	    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">total_packets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_BIOS_IMAGE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ips_flash_bios</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_FW_IMAGE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ips_flash_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* Routine Name: ips_flash_bios                                             */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   flashes the bios of a copperhead adapter                               */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_flash_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span> <span class="n">pt</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_BIOS_IMAGE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IPS_WRITE_BIOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">programbios</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">erasebios</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">verifybios</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">erasebios</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;(%s%d) flash bios failed - unable to erase flash&quot;</span><span class="p">,</span>
				  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">programbios</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						 <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span> <span class="o">+</span>
						 <span class="n">IPS_BIOS_HEADER</span><span class="p">,</span>
						 <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span> <span class="o">-</span>
						 <span class="n">IPS_BIOS_HEADER</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;(%s%d) flash bios failed - unable to flash&quot;</span><span class="p">,</span>
				  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">verifybios</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span> <span class="o">+</span>
						<span class="n">IPS_BIOS_HEADER</span><span class="p">,</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span> <span class="o">-</span>
						<span class="n">IPS_BIOS_HEADER</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;(%s%d) flash bios failed - unable to verify flash&quot;</span><span class="p">,</span>
				  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_BIOS_IMAGE</span> <span class="o">&amp;&amp;</span>
		   <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IPS_ERASE_BIOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">erasebios</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">erasebios</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;(%s%d) flash bios failed - unable to erase flash&quot;</span><span class="p">,</span>
				  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="nl">error:</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ExtendedStatus</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_fill_scb_sg_single                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Fill in a single scb sg_list element from an address                   */</span>
<span class="cm">/*   return a -1 if a breakup occurred                                      */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_fill_scb_sg_single</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">busaddr</span><span class="p">,</span>
		       <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">e_len</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+</span> <span class="n">e_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_xfer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_len</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_xfer</span> <span class="o">-</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">breakup</span> <span class="o">=</span> <span class="n">indx</span><span class="p">;</span>
		<span class="o">++</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_break</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">breakup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_break</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPS_USE_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">enh_list</span><span class="p">[</span><span class="n">indx</span><span class="p">].</span><span class="n">address_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">enh_list</span><span class="p">[</span><span class="n">indx</span><span class="p">].</span><span class="n">address_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">enh_list</span><span class="p">[</span><span class="n">indx</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">e_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">std_list</span><span class="p">[</span><span class="n">indx</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">std_list</span><span class="p">[</span><span class="n">indx</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">e_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">++</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">e_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* Routine Name: ips_flash_firmware                                         */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   flashes the firmware of a copperhead adapter                           */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_flash_firmware</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span> <span class="n">pt</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_SG_LIST</span> <span class="n">sg_list</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmd_busaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPS_FW_IMAGE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IPS_WRITE_FW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_HOST_COMMAND</span><span class="p">));</span>
		<span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_DOWNLOAD</span><span class="p">;</span>
		<span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
		<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ExtendedStatus</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Save the S/G list pointer so it doesn&#39;t get clobbered */</span>
	<span class="n">sg_list</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
	<span class="n">cmd_busaddr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">;</span>
	<span class="cm">/* copy in the CP */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_IOCTL_CMD</span><span class="p">));</span>
	<span class="cm">/* FIX stuff that might be wrong */</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">=</span> <span class="n">cmd_busaddr</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ipsintr_done</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_datasize</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span> <span class="o">=</span>
	    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span>
			   <span class="n">IPS_DMA_DIR</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPS_SCB_MAP_SINGLE</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">TimeOut</span><span class="p">)</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">TimeOut</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* Routine Name: ips_free_flash_copperhead                                  */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   release the memory resources used to hold the flash image              */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span> <span class="o">==</span> <span class="n">ips_FlashData</span><span class="p">)</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ips_FlashDataInUse</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_len</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_busaddr</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flash_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_usrcmd                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Process a user command and make it ready to send                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_usrcmd</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_passthru_t</span> <span class="o">*</span> <span class="n">pt</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_SG_LIST</span> <span class="n">sg_list</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmd_busaddr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_usrcmd&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">scb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">pt</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Save the S/G list pointer so it doesn&#39;t get clobbered */</span>
	<span class="n">sg_list</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
	<span class="n">cmd_busaddr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">;</span>
	<span class="cm">/* copy in the CP */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_IOCTL_CMD</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">dcdb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_DCDB_TABLE</span><span class="p">));</span>

	<span class="cm">/* FIX stuff that might be wrong */</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">=</span> <span class="n">cmd_busaddr</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ipsintr_done</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="cm">/* we don&#39;t support DCDB/READ/WRITE Scatter Gather */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_READ_SG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_WRITE_SG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_DCDB_SG</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CmdBSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">CmdBSize</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_passthru_t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_DCDB</span><span class="p">)</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">dcdb_address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">+</span>
							 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span>
							 <span class="n">dcdb</span> <span class="o">-</span>
							 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CmdBSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_DCDB</span><span class="p">)</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">buffer_pointer</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set timeouts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">TimeOut</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">TimeOut</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">TimeOut</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">TimeOut</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">)</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT60</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT20M</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* assume success */</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* success */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_cleanup_passthru                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Cleanup after a passthru command                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_cleanup_passthru</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_passthru_t</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_cleanup_passthru&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">scb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) couldn&#39;t cleanup after passthru&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips_passthru_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">;</span>

	<span class="cm">/* Copy data back to the user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_DCDB</span><span class="p">)</span>	<span class="cm">/* Copy DCDB Back to Caller&#39;s Area */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">CoppCP</span><span class="p">.</span><span class="n">dcdb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_DCDB_TABLE</span><span class="p">));</span>

	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">BasicStatus</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ExtendedStatus</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">AdapterType</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">IPS_DEVICEID_COPPERHEAD</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_DOWNLOAD</span> <span class="o">||</span>
	     <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_RW_BIOSFW</span><span class="p">))</span>
		<span class="n">ips_free_flash_copperhead</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_datasize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_host_info                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   The passthru interface for the driver                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_host_info</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_INFOSTR</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_host_info&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">localpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IBM ServeRAID General Information:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPS_NVRAM_P5_SIG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Controller Type                   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ips_adapter_name</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
			  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Controller Type                   : Unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">)</span>
		<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
			  <span class="s">&quot;</span><span class="se">\t</span><span class="s">IO region                         : 0x%lx (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
			  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Memory region                     : 0x%lx (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_len</span><span class="p">);</span>
		<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
			  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Shared memory address             : 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">IRQ number                        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

    <span class="cm">/* For the Next 3 lines Check for Binary 0 at the end and don&#39;t include it if it&#39;s there. */</span>
    <span class="cm">/* That keeps everything happy for &quot;text&quot; operations on the proc file.                    */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPS_NVRAM_P5_SIG</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
			          <span class="s">&quot;</span><span class="se">\t</span><span class="s">BIOS Version                      : %c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
			          <span class="s">&quot;</span><span class="se">\t</span><span class="s">BIOS Version                      : %c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
		          <span class="s">&quot;</span><span class="se">\t</span><span class="s">Firmware Version                  : %c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
		          <span class="s">&quot;</span><span class="se">\t</span><span class="s">Firmware Version                  : %c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">CodeBlkVersion</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
		          <span class="s">&quot;</span><span class="se">\t</span><span class="s">Boot Block Version                : %c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>
		          <span class="s">&quot;</span><span class="se">\t</span><span class="s">Boot Block Version                : %c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		          <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">BootBlkVersion</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
    <span class="p">}</span>

	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Driver Version                    : %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">IPS_VERSION_HIGH</span><span class="p">,</span> <span class="n">IPS_VERSION_LOW</span><span class="p">);</span>

	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Driver Build                      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">IPS_BUILD_IDENT</span><span class="p">);</span>

	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Max Physical Devices              : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucMaxPhysicalDevices</span><span class="p">);</span>
	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Max Active Commands               : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span><span class="p">);</span>
	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Current Queued Commands           : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Current Active Commands           : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span><span class="p">);</span>
	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Current Queued PT Commands        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Current Active PT Commands        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span><span class="p">);</span>

	<span class="n">copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">localpos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: copy_mem_info                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Copy data into an IPS_INFOSTR structure                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">copy_mem_info</span><span class="p">(</span><span class="n">IPS_INFOSTR</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;copy_mem_info&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">localpos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">localpos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">localpos</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">localpos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: copy_info                                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   printf style wrapper for an info structure                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">copy_info</span><span class="p">(</span><span class="n">IPS_INFOSTR</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;copy_info&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">copy_mem_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_identify_controller                                    */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Identify this controller                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_identify_controller</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_identify_controller&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPS_DEVICEID_COPPERHEAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="n">IPS_REVID_SERVERAID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_SERVERAID2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_NAVAJO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_NAVAJO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_SERVERAID2</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">slot_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_KIOWA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">IPS_REVID_CLARINETP1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="n">IPS_REVID_CLARINETP3</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucMaxPhysicalDevices</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID3L</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">IPS_REVID_TROMBONE32</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID4H</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPS_DEVICEID_MORPHEUS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_4L</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID4L</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_4M</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID4M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_4MX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID4MX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_4LX</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID4LX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_5I2</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID5I2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_5I1</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID5I1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPS_DEVICEID_MARCO</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_6M</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID6M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_6I</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID6I</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_7k</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID7k</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_SUBDEVICEID_7M</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">=</span> <span class="n">IPS_ADTYPE_SERVERAID7M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_get_bios_version                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Get the BIOS revision number                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_get_bios_version</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">major</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">minor</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">subminor</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hexDigits</span><span class="p">[]</span> <span class="o">=</span>
	    <span class="p">{</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span>
     <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span> <span class="p">};</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_get_bios_version&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">,</span> <span class="s">&quot;       ?&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">IPS_DEVICEID_COPPERHEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPS_USE_MEMIO</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Memory Mapped I/O */</span>

			<span class="cm">/* test 1st byte */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="cm">/* Get Major version */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">major</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="cm">/* Get Minor version */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x1FE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
			<span class="n">minor</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="cm">/* Get SubMinor version */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x1FD</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
			<span class="n">subminor</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Programmed I/O */</span>

			<span class="cm">/* test 1st byte */</span>
			<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="cm">/* Get Major version */</span>
			<span class="n">outl</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">major</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="cm">/* Get Minor version */</span>
			<span class="n">outl</span><span class="p">(</span><span class="mh">0x1FE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">minor</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="cm">/* Get SubMinor version */</span>
			<span class="n">outl</span><span class="p">(</span><span class="mh">0x1FD</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">subminor</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Morpheus Family - Send Command to the card */</span>

		<span class="n">buffer</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

		<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_RW_BIOSFW</span><span class="p">;</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_RW_BIOSFW</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x800</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">total_packets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">packet_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flashfw</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">;</span>

		<span class="cm">/* issue the command */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
		      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span>
				    <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Error occurred */</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0xC0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0xC1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xAA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">major</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x1ff</span> <span class="o">+</span> <span class="mh">0xC0</span><span class="p">];</span>	<span class="cm">/* Offset 0x1ff after the header (0xc0) */</span>
			<span class="n">minor</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x1fe</span> <span class="o">+</span> <span class="mh">0xC0</span><span class="p">];</span>	<span class="cm">/* Offset 0x1fe after the header (0xc0) */</span>
			<span class="n">subminor</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x1fd</span> <span class="o">+</span> <span class="mh">0xC0</span><span class="p">];</span>	<span class="cm">/* Offset 0x1fd after the header (0xc0) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="p">[(</span><span class="n">major</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="p">[</span><span class="n">major</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="p">[</span><span class="n">subminor</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="p">[(</span><span class="n">minor</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="p">[</span><span class="n">minor</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_hainit                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize the controller                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* NOTE: Assumes to be called from with a lock                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_hainit</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_hainit&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statinit</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statinit</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">enableint</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">enableint</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Send FFDC */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">reset_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_ffdc</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">ips_ffdc_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_read_config</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;unable to read config from controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* end if */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_read_adapter_status</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;unable to read controller status.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Identify this controller */</span>
	<span class="n">ips_identify_controller</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_read_subsystem_parameters</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;unable to read subsystem parameters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write nvram user page 5 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_write_driver_status</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;unable to write driver info to controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If there are Logical Drives and a Reset Occurred, then an EraseStripeLock is Needed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">ucLogDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">requires_esl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">ips_clear_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">IPS_INTR_IORL</span><span class="p">);</span>

	<span class="cm">/* set limits on SID, LUN, BUS */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ntargets</span> <span class="o">=</span> <span class="n">IPS_MAX_TARGETS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nlun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nbus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucMaxPhysicalDevices</span> <span class="o">/</span> <span class="n">IPS_MAX_TARGETS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">logical_drive</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ucStripeSize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_xfer</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_xfer</span> <span class="o">=</span> <span class="mh">0x20000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_xfer</span> <span class="o">=</span> <span class="mh">0x40000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7</span>:
	<span class="nl">default:</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_xfer</span> <span class="o">=</span> <span class="mh">0x80000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup max concurrent commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use the new method */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucConcurrentCmdCount</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* use the old method */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">logical_drive</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ucStripeSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">7</span>:
		<span class="nl">default:</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Limit the Active Commands on a Lite Adapter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID3L</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID4L</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID4LX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">&gt;</span> <span class="n">MaxLiteCmds</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MaxLiteCmds</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="n">MaxLiteCmds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set controller IDs */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ha_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_ADAPTER_ID</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nbus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ha_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">init_id</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcdb_active</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_next                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Take the next command off the queue and send it to the controller      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_next</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SC</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_next&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Block access to the queue function so</span>
<span class="cm">	 * this command won&#39;t time out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x300000</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_ffdc</span> <span class="o">&gt;</span> <span class="n">IPS_SECS_8HOURS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_ffdc</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
			<span class="n">ips_ffdc_time</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send passthru commands</span>
<span class="cm">	 * These have priority over normal I/O</span>
<span class="cm">	 * but shouldn&#39;t affect performance too much</span>
<span class="cm">	 * since we limit the number that can be active</span>
<span class="cm">	 * on the card at any one time</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_IOCTL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span> <span class="o">=</span> <span class="n">ips_getscb</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">item</span> <span class="o">=</span> <span class="n">ips_removeq_copp_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">copp_waitlist</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_make_passthru</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPS_FAILURE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_SUCCESS_IMM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* end case */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">IPS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_send_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS</span><span class="p">)</span>
			<span class="n">ips_putq_scb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPS_FAILURE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_SUCCESS_IMM</span>:
			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* end case */</span>

	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send &quot;Normal&quot; I/O commands</span>
<span class="cm">	 */</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span> <span class="o">=</span> <span class="n">ips_getscb</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span>
			<span class="n">dcdb_active</span><span class="p">[</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span>
				    <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">p</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">SC</span> <span class="o">=</span> <span class="n">ips_removeq_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_waitlist</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>	<span class="cm">/* Unlock HA after command is taken off queue */</span>

		<span class="n">SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
		<span class="n">SC</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">SC</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">breakup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ipsintr_done</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* copy in the CDB */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span>
                <span class="n">BUG_ON</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPS_SCB_MAP_SG</span><span class="p">;</span>

                        <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ips_fill_scb_sg_single</span>
				    <span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">scb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				     <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
                        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">=</span>
		    <span class="n">ips_command_direction</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>

		<span class="cm">/* Allow a WRITE BUFFER Command to Have no Data */</span>
		<span class="cm">/* This is Used by Tape Flash Utilites          */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_BUFFER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&gt;=</span> <span class="n">IPS_MAX_XFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TRANSFER64K</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_send_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPS_SUCCESS</span>:
			<span class="n">ips_putq_scb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_FAILURE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcdb_active</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>

			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPS_SUCCESS_IMM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcdb_active</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>

			<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* end case */</span>

		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

	<span class="p">}</span>			<span class="cm">/* end while */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_putq_scb_head                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Add an item to the head of the queue                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_putq_scb_head</span><span class="p">(</span><span class="n">ips_scb_queue_t</span> <span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_putq_scb_head&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">item</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_removeq_scb_head                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove the head of the queue                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">ips_scb_t</span> <span class="o">*</span>
<span class="nf">ips_removeq_scb_head</span><span class="p">(</span><span class="n">ips_scb_queue_t</span> <span class="o">*</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_removeq_scb_head&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">item</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_removeq_scb                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove an item from a queue                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">ips_scb_t</span> <span class="o">*</span>
<span class="nf">ips_removeq_scb</span><span class="p">(</span><span class="n">ips_scb_queue_t</span> <span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_removeq_scb&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="o">==</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ips_removeq_scb_head</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* found a match */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">)</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

		<span class="n">item</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_putq_wait_tail                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Add an item to the tail of the queue                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_putq_wait_tail</span><span class="p">(</span><span class="n">ips_wait_queue_t</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_putq_wait_tail&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">item</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">item</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_removeq_wait_head                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove the head of the queue                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="nf">ips_removeq_wait_head</span><span class="p">(</span><span class="n">ips_wait_queue_t</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_removeq_wait_head&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">item</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_removeq_wait                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove an item from a queue                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="nf">ips_removeq_wait</span><span class="p">(</span><span class="n">ips_wait_queue_t</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_removeq_wait&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="o">==</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ips_removeq_wait_head</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* found a match */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

		<span class="n">item</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_putq_copp_tail                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Add an item to the tail of the queue                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_putq_copp_tail</span><span class="p">(</span><span class="n">ips_copp_queue_t</span> <span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_putq_copp_tail&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_removeq_copp_head                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove the head of the queue                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span>
<span class="nf">ips_removeq_copp_head</span><span class="p">(</span><span class="n">ips_copp_queue_t</span> <span class="o">*</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_removeq_copp_head&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">item</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_removeq_copp                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove an item from a queue                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within the HA lock                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span>
<span class="nf">ips_removeq_copp</span><span class="p">(</span><span class="n">ips_copp_queue_t</span> <span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="n">ips_copp_wait_item_t</span> <span class="o">*</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_copp_wait_item_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_removeq_copp&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="o">==</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ips_removeq_copp_head</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* found a match */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

		<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ipsintr_blocking                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Finalize an interrupt for internal commands                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ipsintr_blocking</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ipsintr_blocking&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_in_progress</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ipsintr_done                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Finalize an interrupt for non-internal commands                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ipsintr_done</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ipsintr_done&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Spurious interrupt; scb NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unexpected interrupt */</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Spurious interrupt; scsi_cmd not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ips_done</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_done                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Do housekeeping on completed commands                                  */</span>
<span class="cm">/*  ASSUMED to be called form within the request lock                       */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_done</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_done&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ips_is_passthru</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ips_cleanup_passthru</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">num_ioctl</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check to see if this command had too much</span>
<span class="cm">		 * data and had to be broke up.  If so, queue</span>
<span class="cm">		 * the rest of the data and continue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">breakup</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_break</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
                        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sg_dma_index</span><span class="p">,</span> <span class="n">ips_sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* we had a data breakup */</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                        <span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>

                        <span class="cm">/* Spin forward to last dma chunk */</span>
                        <span class="n">sg_dma_index</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">breakup</span><span class="p">;</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">breakup</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                                <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

			<span class="cm">/* Take care of possible partial on last chunk */</span>
                        <span class="n">ips_fill_scb_sg_single</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
                                               <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
                                               <span class="n">scb</span><span class="p">,</span> <span class="n">ips_sg_index</span><span class="o">++</span><span class="p">,</span>
                                               <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>

                        <span class="k">for</span> <span class="p">(;</span> <span class="n">sg_dma_index</span> <span class="o">&lt;</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
                             <span class="n">sg_dma_index</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">ips_fill_scb_sg_single</span>
                                    <span class="p">(</span><span class="n">ha</span><span class="p">,</span>
                                     <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
                                     <span class="n">scb</span><span class="p">,</span> <span class="n">ips_sg_index</span><span class="o">++</span><span class="p">,</span>
                                     <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                                        <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span>
			    <span class="n">ips_command_direction</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&gt;=</span> <span class="n">IPS_MAX_XFER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TRANSFER64K</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_send_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IPS_FAILURE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IPS_SUCCESS_IMM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end case */</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* end if passthru */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcdb_active</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>

	<span class="n">ips_freescb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_map_status                                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Map Controller Error codes to Linux Error Codes                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_map_status</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_stat_t</span> <span class="o">*</span> <span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">device_error</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">transfer_len</span><span class="p">;</span>
	<span class="n">IPS_DCDB_TABLE_TAPE</span> <span class="o">*</span><span class="n">tapeDCDB</span><span class="p">;</span>
	<span class="n">IPS_SCSI_INQ_DATA</span> <span class="n">inquiryData</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_map_status&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="s">&quot;(%s%d) Physical device error (%d %d %d): %x %x, Sense Key: %x, ASC: %x, ASCQ: %x&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span> <span class="o">==</span>
			  <span class="n">IPS_ERR_CKCOND</span> <span class="o">?</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sense_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span> <span class="o">==</span>
			  <span class="n">IPS_ERR_CKCOND</span> <span class="o">?</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sense_info</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span> <span class="o">==</span>
			  <span class="n">IPS_ERR_CKCOND</span> <span class="o">?</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sense_info</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* default driver error */</span>
	<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
	<span class="n">device_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPS_CMD_TIMEOUT</span>:
		<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPS_INVAL_OPCO</span>:
	<span class="k">case</span> <span class="n">IPS_INVAL_CMD_BLK</span>:
	<span class="k">case</span> <span class="n">IPS_INVAL_PARM_BLK</span>:
	<span class="k">case</span> <span class="n">IPS_LD_ERROR</span>:
	<span class="k">case</span> <span class="n">IPS_CMD_CMPLT_WERROR</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPS_PHYS_DRV_ERROR</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPS_ERR_SEL_TO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_ERR_OU_RUN</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_EXTENDED_DCDB</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span>
			     <span class="n">IPS_CMD_EXTENDED_DCDB_SG</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tapeDCDB</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPS_DCDB_TABLE_TAPE</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">;</span>
				<span class="n">transfer_len</span> <span class="o">=</span> <span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">transfer_length</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">transfer_len</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">transfer_len</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Underrun - set default to no error */</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>

				<span class="cm">/* Restrict access to physical DASD */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="p">{</span>
				    <span class="n">ips_scmd_buf_read</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span>
                                      <span class="o">&amp;</span><span class="n">inquiryData</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">inquiryData</span><span class="p">));</span>
 				    <span class="k">if</span> <span class="p">((</span><span class="n">inquiryData</span><span class="p">.</span><span class="n">DeviceType</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="p">{</span>
				        <span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
				        <span class="k">break</span><span class="p">;</span>
				    <span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_ERR_RECOVERY</span>:
			<span class="cm">/* don&#39;t fail recovered errors */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_ERR_HOST_RESET</span>:
		<span class="k">case</span> <span class="n">IPS_ERR_DEV_RESET</span>:
			<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_RESET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IPS_ERR_CKCOND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span>
				     <span class="n">IPS_CMD_EXTENDED_DCDB</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span>
					<span class="n">IPS_CMD_EXTENDED_DCDB_SG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tapeDCDB</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">IPS_DCDB_TABLE_TAPE</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
					       <span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">sense_info</span><span class="p">,</span>
					       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
					       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sense_info</span><span class="p">,</span>
					       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">device_error</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* check condition */</span>
			<span class="p">}</span>

			<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>		<span class="cm">/* end switch */</span>
	<span class="p">}</span>			<span class="cm">/* end switch */</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">device_error</span> <span class="o">|</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_send_wait                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Send a command to the controller and wait for it to return             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   The FFDC Time Stamp use this function for the callback, but doesn&#39;t    */</span>
<span class="cm">/*   actually need to wait.                                                 */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_send_wait</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_send_wait&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">!=</span> <span class="n">IPS_FFDC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Won&#39;t be Waiting if this is a Time Stamp */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_in_progress</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ipsintr_blocking</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_send_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">!=</span> <span class="n">IPS_FFDC</span><span class="p">)</span>	<span class="cm">/* Don&#39;t Wait around if this is a Time Stamp */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ips_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_scmd_buf_write                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*  Write data to struct scsi_cmnd request_buffer at proper offsets	    */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_scmd_buf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_scmd_buf_read                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*  Copy data from a struct scsi_cmnd to a new, linear buffer		    */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_scmd_buf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_send_cmd                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Map SCSI commands to ServeRAID commands for logical drives             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_send_cmd</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">device_error</span><span class="p">;</span>
	<span class="n">IPS_DCDB_TABLE_TAPE</span> <span class="o">*</span><span class="n">tapeDCDB</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TimeOut</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_send_cmd&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* internal command */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Controller commands can&#39;t be issued */</span>
			<span class="cm">/* to real devices -- fail them        */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_in_progress</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_is_passthru</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* command to logical bus -- interpret */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="k">case</span> <span class="n">REZERO_UNIT</span>:
		<span class="k">case</span> <span class="n">ERASE</span>:
		<span class="k">case</span> <span class="n">WRITE_FILEMARKS</span>:
		<span class="k">case</span> <span class="n">SPACE</span>:
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">START_STOP</span>:
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="k">case</span> <span class="n">INQUIRY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">==</span> <span class="n">IPS_ADAPTER_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Either we have a TUR</span>
<span class="cm">				 * or we have a SCSI inquiry</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">IPS_SCSI_INQ_DATA</span> <span class="n">inquiry</span><span class="p">;</span>

					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inquiry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_INQ_DATA</span><span class="p">));</span>

					<span class="n">inquiry</span><span class="p">.</span><span class="n">DeviceType</span> <span class="o">=</span>
					    <span class="n">IPS_SCSI_INQ_TYPE_PROCESSOR</span><span class="p">;</span>
					<span class="n">inquiry</span><span class="p">.</span><span class="n">DeviceTypeQualifier</span> <span class="o">=</span>
					    <span class="n">IPS_SCSI_INQ_LU_CONNECTED</span><span class="p">;</span>
					<span class="n">inquiry</span><span class="p">.</span><span class="n">Version</span> <span class="o">=</span> <span class="n">IPS_SCSI_INQ_REV2</span><span class="p">;</span>
					<span class="n">inquiry</span><span class="p">.</span><span class="n">ResponseDataFormat</span> <span class="o">=</span>
					    <span class="n">IPS_SCSI_INQ_RD_REV2</span><span class="p">;</span>
					<span class="n">inquiry</span><span class="p">.</span><span class="n">AdditionalLength</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
					<span class="n">inquiry</span><span class="p">.</span><span class="n">Flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">IPS_SCSI_INQ_Address16</span><span class="p">;</span>
					<span class="n">inquiry</span><span class="p">.</span><span class="n">Flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">IPS_SCSI_INQ_WBus16</span> <span class="o">|</span>
					    <span class="n">IPS_SCSI_INQ_Sync</span><span class="p">;</span>
					<span class="n">strncpy</span><span class="p">(</span><span class="n">inquiry</span><span class="p">.</span><span class="n">VendorId</span><span class="p">,</span> <span class="s">&quot;IBM     &quot;</span><span class="p">,</span>
						<span class="mi">8</span><span class="p">);</span>
					<span class="n">strncpy</span><span class="p">(</span><span class="n">inquiry</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
						<span class="s">&quot;SERVERAID       &quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">strncpy</span><span class="p">(</span><span class="n">inquiry</span><span class="p">.</span><span class="n">ProductRevisionLevel</span><span class="p">,</span>
						<span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

					<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">inquiry</span><span class="p">,</span>
							   <span class="k">sizeof</span> <span class="p">(</span><span class="n">inquiry</span><span class="p">));</span>

					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_GET_LD_INFO</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_LD_INFO</span><span class="p">);</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info_dma_addr</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
			<span class="n">ips_reqsen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_6</span>:
		<span class="k">case</span> <span class="n">WRITE_6</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
				     <span class="n">READ_6</span><span class="p">)</span> <span class="o">?</span> <span class="n">IPS_CMD_READ</span> <span class="o">:</span> <span class="n">IPS_CMD_WRITE</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
				     <span class="n">READ_6</span><span class="p">)</span> <span class="o">?</span> <span class="n">IPS_CMD_READ_SG</span> <span class="o">:</span>
				    <span class="n">IPS_CMD_WRITE_SG</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span>
				    <span class="n">IPS_USE_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">segment_4G</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">log_drv</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span><span class="p">)</span>
				<span class="n">le32_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span><span class="p">,</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span>
							    <span class="n">sector_count</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span>
				    <span class="p">(((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span>
				       <span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span>
								 <span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span> <span class="o">=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">/</span> <span class="n">IPS_BLKSIZE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span> <span class="o">=</span>
				    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="k">case</span> <span class="n">WRITE_10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
				     <span class="n">READ_10</span><span class="p">)</span> <span class="o">?</span> <span class="n">IPS_CMD_READ</span> <span class="o">:</span> <span class="n">IPS_CMD_WRITE</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
				     <span class="n">READ_10</span><span class="p">)</span> <span class="o">?</span> <span class="n">IPS_CMD_READ_SG</span> <span class="o">:</span>
				    <span class="n">IPS_CMD_WRITE_SG</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span>
				    <span class="n">IPS_USE_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">segment_4G</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">log_drv</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span><span class="p">)</span>
				<span class="n">le32_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span><span class="p">,</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span>
							    <span class="n">sector_count</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span>
								       <span class="n">scsi_cmd</span><span class="o">-&gt;</span>
								       <span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
								       <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scb</span><span class="o">-&gt;</span>
				     <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span> <span class="o">=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">/</span> <span class="n">IPS_BLKSIZE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This is a null condition</span>
<span class="cm">				 * we don&#39;t have to do anything</span>
<span class="cm">				 * so just return</span>
<span class="cm">				 */</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESERVE</span>:
		<span class="k">case</span> <span class="n">RELEASE</span>:
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MODE_SENSE</span>:
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_ENQUIRY</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">segment_4G</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq_busaddr</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_GET_LD_INFO</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_LD_INFO</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info_dma_addr</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">logical_info</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEND_DIAGNOSTIC</span>:
		<span class="k">case</span> <span class="n">REASSIGN_BLOCKS</span>:
		<span class="k">case</span> <span class="n">FORMAT_UNIT</span>:
		<span class="k">case</span> <span class="n">SEEK_10</span>:
		<span class="k">case</span> <span class="n">VERIFY</span>:
		<span class="k">case</span> <span class="n">READ_DEFECT_DATA</span>:
		<span class="k">case</span> <span class="n">READ_BUFFER</span>:
		<span class="k">case</span> <span class="n">WRITE_BUFFER</span>:
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* Set the Return Info to appear like the Command was */</span>
			<span class="cm">/* attempted, a Check Condition occurred, and Sense   */</span>
			<span class="cm">/* Data indicating an Invalid CDB OpCode is returned. */</span>
			<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>

			<span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>	<span class="cm">/* Error Code               */</span>
			<span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">;</span>	<span class="cm">/* Sense Key 5 Illegal Req. */</span>
			<span class="n">sp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>	<span class="cm">/* Additional Sense Length  */</span>
			<span class="n">sp</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* ASC = Invalid OpCode     */</span>
			<span class="n">sp</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* ASCQ                     */</span>

			<span class="n">device_error</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Indicate Check Condition */</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">device_error</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* end switch */</span>
	<span class="p">}</span>
	<span class="cm">/* end if */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* setup DCDB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* If we already know the Device is Not there, no need to attempt a Command   */</span>
		<span class="cm">/* This also protects an NT FailOver Controller from getting CDB&#39;s sent to it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">ucState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS_IMM</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dcdb_active</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">dcdb_address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">+</span>
							 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span>
							 <span class="n">dcdb</span> <span class="o">-</span>
							 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">segment_4G</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">TimeOut</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* If NEW Tape DCDB is Supported */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_EXTENDED_DCDB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span>
				    <span class="n">IPS_CMD_EXTENDED_DCDB_SG</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span>
				    <span class="n">IPS_USE_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tapeDCDB</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPS_DCDB_TABLE_TAPE</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">;</span>	<span class="cm">/* Use Same Data Area as Old DCDB Struct */</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">device_address</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_DISCONNECT_ALLOWED</span><span class="p">;</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">cmd_attribute</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPS_TRANSFER64K</span><span class="p">;</span>	<span class="cm">/* Always Turn OFF 64K Size Flag */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
					<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT10</span><span class="p">;</span>	<span class="cm">/* TimeOut is 10 Seconds */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
					<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT60</span><span class="p">;</span>	<span class="cm">/* TimeOut is 60 Seconds */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1200</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
					<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT20M</span><span class="p">;</span>	<span class="cm">/* TimeOut is 20 Minutes */</span>
			<span class="p">}</span>

			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">cdb_length</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">reserved_for_LUN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_EXTENDED_DCDB_SG</span><span class="p">)</span>
				<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">buffer_pointer</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">buffer_pointer</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">sense_length</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">sense_info</span><span class="p">);</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">scsi_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tapeDCDB</span><span class="o">-&gt;</span><span class="n">scsi_cdb</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span>
			       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_DCDB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_DCDB_SG</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">enhanced_sg</span> <span class="o">=</span>
				    <span class="n">IPS_USE_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">device_address</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_DISCONNECT_ALLOWED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT10</span><span class="p">;</span>	<span class="cm">/* TimeOut is 10 Seconds */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT60</span><span class="p">;</span>	<span class="cm">/* TimeOut is 60 Seconds */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TimeOut</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1200</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
					<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">|=</span> <span class="n">IPS_TIMEOUT20M</span><span class="p">;</span>	<span class="cm">/* TimeOut is 20 Minutes */</span>
			<span class="p">}</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cmd_attribute</span> <span class="o">&amp;</span> <span class="n">IPS_TRANSFER64K</span><span class="p">)</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">dcdb</span><span class="p">.</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">IPS_CMD_DCDB_SG</span><span class="p">)</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">buffer_pointer</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">buffer_pointer</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">cdb_length</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sense_length</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sense_info</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">scsi_cdb</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span>
			       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">dcdb</span><span class="p">.</span><span class="n">reserved2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">issue</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_chk_status                                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Check the status of commands to logical drives                         */</span>
<span class="cm">/*   Assumed to be called with the HA lock                                  */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_chkstatus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">IPS_STATUS</span> <span class="o">*</span> <span class="n">pstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">ips_stat_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">basic_status</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ext_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="n">IPS_SCSI_INQ_DATA</span> <span class="n">inquiryData</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_chkstatus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">.</span><span class="n">command_id</span><span class="p">];</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">=</span> <span class="n">basic_status</span> <span class="o">=</span>
	    <span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">.</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_BASIC_STATUS_MASK</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">extended_status</span> <span class="o">=</span> <span class="n">ext_status</span> <span class="o">=</span> <span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">.</span><span class="n">extended_status</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">residue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">scb_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">scb</span><span class="p">;</span>

	<span class="cm">/* Remove the item from the active queue */</span>
	<span class="n">ips_removeq_scb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_activelist</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span>
		<span class="cm">/* internal commands are handled in do_ipsintr */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_chkstatus: cmd 0x%X id %d (%d %d %d)&quot;</span><span class="p">,</span>
		  <span class="n">ips_name</span><span class="p">,</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
		  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">,</span>
		  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ips_is_passthru</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)))</span>
		<span class="cm">/* passthru - just returns the raw result */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPS_CMD_SUCCESS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPS_CMD_RECOVERED_ERROR</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">IPS_CMD_RECOVERED_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					  <span class="s">&quot;(%s%d) Recovered Logical Drive Error OpCode: %x, BSB: %x, ESB: %x&quot;</span><span class="p">,</span>
					  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
					  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span><span class="p">,</span>
					  <span class="n">basic_status</span><span class="p">,</span> <span class="n">ext_status</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
			<span class="k">case</span> <span class="n">REZERO_UNIT</span>:
			<span class="k">case</span> <span class="n">ERASE</span>:
			<span class="k">case</span> <span class="n">WRITE_FILEMARKS</span>:
			<span class="k">case</span> <span class="n">SPACE</span>:
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">START_STOP</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_online</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">INQUIRY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ips_online</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ips_inquiry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
				<span class="n">ips_reqsen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">READ_6</span>:
			<span class="k">case</span> <span class="n">WRITE_6</span>:
			<span class="k">case</span> <span class="n">READ_10</span>:
			<span class="k">case</span> <span class="n">WRITE_10</span>:
			<span class="k">case</span> <span class="n">RESERVE</span>:
			<span class="k">case</span> <span class="n">RELEASE</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">MODE_SENSE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_online</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">)</span>
				    <span class="o">||</span> <span class="o">!</span><span class="n">ips_msense</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ips_online</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">))</span>
					<span class="n">ips_rdcap</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SEND_DIAGNOSTIC</span>:
			<span class="k">case</span> <span class="n">REASSIGN_BLOCKS</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">FORMAT_UNIT</span>:
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SEEK_10</span>:
			<span class="k">case</span> <span class="n">VERIFY</span>:
			<span class="k">case</span> <span class="n">READ_DEFECT_DATA</span>:
			<span class="k">case</span> <span class="n">READ_BUFFER</span>:
			<span class="k">case</span> <span class="n">WRITE_BUFFER</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end switch */</span>

			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">errcode</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* bus == 0 */</span>
			<span class="cm">/* restrict access to physical drives */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">ips_scmd_buf_read</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span>
                                  <span class="o">&amp;</span><span class="n">inquiryData</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">inquiryData</span><span class="p">));</span>
			    <span class="k">if</span> <span class="p">((</span><span class="n">inquiryData</span><span class="p">.</span><span class="n">DeviceType</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span>
			        <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="cm">/* else */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* recovered error / success */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				  <span class="s">&quot;(%s%d) Unrecovered Logical Drive Error OpCode: %x, BSB: %x, ESB: %x&quot;</span><span class="p">,</span>
				  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
				  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span><span class="p">,</span> <span class="n">basic_status</span><span class="p">,</span>
				  <span class="n">ext_status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ips_map_status</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>			<span class="cm">/* else */</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_online                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Determine if a logical drive is online                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_online</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_online&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">&gt;=</span> <span class="n">IPS_MAX_LD</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_LD_INFO</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="o">-&gt;</span><span class="n">drive_info</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span>
	    <span class="n">IPS_LD_OFFLINE</span>
	    <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="o">-&gt;</span><span class="n">drive_info</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span>
	    <span class="n">IPS_LD_FREE</span>
	    <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="o">-&gt;</span><span class="n">drive_info</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span>
	    <span class="n">IPS_LD_CRS</span>
	    <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="o">-&gt;</span><span class="n">drive_info</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span>
	    <span class="n">IPS_LD_SYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_inquiry                                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Simulate an inquiry command to a logical drive                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_inquiry</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_SCSI_INQ_DATA</span> <span class="n">inquiry</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_inquiry&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inquiry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_INQ_DATA</span><span class="p">));</span>

	<span class="n">inquiry</span><span class="p">.</span><span class="n">DeviceType</span> <span class="o">=</span> <span class="n">IPS_SCSI_INQ_TYPE_DASD</span><span class="p">;</span>
	<span class="n">inquiry</span><span class="p">.</span><span class="n">DeviceTypeQualifier</span> <span class="o">=</span> <span class="n">IPS_SCSI_INQ_LU_CONNECTED</span><span class="p">;</span>
	<span class="n">inquiry</span><span class="p">.</span><span class="n">Version</span> <span class="o">=</span> <span class="n">IPS_SCSI_INQ_REV2</span><span class="p">;</span>
	<span class="n">inquiry</span><span class="p">.</span><span class="n">ResponseDataFormat</span> <span class="o">=</span> <span class="n">IPS_SCSI_INQ_RD_REV2</span><span class="p">;</span>
	<span class="n">inquiry</span><span class="p">.</span><span class="n">AdditionalLength</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">inquiry</span><span class="p">.</span><span class="n">Flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_SCSI_INQ_Address16</span><span class="p">;</span>
	<span class="n">inquiry</span><span class="p">.</span><span class="n">Flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">IPS_SCSI_INQ_WBus16</span> <span class="o">|</span> <span class="n">IPS_SCSI_INQ_Sync</span> <span class="o">|</span> <span class="n">IPS_SCSI_INQ_CmdQue</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">inquiry</span><span class="p">.</span><span class="n">VendorId</span><span class="p">,</span> <span class="s">&quot;IBM     &quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">inquiry</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span> <span class="s">&quot;SERVERAID       &quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">inquiry</span><span class="p">.</span><span class="n">ProductRevisionLevel</span><span class="p">,</span> <span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inquiry</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">inquiry</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_rdcap                                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Simulate a read capacity command to a logical drive                    */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_rdcap</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_SCSI_CAPACITY</span> <span class="n">cap</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_rdcap&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">cap</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span>
	    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">le32_to_cpu</span>
			<span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="o">-&gt;</span>
			 <span class="n">drive_info</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">sector_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">IPS_BLKSIZE</span><span class="p">);</span>

	<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cap</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_msense                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Simulate a mode sense command to a logical drive                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_msense</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">heads</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="n">IPS_SCSI_MODE_PAGE_DATA</span> <span class="n">mdata</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_msense&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ulDriveSize</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mh">0x400000</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ucMiscFlag</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="n">IPS_NORM_HEADS</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">IPS_NORM_SECTORS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="n">IPS_COMP_HEADS</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">IPS_COMP_SECTORS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cylinders</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="o">-&gt;</span><span class="n">ulDriveSize</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">])</span> <span class="o">-</span>
	     <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_MODE_PAGE_DATA</span><span class="p">));</span>

	<span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">BlockDescLength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x03</span>:		<span class="cm">/* page 3 */</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">PageCode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_MODE_PAGE3</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">DataLength</span> <span class="o">=</span>
		    <span class="mi">3</span> <span class="o">+</span> <span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">BlockDescLength</span> <span class="o">+</span> <span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">PageLength</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">TracksPerZone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">AltSectorsPerZone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">AltTracksPerZone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">AltTracksPerVolume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">SectorsPerTrack</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">sectors</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">BytesPerSector</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">IPS_BLKSIZE</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">Interleave</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">TrackSkew</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">CylinderSkew</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IPS_SCSI_MP3_SoftSector</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">PageCode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_MODE_PAGE4</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">DataLength</span> <span class="o">=</span>
		    <span class="mi">3</span> <span class="o">+</span> <span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">BlockDescLength</span> <span class="o">+</span> <span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">PageLength</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">CylindersHigh</span> <span class="o">=</span>
		    <span class="n">cpu_to_be16</span><span class="p">((</span><span class="n">cylinders</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">CylindersLow</span> <span class="o">=</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">Heads</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">WritePrecompHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">WritePrecompLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">ReducedWriteCurrentHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">ReducedWriteCurrentLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">StepRate</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">LandingZoneHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">LandingZoneLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">RotationalOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg4</span><span class="p">.</span><span class="n">MediumRotationRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8</span>:
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg8</span><span class="p">.</span><span class="n">PageCode</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg8</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_MODE_PAGE8</span><span class="p">);</span>
		<span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">DataLength</span> <span class="o">=</span>
		    <span class="mi">3</span> <span class="o">+</span> <span class="n">mdata</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">BlockDescLength</span> <span class="o">+</span> <span class="n">mdata</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">pg8</span><span class="p">.</span><span class="n">PageLength</span><span class="p">;</span>
		<span class="cm">/* everything else is left set to 0 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>			<span class="cm">/* end switch */</span>

	<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdata</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">mdata</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_reqsen                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Simulate a request sense command to a logical drive                    */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_reqsen</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_SCSI_REQSEN</span> <span class="n">reqsen</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_reqsen&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reqsen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SCSI_REQSEN</span><span class="p">));</span>

	<span class="n">reqsen</span><span class="p">.</span><span class="n">ResponseCode</span> <span class="o">=</span>
	    <span class="n">IPS_SCSI_REQSEN_VALID</span> <span class="o">|</span> <span class="n">IPS_SCSI_REQSEN_CURRENT_ERR</span><span class="p">;</span>
	<span class="n">reqsen</span><span class="p">.</span><span class="n">AdditionalLength</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">reqsen</span><span class="p">.</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="n">IPS_SCSI_REQSEN_NO_SENSE</span><span class="p">;</span>
	<span class="n">reqsen</span><span class="p">.</span><span class="n">AdditionalSenseCodeQual</span> <span class="o">=</span> <span class="n">IPS_SCSI_REQSEN_NO_SENSE</span><span class="p">;</span>

	<span class="n">ips_scmd_buf_write</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reqsen</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">reqsen</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_free                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Free any allocated space for this controller                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_free</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_free&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IPS_ENQ</span><span class="p">),</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq_busaddr</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_ADAPTER</span><span class="p">)</span> <span class="o">+</span>
					    <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_IO_CMD</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="p">,</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_LD_INFO</span><span class="p">),</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="p">,</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info_dma_addr</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_len</span><span class="p">,</span>
					    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_datasize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ips_deallocatescbs</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span><span class="p">);</span>

		<span class="cm">/* free memory mapped (if applicable) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioremap_ptr</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioremap_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_deallocatescbs                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Free the command blocks                                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_deallocatescbs</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				    <span class="n">IPS_SGLIST_SIZE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_MAX_SG</span> <span class="o">*</span> <span class="n">cmds</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_scb_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">cmds</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* end if */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_allocatescbs                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Allocate the command blocks                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_allocatescbs</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb_p</span><span class="p">;</span>
	<span class="n">IPS_SG_LIST</span> <span class="n">ips_sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">command_dma</span><span class="p">,</span> <span class="n">sg_dma</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_allocatescbs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Allocate memory for the SCBs */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_scb_t</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">command_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ips_sg</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				 <span class="n">IPS_SGLIST_SIZE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_MAX_SG</span> <span class="o">*</span>
				 <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips_sg</span><span class="p">.</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_scb_t</span><span class="p">),</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">,</span>
				    <span class="n">command_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_scb_t</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">scb_p</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">=</span> <span class="n">command_dma</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_scb_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* set up S/G list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPS_USE_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scb_p</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">enh_list</span> <span class="o">=</span>
			    <span class="n">ips_sg</span><span class="p">.</span><span class="n">enh_list</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">IPS_MAX_SG</span><span class="p">;</span>
			<span class="n">scb_p</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span> <span class="o">=</span>
			    <span class="n">sg_dma</span> <span class="o">+</span> <span class="n">IPS_SGLIST_SIZE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_MAX_SG</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scb_p</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">std_list</span> <span class="o">=</span>
			    <span class="n">ips_sg</span><span class="p">.</span><span class="n">std_list</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">IPS_MAX_SG</span><span class="p">;</span>
			<span class="n">scb_p</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span> <span class="o">=</span>
			    <span class="n">sg_dma</span> <span class="o">+</span> <span class="n">IPS_SGLIST_SIZE</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_MAX_SG</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* add to the free list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scb_p</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_freelist</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_freelist</span> <span class="o">=</span> <span class="n">scb_p</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* success */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_init_scb                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize a CCB to default values                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_init_scb</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_SG_LIST</span> <span class="n">sg_list</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmd_busaddr</span><span class="p">,</span> <span class="n">sg_busaddr</span><span class="p">;</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_init_scb&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sg_list</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
	<span class="n">cmd_busaddr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">;</span>
	<span class="n">sg_busaddr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span><span class="p">;</span>
	<span class="cm">/* zero fill */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_scb_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_IO_CMD</span><span class="p">));</span>

	<span class="cm">/* Initialize dummy command bucket */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="o">-&gt;</span><span class="n">ccsar</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span>
				       <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_ADAPTER</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="o">-&gt;</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_MAX_CMDS</span><span class="p">;</span>

	<span class="cm">/* set bus address of scb */</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">=</span> <span class="n">cmd_busaddr</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_busaddr</span> <span class="o">=</span> <span class="n">sg_busaddr</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">sg_list</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>

	<span class="cm">/* Neptune Fix */</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">cccr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">IPS_BIT_ILE</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">ccsar</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span>
					      <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_ADAPTER</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_get_scb                                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize a CCB to default values                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within a lock                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">ips_scb_t</span> <span class="o">*</span>
<span class="nf">ips_getscb</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_getscb&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_freelist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_freelist</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_free_scb                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Return an unused CCB back to the free list                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* ASSUMED to be called from within a lock                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_freescb</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_freescb&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPS_SCB_MAP_SG</span><span class="p">)</span>
                <span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPS_SCB_MAP_SINGLE</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_busaddr</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span>
				 <span class="n">IPS_DMA_DIR</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>

	<span class="cm">/* check to make sure this is not our &quot;special&quot; scb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">q_next</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_freelist</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scb_freelist</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_isinit_copperhead                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Is controller initialized ?                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_isinit_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">scpr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">isr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_isinit_copperhead&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">isr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="n">scpr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_EI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">scpr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_EBM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_isinit_copperhead_memio                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Is controller initialized ?                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_isinit_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">scpr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_is_init_copperhead_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">isr</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="n">scpr</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_EI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">scpr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_EBM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_isinit_morpheus                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Is controller initialized ?                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_isinit_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">post</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_is_init_morpheus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips_isintr_morpheus</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
	    <span class="n">ips_flush_and_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">post</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_MSG0</span><span class="p">);</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">post</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_flush_and_reset                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Perform cleanup ( FLUSH and RESET ) when the adapter is in an unknown  */</span>
<span class="cm">/*   state ( was trying to INIT and an interrupt was already pending ) ...  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_flush_and_reset</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">ret</span><span class="p">;</span>
 	<span class="kt">int</span>  <span class="n">time</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">done</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">command_dma</span><span class="p">;</span>

	<span class="cm">/* Create a usuable SCB */</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ips_scb_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">command_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ips_scb_t</span><span class="p">));</span>
	    <span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span> <span class="o">=</span> <span class="n">command_dma</span><span class="p">;</span>

	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>

	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_FLUSH</span><span class="p">;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_MAX_CMDS</span><span class="p">;</span>   <span class="cm">/* Use an ID that would otherwise not exist */</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPS_NORM_STATE</span><span class="p">;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flush_cache</span><span class="p">.</span><span class="n">reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	    <span class="n">ret</span> <span class="o">=</span> <span class="n">ips_send_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>                      <span class="cm">/* Send the Flush Command */</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">time</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">IPS_ONE_SEC</span><span class="p">;</span>	              <span class="cm">/* Max Wait time is 60 seconds */</span>
	        <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	        <span class="k">while</span> <span class="p">((</span><span class="n">time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">done</span> <span class="o">=</span> <span class="n">ips_poll_for_flush_complete</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	           <span class="cm">/* This may look evil, but it&#39;s only done during extremely rare start-up conditions ! */</span>
	           <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	           <span class="n">time</span><span class="o">--</span><span class="p">;</span>
	        <span class="p">}</span>
        <span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now RESET and INIT the adapter */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">reset</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ips_scb_t</span><span class="p">),</span> <span class="n">scb</span><span class="p">,</span> <span class="n">command_dma</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_poll_for_flush_complete                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Poll for the Flush Command issued by ips_flush_and_reset() to complete */</span>
<span class="cm">/*   All other responses are just taken off the queue and ignored           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_poll_for_flush_complete</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IPS_STATUS</span> <span class="n">cstatus</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">cstatus</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">statupd</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">cstatus</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>      <span class="cm">/* If No Interrupt to process */</span>
			<span class="k">break</span><span class="p">;</span>

	    <span class="cm">/* Success is when we see the Flush Command ID */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">cstatus</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">command_id</span> <span class="o">==</span> <span class="n">IPS_MAX_CMDS</span><span class="p">)</span>
	        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_enable_int_copperhead                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Turn on interrupts                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_enable_int_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_enable_int_copperhead&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">,</span> <span class="n">IPS_BIT_EI</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>	<span class="cm">/*Ensure PCI Posting Completes*/</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_enable_int_copperhead_memio                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Turn on interrupts                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_enable_int_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_enable_int_copperhead_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">IPS_BIT_EI</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>	<span class="cm">/*Ensure PCI Posting Completes*/</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_enable_int_morpheus                                    */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Turn on interrupts                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_enable_int_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">Oimr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_enable_int_morpheus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">Oimr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_OIMR</span><span class="p">);</span>
	<span class="n">Oimr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">Oimr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_OIMR</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_OIMR</span><span class="p">);</span>	<span class="cm">/*Ensure PCI Posting Completes*/</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_init_copperhead                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize a copperhead controller                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_init_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">Isr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">Cbsp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">PostByte</span><span class="p">[</span><span class="n">IPS_MAX_POST_BYTES</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">ConfigByte</span><span class="p">[</span><span class="n">IPS_MAX_CONFIG_BYTES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_init_copperhead&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_POST_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Isr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_GHI</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Delay for 1 Second */</span>
			<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">45</span><span class="p">)</span>
			<span class="cm">/* error occurred */</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">PostByte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_ISPR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PostByte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">IPS_GOOD_POST_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;reset controller fails (post status %x %x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">PostByte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PostByte</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_CONFIG_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Isr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_GHI</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Delay for 1 Second */</span>
			<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
			<span class="cm">/* error occurred */</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">ConfigByte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_ISPR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Cbsp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_CBSP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Cbsp</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_OP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
		<span class="cm">/* reset failed */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* setup CCCR */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x1010</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_CCCR</span><span class="p">);</span>

	<span class="cm">/* Enable busmastering */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">IPS_BIT_EBM</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="cm">/* fix for anaconda64 */</span>
		<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_NDAE</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">IPS_BIT_EI</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_init_copperhead_memio                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize a copperhead controller with memory mapped I/O              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_init_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">Isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">Cbsp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">PostByte</span><span class="p">[</span><span class="n">IPS_MAX_POST_BYTES</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">ConfigByte</span><span class="p">[</span><span class="n">IPS_MAX_CONFIG_BYTES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_init_copperhead_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_POST_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Isr</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_GHI</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Delay for 1 Second */</span>
			<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">45</span><span class="p">)</span>
			<span class="cm">/* error occurred */</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">PostByte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_ISPR</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PostByte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">IPS_GOOD_POST_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;reset controller fails (post status %x %x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">PostByte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PostByte</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_CONFIG_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Isr</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_GHI</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Delay for 1 Second */</span>
			<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
			<span class="cm">/* error occurred */</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">ConfigByte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_ISPR</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Cbsp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_CBSP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Cbsp</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_OP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
		<span class="cm">/* error occurred */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* setup CCCR */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x1010</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_CCCR</span><span class="p">);</span>

	<span class="cm">/* Enable busmastering */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">IPS_BIT_EBM</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="cm">/* fix for anaconda64 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_NDAE</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">IPS_BIT_EI</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>

	<span class="cm">/* if we get here then everything went OK */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_init_morpheus                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize a morpheus controller                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_init_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">Post</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">Config</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">Isr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">Oimr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_init_morpheus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Wait up to 45 secs for Post */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_I960_MSG0I</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">45</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error occurred */</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;timeout waiting for post.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Post</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_MSG0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Post</span> <span class="o">==</span> <span class="mh">0x4F00</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* If Flashing the Battery PIC         */</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Flashing Battery PIC, Please wait ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Clear the interrupt bit */</span>
		<span class="n">Isr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">IPS_BIT_I960_MSG0I</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*    Wait Up to 2 Min. for Completion */</span>
			<span class="n">Post</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_MSG0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Post</span> <span class="o">!=</span> <span class="mh">0x4F00</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Delay for 1 Second */</span>
			<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">120</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;timeout waiting for Battery PIC Flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Clear the interrupt bit */</span>
	<span class="n">Isr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">IPS_BIT_I960_MSG0I</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Post</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IPS_GOOD_POST_STATUS</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;reset controller fails (post status %x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Post</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait up to 240 secs for config bytes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_I960_MSG1I</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error occurred */</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;timeout waiting for config.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Config</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_MSG1</span><span class="p">);</span>

	<span class="cm">/* Clear interrupt bit */</span>
	<span class="n">Isr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">IPS_BIT_I960_MSG1I</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

	<span class="cm">/* Turn on the interrupts */</span>
	<span class="n">Oimr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_OIMR</span><span class="p">);</span>
	<span class="n">Oimr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">Oimr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_OIMR</span><span class="p">);</span>

	<span class="cm">/* if we get here then everything went OK */</span>

	<span class="cm">/* Since we did a RESET, an EraseStripeLock may be needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Post</span> <span class="o">==</span> <span class="mh">0xEF10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Config</span> <span class="o">==</span> <span class="mh">0x000F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Config</span> <span class="o">==</span> <span class="mh">0x0009</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">requires_esl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_reset_copperhead                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Reset the controller                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_reset_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset_counter</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_reset_copperhead&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_reset_copperhead: io addr: %x, irq: %d&quot;</span><span class="p">,</span>
		  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">reset_counter</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_counter</span><span class="o">++</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">IPS_BIT_RST</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>

		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reset_counter</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_reset_copperhead_memio                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Reset the controller                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_reset_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset_counter</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_reset_copperhead_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_reset_copperhead_memio: mem addr: %x, irq: %d&quot;</span><span class="p">,</span>
		  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">reset_counter</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_counter</span><span class="o">++</span><span class="p">;</span>

		<span class="n">writeb</span><span class="p">(</span><span class="n">IPS_BIT_RST</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>

		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SCPR</span><span class="p">);</span>

		<span class="cm">/* Delay for 1 Second */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="n">IPS_ONE_SEC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reset_counter</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_reset_morpheus                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Reset the controller                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_reset_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset_counter</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">junk</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_reset_morpheus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_reset_morpheus: mem addr: %x, irq: %d&quot;</span><span class="p">,</span>
		  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">reset_counter</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_counter</span><span class="o">++</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_IDR</span><span class="p">);</span>

		<span class="cm">/* Delay for 5 Seconds */</span>
		<span class="n">MDELAY</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">IPS_ONE_SEC</span><span class="p">);</span>

		<span class="cm">/* Do a PCI config read to wait for adapter */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">junk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reset_counter</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_statinit                                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize the status queues on the controller                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_statinit</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">phys_status_start</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_statinit&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_start</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_end</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">+</span> <span class="n">IPS_MAX_CMDS</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">phys_status_start</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span><span class="p">;</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">phys_status_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SQSR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">phys_status_start</span> <span class="o">+</span> <span class="n">IPS_STATUS_Q_SIZE</span><span class="p">,</span>
	     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SQER</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">phys_status_start</span> <span class="o">+</span> <span class="n">IPS_STATUS_SIZE</span><span class="p">,</span>
	     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SQHR</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">phys_status_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SQTR</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span> <span class="o">=</span> <span class="n">phys_status_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_statinit_memio                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Initialize the status queues on the controller                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_statinit_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">phys_status_start</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_statinit_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_start</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_end</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">+</span> <span class="n">IPS_MAX_CMDS</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">phys_status_start</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phys_status_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SQSR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phys_status_start</span> <span class="o">+</span> <span class="n">IPS_STATUS_Q_SIZE</span><span class="p">,</span>
	       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SQER</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phys_status_start</span> <span class="o">+</span> <span class="n">IPS_STATUS_SIZE</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SQHR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phys_status_start</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SQTR</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span> <span class="o">=</span> <span class="n">phys_status_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_statupd_copperhead                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove an element from the status queue                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ips_statupd_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_statupd_copperhead&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_start</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span><span class="p">,</span>
	     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_SQTR</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_statupd_copperhead_memio                               */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove an element from the status queue                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ips_statupd_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_statupd_copperhead_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_start</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_tail</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_SQTR</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">p_status_tail</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_statupd_morpheus                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Remove an element from the status queue                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ips_statupd_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_statupd_morpheus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_OUTMSGQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_issue_copperhead                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Send a command down to the controller                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_issue_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">TimeOut</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_issue_copperhead&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">KERN_NOTICE</span> <span class="s">&quot;(%s%d) ips_issue: logical cmd id %d&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TimeOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_CCCR</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_SEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">TimeOut</span> <span class="o">&gt;=</span> <span class="n">IPS_SEM_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_START_STOP</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;ips_issue val [0x%x].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;ips_issue semaphore chk timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">return</span> <span class="p">(</span><span class="n">IPS_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>		<span class="cm">/* end if */</span>
	<span class="p">}</span>			<span class="cm">/* end while */</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_CCSAR</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">IPS_BIT_START_CMD</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_CCCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_issue_copperhead_memio                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Send a command down to the controller                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_issue_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">TimeOut</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_issue_copperhead_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: logical cmd id %d&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TimeOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_CCCR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_SEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">TimeOut</span> <span class="o">&gt;=</span> <span class="n">IPS_SEM_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_START_STOP</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;ips_issue val [0x%x].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				   <span class="s">&quot;ips_issue semaphore chk timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">return</span> <span class="p">(</span><span class="n">IPS_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>		<span class="cm">/* end if */</span>
	<span class="p">}</span>			<span class="cm">/* end while */</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_CCSAR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IPS_BIT_START_CMD</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_CCCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_issue_i2o                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Send a command down to the controller                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_issue_i2o</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_issue_i2o&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: logical cmd id %d&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_INMSGQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_issue_i2o_memio                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Send a command down to the controller                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_issue_i2o_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_issue_i2o_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">,</span>
			  <span class="n">scb</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%s%d) ips_issue: logical cmd id %d&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_busaddr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_INMSGQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IPS_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_isintr_copperhead                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Test to see if an interrupt is for us                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_isintr_copperhead</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">Isr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_isintr_copperhead&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">Isr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="cm">/* ?!?! Nothing really there */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_SCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IPS_BIT_SQO</span> <span class="o">|</span> <span class="n">IPS_BIT_GHI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* status queue overflow or GHI */</span>
		<span class="cm">/* just clear the interrupt */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_isintr_copperhead_memio                                */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Test to see if an interrupt is for us                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_isintr_copperhead_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">Isr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_isintr_memio&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">Isr</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="cm">/* ?!?! Nothing really there */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_SCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IPS_BIT_SQO</span> <span class="o">|</span> <span class="n">IPS_BIT_GHI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* status queue overflow or GHI */</span>
		<span class="cm">/* just clear the interrupt */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">Isr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_HISR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_isintr_morpheus                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Test to see if an interrupt is for us                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_isintr_morpheus</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">Isr</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_isintr_morpheus&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">Isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I2O_HIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Isr</span> <span class="o">&amp;</span> <span class="n">IPS_BIT_I2O_OPQI</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_wait                                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Wait for a command to complete                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_wait</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_wait&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_FAILURE</span><span class="p">;</span>
	<span class="n">done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">time</span> <span class="o">*=</span> <span class="n">IPS_ONE_SEC</span><span class="p">;</span>	<span class="cm">/* convert seconds */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
				<span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="n">IPS_INTR_IORL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">waitflag</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * controller generated an interrupt to</span>
<span class="cm">				 * acknowledge completion of the command</span>
<span class="cm">				 * and ips_intr() has serviced the interrupt.</span>
<span class="cm">				 */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">IPS_SUCCESS</span><span class="p">;</span>
				<span class="n">done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * NOTE: we already have the io_request_lock so</span>
<span class="cm">			 * even if we get an interrupt it won&#39;t get serviced</span>
<span class="cm">			 * until after we finish.</span>
<span class="cm">			 */</span>

			<span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">intr</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* This looks like a very evil loop, but it only does this during start-up */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">time</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_write_driver_status                                    */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Write OS/Driver version to Page 5 of the nvram on the controller       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_write_driver_status</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_write_driver_status&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_readwrite_page5</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;unable to read NVRAM page 5.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check to make sure the page has a valid */</span>
	<span class="cm">/* signature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IPS_NVRAM_P5_SIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			  <span class="s">&quot;(%s%d) NVRAM page 5 has an invalid signature: %X.&quot;</span><span class="p">,</span>
			  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">IPS_NVRAM_P5_SIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		  <span class="s">&quot;(%s%d) Ad Type: %d, Ad Slot: %d, BIOS: %c%c%c%c %c%c%c%c.&quot;</span><span class="p">,</span>
		  <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">),</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_slot</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">ips_get_bios_version</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>

	<span class="cm">/* change values (as needed) */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">operating_system</span> <span class="o">=</span> <span class="n">IPS_OS_LINUX</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ad_type</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">driver_high</span><span class="p">,</span> <span class="n">IPS_VERSION_HIGH</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">driver_low</span><span class="p">,</span> <span class="n">IPS_VERSION_LOW</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_high</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">bios_low</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bios_version</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">versioning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Indicate the Driver Does Not Support Versioning */</span>

	<span class="cm">/* now update the page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_readwrite_page5</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;unable to write NVRAM page 5.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* IF NVRAM Page 5 is OK, Use it for Slot Number Info Because Linux Doesn&#39;t Do Slots */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">slot_num</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_slot</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_read_adapter_status                                    */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Do an Inquiry command to the adapter                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_read_adapter_status</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_read_adapter_status&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_ENQUIRY</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_ENQUIRY</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">log_drv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq_busaddr</span><span class="p">;</span>

	<span class="cm">/* send command */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
	      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_read_subsystem_parameters                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Read subsystem parameters from the adapter                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_read_subsystem_parameters</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_read_subsystem_parameters&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_GET_SUBSYS</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_GET_SUBSYS</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sector_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">log_drv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">;</span>

	<span class="cm">/* send command */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
	      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_read_config                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Read the configuration on the adapter                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_read_config</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_read_config&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* set defaults for initiator IDs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">init_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_READ_CONF</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_READ_CONF</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">basic_io</span><span class="p">.</span><span class="n">sg_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">;</span>

	<span class="cm">/* send command */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
	      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_CONF</span><span class="p">));</span>

		<span class="cm">/* reset initiator IDs */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">init_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

		<span class="cm">/* Allow Completed with Errors, so JCRM can access the Adapter to fix the problems */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">IPS_CMD_CMPLT_WERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_readwrite_page5                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Read nvram page 5 from the adapter                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_readwrite_page5</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_readwrite_page5&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_RW_NVRAM_PAGE</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_RW_NVRAM_PAGE</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nvram</span><span class="p">.</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">));</span>

	<span class="cm">/* issue the command */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
	      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_NVRAM_P5</span><span class="p">));</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_clear_adapter                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   Clear the stripe lock tables                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_clear_adapter</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_clear_adapter&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_reset_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_CONFIG_SYNC</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_CONFIG_SYNC</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">source_target</span> <span class="o">=</span> <span class="n">IPS_POCL</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">config_sync</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* issue command */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
	      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_reset_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* send unlock stripe command */</span>
	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_ERROR_TABLE</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_reset_timeout</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_ERROR_TABLE</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">log_drv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">IPS_CSL</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">unlock_stripe</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* issue command */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ret</span> <span class="o">=</span>
	      <span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">))</span> <span class="o">==</span> <span class="n">IPS_FAILURE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IPS_SUCCESS_IMM</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">basic_status</span> <span class="o">&amp;</span> <span class="n">IPS_GSC_STATUS_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_ffdc_reset                                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   FFDC: write reset info                                                 */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_ffdc_reset</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_ffdc_reset&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_FFDC</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_FFDC</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">reset_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">reset_type</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/* convert time to what the card wants */</span>
	<span class="n">ips_fix_ffdc_time</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_ffdc</span><span class="p">);</span>

	<span class="cm">/* issue command */</span>
	<span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_ffdc_time                                              */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*   FFDC: write time info                                                  */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_ffdc_time</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_scb_t</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_ffdc_time&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DEBUG_VAR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;(%s%d) Sending time update.&quot;</span><span class="p">,</span> <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">);</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scbs</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">ips_init_scb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">ips_cmd_timeout</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPS_CMD_FFDC</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">IPS_CMD_FFDC</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">IPS_COMMAND_ID</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">reset_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">reset_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* convert time to what the card wants */</span>
	<span class="n">ips_fix_ffdc_time</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">last_ffdc</span><span class="p">);</span>

	<span class="cm">/* issue command */</span>
	<span class="n">ips_send_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">ips_cmd_timeout</span><span class="p">,</span> <span class="n">IPS_FFDC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_fix_ffdc_time                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Adjust time_t to what the card wants                                   */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_fix_ffdc_time</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ips_scb_t</span> <span class="o">*</span> <span class="n">scb</span><span class="p">,</span> <span class="kt">time_t</span> <span class="n">current_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">days</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">year</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yleap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">year_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">IPS_DAYS_NORMAL_YEAR</span><span class="p">,</span> <span class="n">IPS_DAYS_LEAP_YEAR</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">month_lengths</span><span class="p">[</span><span class="mi">12</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_fix_ffdc_time&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">days</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">/</span> <span class="n">IPS_SECS_DAY</span><span class="p">;</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">%</span> <span class="n">IPS_SECS_DAY</span><span class="p">;</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">hour</span> <span class="o">=</span> <span class="p">(</span><span class="n">rem</span> <span class="o">/</span> <span class="n">IPS_SECS_HOUR</span><span class="p">);</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="n">rem</span> <span class="o">%</span> <span class="n">IPS_SECS_HOUR</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">minute</span> <span class="o">=</span> <span class="p">(</span><span class="n">rem</span> <span class="o">/</span> <span class="n">IPS_SECS_MIN</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="p">(</span><span class="n">rem</span> <span class="o">%</span> <span class="n">IPS_SECS_MIN</span><span class="p">);</span>

	<span class="n">year</span> <span class="o">=</span> <span class="n">IPS_EPOCH_YEAR</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">days</span> <span class="o">&gt;=</span> <span class="n">year_lengths</span><span class="p">[</span><span class="n">yleap</span> <span class="o">=</span> <span class="n">IPS_IS_LEAP_YEAR</span><span class="p">(</span><span class="n">year</span><span class="p">)])</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">newy</span><span class="p">;</span>

		<span class="n">newy</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="p">(</span><span class="n">days</span> <span class="o">/</span> <span class="n">IPS_DAYS_NORMAL_YEAR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">--</span><span class="n">newy</span><span class="p">;</span>
		<span class="n">days</span> <span class="o">-=</span> <span class="p">(</span><span class="n">newy</span> <span class="o">-</span> <span class="n">year</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_DAYS_NORMAL_YEAR</span> <span class="o">+</span>
		    <span class="n">IPS_NUM_LEAP_YEARS_THROUGH</span><span class="p">(</span><span class="n">newy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">IPS_NUM_LEAP_YEARS_THROUGH</span><span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">year</span> <span class="o">=</span> <span class="n">newy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">yearH</span> <span class="o">=</span> <span class="n">year</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">yearL</span> <span class="o">=</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">days</span> <span class="o">&gt;=</span> <span class="n">month_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">yleap</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">days</span> <span class="o">-=</span> <span class="n">month_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">yleap</span><span class="p">];</span>

	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ffdc</span><span class="p">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * BIOS Flash Routines                                                      *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_erase_bios                                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Erase the BIOS on the adapter                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_erase_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_erase_bios&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear the status register */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* Erase Setup */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* Erase Confirm */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xD0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* Erase Status */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">80000</span><span class="p">;</span>	<span class="cm">/* 80 seconds */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">MDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* timeout */</span>

		<span class="cm">/* try to suspend the erase */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xB0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="cm">/* wait for 10 seconds */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">MDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check for valid VPP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="cm">/* VPP failure */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* check for successful flash */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="cm">/* sequence error */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Otherwise, we were successful */</span>
	<span class="cm">/* clear status */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* enable reads */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_erase_bios_memio                                       */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Erase the BIOS on the adapter                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_erase_bios_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_erase_bios_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear the status register */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* Erase Setup */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* Erase Confirm */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xD0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* Erase Status */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">80000</span><span class="p">;</span>	<span class="cm">/* 80 seconds */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">MDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* timeout */</span>

		<span class="cm">/* try to suspend the erase */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0xB0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="cm">/* wait for 10 seconds */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">MDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check for valid VPP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="cm">/* VPP failure */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* check for successful flash */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="cm">/* sequence error */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Otherwise, we were successful */</span>
	<span class="cm">/* clear status */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="cm">/* enable reads */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_program_bios                                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Program the BIOS on the adapter                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_program_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">buffersize</span><span class="p">,</span>
		 <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_program_bios&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffersize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write a byte */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="n">outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="cm">/* wait up to one second */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">MDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* timeout error */</span>
			<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* check the status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* programming error */</span>
			<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* end for */</span>

	<span class="cm">/* Enable reading */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_program_bios_memio                                     */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Program the BIOS on the adapter                                        */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_program_bios_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">buffersize</span><span class="p">,</span>
		       <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_program_bios_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffersize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write a byte */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="n">writeb</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="cm">/* wait up to one second */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">MDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* timeout error */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">writeb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* check the status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* programming error */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="n">writeb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* end for */</span>

	<span class="cm">/* Enable reading */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_verify_bios                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Verify the BIOS on the adapter                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_verify_bios</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">buffersize</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_verify_bios&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* test 1st byte */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">checksum</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffersize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">outl</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">checksum</span> <span class="o">+</span> <span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* failure */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* success */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_verify_bios_memio                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   Verify the BIOS on the adapter                                         */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_verify_bios_memio</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">buffersize</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_verify_bios_memio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* test 1st byte */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">checksum</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffersize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">IPS_REVID_TROMBONE64</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>	<span class="cm">/* 25 us */</span>

		<span class="n">checksum</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">checksum</span> <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_FLDP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* failure */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* success */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_abort_init                                             */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   cleanup routine for a failed adapter initialization                    */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_abort_init</span><span class="p">(</span><span class="n">ips_ha_t</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ips_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ips_sh</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_shift_controllers                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   helper function for ordering adapters                                  */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_shift_controllers</span><span class="p">(</span><span class="kt">int</span> <span class="n">lowindex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">highindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha_sav</span> <span class="o">=</span> <span class="n">ips_ha</span><span class="p">[</span><span class="n">highindex</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh_sav</span> <span class="o">=</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">highindex</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">highindex</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">lowindex</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha_sav</span><span class="o">-&gt;</span><span class="n">host_num</span> <span class="o">=</span> <span class="n">lowindex</span><span class="p">;</span>
	<span class="n">ips_ha</span><span class="p">[</span><span class="n">lowindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha_sav</span><span class="p">;</span>
	<span class="n">ips_sh</span><span class="p">[</span><span class="n">lowindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh_sav</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_order_controllers                                      */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   place controllers is the &quot;proper&quot; boot order                           */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_order_controllers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">IPS_NVRAM_P5</span> <span class="o">*</span><span class="n">nvram</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_ha</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nvram</span> <span class="o">=</span> <span class="n">ips_ha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_order</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_order</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">position</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ips_num_controllers</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID6M</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID7M</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ips_shift_controllers</span><span class="p">(</span><span class="n">position</span><span class="p">,</span>
								      <span class="n">j</span><span class="p">);</span>
						<span class="n">position</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID4L</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID4M</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID4MX</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID4LX</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ips_shift_controllers</span><span class="p">(</span><span class="n">position</span><span class="p">,</span>
								      <span class="n">j</span><span class="p">);</span>
						<span class="n">position</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID6I</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID5I2</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID5I1</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID7k</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ips_shift_controllers</span><span class="p">(</span><span class="n">position</span><span class="p">,</span>
								      <span class="n">j</span><span class="p">);</span>
						<span class="n">position</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID2</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_NAVAJO</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_KIOWA</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID3L</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID3</span>:
				<span class="k">case</span> <span class="n">IPS_ADTYPE_SERVERAID4H</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">adapter_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ips_shift_controllers</span><span class="p">(</span><span class="n">position</span><span class="p">,</span>
								      <span class="n">j</span><span class="p">);</span>
						<span class="n">position</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* if adapter_order[0], then ordering is complete */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* old bios, use older ordering */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">position</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ips_num_controllers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID5I2</span> <span class="o">||</span>
		    <span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID5I1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ips_shift_controllers</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">position</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if there were no 5I cards, then don&#39;t do any extra ordering */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">position</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ips_num_controllers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID4L</span> <span class="o">||</span>
		    <span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID4M</span> <span class="o">||</span>
		    <span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID4LX</span> <span class="o">||</span>
		    <span class="n">ips_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ad_type</span> <span class="o">==</span> <span class="n">IPS_ADTYPE_SERVERAID4MX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ips_shift_controllers</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">position</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_register_scsi                                          */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   perform any registration and setup with the scsi layer                 */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_register_scsi</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="o">*</span><span class="n">oldha</span> <span class="o">=</span> <span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_driver_template</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_ha_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">oldha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to register controller with SCSI subsystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">IPS_HA</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">oldha</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_ha_t</span><span class="p">));</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">oldha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">oldha</span><span class="p">);</span>
	<span class="cm">/* Install the interrupt handler with the new ha */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_ipsintr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to install interrupt handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_sh</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">oldha</span><span class="p">);</span>

	<span class="cm">/* Store away needed values for later use */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span><span class="p">)</span> <span class="o">?</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">:</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">use_clustering</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ntargets</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nlun</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nbus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">ips_sh</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>
	<span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
<span class="nl">err_out_sh:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*   Routine Name: ips_remove_device                                         */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Routine Description:                                                    */</span>
<span class="cm">/*     Remove one Adapter ( Hot Plugging )                                   */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">ips_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ips_release</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_module_init                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   function called on module load                                         */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">ips_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_pci_driver</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ips_driver_template</span><span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">ips_order_controllers</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_driver_template</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_pci_driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_notifier</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Name: ips_module_exit                                            */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/* Routine Description:                                                     */</span>
<span class="cm">/*   function called on module unload                                       */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">ips_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_pci_driver</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_notifier</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ips_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ips_module_exit</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*   Routine Name: ips_insert_device                                         */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Routine Description:                                                    */</span>
<span class="cm">/*     Add One Adapter ( Hot Plug )                                          */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Return Value:                                                           */</span>
<span class="cm">/*     0 if Successful, else non-zero                                        */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ips_insert_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_insert_device&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;ips&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ips_init_phase1</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ips_init_phase2</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips_hotplug</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_register_scsi</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ips_free</span><span class="p">(</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="n">ips_num_controllers</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ips_next_controller</span> <span class="o">=</span> <span class="n">ips_num_controllers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ips_sh</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*   Routine Name: ips_init_phase1                                           */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Routine Description:                                                    */</span>
<span class="cm">/*     Adapter Initialization                                                */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Return Value:                                                           */</span>
<span class="cm">/*     0 if Successful, else non-zero                                        */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_init_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">indexPtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">io_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mem_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">io_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_address</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioremap_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">IsDead</span><span class="p">;</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_init_phase1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">IPS_MAX_ADAPTERS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">IPS_MAX_ADAPTERS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_ha</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">IPS_MAX_ADAPTERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* stuff that we get in dev */</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>

	<span class="cm">/* Init MEM/IO addresses to 0 */</span>
	<span class="n">mem_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">io_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mem_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* setup memory mapped area (if applicable) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">base</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">offs</span><span class="p">;</span>

		<span class="n">base</span> <span class="o">=</span> <span class="n">mem_addr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="n">mem_addr</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">ioremap_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioremap_ptr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap_ptr</span> <span class="o">+</span> <span class="n">offs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioremap_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* found a controller */</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">ips_ha_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate temporary ha struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ips_sh</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Store info in HA structure */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_addr</span> <span class="o">=</span> <span class="n">io_addr</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">io_len</span> <span class="o">=</span> <span class="n">io_len</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_len</span> <span class="o">=</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">mem_ptr</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioremap_ptr</span> <span class="o">=</span> <span class="n">ioremap_ptr</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">slot_num</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the pci_dev&#39;s dma_mask.  Not all adapters support 64bit</span>
<span class="cm">	 * addressing so don&#39;t enable it if the adapter can&#39;t support</span>
<span class="cm">	 * it!  Also, don&#39;t use 64bit addressing if dma addresses</span>
<span class="cm">	 * are guaranteed to be &lt; 4G.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IPS_ENABLE_DMA64</span> <span class="o">&amp;&amp;</span> <span class="n">IPS_HAS_ENH_SGLIST</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">ha</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPS_HA_ENH_SG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to set DMA Mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ips_cd_boot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ips_FlashData</span><span class="p">){</span>
		<span class="n">ips_FlashData</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">ips_flashbusaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_ENQ</span><span class="p">),</span>
				       <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq_busaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">enq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate host inquiry structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_ADAPTER</span><span class="p">)</span> <span class="o">+</span>
					 <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_IO_CMD</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate host adapt &amp; dummy structures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span><span class="o">-&gt;</span><span class="n">hw_status_start</span> <span class="o">=</span> <span class="n">dma_address</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dummy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>



	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_LD_INFO</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate logical drive info structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">logical_drive_info_dma_addr</span> <span class="o">=</span> <span class="n">dma_address</span><span class="p">;</span>


	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_CONF</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate host conf structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_NVRAM_P5</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate host NVRAM structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">IPS_SUBSYS</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">subsys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate host subsystem structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* the ioctl buffer is now used during adapter initialization, so its</span>
<span class="cm">	 * successful allocation is now required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips_ioctlsize</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">ips_ioctlsize</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ips_ioctlsize</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_busaddr</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_len</span> <span class="o">=</span> <span class="n">ips_ioctlsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ioctl_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate IOCTL data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup Functions</span>
<span class="cm">	 */</span>
	<span class="n">ips_setup_funclist</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">IPS_IS_MORPHEUS</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">IPS_IS_MARCO</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* If Morpheus appears dead, reset it */</span>
		<span class="n">IsDead</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="n">IPS_REG_I960_MSG1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsDead</span> <span class="o">==</span> <span class="mh">0xDEADBEEF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ips_reset_morpheus</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the card if it isn&#39;t already</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">isinit</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Initialization failed</span>
<span class="cm">			 */</span>
			<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">,</span>
				   <span class="s">&quot;Unable to initialize controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">indexPtr</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*   Routine Name: ips_init_phase2                                           */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Routine Description:                                                    */</span>
<span class="cm">/*     Adapter Initialization Phase 2                                        */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*   Return Value:                                                           */</span>
<span class="cm">/*     0 if Successful, else non-zero                                        */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ips_init_phase2</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips_ha_t</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">METHOD_TRACE</span><span class="p">(</span><span class="s">&quot;ips_init_phase2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ips_ha</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Install the interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_ipsintr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">ips_name</span><span class="p">,</span> <span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to install interrupt handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a temporary SCB for initialization</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_allocatescbs</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate a CCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_hainit</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to initialize controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Free the temporary SCB */</span>
	<span class="n">ips_deallocatescbs</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* allocate CCBs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_allocatescbs</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IPS_PRINTK</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate CCBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ips_abort_init</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IBM ServeRAID Adapter Driver &quot;</span> <span class="n">IPS_VER_STRING</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">IPS_VER_STRING</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we almost follow Linus&#39;s tabbing style.</span>
<span class="cm"> * Emacs will notice this stuff at the end of the file and automatically</span>
<span class="cm"> * adjust the settings for this buffer only.  This must remain at the end</span>
<span class="cm"> * of the file.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-indent-level: 2</span>
<span class="cm"> * c-brace-imaginary-offset: 0</span>
<span class="cm"> * c-brace-offset: -2</span>
<span class="cm"> * c-argdecl-indent: 2</span>
<span class="cm"> * c-label-offset: -2</span>
<span class="cm"> * c-continued-statement-offset: 2</span>
<span class="cm"> * c-continued-brace-offset: 0</span>
<span class="cm"> * indent-tabs-mode: nil</span>
<span class="cm"> * tab-width: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
