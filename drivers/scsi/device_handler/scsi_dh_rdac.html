<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › device_handler › scsi_dh_rdac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>scsi_dh_rdac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * LSI/Engenio/NetApp E-Series RDAC SCSI Device Handler</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Mike Christie. All rights reserved.</span>
<span class="cm"> * Copyright (C) Chandra Seetharaman, IBM Corp. 2007</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dh.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define RDAC_NAME &quot;rdac&quot;</span>
<span class="cp">#define RDAC_RETRY_COUNT 5</span>

<span class="cm">/*</span>
<span class="cm"> * LSI mode page stuff</span>
<span class="cm"> *</span>
<span class="cm"> * These struct definitions and the forming of the</span>
<span class="cm"> * mode page were taken from the LSI RDAC 2.4 GPL&#39;d</span>
<span class="cm"> * driver, and then converted to Linux conventions.</span>
<span class="cm"> */</span>
<span class="cp">#define RDAC_QUIESCENCE_TIME 20</span>
<span class="cm">/*</span>
<span class="cm"> * Page Codes</span>
<span class="cm"> */</span>
<span class="cp">#define RDAC_PAGE_CODE_REDUNDANT_CONTROLLER 0x2c</span>

<span class="cm">/*</span>
<span class="cm"> * Controller modes definitions</span>
<span class="cm"> */</span>
<span class="cp">#define RDAC_MODE_TRANSFER_SPECIFIED_LUNS	0x02</span>

<span class="cm">/*</span>
<span class="cm"> * RDAC Options field</span>
<span class="cm"> */</span>
<span class="cp">#define RDAC_FORCED_QUIESENCE 0x02</span>

<span class="cp">#define RDAC_TIMEOUT	(60 * HZ)</span>
<span class="cp">#define RDAC_RETRIES	3</span>

<span class="k">struct</span> <span class="n">rdac_mode_6_hdr</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">data_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">medium_type</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">device_params</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">block_desc_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_mode_10_hdr</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">data_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">medium_type</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">device_params</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">reserved</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">block_desc_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_mode_common</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">controller_serial</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">alt_controller_serial</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">rdac_mode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">alt_rdac_mode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">quiescence_timeout</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rdac_options</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_pg_legacy</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_mode_6_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_mode_common</span> <span class="n">common</span><span class="p">;</span>
<span class="cp">#define MODE6_MAX_LUN	32</span>
	<span class="n">u8</span>	<span class="n">lun_table</span><span class="p">[</span><span class="n">MODE6_MAX_LUN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">reserved2</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_pg_expanded</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_mode_10_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">subpage_code</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_len</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rdac_mode_common</span> <span class="n">common</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">lun_table</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c9_inquiry</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">peripheral_info</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span>	<span class="cm">/* 0xC9 */</span>
	<span class="n">u8</span>	<span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* &quot;vace&quot; */</span>
	<span class="n">u8</span>	<span class="n">avte_cvp</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">path_prio</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved2</span><span class="p">[</span><span class="mi">38</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define SUBSYS_ID_LEN	16</span>
<span class="cp">#define SLOT_ID_LEN	2</span>
<span class="cp">#define ARRAY_LABEL_LEN	31</span>

<span class="k">struct</span> <span class="n">c4_inquiry</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">peripheral_info</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span>	<span class="cm">/* 0xC4 */</span>
	<span class="n">u8</span>	<span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* &quot;subs&quot; */</span>
	<span class="n">u8</span>	<span class="n">subsys_id</span><span class="p">[</span><span class="n">SUBSYS_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">revision</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">slot_id</span><span class="p">[</span><span class="n">SLOT_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define UNIQUE_ID_LEN 16</span>
<span class="k">struct</span> <span class="n">c8_inquiry</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">peripheral_info</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span> <span class="cm">/* 0xC8 */</span>
	<span class="n">u8</span>	<span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="cm">/* &quot;edid&quot; */</span>
	<span class="n">u8</span>	<span class="n">reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">vol_uniq_id_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">vol_uniq_id</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">vol_user_label_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">vol_user_label</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">array_uniq_id_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">array_unique_id</span><span class="p">[</span><span class="n">UNIQUE_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">array_user_label_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">array_user_label</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">lun</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_controller</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">array_id</span><span class="p">[</span><span class="n">UNIQUE_ID_LEN</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">use_ms10</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span>		<span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">node</span><span class="p">;</span> <span class="cm">/* list of all controllers */</span>
	<span class="k">union</span>			<span class="p">{</span>
		<span class="k">struct</span> <span class="n">rdac_pg_legacy</span> <span class="n">legacy</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rdac_pg_expanded</span> <span class="n">expanded</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mode_select</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">array_name</span><span class="p">[</span><span class="n">ARRAY_LABEL_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">ms_lock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ms_queued</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">ms_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span>	<span class="o">*</span><span class="n">ms_sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">ms_head</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">c2_inquiry</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">peripheral_info</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_code</span><span class="p">;</span>	<span class="cm">/* 0xC2 */</span>
	<span class="n">u8</span>	<span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">page_id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* &quot;swr4&quot; */</span>
	<span class="n">u8</span>	<span class="n">sw_version</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">sw_date</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">features_enabled</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">max_lun_supported</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">partitions</span><span class="p">[</span><span class="mi">239</span><span class="p">];</span> <span class="cm">/* Total allocation length should be 0xFF */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_controller</span>	<span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
<span class="cp">#define UNINITIALIZED_LUN	(1 &lt;&lt; 8)</span>
	<span class="kt">unsigned</span>		<span class="n">lun</span><span class="p">;</span>

<span class="cp">#define RDAC_MODE		0</span>
<span class="cp">#define RDAC_MODE_AVT		1</span>
<span class="cp">#define RDAC_MODE_IOSHIP	2</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">mode</span><span class="p">;</span>

<span class="cp">#define RDAC_STATE_ACTIVE	0</span>
<span class="cp">#define RDAC_STATE_PASSIVE	1</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">state</span><span class="p">;</span>

<span class="cp">#define RDAC_LUN_UNOWNED	0</span>
<span class="cp">#define RDAC_LUN_OWNED		1</span>
	<span class="kt">char</span>			<span class="n">lun_state</span><span class="p">;</span>

<span class="cp">#define RDAC_PREFERRED		0</span>
<span class="cp">#define RDAC_NON_PREFERRED	1</span>
	<span class="kt">char</span>			<span class="n">preferred</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">sense</span><span class="p">[</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">];</span>
	<span class="k">union</span>			<span class="p">{</span>
		<span class="k">struct</span> <span class="n">c2_inquiry</span> <span class="n">c2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">c4_inquiry</span> <span class="n">c4</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">c8_inquiry</span> <span class="n">c8</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">c9_inquiry</span> <span class="n">c9</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">inq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;RDAC&quot;</span><span class="p">,</span>
	<span class="s">&quot;AVT&quot;</span><span class="p">,</span>
	<span class="s">&quot;IOSHIP&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lun_state</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;unowned&quot;</span><span class="p">,</span>
	<span class="s">&quot;owned&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rdac_queue_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span>	<span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="n">activate_complete</span>	<span class="n">callback_fn</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">callback_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ctlr_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">list_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">kmpath_rdacd</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * module parameter to enable rdac debug logging.</span>
<span class="cm"> * 2 bits for each type of logging, only two types defined for now</span>
<span class="cm"> * Can be enhanced if required at later point</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rdac_logging</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rdac_logging</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rdac_logging</span><span class="p">,</span> <span class="s">&quot;A bit mask of rdac logging levels, &quot;</span>
		<span class="s">&quot;Default is 1 - failover logging enabled, &quot;</span>
		<span class="s">&quot;set it to 0xF to enable all the logs&quot;</span><span class="p">);</span>

<span class="cp">#define RDAC_LOG_FAILOVER	0</span>
<span class="cp">#define RDAC_LOG_SENSE		2</span>

<span class="cp">#define RDAC_LOG_BITS		2</span>

<span class="cp">#define RDAC_LOG_LEVEL(SHIFT)  \</span>
<span class="cp">	((rdac_logging &gt;&gt; (SHIFT)) &amp; ((1 &lt;&lt; (RDAC_LOG_BITS)) - 1))</span>

<span class="cp">#define RDAC_LOG(SHIFT, sdev, f, arg...) \</span>
<span class="cp">do { \</span>
<span class="cp">	if (unlikely(RDAC_LOG_LEVEL(SHIFT))) \</span>
<span class="cp">		sdev_printk(KERN_INFO, sdev, RDAC_NAME &quot;: &quot; f &quot;\n&quot;, ## arg); \</span>
<span class="cp">} while (0);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="nf">get_rdac_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dh_data</span> <span class="o">*</span><span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_dh_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="nf">get_rdac_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">buflen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
				<span class="s">&quot;get_rdac_req: blk_get_request failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&amp;&amp;</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
				<span class="s">&quot;get_rdac_req: blk_rq_map_kern failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILFAST_DEV</span> <span class="o">|</span> <span class="n">REQ_FAILFAST_TRANSPORT</span> <span class="o">|</span>
			 <span class="n">REQ_FAILFAST_DRIVER</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">RDAC_RETRIES</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">RDAC_TIMEOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="nf">rdac_failover_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_mode_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_queue_data</span> <span class="o">*</span><span class="n">qdata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">lun_table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">use_ms10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rdac_pg_expanded</span> <span class="o">*</span><span class="n">rdac_pg</span><span class="p">;</span>

		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rdac_pg_expanded</span><span class="p">);</span>
		<span class="n">rdac_pg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">mode_select</span><span class="p">.</span><span class="n">expanded</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rdac_pg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
		<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
		<span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">page_code</span> <span class="o">=</span> <span class="n">RDAC_PAGE_CODE_REDUNDANT_CONTROLLER</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">subpage_code</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">page_len</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
		<span class="n">lun_table</span> <span class="o">=</span> <span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">lun_table</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rdac_pg_legacy</span> <span class="o">*</span><span class="n">rdac_pg</span><span class="p">;</span>

		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rdac_pg_legacy</span><span class="p">);</span>
		<span class="n">rdac_pg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">mode_select</span><span class="p">.</span><span class="n">legacy</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rdac_pg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
		<span class="n">common</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
		<span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">page_code</span> <span class="o">=</span> <span class="n">RDAC_PAGE_CODE_REDUNDANT_CONTROLLER</span><span class="p">;</span>
		<span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">page_len</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span>
		<span class="n">lun_table</span> <span class="o">=</span> <span class="n">rdac_pg</span><span class="o">-&gt;</span><span class="n">lun_table</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">rdac_mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RDAC_MODE_TRANSFER_SPECIFIED_LUNS</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">quiescence_timeout</span> <span class="o">=</span> <span class="n">RDAC_QUIESCENCE_TIME</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">rdac_options</span> <span class="o">=</span> <span class="n">RDAC_FORCED_QUIESENCE</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">qdata</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lun_table</span><span class="p">[</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get request for block layer packet command */</span>
	<span class="n">rq</span> <span class="o">=</span> <span class="n">get_rdac_req</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">mode_select</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Prepare the command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">use_ms10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT_10</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_controller</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdac_controller</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rdac_controller</span> <span class="o">*</span><span class="nf">get_controller</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">array_name</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">array_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_controller</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctlr_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">array_id</span><span class="p">,</span> <span class="n">array_id</span><span class="p">,</span> <span class="n">UNIQUE_ID_LEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctlr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* initialize fields of controller */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">array_id</span><span class="p">,</span> <span class="n">array_id</span><span class="p">,</span> <span class="n">UNIQUE_ID_LEN</span><span class="p">);</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">array_name</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">ARRAY_LABEL_LEN</span><span class="p">);</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">use_ms10</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_work</span><span class="p">,</span> <span class="n">send_mode_select</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_head</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctlr_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ctlr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_code</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_RES_TEMP_UNAVAIL</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">get_rdac_req</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">inq</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Prepare the command. */</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INQUIRY</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_code</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">INQUIRY</span><span class="p">);</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_IO</span><span class="p">;</span>

	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_lun_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">array_name</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">array_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c8_inquiry</span> <span class="o">*</span><span class="n">inqp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">submit_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">c8_inquiry</span><span class="p">),</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">inq</span><span class="p">.</span><span class="n">c8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">page_code</span> <span class="o">!=</span> <span class="mh">0xc8</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SCSI_DH_NOSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">page_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;e&#39;</span> <span class="o">||</span> <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">page_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;d&#39;</span> <span class="o">||</span>
		    <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">page_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;i&#39;</span> <span class="o">||</span> <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">page_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;d&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SCSI_DH_NOSYS</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span> <span class="cm">/* Uses only the last byte */</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_LABEL_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">array_name</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">array_user_label</span><span class="p">[(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

		<span class="o">*</span><span class="p">(</span><span class="n">array_name</span><span class="o">+</span><span class="n">ARRAY_LABEL_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">array_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">UNIQUE_ID_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">array_id</span><span class="p">,</span> <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">array_unique_id</span><span class="p">,</span> <span class="n">inqp</span><span class="o">-&gt;</span><span class="n">array_uniq_id_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_ownership</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c9_inquiry</span> <span class="o">*</span><span class="n">inqp</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RDAC_STATE_ACTIVE</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">submit_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">c9_inquiry</span><span class="p">),</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">inq</span><span class="p">.</span><span class="n">c9</span><span class="p">;</span>
		<span class="cm">/* detect the operating mode */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">avte_cvp</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">RDAC_MODE_IOSHIP</span><span class="p">;</span> <span class="cm">/* LUN in IOSHIP mode */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">avte_cvp</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">RDAC_MODE_AVT</span><span class="p">;</span> <span class="cm">/* LUN in AVT mode */</span>
		<span class="k">else</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">RDAC_MODE</span><span class="p">;</span> <span class="cm">/* LUN in RDAC mode */</span>

		<span class="cm">/* Update ownership */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">avte_cvp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">=</span> <span class="n">RDAC_LUN_OWNED</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">=</span> <span class="n">RDAC_LUN_UNOWNED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">RDAC_MODE</span><span class="p">)</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RDAC_STATE_PASSIVE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Update path prio*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">path_prio</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">preferred</span> <span class="o">=</span> <span class="n">RDAC_PREFERRED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">preferred</span> <span class="o">=</span> <span class="n">RDAC_NON_PREFERRED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">initialize_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">array_name</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">array_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c4_inquiry</span> <span class="o">*</span><span class="n">inqp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">submit_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">c4_inquiry</span><span class="p">),</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">inq</span><span class="p">.</span><span class="n">c4</span><span class="p">;</span>
		<span class="cm">/* get the controller index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x31</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">get_controller</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">array_id</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_RES_TEMP_UNAVAIL</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c2_inquiry</span> <span class="o">*</span><span class="n">inqp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">submit_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2_inquiry</span><span class="p">),</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">inq</span><span class="p">.</span><span class="n">c2</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If more than MODE6_MAX_LUN luns are supported, use</span>
<span class="cm">		 * mode select 10</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inqp</span><span class="o">-&gt;</span><span class="n">max_lun_supported</span> <span class="o">&gt;=</span> <span class="n">MODE6_MAX_LUN</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">use_ms10</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">use_ms10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mode_select_handle_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sensebuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="n">sense_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_IO</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_rdac_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_normalize_sense</span><span class="p">(</span><span class="n">sensebuf</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sense_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NO_SENSE</span>:
	<span class="k">case</span> <span class="n">ABORTED_COMMAND</span>:
	<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NOT_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="p">.</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="cm">/* LUN Not Ready and is in the Process of Becoming</span>
<span class="cm">			 * Ready</span>
<span class="cm">			 */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x91</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="p">.</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x36</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Command Lock contention</span>
<span class="cm">			 */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RDAC_LOG</span><span class="p">(</span><span class="n">RDAC_LOG_FAILOVER</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;array %s, ctlr %d, &quot;</span>
		<span class="s">&quot;MODE_SELECT returned with sense %02x/%02x/%02x&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">array_name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		<span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">,</span> <span class="n">sense_hdr</span><span class="p">.</span><span class="n">asc</span><span class="p">,</span> <span class="n">sense_hdr</span><span class="p">.</span><span class="n">ascq</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_controller</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdac_controller</span><span class="p">,</span> <span class="n">ms_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_rdac_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">retry_cnt</span> <span class="o">=</span> <span class="n">RDAC_RETRY_COUNT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_queue_data</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">qdata</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_lock</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_lock</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_RES_TEMP_UNAVAIL</span><span class="p">;</span>
	<span class="n">rq</span> <span class="o">=</span> <span class="n">rdac_failover_get</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">RDAC_LOG</span><span class="p">(</span><span class="n">RDAC_LOG_FAILOVER</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;array %s, ctlr %d, &quot;</span>
		<span class="s">&quot;%s MODE_SELECT command&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">array_name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		<span class="p">(</span><span class="n">retry_cnt</span> <span class="o">==</span> <span class="n">RDAC_RETRY_COUNT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;queueing&quot;</span> <span class="o">:</span> <span class="s">&quot;retrying&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mode_select_handle_sense</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_RETRY</span> <span class="o">&amp;&amp;</span> <span class="n">retry_cnt</span><span class="o">--</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RDAC_STATE_ACTIVE</span><span class="p">;</span>
		<span class="n">RDAC_LOG</span><span class="p">(</span><span class="n">RDAC_LOG_FAILOVER</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;array %s, ctlr %d, &quot;</span>
				<span class="s">&quot;MODE_SELECT completed&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">array_name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">qdata</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
			<span class="n">qdata</span><span class="o">-&gt;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RDAC_STATE_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">callback_fn</span><span class="p">)</span>
			<span class="n">qdata</span><span class="o">-&gt;</span><span class="n">callback_fn</span><span class="p">(</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qdata</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="n">activate_complete</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_queue_data</span> <span class="o">*</span><span class="n">qdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_controller</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>

	<span class="n">qdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_DH_RETRY</span><span class="p">;</span>

	<span class="n">qdata</span><span class="o">-&gt;</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_rdac_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">qdata</span><span class="o">-&gt;</span><span class="n">callback_fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
	<span class="n">qdata</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">qdata</span><span class="o">-&gt;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_queued</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">kmpath_rdacd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SCSI_DH_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdac_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			<span class="n">activate_complete</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_rdac_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_OK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">check_ownership</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RDAC_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">==</span> <span class="n">RDAC_LUN_UNOWNED</span><span class="p">)</span>
			<span class="n">act</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RDAC_MODE_IOSHIP</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">==</span> <span class="n">RDAC_LUN_UNOWNED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">preferred</span> <span class="o">==</span> <span class="n">RDAC_PREFERRED</span><span class="p">))</span>
			<span class="n">act</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">queue_mode_select</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span>
		<span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdac_prep_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_rdac_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">BLKPREP_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RDAC_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BLKPREP_KILL</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdac_check_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="o">*</span><span class="n">sense_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_rdac_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">RDAC_LOG</span><span class="p">(</span><span class="n">RDAC_LOG_SENSE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;array %s, ctlr %d, &quot;</span>
			<span class="s">&quot;I/O returned with sense %02x/%02x/%02x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">array_name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			<span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">,</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span><span class="p">,</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NOT_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="cm">/* LUN Not Ready - Logical Unit Not Ready and is in</span>
<span class="cm">			* the process of becoming ready</span>
<span class="cm">			* Just retry.</span>
<span class="cm">			*/</span>
			<span class="k">return</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x81</span><span class="p">)</span>
			<span class="cm">/* LUN Not Ready - Storage firmware incompatible</span>
<span class="cm">			 * Manual code synchonisation required.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Nothing we can do here. Try to bypass the path.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0xA1</span><span class="p">)</span>
			<span class="cm">/* LUN Not Ready - Quiescense in progress</span>
<span class="cm">			 *</span>
<span class="cm">			 * Just retry and wait.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0xA1</span>  <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="cm">/* LUN Not Ready - Quiescense in progress</span>
<span class="cm">			 * or has been achieved</span>
<span class="cm">			 * Just retry.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x94</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Invalid Request - Current Logical Unit Ownership.</span>
<span class="cm">			 * Controller is not the current owner of the LUN,</span>
<span class="cm">			 * Fail the path, so that the other path be used.</span>
<span class="cm">			 */</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RDAC_STATE_PASSIVE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x29</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Power On, Reset, or Bus Device Reset, just retry.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x8b</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Quiescence in progress , just retry.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* success just means we do not care what scsi-ml does */</span>
	<span class="k">return</span> <span class="n">SCSI_RETURN_NOT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">scsi_dh_devlist</span> <span class="n">rdac_dev_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1722&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1724&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1726&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1742&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1745&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1746&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1814&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1815&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;1818&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;3526&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;TP9400&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;TP9500&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;TP9700&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;IS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;STK&quot;</span><span class="p">,</span> <span class="s">&quot;OPENstorage D280&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;CSM200_R&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;LCSM100_I&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;LCSM100_S&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;LCSM100_E&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;LCSM100_F&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;MD3000&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;MD3000i&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;MD32xx&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;MD32xxi&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;MD36xxi&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;MD36xxf&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;LSI&quot;</span><span class="p">,</span> <span class="s">&quot;INF-01-00&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ENGENIO&quot;</span><span class="p">,</span> <span class="s">&quot;INF-01-00&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;STK&quot;</span><span class="p">,</span> <span class="s">&quot;FLEXLINE 380&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;CSM100_R_FC&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;STK6580_6780&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;SUN_6180&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;ArrayStorage&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rdac_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_tpgs</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rdac_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">rdac_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">rdac_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">rdac_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">rdac_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rdac_bus_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rdac_bus_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_device_handler</span> <span class="n">rdac_dh</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">RDAC_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devlist</span> <span class="o">=</span> <span class="n">rdac_dev_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_fn</span> <span class="o">=</span> <span class="n">rdac_prep_fn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_sense</span> <span class="o">=</span> <span class="n">rdac_check_sense</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">rdac_bus_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span> <span class="o">=</span> <span class="n">rdac_bus_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">rdac_activate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">rdac_match</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdac_bus_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dh_data</span> <span class="o">*</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">array_name</span><span class="p">[</span><span class="n">ARRAY_LABEL_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">array_id</span><span class="p">[</span><span class="n">UNIQUE_ID_LEN</span><span class="p">];</span>

	<span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scsi_dh_data</span><span class="p">)</span>
			       <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_dh_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">RDAC_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">scsi_dh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdac_dh</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">UNINITIALIZED_LUN</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RDAC_STATE_ACTIVE</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_lun_info</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">array_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">initialize_controller</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">array_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">check_ownership</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_ctlr</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">set_mode_select</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_ctlr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clean_ctlr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
		    <span class="s">&quot;%s: LUN %d (%s) (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">RDAC_NAME</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">mode</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">],</span>
		    <span class="n">lun_state</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">clean_ctlr:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">release_controller</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scsi_dh_data</span><span class="p">);</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: not attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">RDAC_NAME</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdac_bus_detach</span><span class="p">(</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dh_data</span> <span class="o">*</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rdac_dh_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ms_queued</span><span class="p">)</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">kmpath_rdacd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">)</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">release_controller</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scsi_dh_data</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Detached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RDAC_NAME</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rdac_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">scsi_register_device_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdac_dh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to register scsi device handler.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create workqueue to handle mode selects for rdac</span>
<span class="cm">	 */</span>
	<span class="n">kmpath_rdacd</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;kmpath_rdacd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kmpath_rdacd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_unregister_device_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdac_dh</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;kmpath_rdacd creation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rdac_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">kmpath_rdacd</span><span class="p">);</span>
	<span class="n">scsi_unregister_device_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdac_dh</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rdac_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rdac_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Multipath LSI/Engenio/NetApp E-Series RDAC driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Christie, Chandra Seetharaman&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;01.00.0000.0000&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
