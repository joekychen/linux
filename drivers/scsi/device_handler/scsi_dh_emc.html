<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › device_handler › scsi_dh_emc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>scsi_dh_emc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Target driver for EMC CLARiiON AX/CX-series hardware.</span>
<span class="cm"> * Based on code from Lars Marowsky-Bree &lt;lmb@suse.de&gt;</span>
<span class="cm"> * and Ed Goggin &lt;egoggin@emc.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (C) 2006 Mike Christie</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#define CLARIION_NAME			&quot;emc&quot;</span>

<span class="cp">#define CLARIION_TRESPASS_PAGE		0x22</span>
<span class="cp">#define CLARIION_BUFFER_SIZE		0xFC</span>
<span class="cp">#define CLARIION_TIMEOUT		(60 * HZ)</span>
<span class="cp">#define CLARIION_RETRIES		3</span>
<span class="cp">#define CLARIION_UNBOUND_LU		-1</span>
<span class="cp">#define CLARIION_SP_A			0</span>
<span class="cp">#define CLARIION_SP_B			1</span>

<span class="cm">/* Flags */</span>
<span class="cp">#define CLARIION_SHORT_TRESPASS		1</span>
<span class="cp">#define CLARIION_HONOR_RESERVATIONS	2</span>

<span class="cm">/* LUN states */</span>
<span class="cp">#define CLARIION_LUN_UNINITIALIZED	-1</span>
<span class="cp">#define CLARIION_LUN_UNBOUND		0</span>
<span class="cp">#define CLARIION_LUN_BOUND		1</span>
<span class="cp">#define CLARIION_LUN_OWNED		2</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">long_trespass</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CLARIION_TRESPASS_PAGE</span><span class="p">,</span>	<span class="cm">/* Page code */</span>
	<span class="mh">0x09</span><span class="p">,</span>			<span class="cm">/* Page length - 2 */</span>
	<span class="mh">0x01</span><span class="p">,</span>			<span class="cm">/* Trespass code */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* Trespass target */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>	<span class="cm">/* Reserved bytes / unknown */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">short_trespass</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CLARIION_TRESPASS_PAGE</span><span class="p">,</span>	<span class="cm">/* Page code */</span>
	<span class="mh">0x02</span><span class="p">,</span>			<span class="cm">/* Page length - 2 */</span>
	<span class="mh">0x01</span><span class="p">,</span>			<span class="cm">/* Trespass code */</span>
	<span class="mh">0xff</span><span class="p">,</span>			<span class="cm">/* Trespass target */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">lun_state</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="s">&quot;not bound&quot;</span><span class="p">,</span>
    <span class="s">&quot;bound&quot;</span><span class="p">,</span>
    <span class="s">&quot;owned&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Flags:</span>
<span class="cm">	 *  CLARIION_SHORT_TRESPASS</span>
<span class="cm">	 * Use short trespass command (FC-series) or the long version</span>
<span class="cm">	 * (default for AX/CX CLARiiON arrays).</span>
<span class="cm">	 *</span>
<span class="cm">	 *  CLARIION_HONOR_RESERVATIONS</span>
<span class="cm">	 * Whether or not (default) to honor SCSI reservations when</span>
<span class="cm">	 * initiating a switch-over.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * I/O buffer for both MODE_SELECT and INQUIRY commands.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">CLARIION_BUFFER_SIZE</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * SCSI sense buffer for commands -- assumes serial issuance</span>
<span class="cm">	 * and completion sequence of all commands for same multipath.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense</span><span class="p">[</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">senselen</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * LUN state</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">lun_state</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * SP Port number</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * which SP (A=0,B=1,UNBOUND=-1) is the default SP for this</span>
<span class="cm">	 * path&#39;s mapped LUN</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">default_sp</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * which SP (A=0,B=1,UNBOUND=-1) is the active SP for this</span>
<span class="cm">	 * path&#39;s mapped LUN</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">current_sp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">clariion_dh_data</span>
			<span class="o">*</span><span class="nf">get_clariion_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dh_data</span> <span class="o">*</span><span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_dh_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse MODE_SELECT cmd reply.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">trespass_endio</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_IO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="n">sshdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_normalize_sense</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sshdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Found valid sense data 0x%2x, &quot;</span>
			    <span class="s">&quot;0x%2x, 0x%2x while sending CLARiiON trespass &quot;</span>
			    <span class="s">&quot;command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">sshdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">,</span>
			    <span class="n">sshdr</span><span class="p">.</span><span class="n">asc</span><span class="p">,</span> <span class="n">sshdr</span><span class="p">.</span><span class="n">ascq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sshdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sshdr</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">sshdr</span><span class="p">.</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Array based copy in progress -- do not send</span>
<span class="cm">			 * mode_select or copy will be aborted mid-stream.</span>
<span class="cm">			 */</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Array Based Copy in &quot;</span>
				    <span class="s">&quot;progress while sending CLARiiON trespass &quot;</span>
				    <span class="s">&quot;command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CLARIION_NAME</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_DEV_TEMP_BUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sshdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sshdr</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sshdr</span><span class="p">.</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * LUN Not Ready - Manual Intervention Required</span>
<span class="cm">			 * indicates in-progress ucode upgrade (NDU).</span>
<span class="cm">			 */</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Detected in-progress &quot;</span>
				    <span class="s">&quot;ucode upgrade NDU operation while sending &quot;</span>
				    <span class="s">&quot;CLARiiON trespass command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CLARIION_NAME</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_DEV_TEMP_BUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_DEV_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: failed to send MODE SELECT, no sense available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_sp_info_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_OK</span><span class="p">;</span>

	<span class="cm">/* check for in-progress ucode upgrade (NDU) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Detected in-progress &quot;</span>
			    <span class="s">&quot;ucode upgrade NDU operation while finding &quot;</span>
			    <span class="s">&quot;current active SP.&quot;</span><span class="p">,</span> <span class="n">CLARIION_NAME</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_DEV_TEMP_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Invalid buffer format */</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: invalid VPD page 0xC0 format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_NOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: ALUA failover mode detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* Linux failover */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: Invalid failover mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_NOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">default_sp</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">current_sp</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define emc_default_str &quot;FC (Legacy)&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">parse_sp_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sp_model</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sp_len</span><span class="p">,</span> <span class="n">serial_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: Invalid information section length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="cm">/* Check for old FC arrays */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;DGC&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Old FC array, not supporting extended information */</span>
			<span class="n">sp_model</span> <span class="o">=</span> <span class="n">emc_default_str</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Parse extended information for SP model number</span>
<span class="cm">	 */</span>
	<span class="n">serial_len</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">160</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">serial_len</span> <span class="o">+</span> <span class="mi">161</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: Invalid array serial number length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">serial_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sp_len</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">99</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">serial_len</span> <span class="o">+</span> <span class="n">sp_len</span> <span class="o">+</span> <span class="mi">161</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: Invalid model number length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">sp_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sp_model</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">serial_len</span> <span class="o">+</span> <span class="mi">161</span><span class="p">];</span>
	<span class="cm">/* Strip whitespace at the end */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sp_len</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sp_model</span><span class="p">[</span><span class="n">sp_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
		<span class="n">sp_len</span><span class="o">--</span><span class="p">;</span>

	<span class="n">sp_model</span><span class="p">[</span><span class="n">sp_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">sp_model</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get block request for REQ_BLOCK_PC command issued to path.  Currently</span>
<span class="cm"> * limited to MODE_SELECT (trespass) and INQUIRY (VPD page 0xC0) commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Uses data and sense buffers in hardware handler context structure and</span>
<span class="cm"> * assumes serial servicing of commands, both issuance and completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="nf">get_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="o">?</span> <span class="n">WRITE</span> <span class="o">:</span> <span class="n">READ</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;get_req: blk_get_request failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MODE_SELECT</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">short_trespass</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT_10</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">long_trespass</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">CLARIION_BUFFER_SIZE</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILFAST_DEV</span> <span class="o">|</span> <span class="n">REQ_FAILFAST_TRANSPORT</span> <span class="o">|</span>
			 <span class="n">REQ_FAILFAST_DRIVER</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">CLARIION_TIMEOUT</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">CLARIION_RETRIES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_inquiry_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">get_req</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">INQUIRY</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_DH_RES_TEMP_UNAVAIL</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">senselen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INQUIRY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;%s: failed to send %s INQUIRY: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">page</span><span class="o">?</span><span class="s">&quot;EVPD&quot;</span><span class="o">:</span><span class="s">&quot;standard&quot;</span><span class="p">,</span>
			    <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
		<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">senselen</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_IO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_trespass_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page22</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLARIION_SHORT_TRESPASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page22</span> <span class="o">=</span> <span class="n">short_trespass</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLARIION_HONOR_RESERVATIONS</span><span class="p">))</span>
			<span class="cm">/* Set Honor Reservations bit */</span>
			<span class="n">page22</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">short_trespass</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">page22</span> <span class="o">=</span> <span class="n">long_trespass</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLARIION_HONOR_RESERVATIONS</span><span class="p">))</span>
			<span class="cm">/* Set Honor Reservations bit */</span>
			<span class="n">page22</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">long_trespass</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">MODE_SELECT_10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">CLARIION_BUFFER_SIZE</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">page22</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">get_req</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_DH_RES_TEMP_UNAVAIL</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">senselen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">trespass_endio</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
				    <span class="s">&quot;%s: failed to send MODE SELECT: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_check_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="o">*</span><span class="n">sense_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NOT_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * LUN Not Ready - Manual Intervention Required</span>
<span class="cm">			 * indicates this is a passive path.</span>
<span class="cm">			 *</span>
<span class="cm">			 * FIXME: However, if this is seen and EVPD C0</span>
<span class="cm">			 * indicates that this is due to a NDU in</span>
<span class="cm">			 * progress, we should set FAIL_PATH too.</span>
<span class="cm">			 * This indicates we might have to do a SCSI</span>
<span class="cm">			 * inquiry in the end_io path. Ugh.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Can return FAILED only when we want the error</span>
<span class="cm">			 * recovery process to kick in.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x25</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * An array based copy is in progress. Do not</span>
<span class="cm">			 * fail the path, do not bypass to another PG,</span>
<span class="cm">			 * do not retry. Fail the IO immediately.</span>
<span class="cm">			 * (Actually this is the same conclusion as in</span>
<span class="cm">			 * the default handler, but lets make sure.)</span>
<span class="cm">			 *</span>
<span class="cm">			 * Can return FAILED only when we want the error</span>
<span class="cm">			 * recovery process to kick in.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x29</span> <span class="o">&amp;&amp;</span> <span class="n">sense_hdr</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Unit Attention Code. This is the first IO</span>
<span class="cm">			 * to the new path, so just retry.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCSI_RETURN_NOT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_prep_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_clariion_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">BLKPREP_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">!=</span> <span class="n">CLARIION_LUN_OWNED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BLKPREP_KILL</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_std_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sp_model</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">send_inquiry_cmd</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span> <span class="o">&amp;&amp;</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">senselen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="n">sshdr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_normalize_sense</span><span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">sshdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: INQUIRY sense code &quot;</span>
				    <span class="s">&quot;%02x/%02x/%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CLARIION_NAME</span><span class="p">,</span>
				    <span class="n">sshdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">,</span> <span class="n">sshdr</span><span class="p">.</span><span class="n">asc</span><span class="p">,</span> <span class="n">sshdr</span><span class="p">.</span><span class="n">ascq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_IO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp_model</span> <span class="o">=</span> <span class="n">parse_sp_model</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_DEV_UNSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FC Series arrays do not support long trespass</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">sp_model</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">sp_model</span><span class="p">,</span> <span class="s">&quot;FC&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLARIION_SHORT_TRESPASS</span><span class="p">;</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
		    <span class="s">&quot;%s: detected Clariion %s, flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">sp_model</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_send_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="n">CLARIION_RETRIES</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">send_inquiry_cmd</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span> <span class="o">&amp;&amp;</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">senselen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="n">sshdr</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_normalize_sense</span><span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">sshdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SCSI_DH_IO</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">clariion_check_sense</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sshdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="n">ADD_TO_MLQUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retry</span><span class="o">--</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: INQUIRY sense code &quot;</span>
			    <span class="s">&quot;%02x/%02x/%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CLARIION_NAME</span><span class="p">,</span>
			      <span class="n">sshdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">,</span> <span class="n">sshdr</span><span class="p">.</span><span class="n">asc</span><span class="p">,</span> <span class="n">sshdr</span><span class="p">.</span><span class="n">ascq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">SCSI_DH_IO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_sp_info_reply</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="n">activate_complete</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span> <span class="o">=</span> <span class="n">get_clariion_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">clariion_send_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">==</span> <span class="n">CLARIION_LUN_OWNED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">send_trespass_cmd</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span><span class="s">&quot;%s: %s trespass command sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CLARIION_NAME</span><span class="p">,</span>
		    <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">CLARIION_SHORT_TRESPASS</span><span class="o">?</span><span class="s">&quot;short&quot;</span><span class="o">:</span><span class="s">&quot;long&quot;</span> <span class="p">);</span>

	<span class="cm">/* Update status */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">clariion_send_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
		    <span class="s">&quot;%s: at SP %c Port %d (%s, default SP %c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">current_sp</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span>
		    <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">lun_state</span><span class="p">[</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">lun_state</span><span class="p">],</span>
		    <span class="n">csdev</span><span class="o">-&gt;</span><span class="n">default_sp</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span>
		<span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * params - parameters in the following format</span>
<span class="cm"> *      &quot;no_of_params\0param1\0param2\0param3\0...\0&quot;</span>
<span class="cm"> *      for example, string for 2 parameters with value 10 and 21</span>
<span class="cm"> *      is specified as &quot;2\010\021\0&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">csdev</span> <span class="o">=</span> <span class="n">get_clariion_data</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">argc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">SCSI_DH_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sscanf</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sscanf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sscanf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hr</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span>
		<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLARIION_SHORT_TRESPASS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLARIION_SHORT_TRESPASS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hr</span><span class="p">)</span>
		<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLARIION_HONOR_RESERVATIONS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLARIION_HONOR_RESERVATIONS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this path is owned, we have to send a trespass command</span>
<span class="cm">	 * with the new parameters. If not, simply return. Next trespass</span>
<span class="cm">	 * command would use the parameters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csdev</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">!=</span> <span class="n">CLARIION_LUN_OWNED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">csdev</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">=</span> <span class="n">CLARIION_LUN_UNINITIALIZED</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">send_trespass_cmd</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Update status */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">clariion_send_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">csdev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">scsi_dh_devlist</span> <span class="n">clariion_dev_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;DGC&quot;</span><span class="p">,</span> <span class="s">&quot;RAID&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DGC&quot;</span><span class="p">,</span> <span class="s">&quot;DISK&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DGC&quot;</span><span class="p">,</span> <span class="s">&quot;VRAID&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">clariion_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_tpgs</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">clariion_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">clariion_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">clariion_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">clariion_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">clariion_dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">clariion_bus_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clariion_bus_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_device_handler</span> <span class="n">clariion_dh</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">CLARIION_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devlist</span>	<span class="o">=</span> <span class="n">clariion_dev_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		<span class="o">=</span> <span class="n">clariion_bus_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detach</span>		<span class="o">=</span> <span class="n">clariion_bus_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_sense</span>	<span class="o">=</span> <span class="n">clariion_check_sense</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">clariion_activate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prep_fn</span>	<span class="o">=</span> <span class="n">clariion_prep_fn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_params</span>	<span class="o">=</span> <span class="n">clariion_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">clariion_match</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clariion_bus_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dh_data</span> <span class="o">*</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scsi_dh_data</span><span class="p">)</span>
			       <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_dh_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Attach failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CLARIION_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">scsi_dh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clariion_dh</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">clariion_dh_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_dh_data</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span> <span class="o">=</span> <span class="n">CLARIION_LUN_UNINITIALIZED</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">default_sp</span> <span class="o">=</span> <span class="n">CLARIION_UNBOUND_LU</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">current_sp</span> <span class="o">=</span> <span class="n">CLARIION_UNBOUND_LU</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">clariion_std_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">clariion_send_inquiry</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">SCSI_DH_OK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
		    <span class="s">&quot;%s: connected to SP %c Port %d (%s, default SP %c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CLARIION_NAME</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">current_sp</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span>
		    <span class="n">h</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">lun_state</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lun_state</span><span class="p">],</span>
		    <span class="n">h</span><span class="o">-&gt;</span><span class="n">default_sp</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scsi_dh_data</span><span class="p">);</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: not attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CLARIION_NAME</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clariion_bus_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dh_data</span> <span class="o">*</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_dh_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: Detached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">CLARIION_NAME</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">scsi_dh_data</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">clariion_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">scsi_register_device_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clariion_dh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to register scsi device handler.&quot;</span><span class="p">,</span>
			<span class="n">CLARIION_NAME</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">clariion_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_unregister_device_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clariion_dh</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">clariion_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">clariion_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EMC CX/AX/FC-family driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Christie &lt;michaelc@cs.wisc.edu&gt;, Chandra Seetharaman &lt;sekharan@us.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
