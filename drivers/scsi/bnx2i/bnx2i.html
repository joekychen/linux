<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bnx2i › bnx2i.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bnx2i.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2i.h: Broadcom NetXtreme II iSCSI driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006 - 2012 Broadcom Corporation</span>
<span class="cm"> * Copyright (c) 2007, 2008 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2007, 2008 Mike Christie</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Anil Veerabhadrappa (anilgv@broadcom.com)</span>
<span class="cm"> * Maintained by: Eddie Wai (eddie.wai@broadcom.com)</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _BNX2I_H_</span>
<span class="cp">#define _BNX2I_H_</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/iscsi_proto.h&gt;</span>
<span class="cp">#include &lt;scsi/libiscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_iscsi.h&gt;</span>

<span class="cp">#include &quot;../../net/ethernet/broadcom/cnic_if.h&quot;</span>
<span class="cp">#include &quot;57xx_iscsi_hsi.h&quot;</span>
<span class="cp">#include &quot;57xx_iscsi_constants.h&quot;</span>

<span class="cp">#define BNX2_ISCSI_DRIVER_NAME		&quot;bnx2i&quot;</span>

<span class="cp">#define BNX2I_MAX_ADAPTERS		8</span>

<span class="cp">#define ISCSI_MAX_CONNS_PER_HBA		128</span>
<span class="cp">#define ISCSI_MAX_SESS_PER_HBA		ISCSI_MAX_CONNS_PER_HBA</span>
<span class="cp">#define ISCSI_MAX_CMDS_PER_SESS		128</span>

<span class="cm">/* Total active commands across all connections supported by devices */</span>
<span class="cp">#define ISCSI_MAX_CMDS_PER_HBA_5708	(28 * (ISCSI_MAX_CMDS_PER_SESS - 1))</span>
<span class="cp">#define ISCSI_MAX_CMDS_PER_HBA_5709	(128 * (ISCSI_MAX_CMDS_PER_SESS - 1))</span>
<span class="cp">#define ISCSI_MAX_CMDS_PER_HBA_57710	(256 * (ISCSI_MAX_CMDS_PER_SESS - 1))</span>

<span class="cp">#define ISCSI_MAX_BDS_PER_CMD		32</span>

<span class="cp">#define MAX_PAGES_PER_CTRL_STRUCT_POOL	8</span>
<span class="cp">#define BNX2I_RESERVED_SLOW_PATH_CMD_SLOTS	4</span>

<span class="cp">#define BNX2I_5771X_DBELL_PAGE_SIZE	128</span>

<span class="cm">/* 5706/08 hardware has limit on maximum buffer size per BD it can handle */</span>
<span class="cp">#define MAX_BD_LENGTH			65535</span>
<span class="cp">#define BD_SPLIT_SIZE			32768</span>

<span class="cm">/* min, max &amp; default values for SQ/RQ/CQ size, configurable via&#39; modparam */</span>
<span class="cp">#define BNX2I_SQ_WQES_MIN		16</span>
<span class="cp">#define BNX2I_570X_SQ_WQES_MAX		128</span>
<span class="cp">#define BNX2I_5770X_SQ_WQES_MAX		512</span>
<span class="cp">#define BNX2I_570X_SQ_WQES_DEFAULT	128</span>
<span class="cp">#define BNX2I_5770X_SQ_WQES_DEFAULT	128</span>

<span class="cp">#define BNX2I_570X_CQ_WQES_MAX 		128</span>
<span class="cp">#define BNX2I_5770X_CQ_WQES_MAX 	512</span>

<span class="cp">#define BNX2I_RQ_WQES_MIN 		16</span>
<span class="cp">#define BNX2I_RQ_WQES_MAX 		32</span>
<span class="cp">#define BNX2I_RQ_WQES_DEFAULT 		16</span>

<span class="cm">/* CCELLs per conn */</span>
<span class="cp">#define BNX2I_CCELLS_MIN		16</span>
<span class="cp">#define BNX2I_CCELLS_MAX		96</span>
<span class="cp">#define BNX2I_CCELLS_DEFAULT		64</span>

<span class="cp">#define ITT_INVALID_SIGNATURE		0xFFFF</span>

<span class="cp">#define ISCSI_CMD_CLEANUP_TIMEOUT	100</span>

<span class="cp">#define BNX2I_CONN_CTX_BUF_SIZE		16384</span>

<span class="cp">#define BNX2I_SQ_WQE_SIZE		64</span>
<span class="cp">#define BNX2I_RQ_WQE_SIZE		256</span>
<span class="cp">#define BNX2I_CQE_SIZE			64</span>

<span class="cp">#define MB_KERNEL_CTX_SHIFT		8</span>
<span class="cp">#define MB_KERNEL_CTX_SIZE		(1 &lt;&lt; MB_KERNEL_CTX_SHIFT)</span>

<span class="cp">#define CTX_SHIFT			7</span>
<span class="cp">#define GET_CID_NUM(cid_addr)		((cid_addr) &gt;&gt; CTX_SHIFT)</span>

<span class="cp">#define CTX_OFFSET 			0x10000</span>
<span class="cp">#define MAX_CID_CNT			0x4000</span>

<span class="cp">#define BNX2I_570X_PAGE_SIZE_DEFAULT	4096</span>

<span class="cm">/* 5709 context registers */</span>
<span class="cp">#define BNX2_MQ_CONFIG2			0x00003d00</span>
<span class="cp">#define BNX2_MQ_CONFIG2_CONT_SZ		(0x7L&lt;&lt;4)</span>
<span class="cp">#define BNX2_MQ_CONFIG2_FIRST_L4L5	(0x1fL&lt;&lt;8)</span>

<span class="cm">/* 57710&#39;s BAR2 is mapped to doorbell registers */</span>
<span class="cp">#define BNX2X_DOORBELL_PCI_BAR		2</span>
<span class="cp">#define BNX2X_MAX_CQS			8</span>

<span class="cp">#define CNIC_ARM_CQE			1</span>
<span class="cp">#define CNIC_ARM_CQE_FP			2</span>
<span class="cp">#define CNIC_DISARM_CQE			0</span>

<span class="cp">#define REG_RD(__hba, offset)				\</span>
<span class="cp">		readl(__hba-&gt;regview + offset)</span>
<span class="cp">#define REG_WR(__hba, offset, val)			\</span>
<span class="cp">		writel(val, __hba-&gt;regview + offset)</span>


<span class="cm">/**</span>
<span class="cm"> * struct generic_pdu_resc - login pdu resource structure</span>
<span class="cm"> *</span>
<span class="cm"> * @req_buf:            driver buffer used to stage payload associated with</span>
<span class="cm"> *                      the login request</span>
<span class="cm"> * @req_dma_addr:       dma address for iscsi login request payload buffer</span>
<span class="cm"> * @req_buf_size:       actual login request payload length</span>
<span class="cm"> * @req_wr_ptr:         pointer into login request buffer when next data is</span>
<span class="cm"> *                      to be written</span>
<span class="cm"> * @resp_hdr:           iscsi header where iscsi login response header is to</span>
<span class="cm"> *                      be recreated</span>
<span class="cm"> * @resp_buf:           buffer to stage login response payload</span>
<span class="cm"> * @resp_dma_addr:      login response payload buffer dma address</span>
<span class="cm"> * @resp_buf_size:      login response paylod length</span>
<span class="cm"> * @resp_wr_ptr:        pointer into login response buffer when next data is</span>
<span class="cm"> *                      to be written</span>
<span class="cm"> * @req_bd_tbl:         iscsi login request payload BD table</span>
<span class="cm"> * @req_bd_dma:         login request BD table dma address</span>
<span class="cm"> * @resp_bd_tbl:        iscsi login response payload BD table</span>
<span class="cm"> * @resp_bd_dma:        login request BD table dma address</span>
<span class="cm"> *</span>
<span class="cm"> * following structure defines buffer info for generic pdus such as iSCSI Login,</span>
<span class="cm"> *	Logout and NOP</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">generic_pdu_resc</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">req_buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">req_dma_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">req_buf_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">req_wr_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="n">resp_hdr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">resp_buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">resp_dma_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resp_buf_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">resp_wr_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">req_bd_tbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">req_bd_dma</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">resp_bd_tbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">resp_bd_dma</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * struct bd_resc_page - tracks DMA&#39;able memory allocated for BD tables</span>
<span class="cm"> *</span>
<span class="cm"> * @link:               list head to link elements</span>
<span class="cm"> * @max_ptrs:           maximun pointers that can be stored in this page</span>
<span class="cm"> * @num_valid:          number of pointer valid in this page</span>
<span class="cm"> * @page:               base addess for page pointer array</span>
<span class="cm"> *</span>
<span class="cm"> * structure to track DMA&#39;able memory allocated for command BD tables</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bd_resc_page</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_ptrs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_valid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">page</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * struct io_bdt - I/O buffer destricptor table</span>
<span class="cm"> *</span>
<span class="cm"> * @bd_tbl:             BD table&#39;s virtual address</span>
<span class="cm"> * @bd_tbl_dma:         BD table&#39;s dma address</span>
<span class="cm"> * @bd_valid:           num valid BD entries</span>
<span class="cm"> *</span>
<span class="cm"> * IO BD table</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">io_bdt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">bd_tbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bd_tbl_dma</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bd_valid</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_cmd - iscsi command structure</span>
<span class="cm"> *</span>
<span class="cm"> * @hdr:                iSCSI header</span>
<span class="cm"> * @conn:               iscsi_conn pointer</span>
<span class="cm"> * @scsi_cmd:           SCSI-ML task pointer corresponding to this iscsi cmd</span>
<span class="cm"> * @sg:                 SG list</span>
<span class="cm"> * @io_tbl:             buffer descriptor (BD) table</span>
<span class="cm"> * @bd_tbl_dma:         buffer descriptor (BD) table&#39;s dma address</span>
<span class="cm"> * @req:                bnx2i specific command request struct</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_bdt</span> <span class="n">io_tbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bd_tbl_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd_request</span> <span class="n">req</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * struct bnx2i_conn - iscsi connection structure</span>
<span class="cm"> *</span>
<span class="cm"> * @cls_conn:              pointer to iscsi cls conn</span>
<span class="cm"> * @hba:                   adapter structure pointer</span>
<span class="cm"> * @iscsi_conn_cid:        iscsi conn id</span>
<span class="cm"> * @fw_cid:                firmware iscsi context id</span>
<span class="cm"> * @ep:                    endpoint structure pointer</span>
<span class="cm"> * @gen_pdu:               login/nopout/logout pdu resources</span>
<span class="cm"> * @violation_notified:    bit mask used to track iscsi error/warning messages</span>
<span class="cm"> *                         already printed out</span>
<span class="cm"> * @work_cnt:              keeps track of the number of outstanding work</span>
<span class="cm"> *</span>
<span class="cm"> * iSCSI connection structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">cmd_cleanup_cmpl</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">iscsi_conn_cid</span><span class="p">;</span>
<span class="cp">#define BNX2I_CID_RESERVED	0x5AFF</span>
	<span class="n">u32</span> <span class="n">fw_cid</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">poll_timer</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Queue Pair (QP) related structure elements.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Buffer for login negotiation process</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">generic_pdu_resc</span> <span class="n">gen_pdu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">violation_notified</span><span class="p">;</span>

	<span class="n">atomic_t</span> <span class="n">work_cnt</span><span class="p">;</span>
<span class="p">};</span>



<span class="cm">/**</span>
<span class="cm"> * struct iscsi_cid_queue - Per adapter iscsi cid queue</span>
<span class="cm"> *</span>
<span class="cm"> * @cid_que_base:           queue base memory</span>
<span class="cm"> * @cid_que:                queue memory pointer</span>
<span class="cm"> * @cid_q_prod_idx:         produce index</span>
<span class="cm"> * @cid_q_cons_idx:         consumer index</span>
<span class="cm"> * @cid_q_max_idx:          max index. used to detect wrap around condition</span>
<span class="cm"> * @cid_free_cnt:           queue size</span>
<span class="cm"> * @conn_cid_tbl:           iscsi cid to conn structure mapping table</span>
<span class="cm"> *</span>
<span class="cm"> * Per adapter iSCSI CID Queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iscsi_cid_queue</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cid_que_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cid_que</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid_q_prod_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid_q_cons_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid_q_max_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid_free_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">**</span><span class="n">conn_cid_tbl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct bnx2i_hba - bnx2i adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * @link:                  list head to link elements</span>
<span class="cm"> * @cnic:                  pointer to cnic device</span>
<span class="cm"> * @pcidev:                pointer to pci dev</span>
<span class="cm"> * @netdev:                pointer to netdev structure</span>
<span class="cm"> * @regview:               mapped PCI register space</span>
<span class="cm"> * @age:                   age, incremented by every recovery</span>
<span class="cm"> * @cnic_dev_type:         cnic device type, 5706/5708/5709/57710</span>
<span class="cm"> * @mail_queue_access:     mailbox queue access mode, applicable to 5709 only</span>
<span class="cm"> * @reg_with_cnic:         indicates whether the device is register with CNIC</span>
<span class="cm"> * @adapter_state:         adapter state, UP, GOING_DOWN, LINK_DOWN</span>
<span class="cm"> * @mtu_supported:         Ethernet MTU supported</span>
<span class="cm"> * @shost:                 scsi host pointer</span>
<span class="cm"> * @max_sqes:              SQ size</span>
<span class="cm"> * @max_rqes:              RQ size</span>
<span class="cm"> * @max_cqes:              CQ size</span>
<span class="cm"> * @num_ccell:             number of command cells per connection</span>
<span class="cm"> * @ofld_conns_active:     active connection list</span>
<span class="cm"> * @eh_wait:               wait queue for the endpoint to shutdown</span>
<span class="cm"> * @max_active_conns:      max offload connections supported by this device</span>
<span class="cm"> * @cid_que:               iscsi cid queue</span>
<span class="cm"> * @ep_rdwr_lock:          read / write lock to synchronize various ep lists</span>
<span class="cm"> * @ep_ofld_list:          connection list for pending offload completion</span>
<span class="cm"> * @ep_active_list:        connection list for active offload endpoints</span>
<span class="cm"> * @ep_destroy_list:       connection list for pending offload completion</span>
<span class="cm"> * @mp_bd_tbl:             BD table to be used with middle path requests</span>
<span class="cm"> * @mp_bd_dma:             DMA address of &#39;mp_bd_tbl&#39; memory buffer</span>
<span class="cm"> * @dummy_buffer:          Dummy buffer to be used with zero length scsicmd reqs</span>
<span class="cm"> * @dummy_buf_dma:         DMA address of &#39;dummy_buffer&#39; memory buffer</span>
<span class="cm"> * @lock:              	   lock to synchonize access to hba structure</span>
<span class="cm"> * @hba_shutdown_tmo:      Timeout value to shutdown each connection</span>
<span class="cm"> * @conn_teardown_tmo:     Timeout value to tear down each connection</span>
<span class="cm"> * @conn_ctx_destroy_tmo:  Timeout value to destroy context of each connection</span>
<span class="cm"> * @pci_did:               PCI device ID</span>
<span class="cm"> * @pci_vid:               PCI vendor ID</span>
<span class="cm"> * @pci_sdid:              PCI subsystem device ID</span>
<span class="cm"> * @pci_svid:              PCI subsystem vendor ID</span>
<span class="cm"> * @pci_func:              PCI function number in system pci tree</span>
<span class="cm"> * @pci_devno:             PCI device number in system pci tree</span>
<span class="cm"> * @num_wqe_sent:          statistic counter, total wqe&#39;s sent</span>
<span class="cm"> * @num_cqe_rcvd:          statistic counter, total cqe&#39;s received</span>
<span class="cm"> * @num_intr_claimed:      statistic counter, total interrupts claimed</span>
<span class="cm"> * @link_changed_count:    statistic counter, num of link change notifications</span>
<span class="cm"> *                         received</span>
<span class="cm"> * @ipaddr_changed_count:  statistic counter, num times IP address changed while</span>
<span class="cm"> *                         at least one connection is offloaded</span>
<span class="cm"> * @num_sess_opened:       statistic counter, total num sessions opened</span>
<span class="cm"> * @num_conn_opened:       statistic counter, total num conns opened on this hba</span>
<span class="cm"> * @ctx_ccell_tasks:       captures number of ccells and tasks supported by</span>
<span class="cm"> *                         currently offloaded connection, used to decode</span>
<span class="cm"> *                         context memory</span>
<span class="cm"> *</span>
<span class="cm"> * Adapter Data Structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regview</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">age</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cnic_dev_type</span><span class="p">;</span>
		<span class="cp">#define BNX2I_NX2_DEV_5706		0x0</span>
		<span class="cp">#define BNX2I_NX2_DEV_5708		0x1</span>
		<span class="cp">#define BNX2I_NX2_DEV_5709		0x2</span>
		<span class="cp">#define BNX2I_NX2_DEV_57710		0x3</span>
	<span class="n">u32</span> <span class="n">mail_queue_access</span><span class="p">;</span>
		<span class="cp">#define BNX2I_MQ_KERNEL_MODE		0x0</span>
		<span class="cp">#define BNX2I_MQ_KERNEL_BYPASS_MODE	0x1</span>
		<span class="cp">#define BNX2I_MQ_BIN_MODE		0x2</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">reg_with_cnic</span><span class="p">;</span>
		<span class="cp">#define BNX2I_CNIC_REGISTERED		1</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">adapter_state</span><span class="p">;</span>
		<span class="cp">#define ADAPTER_STATE_UP		0</span>
		<span class="cp">#define ADAPTER_STATE_GOING_DOWN	1</span>
		<span class="cp">#define ADAPTER_STATE_LINK_DOWN		2</span>
		<span class="cp">#define ADAPTER_STATE_INIT_FAILED	31</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu_supported</span><span class="p">;</span>
		<span class="cp">#define BNX2I_MAX_MTU_SUPPORTED		9000</span>

	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">max_sqes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_rqes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_cqes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_ccell</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ofld_conns_active</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">eh_wait</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">max_active_conns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cid_queue</span> <span class="n">cid_que</span><span class="p">;</span>

	<span class="n">rwlock_t</span> <span class="n">ep_rdwr_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ep_ofld_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ep_active_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ep_destroy_list</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BD table to be used with MP (Middle Path requests.</span>
<span class="cm">	 */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">mp_bd_tbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mp_bd_dma</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dummy_buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dummy_buf_dma</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>	<span class="cm">/* protects hba structure access */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">net_dev_lock</span><span class="p">;</span><span class="cm">/* sync net device access */</span>

	<span class="kt">int</span> <span class="n">hba_shutdown_tmo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conn_teardown_tmo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conn_ctx_destroy_tmo</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * PCI related info.</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">pci_did</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_vid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_sdid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_svid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_devno</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Following are a bunch of statistics useful during development</span>
<span class="cm">	 * and later stage for score boarding.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">num_wqe_sent</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_cqe_rcvd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_intr_claimed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_changed_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ipaddr_changed_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_sess_opened</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_conn_opened</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctx_ccell_tasks</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*******************************************************************************</span>
<span class="cm"> * 	QP [ SQ / RQ / CQ ] info.</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * SQ/RQ/CQ generic structure definition</span>
<span class="cm"> */</span>
<span class="k">struct</span> 	<span class="n">sqe</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">sqe_byte</span><span class="p">[</span><span class="n">BNX2I_SQ_WQE_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> 	<span class="n">rqe</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">rqe_byte</span><span class="p">[</span><span class="n">BNX2I_RQ_WQE_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> 	<span class="n">cqe</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cqe_byte</span><span class="p">[</span><span class="n">BNX2I_CQE_SIZE</span><span class="p">];</span>
<span class="p">};</span>


<span class="k">enum</span> <span class="p">{</span>
<span class="cp">#if defined(__LITTLE_ENDIAN)</span>
	<span class="n">CNIC_EVENT_COAL_INDEX</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">CNIC_SEND_DOORBELL</span>	<span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">CNIC_EVENT_CQ_ARM</span>	<span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="n">CNIC_RECV_DOORBELL</span>	<span class="o">=</span> <span class="mh">0x8</span>
<span class="cp">#elif defined(__BIG_ENDIAN)</span>
	<span class="n">CNIC_EVENT_COAL_INDEX</span>	<span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">CNIC_SEND_DOORBELL</span>	<span class="o">=</span> <span class="mh">0x6</span><span class="p">,</span>
	<span class="n">CNIC_EVENT_CQ_ARM</span>	<span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">CNIC_RECV_DOORBELL</span>	<span class="o">=</span> <span class="mh">0xa</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * CQ DB</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2x_iscsi_cq_pend_cmpl</span> <span class="p">{</span>
	<span class="cm">/* CQ producer, updated by Ustorm */</span>
	<span class="n">u16</span> <span class="n">ustrom_prod</span><span class="p">;</span>
	<span class="cm">/* CQ pending completion counter */</span>
	<span class="n">u16</span> <span class="n">pend_cntr</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">bnx2i_5771x_cq_db</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_iscsi_cq_pend_cmpl</span> <span class="n">qp_pend_cmpl</span><span class="p">[</span><span class="n">BNX2X_MAX_CQS</span><span class="p">];</span>
	<span class="cm">/* CQ pending completion ITT array */</span>
	<span class="n">u16</span> <span class="n">itt</span><span class="p">[</span><span class="n">BNX2X_MAX_CQS</span><span class="p">];</span>
	<span class="cm">/* Cstorm CQ sequence to notify array, updated by driver */</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sqn</span><span class="p">[</span><span class="n">BNX2X_MAX_CQS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="cm">/* 16 byte allignment */</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">bnx2i_5771x_sq_rq_db</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">prod_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved0</span><span class="p">[</span><span class="mi">62</span><span class="p">];</span> <span class="cm">/* Pad structure size to 64 bytes */</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">bnx2i_5771x_dbell_hdr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">header</span><span class="p">;</span>
	<span class="cm">/* 1 for rx doorbell, 0 for tx doorbell */</span>
<span class="cp">#define B577XX_DOORBELL_HDR_RX				(0x1&lt;&lt;0)</span>
<span class="cp">#define B577XX_DOORBELL_HDR_RX_SHIFT			0</span>
	<span class="cm">/* 0 for normal doorbell, 1 for advertise wnd doorbell */</span>
<span class="cp">#define B577XX_DOORBELL_HDR_DB_TYPE			(0x1&lt;&lt;1)</span>
<span class="cp">#define B577XX_DOORBELL_HDR_DB_TYPE_SHIFT		1</span>
	<span class="cm">/* rdma tx only: DPM transaction size specifier (64/128/256/512B) */</span>
<span class="cp">#define B577XX_DOORBELL_HDR_DPM_SIZE			(0x3&lt;&lt;2)</span>
<span class="cp">#define B577XX_DOORBELL_HDR_DPM_SIZE_SHIFT		2</span>
	<span class="cm">/* connection type */</span>
<span class="cp">#define B577XX_DOORBELL_HDR_CONN_TYPE			(0xF&lt;&lt;4)</span>
<span class="cp">#define B577XX_DOORBELL_HDR_CONN_TYPE_SHIFT		4</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bnx2i_5771x_dbell</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_5771x_dbell_hdr</span> <span class="n">dbell</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct qp_info - QP (share queue region) atrributes structure</span>
<span class="cm"> *</span>
<span class="cm"> * @ctx_base:           ioremapped pci register base to access doorbell register</span>
<span class="cm"> *                      pertaining to this offloaded connection</span>
<span class="cm"> * @sq_virt:            virtual address of send queue (SQ) region</span>
<span class="cm"> * @sq_phys:            DMA address of SQ memory region</span>
<span class="cm"> * @sq_mem_size:        SQ size</span>
<span class="cm"> * @sq_prod_qe:         SQ producer entry pointer</span>
<span class="cm"> * @sq_cons_qe:         SQ consumer entry pointer</span>
<span class="cm"> * @sq_first_qe:        virtaul address of first entry in SQ</span>
<span class="cm"> * @sq_last_qe:         virtaul address of last entry in SQ</span>
<span class="cm"> * @sq_prod_idx:        SQ producer index</span>
<span class="cm"> * @sq_cons_idx:        SQ consumer index</span>
<span class="cm"> * @sqe_left:           number sq entry left</span>
<span class="cm"> * @sq_pgtbl_virt:      page table describing buffer consituting SQ region</span>
<span class="cm"> * @sq_pgtbl_phys:      dma address of &#39;sq_pgtbl_virt&#39;</span>
<span class="cm"> * @sq_pgtbl_size:      SQ page table size</span>
<span class="cm"> * @cq_virt:            virtual address of completion queue (CQ) region</span>
<span class="cm"> * @cq_phys:            DMA address of RQ memory region</span>
<span class="cm"> * @cq_mem_size:        CQ size</span>
<span class="cm"> * @cq_prod_qe:         CQ producer entry pointer</span>
<span class="cm"> * @cq_cons_qe:         CQ consumer entry pointer</span>
<span class="cm"> * @cq_first_qe:        virtaul address of first entry in CQ</span>
<span class="cm"> * @cq_last_qe:         virtaul address of last entry in CQ</span>
<span class="cm"> * @cq_prod_idx:        CQ producer index</span>
<span class="cm"> * @cq_cons_idx:        CQ consumer index</span>
<span class="cm"> * @cqe_left:           number cq entry left</span>
<span class="cm"> * @cqe_size:           size of each CQ entry</span>
<span class="cm"> * @cqe_exp_seq_sn:     next expected CQE sequence number</span>
<span class="cm"> * @cq_pgtbl_virt:      page table describing buffer consituting CQ region</span>
<span class="cm"> * @cq_pgtbl_phys:      dma address of &#39;cq_pgtbl_virt&#39;</span>
<span class="cm"> * @cq_pgtbl_size:    	CQ page table size</span>
<span class="cm"> * @rq_virt:            virtual address of receive queue (RQ) region</span>
<span class="cm"> * @rq_phys:            DMA address of RQ memory region</span>
<span class="cm"> * @rq_mem_size:        RQ size</span>
<span class="cm"> * @rq_prod_qe:         RQ producer entry pointer</span>
<span class="cm"> * @rq_cons_qe:         RQ consumer entry pointer</span>
<span class="cm"> * @rq_first_qe:        virtaul address of first entry in RQ</span>
<span class="cm"> * @rq_last_qe:         virtaul address of last entry in RQ</span>
<span class="cm"> * @rq_prod_idx:        RQ producer index</span>
<span class="cm"> * @rq_cons_idx:        RQ consumer index</span>
<span class="cm"> * @rqe_left:           number rq entry left</span>
<span class="cm"> * @rq_pgtbl_virt:      page table describing buffer consituting RQ region</span>
<span class="cm"> * @rq_pgtbl_phys:      dma address of &#39;rq_pgtbl_virt&#39;</span>
<span class="cm"> * @rq_pgtbl_size:      RQ page table size</span>
<span class="cm"> *</span>
<span class="cm"> * queue pair (QP) is a per connection shared data structure which is used</span>
<span class="cm"> *	to send work requests (SQ), receive completion notifications (CQ)</span>
<span class="cm"> *	and receive asynchoronous / scsi sense info (RQ). &#39;qp_info&#39; structure</span>
<span class="cm"> *	below holds queue memory, consumer/producer indexes and page table</span>
<span class="cm"> *	information</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">qp_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctx_base</span><span class="p">;</span>
<span class="cp">#define DPM_TRIGER_TYPE			0x40</span>

<span class="cp">#define BNX2I_570x_QUE_DB_SIZE		0</span>
<span class="cp">#define BNX2I_5771x_QUE_DB_SIZE		16</span>
	<span class="k">struct</span> <span class="n">sqe</span> <span class="o">*</span><span class="n">sq_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">sq_phys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_mem_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sqe</span> <span class="o">*</span><span class="n">sq_prod_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sqe</span> <span class="o">*</span><span class="n">sq_cons_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sqe</span> <span class="o">*</span><span class="n">sq_first_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sqe</span> <span class="o">*</span><span class="n">sq_last_qe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sq_prod_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sq_cons_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sqe_left</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">sq_pgtbl_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">sq_pgtbl_phys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sq_pgtbl_size</span><span class="p">;</span>	<span class="cm">/* set to PAGE_SIZE for 5708 &amp; 5709 */</span>

	<span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cq_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cq_phys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_mem_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cq_prod_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cq_cons_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cq_first_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cq_last_qe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cq_prod_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cq_cons_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_left</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqe_exp_seq_sn</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">cq_pgtbl_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cq_pgtbl_phys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_pgtbl_size</span><span class="p">;</span>	<span class="cm">/* set to PAGE_SIZE for 5708 &amp; 5709 */</span>

	<span class="k">struct</span> <span class="n">rqe</span> <span class="o">*</span><span class="n">rq_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rq_phys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_mem_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rqe</span> <span class="o">*</span><span class="n">rq_prod_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rqe</span> <span class="o">*</span><span class="n">rq_cons_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rqe</span> <span class="o">*</span><span class="n">rq_first_qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rqe</span> <span class="o">*</span><span class="n">rq_last_qe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rq_prod_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rq_cons_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rqe_left</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">rq_pgtbl_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rq_pgtbl_phys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rq_pgtbl_size</span><span class="p">;</span>	<span class="cm">/* set to PAGE_SIZE for 5708 &amp; 5709 */</span>
<span class="p">};</span>



<span class="cm">/*</span>
<span class="cm"> * CID handles</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ep_handles</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">fw_cid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">drv_iscsi_cid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pg_cid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsvd</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">enum</span> <span class="p">{</span>
	<span class="n">EP_STATE_IDLE</span>                   <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">EP_STATE_PG_OFLD_START</span>          <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">EP_STATE_PG_OFLD_COMPL</span>          <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">EP_STATE_OFLD_START</span>             <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">EP_STATE_OFLD_COMPL</span>             <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">EP_STATE_CONNECT_START</span>          <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">EP_STATE_CONNECT_COMPL</span>          <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">EP_STATE_ULP_UPDATE_START</span>       <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">EP_STATE_ULP_UPDATE_COMPL</span>       <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">EP_STATE_DISCONN_START</span>          <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">EP_STATE_DISCONN_COMPL</span>          <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
	<span class="n">EP_STATE_CLEANUP_START</span>          <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
	<span class="n">EP_STATE_CLEANUP_CMPL</span>           <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
	<span class="n">EP_STATE_TCP_FIN_RCVD</span>           <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	<span class="n">EP_STATE_TCP_RST_RCVD</span>           <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="n">EP_STATE_LOGOUT_SENT</span>            <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">EP_STATE_LOGOUT_RESP_RCVD</span>       <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">EP_STATE_PG_OFLD_FAILED</span>         <span class="o">=</span> <span class="mh">0x1000000</span><span class="p">,</span>
	<span class="n">EP_STATE_ULP_UPDATE_FAILED</span>      <span class="o">=</span> <span class="mh">0x2000000</span><span class="p">,</span>
	<span class="n">EP_STATE_CLEANUP_FAILED</span>         <span class="o">=</span> <span class="mh">0x4000000</span><span class="p">,</span>
	<span class="n">EP_STATE_OFLD_FAILED</span>            <span class="o">=</span> <span class="mh">0x8000000</span><span class="p">,</span>
	<span class="n">EP_STATE_CONNECT_FAILED</span>         <span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">EP_STATE_DISCONN_TIMEDOUT</span>       <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
	<span class="n">EP_STATE_OFLD_FAILED_CID_BUSY</span>   <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct bnx2i_endpoint - representation of tcp connection in NX2 world</span>
<span class="cm"> *</span>
<span class="cm"> * @link:               list head to link elements</span>
<span class="cm"> * @hba:                adapter to which this connection belongs</span>
<span class="cm"> * @conn:               iscsi connection this EP is linked to</span>
<span class="cm"> * @cls_ep:             associated iSCSI endpoint pointer</span>
<span class="cm"> * @cm_sk:              cnic sock struct</span>
<span class="cm"> * @hba_age:            age to detect if &#39;iscsid&#39; issues ep_disconnect()</span>
<span class="cm"> *                      after HBA reset is completed by bnx2i/cnic/bnx2</span>
<span class="cm"> *                      modules</span>
<span class="cm"> * @state:              tracks offload connection state machine</span>
<span class="cm"> * @timestamp:          tracks the start time when the ep begins to connect</span>
<span class="cm"> * @num_active_cmds:    tracks the number of outstanding commands for this ep</span>
<span class="cm"> * @ec_shift:           the amount of shift as part of the event coal calc</span>
<span class="cm"> * @qp:                 QP information</span>
<span class="cm"> * @ids:                contains chip allocated *context id* &amp; driver assigned</span>
<span class="cm"> *                      *iscsi cid*</span>
<span class="cm"> * @ofld_timer:         offload timer to detect timeout</span>
<span class="cm"> * @ofld_wait:          wait queue</span>
<span class="cm"> *</span>
<span class="cm"> * Endpoint Structure - equivalent of tcp socket structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">cls_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">cm_sk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hba_age</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">num_active_cmds</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ec_shift</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">qp_info</span> <span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep_handles</span> <span class="n">ids</span><span class="p">;</span>
		<span class="cp">#define ep_iscsi_cid	ids.drv_iscsi_cid</span>
		<span class="cp">#define ep_cid		ids.fw_cid</span>
		<span class="cp">#define ep_pg_cid	ids.pg_cid</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">ofld_timer</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">ofld_wait</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">bnx2i_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cqe</span> <span class="n">cqe</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bnx2i_percpu_s</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">iothread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">work_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">p_work_lock</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* Global variables */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">error_mask1</span><span class="p">,</span> <span class="n">error_mask2</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">u64</span> <span class="n">iscsi_error_mask</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">en_tcp_dack</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_coal_div</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_coal_min</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">bnx2i_scsi_xport_template</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">bnx2i_iscsi_transport</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">cnic_ulp_ops</span> <span class="n">bnx2i_cnic_cb</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sq_size</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rq_size</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">bnx2i_dev_attributes</span><span class="p">[];</span>



<span class="cm">/*</span>
<span class="cm"> * Function Prototypes</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_identify_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_ulp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_ulp_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_start</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_stop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">get_adapter_list_head</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_get_conn_from_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="n">iscsi_cid</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">bnx2i_alloc_ep_pool</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">bnx2i_release_ep_pool</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep_ofld_list_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep_destroy_list_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">bnx2i_find_hba_for_cnic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">bnx2i_alloc_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">bnx2i_free_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">bnx2i_get_rq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">bnx2i_put_rq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">bnx2i_iscsi_unmap_sg_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">bnx2i_drop_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_fw_iscsi_init_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_iscsi_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_iscsi_tmf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_iscsi_text</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_iscsi_scsicmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_iscsi_nopout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unsol</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_iscsi_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_send_cmd_cleanup_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_conn_ofld_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_update_iscsi_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_send_conn_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_alloc_qp_resc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_free_qp_resc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_ep_ofld_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_find_ep_in_ofld_list</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_find_ep_in_destroy_list</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_map_ep_dbell_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_arm_cq_event_coalescing</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u8</span> <span class="n">action</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_hw_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">);</span>

<span class="cm">/* Debug related function prototypes */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_print_pend_cmd_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_print_active_cmd_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_print_xmit_pdu_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bnx2i_print_recv_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_percpu_io_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bnx2i_process_scsi_cmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
