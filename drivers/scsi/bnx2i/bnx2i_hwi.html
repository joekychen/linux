<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bnx2i › bnx2i_hwi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bnx2i_hwi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2i_hwi.c: Broadcom NetXtreme II iSCSI driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006 - 2012 Broadcom Corporation</span>
<span class="cm"> * Copyright (c) 2007, 2008 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2007, 2008 Mike Christie</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Anil Veerabhadrappa (anilgv@broadcom.com)</span>
<span class="cm"> * Maintained by: Eddie Wai (eddie.wai@broadcom.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/libiscsi.h&gt;</span>
<span class="cp">#include &quot;bnx2i.h&quot;</span>

<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_percpu_s</span><span class="p">,</span> <span class="n">bnx2i_percpu</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_get_cid_num - get cid from ep</span>
<span class="cm"> * @ep: 	endpoint pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Only applicable to 57710 family of devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2i_get_cid_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">GET_CID_NUM</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cid</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_adjust_qp_size - Adjust SQ/RQ/CQ size for 57710 device type</span>
<span class="cm"> * @hba: 		Adapter for which adjustments is to be made</span>
<span class="cm"> *</span>
<span class="cm"> * Only applicable to 57710 family of devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_adjust_qp_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">num_elements_per_pg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5706</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5708</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5709</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">))</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span><span class="p">))</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">=</span> <span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust each queue size if the user selection does not</span>
<span class="cm">	 * yield integral num of page buffers</span>
<span class="cm">	 */</span>
	<span class="cm">/* adjust SQ */</span>
	<span class="n">num_elements_per_pg</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">BNX2I_SQ_WQE_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">&lt;</span> <span class="n">num_elements_per_pg</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="n">num_elements_per_pg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">%</span> <span class="n">num_elements_per_pg</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">+</span> <span class="n">num_elements_per_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">num_elements_per_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* adjust CQ */</span>
	<span class="n">num_elements_per_pg</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">BNX2I_CQE_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">&lt;</span> <span class="n">num_elements_per_pg</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">=</span> <span class="n">num_elements_per_pg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">%</span> <span class="n">num_elements_per_pg</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">=</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">+</span> <span class="n">num_elements_per_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">num_elements_per_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* adjust RQ */</span>
	<span class="n">num_elements_per_pg</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">BNX2I_RQ_WQE_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">&lt;</span> <span class="n">num_elements_per_pg</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">=</span> <span class="n">num_elements_per_pg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">%</span> <span class="n">num_elements_per_pg</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">=</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">+</span> <span class="n">num_elements_per_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">num_elements_per_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_get_link_state - get network interface link state</span>
<span class="cm"> * @hba:	adapter instance pointer</span>
<span class="cm"> *</span>
<span class="cm"> * updates adapter structure flag based on netdev state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_get_link_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__LINK_STATE_NOCARRIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_iscsi_license_error - displays iscsi license related error message</span>
<span class="cm"> * @hba:		adapter instance pointer</span>
<span class="cm"> * @error_code:		error classification</span>
<span class="cm"> *</span>
<span class="cm"> * Puts out an error log when driver is unable to offload iscsi connection</span>
<span class="cm"> *	due to license restrictions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_iscsi_license_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_ISCSI_NOT_SUPPORTED</span><span class="p">)</span>
		<span class="cm">/* iSCSI offload not supported on this device */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bnx2i: iSCSI not supported, dev=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_LOM_ISCSI_NOT_ENABLED</span><span class="p">)</span>
		<span class="cm">/* iSCSI offload not supported on this LOM device */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bnx2i: LOM is not enable to &quot;</span>
				<span class="s">&quot;offload iSCSI connections, dev=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_INIT_FAILED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_arm_cq_event_coalescing - arms CQ to enable EQ notification</span>
<span class="cm"> * @ep:		endpoint (transport indentifier) structure</span>
<span class="cm"> * @action:	action, ARM or DISARM. For now only ARM_CQE is used</span>
<span class="cm"> *</span>
<span class="cm"> * Arm&#39;ing CQ will enable chip to generate global EQ events inorder to interrupt</span>
<span class="cm"> *	the driver. EQ event is generated CQ index is hit or at least 1 CQ is</span>
<span class="cm"> *	outstanding and on chip timer expires</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_arm_cq_event_coalescing</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u8</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_5771x_cq_db</span> <span class="o">*</span><span class="n">cq_db</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cq_index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_active_cmds</span><span class="p">;</span>

	<span class="cm">/* Coalesce CQ entries only on 10G devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Do not update CQ DB multiple times before firmware writes</span>
<span class="cm">	 * &#39;0xFFFF&#39; to CQDB-&gt;SQN field. Deviation may cause spurious</span>
<span class="cm">	 * interrupts and other unwanted results</span>
<span class="cm">	 */</span>
	<span class="n">cq_db</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_5771x_cq_db</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">CNIC_ARM_CQE_FP</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq_db</span><span class="o">-&gt;</span><span class="n">sqn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">cq_db</span><span class="o">-&gt;</span><span class="n">sqn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">CNIC_ARM_CQE</span> <span class="o">||</span> <span class="n">action</span> <span class="o">==</span> <span class="n">CNIC_ARM_CQE_FP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_active_cmds</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_active_cmds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_active_cmds</span> <span class="o">&lt;=</span> <span class="n">event_coal_min</span><span class="p">)</span>
			<span class="n">next_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">next_index</span> <span class="o">=</span> <span class="n">num_active_cmds</span> <span class="o">&gt;&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ec_shift</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_index</span> <span class="o">&gt;</span> <span class="n">num_active_cmds</span> <span class="o">-</span> <span class="n">event_coal_min</span><span class="p">)</span>
				<span class="n">next_index</span> <span class="o">=</span> <span class="n">num_active_cmds</span> <span class="o">-</span> <span class="n">event_coal_min</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_index</span><span class="p">)</span>
			<span class="n">next_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cq_index</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cqe_exp_seq_sn</span> <span class="o">+</span> <span class="n">next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq_index</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cqe_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">cq_index</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cqe_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq_index</span><span class="p">)</span>
			<span class="n">cq_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">cq_db</span><span class="o">-&gt;</span><span class="n">sqn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cq_index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">next_index</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_get_rq_buf - copy RQ buffer contents to driver buffer</span>
<span class="cm"> * @conn:		iscsi connection on which RQ event occurred</span>
<span class="cm"> * @ptr:		driver buffer to which RQ buffer contents is to</span>
<span class="cm"> *			be copied</span>
<span class="cm"> * @len:		length of valid data inside RQ buf</span>
<span class="cm"> *</span>
<span class="cm"> * Copies RQ buffer contents from shared (DMA&#39;able) memory region to</span>
<span class="cm"> *	driver buffer. RQ is used to DMA unsolicitated iscsi pdu&#39;s and</span>
<span class="cm"> *	scsi sense info</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_get_rq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rqe_left</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rqe_left</span><span class="o">--</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_qe</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_qe</span> <span class="o">==</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_last_qe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_qe</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_first_qe</span><span class="p">;</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_qe</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_ring_577xx_doorbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_5771x_dbell</span> <span class="n">dbell</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbell</span><span class="p">));</span>
	<span class="n">dbell</span><span class="p">.</span><span class="n">dbell</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">B577XX_ISCSI_CONNECTION_TYPE</span> <span class="o">&lt;&lt;</span>
			      <span class="n">B577XX_DOORBELL_HDR_CONN_TYPE_SHIFT</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dbell</span><span class="p">);</span>
	<span class="cm">/* TODO : get doorbell register mapping */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_put_rq_buf - Replenish RQ buffer, if required ring on chip doorbell</span>
<span class="cm"> * @conn:	iscsi connection on which event to post</span>
<span class="cm"> * @count:	number of RQ buffer being posted to chip</span>
<span class="cm"> *</span>
<span class="cm"> * No need to ring hardware doorbell for 57710 family of devices</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_put_rq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_5771x_sq_rq_db</span> <span class="o">*</span><span class="n">rq_db</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hi_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rqe_left</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">&amp;=</span> <span class="mh">0x7FFF</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">&gt;</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">%=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hi_bit</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">|=</span> <span class="n">hi_bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rq_db</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_5771x_sq_rq_db</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span><span class="p">;</span>
		<span class="n">rq_db</span><span class="o">-&gt;</span><span class="n">prod_idx</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span><span class="p">;</span>
		<span class="cm">/* no need to ring hardware doorbell for 57710 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span><span class="p">,</span>
		       <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span> <span class="o">+</span> <span class="n">CNIC_RECV_DOORBELL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ring_sq_dbell - Ring SQ doorbell to wake-up the processing engine</span>
<span class="cm"> * @conn: 		iscsi connection to which new SQ entries belong</span>
<span class="cm"> * @count: 		number of SQ WQEs to post</span>
<span class="cm"> *</span>
<span class="cm"> * SQ DB is updated in host memory and TX Doorbell is rung for 57710 family</span>
<span class="cm"> *	of devices. For 5706/5708/5709 new SQ WQE count is written into the</span>
<span class="cm"> *	doorbell register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_ring_sq_dbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_5771x_sq_rq_db</span> <span class="o">*</span><span class="n">sq_db</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_active_cmds</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>	<span class="cm">/* flush SQ WQE memory before the doorbell is rung */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sq_db</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_5771x_sq_rq_db</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">;</span>
		<span class="n">sq_db</span><span class="o">-&gt;</span><span class="n">prod_idx</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_idx</span><span class="p">;</span>
		<span class="n">bnx2i_ring_577xx_doorbell</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span> <span class="o">+</span> <span class="n">CNIC_SEND_DOORBELL</span><span class="p">);</span>

	<span class="n">mmiowb</span><span class="p">();</span> <span class="cm">/* flush posted PCI writes */</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ring_dbell_update_sq_params - update SQ driver parameters</span>
<span class="cm"> * @conn:	iscsi connection to which new SQ entries belong</span>
<span class="cm"> * @count:	number of SQ WQEs to post</span>
<span class="cm"> *</span>
<span class="cm"> * this routine will update SQ driver parameters and ring the doorbell</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span> <span class="o">==</span>
		    <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_last_qe</span><span class="p">)</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span> <span class="o">=</span>
						<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_first_qe</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;=</span>
		    <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_last_qe</span><span class="p">)</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp_cnt</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_last_qe</span> <span class="o">-</span>
				<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_first_qe</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span>
								<span class="p">(</span><span class="n">tmp_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_idx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/* Ring the doorbell */</span>
	<span class="n">bnx2i_ring_sq_dbell</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_idx</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_iscsi_login - post iSCSI login request MP WQE to hardware</span>
<span class="cm"> * @conn:	iscsi connection</span>
<span class="cm"> * @cmd:	driver command structure which is requesting</span>
<span class="cm"> *		a WQE to sent to chip for further processing</span>
<span class="cm"> *</span>
<span class="cm"> * prepare and post an iSCSI Login request WQE to CNIC firmware</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_iscsi_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">bnx2i_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_login_request</span> <span class="o">*</span><span class="n">login_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_login_req</span> <span class="o">*</span><span class="n">login_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dword</span><span class="p">;</span>

	<span class="n">bnx2i_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">login_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_login_req</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">login_wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_login_request</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>

	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">op_attr</span> <span class="o">=</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">version_max</span> <span class="o">=</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">max_version</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">version_min</span> <span class="o">=</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">min_version</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">isid_lo</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">isid_hi</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">isid</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">tsih</span> <span class="o">=</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">tsih</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ISCSI_TASK_TYPE_MPATH</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_LOGIN_REQUEST_TYPE_SHIFT</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">;</span>

	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">exp_stat_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">exp_statsn</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_LOGIN_REQUEST_UPDATE_EXP_STAT_SN</span><span class="p">;</span>

	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">resp_bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_dma</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">resp_bd_list_addr_hi</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">dword</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_LOGIN_REQUEST_NUM_RESP_BDS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf_size</span> <span class="o">&lt;&lt;</span>
		  <span class="n">ISCSI_LOGIN_REQUEST_RESP_BUFFER_LENGTH_SHIFT</span><span class="p">));</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">resp_buffer</span> <span class="o">=</span> <span class="n">dword</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">num_bds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">login_wqe</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_iscsi_tmf - post iSCSI task management request MP WQE to hardware</span>
<span class="cm"> * @conn:	iscsi connection</span>
<span class="cm"> * @mtask:	driver command structure which is requesting</span>
<span class="cm"> *		a WQE to sent to chip for further processing</span>
<span class="cm"> *</span>
<span class="cm"> * prepare and post an iSCSI Login request WQE to CNIC firmware</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_iscsi_tmf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tm</span> <span class="o">*</span><span class="n">tmfabort_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">ref_sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">ctask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">bnx2i_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_tmf_request</span> <span class="o">*</span><span class="n">tmfabort_wqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scsi_lun</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">bnx2i_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">mtask</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">tmfabort_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_tm</span> <span class="o">*</span><span class="p">)</span><span class="n">mtask</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">tmfabort_wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_tmf_request</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>

	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">op_attr</span> <span class="o">=</span> <span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtask</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span> <span class="p">(</span><span class="n">ISCSI_TASK_TYPE_MPATH</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_TM_FUNC_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_TM_FUNC_ABORT_TASK</span>:
	<span class="k">case</span> <span class="n">ISCSI_TM_FUNC_TASK_REASSIGN</span>:
		<span class="n">ctask</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">rtt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctask</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctask</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * the iscsi layer must have completed the cmd while</span>
<span class="cm">			 * was starting up.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Note: In the case of a SCSI cmd timeout, the task&#39;s</span>
<span class="cm">			 *       sc is still active; hence ctask-&gt;sc != 0</span>
<span class="cm">			 *       In this case, the task must be aborted</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ref_sc</span> <span class="o">=</span> <span class="n">ctask</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref_sc</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
			<span class="n">dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">ISCSI_TASK_TYPE_WRITE</span> <span class="o">&lt;&lt;</span>
				 <span class="n">ISCSI_CMD_REQUEST_TYPE_SHIFT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">ISCSI_TASK_TYPE_READ</span> <span class="o">&lt;&lt;</span>
				 <span class="n">ISCSI_CMD_REQUEST_TYPE_SHIFT</span><span class="p">);</span>
		<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">ref_itt</span> <span class="o">=</span> <span class="p">(</span><span class="n">dword</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">rtt</span> <span class="o">&amp;</span> <span class="n">ISCSI_ITT_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">ref_itt</span> <span class="o">=</span> <span class="n">RESERVED_ITT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">scsi_lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span><span class="p">));</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">ref_cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tmfabort_hdr</span><span class="o">-&gt;</span><span class="n">refcmdsn</span><span class="p">);</span>

	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">;</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
				<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">num_bds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmfabort_wqe</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_iscsi_text - post iSCSI text WQE to hardware</span>
<span class="cm"> * @conn:	iscsi connection</span>
<span class="cm"> * @mtask:	driver command structure which is requesting</span>
<span class="cm"> *		a WQE to sent to chip for further processing</span>
<span class="cm"> *</span>
<span class="cm"> * prepare and post an iSCSI Text request WQE to CNIC firmware</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_iscsi_text</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">mtask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">bnx2i_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_text_request</span> <span class="o">*</span><span class="n">text_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_text</span> <span class="o">*</span><span class="n">text_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dword</span><span class="p">;</span>

	<span class="n">bnx2i_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">mtask</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">text_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_text</span> <span class="o">*</span><span class="p">)</span><span class="n">mtask</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">text_wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_text_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">text_wqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_text_request</span><span class="p">));</span>

	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">text_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">op_attr</span> <span class="o">=</span> <span class="n">text_hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">text_hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">);</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">mtask</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ISCSI_TASK_TYPE_MPATH</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_TEXT_REQUEST_TYPE_SHIFT</span><span class="p">);</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">ttt</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">text_hdr</span><span class="o">-&gt;</span><span class="n">ttt</span><span class="p">);</span>

	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">text_hdr</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">);</span>

	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">resp_bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_dma</span><span class="p">;</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">resp_bd_list_addr_hi</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">dword</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_TEXT_REQUEST_NUM_RESP_BDS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf_size</span> <span class="o">&lt;&lt;</span>
		  <span class="n">ISCSI_TEXT_REQUEST_RESP_BUFFER_LENGTH_SHIFT</span><span class="p">));</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">resp_buffer</span> <span class="o">=</span> <span class="n">dword</span><span class="p">;</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span><span class="p">;</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">num_bds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">text_wqe</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_iscsi_scsicmd - post iSCSI scsicmd request WQE to hardware</span>
<span class="cm"> * @conn:	iscsi connection</span>
<span class="cm"> * @cmd:	driver command structure which is requesting</span>
<span class="cm"> *		a WQE to sent to chip for further processing</span>
<span class="cm"> *</span>
<span class="cm"> * prepare and post an iSCSI SCSI-CMD request WQE to CNIC firmware</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_iscsi_scsicmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd_request</span> <span class="o">*</span><span class="n">scsi_cmd_wqe</span><span class="p">;</span>

	<span class="n">scsi_cmd_wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd_request</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">scsi_cmd_wqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd_request</span><span class="p">));</span>
	<span class="n">scsi_cmd_wqe</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_iscsi_nopout - post iSCSI NOPOUT request WQE to hardware</span>
<span class="cm"> * @conn:		iscsi connection</span>
<span class="cm"> * @cmd:		driver command structure which is requesting</span>
<span class="cm"> *			a WQE to sent to chip for further processing</span>
<span class="cm"> * @datap:		payload buffer pointer</span>
<span class="cm"> * @data_len:		payload data length</span>
<span class="cm"> * @unsol:		indicated whether nopout pdu is unsolicited pdu or</span>
<span class="cm"> *			in response to target&#39;s NOPIN w/ TTT != FFFFFFFF</span>
<span class="cm"> *</span>
<span class="cm"> * prepare and post a nopout request WQE to CNIC firmware</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_iscsi_nopout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unsol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">bnx2i_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_nop_out_request</span> <span class="o">*</span><span class="n">nopout_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_nopout</span> <span class="o">*</span><span class="n">nopout_hdr</span><span class="p">;</span>

	<span class="n">bnx2i_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">nopout_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_nopout</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">nopout_wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_nop_out_request</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">nopout_wqe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_nop_out_request</span><span class="p">));</span>

	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">nopout_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">op_attr</span> <span class="o">=</span> <span class="n">ISCSI_FLAG_CMD_FINAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nopout_hdr</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="cm">/* 57710 requires LUN field to be swapped */</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">ISCSI_TASK_TYPE_MPATH</span> <span class="o">&lt;&lt;</span>
			    <span class="n">ISCSI_TMF_REQUEST_TYPE_SHIFT</span><span class="p">));</span>
	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">ttt</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">nopout_hdr</span><span class="o">-&gt;</span><span class="n">ttt</span><span class="p">);</span>
	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unsol</span><span class="p">)</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_NOP_OUT_REQUEST_LOCAL_COMPLETION</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nopout_hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">==</span> <span class="n">RESERVED_ITT</span><span class="p">)</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_NOP_OUT_REQUEST_LOCAL_COMPLETION</span><span class="p">;</span>

	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">nopout_hdr</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">);</span>
	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* handle payload data, not required in first release */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;NOPOUT: WARNING!! payload len != 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
					<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">;</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">num_bds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nopout_wqe</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_iscsi_logout - post iSCSI logout request WQE to hardware</span>
<span class="cm"> * @conn:	iscsi connection</span>
<span class="cm"> * @cmd:	driver command structure which is requesting</span>
<span class="cm"> *		a WQE to sent to chip for further processing</span>
<span class="cm"> *</span>
<span class="cm"> * prepare and post logout request WQE to CNIC firmware</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_iscsi_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">bnx2i_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_logout_request</span> <span class="o">*</span><span class="n">logout_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_logout</span> <span class="o">*</span><span class="n">logout_hdr</span><span class="p">;</span>

	<span class="n">bnx2i_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">logout_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_logout</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">logout_wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_logout_request</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">logout_wqe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_logout_request</span><span class="p">));</span>

	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">logout_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">logout_hdr</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">);</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">op_attr</span> <span class="o">=</span>
			<span class="n">logout_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|</span> <span class="n">ISCSI_LOGOUT_REQUEST_ALWAYS_ONE</span><span class="p">;</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">ISCSI_TASK_TYPE_MPATH</span> <span class="o">&lt;&lt;</span>
			    <span class="n">ISCSI_LOGOUT_REQUEST_TYPE_SHIFT</span><span class="p">));</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">;</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
				<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">num_bds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">logout_wqe</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_LOGOUT_SENT</span><span class="p">;</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_update_iscsi_conn - post iSCSI logout request WQE to hardware</span>
<span class="cm"> * @conn:	iscsi connection which requires iscsi parameter update</span>
<span class="cm"> *</span>
<span class="cm"> * sends down iSCSI Conn Update request to move iSCSI conn to FFP</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_update_iscsi_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_update</span> <span class="o">*</span><span class="n">update_wqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_update</span> <span class="n">conn_update_kwqe</span><span class="p">;</span>

	<span class="n">update_wqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conn_update_kwqe</span><span class="p">;</span>

	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_UPDATE_CONN</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* 5771x requires conn context id to be passed as is */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">)</span>
		<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">ISCSI_KWQE_CONN_UPDATE_HEADER_DIGEST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span><span class="p">)</span>
		<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">ISCSI_KWQE_CONN_UPDATE_DATA_DIGEST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">initial_r2t_en</span><span class="p">)</span>
		<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">ISCSI_KWQE_CONN_UPDATE_INITIAL_R2T</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">imm_data_en</span><span class="p">)</span>
		<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">|=</span> <span class="n">ISCSI_KWQE_CONN_UPDATE_IMMEDIATE_DATA</span><span class="p">;</span>

	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_send_pdu_length</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_recv_pdu_length</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">first_burst_length</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">first_burst</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_burst_length</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">max_burst</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">exp_stat_sn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">exp_statsn</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_outstanding_r2ts</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">max_r2t</span><span class="p">;</span>
	<span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">session_error_recovery_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">erl</span><span class="p">;</span>
	<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
			  <span class="s">&quot;bnx2i: conn update - MBL 0x%x FBL 0x%x&quot;</span>
			  <span class="s">&quot;MRDSL_I 0x%x MRDSL_T 0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_burst_length</span><span class="p">,</span>
			  <span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">first_burst_length</span><span class="p">,</span>
			  <span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_recv_pdu_length</span><span class="p">,</span>
			  <span class="n">update_wqe</span><span class="o">-&gt;</span><span class="n">max_send_pdu_length</span><span class="p">);</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">update_wqe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_ofld_timer - post iSCSI logout request WQE to hardware</span>
<span class="cm"> * @data:	endpoint (transport handle) structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * routine to handle connection offload/destroy request timeout</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_ep_ofld_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_OFLD_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ofld_timer: CONN_OFLD timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_OFLD_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_DISCONN_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ofld_timer: CONN_DISCON timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_DISCONN_TIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_CLEANUP_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ofld_timer: CONN_CLEANUP timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CLEANUP_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_power_of2</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">power</span><span class="p">;</span>
	<span class="n">val</span><span class="o">--</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">power</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">power</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_cmd_cleanup_req - send iscsi cmd context clean-up request</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @cmd:	driver command structure which is requesting</span>
<span class="cm"> *		a WQE to sent to chip for further processing</span>
<span class="cm"> *</span>
<span class="cm"> * prepares and posts CONN_OFLD_REQ1/2 KWQE</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_send_cmd_cleanup_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cleanup_request</span> <span class="o">*</span><span class="n">cmd_cleanup</span><span class="p">;</span>

	<span class="n">cmd_cleanup</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cleanup_request</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd_cleanup</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cleanup_request</span><span class="p">));</span>

	<span class="n">cmd_cleanup</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_OPCODE_CLEANUP_REQUEST</span><span class="p">;</span>
	<span class="n">cmd_cleanup</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">cmd_cleanup</span><span class="o">-&gt;</span><span class="n">cq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CQ# used for completion, 5771x only */</span>

	<span class="n">bnx2i_ring_dbell_update_sq_params</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_conn_destroy - initiates iscsi connection teardown process</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @ep:		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * this routine prepares and posts CONN_OFLD_REQ1/2 KWQE to initiate</span>
<span class="cm"> * 	iscsi connection context clean-up process</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_conn_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_destroy</span> <span class="n">conn_cleanup</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn_cleanup</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_kwqe_conn_destroy</span><span class="p">));</span>

	<span class="n">conn_cleanup</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_DESTROY_CONN</span><span class="p">;</span>
	<span class="n">conn_cleanup</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>
	<span class="cm">/* 5771x requires conn context id to be passed as is */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">conn_cleanup</span><span class="p">.</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conn_cleanup</span><span class="p">.</span><span class="n">context_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">conn_cleanup</span><span class="p">.</span><span class="n">reserved0</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">conn_cleanup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_570x_send_conn_ofld_req - initiates iscsi conn context setup process</span>
<span class="cm"> * @hba: 		adapter structure pointer</span>
<span class="cm"> * @ep: 		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * 5706/5708/5709 specific - prepares and posts CONN_OFLD_REQ1/2 KWQE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_570x_send_conn_ofld_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_offload1</span> <span class="n">ofld_req1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_offload2</span> <span class="n">ofld_req2</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_OFFLOAD_CONN1</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">iscsi_conn_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">;</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_phys</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">sq_page_table_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">sq_page_table_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_phys</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">cq_page_table_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">cq_page_table_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_OFFLOAD_CONN2</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_phys</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">rq_page_table_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">rq_page_table_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">;</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">sq_first_pte</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">sq_first_pte</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>

	<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">cq_first_pte</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">cq_first_pte</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req1</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req2</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">num_additional_wqes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_5771x_send_conn_ofld_req - initiates iscsi connection context creation</span>
<span class="cm"> * @hba: 		adapter structure pointer</span>
<span class="cm"> * @ep: 		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * 57710 specific - prepares and posts CONN_OFLD_REQ1/2 KWQE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_5771x_send_conn_ofld_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_offload1</span> <span class="n">ofld_req1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_offload2</span> <span class="n">ofld_req2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_conn_offload3</span> <span class="n">ofld_req3</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_OFFLOAD_CONN1</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">iscsi_conn_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">;</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_phys</span> <span class="o">+</span> <span class="n">ISCSI_SQ_DB_SIZE</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">sq_page_table_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">sq_page_table_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_phys</span> <span class="o">+</span> <span class="n">ISCSI_CQ_DB_SIZE</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">cq_page_table_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">cq_page_table_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_OFFLOAD_CONN2</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_phys</span> <span class="o">+</span> <span class="n">ISCSI_RQ_DB_SIZE</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">rq_page_table_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">rq_page_table_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span> <span class="o">+</span> <span class="n">ISCSI_SQ_DB_SIZE</span><span class="p">);</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">sq_first_pte</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">sq_first_pte</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>

	<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span> <span class="o">+</span> <span class="n">ISCSI_CQ_DB_SIZE</span><span class="p">);</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">cq_first_pte</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">cq_first_pte</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req1</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req2</span><span class="p">;</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">num_additional_wqes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ofld_req3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ofld_req3</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span> <span class="o">+</span> <span class="n">ISCSI_RQ_DB_SIZE</span><span class="p">);</span>
	<span class="n">ofld_req3</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qp_first_pte</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qp_first_pte</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">ofld_req3</span><span class="p">;</span>
	<span class="cm">/* need if we decide to go with multiple KCQE&#39;s per conn */</span>
	<span class="n">num_kwqes</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_conn_ofld_req - initiates iscsi connection context setup process</span>
<span class="cm"> *</span>
<span class="cm"> * @hba: 		adapter structure pointer</span>
<span class="cm"> * @ep: 		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * this routine prepares and posts CONN_OFLD_REQ1/2 KWQE</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_conn_ofld_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_5771x_send_conn_ofld_req</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_570x_send_conn_ofld_req</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * setup_qp_page_tables - iscsi QP page table setup function</span>
<span class="cm"> * @ep:		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * Sets up page tables for SQ/RQ/CQ, 1G/sec (5706/5708/5709) devices requires</span>
<span class="cm"> * 	64-bit address in big endian format. Whereas 10G/sec (57710) requires</span>
<span class="cm"> * 	PT in little endian format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_qp_page_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnic_dev_10g</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">cnic_dev_10g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cnic_dev_10g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* SQ page table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span><span class="p">);</span>
	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_phys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span>
		<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span> <span class="o">+</span> <span class="n">ISCSI_SQ_DB_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num_pages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PTE is written in little endian format for 57710 */</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* PTE is written in big endian format for</span>
<span class="cm">			 * 5706/5708/5709 devices */</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* RQ page table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span><span class="p">);</span>
	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_phys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span>
		<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span> <span class="o">+</span> <span class="n">ISCSI_RQ_DB_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num_pages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PTE is written in little endian format for 57710 */</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* PTE is written in big endian format for</span>
<span class="cm">			 * 5706/5708/5709 devices */</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* CQ page table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span><span class="p">);</span>
	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_phys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span>
		<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span> <span class="o">+</span> <span class="n">ISCSI_CQ_DB_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num_pages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PTE is written in little endian format for 57710 */</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* PTE is written in big endian format for</span>
<span class="cm">			 * 5706/5708/5709 devices */</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">page</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ptbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_alloc_qp_resc - allocates required resources for QP.</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @ep:		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate QP (transport layer for iSCSI connection) resources, DMA&#39;able</span>
<span class="cm"> *	memory for SQ/RQ/CQ and page tables. EP structure elements such</span>
<span class="cm"> *	as producer/consumer indexes/pointers, queue sizes and page table</span>
<span class="cm"> *	contents are setup</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_alloc_qp_resc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_5771x_cq_db</span> <span class="o">*</span><span class="n">cq_db</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pg_cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate page table memory for SQ which is page aligned */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">*</span> <span class="n">BNX2I_SQ_WQE_SIZE</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unable to alloc SQ PT mem (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory area for actual SQ element */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unable to alloc SQ BD memory %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_first_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_first_qe</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_cons_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_first_qe</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_last_qe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_first_qe</span><span class="p">[</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sqe_left</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">;</span>

	<span class="cm">/* Allocate page table memory for CQ which is page aligned */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">*</span> <span class="n">BNX2I_CQE_SIZE</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unable to alloc CQ PT memory %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory area for actual CQ element */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unable to alloc CQ BD memory %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_first_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_prod_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_first_qe</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_cons_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_first_qe</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_last_qe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_first_qe</span><span class="p">[</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cqe_left</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cqe_exp_seq_sn</span> <span class="o">=</span> <span class="n">ISCSI_INITIAL_SN</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cqe_size</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span><span class="p">;</span>

	<span class="cm">/* Invalidate all EQ CQE index, req only for 57710 */</span>
	<span class="n">cq_db</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_5771x_cq_db</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cq_db</span><span class="o">-&gt;</span><span class="n">sqn</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cq_db</span><span class="o">-&gt;</span><span class="n">sqn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">BNX2X_MAX_CQS</span><span class="p">);</span>

	<span class="cm">/* Allocate page table memory for RQ which is page aligned */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">*</span> <span class="n">BNX2I_RQ_WQE_SIZE</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unable to alloc RQ PT mem %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory area for actual RQ element */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_virt</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unable to alloc RQ BD memory %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_first_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_virt</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_first_qe</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_qe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_first_qe</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_last_qe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_first_qe</span><span class="p">[</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_prod_idx</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rqe_left</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span><span class="p">;</span>

	<span class="n">setup_qp_page_tables</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">mem_alloc_err:</span>
	<span class="n">bnx2i_free_qp_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * bnx2i_free_qp_resc - free memory resources held by QP</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @ep:	endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * Free QP resources - SQ/RQ/CQ memory and page tables.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_free_qp_resc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Free SQ mem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_size</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_phys</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_pgtbl_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_mem_size</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_phys</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">sq_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free RQ mem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_size</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_phys</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_pgtbl_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_mem_size</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_virt</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_phys</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">rq_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free CQ mem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_size</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_phys</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_pgtbl_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_mem_size</span><span class="p">,</span>
				  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_phys</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">cq_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_send_fw_iscsi_init_msg - initiates initial handshake with iscsi f/w</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Send down iscsi_init KWQEs which initiates the initial handshake with the f/w</span>
<span class="cm"> * 	This results in iSCSi support validation and on-chip context manager</span>
<span class="cm"> * 	initialization.  Firmware completes this handshake with a CQE carrying</span>
<span class="cm"> * 	the result of iscsi support validation. Parameter carried by</span>
<span class="cm"> * 	iscsi init request determines the number of offloaded connection and</span>
<span class="cm"> * 	tolerance level for iscsi protocol violation this hba/chip can support</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_send_fw_iscsi_init_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_init1</span> <span class="n">iscsi_init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_kwqe_init2</span> <span class="n">iscsi_init2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask64</span><span class="p">;</span>

	<span class="n">bnx2i_adjust_qp_size</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>

	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="n">ISCSI_PAGE_SIZE_4K</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_INIT1_PAGE_SIZE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en_tcp_dack</span><span class="p">)</span>
		<span class="n">iscsi_init</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISCSI_KWQE_INIT1_DELAYED_ACK_ENABLE</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">reserved0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">num_cqs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_INIT1</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">dummy_buffer_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">dummy_buffer_addr_hi</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ccell</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">ctx_ccell_tasks</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ccell</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">num_ccells_per_conn</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ccell</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">num_tasks_per_conn</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">sq_wqes_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">BNX2I_SQ_WQE_SIZE</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">sq_num_wqes</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">cq_log_wqes_per_page</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">bnx2i_power_of2</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">BNX2I_CQE_SIZE</span><span class="p">);</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">cq_num_wqes</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">cq_num_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">*</span> <span class="n">BNX2I_CQE_SIZE</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">sq_num_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">*</span> <span class="n">BNX2I_SQ_WQE_SIZE</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">rq_buffer_size</span> <span class="o">=</span> <span class="n">BNX2I_RQ_WQE_SIZE</span><span class="p">;</span>
	<span class="n">iscsi_init</span><span class="p">.</span><span class="n">rq_num_wqes</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span><span class="p">;</span>


	<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_KWQE_OPCODE_INIT2</span><span class="p">;</span>
	<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ISCSI_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>
	<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">max_cq_sqn</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mask64</span> <span class="o">=</span> <span class="mh">0x0ULL</span><span class="p">;</span>
	<span class="n">mask64</span> <span class="o">|=</span> <span class="p">(</span>
		<span class="cm">/* CISCO MDS */</span>
		<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span>
		  <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_TTT_NOT_RSRV</span><span class="p">)</span> <span class="o">|</span>
		<span class="cm">/* HP MSA1510i */</span>
		<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span>
		  <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_EXP_DATASN</span><span class="p">)</span> <span class="o">|</span>
		<span class="cm">/* EMC */</span>
		<span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_LUN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_mask1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">error_bit_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_mask1</span><span class="p">;</span>
		<span class="n">mask64</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">~</span><span class="n">mask64</span><span class="p">);</span>
		<span class="n">mask64</span> <span class="o">|=</span> <span class="n">error_mask1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">error_bit_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">mask64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error_mask2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">error_bit_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_mask2</span><span class="p">;</span>
		<span class="n">mask64</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">mask64</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">error_mask2</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">iscsi_init2</span><span class="p">.</span><span class="n">error_bit_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">mask64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">iscsi_error_mask</span> <span class="o">=</span> <span class="n">mask64</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">iscsi_init</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">iscsi_init2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_scsi_cmd_resp - this function handles scsi cmd completion.</span>
<span class="cm"> * @session:	iscsi session</span>
<span class="cm"> * @bnx2i_conn:	bnx2i connection</span>
<span class="cm"> * @cqe:	pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process SCSI CMD Response CQE &amp; complete the request to SCSI-ML</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_process_scsi_cmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd_response</span> <span class="o">*</span><span class="n">resp_cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">bnx2i_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_scsi_rsp</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">resp_cqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd_response</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
				 <span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_CMD_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">bnx2i_cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">op_attr</span> <span class="o">&amp;</span> <span class="n">ISCSI_CMD_REQUEST_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">datain_pdus_cnt</span> <span class="o">+=</span>
			<span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">task_stat</span><span class="p">.</span><span class="n">read_stat</span><span class="p">.</span><span class="n">num_data_outs</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">+=</span>
			<span class="n">bnx2i_cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">total_data_transfer_length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">dataout_pdus_cnt</span> <span class="o">+=</span>
			<span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">task_stat</span><span class="p">.</span><span class="n">read_stat</span><span class="p">.</span><span class="n">num_data_outs</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">r2t_pdus_cnt</span> <span class="o">+=</span>
			<span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">task_stat</span><span class="p">.</span><span class="n">read_stat</span><span class="p">.</span><span class="n">num_r2ts</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">txdata_octets</span> <span class="o">+=</span>
			<span class="n">bnx2i_cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">total_data_transfer_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2i_iscsi_unmap_sg_list</span><span class="p">(</span><span class="n">bnx2i_cmd</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_scsi_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">resp_cqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd_response</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">response_flags</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">residual_count</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">residual_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_OP_SCSI_DATA_IN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">resp_cqe</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">BNX2I_RQ_WQE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
					  <span class="s">&quot;sense data len %d &gt; RQ sz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">datalen</span><span class="p">);</span>
			<span class="n">datalen</span> <span class="o">=</span> <span class="n">BNX2I_RQ_WQE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
					  <span class="s">&quot;sense data len %d &gt; conn data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">datalen</span><span class="p">);</span>
			<span class="n">datalen</span> <span class="o">=</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bnx2i_get_rq_buf</span><span class="p">(</span><span class="n">bnx2i_cmd</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
		<span class="n">bnx2i_put_rq_buf</span><span class="p">(</span><span class="n">bnx2i_cmd</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span>
			     <span class="n">conn</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_login_resp - this function handles iscsi login response</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process Login Response CQE &amp; complete it to open-iscsi user daemon</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_process_login_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_login_response</span> <span class="o">*</span><span class="n">login</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_login_rsp</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pld_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pad_len</span><span class="p">;</span>

	<span class="n">login</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_login_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
				 <span class="n">login</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_LOGIN_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">resp_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_login_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">response_flags</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">max_version</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">version_max</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">active_version</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">version_active</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">hlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hton24</span><span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">,</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">login</span><span class="o">-&gt;</span><span class="n">isid_lo</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">tsih</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">login</span><span class="o">-&gt;</span><span class="n">tsih</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">statsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">login</span><span class="o">-&gt;</span><span class="n">stat_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">login</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">login</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">status_class</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">status_class</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">status_detail</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">status_detail</span><span class="p">;</span>
	<span class="n">pld_len</span> <span class="o">=</span> <span class="n">login</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span> <span class="o">=</span>
					<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span> <span class="o">+</span> <span class="n">pld_len</span><span class="p">;</span>

	<span class="n">pad_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pld_len</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="n">pad_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">pld_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pad_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pad_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">resp_hdr</span><span class="p">,</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">,</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span> <span class="o">-</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_text_resp - this function handles iscsi text response</span>
<span class="cm"> * @session:	iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:	iscsi connection pointer</span>
<span class="cm"> * @cqe:	pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI Text Response CQE&amp;  complete it to open-iscsi user daemon</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_process_text_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_text_response</span> <span class="o">*</span><span class="n">text</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_text_rsp</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pld_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pad_len</span><span class="p">;</span>

	<span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_text_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">text</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_LOGIN_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">resp_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_text_rsp</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">text</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">text</span><span class="o">-&gt;</span><span class="n">response_flags</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">hlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hton24</span><span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">,</span> <span class="n">text</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">ttt</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">text</span><span class="o">-&gt;</span><span class="n">ttt</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">statsn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_statsn</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">text</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">text</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>
	<span class="n">pld_len</span> <span class="o">=</span> <span class="n">text</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span> <span class="o">+</span>
					  <span class="n">pld_len</span><span class="p">;</span>
	<span class="n">pad_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pld_len</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="n">pad_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">pld_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pad_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pad_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">resp_hdr</span><span class="p">,</span>
			     <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">,</span>
			     <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span> <span class="o">-</span>
			     <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_tmf_resp - this function handles iscsi TMF response</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI TMF Response CQE and wake up the driver eh thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_process_tmf_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_tmf_response</span> <span class="o">*</span><span class="n">tmf_cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tm_rsp</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">;</span>

	<span class="n">tmf_cqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_tmf_response</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
				 <span class="n">tmf_cqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_TMF_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">resp_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_tm_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">tmf_cqe</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmf_cqe</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmf_cqe</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="n">tmf_cqe</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>

	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_logout_resp - this function handles iscsi logout response</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI Logout Response CQE &amp; make function call to</span>
<span class="cm"> * notify the user daemon.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_process_logout_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_logout_response</span> <span class="o">*</span><span class="n">logout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_logout_rsp</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">;</span>

	<span class="n">logout</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_logout_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
				 <span class="n">logout</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_LOGOUT_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">resp_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_logout_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">logout</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">logout</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">hlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">statsn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_statsn</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">logout</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">logout</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>

	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">t2wait</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">logout</span><span class="o">-&gt;</span><span class="n">time_to_wait</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">t2retain</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">logout</span><span class="o">-&gt;</span><span class="n">time_to_retain</span><span class="p">);</span>

	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_LOGOUT_RESP_RCVD</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_nopin_local_cmpl - this function handles iscsi nopin CQE</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI NOPIN local completion CQE, frees IIT and command structures</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_nopin_local_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="n">nop_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="n">nop_in</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
				 <span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_NOP_IN_MSG_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span>
		<span class="n">__iscsi_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_unsol_pdu_adjust_rq - makes adjustments to RQ after unsol pdu is recvd</span>
<span class="cm"> * @conn:	iscsi connection</span>
<span class="cm"> *</span>
<span class="cm"> * Firmware advances RQ producer index for every unsolicited PDU even if</span>
<span class="cm"> *	payload data length is &#39;0&#39;. This function makes corresponding</span>
<span class="cm"> *	adjustments on the driver side to match this f/w behavior</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_unsol_pdu_adjust_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dummy_rq_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">bnx2i_get_rq_buf</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">dummy_rq_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bnx2i_put_rq_buf</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_nopin_mesg - this function handles iscsi nopin CQE</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI target&#39;s proactive iSCSI NOPIN request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_process_nopin_mesg</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="n">nop_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_nopin</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt_async_nop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nop_in</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_nopin</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ttt</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">ttt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">RESERVED_ITT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_unsol_pdu_adjust_rq</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">RESERVED_ITT</span><span class="p">;</span>
		<span class="n">tgt_async_nop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this is a response to one of our nop-outs */</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">itt_t</span><span class="p">)</span> <span class="p">(</span><span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_NOP_IN_MSG_INDEX</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_FLAG_CMD_FINAL</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ttt</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">ttt</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">nop_in</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tgt_async_nop</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_async_mesg - this function handles iscsi async message</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI ASYNC Message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_async_mesg</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_async_msg</span> <span class="o">*</span><span class="n">async_cqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_async</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">async_event</span><span class="p">;</span>

	<span class="n">bnx2i_unsol_pdu_adjust_rq</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>

	<span class="n">async_cqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_async_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">async_event</span> <span class="o">=</span> <span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">async_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async_event</span> <span class="o">==</span> <span class="n">ISCSI_ASYNC_MSG_SCSI_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				  <span class="s">&quot;async: scsi events not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">resp_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_async</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>

	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">async_event</span> <span class="o">=</span> <span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">async_event</span><span class="p">;</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">async_vcode</span> <span class="o">=</span> <span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">async_vcode</span><span class="p">;</span>

	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">param2</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">param2</span><span class="p">);</span>
	<span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">param3</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">async_cqe</span><span class="o">-&gt;</span><span class="n">param3</span><span class="p">);</span>

	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
			     <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">resp_hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_reject_mesg - process iscsi reject pdu</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process iSCSI REJECT message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_reject_mesg</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_reject_msg</span> <span class="o">*</span><span class="n">reject</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_reject</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">reject</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_reject_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reject</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_get_rq_buf</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">reject</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
		<span class="n">bnx2i_put_rq_buf</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bnx2i_unsol_pdu_adjust_rq</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_reject</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_hdr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">reject</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reject</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">,</span> <span class="n">reject</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">reject</span><span class="o">-&gt;</span><span class="n">max_cmd_sn</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">reject</span><span class="o">-&gt;</span><span class="n">exp_cmd_sn</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ffffffff</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">RESERVED_ITT</span><span class="p">);</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			     <span class="n">reject</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_cmd_cleanup_resp - process scsi command clean-up completion</span>
<span class="cm"> * @session:		iscsi session pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> * @cqe:		pointer to newly DMA&#39;ed CQE entry for processing</span>
<span class="cm"> *</span>
<span class="cm"> * process command cleanup response CQE during conn shutdown or error recovery</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_cmd_cleanup_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cleanup_response</span> <span class="o">*</span><span class="n">cmd_clean_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="n">cmd_clean_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cleanup_response</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
			<span class="n">cmd_clean_rsp</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_CLEANUP_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: cmd clean ITT %x not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd_clean_rsp</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_CLEANUP_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cmd_cleanup_cmpl</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_percpu_io_thread - thread per cpu for ios</span>
<span class="cm"> *</span>
<span class="cm"> * @arg:	ptr to bnx2i_percpu_info structure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_percpu_io_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_percpu_s</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_work</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work_list</span><span class="p">);</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>

			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="cm">/* work allocated in the bh, freed here */</span>
				<span class="n">bnx2i_process_scsi_cmd_resp</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">,</span>
							    <span class="n">work</span><span class="o">-&gt;</span><span class="n">bnx2i_conn</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">work_cnt</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_queue_scsi_cmd_resp - queue cmd completion to the percpu thread</span>
<span class="cm"> * @bnx2i_conn:		bnx2i connection</span>
<span class="cm"> *</span>
<span class="cm"> * this function is called by generic KCQ handler to queue all pending cmd</span>
<span class="cm"> * completion CQEs</span>
<span class="cm"> *</span>
<span class="cm"> * The implementation is to queue the cmd response based on the</span>
<span class="cm"> * last recorded command for the given connection.  The</span>
<span class="cm"> * cpu_id gets recorded upon task_xmit.  No out-of-order completion!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_queue_scsi_cmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="n">cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_work</span> <span class="o">*</span><span class="n">bnx2i_work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_percpu_s</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				 <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">&amp;</span> <span class="n">ISCSI_CMD_RESPONSE_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span> <span class="o">||</span> <span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_rq_cpu_valid</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bnx2i_percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iothread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Alloc and copy to the cqe */</span>
	<span class="n">bnx2i_work</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">bnx2i_work</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
		<span class="n">bnx2i_work</span><span class="o">-&gt;</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_work</span><span class="o">-&gt;</span><span class="n">cqe</span><span class="p">,</span> <span class="n">cqe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cqe</span><span class="p">));</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">work_cnt</span><span class="p">);</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iothread</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
	<span class="n">bnx2i_process_scsi_cmd_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cqe</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_new_cqes - process newly DMA&#39;ed CQE&#39;s</span>
<span class="cm"> * @bnx2i_conn:		bnx2i connection</span>
<span class="cm"> *</span>
<span class="cm"> * this function is called by generic KCQ handler to process all pending CQE&#39;s</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_process_new_cqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qp_info</span> <span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="n">nopin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt_async_msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cqe_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): cq resr freed in bh execution!&quot;</span><span class="p">,</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nopin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_nop_in_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nopin</span><span class="o">-&gt;</span><span class="n">cq_req_sn</span> <span class="o">!=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cqe_exp_seq_sn</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ISCSI_SUSPEND_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">suspend_rx</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nopin</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_OP_NOOP_IN</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nopin</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">RESERVED_ITT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: Unsolicited &quot;</span>
					<span class="s">&quot;NOP-In detected for suspended &quot;</span>
					<span class="s">&quot;connection dev=%s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">bnx2i_unsol_pdu_adjust_rq</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cqe_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tgt_async_msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nopin</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_SCSI_CMD_RSP</span>:
		<span class="k">case</span> <span class="n">ISCSI_OP_SCSI_DATA_IN</span>:
			<span class="cm">/* Run the kthread engine only for data cmds</span>
<span class="cm">			   All other cmds will be completed in this bh! */</span>
			<span class="n">bnx2i_queue_scsi_cmd_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">nopin</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_LOGIN_RSP</span>:
			<span class="n">bnx2i_process_login_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						 <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_SCSI_TMFUNC_RSP</span>:
			<span class="n">bnx2i_process_tmf_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
					       <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_TEXT_RSP</span>:
			<span class="n">bnx2i_process_text_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_LOGOUT_RSP</span>:
			<span class="n">bnx2i_process_logout_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						  <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_NOOP_IN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_process_nopin_mesg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						     <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">))</span>
				<span class="n">tgt_async_msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OPCODE_NOPOUT_LOCAL_COMPLETION</span>:
			<span class="n">bnx2i_process_nopin_local_cmpl</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						       <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_ASYNC_EVENT</span>:
			<span class="n">bnx2i_process_async_mesg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						 <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="n">tgt_async_msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OP_REJECT</span>:
			<span class="n">bnx2i_process_reject_mesg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						  <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_OPCODE_CLEANUP_RESPONSE</span>:
			<span class="n">bnx2i_process_cmd_cleanup_resp</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						       <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unknown opcode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">nopin</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt_async_msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_active_cmds</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): no active cmd! &quot;</span>
				       <span class="s">&quot;op 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">nopin</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_active_cmds</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">cqe_out:</span>
		<span class="cm">/* clear out in production version only, till beta keep opcode</span>
<span class="cm">		 * field intact, will be helpful in debugging (context dump)</span>
<span class="cm">		 * nopin-&gt;op_code = 0;</span>
<span class="cm">		 */</span>
		<span class="n">cqe_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cqe_exp_seq_sn</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cqe_exp_seq_sn</span> <span class="o">==</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cqe_size</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cqe_exp_seq_sn</span> <span class="o">=</span> <span class="n">ISCSI_INITIAL_SN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span> <span class="o">==</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_last_qe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span> <span class="o">=</span> <span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_first_qe</span><span class="p">;</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_qe</span><span class="o">++</span><span class="p">;</span>
			<span class="n">qp</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cqe_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_fastpath_notification - process global event queue (KCQ)</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @new_cqe_kcqe:	pointer to newly DMA&#39;ed KCQE entry</span>
<span class="cm"> *</span>
<span class="cm"> * Fast path event notification handler, KCQ entry carries context id</span>
<span class="cm"> *	of the connection that has 1 or more pending CQ entries</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_fastpath_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">new_cqe_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nxt_idx</span><span class="p">;</span>

	<span class="n">iscsi_cid</span> <span class="o">=</span> <span class="n">new_cqe_kcqe</span><span class="o">-&gt;</span><span class="n">iscsi_conn_id</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">bnx2i_get_conn_from_id</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2i_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;cid #%x not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;cid #%x - ep not bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_process_new_cqes</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>
	<span class="n">nxt_idx</span> <span class="o">=</span> <span class="n">bnx2i_arm_cq_event_coalescing</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
						<span class="n">CNIC_ARM_CQE_FP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nxt_idx</span> <span class="o">&amp;&amp;</span> <span class="n">nxt_idx</span> <span class="o">==</span> <span class="n">bnx2i_process_new_cqes</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">))</span>
		<span class="n">bnx2i_arm_cq_event_coalescing</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">CNIC_ARM_CQE_FP</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_update_conn_cmpl - process iscsi conn update completion KCQE</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @update_kcqe:	kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * CONN_UPDATE completion handler, this completes iSCSI connection FFP migration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_update_conn_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">update_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">;</span>

	<span class="n">iscsi_cid</span> <span class="o">=</span> <span class="n">update_kcqe</span><span class="o">-&gt;</span><span class="n">iscsi_conn_id</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_get_conn_from_id</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;conn_update: cid %x not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;cid %x does not have ep bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;request failed cid %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_ULP_UPDATE_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_ULP_UPDATE_COMPL</span><span class="p">;</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_recovery_que_add_conn - add connection to recovery queue</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection</span>
<span class="cm"> *</span>
<span class="cm"> * Add connection to recovery queue and schedule adapter eh worker</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_recovery_que_add_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
			   <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_tcp_error - process error notification on a given connection</span>
<span class="cm"> *</span>
<span class="cm"> * @hba: 		adapter structure pointer</span>
<span class="cm"> * @tcp_err: 		tcp error kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * handles tcp level error notifications from FW.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_tcp_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">tcp_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">;</span>

	<span class="n">iscsi_cid</span> <span class="o">=</span> <span class="n">tcp_err</span><span class="o">-&gt;</span><span class="n">iscsi_conn_id</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">bnx2i_get_conn_from_id</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2i_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i - cid 0x%x not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i - cid 0x%x had TCP errors, error code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">iscsi_cid</span><span class="p">,</span> <span class="n">tcp_err</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
	<span class="n">bnx2i_recovery_que_add_conn</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_iscsi_error - process error notification on a given connection</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @iscsi_err:		iscsi error kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * handles iscsi error notifications from the FW. Firmware based in initial</span>
<span class="cm"> *	handshake classifies iscsi protocol / TCP rfc violation into either</span>
<span class="cm"> *	warning or error indications. If indication is of &quot;Error&quot; type, driver</span>
<span class="cm"> *	will initiate session recovery for that connection/session. For</span>
<span class="cm"> *	&quot;Warning&quot; type indication, driver will put out a system log message</span>
<span class="cm"> *	(there will be only one message for each type for the life of the</span>
<span class="cm"> *	session, this is to avoid un-necessarily overloading the system)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_iscsi_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">iscsi_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">warn_notice</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;iscsi_warning&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">error_notice</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;iscsi_error&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">additional_notice</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_recovery</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">err_mask64</span><span class="p">;</span>

	<span class="n">iscsi_cid</span> <span class="o">=</span> <span class="n">iscsi_err</span><span class="o">-&gt;</span><span class="n">iscsi_conn_id</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">bnx2i_get_conn_from_id</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2i_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i - cid 0x%x not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err_mask64</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">iscsi_err</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask64</span> <span class="o">&amp;</span> <span class="n">iscsi_error_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">need_recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">message</span> <span class="o">=</span> <span class="n">warn_notice</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">need_recovery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">message</span> <span class="o">=</span> <span class="n">error_notice</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iscsi_err</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_HDR_DIG_ERR</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;hdr digest err&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_DATA_DIG_ERR</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;data digest err&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_OPCODE</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;wrong opcode rcvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_AHS_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;AHS len &gt; 0 rcvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_ITT</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid ITT rcvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_STATSN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;wrong StatSN rcvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_EXP_DATASN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;wrong DataSN rcvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_PEND_R2T</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;pend R2T violation&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_0</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, UO&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_1</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, U1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_2</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, U2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_3</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, U3&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_4</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, U4&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_5</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, U5&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_6</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;ERL0, U6&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_REMAIN_RCV_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid resi len&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_MAX_RCV_PDU_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;MRDSL violation&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_F_BIT_ZERO</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;F-bit not set&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_TTT_NOT_RSRV</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid TTT&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DATASN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid DataSN&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_REMAIN_BURST_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;burst len violation&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_BUFFER_OFF</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;buf offset violation&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_LUN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid LUN field&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_R2TSN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid R2TSN field&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#define BNX2I_ERR_DESIRED_DATA_TRNS_LEN_0 	\</span>
<span class="cp">	ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DESIRED_DATA_TRNS_LEN_0</span>
	<span class="k">case</span> <span class="n">BNX2I_ERR_DESIRED_DATA_TRNS_LEN_0</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid cmd len1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#define BNX2I_ERR_DESIRED_DATA_TRNS_LEN_1 	\</span>
<span class="cp">	ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DESIRED_DATA_TRNS_LEN_1</span>
	<span class="k">case</span> <span class="n">BNX2I_ERR_DESIRED_DATA_TRNS_LEN_1</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;invalid cmd len2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_PEND_R2T_EXCEED</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span>
		       <span class="s">&quot;pend r2t exceeds MaxOutstandingR2T value&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_TTT_IS_RSRV</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;TTT is rsvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_MAX_BURST_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;MBL violation&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#define BNX2I_ERR_DATA_SEG_LEN_NOT_ZERO 	\</span>
<span class="cp">	ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DATA_SEG_LEN_NOT_ZERO</span>
	<span class="k">case</span> <span class="n">BNX2I_ERR_DATA_SEG_LEN_NOT_ZERO</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;data seg len != 0&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_REJECT_PDU_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;reject pdu len error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_ASYNC_PDU_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;async pdu len error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_NOPIN_PDU_LEN</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;nopin pdu len error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#define BNX2_ERR_PEND_R2T_IN_CLEANUP			\</span>
<span class="cp">	ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_PEND_R2T_IN_CLEANUP</span>
	<span class="k">case</span> <span class="n">BNX2_ERR_PEND_R2T_IN_CLEANUP</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;pend r2t in cleanup&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISCI_KCQE_COMPLETION_STATUS_TCP_ERROR_IP_FRAGMENT</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;IP fragments rcvd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCI_KCQE_COMPLETION_STATUS_TCP_ERROR_IP_OPTIONS</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;IP options error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCI_KCQE_COMPLETION_STATUS_TCP_ERROR_URGENT_FLAG</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">additional_notice</span><span class="p">,</span> <span class="s">&quot;urgent flag error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;iscsi_err - unknown err %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">iscsi_err</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				  <span class="s">&quot;bnx2i: %s - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">message</span><span class="p">,</span> <span class="n">additional_notice</span><span class="p">);</span>

		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				  <span class="s">&quot;conn_err - hostno %d conn %p, &quot;</span>
				  <span class="s">&quot;iscsi_cid %x cid %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
		<span class="n">bnx2i_recovery_que_add_conn</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">iscsi_err</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">violation_notified</span><span class="p">))</span>
			<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span>
					  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
					  <span class="s">&quot;bnx2i: %s - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">message</span><span class="p">,</span> <span class="n">additional_notice</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_conn_destroy_cmpl - process iscsi conn destroy completion</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @conn_destroy:	conn destroy kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * handles connection destroy completion request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_conn_destroy_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">conn_destroy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_find_ep_in_destroy_list</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">conn_destroy</span><span class="o">-&gt;</span><span class="n">iscsi_conn_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i_conn_destroy_cmpl: no pending &quot;</span>
				  <span class="s">&quot;offload request, unexpected complection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;conn destroy- error hba mis-match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn_destroy</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;conn_destroy_cmpl: op failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CLEANUP_FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CLEANUP_CMPL</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_process_ofld_cmpl - process initial iscsi conn offload completion</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @ofld_kcqe:		conn offload kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * handles initial connection offload completion, ep_connect() thread is</span>
<span class="cm"> *	woken-up to continue with LLP connect process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_process_ofld_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">ofld_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cid_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid_num</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_find_ep_in_ofld_list</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">iscsi_conn_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ofld_cmpl: no pend offload request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ofld_cmpl: error hba mis-match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_OFLD_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">==</span>
		    <span class="n">ISCSI_KCQE_COMPLETION_STATUS_CTX_ALLOC_FAILURE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): ofld1 cmpl - unable &quot;</span>
				<span class="s">&quot;to allocate iSCSI context resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">==</span>
			 <span class="n">ISCSI_KCQE_COMPLETION_STATUS_INVALID_OPCODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): ofld1 cmpl - invalid &quot;</span>
				<span class="s">&quot;opcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">==</span>
			 <span class="n">ISCSI_KCQE_COMPLETION_STATUS_CID_BUSY</span><span class="p">)</span>
			<span class="cm">/* error status code valid only for 5771x chipset */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_OFLD_FAILED_CID_BUSY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): ofld1 cmpl - invalid &quot;</span>
				<span class="s">&quot;error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_OFLD_COMPL</span><span class="p">;</span>
		<span class="n">cid_addr</span> <span class="o">=</span> <span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">iscsi_conn_context_id</span><span class="p">;</span>
		<span class="n">cid_num</span> <span class="o">=</span> <span class="n">bnx2i_get_cid_num</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">=</span> <span class="n">cid_addr</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_indicate_kcqe - process iscsi conn update completion KCQE</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @update_kcqe:	kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Generic KCQ event handler/dispatcher</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_indicate_kcqe</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kcqe</span> <span class="o">*</span><span class="n">kcqe</span><span class="p">[],</span>
				<span class="n">u32</span> <span class="n">num_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="n">ikcqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ikcqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_kcqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">kcqe</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span>
		    <span class="n">ISCSI_KCQE_OPCODE_CQ_EVENT_NOTIFICATION</span><span class="p">)</span>
			<span class="n">bnx2i_fastpath_notification</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_OPCODE_OFFLOAD_CONN</span><span class="p">)</span>
			<span class="n">bnx2i_process_ofld_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_OPCODE_UPDATE_CONN</span><span class="p">)</span>
			<span class="n">bnx2i_process_update_conn_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_OPCODE_INIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">!=</span>
			    <span class="n">ISCSI_KCQE_COMPLETION_STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">bnx2i_iscsi_license_error</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="o">-&gt;</span>\
							  <span class="n">completion_status</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
				<span class="n">bnx2i_get_link_state</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;bnx2i [%.2x:%.2x.%.2x]: &quot;</span>
						 <span class="s">&quot;ISCSI_INIT passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
						 <span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_devno</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>


			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_OPCODE_DESTROY_CONN</span><span class="p">)</span>
			<span class="n">bnx2i_process_conn_destroy_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_OPCODE_ISCSI_ERROR</span><span class="p">)</span>
			<span class="n">bnx2i_process_iscsi_error</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">==</span> <span class="n">ISCSI_KCQE_OPCODE_TCP_ERROR</span><span class="p">)</span>
			<span class="n">bnx2i_process_tcp_error</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ikcqe</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: unknown opcode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ikcqe</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_indicate_netevent - Generic netdev event handler</span>
<span class="cm"> * @context:	adapter structure pointer</span>
<span class="cm"> * @event:	event type</span>
<span class="cm"> * @vlan_id:	vlans id - associated vlan id with this event</span>
<span class="cm"> *</span>
<span class="cm"> * Handles four netdev events, NETDEV_UP, NETDEV_DOWN,</span>
<span class="cm"> *	NETDEV_GOING_DOWN and NETDEV_CHANGE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_indicate_netevent</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="cm">/* Ignore all netevent coming from vlans */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">))</span>
			<span class="n">bnx2i_send_fw_iscsi_init_msg</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_GOING_DOWN</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					    <span class="n">bnx2i_drop_session</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_CHANGE</span>:
		<span class="n">bnx2i_get_link_state</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_cm_connect_cmpl - process iscsi conn establishment completion</span>
<span class="cm"> * @cm_sk: 		cnic sock structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * function callback exported via bnx2i - cnic driver interface to</span>
<span class="cm"> *	indicate completion of option-2 TCP connect request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cm_connect_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">cm_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CONNECT_FAILED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SK_F_OFFLD_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CONNECT_COMPL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CONNECT_FAILED</span><span class="p">;</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_cm_close_cmpl - process tcp conn close completion</span>
<span class="cm"> * @cm_sk:	cnic sock structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * function callback exported via bnx2i - cnic driver interface to</span>
<span class="cm"> *	indicate completion of option-2 graceful TCP connect shutdown</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cm_close_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">cm_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_DISCONN_COMPL</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_cm_abort_cmpl - process abortive tcp conn teardown completion</span>
<span class="cm"> * @cm_sk:	cnic sock structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * function callback exported via bnx2i - cnic driver interface to</span>
<span class="cm"> *	indicate completion of option-2 abortive TCP connect termination</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cm_abort_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">cm_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_DISCONN_COMPL</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_cm_remote_close - process received TCP FIN</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @update_kcqe:	kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * function callback exported via bnx2i - cnic driver interface to indicate</span>
<span class="cm"> *	async TCP events such as FIN</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cm_remote_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">cm_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_TCP_FIN_RCVD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">bnx2i_recovery_que_add_conn</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_cm_remote_abort - process TCP RST and start conn cleanup</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @update_kcqe:	kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * function callback exported via bnx2i - cnic driver interface to</span>
<span class="cm"> *	indicate async TCP events (RST) sent by the peer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cm_remote_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">cm_sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_TCP_RST_RCVD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">EP_STATE_DISCONN_START</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span>
			<span class="n">bnx2i_recovery_que_add_conn</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_send_nl_mesg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msg_type</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">iscsi_offload_mesg</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_iscsi_transport</span><span class="p">,</span>
				<span class="n">msg_type</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: private nl message send error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_cnic_cb - global template of bnx2i - cnic driver interface structure</span>
<span class="cm"> *			carrying callback function pointers</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cnic_ulp_ops</span> <span class="n">bnx2i_cnic_cb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cnic_init</span> <span class="o">=</span> <span class="n">bnx2i_ulp_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_exit</span> <span class="o">=</span> <span class="n">bnx2i_ulp_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_start</span> <span class="o">=</span> <span class="n">bnx2i_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_stop</span> <span class="o">=</span> <span class="n">bnx2i_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indicate_kcqes</span> <span class="o">=</span> <span class="n">bnx2i_indicate_kcqe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indicate_netevent</span> <span class="o">=</span> <span class="n">bnx2i_indicate_netevent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cm_connect_complete</span> <span class="o">=</span> <span class="n">bnx2i_cm_connect_cmpl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cm_close_complete</span> <span class="o">=</span> <span class="n">bnx2i_cm_close_cmpl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cm_abort_complete</span> <span class="o">=</span> <span class="n">bnx2i_cm_abort_cmpl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cm_remote_close</span> <span class="o">=</span> <span class="n">bnx2i_cm_remote_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cm_remote_abort</span> <span class="o">=</span> <span class="n">bnx2i_cm_remote_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iscsi_nl_send_msg</span> <span class="o">=</span> <span class="n">bnx2i_send_nl_mesg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_map_ep_dbell_regs - map connection doorbell registers</span>
<span class="cm"> * @ep: bnx2i endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * maps connection&#39;s SQ and RQ doorbell registers, 5706/5708/5709 hosts these</span>
<span class="cm"> *	register in BAR #0. Whereas in 57710 these register are accessed by</span>
<span class="cm"> *	mapping BAR #1</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_map_ep_dbell_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cid_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_off</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_l4l5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctx_sz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config2</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">reg_base</span><span class="p">;</span>

	<span class="n">cid_num</span> <span class="o">=</span> <span class="n">bnx2i_get_cid_num</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					      <span class="n">BNX2X_DOORBELL_PCI_BAR</span><span class="p">);</span>
		<span class="n">reg_off</span> <span class="o">=</span> <span class="n">BNX2I_5771X_DBELL_PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="n">cid_num</span> <span class="o">&amp;</span> <span class="mh">0x1FFFF</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">DPM_TRIGER_TYPE</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">reg_off</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">arm_cq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_base</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5709</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mail_queue_access</span> <span class="o">==</span> <span class="n">BNX2I_MQ_BIN_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">config2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">BNX2_MQ_CONFIG2</span><span class="p">);</span>
		<span class="n">first_l4l5</span> <span class="o">=</span> <span class="n">config2</span> <span class="o">&amp;</span> <span class="n">BNX2_MQ_CONFIG2_FIRST_L4L5</span><span class="p">;</span>
		<span class="n">ctx_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="n">BNX2_MQ_CONFIG2_CONT_SZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx_sz</span><span class="p">)</span>
			<span class="n">reg_off</span> <span class="o">=</span> <span class="n">CTX_OFFSET</span> <span class="o">+</span> <span class="n">MAX_CID_CNT</span> <span class="o">*</span> <span class="n">MB_KERNEL_CTX_SIZE</span>
				  <span class="o">+</span> <span class="n">BNX2I_570X_PAGE_SIZE_DEFAULT</span> <span class="o">*</span>
				  <span class="p">(((</span><span class="n">cid_num</span> <span class="o">-</span> <span class="n">first_l4l5</span><span class="p">)</span> <span class="o">/</span> <span class="n">ctx_sz</span><span class="p">)</span> <span class="o">+</span> <span class="mi">256</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">reg_off</span> <span class="o">=</span> <span class="n">CTX_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">MB_KERNEL_CTX_SIZE</span> <span class="o">*</span> <span class="n">cid_num</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* 5709 device in normal node and 5706/5708 devices */</span>
		<span class="n">reg_off</span> <span class="o">=</span> <span class="n">CTX_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">MB_KERNEL_CTX_SIZE</span> <span class="o">*</span> <span class="n">cid_num</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">reg_off</span><span class="p">,</span>
					  <span class="n">MB_KERNEL_CTX_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">qp</span><span class="p">.</span><span class="n">ctx_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">arm_cq:</span>
	<span class="n">bnx2i_arm_cq_event_coalescing</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">CNIC_ARM_CQE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
