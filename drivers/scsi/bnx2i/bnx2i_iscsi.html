<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bnx2i › bnx2i_iscsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bnx2i_iscsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * bnx2i_iscsi.c: Broadcom NetXtreme II iSCSI driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006 - 2012 Broadcom Corporation</span>
<span class="cm"> * Copyright (c) 2007, 2008 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2007, 2008 Mike Christie</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Anil Veerabhadrappa (anilgv@broadcom.com)</span>
<span class="cm"> * Maintained by: Eddie Wai (eddie.wai@broadcom.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/libiscsi.h&gt;</span>
<span class="cp">#include &quot;bnx2i.h&quot;</span>

<span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">bnx2i_scsi_xport_template</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">bnx2i_iscsi_transport</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">bnx2i_host_template</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Global endpoint resource info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">bnx2i_resc_lock</span><span class="p">);</span> <span class="cm">/* protects global resources */</span>

<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_percpu_s</span><span class="p">,</span> <span class="n">bnx2i_percpu</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_adapter_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_get_write_cmd_bd_idx - identifies various BD bookmarks</span>
<span class="cm"> * @cmd:		iscsi cmd struct pointer</span>
<span class="cm"> * @buf_off:		absolute buffer offset</span>
<span class="cm"> * @start_bd_off:	u32 pointer to return the offset within the BD</span>
<span class="cm"> *			indicated by &#39;start_bd_idx&#39; on which &#39;buf_off&#39; falls</span>
<span class="cm"> * @start_bd_idx:	index of the BD on which &#39;buf_off&#39; falls</span>
<span class="cm"> *</span>
<span class="cm"> * identifies &amp; marks various bd info for scsi command&#39;s imm data,</span>
<span class="cm"> * unsolicited data and the first solicited data seq.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_get_write_cmd_bd_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf_off</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">start_bd_off</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">start_bd_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">bd_tbl</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_bd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">buf_off</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">cur_offset</span> <span class="o">+</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cur_offset</span> <span class="o">+=</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">;</span>
			<span class="n">cur_bd_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bd_tbl</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">start_bd_off</span> <span class="o">=</span> <span class="n">buf_off</span> <span class="o">-</span> <span class="n">cur_offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">start_bd_idx</span> <span class="o">=</span> <span class="n">cur_bd_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_setup_write_cmd_bd_info - sets up BD various information</span>
<span class="cm"> * @task:	transport layer&#39;s cmd struct pointer</span>
<span class="cm"> *</span>
<span class="cm"> * identifies &amp; marks various bd info for scsi command&#39;s immediate data,</span>
<span class="cm"> * unsolicited data and first solicited data seq which includes BD start</span>
<span class="cm"> * index &amp; BD buf off. his function takes into account iscsi parameter such</span>
<span class="cm"> * as immediate data and unsolicited data is support on this connection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_setup_write_cmd_bd_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_bd_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_bd_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">total_data_transfer_length</span><span class="p">;</span>

	<span class="cm">/* if ImmediateData is turned off &amp; IntialR2T is turned on,</span>
<span class="cm">	 * there will be no immediate or unsolicited data, just return.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscsi_task_has_unsol_data</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">imm_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Immediate data */</span>
	<span class="n">buffer_offset</span> <span class="o">+=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">imm_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">imm_count</span> <span class="o">==</span> <span class="n">cmd_len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_task_has_unsol_data</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2i_get_write_cmd_bd_idx</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">buffer_offset</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">start_bd_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_bd_idx</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">ud_buffer_offset</span> <span class="o">=</span> <span class="n">start_bd_offset</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">ud_start_bd_index</span> <span class="o">=</span> <span class="n">start_bd_idx</span><span class="p">;</span>
		<span class="n">buffer_offset</span> <span class="o">+=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">unsol_r2t</span><span class="p">.</span><span class="n">data_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_offset</span> <span class="o">!=</span> <span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_get_write_cmd_bd_idx</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">buffer_offset</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">start_bd_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_bd_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_bd_offset</span> <span class="o">&gt;</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">first_burst</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_bd_idx</span> <span class="o">&gt;</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
					  <span class="s">&quot;bnx2i- error, buf offset 0x%x &quot;</span>
					  <span class="s">&quot;bd_valid %d use_sg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">buffer_offset</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span><span class="p">,</span>
					  <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
						  <span class="s">&quot;bnx2i err, bd[%d]: len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>\
						  <span class="n">buffer_length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">sd_buffer_offset</span> <span class="o">=</span> <span class="n">start_bd_offset</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">sd_start_bd_index</span> <span class="o">=</span> <span class="n">start_bd_idx</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * bnx2i_map_scsi_sg - maps IO buffer and prepares the BD table</span>
<span class="cm"> * @hba:	adapter instance</span>
<span class="cm"> * @cmd:	iscsi cmd struct pointer</span>
<span class="cm"> *</span>
<span class="cm"> * map SG list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_map_scsi_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sg_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ISCSI_MAX_BDS_PER_CMD</span><span class="p">);</span>

	<span class="n">sg_count</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span><span class="p">].</span><span class="n">buffer_addr_lo</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span><span class="p">].</span><span class="n">buffer_addr_hi</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span><span class="p">].</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_BD_FIRST_IN_BD_CHAIN</span><span class="p">;</span>

		<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">sg_len</span><span class="p">;</span>
		<span class="n">bd_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd_count</span><span class="p">)</span>
		<span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISCSI_BD_LAST_IN_BD_CHAIN</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">byte_count</span> <span class="o">!=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">bd_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_iscsi_map_sg_list - maps SG list</span>
<span class="cm"> * @cmd:	iscsi cmd struct pointer</span>
<span class="cm"> *</span>
<span class="cm"> * creates BD list table for the command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_iscsi_map_sg_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bd_count</span><span class="p">;</span>

	<span class="n">bd_count</span>  <span class="o">=</span> <span class="n">bnx2i_map_scsi_sg</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl</span><span class="p">;</span>

		<span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer_addr_lo</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer_addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span> <span class="o">=</span> <span class="n">bd_count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_iscsi_unmap_sg_list - unmaps SG list</span>
<span class="cm"> * @cmd:	iscsi cmd struct pointer</span>
<span class="cm"> *</span>
<span class="cm"> * unmap IO buffers and invalidate the BD table</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_iscsi_unmap_sg_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_setup_cmd_wqe_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl_dma</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_bind_conn_to_iscsi_cid - bind conn structure to &#39;iscsi_cid&#39;</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @conn:	pointer to iscsi connection</span>
<span class="cm"> * @iscsi_cid:	iscsi context ID, range 0 - (MAX_CONN - 1)</span>
<span class="cm"> *</span>
<span class="cm"> * update iscsi cid table entry with connection pointer. This enables</span>
<span class="cm"> *	driver to quickly get hold of connection structure pointer in</span>
<span class="cm"> *	completion/interrupt thread using iscsi context ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_bind_conn_to_iscsi_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">[</span><span class="n">iscsi_cid</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				 <span class="s">&quot;conn bind - entry #%d not free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">[</span><span class="n">iscsi_cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_get_conn_from_id - maps an iscsi cid to corresponding conn ptr</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @iscsi_cid:	iscsi context ID, range 0 - (MAX_CONN - 1)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="nf">bnx2i_get_conn_from_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="n">iscsi_cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bnx2i: ERROR - missing conn&lt;-&gt;cid table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iscsi_cid</span> <span class="o">&gt;=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bnx2i: wrong cid #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">[</span><span class="n">iscsi_cid</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_alloc_iscsi_cid - allocates a iscsi_cid from free pool</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2i_alloc_iscsi_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_free_cnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_cons_idx</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_cons_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_cons_idx</span> <span class="o">==</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_max_idx</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_free_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_free_iscsi_cid - returns tcp port to free list</span>
<span class="cm"> * @hba: 		pointer to adapter instance</span>
<span class="cm"> * @iscsi_cid:		iscsi context ID to free</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_free_iscsi_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iscsi_cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_cid</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_free_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_prod_idx</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">iscsi_cid</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">[</span><span class="n">iscsi_cid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_prod_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_prod_idx</span> <span class="o">==</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_max_idx</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_setup_free_cid_que - sets up free iscsi cid queue</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * allocates memory for iscsi cid queue &amp; &#39;cid - conn ptr&#39; mapping table,</span>
<span class="cm"> * 	and initialize table attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_setup_free_cid_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mem_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">mem_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mem_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">mem_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mem_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_q_max_idx</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_free_cnt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_release_free_cid_que - releases &#39;iscsi_cid&#39; queue resources</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_release_free_cid_que</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_que_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">conn_cid_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_alloc_ep - allocates ep structure from global pool</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * routine allocates a free endpoint structure from global pool and</span>
<span class="cm"> *	a tcp port to be used for this connection.  Global resource lock,</span>
<span class="cm"> *	&#39;bnx2i_resc_lock&#39; is held while accessing shared global data structures</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="nf">bnx2i_alloc_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ec_div</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_create_endpoint</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bnx2i: Could not allocate ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cls_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_IDLE</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba_age</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">;</span>

	<span class="n">ec_div</span> <span class="o">=</span> <span class="n">event_coal_div</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ec_div</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ec_shift</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">ofld_conns_active</span><span class="o">++</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_free_ep - free endpoint</span>
<span class="cm"> * @ep:		pointer to iscsi endpoint structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_free_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_resc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_IDLE</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ofld_conns_active</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">bnx2i_free_iscsi_cid</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_resc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_alloc_bdt - allocates buffer descriptor (BD) table for the command</span>
<span class="cm"> * @hba:	adapter instance pointer</span>
<span class="cm"> * @session:	iscsi session pointer</span>
<span class="cm"> * @cmd:	iscsi command structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_alloc_bdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_bdt</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">bd_tbl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">ISCSI_MAX_BDS_PER_CMD</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bd</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_session_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s">&quot;Could not &quot;</span>
				     <span class="s">&quot;allocate bdt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">bd_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_destroy_cmd_pool - destroys iscsi command pool and release BD table</span>
<span class="cm"> * @hba:	adapter instance pointer</span>
<span class="cm"> * @session:	iscsi session pointer</span>
<span class="cm"> * @cmd:	iscsi command structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_destroy_cmd_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">ISCSI_MAX_BDS_PER_CMD</span> <span class="o">*</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_bd</span><span class="p">),</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl</span><span class="p">,</span>
					  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_tbl_dma</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_setup_cmd_pool - sets up iscsi command pool for the session</span>
<span class="cm"> * @hba:	adapter instance pointer</span>
<span class="cm"> * @session:	iscsi session pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_setup_cmd_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

		<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_max</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_alloc_bdt</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">free_bdts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_bdts:</span>
	<span class="n">bnx2i_destroy_cmd_pool</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_setup_mp_bdt - allocate BD table resources</span>
<span class="cm"> * @hba:	pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate memory for dummy buffer and associated BD</span>
<span class="cm"> * table to be used by middle path (MP) requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_setup_mp_bdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">mp_bdt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to allocate Middle Path BDT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to alloc Middle Path Dummy Buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mp_bdt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">;</span>
	<span class="n">mp_bdt</span><span class="o">-&gt;</span><span class="n">buffer_addr_lo</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">mp_bdt</span><span class="o">-&gt;</span><span class="n">buffer_addr_hi</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">mp_bdt</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">mp_bdt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_BD_LAST_IN_BD_CHAIN</span> <span class="o">|</span>
			<span class="n">ISCSI_BD_FIRST_IN_BD_CHAIN</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_free_mp_bdt - releases ITT back to free pool</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * free MP dummy buffer and associated BD table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_free_mp_bdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_drop_session - notifies iscsid of connection error.</span>
<span class="cm"> * @hba:	adapter instance pointer</span>
<span class="cm"> * @session:	iscsi session pointer</span>
<span class="cm"> *</span>
<span class="cm"> * This notifies iscsid that there is a error, so it can initiate</span>
<span class="cm"> * recovery.</span>
<span class="cm"> *</span>
<span class="cm"> * This relies on caller using the iscsi class iterator so the object</span>
<span class="cm"> * is refcounted and does not disapper from under us.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_drop_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iscsi_session_failure</span><span class="p">(</span><span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span> <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_destroy_list_add - add an entry to EP destroy list</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @ep:		pointer to endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * EP destroy queue manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_destroy_list_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_destroy_list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_destroy_list_del - add an entry to EP destroy list</span>
<span class="cm"> *</span>
<span class="cm"> * @hba: 		pointer to adapter instance</span>
<span class="cm"> * @ep: 		pointer to endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * EP destroy queue manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_destroy_list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_ofld_list_add - add an entry to ep offload pending list</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @ep:		pointer to endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * pending conn offload completion queue manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_ofld_list_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_ofld_list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_ofld_list_del - add an entry to ep offload pending list</span>
<span class="cm"> * @hba: 		pointer to adapter instance</span>
<span class="cm"> * @ep: 		pointer to endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * pending conn offload completion queue manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_ofld_list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_find_ep_in_ofld_list - find iscsi_cid in pending list of endpoints</span>
<span class="cm"> *</span>
<span class="cm"> * @hba: 		pointer to adapter instance</span>
<span class="cm"> * @iscsi_cid:		iscsi context ID to find</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span>
<span class="nf">bnx2i_find_ep_in_ofld_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_ofld_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span><span class="n">list</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span> <span class="o">==</span> <span class="n">iscsi_cid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;l5 cid %d not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_find_ep_in_destroy_list - find iscsi_cid in destroy list</span>
<span class="cm"> * @hba: 		pointer to adapter instance</span>
<span class="cm"> * @iscsi_cid:		iscsi context ID to find</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span>
<span class="nf">bnx2i_find_ep_in_destroy_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iscsi_cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_destroy_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="p">)</span><span class="n">list</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span> <span class="o">==</span> <span class="n">iscsi_cid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;l5 cid %d not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_cid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_active_list_add - add an entry to ep active list</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @ep:		pointer to endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * current active conn queue manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_ep_active_list_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_active_list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_active_list_del - deletes an entry to ep active list</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @ep:		pointer to endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * current active conn queue manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_ep_active_list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_setup_host_queue_size - assigns shost-&gt;can_queue param</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @shost:	scsi host pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes &#39;can_queue&#39; parameter based on how many outstanding commands</span>
<span class="cm"> * 	the device can handle. Each device 5708/5709/57710 has different</span>
<span class="cm"> *	capabilities</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_setup_host_queue_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5708</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ISCSI_MAX_CMDS_PER_HBA_5708</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5709</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ISCSI_MAX_CMDS_PER_HBA_5709</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ISCSI_MAX_CMDS_PER_HBA_57710</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ISCSI_MAX_CMDS_PER_HBA_5708</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_alloc_hba - allocate and init adapter instance</span>
<span class="cm"> * @cnic:	cnic device pointer</span>
<span class="cm"> *</span>
<span class="cm"> * allocate &amp; initialize adapter structure and call other</span>
<span class="cm"> *	support routines to do per adapter initialization</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="nf">bnx2i_alloc_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_host_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hba</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_boundary</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">bnx2i_scsi_xport_template</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ISCSI_MAX_CONNS_PER_HBA</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="cm">/* Get PCI related information and update hba struct members */</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_did</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_vid</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_sdid</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_svid</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pci_devno</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">bnx2i_identify_device</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="n">bnx2i_setup_host_queue_size</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_5709</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
					       <span class="n">BNX2_MQ_CONFIG2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ioreg_map_err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ioreg_map_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_setup_mp_bdt</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mp_bdt_mem_err</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_ofld_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_active_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_destroy_list</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">mtu_supported</span> <span class="o">=</span> <span class="n">BNX2I_MAX_MTU_SUPPORTED</span><span class="p">;</span>

	<span class="cm">/* different values for 5708/5709/57710 */</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_active_conns</span> <span class="o">=</span> <span class="n">ISCSI_MAX_CONNS_PER_HBA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_setup_free_cid_que</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cid_que_err</span><span class="p">;</span>

	<span class="cm">/* SQ/RQ/CQ size can be changed via sysfx interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sq_size</span> <span class="o">&amp;&amp;</span> <span class="n">sq_size</span> <span class="o">&lt;=</span> <span class="n">BNX2I_5770X_SQ_WQES_MAX</span><span class="p">)</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="n">sq_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="n">BNX2I_5770X_SQ_WQES_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 5706/5708/5709 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sq_size</span> <span class="o">&amp;&amp;</span> <span class="n">sq_size</span> <span class="o">&lt;=</span> <span class="n">BNX2I_570X_SQ_WQES_MAX</span><span class="p">)</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="n">sq_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">=</span> <span class="n">BNX2I_570X_SQ_WQES_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_rqes</span> <span class="o">=</span> <span class="n">rq_size</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">+</span> <span class="n">rq_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">&gt;</span> <span class="n">BNX2I_5770X_CQ_WQES_MAX</span><span class="p">)</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">=</span> <span class="n">BNX2I_5770X_CQ_WQES_MAX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">&gt;</span> <span class="n">BNX2I_570X_CQ_WQES_MAX</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_cqes</span> <span class="o">=</span> <span class="n">BNX2I_570X_CQ_WQES_MAX</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ccell</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">eh_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_shutdown_tmo</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">conn_teardown_tmo</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">conn_ctx_destroy_tmo</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 5706/5708/5709 */</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_shutdown_tmo</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">conn_teardown_tmo</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">conn_ctx_destroy_tmo</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_host_add</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_dump_mem</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hba</span><span class="p">;</span>

<span class="nl">free_dump_mem:</span>
	<span class="n">bnx2i_release_free_cid_que</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="nl">cid_que_err:</span>
	<span class="n">bnx2i_free_mp_bdt</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="nl">mp_bdt_mem_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">ioreg_map_err:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_free_hba- releases hba structure and resources held by the adapter</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * free adapter structure and call various cleanup routines.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2i_free_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>

	<span class="n">iscsi_host_remove</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_ofld_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_active_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_destroy_list</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">regview</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2i_free_mp_bdt</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="n">bnx2i_release_free_cid_que</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="n">iscsi_host_free</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_free_login_resources - free DMA resources used for login process</span>
<span class="cm"> * @hba:		pointer to adapter instance</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Login related resources, mostly BDT &amp; payload DMA memory is freed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_conn_free_login_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_tbl</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_dma</span><span class="p">);</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span><span class="p">);</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_dma_addr</span><span class="p">);</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">,</span>
				  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_dma_addr</span><span class="p">);</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_alloc_login_resources - alloc DMA resources for login/nop.</span>
<span class="cm"> * @hba:		pointer to adapter instance</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Mgmt task DNA resources are allocated in this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_conn_alloc_login_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Allocate memory for login request/response buffers */</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_dma_addr</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">login_req_buf_failure</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_wr_ptr</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_dma_addr</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">login_resp_buf_failure</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf_size</span> <span class="o">=</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_wr_ptr</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">login_req_bd_tbl_failure</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_tbl</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_dma</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_tbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">login_resp_bd_tbl_failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">login_resp_bd_tbl_failure:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span><span class="p">,</span>
			  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_dma</span><span class="p">);</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">login_req_bd_tbl_failure:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">,</span>
			  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span><span class="p">,</span>
			  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_dma_addr</span><span class="p">);</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">login_resp_buf_failure:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">,</span>
			  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">,</span>
			  <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_dma_addr</span><span class="p">);</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">login_req_buf_failure:</span>
	<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
			  <span class="s">&quot;login resource alloc failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_iscsi_prep_generic_pdu_bd - prepares BD table.</span>
<span class="cm"> * @bnx2i_conn:		iscsi connection pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates buffers and BD tables before shipping requests to cnic</span>
<span class="cm"> *	for PDUs prepared by &#39;iscsid&#39; daemon</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_iscsi_prep_generic_pdu_bd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="n">bd_tbl</span><span class="p">;</span>

	<span class="n">bd_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_bd</span> <span class="o">*</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_bd_tbl</span><span class="p">;</span>

	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_addr_hi</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_dma_addr</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_wr_ptr</span> <span class="o">-</span>
				<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">reserved0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_BD_LAST_IN_BD_CHAIN</span> <span class="o">|</span>
			<span class="n">ISCSI_BD_FIRST_IN_BD_CHAIN</span><span class="p">;</span>

	<span class="n">bd_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_bd</span>  <span class="o">*</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_bd_tbl</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">resp_dma_addr</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">reserved0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISCSI_BD_LAST_IN_BD_CHAIN</span> <span class="o">|</span>
			<span class="n">ISCSI_BD_FIRST_IN_BD_CHAIN</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_iscsi_send_generic_request - called to send mgmt tasks.</span>
<span class="cm"> * @task:	transport layer task pointer</span>
<span class="cm"> *</span>
<span class="cm"> * called to transmit PDUs prepared by the &#39;iscsid&#39; daemon. iSCSI login,</span>
<span class="cm"> *	Nop-out and Logout requests flow through this path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_iscsi_send_generic_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="n">bnx2i_iscsi_prep_generic_pdu_bd</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_LOGIN</span>:
		<span class="n">bnx2i_send_iscsi_login</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_NOOP_OUT</span>:
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf_size</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_send_iscsi_nopout</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span>
						     <span class="n">buf</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_send_iscsi_nopout</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span>
						     <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_LOGOUT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_send_iscsi_logout</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_SCSI_TMFUNC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_send_iscsi_tmf</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_TEXT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_send_iscsi_text</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				  <span class="s">&quot;send_gen: unsupported op 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**********************************************************************</span>
<span class="cm"> *		SCSI-ML Interface</span>
<span class="cm"> **********************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_cpy_scsi_cdb - copies LUN &amp; CDB fields in required format to sq wqe</span>
<span class="cm"> * @sc:		SCSI-ML command pointer</span>
<span class="cm"> * @cmd:	iscsi cmd pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cpy_scsi_cdb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dword</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lpcnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">srcp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dstp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scsi_lun</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_lun</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">lpcnt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>
	<span class="n">srcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="n">dstp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">cdb</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lpcnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dword</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">srcp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dstp</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>
		<span class="n">srcp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">dstp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">srcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srcp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dstp</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_cleanup_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mgmt task or cmd was never sent to us to transmit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span> <span class="o">||</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISCSI_TASK_PENDING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * need to clean-up task context to claim dma buffers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISCSI_TASK_ABRT_TMF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_send_cmd_cleanup_req</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cmd_cleanup_cmpl</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ISCSI_CMD_CLEANUP_TIMEOUT</span><span class="p">));</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2i_iscsi_unmap_sg_list</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_mtask_xmit - transmit mtask to chip for further processing</span>
<span class="cm"> * @conn:	transport layer conn structure pointer</span>
<span class="cm"> * @task:	transport layer command structure pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnx2i_mtask_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISCSI_DEF_MAX_RECV_SEG_LEN</span><span class="p">);</span>

	<span class="n">bnx2i_setup_cmd_wqe_template</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf_size</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">);</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_wr_ptr</span> <span class="o">=</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">gen_pdu</span><span class="p">.</span><span class="n">req_buf</span> <span class="o">+</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bnx2i_iscsi_send_generic_request</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_task_xmit - transmit iscsi command to chip for further processing</span>
<span class="cm"> * @task:	transport layer command structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * maps SG buffers and send request to chip/firmware in the form of SQ WQE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_task_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_scsi_req</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_scsi_req</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_active_cmds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="o">&gt;</span>
	    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is no scsi_cmnd this must be a mgmt task</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bnx2i_mtask_xmit</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>

	<span class="n">bnx2i_setup_cmd_wqe_template</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ISCSI_OP_SCSI_CMD</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">total_data_transfer_length</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">cmd_sn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">);</span>

	<span class="n">bnx2i_iscsi_map_sg_list</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">bnx2i_cpy_scsi_cdb</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">op_attr</span> <span class="o">=</span> <span class="n">ISCSI_ATTR_SIMPLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">op_attr</span> <span class="o">|=</span> <span class="n">ISCSI_CMD_REQUEST_WRITE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">ISCSI_TASK_TYPE_WRITE</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_CMD_REQUEST_TYPE_SHIFT</span><span class="p">);</span>
		<span class="n">bnx2i_setup_write_cmd_bd_info</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">op_attr</span> <span class="o">|=</span> <span class="n">ISCSI_CMD_REQUEST_READ</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">itt</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">ISCSI_TASK_TYPE_READ</span> <span class="o">&lt;&lt;</span> <span class="n">ISCSI_CMD_REQUEST_TYPE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">num_bds</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">io_tbl</span><span class="p">.</span><span class="n">bd_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bd_list_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bd_list_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">num_bds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_send_iscsi_scsicmd</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_session_create - create a new iscsi session</span>
<span class="cm"> * @cmds_max:		max commands supported</span>
<span class="cm"> * @qdepth:		scsi queue depth to support</span>
<span class="cm"> * @initial_cmdsn:	initial iscsi CMDSN to be used for this session</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a new iSCSI session instance on given device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span>
<span class="nf">bnx2i_session_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		     <span class="kt">uint16_t</span> <span class="n">cmds_max</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">qdepth</span><span class="p">,</span>
		     <span class="kt">uint32_t</span> <span class="n">initial_cmdsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bnx2i: missing ep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_adapter_ready</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * user can override hw limit as long as it is within</span>
<span class="cm">	 * the min/max.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmds_max</span> <span class="o">&gt;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">)</span>
		<span class="n">cmds_max</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">max_sqes</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmds_max</span> <span class="o">&lt;</span> <span class="n">BNX2I_SQ_WQES_MIN</span><span class="p">)</span>
		<span class="n">cmds_max</span> <span class="o">=</span> <span class="n">BNX2I_SQ_WQES_MIN</span><span class="p">;</span>

	<span class="n">cls_session</span> <span class="o">=</span> <span class="n">iscsi_session_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_iscsi_transport</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
					  <span class="n">cmds_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_cmd</span><span class="p">),</span>
					  <span class="n">initial_cmdsn</span><span class="p">,</span> <span class="n">ISCSI_MAX_TARGET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_session</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_setup_cmd_pool</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">session_teardown</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cls_session</span><span class="p">;</span>

<span class="nl">session_teardown:</span>
	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_session_destroy - destroys iscsi session</span>
<span class="cm"> * @cls_session:	pointer to iscsi cls session</span>
<span class="cm"> *</span>
<span class="cm"> * Destroys previously created iSCSI session instance and releases</span>
<span class="cm"> *	all resources held by it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_session_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">bnx2i_destroy_cmd_pool</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_create - create iscsi connection instance</span>
<span class="cm"> * @cls_session:	pointer to iscsi cls session</span>
<span class="cm"> * @cid:		iscsi cid as per rfc (not NX2&#39;s CID terminology)</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a new iSCSI connection instance for a given session</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span>
<span class="nf">bnx2i_conn_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">iscsi_conn_setup</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bnx2i_conn</span><span class="p">),</span>
				    <span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">work_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* &#39;ep&#39; ptr will be assigned in bind() call */</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cmd_cleanup_cmpl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn_alloc_login_resources</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
				  <span class="s">&quot;conn_new: login resc alloc failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cls_conn</span><span class="p">;</span>

<span class="nl">free_conn:</span>
	<span class="n">iscsi_conn_teardown</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_bind - binds iscsi sess, conn and ep objects together</span>
<span class="cm"> * @cls_session:	pointer to iscsi cls session</span>
<span class="cm"> * @cls_conn:		pointer to iscsi cls conn</span>
<span class="cm"> * @transport_fd:	64-bit EP handle</span>
<span class="cm"> * @is_leading:		leading connection on this session?</span>
<span class="cm"> *</span>
<span class="cm"> * Binds together iSCSI session instance, iSCSI connection instance</span>
<span class="cm"> *	and the TCP connection. This routine returns error code if</span>
<span class="cm"> *	TCP connection does not belong on the device iSCSI sess/conn</span>
<span class="cm"> *	is bound</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_conn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			   <span class="kt">uint64_t</span> <span class="n">transport_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_code</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_lookup_endpoint</span><span class="p">(</span><span class="n">transport_fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Forcefully terminate all in progress connection recovery at the</span>
<span class="cm">	 * earliest, either in bind(), send_pdu(LOGIN), or conn_start()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_adapter_ready</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_TCP_FIN_RCVD</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_TCP_RST_RCVD</span><span class="p">))</span>
		<span class="cm">/* Peer disconnect via&#39; FIN or RST */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_conn_bind</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="n">is_leading</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Error - TCP connection does not belong to this device</span>
<span class="cm">		 */</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				  <span class="s">&quot;conn bind, ep=0x%p (%s) does not&quot;</span><span class="p">,</span>
				  <span class="n">bnx2i_ep</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ALERT</span><span class="p">,</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				  <span class="s">&quot;belong to hba (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">iscsi_conn_cid</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">fw_cid</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">;</span>

	<span class="n">ret_code</span> <span class="o">=</span> <span class="n">bnx2i_bind_conn_to_iscsi_cid</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">,</span>
						<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">);</span>

	<span class="cm">/* 5706/5708/5709 FW takes RQ as full when initiated, but for 57710</span>
<span class="cm">	 * driver needs to explicitly replenish RQ index during setup.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">bnx2i_put_rq_buf</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2i_arm_cq_event_coalescing</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">CNIC_ARM_CQE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_destroy - destroy iscsi connection instance &amp; release resources</span>
<span class="cm"> * @cls_conn:	pointer to iscsi cls conn</span>
<span class="cm"> *</span>
<span class="cm"> * Destroy an iSCSI connection instance and release memory resources held by</span>
<span class="cm"> *	this connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_conn_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_work</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_percpu_s</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">iscsi_conn_to_session</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">));</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">bnx2i_conn_free_login_resources</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">work_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bnx2i_percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">==</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">&amp;&amp;</span>
				    <span class="n">work</span><span class="o">-&gt;</span><span class="n">bnx2i_conn</span> <span class="o">==</span> <span class="n">bnx2i_conn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span>
							<span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">work_cnt</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_work_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iscsi_conn_teardown</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_get_param - return iscsi ep parameter to caller</span>
<span class="cm"> * @ep:		pointer to iscsi endpoint</span>
<span class="cm"> * @param:	parameter type identifier</span>
<span class="cm"> * @buf: 	buffer pointer</span>
<span class="cm"> *</span>
<span class="cm"> * returns iSCSI ep parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">dst_port</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">dst_ip</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_host_get_param - returns host (adapter) related parameters</span>
<span class="cm"> * @shost:	scsi host pointer</span>
<span class="cm"> * @param:	parameter type identifier</span>
<span class="cm"> * @buf:	buffer pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_host_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_NETDEV_NAME</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">active_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_active_list</span><span class="p">;</span>

		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_active_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>

			<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">active_list</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">bnx2i_endpoint</span><span class="p">,</span>
						    <span class="n">link</span><span class="p">);</span>
			<span class="n">csk</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SK_F_IPV6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">src_ip</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">src_ip</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">ep_rdwr_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_host_get_param</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_start - completes iscsi connection migration to FFP</span>
<span class="cm"> * @cls_conn:	pointer to iscsi cls conn</span>
<span class="cm"> *</span>
<span class="cm"> * last call in FFP migration to handover iscsi conn to the driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_conn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_ULP_UPDATE_START</span><span class="p">;</span>
	<span class="n">bnx2i_update_iscsi_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * this should normally not sleep for a long time so it should</span>
<span class="cm">	 * not disrupt the caller.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bnx2i_ep_ofld_timer</span><span class="p">;</span>
	<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>
	<span class="cm">/* update iSCSI context for this conn, wait for CNIC to complete */</span>
	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">,</span>
			<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_ULP_UPDATE_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

	<span class="n">iscsi_conn_start</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_conn_get_stats - returns iSCSI stats</span>
<span class="cm"> * @cls_conn:	pointer to iscsi cls conn</span>
<span class="cm"> * @stats:	pointer to iscsi statistic struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_conn_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iscsi_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">txdata_octets</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">txdata_octets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dataout_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dataout_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">datain_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">datain_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">r2t_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">r2t_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom_length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;eh_abort_cnt&quot;</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">eh_abort_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">digest_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_check_route - checks if target IP route belongs to one of NX2 devices</span>
<span class="cm"> * @dst_addr:	target IP address</span>
<span class="cm"> *</span>
<span class="cm"> * check if route resolves to BNX2 device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="nf">bnx2i_check_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">desti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">get_adapter_list_head</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">)</span>
		<span class="n">cnic</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">cm_select_dev</span><span class="p">(</span><span class="n">desti</span><span class="p">,</span> <span class="n">CNIC_ULP_ISCSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: no route,&quot;</span>
		       <span class="s">&quot;can&#39;t connect using cnic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">no_nx2_route</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_find_hba_for_cnic</span><span class="p">(</span><span class="n">cnic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_nx2_route</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_adapter_ready</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: check route, hba not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">no_nx2_route</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mtu_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: %s network i/f mtu is set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i: iSCSI HBA can support mtu of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">mtu_supported</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">no_nx2_route</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hba</span><span class="p">;</span>
<span class="nl">no_nx2_route:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_tear_down_conn - tear down iscsi/tcp connection and free resources</span>
<span class="cm"> * @hba:	pointer to adapter instance</span>
<span class="cm"> * @ep:		endpoint (transport indentifier) structure</span>
<span class="cm"> *</span>
<span class="cm"> * destroys cm_sock structure and on chip iscsi context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_tear_down_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_CNIC_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">)</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">cm_destroy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_DISCONN_TIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

			<span class="cm">/* Must suspend all rx queue activity for this ep */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ISCSI_SUSPEND_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">suspend_rx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* CONN_DISCONNECT timeout may or may not be an issue depending</span>
<span class="cm">		 * on what transcribed in TCP layer, different targets behave</span>
<span class="cm">		 * differently</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): - WARN - CONN_DISCON timed out, &quot;</span>
				  <span class="s">&quot;please submit GRC Dump, NW/PCIe trace, &quot;</span>
				  <span class="s">&quot;driver msgs to developers for analysis</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CLEANUP_START</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">conn_ctx_destroy_tmo</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bnx2i_ep_ofld_timer</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

	<span class="n">bnx2i_ep_destroy_list_add</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* destroy iSCSI context, wait for it to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_send_conn_destroy</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CLEANUP_CMPL</span><span class="p">;</span>

	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_CLEANUP_START</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

	<span class="n">bnx2i_ep_destroy_list_del</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_CLEANUP_CMPL</span><span class="p">)</span>
		<span class="cm">/* should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i - conn destroy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_connect - establish TCP connection to target portal</span>
<span class="cm"> * @shost:		scsi host</span>
<span class="cm"> * @dst_addr:		target IP address</span>
<span class="cm"> * @non_blocking:	blocking or non-blocking call</span>
<span class="cm"> *</span>
<span class="cm"> * this routine initiates the TCP/IP connection by invoking Option-2 i/f</span>
<span class="cm"> *	with l5_core and the CNIC. This is a multi-step process of resolving</span>
<span class="cm"> *	route to target, create a iscsi connection context, handshaking with</span>
<span class="cm"> *	CNIC module to create/initialize the socket struct and finally</span>
<span class="cm"> *	sending down option-2 request to complete TCP 3-way handshake</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="nf">bnx2i_ep_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">non_blocking</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iscsi_cid</span> <span class="o">=</span> <span class="n">BNX2I_CID_RESERVED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">desti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">desti6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_sockaddr</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* driver is given scsi host to work with */</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * check if the given destination can be reached through</span>
<span class="cm">		 * a iscsi capable NetXtreme2 device</span>
<span class="cm">		 */</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_check_route</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">nohba</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_adapter_ready</span><span class="p">(</span><span class="n">hba</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cid_que</span><span class="p">.</span><span class="n">cid_free_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_busy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cnic</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">bnx2i_alloc_ep</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_busy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">num_active_cmds</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iscsi_cid</span> <span class="o">=</span> <span class="n">bnx2i_alloc_iscsi_cid</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_cid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): alloc_ep - unable to allocate &quot;</span>
			<span class="s">&quot;iscsi cid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">bnx2i_free_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">check_busy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba_age</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2i_alloc_qp_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): ep_conn - alloc QP resc error&quot;</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">qp_resc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">iscsi_cid</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_OFLD_START</span><span class="p">;</span>
	<span class="n">bnx2i_ep_ofld_list_add</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bnx2i_ep_ofld_timer</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_send_conn_ofld_req</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_OFLD_FAILED_CID_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): iscsi cid %d is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): unable to send conn offld kwqe&quot;</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">bnx2i_ep_ofld_list_del</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">conn_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for CNIC hardware to setup conn context and return &#39;cid&#39; */</span>
	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">,</span>
				 <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_OFLD_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

	<span class="n">bnx2i_ep_ofld_list_del</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_OFLD_COMPL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_OFLD_FAILED_CID_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): iscsi cid %d is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_iscsi_cid</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">conn_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">cm_create</span><span class="p">(</span><span class="n">cnic</span><span class="p">,</span> <span class="n">CNIC_ULP_ISCSI</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">,</span>
			     <span class="n">iscsi_cid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Need to terminate and cleanup the connection */</span>
		<span class="k">goto</span> <span class="n">release_ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">rcv_buf</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">snd_buf</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SK_TCP_TIMESTAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="o">-&gt;</span><span class="n">tcp_flags</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saddr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">saddr</span><span class="p">.</span><span class="n">remote</span><span class="p">.</span><span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="n">desti</span><span class="p">;</span>
		<span class="n">saddr</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">desti</span><span class="o">-&gt;</span><span class="n">sin_family</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desti6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">saddr</span><span class="p">.</span><span class="n">remote</span><span class="p">.</span><span class="n">v6</span> <span class="o">=</span> <span class="o">*</span><span class="n">desti6</span><span class="p">;</span>
		<span class="n">saddr</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="n">v6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">desti6</span><span class="o">-&gt;</span><span class="n">sin6_family</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_CONNECT_START</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_CNIC_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">conn_failed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">cm_connect</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release_ep</span><span class="p">;</span>

	<span class="n">bnx2i_ep_active_list_add</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_map_ep_dbell_regs</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">del_active_ep</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>

<span class="nl">del_active_ep:</span>
	<span class="n">bnx2i_ep_active_list_del</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
<span class="nl">release_ep:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_tear_down_conn</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">conn_failed:</span>
	<span class="n">bnx2i_free_qp_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
<span class="nl">qp_resc_err:</span>
	<span class="n">bnx2i_free_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="nl">check_busy:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
<span class="nl">nohba:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_poll - polls for TCP connection establishement</span>
<span class="cm"> * @ep:			TCP connection (endpoint) handle</span>
<span class="cm"> * @timeout_ms:		timeout value in milli secs</span>
<span class="cm"> *</span>
<span class="cm"> * polls for TCP connect request to complete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_IDLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_CONNECT_FAILED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_OFLD_FAILED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_CONNECT_COMPL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">,</span>
					      <span class="p">((</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span>
						<span class="n">EP_STATE_OFLD_FAILED</span><span class="p">)</span> <span class="o">||</span>
					       <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span>
						<span class="n">EP_STATE_CONNECT_FAILED</span><span class="p">)</span> <span class="o">||</span>
					       <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span>
						<span class="n">EP_STATE_CONNECT_COMPL</span><span class="p">)),</span>
					      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout_ms</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_OFLD_FAILED</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* timeout */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_tcp_conn_active - check EP state transition</span>
<span class="cm"> * @ep:		endpoint pointer</span>
<span class="cm"> *</span>
<span class="cm"> * check if underlying TCP connection is active</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_ep_tcp_conn_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnic_dev_10g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_NX2_DEV_57710</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic_dev_type</span><span class="p">))</span>
		<span class="n">cnic_dev_10g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EP_STATE_CLEANUP_FAILED</span>:
	<span class="k">case</span> <span class="n">EP_STATE_OFLD_FAILED</span>:
	<span class="k">case</span> <span class="n">EP_STATE_DISCONN_TIMEDOUT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EP_STATE_CONNECT_START</span>:
	<span class="k">case</span> <span class="n">EP_STATE_CONNECT_FAILED</span>:
	<span class="k">case</span> <span class="n">EP_STATE_CONNECT_COMPL</span>:
	<span class="k">case</span> <span class="n">EP_STATE_ULP_UPDATE_START</span>:
	<span class="k">case</span> <span class="n">EP_STATE_ULP_UPDATE_COMPL</span>:
	<span class="k">case</span> <span class="n">EP_STATE_TCP_FIN_RCVD</span>:
	<span class="k">case</span> <span class="n">EP_STATE_LOGOUT_SENT</span>:
	<span class="k">case</span> <span class="n">EP_STATE_LOGOUT_RESP_RCVD</span>:
	<span class="k">case</span> <span class="n">EP_STATE_ULP_UPDATE_FAILED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EP_STATE_TCP_RST_RCVD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cnic_dev_10g</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * bnx2i_hw_ep_disconnect - executes TCP connection teardown process in the hw</span>
<span class="cm"> * @ep:		TCP connection (bnx2i endpoint) handle</span>
<span class="cm"> *</span>
<span class="cm"> * executes  TCP connection teardown process</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2i_hw_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">close_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cnic</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnic</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_IDLE</span> <span class="o">||</span>
	    <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_DISCONN_TIMEDOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2i_ep_tcp_conn_active</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">destroy_conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">conn_teardown_tmo</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bnx2i_ep_ofld_timer</span><span class="p">;</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2I_CNIC_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_TCP_FIN_RCVD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISCSI_STATE_LOGGING_OUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_LOGOUT_SENT</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Logout sent, but no resp */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): WARNING&quot;</span>
						<span class="s">&quot; logout response was not &quot;</span>
						<span class="s">&quot;received!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span>
					   <span class="n">EP_STATE_LOGOUT_RESP_RCVD</span><span class="p">)</span>
					<span class="n">close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_DISCONN_START</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">)</span>
		<span class="n">close_ret</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">cm_close</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">close_ret</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">cm_abort</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">cm_sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">close_ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;bnx2i (%s): close/abort(%d) returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">close_ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* wait for option-2 conn teardown */</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">,</span>
				 <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">EP_STATE_DISCONN_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">ofld_timer</span><span class="p">);</span>

<span class="nl">destroy_conn:</span>
	<span class="n">bnx2i_ep_active_list_del</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_tear_down_conn</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_IDLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_ep_disconnect - executes TCP connection teardown process</span>
<span class="cm"> * @ep:		TCP connection (iscsi endpoint) handle</span>
<span class="cm"> *</span>
<span class="cm"> * executes  TCP connection teardown process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2i_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_endpoint</span> <span class="o">*</span><span class="n">bnx2i_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_conn</span> <span class="o">*</span><span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>

	<span class="n">bnx2i_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="cm">/* driver should not attempt connection cleanup until TCP_CONNECT</span>
<span class="cm">	 * completes either successfully or fails. Timeout is 9-secs, so</span>
<span class="cm">	 * wait for it to complete</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_CONNECT_START</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2i_conn</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">iscsi_suspend_queue</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_DISCONN_TIMEDOUT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_IDLE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_resc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bnx2i_ep</span><span class="o">-&gt;</span><span class="n">hba_age</span> <span class="o">!=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2i_ep_active_list_del</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_resc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do all chip cleanup here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_hw_ep_disconnect</span><span class="p">(</span><span class="n">bnx2i_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">free_resc:</span>
	<span class="n">bnx2i_free_qp_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">bnx2i_ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2i_conn</span><span class="p">)</span>
		<span class="n">bnx2i_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bnx2i_free_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">net_dev_lock</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">eh_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2i_nl_set_path - ISCSI_UEVENT_PATH_UPDATE user message handler</span>
<span class="cm"> * @buf:	pointer to buffer containing iscsi path message</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2i_nl_set_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_path</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2i_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">);</span>

	<span class="cm">/* handled by cnic driver */</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">iscsi_nl_msg_recv</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">ISCSI_UEVENT_PATH_UPDATE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				     <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">bnx2i_attr_is_visible</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_NETDEV_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_RECV_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_XMIT_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_HDRDGST_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_DATADGST_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_EXP_STATSN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PING_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_RECV_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_INITIAL_R2T_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_R2T</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IMM_DATA_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FIRST_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PDU_INORDER_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_DATASEQ_INORDER_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_ERL</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TARGET_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TPGT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FAST_ABORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_ABORT_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_LU_RESET_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TGT_RESET_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IFACE_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_INITIATOR_NAME</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;Scsi_Host_Template&#39; structure and &#39;iscsi_tranport&#39; structure template</span>
<span class="cm"> * used while registering with the scsi host and iSCSI transport module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">bnx2i_host_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Broadcom Offload iSCSI Initiator&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="s">&quot;bnx2i&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">iscsi_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">iscsi_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_recover_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">iscsi_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>		<span class="o">=</span> <span class="n">iscsi_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">ISCSI_MAX_BDS_PER_CMD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">bnx2i_dev_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">bnx2i_iscsi_transport</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;bnx2i&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>			<span class="o">=</span> <span class="n">CAP_RECOVERY_L0</span> <span class="o">|</span> <span class="n">CAP_HDRDGST</span> <span class="o">|</span>
				  <span class="n">CAP_MULTI_R2T</span> <span class="o">|</span> <span class="n">CAP_DATADGST</span> <span class="o">|</span>
				  <span class="n">CAP_DATA_PATH_OFFLOAD</span> <span class="o">|</span>
				  <span class="n">CAP_TEXT_NEGO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_session</span>		<span class="o">=</span> <span class="n">bnx2i_session_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_session</span>	<span class="o">=</span> <span class="n">bnx2i_session_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_conn</span>		<span class="o">=</span> <span class="n">bnx2i_conn_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_conn</span>		<span class="o">=</span> <span class="n">bnx2i_conn_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_conn</span>		<span class="o">=</span> <span class="n">bnx2i_conn_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr_is_visible</span>	<span class="o">=</span> <span class="n">bnx2i_attr_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_param</span>		<span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_conn_param</span>		<span class="o">=</span> <span class="n">iscsi_conn_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_session_param</span>	<span class="o">=</span> <span class="n">iscsi_session_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_param</span>		<span class="o">=</span> <span class="n">bnx2i_host_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_conn</span>		<span class="o">=</span> <span class="n">bnx2i_conn_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_conn</span>		<span class="o">=</span> <span class="n">iscsi_conn_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_pdu</span>		<span class="o">=</span> <span class="n">iscsi_conn_send_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_task</span>		<span class="o">=</span> <span class="n">bnx2i_task_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">bnx2i_conn_get_stats</span><span class="p">,</span>
	<span class="cm">/* TCP connect - disconnect - option-2 interface calls */</span>
	<span class="p">.</span><span class="n">get_ep_param</span>		<span class="o">=</span> <span class="n">bnx2i_ep_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_connect</span>		<span class="o">=</span> <span class="n">bnx2i_ep_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_poll</span>		<span class="o">=</span> <span class="n">bnx2i_ep_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_disconnect</span>		<span class="o">=</span> <span class="n">bnx2i_ep_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_path</span>		<span class="o">=</span> <span class="n">bnx2i_nl_set_path</span><span class="p">,</span>
	<span class="cm">/* Error recovery timeout call */</span>
	<span class="p">.</span><span class="n">session_recovery_timedout</span> <span class="o">=</span> <span class="n">iscsi_session_recovery_timedout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_task</span>		<span class="o">=</span> <span class="n">bnx2i_cleanup_task</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
